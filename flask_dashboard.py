"""
경영지표 대시보드 (Flask 버전)
- 오래된 CPU에서도 작동
- Chart.js 사용
- 연도 비교, 검사목적 필터, 업체별 분석, 부적합항목 분석
- AI 분석 (Google Gemini API)
"""
from flask import Flask, render_template_string, jsonify, request, redirect, make_response
import os
import time
import sqlite3
from pathlib import Path
from datetime import datetime, timedelta
import json
import subprocess
import secrets
import hashlib
from functools import wraps

app = Flask(__name__)

# ============ 로그인/인증 시스템 ============
USER_SESSIONS = {}  # session_id -> {user_id, username, role, login_time, last_activity}

def get_user_db():
    """사용자 데이터베이스 연결"""
    db_path = Path(__file__).resolve().parent / "data" / "users.db"
    conn = sqlite3.connect(str(db_path))
    conn.row_factory = sqlite3.Row
    return conn

def init_user_db():
    """사용자 데이터베이스 초기화"""
    conn = get_user_db()
    cursor = conn.cursor()

    # 사용자 테이블
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT UNIQUE NOT NULL,
            password_hash TEXT NOT NULL,
            name TEXT,
            role TEXT DEFAULT 'user',
            team_id INTEGER,
            email TEXT,
            status TEXT DEFAULT 'active',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            last_login TIMESTAMP,
            FOREIGN KEY (team_id) REFERENCES teams(id)
        )
    ''')

    # 팀 테이블
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS teams (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT UNIQUE NOT NULL,
            category TEXT,
            parent_id INTEGER,
            track_details INTEGER DEFAULT 0,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (parent_id) REFERENCES teams(id)
        )
    ''')

    # 목표 설정 테이블 (개인/팀/전체)
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS goals (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            year INTEGER NOT NULL,
            month INTEGER,
            goal_type TEXT NOT NULL,
            target_id INTEGER,
            inspection_purpose TEXT,
            target_sales REAL DEFAULT 0,
            target_count INTEGER DEFAULT 0,
            created_by INTEGER,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (created_by) REFERENCES users(id)
        )
    ''')

    # 권한 그룹 테이블
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS permission_groups (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT UNIQUE NOT NULL,
            description TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')

    # 권한 상세 테이블
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS permissions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            group_id INTEGER,
            permission_type TEXT,
            permission_key TEXT,
            permission_value TEXT,
            FOREIGN KEY (group_id) REFERENCES permission_groups(id)
        )
    ''')

    # 사용자-권한그룹 연결 테이블
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS user_permissions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            group_id INTEGER,
            FOREIGN KEY (user_id) REFERENCES users(id),
            FOREIGN KEY (group_id) REFERENCES permission_groups(id)
        )
    ''')

    # 팀원 테이블 (부서별 인원 관리)
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS team_members (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            team_id INTEGER NOT NULL,
            name TEXT NOT NULL,
            position TEXT,
            duties TEXT,
            region TEXT,
            hire_year INTEGER,
            phone TEXT,
            email TEXT,
            notes TEXT,
            is_active INTEGER DEFAULT 1,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (team_id) REFERENCES teams(id)
        )
    ''')

    # 시스템 설정 테이블
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS system_settings (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            setting_key TEXT UNIQUE NOT NULL,
            setting_value TEXT,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')

    # 다운로드 로그 테이블
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS download_logs (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            file_type TEXT,
            file_name TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id)
        )
    ''')

    # 활동 로그 테이블
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS user_activity (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            action TEXT,
            details TEXT,
            ip_address TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id)
        )
    ''')

    # 메뉴 접근 로그 테이블
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS menu_logs (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            menu_name TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            exit_at TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id)
        )
    ''')

    # AI 분석 로그 테이블
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS ai_logs (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            prompt TEXT,
            response_length INTEGER,
            tokens_used INTEGER,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id)
        )
    ''')

    # 원가 데이터 테이블
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS cost_data (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            item_name TEXT NOT NULL,
            category TEXT,
            classification TEXT,
            material_cost REAL DEFAULT 0,
            labor_cost REAL DEFAULT 0,
            expense REAL DEFAULT 0,
            direct_cost REAL DEFAULT 0,
            indirect_labor REAL DEFAULT 0,
            indirect_expense REAL DEFAULT 0,
            indirect_cost REAL DEFAULT 0,
            test_cost REAL DEFAULT 0,
            admin_cost REAL DEFAULT 0,
            profit REAL DEFAULT 0,
            total_cost REAL DEFAULT 0,
            fee REAL DEFAULT 0,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')

    # 원가-매출 항목 매핑 테이블
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS cost_mapping (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            cost_item_name TEXT NOT NULL,
            sales_item_name TEXT NOT NULL,
            group_name TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            UNIQUE(cost_item_name, sales_item_name)
        )
    ''')

    # group_name 컬럼 추가 (마이그레이션)
    try:
        cursor.execute('ALTER TABLE cost_mapping ADD COLUMN group_name TEXT')
    except:
        pass

    # 손익계산서 설정 테이블
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS financial_settings (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            year INTEGER NOT NULL,
            revenue REAL DEFAULT 0,
            cost_of_sales REAL DEFAULT 0,
            sga_expense REAL DEFAULT 0,
            non_operating_income REAL DEFAULT 0,
            cost_rate REAL DEFAULT 0,
            sga_rate REAL DEFAULT 0,
            notes TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            UNIQUE(year)
        )
    ''')

    # 손익계산서 세부 항목 테이블 (추가 비용 항목)
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS financial_details (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            year INTEGER NOT NULL,
            category TEXT NOT NULL,
            item_name TEXT NOT NULL,
            amount REAL DEFAULT 0,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (year) REFERENCES financial_settings(year)
        )
    ''')

    # 사용자별 탭 접근 권한 테이블
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS user_tab_permissions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER NOT NULL,
            tab_name TEXT NOT NULL,
            can_access INTEGER DEFAULT 1,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id),
            UNIQUE(user_id, tab_name)
        )
    ''')

    # 기존 users 테이블에 team_id, email 컬럼 추가 (마이그레이션)
    try:
        cursor.execute('ALTER TABLE users ADD COLUMN team_id INTEGER')
    except:
        pass
    try:
        cursor.execute('ALTER TABLE users ADD COLUMN email TEXT')
    except:
        pass

    # 기본 팀 데이터 삽입
    default_teams = [
        ('재무팀', '본사', None, 0),
        ('총무팀', '본사', None, 0),
        ('마케팅팀', '본사', None, 0),
        ('고객지원팀(본사접수)', '본사', None, 0),
        ('품질보증팀', '본사', None, 0),
        ('분석실', '본사', None, 0),
        ('영업부', '영업', None, 1),
        ('서울센터', '영업', 7, 1),
        ('경북센터', '영업', 7, 1),
        ('지사', '지사', None, 1),
        ('충북지사', '지사', 10, 1),
        ('경북지사', '지사', 10, 1),
        ('전라지사', '지사', 10, 1),
        ('경기지사', '지사', 10, 1),
        ('서울지사', '지사', 10, 1),
    ]
    for team_name, category, parent_id, track_details in default_teams:
        cursor.execute('SELECT id FROM teams WHERE name = ?', (team_name,))
        if not cursor.fetchone():
            cursor.execute(
                'INSERT INTO teams (name, category, parent_id, track_details) VALUES (?, ?, ?, ?)',
                (team_name, category, parent_id, track_details)
            )

    # 기본 권한 그룹 생성
    default_permission_groups = [
        ('관리자', '모든 기능 접근 가능'),
        ('매니저', '팀 데이터 관리 가능'),
        ('일반', '개인 데이터만 접근'),
        ('뷰어', '조회만 가능'),
    ]
    for group_name, description in default_permission_groups:
        cursor.execute('SELECT id FROM permission_groups WHERE name = ?', (group_name,))
        if not cursor.fetchone():
            cursor.execute(
                'INSERT INTO permission_groups (name, description) VALUES (?, ?)',
                (group_name, description)
            )

    # 기본 관리자 계정 생성 (없는 경우만)
    cursor.execute("SELECT id FROM users WHERE username = 'admin'")
    if not cursor.fetchone():
        admin_password = hashlib.sha256("admin123".encode()).hexdigest()
        cursor.execute(
            "INSERT INTO users (username, password_hash, name, role) VALUES (?, ?, ?, ?)",
            ("admin", admin_password, "관리자", "admin")
        )

    # 2025년 기본 손익계산서 설정 (없는 경우만)
    cursor.execute("SELECT id FROM financial_settings WHERE year = 2025")
    if not cursor.fetchone():
        # 분석사업 기준 (11월 누계 데이터 기반)
        # 매출: 51.98억, 원가: 36.22억 (69.7%), 판관비: 30.34억 (58.4%), 영업외손익: +4.0억
        cursor.execute('''
            INSERT INTO financial_settings
            (year, revenue, cost_of_sales, sga_expense, non_operating_income, cost_rate, sga_rate, notes)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        ''', (
            2025,
            5198000000,    # 51.98억 (매출)
            3622000000,    # 36.22억 (매출원가)
            3034000000,    # 30.34억 (판관비)
            400000000,     # 4.0억 (영업외손익)
            69.7,          # 원가율 %
            58.4,          # 판관비율 %
            '분석사업 기준 (11월 누계 데이터)'
        ))

    conn.commit()
    conn.close()

# 앱 시작 시 사용자 DB 초기화
init_user_db()

def verify_user_session(session_id):
    """세션 유효성 검증"""
    if not session_id or session_id not in USER_SESSIONS:
        return None

    session = USER_SESSIONS[session_id]
    # 8시간 후 세션 만료
    if datetime.now() - session['login_time'] > timedelta(hours=8):
        del USER_SESSIONS[session_id]
        return None

    session['last_activity'] = datetime.now()
    return session

def login_required(f):
    """로그인 필수 데코레이터"""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        session_id = request.cookies.get('session_id')
        session = verify_user_session(session_id)
        if not session:
            if request.path.startswith('/api/'):
                return jsonify({'error': 'Unauthorized', 'logged_in': False}), 401
            return redirect('/login')
        request.user_session = session
        return f(*args, **kwargs)
    return decorated_function

def admin_required(f):
    """관리자 권한 필수 데코레이터"""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        session_id = request.cookies.get('session_id')
        session = verify_user_session(session_id)
        if not session or session.get('role') != 'admin':
            if request.path.startswith('/api/'):
                return jsonify({'error': 'Admin access required'}), 403
            return redirect('/login')
        request.user_session = session
        return f(*args, **kwargs)
    return decorated_function

def log_user_activity(user_id, action, details=None, ip_address=None):
    """사용자 활동 기록"""
    try:
        conn = get_user_db()
        cursor = conn.cursor()
        cursor.execute(
            "INSERT INTO user_activity (user_id, action, details, ip_address) VALUES (?, ?, ?, ?)",
            (user_id, action, details, ip_address)
        )
        conn.commit()
        conn.close()
    except Exception as e:
        print(f"Activity log error: {e}")

def log_menu_access(user_id, menu_name):
    """메뉴 접근 기록 - 이전 탭 종료시간 업데이트 후 새 기록 생성"""
    try:
        conn = get_user_db()
        cursor = conn.cursor()
        # 이전 탭의 종료시간 업데이트 (exit_at이 NULL인 가장 최근 기록)
        cursor.execute('''
            UPDATE menu_logs SET exit_at = CURRENT_TIMESTAMP
            WHERE user_id = ? AND exit_at IS NULL
        ''', (user_id,))
        # 새 탭 진입 기록
        cursor.execute(
            "INSERT INTO menu_logs (user_id, menu_name) VALUES (?, ?)",
            (user_id, menu_name)
        )
        conn.commit()
        conn.close()
    except Exception as e:
        print(f"Menu log error: {e}")

def log_ai_analysis(user_id, prompt, response_length=0, tokens_used=0):
    """AI 분석 기록"""
    try:
        conn = get_user_db()
        cursor = conn.cursor()
        cursor.execute(
            "INSERT INTO ai_logs (user_id, prompt, response_length, tokens_used) VALUES (?, ?, ?, ?)",
            (user_id, prompt, response_length, tokens_used)
        )
        conn.commit()
        conn.close()
    except Exception as e:
        print(f"AI log error: {e}")

def load_cost_data_from_excel(file_path=None):
    """엑셀에서 원가 데이터 로드"""
    import pandas as pd
    import os

    if file_path is None:
        file_path = os.path.expanduser('~/gdrive_data/cost_data/식품_원가산출표.xls')

    if not os.path.exists(file_path):
        print(f"[COST] 원가 파일 없음: {file_path}")
        return {'success': False, 'error': '파일 없음'}

    try:
        conn = get_user_db()
        cursor = conn.cursor()

        # 기존 데이터 삭제
        cursor.execute('DELETE FROM cost_data')

        total_count = 0
        sheets = ['이화학적검사 집계', '미생물학적검사 집계']

        for sheet_name in sheets:
            try:
                df = pd.read_excel(file_path, sheet_name=sheet_name, header=1)
                category = '이화학' if '이화학' in sheet_name else '미생물'

                for _, row in df.iterrows():
                    item_name = str(row.get('구분', '')).strip()
                    if not item_name or item_name == 'nan':
                        continue

                    cursor.execute('''
                        INSERT INTO cost_data (item_name, category, classification,
                            material_cost, labor_cost, expense, direct_cost,
                            indirect_labor, indirect_expense, indirect_cost,
                            test_cost, admin_cost, profit, total_cost, fee)
                        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                    ''', (
                        item_name,
                        category,
                        str(row.get('분류', '')),
                        float(row.get('재료비', 0) or 0),
                        float(row.get('노무비', 0) or 0),
                        float(row.get('경비', 0) or 0),
                        float(row.get('직접비 계', 0) or 0),
                        float(row.get('간접노무비', row.get('간 접노무비', 0)) or 0),
                        float(row.get('간접경비', 0) or 0),
                        float(row.get('간접비 계', 0) or 0),
                        float(row.get('시험원가', 0) or 0),
                        float(row.get('일반관리비', 0) or 0),
                        float(row.get('이윤', 0) or 0),
                        float(row.get('총원가', 0) or 0),
                        float(row.get('수수료', 0) or 0)
                    ))
                    total_count += 1

                print(f"[COST] {sheet_name}: {total_count}개 로드")
            except Exception as e:
                print(f"[COST] {sheet_name} 처리 오류: {e}")

        conn.commit()
        conn.close()
        print(f"[COST] 총 {total_count}개 원가 데이터 로드 완료")
        return {'success': True, 'count': total_count}

    except Exception as e:
        print(f"[COST] 원가 데이터 로드 오류: {e}")
        return {'success': False, 'error': str(e)}

def get_cost_data():
    """원가 데이터 조회"""
    conn = get_user_db()
    cursor = conn.cursor()
    cursor.execute('SELECT * FROM cost_data ORDER BY category, item_name')
    data = [dict(row) for row in cursor.fetchall()]
    conn.close()
    return data

def get_cost_by_item_name(item_name):
    """항목명으로 원가 조회 (매핑 테이블 우선, 없으면 직접 매칭)"""
    conn = get_user_db()
    cursor = conn.cursor()

    # 매핑 테이블에서 검색
    cursor.execute('''
        SELECT c.* FROM cost_data c
        JOIN cost_mapping m ON c.item_name = m.cost_item_name
        WHERE m.sales_item_name = ?
    ''', (item_name,))
    row = cursor.fetchone()

    if not row:
        # 직접 매칭 시도
        cursor.execute('SELECT * FROM cost_data WHERE item_name = ?', (item_name,))
        row = cursor.fetchone()

    conn.close()
    return dict(row) if row else None

# 터미널 인증 설정
TERMINAL_PASSWORD = "biofl2024"  # 터미널 접속 비밀번호
terminal_sessions = {}  # 세션 토큰 저장

# Gemini API 설정 (여러 키로 429 에러 대응)
GEMINI_API_KEYS = [
    os.environ.get('GEMINI_API_KEY', ''),
    os.environ.get('GEMINI_API_KEY_2', 'AIzaSyA7saUcePkpMh3olwkKKG7z-u1XXcDc7u4'),  # 경영지표1
    os.environ.get('GEMINI_API_KEY_3', 'AIzaSyCo8k3H7Pi128OuBgcupa7jlcm-hH1q68g'),  # 경영지표2
]
GEMINI_API_KEYS = [k for k in GEMINI_API_KEYS if k]  # 빈 키 제거
current_api_key_index = 0  # 현재 사용 중인 키 인덱스

# Claude API 설정 (경영지표 분석용)
# 서버에서 환경변수 CLAUDE_API_KEY 설정 필요: export CLAUDE_API_KEY="your-api-key"
CLAUDE_API_KEY = os.environ.get('CLAUDE_API_KEY', '')
CLAUDE_MODEL = "claude-sonnet-4-20250514"  # Claude Sonnet 4 - 경영 분석용
USE_CLAUDE = bool(CLAUDE_API_KEY)  # API 키가 있으면 Claude 사용

# 경로 설정 - 절대 경로 사용
BASE_DIR = Path(__file__).resolve().parent
DATA_DIR = BASE_DIR / "data"  # 상대 경로로 변경
CACHE_FILE = BASE_DIR / "data_cache.pkl"  # 파일 캐시 경로
SQLITE_DB = DATA_DIR / "business_data.db"  # SQLite 데이터베이스 경로

# 데이터 캐시 (메모리에 저장)
DATA_CACHE = {}
CACHE_TIME = {}
FILE_MTIME = {}  # 파일 수정 시간 추적
AI_SUMMARY_CACHE = {}  # AI용 데이터 요약 캐시
USE_SQLITE = True  # SQLite 사용 여부


def init_sqlite_db():
    """SQLite 데이터베이스 초기화"""
    import sqlite3

    conn = sqlite3.connect(str(SQLITE_DB))
    cursor = conn.cursor()

    # 기본 데이터 테이블 (연도별 Excel 데이터)
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS excel_data (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            year TEXT,
            접수번호 TEXT,
            접수일자 TEXT,
            발행일 TEXT,
            검체유형 TEXT,
            업체명 TEXT,
            의뢰인명 TEXT,
            업체주소 TEXT,
            영업담당 TEXT,
            검사목적 TEXT,
            총금액 REAL,
            시험분야 TEXT,
            입금일 TEXT,
            입금여부 TEXT,
            검사구분 TEXT,
            입금구분 TEXT,
            업체분류 TEXT,
            raw_data TEXT
        )
    ''')

    # food_item 데이터 테이블
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS food_item_data (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            year TEXT,
            접수일자 TEXT,
            발행일 TEXT,
            검체유형 TEXT,
            업체명 TEXT,
            의뢰인명 TEXT,
            업체주소 TEXT,
            항목명 TEXT,
            규격 TEXT,
            항목담당 TEXT,
            결과입력자 TEXT,
            입력일 TEXT,
            분석일 TEXT,
            항목단위 TEXT,
            시험결과 TEXT,
            시험치 TEXT,
            성적서결과 TEXT,
            판정 TEXT,
            검사목적 TEXT,
            긴급여부 TEXT,
            항목수수료 REAL,
            영업담당 TEXT
        )
    ''')

    # 메타데이터 테이블 (파일 수정 시간 추적)
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS file_metadata (
            file_path TEXT PRIMARY KEY,
            mtime REAL,
            row_count INTEGER
        )
    ''')

    # 토큰 사용량 추적 테이블
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS token_usage (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            date TEXT,
            year_month TEXT,
            model TEXT,
            input_tokens INTEGER,
            output_tokens INTEGER,
            total_tokens INTEGER,
            cost_usd REAL,
            cost_krw REAL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')

    # 인덱스 생성 (빠른 검색용)
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_excel_year ON excel_data(year)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_excel_manager ON excel_data(영업담당)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_excel_purpose ON excel_data(검사목적)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_food_year ON food_item_data(year)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_food_manager ON food_item_data(영업담당)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_food_purpose ON food_item_data(검사목적)')
    # 항목명 컬럼이 있을 때만 인덱스 생성 (Colab 변환 DB 호환)
    try:
        cursor.execute('CREATE INDEX IF NOT EXISTS idx_food_item ON food_item_data(항목명)')
    except:
        pass
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_token_yearmonth ON token_usage(year_month)')

    # 기존 DB에 새 컬럼 추가 (마이그레이션)
    new_columns = ['시험분야', '입금일', '입금여부', '검사구분', '입금구분', '업체분류']
    for col in new_columns:
        try:
            cursor.execute(f'ALTER TABLE excel_data ADD COLUMN {col} TEXT')
            print(f"[SQLITE] excel_data 컬럼 추가: {col}")
        except:
            pass  # 이미 존재하면 무시

    # food_item_data 마이그레이션
    food_item_columns = ['접수일자', '발행일', '검체유형', '업체명', '의뢰인명', '업체주소',
                         '항목명', '규격', '항목담당', '결과입력자', '입력일', '분석일',
                         '항목단위', '시험결과', '시험치', '성적서결과', '판정', '검사목적',
                         '긴급여부', '항목수수료', '영업담당']
    for col in food_item_columns:
        try:
            col_type = 'REAL' if col == '항목수수료' else 'TEXT'
            cursor.execute(f'ALTER TABLE food_item_data ADD COLUMN {col} {col_type}')
            print(f"[SQLITE] food_item_data 컬럼 추가: {col}")
        except:
            pass  # 이미 존재하면 무시

    conn.commit()
    conn.close()
    print("[SQLITE] 데이터베이스 초기화 완료")


# 토큰 비용 설정 (USD per 1M tokens)
TOKEN_COSTS = {
    'gemini-2.0-flash': {'input': 0.075, 'output': 0.30},  # Gemini 2.0 Flash
    'claude-3-haiku': {'input': 0.80, 'output': 4.00},
    'claude-3-sonnet': {'input': 3.00, 'output': 15.00},
    'claude-3-opus': {'input': 15.00, 'output': 75.00},
    'claude-sonnet-4-20250514': {'input': 3.00, 'output': 15.00},  # Claude Sonnet 4
    'claude-opus-4-20250514': {'input': 15.00, 'output': 75.00},  # Claude Opus 4
    'claude-3-5-haiku-20241022': {'input': 0.80, 'output': 4.00},  # Claude 3.5 Haiku
}
USD_TO_KRW = 1450  # 환율


def call_claude_api(prompt, system_prompt=None, max_tokens=1024):
    """Claude API 호출 함수"""
    import urllib.request
    import json

    url = "https://api.anthropic.com/v1/messages"

    messages = [{"role": "user", "content": prompt}]

    payload = {
        "model": CLAUDE_MODEL,
        "max_tokens": max_tokens,
        "messages": messages
    }

    if system_prompt:
        payload["system"] = system_prompt

    headers = {
        "x-api-key": CLAUDE_API_KEY,
        "anthropic-version": "2023-06-01",
        "content-type": "application/json"
    }

    try:
        req = urllib.request.Request(
            url,
            data=json.dumps(payload).encode('utf-8'),
            headers=headers,
            method='POST'
        )

        with urllib.request.urlopen(req, timeout=60) as response:
            result = json.loads(response.read().decode('utf-8'))

        # 토큰 사용량 기록
        usage = result.get('usage', {})
        input_tokens = usage.get('input_tokens', 0)
        output_tokens = usage.get('output_tokens', 0)
        record_token_usage(CLAUDE_MODEL, input_tokens, output_tokens)
        print(f"[Claude] 토큰 사용: 입력={input_tokens}, 출력={output_tokens}")

        # 응답 텍스트 추출
        content = result.get('content', [])
        if content and len(content) > 0:
            return {'success': True, 'text': content[0].get('text', ''), 'usage': usage}
        else:
            return {'success': False, 'error': '응답 없음'}

    except urllib.error.HTTPError as e:
        error_body = e.read().decode('utf-8') if e.fp else str(e)
        print(f"[Claude] HTTP 오류: {e.code} - {error_body}")
        return {'success': False, 'error': f'API 오류 {e.code}: {error_body}'}
    except Exception as e:
        print(f"[Claude] 오류: {e}")
        return {'success': False, 'error': str(e)}


def record_token_usage(model, input_tokens, output_tokens):
    """토큰 사용량 기록"""
    import sqlite3
    from datetime import datetime

    total_tokens = input_tokens + output_tokens

    # 비용 계산
    cost_info = TOKEN_COSTS.get(model, {'input': 0.075, 'output': 0.30})
    cost_usd = (input_tokens * cost_info['input'] / 1_000_000) + (output_tokens * cost_info['output'] / 1_000_000)
    cost_krw = cost_usd * USD_TO_KRW

    today = datetime.now().strftime('%Y-%m-%d')
    year_month = datetime.now().strftime('%Y-%m')

    try:
        conn = sqlite3.connect(str(SQLITE_DB))
        cursor = conn.cursor()
        cursor.execute('''
            INSERT INTO token_usage (date, year_month, model, input_tokens, output_tokens, total_tokens, cost_usd, cost_krw)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        ''', (today, year_month, model, input_tokens, output_tokens, total_tokens, cost_usd, cost_krw))
        conn.commit()
        conn.close()
    except Exception as e:
        print(f"[TOKEN] 사용량 기록 오류: {e}")


def get_token_usage_stats():
    """토큰 사용량 통계 조회"""
    import sqlite3
    from datetime import datetime

    current_month = datetime.now().strftime('%Y-%m')
    # 저번달 계산
    now = datetime.now()
    if now.month == 1:
        last_month = f"{now.year - 1}-12"
    else:
        last_month = f"{now.year}-{now.month - 1:02d}"

    try:
        conn = sqlite3.connect(str(SQLITE_DB))
        cursor = conn.cursor()

        # 이번달 통계
        cursor.execute('''
            SELECT COALESCE(SUM(total_tokens), 0), COALESCE(SUM(cost_usd), 0), COALESCE(SUM(cost_krw), 0)
            FROM token_usage WHERE year_month = ?
        ''', (current_month,))
        this_month = cursor.fetchone()

        # 저번달 통계
        cursor.execute('''
            SELECT COALESCE(SUM(total_tokens), 0), COALESCE(SUM(cost_usd), 0), COALESCE(SUM(cost_krw), 0)
            FROM token_usage WHERE year_month = ?
        ''', (last_month,))
        prev_month = cursor.fetchone()

        conn.close()

        return {
            'this_month': {
                'tokens': int(this_month[0]),
                'cost_usd': round(this_month[1], 4),
                'cost_krw': round(this_month[2], 0)
            },
            'last_month': {
                'tokens': int(prev_month[0]),
                'cost_usd': round(prev_month[1], 4),
                'cost_krw': round(prev_month[2], 0)
            }
        }
    except Exception as e:
        print(f"[TOKEN] 통계 조회 오류: {e}")
        return {
            'this_month': {'tokens': 0, 'cost_usd': 0, 'cost_krw': 0},
            'last_month': {'tokens': 0, 'cost_usd': 0, 'cost_krw': 0}
        }


def check_sqlite_needs_update():
    """SQLite DB 업데이트 필요 여부 확인"""
    import sqlite3

    if not SQLITE_DB.exists():
        return True

    try:
        conn = sqlite3.connect(str(SQLITE_DB))
        cursor = conn.cursor()

        # 테이블이 비어있는지 확인
        for year in ['2024', '2025']:
            cursor.execute('SELECT COUNT(*) FROM excel_data WHERE year = ?', (year,))
            if cursor.fetchone()[0] == 0:
                conn.close()
                print(f"[SQLITE] 업데이트 필요: {year}년 excel_data 비어있음")
                return True

            cursor.execute('SELECT COUNT(*) FROM food_item_data WHERE year = ?', (year,))
            if cursor.fetchone()[0] == 0:
                conn.close()
                print(f"[SQLITE] 업데이트 필요: {year}년 food_item_data 비어있음")
                return True

        # 모든 Excel 파일의 현재 mtime 확인
        for year in ['2024', '2025']:
            # 기본 데이터
            data_path = DATA_DIR / str(year)
            if data_path.exists():
                for f in sorted(data_path.glob("*.xlsx")):
                    file_path = str(f)
                    current_mtime = f.stat().st_mtime

                    cursor.execute('SELECT mtime FROM file_metadata WHERE file_path = ?', (file_path,))
                    row = cursor.fetchone()

                    if not row or row[0] < current_mtime:
                        conn.close()
                        print(f"[SQLITE] 업데이트 필요: {f.name}")
                        return True

            # food_item 데이터
            food_path = DATA_DIR / "food_item" / str(year)
            if food_path.exists():
                for f in sorted(food_path.glob("*.xlsx")):
                    file_path = str(f)
                    current_mtime = f.stat().st_mtime

                    cursor.execute('SELECT mtime FROM file_metadata WHERE file_path = ?', (file_path,))
                    row = cursor.fetchone()

                    if not row or row[0] < current_mtime:
                        conn.close()
                        print(f"[SQLITE] 업데이트 필요: {f.name}")
                        return True

        conn.close()
        return False

    except Exception as e:
        print(f"[SQLITE] 체크 오류: {e}")
        return True


def convert_excel_to_sqlite():
    """Excel 파일을 SQLite로 변환"""
    import sqlite3
    import time
    from openpyxl import load_workbook

    print("[SQLITE] Excel → SQLite 변환 시작...")
    start_time = time.time()

    init_sqlite_db()
    conn = sqlite3.connect(str(SQLITE_DB))
    cursor = conn.cursor()

    total_records = 0

    for year in ['2024', '2025']:
        # 기본 데이터 변환
        data_path = DATA_DIR / str(year)
        if data_path.exists():
            # 해당 연도 데이터가 비어있는지 확인
            cursor.execute('SELECT COUNT(*) FROM excel_data WHERE year = ?', (year,))
            existing_count = cursor.fetchone()[0]
            force_convert = existing_count == 0

            if force_convert:
                print(f"[SQLITE] {year}년 excel_data 비어있음 - 강제 변환")

            # 먼저 변환이 필요한 파일 목록 확인
            files_to_convert = []
            for f in sorted(data_path.glob("*.xlsx")):
                file_path = str(f)
                current_mtime = f.stat().st_mtime

                # 강제 변환 모드가 아닐 때만 스킵 체크
                if not force_convert:
                    cursor.execute('SELECT mtime FROM file_metadata WHERE file_path = ?', (file_path,))
                    row = cursor.fetchone()
                    if row and row[0] >= current_mtime:
                        print(f"[SQLITE] {f.name} 스킵 (이미 최신)")
                        continue
                files_to_convert.append((f, file_path, current_mtime))

            # 변환할 파일이 있으면 해당 연도 데이터 전체 삭제 후 재로드
            if files_to_convert:
                cursor.execute('DELETE FROM excel_data WHERE year = ?', (year,))
                print(f"[SQLITE] {year}년 데이터 삭제 후 전체 재변환")

                # 모든 파일 처리 (변환 필요 여부와 관계없이 전체 로드)
                for f in sorted(data_path.glob("*.xlsx")):
                    file_path = str(f)
                    current_mtime = f.stat().st_mtime

                    try:
                        wb = load_workbook(f, read_only=True, data_only=True)
                        ws = wb.active
                        headers = [cell.value for cell in ws[1]]

                        batch = []
                        for row_data in ws.iter_rows(min_row=2, values_only=True):
                            row_dict = dict(zip(headers, row_data))
                            batch.append((
                                year,
                                str(row_dict.get('접수번호', '')),
                                str(row_dict.get('접수일자', '')),
                                str(row_dict.get('발행일', '')),
                                str(row_dict.get('검체유형', '')),
                                str(row_dict.get('업체명', '')),
                                str(row_dict.get('의뢰인명', '')),
                                str(row_dict.get('업체주소', '')),
                                str(row_dict.get('영업담당', '')),
                                str(row_dict.get('검사목적', '')),
                                float(row_dict.get('총금액', 0) or 0),
                                str(row_dict.get('시험분야', '')),
                                str(row_dict.get('입금일', '')),
                                str(row_dict.get('입금여부', '')),
                                str(row_dict.get('검사구분', '')),
                                str(row_dict.get('입금구분', '')),
                                str(row_dict.get('업체분류', '')),
                                json.dumps(row_dict, ensure_ascii=False, default=str)
                            ))

                        cursor.executemany('''
                            INSERT INTO excel_data
                            (year, 접수번호, 접수일자, 발행일, 검체유형, 업체명, 의뢰인명, 업체주소, 영업담당, 검사목적, 총금액, 시험분야, 입금일, 입금여부, 검사구분, 입금구분, 업체분류, raw_data)
                            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                        ''', batch)

                        # 메타데이터 업데이트
                        cursor.execute('''
                            INSERT OR REPLACE INTO file_metadata (file_path, mtime, row_count)
                            VALUES (?, ?, ?)
                        ''', (file_path, current_mtime, len(batch)))

                        wb.close()
                        total_records += len(batch)
                        print(f"[SQLITE] {f.name}: {len(batch)}건 변환")

                    except Exception as e:
                        print(f"[SQLITE ERROR] {f.name}: {e}")

        # food_item 데이터 변환
        food_path = DATA_DIR / "food_item" / str(year)
        if food_path.exists():
            # 해당 연도 데이터가 비어있는지 확인
            cursor.execute('SELECT COUNT(*) FROM food_item_data WHERE year = ?', (year,))
            existing_count = cursor.fetchone()[0]
            force_convert = existing_count == 0

            if force_convert:
                print(f"[SQLITE] {year}년 food_item_data 비어있음 - 강제 변환")

            # 변환이 필요한 파일 목록 수집
            files_to_convert = []
            for f in sorted(food_path.glob("*.xlsx")):
                file_path = str(f)
                current_mtime = f.stat().st_mtime

                # 강제 변환 모드가 아닐 때만 스킵 체크
                if not force_convert:
                    cursor.execute('SELECT mtime FROM file_metadata WHERE file_path = ?', (file_path,))
                    row = cursor.fetchone()
                    if row and row[0] >= current_mtime:
                        print(f"[SQLITE] food_item {f.name} 스킵 (이미 최신)")
                        continue
                files_to_convert.append((f, file_path, current_mtime))

            # 변환할 파일이 있으면 해당 연도 데이터 삭제 후 전체 재로드
            if files_to_convert:
                cursor.execute('DELETE FROM food_item_data WHERE year = ?', (year,))
                print(f"[SQLITE] food_item {year}년 데이터 삭제 후 재변환")

                # 모든 파일 처리 (변환 필요 여부와 관계없이 전체 로드)
                for f in sorted(food_path.glob("*.xlsx")):
                    file_path = str(f)
                    current_mtime = f.stat().st_mtime

                    try:
                        wb = load_workbook(f, read_only=True, data_only=True)
                        ws = wb.active
                        headers = [cell.value for cell in ws[1]]

                        required_columns = ['접수일자', '발행일', '검체유형', '업체명', '의뢰인명', '업체주소',
                                           '항목명', '규격', '항목담당', '결과입력자', '입력일', '분석일',
                                           '항목단위', '시험결과', '시험치', '성적서결과', '판정', '검사목적',
                                           '긴급여부', '항목수수료', '영업담당']

                        col_indices = {}
                        for i, h in enumerate(headers):
                            if h in required_columns:
                                col_indices[h] = i

                        batch = []
                        for row_data in ws.iter_rows(min_row=2, values_only=True):
                            row_dict = {}
                            for col_name, idx in col_indices.items():
                                row_dict[col_name] = row_data[idx] if idx < len(row_data) else None

                            batch.append((
                                year,
                                str(row_dict.get('접수일자', '') or ''),
                                str(row_dict.get('발행일', '') or ''),
                                str(row_dict.get('검체유형', '') or ''),
                                str(row_dict.get('업체명', '') or ''),
                                str(row_dict.get('의뢰인명', '') or ''),
                                str(row_dict.get('업체주소', '') or ''),
                                str(row_dict.get('항목명', '') or ''),
                                str(row_dict.get('규격', '') or ''),
                                str(row_dict.get('항목담당', '') or ''),
                                str(row_dict.get('결과입력자', '') or ''),
                                str(row_dict.get('입력일', '') or ''),
                                str(row_dict.get('분석일', '') or ''),
                                str(row_dict.get('항목단위', '') or ''),
                                str(row_dict.get('시험결과', '') or ''),
                                str(row_dict.get('시험치', '') or ''),
                                str(row_dict.get('성적서결과', '') or ''),
                                str(row_dict.get('판정', '') or ''),
                                str(row_dict.get('검사목적', '') or ''),
                                str(row_dict.get('긴급여부', '') or ''),
                                float(row_dict.get('항목수수료', 0) or 0),
                                str(row_dict.get('영업담당', '') or '')
                            ))

                        cursor.executemany('''
                            INSERT INTO food_item_data
                            (year, 접수일자, 발행일, 검체유형, 업체명, 의뢰인명, 업체주소, 항목명, 규격,
                             항목담당, 결과입력자, 입력일, 분석일, 항목단위, 시험결과, 시험치, 성적서결과,
                             판정, 검사목적, 긴급여부, 항목수수료, 영업담당)
                            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                        ''', batch)

                        cursor.execute('''
                            INSERT OR REPLACE INTO file_metadata (file_path, mtime, row_count)
                            VALUES (?, ?, ?)
                        ''', (file_path, current_mtime, len(batch)))

                        wb.close()
                        total_records += len(batch)
                        print(f"[SQLITE] food_item {f.name}: {len(batch)}건 변환")

                    except Exception as e:
                        print(f"[SQLITE ERROR] food_item {f.name}: {e}")

    conn.commit()
    conn.close()

    elapsed = time.time() - start_time
    print(f"[SQLITE] 변환 완료! 총 {total_records:,}건, {elapsed:.1f}초 소요")


def load_excel_data_sqlite(year):
    """SQLite에서 데이터 로드 (빠름) - Colab DB 호환"""
    import sqlite3
    import time

    start_time = time.time()

    conn = sqlite3.connect(str(SQLITE_DB))
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()

    # 테이블 컬럼 확인
    cursor.execute("PRAGMA table_info(excel_data)")
    columns = [col[1] for col in cursor.fetchall()]

    data = []

    # raw_data 컬럼이 있으면 기존 방식 (JSON 파싱)
    if 'raw_data' in columns:
        cursor.execute('SELECT raw_data FROM excel_data WHERE year = ?', (str(year),))
        rows = cursor.fetchall()
        for row in rows:
            try:
                if row[0]:
                    data.append(json.loads(row[0]))
            except:
                pass
    else:
        # Colab DB 방식: 컬럼에서 직접 로드
        cursor.execute('SELECT * FROM excel_data WHERE year = ?', (str(year),))
        rows = cursor.fetchall()
        data = [dict(row) for row in rows]

    conn.close()

    elapsed = time.time() - start_time
    print(f"[SQLITE] {year}년 데이터 로드: {len(data):,}건, {elapsed:.2f}초")

    return data


def load_food_item_data_sqlite(year):
    """SQLite에서 food_item 데이터 로드 (빠름) - Colab DB 호환"""
    import sqlite3
    import time

    start_time = time.time()

    conn = sqlite3.connect(str(SQLITE_DB))
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()

    # 테이블 존재 여부 확인
    cursor.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='food_item_data'")
    if not cursor.fetchone():
        conn.close()
        print(f"[SQLITE] food_item_data 테이블 없음")
        return []

    # Colab DB 호환: 모든 컬럼 로드
    cursor.execute('SELECT * FROM food_item_data WHERE year = ?', (str(year),))

    rows = cursor.fetchall()
    data = [dict(row) for row in rows]

    conn.close()

    elapsed = time.time() - start_time
    print(f"[SQLITE] food_item {year}년 데이터 로드: {len(data):,}건, {elapsed:.2f}초")

    return data


def get_data_files_mtime():
    """모든 데이터 파일의 최신 수정 시간 반환"""
    latest_mtime = 0
    for year in ['2024', '2025']:
        data_path = DATA_DIR / str(year)
        if data_path.exists():
            for f in data_path.glob("*.xlsx"):
                mtime = f.stat().st_mtime
                if mtime > latest_mtime:
                    latest_mtime = mtime
        food_path = DATA_DIR / "food_item" / str(year)
        if food_path.exists():
            for f in food_path.glob("*.xlsx"):
                mtime = f.stat().st_mtime
                if mtime > latest_mtime:
                    latest_mtime = mtime
    return latest_mtime


def load_cache_from_file():
    """파일에서 캐시 로드 (서버 시작 시)"""
    global DATA_CACHE, CACHE_TIME, FILE_MTIME, AI_SUMMARY_CACHE
    import pickle

    if not CACHE_FILE.exists():
        print("[CACHE] 캐시 파일 없음 - 새로 생성 필요")
        return False

    try:
        # 데이터 파일 수정 시간 확인
        current_mtime = get_data_files_mtime()
        cache_mtime = CACHE_FILE.stat().st_mtime

        # 캐시가 데이터보다 오래된 경우 무효화
        if current_mtime > cache_mtime:
            print(f"[CACHE] 데이터 파일이 캐시보다 최신 - 다시 로드 필요")
            return False

        with open(CACHE_FILE, 'rb') as f:
            cached = pickle.load(f)

        DATA_CACHE = cached.get('DATA_CACHE', {})
        CACHE_TIME = cached.get('CACHE_TIME', {})
        FILE_MTIME = cached.get('FILE_MTIME', {})
        AI_SUMMARY_CACHE = cached.get('AI_SUMMARY_CACHE', {})

        # 캐시 시간 업데이트 (현재 시간 기준으로)
        import time
        current_time = time.time()
        for key in CACHE_TIME:
            CACHE_TIME[key] = current_time

        total_records = sum(len(v) for v in DATA_CACHE.values() if isinstance(v, list))
        print(f"[CACHE] 파일에서 캐시 로드 완료 ({total_records:,}건)")
        return True

    except Exception as e:
        print(f"[CACHE] 파일 캐시 로드 실패: {e}")
        return False


def save_cache_to_file():
    """캐시를 파일로 저장"""
    import pickle

    try:
        cached = {
            'DATA_CACHE': DATA_CACHE,
            'CACHE_TIME': CACHE_TIME,
            'FILE_MTIME': FILE_MTIME,
            'AI_SUMMARY_CACHE': AI_SUMMARY_CACHE
        }
        with open(CACHE_FILE, 'wb') as f:
            pickle.dump(cached, f)
        print(f"[CACHE] 파일로 캐시 저장 완료")
    except Exception as e:
        print(f"[CACHE] 파일 캐시 저장 실패: {e}")

# 설정
MANAGER_TO_BRANCH = {
    # 본사/마케팅
    "본사접수": "본사",
    "마케팅": "마케팅",
    # 서울센터
    "조봉현": "서울센터", "오석현": "서울센터", "오세중": "서울센터", "장동주": "서울센터",
    # 경북센터
    "엄상흠": "경북센터",
    # 충청지사
    "장동욱": "충청지사", "박은태": "충청지사", "지병훈": "충청지사",
    # 전라지사
    "이강현": "전라지사",
    # 기타지사
    "엄은정": "기타지사", "정유경": "기타지사", "심태보": "기타지사", "이성복": "기타지사", "도준구": "기타지사", "ISA": "기타지사",
}

# 부서별 매핑 (메인 대시보드 부서별 카드용)
MANAGER_TO_DEPARTMENT = {
    "본사접수": "본사",
    "마케팅": "마케팅",
    # 직영(영업부)
    "오세중": "영업부", "장동주": "영업부", "조봉현": "영업부", "오석현": "영업부", "엄상흠": "영업부",
    # 지사
    "장동욱": "지사", "박은태": "지사", "지병훈": "지사",
    "엄은정": "지사", "정유경": "지사",
    "이강현": "지사", "도준구": "지사", "이성복": "지사",
    "ISA": "지사",
}

# 지사에 포함될 담당자 목록 (지사 카드용)
BRANCH_MEMBERS = {"장동욱", "박은태", "지병훈", "엄은정", "정유경", "이강현", "도준구", "이성복", "ISA"}

# 개인별 분석에서 제외할 영업담당 (외부 기관 등)
EXCLUDED_MANAGERS = {"IBK", "미지정"}

# 업체별 분석에서 제외할 거래처
EXCLUDED_CLIENTS = {"IBK", "IGC"}

def load_excel_data(year, use_cache=True):
    """데이터 로드 (SQLite 우선, 없으면 Excel)"""
    import time

    # 캐시 확인 (1시간 유효)
    cache_key = str(year)
    if use_cache and cache_key in DATA_CACHE:
        cache_age = time.time() - CACHE_TIME.get(cache_key, 0)
        if cache_age < 3600:  # 1시간
            print(f"[CACHE] {year}년 데이터 캐시 사용 ({len(DATA_CACHE[cache_key])}건)")
            return DATA_CACHE[cache_key]

    # SQLite 사용 (DB가 존재하면)
    if USE_SQLITE and SQLITE_DB.exists():
        all_data = load_excel_data_sqlite(year)
        DATA_CACHE[cache_key] = all_data
        CACHE_TIME[cache_key] = time.time()
        return all_data

    # 기존 Excel 로드 방식 (폴백)
    from openpyxl import load_workbook

    data_path = DATA_DIR / str(year)
    if not data_path.exists():
        return []

    print(f"[LOAD] {year}년 데이터 로딩 시작 (Excel)...")
    start_time = time.time()

    all_data = []
    files = sorted(data_path.glob("*.xlsx"))

    for f in files:
        try:
            wb = load_workbook(f, read_only=True, data_only=True)
            ws = wb.active
            headers = [cell.value for cell in ws[1]]

            for row in ws.iter_rows(min_row=2, values_only=True):
                row_dict = dict(zip(headers, row))
                all_data.append(row_dict)
            wb.close()
            print(f"[LOAD] {f.name} 완료")
        except Exception as e:
            print(f"[ERROR] Loading {f}: {e}")

    elapsed = time.time() - start_time
    print(f"[LOAD] {year}년 완료: {len(all_data)}건, {elapsed:.1f}초 소요")

    # 캐시 저장
    DATA_CACHE[cache_key] = all_data
    CACHE_TIME[cache_key] = time.time()

    return all_data

def load_food_item_data(year, use_cache=True):
    """food_item 데이터 로드 (SQLite 우선, 없으면 Excel)"""
    import time

    cache_key = f"food_item_{year}"
    if use_cache and cache_key in DATA_CACHE:
        cache_age = time.time() - CACHE_TIME.get(cache_key, 0)
        if cache_age < 3600:
            print(f"[CACHE] food_item {year}년 데이터 캐시 사용 ({len(DATA_CACHE[cache_key])}건)")
            return DATA_CACHE[cache_key]

    # SQLite 사용 (DB가 존재하면)
    if USE_SQLITE and SQLITE_DB.exists():
        all_data = load_food_item_data_sqlite(year)
        DATA_CACHE[cache_key] = all_data
        CACHE_TIME[cache_key] = time.time()
        return all_data

    # 기존 Excel 로드 방식 (폴백)
    from openpyxl import load_workbook

    data_path = DATA_DIR / "food_item" / str(year)
    if not data_path.exists():
        print(f"[WARN] food_item {year}년 폴더 없음: {data_path}")
        return []

    print(f"[LOAD] food_item {year}년 데이터 로딩 시작 (Excel)...")
    start_time = time.time()

    # 필요한 컬럼만 로드
    required_columns = ['접수일자', '발행일', '검체유형', '업체명', '의뢰인명', '업체주소',
                       '항목명', '규격', '항목담당', '결과입력자', '입력일', '분석일',
                       '항목단위', '시험결과', '시험치', '성적서결과', '판정', '검사목적',
                       '긴급여부', '항목수수료', '영업담당']

    all_data = []
    files = sorted(data_path.glob("*.xlsx"))

    for f in files:
        try:
            wb = load_workbook(f, read_only=True, data_only=True)
            ws = wb.active
            headers = [cell.value for cell in ws[1]]

            # 컬럼 인덱스 매핑
            col_indices = {}
            for i, h in enumerate(headers):
                if h in required_columns:
                    col_indices[h] = i

            for row in ws.iter_rows(min_row=2, values_only=True):
                row_dict = {}
                for col_name, idx in col_indices.items():
                    row_dict[col_name] = row[idx] if idx < len(row) else None
                all_data.append(row_dict)
            wb.close()
            print(f"[LOAD] food_item {f.name} 완료")
        except Exception as e:
            print(f"[ERROR] Loading food_item {f}: {e}")

    elapsed = time.time() - start_time
    print(f"[LOAD] food_item {year}년 완료: {len(all_data)}건, {elapsed:.1f}초 소요")

    DATA_CACHE[cache_key] = all_data
    CACHE_TIME[cache_key] = time.time()

    return all_data


def check_data_changed(year):
    """데이터 파일 변경 감지"""
    data_path = DATA_DIR / str(year)
    if not data_path.exists():
        return False

    files = sorted(data_path.glob("*.xlsx"))
    current_mtimes = {}

    for f in files:
        current_mtimes[str(f)] = f.stat().st_mtime

    cache_key = f"mtime_{year}"
    old_mtimes = FILE_MTIME.get(cache_key, {})

    if current_mtimes != old_mtimes:
        FILE_MTIME[cache_key] = current_mtimes
        return True

    return False


def get_ai_data_summary(force_refresh=False):
    """AI 분석용 데이터 요약 생성 (캐시됨)"""
    import time

    cache_key = 'ai_summary'

    # 데이터 변경 확인
    data_changed = check_data_changed('2024') or check_data_changed('2025')

    # 캐시 유효성 확인 (1시간 또는 데이터 변경 시)
    if not force_refresh and cache_key in AI_SUMMARY_CACHE:
        cache_age = time.time() - AI_SUMMARY_CACHE.get('_time', 0)
        if cache_age < 3600 and not data_changed:
            print(f"[AI-CACHE] 요약 캐시 사용 (나이: {cache_age:.0f}초)")
            return AI_SUMMARY_CACHE[cache_key]

    print(f"[AI-CACHE] 데이터 요약 생성 중...")
    start_time = time.time()

    # 데이터 로드
    food_2024 = load_food_item_data('2024')
    food_2025 = load_food_item_data('2025')

    # 요약 통계 계산
    summary = {
        '2024': {'total_count': 0, 'total_fee': 0, 'by_purpose': {}, 'by_sample_type': {},
                 'by_manager': {}, 'by_item': {}, 'monthly': {}, 'by_client': {}},
        '2025': {'total_count': 0, 'total_fee': 0, 'by_purpose': {}, 'by_sample_type': {},
                 'by_manager': {}, 'by_item': {}, 'monthly': {}, 'by_client': {}},
        'filter_values': {'purposes': set(), 'sample_types': set(), 'items': set(), 'managers': set(), 'clients': set()}
    }

    for year, data in [('2024', food_2024), ('2025', food_2025)]:
        for row in data:
            purpose = str(row.get('검사목적', '') or '').strip()
            sample_type = str(row.get('검체유형', '') or '').strip()
            item_name = str(row.get('항목명', '') or '').strip()
            manager = str(row.get('영업담당', '') or '').strip() or '미지정'
            client = str(row.get('업체명', '') or '').strip() or '미지정'
            fee = row.get('항목수수료', 0) or 0
            date = row.get('접수일자')

            if isinstance(fee, str):
                fee = float(fee.replace(',', '').replace('원', '')) if fee else 0

            summary[year]['total_count'] += 1
            summary[year]['total_fee'] += fee

            # 목적별
            if purpose:
                if purpose not in summary[year]['by_purpose']:
                    summary[year]['by_purpose'][purpose] = {'count': 0, 'fee': 0}
                summary[year]['by_purpose'][purpose]['count'] += 1
                summary[year]['by_purpose'][purpose]['fee'] += fee
                summary['filter_values']['purposes'].add(purpose)

            # 검체유형별
            if sample_type:
                if sample_type not in summary[year]['by_sample_type']:
                    summary[year]['by_sample_type'][sample_type] = {'count': 0, 'fee': 0}
                summary[year]['by_sample_type'][sample_type]['count'] += 1
                summary[year]['by_sample_type'][sample_type]['fee'] += fee
                summary['filter_values']['sample_types'].add(sample_type)

            # 영업담당별
            if manager not in summary[year]['by_manager']:
                summary[year]['by_manager'][manager] = {'count': 0, 'fee': 0}
            summary[year]['by_manager'][manager]['count'] += 1
            summary[year]['by_manager'][manager]['fee'] += fee
            summary['filter_values']['managers'].add(manager)

            # 항목별 (TOP 50만)
            if item_name:
                if item_name not in summary[year]['by_item']:
                    summary[year]['by_item'][item_name] = {'count': 0, 'fee': 0}
                summary[year]['by_item'][item_name]['count'] += 1
                summary[year]['by_item'][item_name]['fee'] += fee
                summary['filter_values']['items'].add(item_name)

            # 월별
            if date and hasattr(date, 'month'):
                m = date.month
                if m not in summary[year]['monthly']:
                    summary[year]['monthly'][m] = {'count': 0, 'fee': 0}
                summary[year]['monthly'][m]['count'] += 1
                summary[year]['monthly'][m]['fee'] += fee

            # 고객(업체)별
            if client and client != '미지정':
                if client not in summary[year]['by_client']:
                    summary[year]['by_client'][client] = {'count': 0, 'fee': 0, 'purposes': set(), 'months': set()}
                summary[year]['by_client'][client]['count'] += 1
                summary[year]['by_client'][client]['fee'] += fee
                if purpose:
                    summary[year]['by_client'][client]['purposes'].add(purpose)
                if date and hasattr(date, 'month'):
                    summary[year]['by_client'][client]['months'].add(date.month)
                summary['filter_values']['clients'].add(client)

    # set을 sorted list로 변환
    summary['filter_values']['purposes'] = sorted(summary['filter_values']['purposes'])
    summary['filter_values']['sample_types'] = sorted(summary['filter_values']['sample_types'])
    summary['filter_values']['items'] = sorted(summary['filter_values']['items'])[:100]  # 상위 100개만
    # ISA, IBK 등 제외 대상은 필터 목록에서 제외
    summary['filter_values']['managers'] = sorted([m for m in summary['filter_values']['managers'] if m not in EXCLUDED_MANAGERS])

    # 항목별 데이터 정렬 (상위 50개만 유지)
    for year in ['2024', '2025']:
        sorted_items = sorted(summary[year]['by_item'].items(),
                             key=lambda x: x[1]['fee'], reverse=True)[:50]
        summary[year]['by_item'] = dict(sorted_items)

    # 고객별 데이터 정렬 (상위 100개만 유지) + set을 list로 변환
    for year in ['2024', '2025']:
        sorted_clients = sorted(summary[year]['by_client'].items(),
                               key=lambda x: x[1]['fee'], reverse=True)[:100]
        summary[year]['by_client'] = {
            k: {
                'count': v['count'],
                'fee': v['fee'],
                'purposes': list(v['purposes']),
                'months': sorted(list(v['months']))
            }
            for k, v in sorted_clients
        }

    # 고객사 필터 값 정렬
    summary['filter_values']['clients'] = sorted(summary['filter_values']['clients'])[:200]

    elapsed = time.time() - start_time
    print(f"[AI-CACHE] 요약 생성 완료: {elapsed:.1f}초 소요")

    AI_SUMMARY_CACHE[cache_key] = summary
    AI_SUMMARY_CACHE['_time'] = time.time()

    return summary


def process_food_item_data(data, purpose_filter=None, sample_type_filter=None,
                           item_filter=None, manager_filter=None):
    """검사항목 데이터 처리"""
    by_item = {}  # 항목별 데이터
    by_item_month = {}  # 항목별-월별 데이터
    by_item_analyzer = {}  # 항목별-분석자 데이터
    by_sample_type_item = {}  # 검체유형별-항목 데이터
    by_manager_item = {}  # 영업담당별-항목 데이터
    by_manager_fee = {}  # 영업담당별-수수료 데이터
    by_month_fee = {}  # 월별-수수료 데이터
    by_purpose_sample_type = {}  # 검사목적별-검체유형 매핑
    by_purpose_sample_type_item = {}  # 검사목적+검체유형별-항목 매핑
    by_purpose_item = {}  # 검사목적별-항목 데이터 (NEW)
    by_analyzer = {}  # 분석자별 데이터 (NEW)
    by_analyzer_item = {}  # 분석자별-항목 데이터 (NEW)
    by_month_item = {}  # 월별-항목 데이터 (NEW)

    purposes = set()
    sample_types = set()
    items = set()
    managers = set()
    analyzers = set()

    total_fee = 0
    total_count = 0

    # 잔류농약/항생물질(참고용) 중복 제거를 위한 고유 샘플 추적
    unique_pesticide_samples = set()  # (접수일자, 업체명, 검체유형) 조합으로 고유 식별
    pesticide_unique_count = 0  # 잔류농약(참고용) 고유 건수
    antibiotic_unique_count = 0  # 항생물질(참고용) 고유 건수

    for row in data:
        purpose = str(row.get('검사목적', '') or '').strip()
        sample_type = str(row.get('검체유형', '') or '').strip()
        item_name = str(row.get('항목명', '') or '').strip()
        manager = str(row.get('영업담당', '') or '').strip() or '미지정'
        analyzer = str(row.get('결과입력자', '') or '').strip() or '미지정'
        fee = row.get('항목수수료', 0) or 0
        date = row.get('접수일자')
        company = str(row.get('업체명', '') or '').strip()

        if isinstance(fee, str):
            fee = float(fee.replace(',', '').replace('원', '')) if fee else 0

        # 목록 수집
        if purpose: purposes.add(purpose)
        if sample_type: sample_types.add(sample_type)
        if item_name: items.add(item_name)
        if manager and manager != '미지정': managers.add(manager)
        if analyzer and analyzer != '미지정': analyzers.add(analyzer)

        # 검사목적별-검체유형 매핑 수집
        if purpose and sample_type:
            if purpose not in by_purpose_sample_type:
                by_purpose_sample_type[purpose] = set()
            by_purpose_sample_type[purpose].add(sample_type)

        # 검사목적+검체유형별-항목 매핑 수집 (잔류농약, 항생물질 제외)
        if purpose and sample_type and item_name:
            if not (sample_type.startswith('잔류농약') or sample_type.startswith('항생물질')):
                key = f"{purpose}|{sample_type}"
                if key not in by_purpose_sample_type_item:
                    by_purpose_sample_type_item[key] = set()
                by_purpose_sample_type_item[key].add(item_name)

        # 필터 적용
        if purpose_filter and purpose_filter != '전체' and purpose != purpose_filter:
            continue
        # 검체유형 필터 (와일드카드 지원)
        if sample_type_filter and sample_type_filter != '전체':
            if sample_type_filter.endswith('*'):
                # 와일드카드 패턴: "잔류농약*" -> 잔류농약으로 시작하는 모든 유형 매칭
                prefix = sample_type_filter[:-1]  # '*' 제거
                if not sample_type.startswith(prefix):
                    continue
            elif sample_type != sample_type_filter:
                continue
        if item_filter and item_filter != '전체' and item_name != item_filter:
            continue
        if manager_filter and manager_filter != '전체' and manager != manager_filter:
            continue

        # 월 추출
        month = 0
        if date:
            if hasattr(date, 'month'):
                month = date.month
            else:
                try:
                    month = int(str(date).split('-')[1])
                except:
                    month = 0

        total_fee += fee

        # 잔류농약(참고용), 항생물질(참고용)은 접수일자+업체명+검체유형으로 고유 카운트
        is_pesticide_ref = purpose == '잔류농약(참고용)'
        is_antibiotic_ref = purpose == '항생물질(참고용)'
        should_count_as_sample = True  # 이 행을 샘플 건수로 카운트할지 여부

        if is_pesticide_ref or is_antibiotic_ref:
            # 고유 식별 키: 접수일자 + 업체명 + 검체유형
            unique_key = (str(date), company, sample_type)
            if unique_key not in unique_pesticide_samples:
                unique_pesticide_samples.add(unique_key)
                total_count += 1
                if is_pesticide_ref:
                    pesticide_unique_count += 1
                else:
                    antibiotic_unique_count += 1
            else:
                should_count_as_sample = False  # 이미 카운트된 샘플
        else:
            # 일반 항목은 건별로 카운트
            total_count += 1

        # 항목별 집계
        if item_name:
            if item_name not in by_item:
                by_item[item_name] = {'count': 0, 'fee': 0}
            by_item[item_name]['count'] += 1
            by_item[item_name]['fee'] += fee

            # 항목별-월별
            if month > 0:
                if item_name not in by_item_month:
                    by_item_month[item_name] = {}
                if month not in by_item_month[item_name]:
                    by_item_month[item_name][month] = 0
                by_item_month[item_name][month] += 1

            # 항목별-분석자
            if item_name not in by_item_analyzer:
                by_item_analyzer[item_name] = {}
            if analyzer not in by_item_analyzer[item_name]:
                by_item_analyzer[item_name][analyzer] = {'count': 0, 'fee': 0}
            by_item_analyzer[item_name][analyzer]['count'] += 1
            by_item_analyzer[item_name][analyzer]['fee'] += fee

        # 검체유형별-항목
        if sample_type:
            if sample_type not in by_sample_type_item:
                by_sample_type_item[sample_type] = {}
            if item_name:
                if item_name not in by_sample_type_item[sample_type]:
                    by_sample_type_item[sample_type][item_name] = {'count': 0, 'fee': 0}
                by_sample_type_item[sample_type][item_name]['count'] += 1
                by_sample_type_item[sample_type][item_name]['fee'] += fee

        # 영업담당별 집계 (잔류농약/항생물질은 고유 샘플만 카운트)
        if manager not in by_manager_item:
            by_manager_item[manager] = {'count': 0, 'fee': 0, 'items': {}}
        if should_count_as_sample:
            by_manager_item[manager]['count'] += 1
        by_manager_item[manager]['fee'] += fee
        if item_name:
            if item_name not in by_manager_item[manager]['items']:
                by_manager_item[manager]['items'][item_name] = {'count': 0, 'fee': 0}
            by_manager_item[manager]['items'][item_name]['count'] += 1
            by_manager_item[manager]['items'][item_name]['fee'] += fee

        # 월별 수수료 (잔류농약/항생물질은 고유 샘플만 카운트)
        if month > 0:
            if month not in by_month_fee:
                by_month_fee[month] = {'count': 0, 'fee': 0}
            if should_count_as_sample:
                by_month_fee[month]['count'] += 1
            by_month_fee[month]['fee'] += fee

            # 월별-항목 (NEW)
            if item_name:
                if month not in by_month_item:
                    by_month_item[month] = {}
                if item_name not in by_month_item[month]:
                    by_month_item[month][item_name] = 0
                by_month_item[month][item_name] += 1

        # 검사목적별-항목 (NEW)
        if purpose and item_name:
            if purpose not in by_purpose_item:
                by_purpose_item[purpose] = {}
            if item_name not in by_purpose_item[purpose]:
                by_purpose_item[purpose][item_name] = {'count': 0, 'fee': 0}
            by_purpose_item[purpose][item_name]['count'] += 1
            by_purpose_item[purpose][item_name]['fee'] += fee

        # 분석자별 집계 (잔류농약/항생물질은 고유 샘플만 카운트)
        if analyzer and analyzer != '미지정':
            if analyzer not in by_analyzer:
                by_analyzer[analyzer] = {'count': 0, 'fee': 0, 'items': set()}
            if should_count_as_sample:
                by_analyzer[analyzer]['count'] += 1
            by_analyzer[analyzer]['fee'] += fee
            if item_name:
                by_analyzer[analyzer]['items'].add(item_name)

            # 분석자별-항목 (NEW)
            if item_name:
                if analyzer not in by_analyzer_item:
                    by_analyzer_item[analyzer] = {}
                if item_name not in by_analyzer_item[analyzer]:
                    by_analyzer_item[analyzer][item_name] = 0
                by_analyzer_item[analyzer][item_name] += 1

    # 항목별 분석자 다양성 계산 (NEW)
    item_analyzer_diversity = []
    for item_name, analyzers_data in by_item_analyzer.items():
        analyzer_count = len(analyzers_data)
        item_total = sum(a['count'] for a in analyzers_data.values())  # 변수명 변경 (total_count 충돌 방지)
        top_analyzers = sorted(analyzers_data.items(), key=lambda x: x[1]['count'], reverse=True)[:5]
        item_analyzer_diversity.append({
            'item': item_name,
            'total_count': item_total,
            'analyzer_count': analyzer_count,
            'top_analyzers': [(name, data['count']) for name, data in top_analyzers]
        })
    item_analyzer_diversity.sort(key=lambda x: x['total_count'], reverse=True)

    # 결과 정리
    by_item_sorted = sorted(by_item.items(), key=lambda x: x[1]['count'], reverse=True)
    by_manager_sorted = sorted(by_manager_item.items(), key=lambda x: x[1]['fee'], reverse=True)

    # 분석자별 정렬
    by_analyzer_sorted = [(name, {'count': d['count'], 'fee': d['fee'], 'item_count': len(d['items'])})
                          for name, d in sorted(by_analyzer.items(), key=lambda x: x[1]['count'], reverse=True)]

    return {
        'by_item': by_item_sorted,
        'by_item_month': {k: list(v.items()) for k, v in by_item_month.items()},
        'by_item_analyzer': {k: sorted(v.items(), key=lambda x: x[1]['count'], reverse=True)
                            for k, v in by_item_analyzer.items()},
        'by_sample_type_item': {k: sorted(v.items(), key=lambda x: x[1]['count'], reverse=True)
                               for k, v in by_sample_type_item.items()},
        'by_manager_item': by_manager_sorted,
        'by_month_fee': list(by_month_fee.items()),
        'purposes': sorted(purposes),
        'sample_types': sorted(sample_types),
        'items': sorted(items),
        'managers': sorted(managers),
        'analyzers': sorted(analyzers),
        'total_fee': total_fee,
        'total_count': total_count,
        'pesticide_unique_count': pesticide_unique_count,  # 잔류농약(참고용) 고유 건수
        'antibiotic_unique_count': antibiotic_unique_count,  # 항생물질(참고용) 고유 건수
        'by_purpose_sample_type': {k: sorted(v) for k, v in by_purpose_sample_type.items()},
        'by_purpose_sample_type_item': {k: sorted(v) for k, v in by_purpose_sample_type_item.items()},
        # 새로운 데이터 (전체 항목 포함 - UI에서 필요시 제한)
        'by_purpose_item': {k: sorted(v.items(), key=lambda x: x[1]['count'], reverse=True)
                           for k, v in by_purpose_item.items()},
        'by_analyzer': by_analyzer_sorted[:30],
        'by_analyzer_item': {k: sorted(v.items(), key=lambda x: x[1], reverse=True)[:20]
                            for k, v in by_analyzer_item.items()},
        'by_month_item': {m: sorted(items.items(), key=lambda x: x[1], reverse=True)[:10]
                         for m, items in by_month_item.items()},
        'item_analyzer_diversity': item_analyzer_diversity[:50]
    }

def extract_region(address):
    """주소에서 시/도, 시/군/구 추출"""
    if not address:
        return None, None

    addr = str(address).strip()
    if not addr:
        return None, None

    # 시/도 추출
    sido = None
    sigungu = None

    # 광역시/특별시/도 패턴 (전체 이름 + 약칭)
    sido_full_to_short = {
        '서울특별시': '서울', '서울시': '서울', '서울': '서울',
        '부산광역시': '부산', '부산시': '부산', '부산': '부산',
        '대구광역시': '대구', '대구시': '대구', '대구': '대구',
        '인천광역시': '인천', '인천시': '인천', '인천': '인천',
        '광주광역시': '광주', '광주시': '광주', '광주': '광주',
        '대전광역시': '대전', '대전시': '대전', '대전': '대전',
        '울산광역시': '울산', '울산시': '울산', '울산': '울산',
        '세종특별자치시': '세종', '세종시': '세종', '세종': '세종',
        '경기도': '경기', '경기': '경기',
        '강원도': '강원', '강원특별자치도': '강원', '강원': '강원',
        '충청북도': '충북', '충북': '충북',
        '충청남도': '충남', '충남': '충남',
        '전라북도': '전북', '전북특별자치도': '전북', '전북': '전북',
        '전라남도': '전남', '전남': '전남',
        '경상북도': '경북', '경북': '경북',
        '경상남도': '경남', '경남': '경남',
        '제주특별자치도': '제주', '제주도': '제주', '제주': '제주'
    }

    # 긴 이름부터 매칭 (충청북도가 충북보다 먼저 매칭되도록)
    for full_name in sorted(sido_full_to_short.keys(), key=len, reverse=True):
        if full_name in addr:
            sido = sido_full_to_short[full_name]
            break

    # 시/군/구 추출 (첫 번째 시/군/구 단위)
    import re
    # 시, 군, 구 패턴 매칭
    match = re.search(r'([가-힣]+(?:시|군|구))', addr)
    if match:
        sigungu = match.group(1)
        # 시도명이 시군구에 포함되어 있으면 다음 매칭 찾기
        if sido and (sigungu == sido + '시' or sigungu == sido + '도'):
            matches = re.findall(r'([가-힣]+(?:시|군|구))', addr)
            if len(matches) > 1:
                sigungu = matches[1]

    return sido, sigungu

def process_data(data, purpose_filter=None, prev_year_clients=None):
    """데이터 처리

    Args:
        data: 처리할 데이터 목록
        purpose_filter: 검사목적 필터 (옵션)
        prev_year_clients: 전년도 거래처 목록 (신규/기존 판단용)
    """
    by_manager = {}
    by_branch = {}
    by_month = {}
    by_client = {}
    by_purpose = {}
    by_defect = {}
    by_defect_month = {}
    by_defect_purpose = {}  # 부적합-검사목적별 데이터
    by_defect_purpose_month = {}  # 부적합-검사목적별-월별 데이터
    by_defect_manager = {}  # 부적합-담당자별 데이터
    by_defect_client = {}  # 부적합-업체별 데이터
    by_defect_season = {}  # 부적합-계절별 데이터
    defect_monthly_total = {}  # 부적합 월별 총 건수
    by_purpose_month = {}  # 목적별-월별 데이터
    by_region = {}  # 지역별 데이터
    by_region_manager = {}  # 지역-담당자별 데이터
    by_purpose_manager = {}  # 목적별-담당자 데이터
    by_purpose_region = {}  # 목적별-지역 데이터
    by_sample_type = {}  # 검체유형별 데이터
    by_sample_type_month = {}  # 검체유형별-월별 데이터
    by_sample_type_manager = {}  # 검체유형별-담당자 데이터
    by_sample_type_purpose = {}  # 검체유형별-목적 데이터
    by_urgent_month = {}  # 월별 긴급 데이터
    by_branch_month_clients = {}  # 지사별 월별 거래처 (중복 분석용)
    purpose_month_clients = {}  # 목적별 월별 거래처 (필터링용)
    client_purpose_months = {}  # 거래처+목적별 월별 거래 추적 (지속적인 거래 분석용)
    client_sample_type_months = {}  # 거래처+검체유형별 월별 거래 추적
    by_department = {}  # 부서별 데이터 (본사, 마케팅, 영업부, 지사)
    purposes = set()
    sample_types = set()  # 검체유형 목록
    total_sales = 0
    total_count = 0

    # 주소 컬럼 자동 감지
    address_columns = ['거래처 주소', '채품지주소', '채품장소', '주소', '시료주소', '업체주소', '거래처주소', '검체주소', '시료채취장소']

    for row in data:
        purpose = str(row.get('검사목적', '') or '').strip()
        purposes.add(purpose) if purpose else None

        # 검사목적 필터 적용
        if purpose_filter and purpose_filter != '전체' and purpose != purpose_filter:
            continue

        manager = row.get('영업담당', '미지정')
        sales = row.get('공급가액', 0) or 0
        date = row.get('접수일자')
        client = str(row.get('거래처', '') or '').strip() or '미지정'
        defect = str(row.get('부적합항목', '') or '').strip()
        sample_type = str(row.get('검체유형', '') or '').strip()
        urgent_raw = str(row.get('긴급여부', '') or '').strip()
        # '일반'이 아니고 값이 있으면 모두 긴급으로 처리
        is_urgent = urgent_raw and urgent_raw != '일반'
        if sample_type:
            sample_types.add(sample_type)

        if isinstance(sales, str):
            sales = float(sales.replace(',', '').replace('원', '')) if sales else 0

        # 매니저별
        if manager not in by_manager:
            by_manager[manager] = {'sales': 0, 'count': 0, 'clients': {}, 'urgent': 0, 'urgent_by_purpose': {}, 'by_purpose': {}}
        by_manager[manager]['sales'] += sales
        by_manager[manager]['count'] += 1
        # 검사목적별 매출/건수 추가
        if purpose:
            if purpose not in by_manager[manager]['by_purpose']:
                by_manager[manager]['by_purpose'][purpose] = {'sales': 0, 'count': 0}
            by_manager[manager]['by_purpose'][purpose]['sales'] += sales
            by_manager[manager]['by_purpose'][purpose]['count'] += 1
        if is_urgent:
            by_manager[manager]['urgent'] += 1
            # 검사목적별 긴급 건수 추가
            if purpose:
                if purpose not in by_manager[manager]['urgent_by_purpose']:
                    by_manager[manager]['urgent_by_purpose'][purpose] = 0
                by_manager[manager]['urgent_by_purpose'][purpose] += 1
        if client not in by_manager[manager]['clients']:
            by_manager[manager]['clients'][client] = {'sales': 0, 'count': 0}
        by_manager[manager]['clients'][client]['sales'] += sales
        by_manager[manager]['clients'][client]['count'] += 1

        # 지사별
        branch = MANAGER_TO_BRANCH.get(manager, '기타')
        if branch not in by_branch:
            by_branch[branch] = {'sales': 0, 'count': 0, 'managers': set(), 'by_purpose': {}}
        by_branch[branch]['sales'] += sales
        by_branch[branch]['count'] += 1
        by_branch[branch]['managers'].add(manager)

        # 팀별 검사목적별 데이터
        if purpose:
            if purpose not in by_branch[branch]['by_purpose']:
                by_branch[branch]['by_purpose'][purpose] = {'sales': 0, 'count': 0}
            by_branch[branch]['by_purpose'][purpose]['sales'] += sales
            by_branch[branch]['by_purpose'][purpose]['count'] += 1

        # 부서별 (본사, 마케팅, 영업부, 지사)
        department = MANAGER_TO_DEPARTMENT.get(manager, '기타')
        if department not in by_department:
            by_department[department] = {'sales': 0, 'count': 0}
        by_department[department]['sales'] += sales
        by_department[department]['count'] += 1

        # 월별
        month = 0
        if date:
            if hasattr(date, 'month'):
                month = date.month
            else:
                try:
                    month = int(str(date).split('-')[1])
                except:
                    month = 0

        if month > 0:
            if month not in by_month:
                by_month[month] = {'sales': 0, 'count': 0, 'byPurpose': {}, 'byManager': {}, 'byBranch': {}, 'clients': set()}
            by_month[month]['sales'] += sales
            by_month[month]['count'] += 1
            # 월별 거래 업체 추적 (제외 대상 제외)
            if client and client not in EXCLUDED_CLIENTS:
                by_month[month]['clients'].add(client)

            # 월별 검사목적별 데이터
            if purpose:
                if purpose not in by_month[month]['byPurpose']:
                    by_month[month]['byPurpose'][purpose] = {'sales': 0, 'count': 0}
                by_month[month]['byPurpose'][purpose]['sales'] += sales
                by_month[month]['byPurpose'][purpose]['count'] += 1

            # 월별 담당자별 데이터
            if manager not in by_month[month]['byManager']:
                by_month[month]['byManager'][manager] = {'sales': 0, 'count': 0, 'byPurpose': {}}
            by_month[month]['byManager'][manager]['sales'] += sales
            by_month[month]['byManager'][manager]['count'] += 1
            # 월별 담당자별 검사목적 데이터
            if purpose:
                if purpose not in by_month[month]['byManager'][manager]['byPurpose']:
                    by_month[month]['byManager'][manager]['byPurpose'][purpose] = {'sales': 0, 'count': 0}
                by_month[month]['byManager'][manager]['byPurpose'][purpose]['sales'] += sales
                by_month[month]['byManager'][manager]['byPurpose'][purpose]['count'] += 1

            # 월별 팀별 데이터
            if branch not in by_month[month]['byBranch']:
                by_month[month]['byBranch'][branch] = {'sales': 0, 'count': 0, 'byPurpose': {}}
            by_month[month]['byBranch'][branch]['sales'] += sales
            by_month[month]['byBranch'][branch]['count'] += 1
            # 월별 팀별 검사목적 데이터
            if purpose:
                if purpose not in by_month[month]['byBranch'][branch]['byPurpose']:
                    by_month[month]['byBranch'][branch]['byPurpose'][purpose] = {'sales': 0, 'count': 0}
                by_month[month]['byBranch'][branch]['byPurpose'][purpose]['sales'] += sales
                by_month[month]['byBranch'][branch]['byPurpose'][purpose]['count'] += 1

            # 월별 긴급 데이터 (담당자별, 검사목적별 세분화)
            if month not in by_urgent_month:
                by_urgent_month[month] = {'sales': 0, 'count': 0, 'byManager': {}, 'byPurpose': {}}
            if is_urgent:
                by_urgent_month[month]['sales'] += sales
                by_urgent_month[month]['count'] += 1
                # 긴급 담당자별
                if manager and manager != '미지정':
                    if manager not in by_urgent_month[month]['byManager']:
                        by_urgent_month[month]['byManager'][manager] = {'sales': 0, 'count': 0}
                    by_urgent_month[month]['byManager'][manager]['sales'] += sales
                    by_urgent_month[month]['byManager'][manager]['count'] += 1
                # 긴급 검사목적별
                if purpose:
                    if purpose not in by_urgent_month[month]['byPurpose']:
                        by_urgent_month[month]['byPurpose'][purpose] = {'sales': 0, 'count': 0}
                    by_urgent_month[month]['byPurpose'][purpose]['sales'] += sales
                    by_urgent_month[month]['byPurpose'][purpose]['count'] += 1

            # 지사별 월별 거래처 (중복 분석용)
            if branch not in by_branch_month_clients:
                by_branch_month_clients[branch] = {}
            if month not in by_branch_month_clients[branch]:
                by_branch_month_clients[branch][month] = set()
            if client and client != '미지정':
                by_branch_month_clients[branch][month].add(client)

            # 목적별 월별 거래처 (필터링용)
            if purpose and client and client != '미지정':
                if purpose not in purpose_month_clients:
                    purpose_month_clients[purpose] = {}
                if month not in purpose_month_clients[purpose]:
                    purpose_month_clients[purpose][month] = set()
                purpose_month_clients[purpose][month].add(client)

        # 거래처별 - 주소 추출
        client_address = None
        for col in address_columns:
            if row.get(col):
                client_address = str(row.get(col, '')).strip()
                break

        # 시험분야, 업체분류 추출
        test_field = str(row.get('시험분야', '') or '').strip()  # 식품, 축산 등
        company_type = str(row.get('업체분류', '') or '').strip()  # 식품, 축산, 식품,축산 등

        # 거래처별
        if client not in by_client:
            by_client[client] = {'sales': 0, 'count': 0, 'purposes': {}, 'managers': {}, 'months': set(), 'address': '', 'test_fields': set(), 'company_types': set()}
        by_client[client]['sales'] += sales
        by_client[client]['count'] += 1
        # 시험분야 저장
        if test_field:
            by_client[client]['test_fields'].add(test_field)
        # 업체분류 저장
        if company_type:
            by_client[client]['company_types'].add(company_type)
        # 주소 저장 (첫번째 유효한 주소 사용)
        if client_address and not by_client[client]['address']:
            by_client[client]['address'] = client_address
        # 거래처별 담당자 집계
        if manager and manager != '미지정':
            if manager not in by_client[client]['managers']:
                by_client[client]['managers'][manager] = {'sales': 0, 'count': 0}
            by_client[client]['managers'][manager]['sales'] += sales
            by_client[client]['managers'][manager]['count'] += 1
        # 거래처별 거래 월 추적
        if month > 0:
            by_client[client]['months'].add(month)
        if purpose:
            if purpose not in by_client[client]['purposes']:
                by_client[client]['purposes'][purpose] = {'sales': 0, 'count': 0}
            by_client[client]['purposes'][purpose]['sales'] += sales
            by_client[client]['purposes'][purpose]['count'] += 1

            # 거래처+유형별 월별 거래 추적
            if month > 0:
                cp_key = f"{client}|{purpose}"
                if cp_key not in client_purpose_months:
                    client_purpose_months[cp_key] = {'client': client, 'purpose': purpose, 'months': set(), 'sales': 0, 'count': 0}
                client_purpose_months[cp_key]['months'].add(month)
                client_purpose_months[cp_key]['sales'] += sales
                client_purpose_months[cp_key]['count'] += 1

        # 검사목적별
        if purpose:
            if purpose not in by_purpose:
                by_purpose[purpose] = {'sales': 0, 'count': 0}
            by_purpose[purpose]['sales'] += sales
            by_purpose[purpose]['count'] += 1

            # 목적별-담당자 데이터
            if purpose not in by_purpose_manager:
                by_purpose_manager[purpose] = {}
            if manager not in by_purpose_manager[purpose]:
                by_purpose_manager[purpose][manager] = {'sales': 0, 'count': 0}
            by_purpose_manager[purpose][manager]['sales'] += sales
            by_purpose_manager[purpose][manager]['count'] += 1

            # 목적별-월별 데이터
            if month > 0:
                if purpose not in by_purpose_month:
                    by_purpose_month[purpose] = {}
                if month not in by_purpose_month[purpose]:
                    by_purpose_month[purpose][month] = {'sales': 0, 'count': 0, 'by_manager': {}}
                by_purpose_month[purpose][month]['sales'] += sales
                by_purpose_month[purpose][month]['count'] += 1
                # 담당자별 월별 목적 데이터
                if manager not in by_purpose_month[purpose][month]['by_manager']:
                    by_purpose_month[purpose][month]['by_manager'][manager] = {'sales': 0, 'count': 0}
                by_purpose_month[purpose][month]['by_manager'][manager]['sales'] += sales
                by_purpose_month[purpose][month]['by_manager'][manager]['count'] += 1

        # 부적합항목별
        if defect:
            if defect not in by_defect:
                by_defect[defect] = {'count': 0}
            by_defect[defect]['count'] += 1

            # 부적합항목 월별
            if month > 0:
                if defect not in by_defect_month:
                    by_defect_month[defect] = {}
                if month not in by_defect_month[defect]:
                    by_defect_month[defect][month] = 0
                by_defect_month[defect][month] += 1

                # 월별 총 부적합 건수
                if month not in defect_monthly_total:
                    defect_monthly_total[month] = {'count': 0, 'by_purpose': {}}
                defect_monthly_total[month]['count'] += 1
                if purpose:
                    if purpose not in defect_monthly_total[month]['by_purpose']:
                        defect_monthly_total[month]['by_purpose'][purpose] = 0
                    defect_monthly_total[month]['by_purpose'][purpose] += 1

                # 계절별 부적합
                season = '봄' if month in [3, 4, 5] else '여름' if month in [6, 7, 8] else '가을' if month in [9, 10, 11] else '겨울'
                if season not in by_defect_season:
                    by_defect_season[season] = {'count': 0, 'months': set(), 'defects': {}, 'by_purpose': {}}
                by_defect_season[season]['count'] += 1
                by_defect_season[season]['months'].add(month)
                if defect not in by_defect_season[season]['defects']:
                    by_defect_season[season]['defects'][defect] = 0
                by_defect_season[season]['defects'][defect] += 1
                if purpose:
                    if purpose not in by_defect_season[season]['by_purpose']:
                        by_defect_season[season]['by_purpose'][purpose] = 0
                    by_defect_season[season]['by_purpose'][purpose] += 1

            # 부적합항목-담당자별
            if manager and manager != '미지정':
                if manager not in by_defect_manager:
                    by_defect_manager[manager] = {'count': 0, 'defects': {}, 'by_purpose': {}}
                by_defect_manager[manager]['count'] += 1
                if defect not in by_defect_manager[manager]['defects']:
                    by_defect_manager[manager]['defects'][defect] = 0
                by_defect_manager[manager]['defects'][defect] += 1
                if purpose:
                    if purpose not in by_defect_manager[manager]['by_purpose']:
                        by_defect_manager[manager]['by_purpose'][purpose] = 0
                    by_defect_manager[manager]['by_purpose'][purpose] += 1

            # 부적합항목-업체별
            if client and client != '미지정':
                if client not in by_defect_client:
                    by_defect_client[client] = {'count': 0, 'defects': {}, 'by_purpose': {}}
                by_defect_client[client]['count'] += 1
                if defect not in by_defect_client[client]['defects']:
                    by_defect_client[client]['defects'][defect] = 0
                by_defect_client[client]['defects'][defect] += 1
                if purpose:
                    if purpose not in by_defect_client[client]['by_purpose']:
                        by_defect_client[client]['by_purpose'][purpose] = 0
                    by_defect_client[client]['by_purpose'][purpose] += 1

            # 부적합항목-검사목적별
            if purpose:
                if purpose not in by_defect_purpose:
                    by_defect_purpose[purpose] = {}
                if defect not in by_defect_purpose[purpose]:
                    by_defect_purpose[purpose][defect] = {'count': 0}
                by_defect_purpose[purpose][defect]['count'] += 1

                # 부적합항목-검사목적별-월별
                if month > 0:
                    if purpose not in by_defect_purpose_month:
                        by_defect_purpose_month[purpose] = {}
                    if defect not in by_defect_purpose_month[purpose]:
                        by_defect_purpose_month[purpose][defect] = {}
                    if month not in by_defect_purpose_month[purpose][defect]:
                        by_defect_purpose_month[purpose][defect][month] = 0
                    by_defect_purpose_month[purpose][defect][month] += 1

        # 검체유형별
        if sample_type:
            if sample_type not in by_sample_type:
                by_sample_type[sample_type] = {'sales': 0, 'count': 0}
            by_sample_type[sample_type]['sales'] += sales
            by_sample_type[sample_type]['count'] += 1

            # 검체유형별-담당자 데이터
            if sample_type not in by_sample_type_manager:
                by_sample_type_manager[sample_type] = {}
            if manager not in by_sample_type_manager[sample_type]:
                by_sample_type_manager[sample_type][manager] = {'sales': 0, 'count': 0, 'by_purpose': {}}
            by_sample_type_manager[sample_type][manager]['sales'] += sales
            by_sample_type_manager[sample_type][manager]['count'] += 1
            # 담당자별 목적 데이터 추가
            if purpose:
                if purpose not in by_sample_type_manager[sample_type][manager]['by_purpose']:
                    by_sample_type_manager[sample_type][manager]['by_purpose'][purpose] = {'sales': 0, 'count': 0}
                by_sample_type_manager[sample_type][manager]['by_purpose'][purpose]['sales'] += sales
                by_sample_type_manager[sample_type][manager]['by_purpose'][purpose]['count'] += 1

            # 검체유형별-목적 데이터
            if purpose:
                if sample_type not in by_sample_type_purpose:
                    by_sample_type_purpose[sample_type] = {}
                if purpose not in by_sample_type_purpose[sample_type]:
                    by_sample_type_purpose[sample_type][purpose] = {'sales': 0, 'count': 0}
                by_sample_type_purpose[sample_type][purpose]['sales'] += sales
                by_sample_type_purpose[sample_type][purpose]['count'] += 1

            # 검체유형별-월별 데이터
            if month > 0:
                if sample_type not in by_sample_type_month:
                    by_sample_type_month[sample_type] = {}
                if month not in by_sample_type_month[sample_type]:
                    by_sample_type_month[sample_type][month] = {'sales': 0, 'count': 0, 'by_manager': {}, 'by_purpose': {}}
                by_sample_type_month[sample_type][month]['sales'] += sales
                by_sample_type_month[sample_type][month]['count'] += 1
                # 담당자별 월별 검체유형 데이터
                if manager not in by_sample_type_month[sample_type][month]['by_manager']:
                    by_sample_type_month[sample_type][month]['by_manager'][manager] = {'sales': 0, 'count': 0}
                by_sample_type_month[sample_type][month]['by_manager'][manager]['sales'] += sales
                by_sample_type_month[sample_type][month]['by_manager'][manager]['count'] += 1
                # 목적별 월별 검체유형 데이터
                if purpose:
                    if purpose not in by_sample_type_month[sample_type][month]['by_purpose']:
                        by_sample_type_month[sample_type][month]['by_purpose'][purpose] = {'sales': 0, 'count': 0}
                    by_sample_type_month[sample_type][month]['by_purpose'][purpose]['sales'] += sales
                    by_sample_type_month[sample_type][month]['by_purpose'][purpose]['count'] += 1

                # 거래처+검체유형별 월별 거래 추적
                cst_key = f"{client}|{sample_type}"
                if cst_key not in client_sample_type_months:
                    client_sample_type_months[cst_key] = {'client': client, 'sample_type': sample_type, 'months': set(), 'sales': 0, 'count': 0}
                client_sample_type_months[cst_key]['months'].add(month)
                client_sample_type_months[cst_key]['sales'] += sales
                client_sample_type_months[cst_key]['count'] += 1

        # 지역별 분석
        address = None
        for col in address_columns:
            if row.get(col):
                address = row.get(col)
                break

        sido, sigungu = extract_region(address)

        if sido:
            region_key = sido
            if sigungu:
                region_key = f"{sido} {sigungu}"

            # 지역별 통계
            if region_key not in by_region:
                by_region[region_key] = {'sales': 0, 'count': 0, 'sido': sido, 'sigungu': sigungu or '', 'managers': {}}
            by_region[region_key]['sales'] += sales
            by_region[region_key]['count'] += 1

            # 지역-담당자별 통계
            if manager not in by_region[region_key]['managers']:
                by_region[region_key]['managers'][manager] = {'sales': 0, 'count': 0}
            by_region[region_key]['managers'][manager]['sales'] += sales
            by_region[region_key]['managers'][manager]['count'] += 1

            # 담당자-지역별 통계
            if manager not in by_region_manager:
                by_region_manager[manager] = {}
            if region_key not in by_region_manager[manager]:
                by_region_manager[manager][region_key] = {'sales': 0, 'count': 0, 'sido': sido, 'sigungu': sigungu or ''}
            by_region_manager[manager][region_key]['sales'] += sales
            by_region_manager[manager][region_key]['count'] += 1

            # 목적별-지역 데이터
            if purpose:
                if purpose not in by_purpose_region:
                    by_purpose_region[purpose] = {}
                if region_key not in by_purpose_region[purpose]:
                    by_purpose_region[purpose][region_key] = {'sales': 0, 'count': 0}
                by_purpose_region[purpose][region_key]['sales'] += sales
                by_purpose_region[purpose][region_key]['count'] += 1

        total_sales += sales
        total_count += 1

    # 정렬 (EXCLUDED_MANAGERS 제외)
    sorted_managers = sorted(
        [(m, d) for m, d in by_manager.items() if m not in EXCLUDED_MANAGERS],
        key=lambda x: x[1]['sales'], reverse=True
    )
    sorted_branches = sorted(by_branch.items(), key=lambda x: x[1]['sales'], reverse=True)
    sorted_clients = sorted(
        [(c, d) for c, d in by_client.items() if c not in EXCLUDED_CLIENTS],
        key=lambda x: x[1]['sales'], reverse=True
    )
    sorted_purposes = sorted(by_purpose.items(), key=lambda x: x[1]['sales'], reverse=True)
    sorted_defects = sorted(by_defect.items(), key=lambda x: x[1]['count'], reverse=True)

    # 매니저별 TOP 10 거래처
    manager_top_clients = {}
    for mgr, data in sorted_managers:
        clients = sorted(data['clients'].items(), key=lambda x: x[1]['sales'], reverse=True)[:10]
        manager_top_clients[mgr] = clients

    # 고효율 업체 (높은 단가)
    high_efficiency = [(c, d) for c, d in sorted_clients if d['count'] > 0]
    high_efficiency = sorted(high_efficiency, key=lambda x: x[1]['sales'] / x[1]['count'] if x[1]['count'] > 0 else 0, reverse=True)[:20]

    # 대량 업체 (많은 건수)
    high_volume = sorted(by_client.items(), key=lambda x: x[1]['count'], reverse=True)[:20]

    # 지역별 정렬 (매출 기준)
    sorted_regions = sorted(by_region.items(), key=lambda x: x[1]['sales'], reverse=True)

    # 지역별 TOP 담당자
    region_top_managers = {}
    for region, data in sorted_regions:
        managers = sorted(data['managers'].items(), key=lambda x: x[1]['sales'], reverse=True)
        region_top_managers[region] = [
            {'name': m, 'sales': d['sales'], 'count': d['count']}
            for m, d in managers[:5]
        ]

    # 계층적 지역 데이터 (시도 > 시군구 > 업체/담당자)
    by_sido = {}
    for region, data in by_region.items():
        sido = data['sido']
        sigungu = data['sigungu']
        if sido not in by_sido:
            by_sido[sido] = {'sales': 0, 'count': 0, 'sigungu': {}, 'managers': {}, 'clients': set()}
        by_sido[sido]['sales'] += data['sales']
        by_sido[sido]['count'] += data['count']

        # 시군구별 집계
        if sigungu:
            if sigungu not in by_sido[sido]['sigungu']:
                by_sido[sido]['sigungu'][sigungu] = {'sales': 0, 'count': 0, 'managers': {}, 'clients': set()}
            by_sido[sido]['sigungu'][sigungu]['sales'] += data['sales']
            by_sido[sido]['sigungu'][sigungu]['count'] += data['count']
            # 시군구별 담당자
            for mgr, mgr_data in data['managers'].items():
                if mgr not in by_sido[sido]['sigungu'][sigungu]['managers']:
                    by_sido[sido]['sigungu'][sigungu]['managers'][mgr] = {'sales': 0, 'count': 0}
                by_sido[sido]['sigungu'][sigungu]['managers'][mgr]['sales'] += mgr_data['sales']
                by_sido[sido]['sigungu'][sigungu]['managers'][mgr]['count'] += mgr_data['count']

        # 시도별 담당자 합계
        for mgr, mgr_data in data['managers'].items():
            if mgr not in by_sido[sido]['managers']:
                by_sido[sido]['managers'][mgr] = {'sales': 0, 'count': 0}
            by_sido[sido]['managers'][mgr]['sales'] += mgr_data['sales']
            by_sido[sido]['managers'][mgr]['count'] += mgr_data['count']

    # 계층 데이터 정리 (JSON 직렬화를 위해 set 제거)
    sido_hierarchy = {}
    for sido, data in by_sido.items():
        sido_hierarchy[sido] = {
            'sales': data['sales'],
            'count': data['count'],
            'clientCount': len([sg for sg in data['sigungu'].values()]),
            'managers': sorted([{'name': m, 'sales': d['sales'], 'count': d['count']}
                              for m, d in data['managers'].items()],
                             key=lambda x: x['sales'], reverse=True)[:10],
            'sigungu': {
                sg: {
                    'sales': sg_data['sales'],
                    'count': sg_data['count'],
                    'managers': sorted([{'name': m, 'sales': d['sales'], 'count': d['count']}
                                       for m, d in sg_data['managers'].items()],
                                      key=lambda x: x['sales'], reverse=True)[:10]
                }
                for sg, sg_data in data['sigungu'].items()
            }
        }

    # 담당자별 지역 분포
    manager_regions = {}
    for mgr, regions in by_region_manager.items():
        sorted_mgr_regions = sorted(regions.items(), key=lambda x: x[1]['sales'], reverse=True)
        manager_regions[mgr] = [
            {'region': r, 'sales': d['sales'], 'count': d['count'], 'sido': d['sido'], 'sigungu': d['sigungu']}
            for r, d in sorted_mgr_regions[:10]
        ]

    # 목적별 담당자 데이터 정리
    purpose_managers = {}
    for purpose, managers in by_purpose_manager.items():
        sorted_pm = sorted(managers.items(), key=lambda x: x[1]['sales'], reverse=True)
        purpose_managers[purpose] = [
            {'name': m, 'sales': d['sales'], 'count': d['count']}
            for m, d in sorted_pm[:20]
        ]

    # 목적별 지역 데이터 정리
    purpose_regions = {}
    for purpose, regions in by_purpose_region.items():
        sorted_pr = sorted(regions.items(), key=lambda x: x[1]['sales'], reverse=True)
        purpose_regions[purpose] = [
            {'region': r, 'sales': d['sales'], 'count': d['count']}
            for r, d in sorted_pr[:20]
        ]

    # 검체유형별 정렬
    sorted_sample_types = sorted(by_sample_type.items(), key=lambda x: x[1]['sales'], reverse=True)

    # 검체유형별 담당자 데이터 정리
    sample_type_managers = {}
    for st, managers in by_sample_type_manager.items():
        sorted_stm = sorted(managers.items(), key=lambda x: x[1]['sales'], reverse=True)
        sample_type_managers[st] = [
            {'name': m, 'sales': d['sales'], 'count': d['count'], 'by_purpose': d.get('by_purpose', {})}
            for m, d in sorted_stm[:20]
        ]

    # 검체유형별 목적 데이터 정리
    sample_type_purposes = {}
    for st, purposes_data in by_sample_type_purpose.items():
        sorted_stp = sorted(purposes_data.items(), key=lambda x: x[1]['sales'], reverse=True)
        sample_type_purposes[st] = [
            {'name': p, 'sales': d['sales'], 'count': d['count']}
            for p, d in sorted_stp[:20]
        ]

    # 지사별 월별 거래처 중복률 계산 (전년도 기준)
    branch_client_retention = {}
    for branch, month_clients in by_branch_month_clients.items():
        months = sorted(month_clients.keys())
        retention_data = []
        # 전년도 거래처로 초기화
        all_clients = set(prev_year_clients) if prev_year_clients else set()
        for month in months:
            clients = month_clients[month]
            # 기존 거래처: 전년도 또는 이전 월에 거래한 적 있는 거래처
            overlap = len(clients & all_clients)
            new_clients = len(clients - all_clients)
            retention_rate = (overlap / len(all_clients) * 100) if all_clients else 0
            retention_data.append({
                'month': month,
                'total': len(clients),
                'overlap': overlap,
                'retention': round(retention_rate, 1),
                'new': new_clients
            })
            all_clients.update(clients)
        branch_client_retention[branch] = retention_data

    # 목적별 월별 거래처 중복률 계산 (전년도 기준)
    purpose_client_retention = {}
    for purpose, month_clients in purpose_month_clients.items():
        months = sorted(month_clients.keys())
        retention_data = []
        # 전년도 거래처로 초기화
        all_clients = set(prev_year_clients) if prev_year_clients else set()
        for month in months:
            clients = month_clients[month]
            # 기존 거래처: 전년도 또는 이전 월에 거래한 적 있는 거래처
            overlap = len(clients & all_clients)
            new_clients = len(clients - all_clients)
            retention_rate = (overlap / len(all_clients) * 100) if all_clients else 0
            retention_data.append({
                'month': month,
                'total': len(clients),
                'overlap': overlap,
                'retention': round(retention_rate, 1),
                'new': new_clients
            })
            all_clients.update(clients)
        purpose_client_retention[purpose] = retention_data

    # 전체 월별 거래처 중복률 (모든 지사 합산)
    all_month_clients = {}
    for branch, month_clients in by_branch_month_clients.items():
        for month, clients in month_clients.items():
            if month not in all_month_clients:
                all_month_clients[month] = set()
            all_month_clients[month].update(clients)

    total_retention = []
    # 전년도 거래처가 있으면 기존 거래처 기준으로 사용
    cumulative_clients = set(prev_year_clients) if prev_year_clients else set()
    prev_year_base = set(prev_year_clients) if prev_year_clients else set()

    for month in sorted(all_month_clients.keys()):
        clients = all_month_clients[month]
        # 기존 거래처: 전년도 또는 이전 월에 거래한 적 있는 거래처
        overlap = len(clients & cumulative_clients)
        # 신규 거래처: 전년도에도 없고 올해 이전 월에도 없는 거래처
        new_clients = len(clients - cumulative_clients)
        retention_rate = (overlap / len(cumulative_clients) * 100) if cumulative_clients else 0

        total_retention.append({
            'month': month,
            'total': len(clients),
            'overlap': overlap,
            'retention': round(retention_rate, 1),
            'new': new_clients,
            'cumulative': len(cumulative_clients | clients),
            'prev_year_overlap': len(clients & prev_year_base) if prev_year_base else 0  # 전년도 대비 유지 거래처
        })
        cumulative_clients.update(clients)

    return {
        'by_manager': [(m, {'sales': d['sales'], 'count': d['count'], 'urgent': d.get('urgent', 0), 'urgent_by_purpose': d.get('urgent_by_purpose', {}), 'by_purpose': d.get('by_purpose', {})}) for m, d in sorted_managers],
        'by_branch': [(k, {'sales': v['sales'], 'count': v['count'], 'managers': list(v['managers']), 'by_purpose': v.get('by_purpose', {})})
                      for k, v in sorted_branches],
        'by_month': sorted([(m, {
            'sales': d['sales'],
            'count': d['count'],
            'clientCount': len(d.get('clients', set())),
            'byPurpose': d.get('byPurpose', {}),
            'byManager': d.get('byManager', {}),
            'byBranch': d.get('byBranch', {})
        }) for m, d in by_month.items()]),
        'by_urgent_month': sorted(by_urgent_month.items()),
        'by_client': [(c, {
            'sales': d['sales'],
            'count': d['count'],
            'avg': d['sales']/d['count'] if d['count'] > 0 else 0,
            'manager': max(d.get('managers', {}).items(), key=lambda x: x[1]['sales'])[0] if d.get('managers') else '미지정',
            'purpose': max(d.get('purposes', {}).items(), key=lambda x: x[1]['sales'])[0] if d.get('purposes') else '',
            'tradeMonths': len(d.get('months', set())),
            'purposes': d.get('purposes', {}),
            'byPurpose': {p: {'sales': pd['sales'], 'count': pd['count']} for p, pd in d.get('purposes', {}).items()},
            'byManager': {m: {'sales': md['sales'], 'count': md['count']} for m, md in d.get('managers', {}).items()},
            'address': d.get('address', ''),
            'testFields': list(d.get('test_fields', set())),  # 시험분야 (식품, 축산 등)
            'companyTypes': list(d.get('company_types', set()))  # 업체분류 (식품, 축산, 식품,축산 등)
        }) for c, d in sorted_clients],
        'by_purpose': sorted_purposes,
        'by_defect': sorted_defects[:30],
        'by_defect_month': {d: sorted(months.items()) for d, months in by_defect_month.items()},
        'by_defect_purpose': {p: sorted(defects.items(), key=lambda x: x[1]['count'], reverse=True)[:30] for p, defects in by_defect_purpose.items()},
        'by_defect_purpose_month': {p: {d: sorted(months.items()) for d, months in defects.items()} for p, defects in by_defect_purpose_month.items()},
        'by_defect_manager': [(m, {'count': d['count'], 'defects': sorted(d['defects'].items(), key=lambda x: x[1], reverse=True)[:10], 'by_purpose': d['by_purpose']}) for m, d in sorted(by_defect_manager.items(), key=lambda x: x[1]['count'], reverse=True)[:30]],
        'by_defect_client': [(c, {'count': d['count'], 'defects': sorted(d['defects'].items(), key=lambda x: x[1], reverse=True)[:10], 'by_purpose': d['by_purpose']}) for c, d in sorted(by_defect_client.items(), key=lambda x: x[1]['count'], reverse=True)[:50]],
        'by_defect_season': {s: {'count': d['count'], 'months': list(d['months']), 'defects': sorted(d['defects'].items(), key=lambda x: x[1], reverse=True)[:10], 'by_purpose': d['by_purpose']} for s, d in by_defect_season.items()},
        'defect_monthly_total': {m: {'count': d['count'], 'by_purpose': d['by_purpose']} for m, d in sorted(defect_monthly_total.items())},
        'by_purpose_month': {p: {m: {'sales': d['sales'], 'count': d['count'], 'by_manager': d.get('by_manager', {})} for m, d in months.items()} for p, months in by_purpose_month.items()},
        'manager_top_clients': manager_top_clients,
        'high_efficiency': [(c, {'sales': d['sales'], 'count': d['count'], 'avg': d['sales']/d['count'] if d['count'] > 0 else 0})
                           for c, d in high_efficiency],
        'high_volume': [(c, {'sales': d['sales'], 'count': d['count'], 'avg': d['sales']/d['count'] if d['count'] > 0 else 0})
                       for c, d in high_volume],
        'by_region': [(r, {'sales': d['sales'], 'count': d['count'], 'sido': d['sido'], 'sigungu': d['sigungu']})
                      for r, d in sorted_regions[:50]],
        'region_top_managers': region_top_managers,
        'sido_hierarchy': sido_hierarchy,
        'manager_regions': manager_regions,
        'purpose_managers': purpose_managers,
        'purpose_regions': purpose_regions,
        'purposes': sorted(list(purposes)),
        'by_sample_type': sorted_sample_types,
        'by_sample_type_month': {st: {m: {'sales': d['sales'], 'count': d['count'], 'by_manager': d.get('by_manager', {}), 'by_purpose': d.get('by_purpose', {})} for m, d in months.items()} for st, months in by_sample_type_month.items()},
        'sample_type_managers': sample_type_managers,
        'sample_type_purposes': sample_type_purposes,
        'sample_types': sorted(list(sample_types)),
        'branch_client_retention': branch_client_retention,
        'total_client_retention': total_retention,
        'purpose_client_retention': purpose_client_retention,
        'prev_year_client_count': len(prev_year_clients) if prev_year_clients else 0,
        'by_department': by_department,
        'total_sales': total_sales,
        'total_count': total_count,
        'client_purpose_months': [
            {'client': d['client'], 'purpose': d['purpose'], 'monthCount': len(d['months']), 'months': sorted(list(d['months'])), 'sales': d['sales'], 'count': d['count']}
            for d in sorted(client_purpose_months.values(), key=lambda x: (len(x['months']), x['sales']), reverse=True)
            if len(d['months']) >= 2  # 2개월 이상 지속된 거래만 포함
        ][:100],  # 상위 100개만
        'client_sample_type_months': [
            {'client': d['client'], 'sample_type': d['sample_type'], 'monthCount': len(d['months']), 'months': sorted(list(d['months'])), 'sales': d['sales'], 'count': d['count']}
            for d in sorted(client_sample_type_months.values(), key=lambda x: (len(x['months']), x['sales']), reverse=True)
            if len(d['months']) >= 2  # 2개월 이상 지속된 거래만 포함
        ][:100]  # 상위 100개만
    }

# ============ 로그인 페이지 템플릿 ============
LOGIN_TEMPLATE = '''
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:,">
    <title>로그인 - 실적 분석 시스템</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Malgun Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #a8b5d6 50%, #c5a8d6 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .login-container {
            background: white;
            border-radius: 16px;
            padding: 50px 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            text-align: center;
            max-width: 420px;
            width: 90%;
        }
        .logo-container {
            margin-bottom: 10px;
        }
        .logo-text {
            font-size: 48px;
            font-weight: bold;
            color: #00a0a0;
            letter-spacing: 2px;
        }
        .logo-anniversary {
            font-size: 14px;
            color: #e07040;
            margin-top: 5px;
        }
        .program-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin: 25px 0 5px 0;
        }
        .program-subtitle {
            font-size: 14px;
            color: #888;
            margin-bottom: 25px;
        }
        .login-form { width: 100%; }
        .form-group {
            margin-bottom: 18px;
            text-align: left;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-size: 14px;
            font-weight: 500;
        }
        .form-group input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.3s, box-shadow 0.3s;
            background: #fff;
        }
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #5b7bd5 0%, #8b5e9e 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 5px;
        }
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        .error-msg {
            background: #fff0f0;
            color: #e05050;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }
        .error-msg.show {
            display: block;
        }
        .copyright {
            margin-top: 30px;
            color: #aaa;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="logo-container">
            <div class="logo-text">BFL</div>
            <div class="logo-anniversary">10th Anniversary</div>
        </div>
        <h1 class="program-title">실적 분석 시스템</h1>
        <p class="program-subtitle">Business Performance Analytics</p>
        <form class="login-form" onsubmit="return handleLogin(event)">
            <div class="error-msg" id="errorMsg"></div>
            <div class="form-group">
                <label for="username">아이디</label>
                <input type="text" id="username" name="username" required autocomplete="username">
            </div>
            <div class="form-group">
                <label for="password">비밀번호</label>
                <input type="password" id="password" name="password" required autocomplete="current-password">
            </div>
            <button type="submit" class="login-btn">로그인</button>
        </form>
        <p class="copyright">© 2026 HS.KIM. All rights reserved</p>
    </div>
    <script>
        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('errorMsg');

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();

                if (data.success) {
                    window.location.href = '/';
                } else {
                    errorMsg.textContent = data.error || '로그인 실패';
                    errorMsg.classList.add('show');
                }
            } catch (err) {
                errorMsg.textContent = '서버 연결에 실패했습니다.';
                errorMsg.classList.add('show');
            }
            return false;
        }
    </script>
</body>
</html>
'''

# ============ 관리자 페이지 템플릿 ============
ADMIN_TEMPLATE = '''
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:,">
    <title>관리자 - 실적 분석 시스템</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Malgun Gothic', sans-serif; background: #f5f5f5; min-height: 100vh; }
        .admin-header { background: linear-gradient(135deg, #1a1a2e 0%, #0f3460 100%); color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; }
        .admin-header h1 { font-size: 24px; }
        .admin-header a { color: white; text-decoration: none; padding: 8px 16px; background: rgba(255,255,255,0.2); border-radius: 5px; margin-left: 10px; }
        .admin-container { display: flex; min-height: calc(100vh - 70px); }
        .admin-sidebar { width: 240px; background: #1a1a2e; padding: 20px 0; }
        .sidebar-section { margin-bottom: 10px; }
        .sidebar-title { color: #64748b; font-size: 11px; padding: 10px 20px; text-transform: uppercase; letter-spacing: 1px; }
        .sidebar-item { display: flex; align-items: center; gap: 10px; padding: 12px 20px; color: #94a3b8; cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; }
        .sidebar-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .sidebar-item.active { background: rgba(99,102,241,0.2); color: #818cf8; border-left-color: #818cf8; }
        .sidebar-item i { width: 20px; text-align: center; }
        .admin-content { flex: 1; padding: 30px; overflow-y: auto; }
        .admin-panel { display: none; }
        .admin-panel.active { display: block; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .panel-header h2 { font-size: 22px; color: #1e293b; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .card-title { font-size: 16px; font-weight: 600; color: #334155; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
        .btn-primary { background: #6366f1; color: white; }
        .btn-primary:hover { background: #4f46e5; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background: #f8fafc; font-weight: 600; color: #475569; font-size: 13px; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-info { background: #dbeafe; color: #1e40af; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 500; color: #374151; font-size: 14px; }
        .form-control { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; }
        .form-control:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99,102,241,0.1); }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal.show { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #e2e8f0; }
        .modal-header h3 { font-size: 18px; color: #1e293b; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b; }
        .modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; padding-top: 15px; border-top: 1px solid #e2e8f0; }
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; }
        .tab-btn { padding: 10px 20px; border: none; background: none; cursor: pointer; font-size: 14px; color: #64748b; border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .tab-btn.active { color: #6366f1; border-bottom-color: #6366f1; }
        .goal-card { border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 10px; }
        .goal-card:hover { border-color: #6366f1; background: #f8fafc; }
        .goal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .goal-title { font-weight: 600; color: #1e293b; }
        .goal-amount { font-size: 20px; font-weight: 700; color: #6366f1; }
        .goal-progress { height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; }
        .goal-progress-bar { height: 100%; background: #6366f1; border-radius: 4px; transition: width 0.3s; }
        .tree-view { padding-left: 20px; }
        .tree-item { padding: 8px 0; }
        .tree-toggle { cursor: pointer; user-select: none; }
        .tree-toggle:before { content: '▶'; display: inline-block; width: 20px; font-size: 10px; transition: transform 0.2s; }
        .tree-toggle.open:before { transform: rotate(90deg); }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; }
        .stat-card.blue { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stat-card.green { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .stat-card.orange { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .stat-value { font-size: 28px; font-weight: 700; }
        .stat-label { font-size: 13px; opacity: 0.9; margin-top: 5px; }
        .search-box { display: flex; gap: 10px; margin-bottom: 20px; }
        .search-box input { flex: 1; }
        .copyright { text-align: center; padding: 20px; color: #888; font-size: 12px; }
    </style>
</head>
<body>
    <div class="admin-header">
        <h1>🛠️ 관리자 대시보드</h1>
        <div>
            <a href="/">← 메인으로</a>
            <a href="/api/auth/logout">로그아웃</a>
        </div>
    </div>

    <div class="admin-container">
        <div class="admin-sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">목표 관리</div>
                <div class="sidebar-item active" onclick="showPanel('goals')">🎯 목표 설정</div>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-title">사용자 관리</div>
                <div class="sidebar-item" onclick="showPanel('users')">👥 사용자 목록</div>
                <div class="sidebar-item" onclick="showPanel('activity')">📋 로그인 이력</div>
                <div class="sidebar-item" onclick="showPanel('usage')">📊 이용 기록</div>
                <div class="sidebar-item" onclick="showPanel('downloads')">📥 다운로드 기록</div>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-title">권한 관리</div>
                <div class="sidebar-item" onclick="showPanel('permissions')">🔐 사용자 권한</div>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-title">시스템</div>
                <div class="sidebar-item" onclick="showPanel('settings')">⚙️ 시스템 설정</div>
                <div class="sidebar-item" onclick="showPanel('aiLogs')">🤖 AI 분석 로그</div>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-title">원가 관리</div>
                <div class="sidebar-item" onclick="showPanel('costData')">💰 원가 데이터</div>
                <div class="sidebar-item" onclick="showPanel('costMapping')">🔗 항목 매핑</div>
                <div class="sidebar-item" onclick="showPanel('profitAnalysis')">📈 손익 분석</div>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-title">재무 설정</div>
                <div class="sidebar-item" onclick="showPanel('financialSettings')">📊 손익계산서 설정</div>
            </div>
        </div>

        <div class="admin-content">
            <!-- 목표 설정 패널 -->
            <div id="goalsPanel" class="admin-panel active">
                <div class="panel-header">
                    <h2>🎯 목표 설정</h2>
                    <button class="btn btn-primary" onclick="showGoalModal()">+ 목표 추가</button>
                </div>
                <div class="tabs">
                    <button class="tab-btn active" onclick="showGoalTab('overall')">전체 목표</button>
                    <button class="tab-btn" onclick="showGoalTab('team')">팀별 목표</button>
                    <button class="tab-btn" onclick="showGoalTab('individual')">개인별 목표</button>
                </div>
                <div class="form-row" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label>연도</label>
                        <select class="form-control" id="goalYear" onchange="loadGoals()">
                            <option value="2026">2026년</option>
                            <option value="2025">2025년</option>
                            <option value="2024">2024년</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>검사목적</label>
                        <select class="form-control" id="goalPurpose" onchange="loadGoals()">
                            <option value="전체">전체</option>
                            <option value="자가품질검사">자가품질검사</option>
                            <option value="위생교육검사">위생교육검사</option>
                            <option value="의뢰검사">의뢰검사</option>
                        </select>
                    </div>
                </div>
                <div id="goalsContent">
                    <div class="stat-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalGoalSales">0억</div>
                            <div class="stat-label">전체 매출 목표</div>
                        </div>
                        <div class="stat-card blue">
                            <div class="stat-value" id="totalGoalCount">0건</div>
                            <div class="stat-label">전체 건수 목표</div>
                        </div>
                        <div class="stat-card green">
                            <div class="stat-value" id="goalAchievement">0%</div>
                            <div class="stat-label">달성률</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-title">📊 목표 현황</div>
                        <table>
                            <thead>
                                <tr>
                                    <th>구분</th>
                                    <th>대상</th>
                                    <th>검사목적</th>
                                    <th>매출 목표</th>
                                    <th>건수 목표</th>
                                    <th>관리</th>
                                </tr>
                            </thead>
                            <tbody id="goalsTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 사용자 목록 패널 -->
            <div id="usersPanel" class="admin-panel">
                <div class="panel-header">
                    <h2>👥 사용자 관리</h2>
                    <button class="btn btn-primary" onclick="showAddUserModal()">+ 사용자 추가</button>
                </div>
                <div class="search-box">
                    <input type="text" class="form-control" placeholder="사용자 검색..." id="userSearch" onkeyup="filterUsers()">
                    <select class="form-control" style="width: 150px;" id="teamFilter" onchange="filterUsers()">
                        <option value="">전체 팀</option>
                    </select>
                </div>
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>사용자명</th>
                                <th>이름</th>
                                <th>이메일</th>
                                <th>소속팀</th>
                                <th>역할</th>
                                <th>상태</th>
                                <th>마지막 로그인</th>
                                <th>관리</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- 로그인 이력 패널 -->
            <div id="activityPanel" class="admin-panel">
                <div class="panel-header">
                    <h2>📋 로그인 이력</h2>
                </div>
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>시간</th>
                                <th>사용자</th>
                                <th>활동</th>
                                <th>상세</th>
                                <th>IP</th>
                            </tr>
                        </thead>
                        <tbody id="activityTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- 이용 기록 패널 -->
            <div id="usagePanel" class="admin-panel">
                <div class="panel-header">
                    <h2>📊 이용 기록</h2>
                </div>
                <div class="card">
                    <div class="card-title">탭 이용 기록</div>
                    <table>
                        <thead>
                            <tr>
                                <th>사용자</th>
                                <th>메뉴</th>
                                <th>진입시간</th>
                                <th>종료시간</th>
                            </tr>
                        </thead>
                        <tbody id="menuLogsTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- 다운로드 기록 패널 -->
            <div id="downloadsPanel" class="admin-panel">
                <div class="panel-header">
                    <h2>📥 다운로드 기록</h2>
                </div>
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>시간</th>
                                <th>사용자</th>
                                <th>파일 유형</th>
                                <th>파일명</th>
                            </tr>
                        </thead>
                        <tbody id="downloadLogsTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- 권한 관리 패널 -->
            <div id="permissionsPanel" class="admin-panel">
                <div class="panel-header">
                    <h2>🔐 사용자 권한</h2>
                </div>

                <!-- 사용자별 탭 접근 권한 -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-title">📱 사용자별 탭 접근 권한</div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label>사용자 선택</label>
                        <select class="form-control" id="permUserSelect" onchange="loadUserTabPermissions()" style="max-width: 300px;">
                            <option value="">-- 사용자 선택 --</option>
                        </select>
                    </div>
                    <div id="tabPermissionsContainer" style="display: none;">
                        <table>
                            <thead>
                                <tr>
                                    <th>탭 이름</th>
                                    <th style="width: 100px; text-align: center;">접근 허용</th>
                                </tr>
                            </thead>
                            <tbody id="tabPermissionsTable"></tbody>
                        </table>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-primary" onclick="saveUserTabPermissions()">💾 권한 저장</button>
                            <label style="margin-left: 20px;">
                                <input type="checkbox" id="permAdminAccess" onchange="toggleAdminAccess()"> 관리자 대시보드 접근
                            </label>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="card">
                        <div class="card-title">권한 그룹</div>
                        <div id="permissionGroups"></div>
                        <button class="btn btn-primary btn-sm" style="margin-top: 10px;" onclick="showPermissionGroupModal()">+ 권한 그룹 추가</button>
                    </div>
                    <div class="card">
                        <div class="card-title">권한 설정</div>
                        <div class="form-group">
                            <label>메뉴 접근 권한</label>
                            <div id="menuPermissions"></div>
                        </div>
                        <div class="form-group">
                            <label>데이터 범위</label>
                            <select class="form-control" id="dataScope">
                                <option value="all">전체 데이터</option>
                                <option value="team">팀 데이터만</option>
                                <option value="personal">개인 데이터만</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>기능 권한</label>
                            <div>
                                <label><input type="checkbox" id="canEdit"> 수정</label>
                                <label><input type="checkbox" id="canDelete"> 삭제</label>
                                <label><input type="checkbox" id="canExport"> 내보내기</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 시스템 설정 패널 -->
            <div id="settingsPanel" class="admin-panel">
                <div class="panel-header">
                    <h2>⚙️ 시스템 설정</h2>
                </div>
                <div class="form-row">
                    <div class="card">
                        <div class="card-title">기본 정보</div>
                        <div class="form-group">
                            <label>회사명</label>
                            <input type="text" class="form-control" id="companyName" value="식품의약품안전진흥원">
                        </div>
                        <div class="form-group">
                            <label>연락처</label>
                            <input type="text" class="form-control" id="companyPhone">
                        </div>
                        <button class="btn btn-primary" onclick="saveSettings()">저장</button>
                    </div>
                    <div class="card">
                        <div class="card-title">테마 설정</div>
                        <div class="form-group">
                            <label>테마 모드</label>
                            <select class="form-control" id="themeMode">
                                <option value="light">라이트 모드</option>
                                <option value="dark">다크 모드</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">팀 관리</div>
                    <table>
                        <thead>
                            <tr>
                                <th>팀명</th>
                                <th>카테고리</th>
                                <th>상세 이력 추적</th>
                                <th>관리</th>
                            </tr>
                        </thead>
                        <tbody id="teamsTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- AI 분석 로그 패널 -->
            <div id="aiLogsPanel" class="admin-panel">
                <div class="panel-header">
                    <h2>🤖 AI 분석 로그</h2>
                </div>
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>시간</th>
                                <th>사용자</th>
                                <th>프롬프트</th>
                                <th>응답 길이</th>
                                <th>토큰</th>
                            </tr>
                        </thead>
                        <tbody id="aiLogsTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- 원가 데이터 패널 -->
            <div id="costDataPanel" class="admin-panel">
                <div class="panel-header">
                    <h2>💰 원가 데이터</h2>
                    <button class="btn btn-primary" onclick="reloadCostData()">📥 엑셀에서 로드</button>
                </div>
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="costDataCount">0</div>
                        <div class="stat-label">총 원가 항목</div>
                    </div>
                    <div class="stat-card blue">
                        <div class="stat-value" id="costDataPhysical">0</div>
                        <div class="stat-label">이화학 검사</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-value" id="costDataMicro">0</div>
                        <div class="stat-label">미생물 검사</div>
                    </div>
                </div>
                <div class="search-box">
                    <input type="text" class="form-control" placeholder="원가 항목 검색..." id="costSearch" onkeyup="filterCostData()">
                    <select class="form-control" style="width: 150px;" id="costCategoryFilter" onchange="filterCostData()">
                        <option value="">전체 카테고리</option>
                        <option value="이화학">이화학</option>
                        <option value="미생물">미생물</option>
                    </select>
                </div>
                <div class="card">
                    <div class="card-title">원가 데이터 목록</div>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>항목명</th>
                                    <th>카테고리</th>
                                    <th>재료비</th>
                                    <th>노무비</th>
                                    <th>경비</th>
                                    <th>직접비 계</th>
                                    <th>간접비 계</th>
                                    <th>총원가</th>
                                </tr>
                            </thead>
                            <tbody id="costDataTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 항목 매핑 패널 -->
            <div id="costMappingPanel" class="admin-panel">
                <div class="panel-header">
                    <h2>🔗 원가-매출 항목 매핑</h2>
                    <button class="btn btn-primary" onclick="showMappingModal()">+ 매핑 추가</button>
                </div>
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="mappingCount">0</div>
                        <div class="stat-label">매핑된 항목</div>
                    </div>
                    <div class="stat-card blue">
                        <div class="stat-value" id="unmappedCount">0</div>
                        <div class="stat-label">미매핑 항목</div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="card" style="flex: 1;">
                        <div class="card-title">현재 매핑 목록</div>
                        <table>
                            <thead>
                                <tr>
                                    <th>원가 항목</th>
                                    <th>매출 항목</th>
                                    <th>관리</th>
                                </tr>
                            </thead>
                            <tbody id="costMappingTable"></tbody>
                        </table>
                    </div>
                    <div class="card" style="flex: 1;">
                        <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>미매핑 매출 항목 (상위 50개)</span>
                            <button class="btn btn-sm btn-primary" onclick="showBatchMappingModal()">선택 항목 일괄 매핑</button>
                        </div>
                        <div style="max-height: 400px; overflow-y: auto;">
                            <table>
                                <thead>
                                    <tr>
                                        <th style="width: 30px;"><input type="checkbox" id="selectAllUnmapped" onchange="toggleAllUnmapped()"></th>
                                        <th>매출 항목명</th>
                                        <th>건수</th>
                                        <th>매핑</th>
                                    </tr>
                                </thead>
                                <tbody id="unmappedItemsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 손익 분석 패널 -->
            <div id="profitAnalysisPanel" class="admin-panel">
                <div class="panel-header">
                    <h2>📈 손익 분석</h2>
                    <select class="form-control" style="width: 120px;" id="profitYear" onchange="loadProfitAnalysis()">
                        <option value="2026">2026년</option>
                        <option value="2025" selected>2025년</option>
                        <option value="2024">2024년</option>
                    </select>
                </div>
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalRevenue">0원</div>
                        <div class="stat-label">총 매출</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-value" id="totalCostSum">0원</div>
                        <div class="stat-label">총 원가</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-value" id="totalProfit">0원</div>
                        <div class="stat-label">총 이익</div>
                    </div>
                    <div class="stat-card blue">
                        <div class="stat-value" id="profitRate">0%</div>
                        <div class="stat-label">이익률</div>
                    </div>
                </div>
                <div class="stat-grid" style="margin-bottom: 20px;">
                    <div class="stat-card">
                        <div class="stat-value" id="totalItems">0</div>
                        <div class="stat-label">총 항목수</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-value" id="matchedItems">0</div>
                        <div class="stat-label">매칭된 항목</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-value" id="matchRate">0%</div>
                        <div class="stat-label">매칭률</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">항목별 손익 분석 (상위 100개)</div>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>항목명</th>
                                    <th>건수</th>
                                    <th>매출액</th>
                                    <th>단가원가</th>
                                    <th>총원가</th>
                                    <th>이익</th>
                                    <th>이익률</th>
                                    <th>매칭</th>
                                </tr>
                            </thead>
                            <tbody id="profitAnalysisTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 손익계산서 설정 패널 -->
            <div id="financialSettingsPanel" class="admin-panel">
                <div class="panel-header">
                    <h2>📊 손익계산서 설정</h2>
                    <button class="btn btn-primary" onclick="saveFinancialSettings()">💾 저장</button>
                </div>
                <div class="form-row" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label>연도</label>
                        <select class="form-control" id="financialYear" onchange="loadFinancialSettings()">
                            <option value="2026">2026년</option>
                            <option value="2025" selected>2025년</option>
                            <option value="2024">2024년</option>
                        </select>
                    </div>
                </div>

                <!-- 손익계산서 구조 -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-title">📋 손익계산서 입력</div>
                    <table style="width: 100%;">
                        <tbody>
                            <tr style="background: #f1f5f9;">
                                <td style="padding: 12px; font-weight: bold;">매출액</td>
                                <td style="padding: 12px; text-align: right;">
                                    <input type="text" class="form-control fs-money-input" id="fsRevenue" style="width: 200px; text-align: right;" placeholder="0">
                                </td>
                                <td style="padding: 12px; color: #64748b;">원</td>
                                <td style="padding: 12px; color: #64748b; width: 100px;">100%</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px;">(-) 매출원가</td>
                                <td style="padding: 12px; text-align: right;">
                                    <input type="text" class="form-control fs-money-input" id="fsCostOfSales" style="width: 200px; text-align: right;" placeholder="0">
                                </td>
                                <td style="padding: 12px; color: #64748b;">원</td>
                                <td style="padding: 12px;">
                                    <span id="fsCostRate" style="color: #ef4444;">0%</span>
                                </td>
                            </tr>
                            <tr style="background: #ecfdf5;">
                                <td style="padding: 12px; font-weight: bold; color: #10b981;">= 매출총이익</td>
                                <td style="padding: 12px; text-align: right; font-weight: bold; color: #10b981;">
                                    <span id="fsGrossProfit">0</span>
                                </td>
                                <td style="padding: 12px; color: #10b981;">원</td>
                                <td style="padding: 12px;">
                                    <span id="fsGrossProfitRate" style="color: #10b981;">0%</span>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 12px;">(-) 판매비와관리비</td>
                                <td style="padding: 12px; text-align: right;">
                                    <input type="text" class="form-control fs-money-input" id="fsSgaExpense" style="width: 200px; text-align: right;" placeholder="0">
                                </td>
                                <td style="padding: 12px; color: #64748b;">원</td>
                                <td style="padding: 12px;">
                                    <span id="fsSgaRate" style="color: #f59e0b;">0%</span>
                                </td>
                            </tr>
                            <tr style="background: #fef3c7;">
                                <td style="padding: 12px; font-weight: bold; color: #f59e0b;">= 영업이익</td>
                                <td style="padding: 12px; text-align: right; font-weight: bold; color: #f59e0b;">
                                    <span id="fsOperatingProfit">0</span>
                                </td>
                                <td style="padding: 12px; color: #f59e0b;">원</td>
                                <td style="padding: 12px;">
                                    <span id="fsOperatingProfitRate" style="color: #f59e0b;">0%</span>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 12px;">(+/-) 영업외손익</td>
                                <td style="padding: 12px; text-align: right;">
                                    <input type="text" class="form-control fs-money-input" id="fsNonOperating" style="width: 200px; text-align: right;" placeholder="0">
                                </td>
                                <td style="padding: 12px; color: #64748b;">원</td>
                                <td style="padding: 12px; color: #64748b;">-</td>
                            </tr>
                            <tr style="background: #dbeafe;">
                                <td style="padding: 12px; font-weight: bold; color: #3b82f6;">= 세전이익</td>
                                <td style="padding: 12px; text-align: right; font-weight: bold; color: #3b82f6;">
                                    <span id="fsPreTaxProfit">0</span>
                                </td>
                                <td style="padding: 12px; color: #3b82f6;">원</td>
                                <td style="padding: 12px;">
                                    <span id="fsPreTaxProfitRate" style="color: #3b82f6;">0%</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 세부 비용 항목 -->
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>📝 세부 비용 항목</span>
                        <button class="btn btn-sm btn-primary" onclick="addFinancialDetail()">+ 항목 추가</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>구분</th>
                                <th>항목명</th>
                                <th style="text-align: right;">금액</th>
                                <th style="width: 80px;">관리</th>
                            </tr>
                        </thead>
                        <tbody id="financialDetailsTable"></tbody>
                    </table>
                </div>

                <!-- 메모 -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-title">📝 메모</div>
                    <textarea class="form-control" id="fsNotes" rows="3" placeholder="손익계산서 관련 메모..."></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- 팀원 관리 모달 -->
    <div class="modal" id="teamMemberModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 id="teamMemberModalTitle">팀원 관리</h3>
                <button class="modal-close" onclick="closeModal('teamMemberModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span id="teamMemberCount" style="color: #64748b;">총 0명</span>
                    <button class="btn btn-primary" onclick="showAddMemberForm()">+ 인원 추가</button>
                </div>

                <!-- 인원 추가/수정 폼 -->
                <div id="memberFormContainer" style="display: none; background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <input type="hidden" id="editMemberId">
                    <div class="form-row" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <div class="form-group">
                            <label>이름 *</label>
                            <input type="text" class="form-control" id="memberName" required>
                        </div>
                        <div class="form-group">
                            <label>직책</label>
                            <input type="text" class="form-control" id="memberPosition" placeholder="예: 팀장, 과장">
                        </div>
                        <!-- 본사 부서용 필드 -->
                        <div class="form-group headquarters-field">
                            <label>담당 업무</label>
                            <input type="text" class="form-control" id="memberDuties" placeholder="예: 회계, 인사관리">
                        </div>
                        <!-- 영업/지사용 필드 -->
                        <div class="form-group sales-field" style="display: none;">
                            <label>담당 지역</label>
                            <input type="text" class="form-control" id="memberRegion" placeholder="예: 서울 강남구">
                        </div>
                        <div class="form-group sales-field" style="display: none;">
                            <label>입사년도</label>
                            <input type="number" class="form-control" id="memberHireYear" placeholder="2020">
                        </div>
                        <div class="form-group sales-field" style="display: none;">
                            <label>연락처</label>
                            <input type="text" class="form-control" id="memberPhone" placeholder="010-0000-0000">
                        </div>
                        <div class="form-group">
                            <label>이메일</label>
                            <input type="email" class="form-control" id="memberEmail">
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>비고</label>
                            <input type="text" class="form-control" id="memberNotes">
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="btn btn-primary" onclick="saveMember()">저장</button>
                        <button class="btn" onclick="hideMemberForm()">취소</button>
                    </div>
                </div>

                <!-- 팀원 목록 테이블 -->
                <table>
                    <thead>
                        <tr id="memberTableHeader">
                            <th>이름</th>
                            <th>직책</th>
                            <th class="headquarters-col">담당 업무</th>
                            <th class="sales-col" style="display: none;">담당 지역</th>
                            <th class="sales-col" style="display: none;">입사년도</th>
                            <th class="sales-col" style="display: none;">연락처</th>
                            <th>이메일</th>
                            <th>관리</th>
                        </tr>
                    </thead>
                    <tbody id="teamMembersTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 목표 추가 모달 -->
    <div class="modal" id="goalModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>목표 설정</h3>
                <button class="modal-close" onclick="closeModal('goalModal')">&times;</button>
            </div>
            <form onsubmit="return saveGoal(event)">
                <div class="form-group">
                    <label>목표 유형</label>
                    <select class="form-control" id="goalType" onchange="updateGoalTarget()">
                        <option value="overall">전체 목표</option>
                        <option value="team">팀 목표</option>
                        <option value="individual">개인 목표</option>
                    </select>
                </div>
                <div class="form-group" id="goalTargetGroup" style="display: none;">
                    <label>대상 선택</label>
                    <select class="form-control" id="goalTarget"></select>
                </div>
                <div class="form-group">
                    <label>검사목적</label>
                    <select class="form-control" id="goalInspectionPurpose">
                        <option value="전체">전체</option>
                        <option value="자가품질검사">자가품질검사</option>
                        <option value="위생교육검사">위생교육검사</option>
                        <option value="의뢰검사">의뢰검사</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>매출 목표 (원)</label>
                        <input type="number" class="form-control" id="goalSales" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>건수 목표</label>
                        <input type="number" class="form-control" id="goalCount" placeholder="0">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>연도</label>
                        <select class="form-control" id="goalSetYear">
                            <option value="2026">2026년</option>
                            <option value="2025">2025년</option>
                            <option value="2024">2024년</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>월 (선택)</label>
                        <select class="form-control" id="goalMonth">
                            <option value="">연간 목표</option>
                            <option value="1">1월</option>
                            <option value="2">2월</option>
                            <option value="3">3월</option>
                            <option value="4">4월</option>
                            <option value="5">5월</option>
                            <option value="6">6월</option>
                            <option value="7">7월</option>
                            <option value="8">8월</option>
                            <option value="9">9월</option>
                            <option value="10">10월</option>
                            <option value="11">11월</option>
                            <option value="12">12월</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeModal('goalModal')">취소</button>
                    <button type="submit" class="btn btn-primary">저장</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 원가-매출 매핑 모달 -->
    <div class="modal" id="mappingModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>원가-매출 항목 매핑</h3>
                <button class="modal-close" onclick="closeModal('mappingModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>매출 항목명</label>
                <input type="text" class="form-control" id="mappingSalesItem" placeholder="매출 항목명 입력" readonly style="background: #f1f5f9;">
            </div>
            <div class="form-group">
                <label>원가 항목 선택</label>
                <input type="text" class="form-control" id="mappingCostSearch" placeholder="원가 항목 검색..." oninput="searchCostItems()">
            </div>
            <div id="costSuggestions" style="max-height: 250px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 15px;">
                <div style="padding: 20px; text-align: center; color: #64748b;">추천 항목을 불러오는 중...</div>
            </div>
            <div class="form-group">
                <label>선택된 원가 항목</label>
                <input type="text" class="form-control" id="mappingCostItem" readonly style="background: #ecfdf5; border-color: #10b981;">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="closeModal('mappingModal')">취소</button>
                <button type="button" class="btn btn-primary" onclick="saveMapping()">저장</button>
            </div>
        </div>
    </div>

    <!-- 일괄 매핑 모달 -->
    <div class="modal" id="batchMappingModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>일괄 매핑 (그룹)</h3>
                <button class="modal-close" onclick="closeModal('batchMappingModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>선택된 매출 항목 (<span id="selectedCount">0</span>개)</label>
                <div id="selectedItemsList" style="max-height: 150px; overflow-y: auto; background: #f1f5f9; padding: 10px; border-radius: 8px; font-size: 13px;"></div>
            </div>
            <div class="form-group">
                <label>그룹명 (같은 그룹은 원가를 1번만 계산)</label>
                <input type="text" class="form-control" id="batchGroupName" placeholder="예: 영양성분검사">
            </div>
            <div class="form-group">
                <label>원가 항목 검색</label>
                <input type="text" class="form-control" id="batchCostSearch" placeholder="원가 항목 검색..." oninput="searchBatchCostItems()">
            </div>
            <div id="batchCostSuggestions" style="max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 15px;"></div>
            <div class="form-group">
                <label>선택된 원가 항목</label>
                <input type="text" class="form-control" id="batchCostItem" readonly style="background: #ecfdf5; border-color: #10b981;">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="closeModal('batchMappingModal')">취소</button>
                <button type="button" class="btn btn-primary" onclick="saveBatchMapping()">일괄 매핑 저장</button>
            </div>
        </div>
    </div>

    <!-- 사용자 추가/수정 모달 -->
    <div class="modal" id="userModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="userModalTitle">사용자 추가</h3>
                <button class="modal-close" onclick="closeModal('userModal')">&times;</button>
            </div>
            <form onsubmit="return saveUser(event)">
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label>사용자 ID</label>
                    <input type="text" class="form-control" id="newUsername" required>
                </div>
                <div class="form-group">
                    <label>이름</label>
                    <input type="text" class="form-control" id="newName" required>
                </div>
                <div class="form-group">
                    <label>이메일</label>
                    <input type="email" class="form-control" id="newEmail">
                </div>
                <div class="form-group">
                    <label>비밀번호</label>
                    <input type="password" class="form-control" id="newPassword" autocomplete="new-password">
                    <small style="color: #64748b;">수정 시 비워두면 변경하지 않습니다</small>
                </div>
                <div class="form-group">
                    <label>소속팀</label>
                    <select class="form-control" id="newTeam"></select>
                </div>
                <div class="form-group">
                    <label>역할</label>
                    <select class="form-control" id="newRole">
                        <option value="user">일반 사용자</option>
                        <option value="manager">매니저</option>
                        <option value="admin">관리자</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeModal('userModal')">취소</button>
                    <button type="submit" class="btn btn-primary">저장</button>
                </div>
            </form>
        </div>
    </div>

    <p class="copyright">© 2026 HS.KIM. All rights reserved.</p>

    <script>
        let teamsData = [];
        let usersData = [];
        let goalsData = [];
        let currentGoalTab = 'overall';

        // 패널 전환
        function showPanel(panel) {
            document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
            document.getElementById(panel + 'Panel').classList.add('active');
            event.target.classList.add('active');

            if (panel === 'goals') loadGoals();
            else if (panel === 'users') loadUsers();
            else if (panel === 'activity') loadActivity();
            else if (panel === 'usage') loadMenuLogs();
            else if (panel === 'downloads') loadDownloadLogs();
            else if (panel === 'permissions') loadPermissions();
            else if (panel === 'settings') loadSettings();
            else if (panel === 'aiLogs') loadAiLogs();
            else if (panel === 'costData') loadCostData();
            else if (panel === 'costMapping') loadCostMapping();
            else if (panel === 'profitAnalysis') loadProfitAnalysis();
            else if (panel === 'financialSettings') loadFinancialSettings();
        }

        // 목표 탭 전환
        function showGoalTab(tab) {
            currentGoalTab = tab;
            document.querySelectorAll('.tabs .tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            loadGoals();
        }

        // 목표 로드
        async function loadGoals() {
            const year = document.getElementById('goalYear').value;
            const purpose = document.getElementById('goalPurpose').value;
            try {
                const response = await fetch(`/api/admin/goals?year=${year}&purpose=${purpose}&type=${currentGoalTab}`);
                const data = await response.json();
                goalsData = data.goals || [];
                renderGoals();
            } catch (e) {
                console.error('목표 로드 실패:', e);
            }
        }

        function renderGoals() {
            const tbody = document.getElementById('goalsTable');
            if (!goalsData.length) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #64748b;">등록된 목표가 없습니다.</td></tr>';
                return;
            }
            tbody.innerHTML = goalsData.map(g => `
                <tr>
                    <td><span class="badge badge-${g.goal_type === 'overall' ? 'info' : g.goal_type === 'team' ? 'success' : 'warning'}">${g.goal_type === 'overall' ? '전체' : g.goal_type === 'team' ? '팀' : '개인'}</span></td>
                    <td>${g.target_name || '-'}</td>
                    <td>${g.inspection_purpose || '전체'}</td>
                    <td>${(g.target_sales / 100000000).toFixed(1)}억</td>
                    <td>${g.target_count?.toLocaleString() || 0}건</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editGoal(${g.id})">수정</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteGoal(${g.id})">삭제</button>
                    </td>
                </tr>
            `).join('');
        }

        // 사용자 로드
        async function loadUsers() {
            try {
                const [usersRes, teamsRes] = await Promise.all([
                    fetch('/api/admin/users'),
                    fetch('/api/admin/teams')
                ]);
                const usersJson = await usersRes.json();
                const teamsJson = await teamsRes.json();
                usersData = usersJson.users || [];
                teamsData = teamsJson.teams || [];
                renderUsers();
                renderTeamFilters();
            } catch (e) {
                console.error('사용자 로드 실패:', e);
            }
        }

        function renderUsers() {
            const tbody = document.getElementById('usersTable');
            tbody.innerHTML = usersData.map(u => `
                <tr>
                    <td>${u.id}</td>
                    <td>${u.username}</td>
                    <td>${u.name || '-'}</td>
                    <td>${u.email || '-'}</td>
                    <td>${u.team_name || '-'}</td>
                    <td><span class="badge badge-${u.role === 'admin' ? 'danger' : u.role === 'manager' ? 'warning' : 'info'}">${u.role === 'admin' ? '관리자' : u.role === 'manager' ? '매니저' : '사용자'}</span></td>
                    <td><span class="badge badge-${u.status === 'active' ? 'success' : 'danger'}">${u.status === 'active' ? '활성' : '정지'}</span></td>
                    <td>${u.last_login || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editUser(${u.id})">수정</button>
                        <button class="btn btn-sm btn-warning" onclick="resetPassword(${u.id})">PW초기화</button>
                        ${u.status === 'active'
                            ? `<button class="btn btn-sm btn-danger" onclick="toggleUserStatus(${u.id}, 'suspended')">정지</button>`
                            : `<button class="btn btn-sm btn-success" onclick="toggleUserStatus(${u.id}, 'active')">활성화</button>`
                        }
                    </td>
                </tr>
            `).join('');
        }

        function renderTeamFilters() {
            const select = document.getElementById('teamFilter');
            const newTeamSelect = document.getElementById('newTeam');
            const options = '<option value="">전체 팀</option>' + teamsData.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            select.innerHTML = options;
            if (newTeamSelect) {
                newTeamSelect.innerHTML = '<option value="">선택 안함</option>' + teamsData.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            }
        }

        // 활동 로그
        async function loadActivity() {
            const response = await fetch('/api/admin/activity');
            const data = await response.json();
            document.getElementById('activityTable').innerHTML = (data.activities || []).map(a => `
                <tr>
                    <td>${a.created_at}</td>
                    <td>${a.username || 'Unknown'}</td>
                    <td>${a.action || '-'}</td>
                    <td>${a.details || '-'}</td>
                    <td>${a.ip_address || '-'}</td>
                </tr>
            `).join('');
        }

        // 메뉴 로그
        async function loadMenuLogs() {
            const response = await fetch('/api/admin/menu-logs');
            const data = await response.json();
            document.getElementById('menuLogsTable').innerHTML = (data.logs || []).map(l => `
                <tr>
                    <td>${l.display_name || l.username || '알 수 없음'}</td>
                    <td>${l.menu_name_kr || l.menu_name}</td>
                    <td>${l.entry_time || l.created_at}</td>
                    <td>${l.exit_time || '-'}</td>
                </tr>
            `).join('');
        }

        // 다운로드 로그
        async function loadDownloadLogs() {
            const response = await fetch('/api/admin/download-logs');
            const data = await response.json();
            document.getElementById('downloadLogsTable').innerHTML = (data.logs || []).map(l => `
                <tr>
                    <td>${l.created_at}</td>
                    <td>${l.username || 'Unknown'}</td>
                    <td>${l.file_type}</td>
                    <td>${l.file_name}</td>
                </tr>
            `).join('');
        }

        // AI 로그
        async function loadAiLogs() {
            const response = await fetch('/api/admin/ai-logs');
            const data = await response.json();
            document.getElementById('aiLogsTable').innerHTML = (data.logs || []).map(l => `
                <tr>
                    <td>${l.created_at}</td>
                    <td>${l.username || 'Unknown'}</td>
                    <td>${(l.prompt || '').substring(0, 100)}${l.prompt?.length > 100 ? '...' : ''}</td>
                    <td>${l.response_length || 0}</td>
                    <td>${l.tokens_used || 0}</td>
                </tr>
            `).join('');
        }

        // ============ 원가 관리 함수들 ============
        let costDataCache = [];
        let costMappingCache = [];
        let unmappedItemsCache = [];

        // 원가 데이터 로드
        async function loadCostData() {
            try {
                const response = await fetch('/api/admin/cost-data');
                const data = await response.json();
                costDataCache = data.data || [];

                // 통계 업데이트
                document.getElementById('costDataCount').textContent = costDataCache.length;
                const physical = costDataCache.filter(c => c.category === '이화학').length;
                const micro = costDataCache.filter(c => c.category === '미생물').length;
                document.getElementById('costDataPhysical').textContent = physical;
                document.getElementById('costDataMicro').textContent = micro;

                renderCostDataTable();
            } catch (e) {
                console.error('원가 데이터 로드 실패:', e);
            }
        }

        function renderCostDataTable() {
            const search = document.getElementById('costSearch')?.value?.toLowerCase() || '';
            const category = document.getElementById('costCategoryFilter')?.value || '';

            let filtered = costDataCache;
            if (search) {
                filtered = filtered.filter(c => c.item_name?.toLowerCase().includes(search));
            }
            if (category) {
                filtered = filtered.filter(c => c.category === category);
            }

            document.getElementById('costDataTable').innerHTML = filtered.slice(0, 200).map(c => `
                <tr>
                    <td>${c.item_name || '-'}</td>
                    <td>${c.category || '-'}</td>
                    <td style="text-align: right;">${formatNumber(c.material_cost)}</td>
                    <td style="text-align: right;">${formatNumber(c.labor_cost)}</td>
                    <td style="text-align: right;">${formatNumber(c.expense)}</td>
                    <td style="text-align: right;">${formatNumber(c.direct_cost)}</td>
                    <td style="text-align: right;">${formatNumber(c.indirect_cost)}</td>
                    <td style="text-align: right; font-weight: bold;">${formatNumber(c.total_cost)}</td>
                </tr>
            `).join('') || '<tr><td colspan="8" style="text-align:center;">원가 데이터가 없습니다</td></tr>';
        }

        function filterCostData() {
            renderCostDataTable();
        }

        async function reloadCostData() {
            if (!confirm('엑셀 파일에서 원가 데이터를 다시 로드하시겠습니까?\\n기존 데이터가 덮어씌워집니다.')) return;
            try {
                const response = await fetch('/api/admin/cost-data/reload', { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    alert('원가 데이터 로드 완료: ' + result.count + '개 항목');
                    loadCostData();
                } else {
                    alert('로드 실패: ' + (result.error || '알 수 없는 오류'));
                }
            } catch (e) {
                alert('로드 실패: ' + e.message);
            }
        }

        // 항목 매핑 로드
        async function loadCostMapping() {
            try {
                // 원가 데이터도 함께 로드 (추천 기능에 필요)
                if (!costDataCache.length) {
                    const costRes = await fetch('/api/admin/cost-data');
                    const costData = await costRes.json();
                    costDataCache = costData.data || [];
                }

                const [mappingRes, profitRes] = await Promise.all([
                    fetch('/api/admin/cost-mapping'),
                    fetch('/api/cost/profit-analysis?year=2025')
                ]);
                const mappingData = await mappingRes.json();
                const profitData = await profitRes.json();

                costMappingCache = mappingData.mappings || [];
                document.getElementById('mappingCount').textContent = costMappingCache.length;

                // 매핑 테이블 렌더링 (그룹명 표시)
                document.getElementById('costMappingTable').innerHTML = costMappingCache.map(m => `
                    <tr>
                        <td>${m.cost_item_name}${m.group_name ? '<br><small style="color:#64748b;">그룹: ' + m.group_name + '</small>' : ''}</td>
                        <td>${m.sales_item_name}</td>
                        <td><button class="btn btn-sm" style="background:#ef4444; color:#fff;" onclick="deleteMapping(${m.id})">삭제</button></td>
                    </tr>
                `).join('') || '<tr><td colspan="3" style="text-align:center;">매핑된 항목이 없습니다</td></tr>';

                // 미매핑 항목 표시 (체크박스 포함)
                const unmapped = (profitData.data || []).filter(p => !p.matched);
                unmappedItemsCache = unmapped;
                document.getElementById('unmappedCount').textContent = unmapped.length;
                document.getElementById('unmappedItemsTable').innerHTML = unmapped.slice(0, 50).map((p, idx) => `
                    <tr>
                        <td><input type="checkbox" class="unmapped-checkbox" data-item="${p.item_name.replace(/"/g, '&quot;')}"></td>
                        <td>${p.item_name}</td>
                        <td>${p.count}</td>
                        <td><button class="btn btn-sm btn-primary" onclick="quickMapping('${p.item_name.replace(/'/g, "\\\\'")}')">매핑</button></td>
                    </tr>
                `).join('') || '<tr><td colspan="4" style="text-align:center;">모든 항목이 매핑되었습니다</td></tr>';
                document.getElementById('selectAllUnmapped').checked = false;
            } catch (e) {
                console.error('매핑 데이터 로드 실패:', e);
            }
        }

        async function deleteMapping(id) {
            if (!confirm('이 매핑을 삭제하시겠습니까?')) return;
            try {
                await fetch('/api/admin/cost-mapping/' + id, { method: 'DELETE' });
                loadCostMapping();
            } catch (e) {
                alert('삭제 실패: ' + e.message);
            }
        }

        function quickMapping(salesItem) {
            document.getElementById('mappingSalesItem').value = salesItem;
            document.getElementById('mappingCostItem').value = '';
            document.getElementById('mappingCostSearch').value = '';
            document.getElementById('mappingModal').classList.add('show');
            // 유사 항목 자동 검색
            showCostSuggestions(salesItem);
        }

        function showMappingModal() {
            document.getElementById('mappingSalesItem').value = '';
            document.getElementById('mappingCostItem').value = '';
            document.getElementById('mappingCostSearch').value = '';
            document.getElementById('costSuggestions').innerHTML = '<div style="padding: 20px; text-align: center; color: #64748b;">매출 항목을 선택하세요</div>';
            document.getElementById('mappingModal').classList.add('show');
        }

        function showCostSuggestions(salesItem) {
            if (!costDataCache.length) {
                document.getElementById('costSuggestions').innerHTML = '<div style="padding: 20px; text-align: center; color: #ef4444;">원가 데이터가 없습니다. 먼저 원가 데이터를 로드하세요.</div>';
                return;
            }

            // 유사도 기반 정렬
            const scored = costDataCache.map(c => {
                let score = 0;
                const costName = (c.item_name || '').toLowerCase();
                const salesName = salesItem.toLowerCase();

                // 정확히 일치
                if (costName === salesName) score = 100;
                // 포함 관계
                else if (costName.includes(salesName) || salesName.includes(costName)) score = 80;
                // 부분 일치 (첫 글자들)
                else if (costName.substring(0, 3) === salesName.substring(0, 3)) score = 60;
                // 공통 문자 수
                else {
                    const common = [...salesName].filter(ch => costName.includes(ch)).length;
                    score = Math.min(50, common * 10);
                }
                return { ...c, score };
            }).filter(c => c.score > 0).sort((a, b) => b.score - a.score).slice(0, 20);

            renderCostSuggestions(scored, salesItem);
        }

        function searchCostItems() {
            const search = document.getElementById('mappingCostSearch').value.toLowerCase().trim();
            if (!search) {
                const salesItem = document.getElementById('mappingSalesItem').value;
                if (salesItem) showCostSuggestions(salesItem);
                return;
            }

            const filtered = costDataCache.filter(c =>
                (c.item_name || '').toLowerCase().includes(search)
            ).slice(0, 20);

            renderCostSuggestions(filtered.map(c => ({ ...c, score: 50 })), '');
        }

        function renderCostSuggestions(items, salesItem) {
            if (!items.length) {
                document.getElementById('costSuggestions').innerHTML = '<div style="padding: 20px; text-align: center; color: #64748b;">일치하는 원가 항목이 없습니다</div>';
                return;
            }

            document.getElementById('costSuggestions').innerHTML = items.map(c => `
                <div onclick="selectCostItem('${c.item_name.replace(/'/g, "\\\\'")}')"
                     style="padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;"
                     onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='white'">
                    <div>
                        <div style="font-weight: 500;">${c.item_name}</div>
                        <div style="font-size: 12px; color: #64748b;">${c.category || ''} | 총원가: ${formatNumber(c.total_cost)}원</div>
                    </div>
                    ${c.score >= 80 ? '<span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">추천</span>' :
                      c.score >= 50 ? '<span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">유사</span>' : ''}
                </div>
            `).join('');
        }

        function selectCostItem(itemName) {
            document.getElementById('mappingCostItem').value = itemName;
            // 선택된 항목 하이라이트
            document.querySelectorAll('#costSuggestions > div').forEach(div => {
                div.style.background = div.textContent.includes(itemName) ? '#ecfdf5' : 'white';
            });
        }

        async function saveMapping() {
            const costItem = document.getElementById('mappingCostItem').value.trim();
            const salesItem = document.getElementById('mappingSalesItem').value.trim();
            if (!costItem || !salesItem) {
                alert('원가 항목과 매출 항목을 모두 입력하세요');
                return;
            }
            try {
                const response = await fetch('/api/admin/cost-mapping', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cost_item_name: costItem, sales_item_name: salesItem })
                });
                const result = await response.json();
                if (result.success) {
                    closeModal('mappingModal');
                    loadCostMapping();
                    loadProfitAnalysis();
                } else {
                    alert('저장 실패: ' + (result.error || '알 수 없는 오류'));
                }
            } catch (e) {
                alert('저장 실패: ' + e.message);
            }
        }

        // 전체 선택/해제
        function toggleAllUnmapped() {
            const checked = document.getElementById('selectAllUnmapped').checked;
            document.querySelectorAll('.unmapped-checkbox').forEach(cb => cb.checked = checked);
        }

        // 선택된 항목 가져오기
        function getSelectedUnmappedItems() {
            const selected = [];
            document.querySelectorAll('.unmapped-checkbox:checked').forEach(cb => {
                selected.push(cb.dataset.item);
            });
            return selected;
        }

        // 일괄 매핑 모달 표시
        function showBatchMappingModal() {
            const selected = getSelectedUnmappedItems();
            if (selected.length === 0) {
                alert('매핑할 항목을 선택하세요');
                return;
            }

            document.getElementById('selectedCount').textContent = selected.length;
            document.getElementById('selectedItemsList').innerHTML = selected.map(item =>
                `<span style="display: inline-block; background: #e2e8f0; padding: 2px 8px; margin: 2px; border-radius: 4px;">${item}</span>`
            ).join('');
            document.getElementById('batchGroupName').value = '';
            document.getElementById('batchCostSearch').value = '';
            document.getElementById('batchCostItem').value = '';
            document.getElementById('batchCostSuggestions').innerHTML = '<div style="padding: 15px; text-align: center; color: #64748b;">원가 항목을 검색하세요</div>';
            document.getElementById('batchMappingModal').classList.add('show');
        }

        // 일괄 매핑용 원가 항목 검색
        function searchBatchCostItems() {
            const search = document.getElementById('batchCostSearch').value.toLowerCase().trim();
            if (!search) {
                document.getElementById('batchCostSuggestions').innerHTML = '<div style="padding: 15px; text-align: center; color: #64748b;">원가 항목을 검색하세요</div>';
                return;
            }

            const filtered = costDataCache.filter(c =>
                (c.item_name || '').toLowerCase().includes(search)
            ).slice(0, 15);

            if (!filtered.length) {
                document.getElementById('batchCostSuggestions').innerHTML = '<div style="padding: 15px; text-align: center; color: #64748b;">일치하는 항목 없음</div>';
                return;
            }

            document.getElementById('batchCostSuggestions').innerHTML = filtered.map(c => `
                <div onclick="selectBatchCostItem('${c.item_name.replace(/'/g, "\\\\'")}')"
                     style="padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #e2e8f0;"
                     onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='white'">
                    <div style="font-weight: 500;">${c.item_name}</div>
                    <div style="font-size: 12px; color: #64748b;">${c.category || ''} | 총원가: ${formatNumber(c.total_cost)}원</div>
                </div>
            `).join('');
        }

        function selectBatchCostItem(itemName) {
            document.getElementById('batchCostItem').value = itemName;
            // 그룹명 자동 설정
            if (!document.getElementById('batchGroupName').value) {
                document.getElementById('batchGroupName').value = itemName;
            }
        }

        // 일괄 매핑 저장
        async function saveBatchMapping() {
            const costItem = document.getElementById('batchCostItem').value.trim();
            const groupName = document.getElementById('batchGroupName').value.trim();
            const salesItems = getSelectedUnmappedItems();

            if (!costItem) {
                alert('원가 항목을 선택하세요');
                return;
            }
            if (!groupName) {
                alert('그룹명을 입력하세요');
                return;
            }
            if (salesItems.length === 0) {
                alert('매핑할 매출 항목이 없습니다');
                return;
            }

            try {
                const response = await fetch('/api/admin/cost-mapping/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cost_item_name: costItem,
                        sales_item_names: salesItems,
                        group_name: groupName
                    })
                });
                const result = await response.json();
                if (result.success) {
                    alert(result.count + '개 항목이 "' + result.group_name + '" 그룹으로 매핑되었습니다');
                    closeModal('batchMappingModal');
                    loadCostMapping();
                    loadProfitAnalysis();
                } else {
                    alert('매핑 실패: ' + (result.error || '알 수 없는 오류'));
                }
            } catch (e) {
                alert('매핑 실패: ' + e.message);
            }
        }

        // 손익 분석 로드
        async function loadProfitAnalysis() {
            const year = document.getElementById('profitYear')?.value || '2025';
            try {
                const response = await fetch('/api/cost/profit-analysis?year=' + year);
                const data = await response.json();
                const summary = data.summary || {};

                document.getElementById('totalRevenue').textContent = formatCurrency(summary.total_revenue || 0);
                document.getElementById('totalCostSum').textContent = formatCurrency(summary.total_cost || 0);
                document.getElementById('totalProfit').textContent = formatCurrency(summary.total_profit || 0);
                document.getElementById('profitRate').textContent = (summary.profit_rate || 0).toFixed(1) + '%';
                document.getElementById('totalItems').textContent = summary.total_items || 0;
                document.getElementById('matchedItems').textContent = summary.matched_items || 0;
                document.getElementById('matchRate').textContent = (summary.match_rate || 0).toFixed(1) + '%';

                document.getElementById('profitAnalysisTable').innerHTML = (data.data || []).map(p => `
                    <tr style="${p.matched ? '' : 'background: #fef3c7;'}">
                        <td>${p.item_name}</td>
                        <td style="text-align: right;">${p.count}</td>
                        <td style="text-align: right;">${formatCurrency(p.revenue)}</td>
                        <td style="text-align: right;">${formatNumber(p.unit_cost)}</td>
                        <td style="text-align: right;">${formatCurrency(p.total_cost)}</td>
                        <td style="text-align: right; color: ${p.profit >= 0 ? '#059669' : '#dc2626'};">${formatCurrency(p.profit)}</td>
                        <td style="text-align: right;">${p.profit_rate.toFixed(1)}%</td>
                        <td style="text-align: center;">${p.matched ? '✅' : '❌'}</td>
                    </tr>
                `).join('') || '<tr><td colspan="8" style="text-align:center;">데이터가 없습니다</td></tr>';
            } catch (e) {
                console.error('손익 분석 로드 실패:', e);
            }
        }

        // ============ 손익계산서 설정 함수들 ============
        let financialDetailsCache = [];

        // 콤마 포맷 헬퍼 함수
        function formatMoneyInput(num) {
            return Math.round(num || 0).toLocaleString('ko-KR');
        }

        function parseMoneyInput(str) {
            if (!str) return 0;
            return parseFloat(String(str).replace(/,/g, '')) || 0;
        }

        function setMoneyInputValue(id, value) {
            const el = document.getElementById(id);
            if (el) el.value = formatMoneyInput(value);
        }

        function getMoneyInputValue(id) {
            const el = document.getElementById(id);
            return el ? parseMoneyInput(el.value) : 0;
        }

        // 입력 시 자동 콤마 포맷
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('fs-money-input')) {
                const val = parseMoneyInput(e.target.value);
                const cursorPos = e.target.selectionStart;
                const oldLen = e.target.value.length;
                e.target.value = formatMoneyInput(val);
                const newLen = e.target.value.length;
                // 커서 위치 조정
                const newPos = cursorPos + (newLen - oldLen);
                e.target.setSelectionRange(newPos, newPos);
                calculateFinancialSummary();
            }
        });

        async function loadFinancialSettings() {
            const year = document.getElementById('financialYear')?.value || '2025';
            try {
                const response = await fetch('/api/admin/financial-settings?year=' + year);
                const data = await response.json();

                if (data.settings) {
                    const s = data.settings;
                    setMoneyInputValue('fsRevenue', s.revenue || 0);
                    setMoneyInputValue('fsCostOfSales', s.cost_of_sales || 0);
                    setMoneyInputValue('fsSgaExpense', s.sga_expense || 0);
                    setMoneyInputValue('fsNonOperating', s.non_operating_income || 0);
                    document.getElementById('fsNotes').value = s.notes || '';
                } else {
                    // 데이터가 없으면 초기화
                    setMoneyInputValue('fsRevenue', 0);
                    setMoneyInputValue('fsCostOfSales', 0);
                    setMoneyInputValue('fsSgaExpense', 0);
                    setMoneyInputValue('fsNonOperating', 0);
                    document.getElementById('fsNotes').value = '';
                }

                financialDetailsCache = data.details || [];
                renderFinancialDetailsTable();
                calculateFinancialSummary();
            } catch (e) {
                console.error('손익계산서 설정 로드 실패:', e);
            }
        }

        function calculateFinancialSummary() {
            const revenue = getMoneyInputValue('fsRevenue');
            const costOfSales = getMoneyInputValue('fsCostOfSales');
            const sgaExpense = getMoneyInputValue('fsSgaExpense');
            const nonOperating = getMoneyInputValue('fsNonOperating');

            const grossProfit = revenue - costOfSales;
            const operatingProfit = grossProfit - sgaExpense;
            const preTaxProfit = operatingProfit + nonOperating;

            const costRate = revenue > 0 ? (costOfSales / revenue * 100) : 0;
            const grossProfitRate = revenue > 0 ? (grossProfit / revenue * 100) : 0;
            const sgaRate = revenue > 0 ? (sgaExpense / revenue * 100) : 0;
            const operatingProfitRate = revenue > 0 ? (operatingProfit / revenue * 100) : 0;
            const preTaxProfitRate = revenue > 0 ? (preTaxProfit / revenue * 100) : 0;

            document.getElementById('fsCostRate').textContent = costRate.toFixed(1) + '%';
            document.getElementById('fsGrossProfit').textContent = formatFinancialNumber(grossProfit);
            document.getElementById('fsGrossProfitRate').textContent = grossProfitRate.toFixed(1) + '%';
            document.getElementById('fsSgaRate').textContent = sgaRate.toFixed(1) + '%';
            document.getElementById('fsOperatingProfit').textContent = formatFinancialNumber(operatingProfit);
            document.getElementById('fsOperatingProfitRate').textContent = operatingProfitRate.toFixed(1) + '%';
            document.getElementById('fsPreTaxProfit').textContent = formatFinancialNumber(preTaxProfit);
            document.getElementById('fsPreTaxProfitRate').textContent = preTaxProfitRate.toFixed(1) + '%';

            // 색상 업데이트
            const opColor = operatingProfit >= 0 ? '#f59e0b' : '#ef4444';
            const ptColor = preTaxProfit >= 0 ? '#3b82f6' : '#ef4444';
            document.getElementById('fsOperatingProfit').style.color = opColor;
            document.getElementById('fsOperatingProfitRate').style.color = opColor;
            document.getElementById('fsPreTaxProfit').style.color = ptColor;
            document.getElementById('fsPreTaxProfitRate').style.color = ptColor;
        }

        function formatFinancialNumber(num) {
            const n = Math.round(num);
            if (Math.abs(n) >= 100000000) {
                return (n / 100000000).toFixed(2) + '억';
            }
            return n.toLocaleString('ko-KR');
        }

        function renderFinancialDetailsTable() {
            const tbody = document.getElementById('financialDetailsTable');
            if (!tbody) return;

            tbody.innerHTML = financialDetailsCache.map((d, idx) => `
                <tr>
                    <td>
                        <select class="form-control form-control-sm" onchange="updateFinancialDetail(${idx}, 'category', this.value)">
                            <option value="원가" ${d.category === '원가' ? 'selected' : ''}>원가</option>
                            <option value="판관비" ${d.category === '판관비' ? 'selected' : ''}>판관비</option>
                            <option value="영업외" ${d.category === '영업외' ? 'selected' : ''}>영업외</option>
                        </select>
                    </td>
                    <td><input type="text" class="form-control form-control-sm" value="${d.item_name || ''}" onchange="updateFinancialDetail(${idx}, 'item_name', this.value)"></td>
                    <td><input type="number" class="form-control form-control-sm" style="text-align: right;" value="${d.amount || 0}" onchange="updateFinancialDetail(${idx}, 'amount', this.value)"></td>
                    <td style="text-align: center;">
                        <button class="btn btn-sm" style="color: #ef4444;" onclick="removeFinancialDetail(${idx})">🗑️</button>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="4" style="text-align: center; color: #94a3b8;">세부 항목이 없습니다</td></tr>';
        }

        function addFinancialDetail() {
            financialDetailsCache.push({
                category: '원가',
                item_name: '',
                amount: 0
            });
            renderFinancialDetailsTable();
        }

        function updateFinancialDetail(idx, field, value) {
            if (financialDetailsCache[idx]) {
                financialDetailsCache[idx][field] = field === 'amount' ? parseFloat(value) || 0 : value;
            }
        }

        function removeFinancialDetail(idx) {
            financialDetailsCache.splice(idx, 1);
            renderFinancialDetailsTable();
        }

        async function saveFinancialSettings() {
            const year = parseInt(document.getElementById('financialYear').value);
            const revenue = getMoneyInputValue('fsRevenue');
            const costOfSales = getMoneyInputValue('fsCostOfSales');
            const sgaExpense = getMoneyInputValue('fsSgaExpense');
            const nonOperating = getMoneyInputValue('fsNonOperating');
            const notes = document.getElementById('fsNotes').value;

            const costRate = revenue > 0 ? (costOfSales / revenue * 100) : 0;
            const sgaRate = revenue > 0 ? (sgaExpense / revenue * 100) : 0;

            try {
                const response = await fetch('/api/admin/financial-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        year,
                        revenue,
                        cost_of_sales: costOfSales,
                        sga_expense: sgaExpense,
                        non_operating_income: nonOperating,
                        cost_rate: costRate,
                        sga_rate: sgaRate,
                        notes,
                        details: financialDetailsCache
                    })
                });
                const result = await response.json();
                if (result.success) {
                    alert('손익계산서 설정이 저장되었습니다.');
                } else {
                    alert('저장 실패: ' + (result.error || '알 수 없는 오류'));
                }
            } catch (e) {
                alert('저장 실패: ' + e.message);
            }
        }

        function formatNumber(num) {
            return Math.round(num || 0).toLocaleString('ko-KR');
        }

        function formatCurrency(num) {
            const n = Math.round(num || 0);
            if (Math.abs(n) >= 100000000) {
                return (n / 100000000).toFixed(1) + '억원';
            } else if (Math.abs(n) >= 10000) {
                return Math.round(n / 10000).toLocaleString('ko-KR') + '만원';
            }
            return n.toLocaleString('ko-KR') + '원';
        }

        // 설정 로드
        async function loadSettings() {
            const response = await fetch('/api/admin/teams');
            const data = await response.json();
            teamsData = data.teams || [];
            document.getElementById('teamsTable').innerHTML = teamsData.map(t => `
                <tr>
                    <td>${t.name}</td>
                    <td>${t.category}</td>
                    <td>${t.track_details ? '✅' : '❌'}</td>
                    <td><button class="btn btn-sm btn-primary" onclick="editTeam(${t.id})">수정</button></td>
                </tr>
            `).join('');
        }

        // 권한 로드
        async function loadPermissions() {
            // 사용자 목록 로드
            try {
                const usersRes = await fetch('/api/admin/users');
                const usersJson = await usersRes.json();
                const users = usersJson.users || [];
                const select = document.getElementById('permUserSelect');
                if (select) {
                    select.innerHTML = '<option value="">-- 사용자 선택 --</option>' +
                        users.map(u => `<option value="${u.id}">${u.name} (${u.username})</option>`).join('');
                }
            } catch (e) {
                console.error('사용자 목록 로드 실패:', e);
            }

            const response = await fetch('/api/admin/permission-groups');
            const data = await response.json();
            document.getElementById('permissionGroups').innerHTML = (data.groups || []).map(g => `
                <div class="goal-card" onclick="selectPermissionGroup(${g.id})">
                    <div class="goal-header">
                        <span class="goal-title">${g.name}</span>
                    </div>
                    <div style="font-size: 12px; color: #64748b;">${g.description}</div>
                </div>
            `).join('');
        }

        // 탭 목록 정의
        const TAB_LIST = [
            { id: 'overview', name: '대시보드', icon: '📊' },
            { id: 'detail', name: '상세분석', icon: '📈' },
            { id: 'collection', name: '수금', icon: '💰' },
            { id: 'profitAnalysis', name: '손익분석', icon: '📊' },
            { id: 'aiAnalysis', name: 'AI분석', icon: '🤖' },
            { id: 'reports', name: '보고서', icon: '📑' },
            { id: 'organization', name: '조직', icon: '🏢' }
        ];

        let currentPermUserId = null;
        let currentTabPermissions = {};

        async function loadUserTabPermissions() {
            const userId = document.getElementById('permUserSelect').value;
            const container = document.getElementById('tabPermissionsContainer');

            if (!userId) {
                container.style.display = 'none';
                return;
            }

            currentPermUserId = userId;
            container.style.display = 'block';

            try {
                const response = await fetch('/api/admin/user-tab-permissions?user_id=' + userId);
                const data = await response.json();
                currentTabPermissions = data.permissions || {};

                // 관리자 접근 권한 체크박스
                document.getElementById('permAdminAccess').checked = data.is_admin || false;

                // 탭 권한 테이블 렌더링
                const tbody = document.getElementById('tabPermissionsTable');
                tbody.innerHTML = TAB_LIST.map(tab => `
                    <tr>
                        <td>${tab.icon} ${tab.name}</td>
                        <td style="text-align: center;">
                            <input type="checkbox" class="tab-perm-checkbox"
                                data-tab="${tab.id}"
                                ${currentTabPermissions[tab.id] !== false ? 'checked' : ''}>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('탭 권한 로드 실패:', e);
            }
        }

        async function saveUserTabPermissions() {
            if (!currentPermUserId) {
                alert('사용자를 선택하세요.');
                return;
            }

            const permissions = {};
            document.querySelectorAll('.tab-perm-checkbox').forEach(cb => {
                permissions[cb.dataset.tab] = cb.checked;
            });

            const isAdmin = document.getElementById('permAdminAccess').checked;

            try {
                const response = await fetch('/api/admin/user-tab-permissions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentPermUserId,
                        permissions: permissions,
                        is_admin: isAdmin
                    })
                });
                const result = await response.json();
                if (result.success) {
                    alert('권한이 저장되었습니다.');
                } else {
                    alert('저장 실패: ' + (result.error || '알 수 없는 오류'));
                }
            } catch (e) {
                alert('저장 실패: ' + e.message);
            }
        }

        function toggleAdminAccess() {
            // 관리자 권한 토글 시 추가 작업 필요하면 여기에
        }

        // 모달
        async function showGoalModal() {
            // 검사목적 옵션 동적 로드
            try {
                const res = await fetch('/api/purposes');
                const data = await res.json();
                const select = document.getElementById('goalInspectionPurpose');
                select.innerHTML = '<option value="전체">전체</option>' +
                    (data.purposes || []).map(p => `<option value="${p}">${p}</option>`).join('');
            } catch (e) {
                console.error('검사목적 로드 실패:', e);
            }
            document.getElementById('goalModal').classList.add('show');
        }
        function showAddUserModal() {
            document.getElementById('userModalTitle').textContent = '사용자 추가';
            document.getElementById('editUserId').value = '';
            document.getElementById('newUsername').value = '';
            document.getElementById('newName').value = '';
            document.getElementById('newEmail').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('userModal').classList.add('show');
        }
        function closeModal(id) { document.getElementById(id).classList.remove('show'); }

        // 목표 저장
        async function saveGoal(e) {
            e.preventDefault();
            const data = {
                goal_type: document.getElementById('goalType').value,
                target_id: document.getElementById('goalTarget')?.value || null,
                inspection_purpose: document.getElementById('goalInspectionPurpose').value,
                target_sales: parseFloat(document.getElementById('goalSales').value) || 0,
                target_count: parseInt(document.getElementById('goalCount').value) || 0,
                year: parseInt(document.getElementById('goalSetYear').value),
                month: document.getElementById('goalMonth').value ? parseInt(document.getElementById('goalMonth').value) : null
            };
            await fetch('/api/admin/goals', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            closeModal('goalModal');
            loadGoals();
            return false;
        }

        async function deleteGoal(id) {
            if (!confirm('삭제하시겠습니까?')) return;
            await fetch(`/api/admin/goals/${id}`, { method: 'DELETE' });
            loadGoals();
        }

        // 사용자 저장
        async function saveUser(e) {
            e.preventDefault();
            const userId = document.getElementById('editUserId').value;
            const data = {
                username: document.getElementById('newUsername').value,
                name: document.getElementById('newName').value,
                email: document.getElementById('newEmail').value,
                password: document.getElementById('newPassword').value,
                team_id: document.getElementById('newTeam').value || null,
                role: document.getElementById('newRole').value
            };
            const url = userId ? `/api/admin/users/${userId}` : '/api/admin/users';
            const method = userId ? 'PUT' : 'POST';
            const result = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const res = await result.json();
            if (res.success) {
                closeModal('userModal');
                loadUsers();
            } else {
                alert(res.error);
            }
            return false;
        }

        function editUser(id) {
            const user = usersData.find(u => u.id === id);
            if (!user) return;
            document.getElementById('userModalTitle').textContent = '사용자 수정';
            document.getElementById('editUserId').value = id;
            document.getElementById('newUsername').value = user.username;
            document.getElementById('newName').value = user.name || '';
            document.getElementById('newEmail').value = user.email || '';
            document.getElementById('newPassword').value = '';
            document.getElementById('newTeam').value = user.team_id || '';
            document.getElementById('newRole').value = user.role;
            document.getElementById('userModal').classList.add('show');
        }

        async function resetPassword(id) {
            if (!confirm('비밀번호를 초기화하시겠습니까?\\n새 비밀번호: 1234')) return;
            await fetch(`/api/admin/users/${id}/reset-password`, { method: 'POST' });
            alert('비밀번호가 1234로 초기화되었습니다.');
        }

        async function toggleUserStatus(userId, status) {
            await fetch(`/api/admin/users/${userId}/status`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status })
            });
            loadUsers();
        }

        function updateGoalTarget() {
            const type = document.getElementById('goalType').value;
            const targetGroup = document.getElementById('goalTargetGroup');
            const targetSelect = document.getElementById('goalTarget');
            if (type === 'overall') {
                targetGroup.style.display = 'none';
            } else {
                targetGroup.style.display = 'block';
                if (type === 'team') {
                    targetSelect.innerHTML = teamsData.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
                } else {
                    targetSelect.innerHTML = usersData.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
                }
            }
        }

        function filterUsers() {
            // 간단한 필터링
        }

        // 팀원 관리
        let currentTeamId = null;
        let currentTeamCategory = null;

        function editTeam(teamId) {
            const team = teamsData.find(t => t.id === teamId);
            if (!team) return;

            currentTeamId = teamId;
            currentTeamCategory = team.category;

            // 모달 제목 설정
            document.getElementById('teamMemberModalTitle').textContent = team.name + ' - 인원 관리';

            // 부서 유형에 따라 필드 표시/숨김
            const isHeadquarters = (team.category === '본사');
            document.querySelectorAll('.headquarters-field, .headquarters-col').forEach(el => {
                el.style.display = isHeadquarters ? '' : 'none';
            });
            document.querySelectorAll('.sales-field, .sales-col').forEach(el => {
                el.style.display = isHeadquarters ? 'none' : '';
            });

            // 폼 초기화 및 숨기기
            hideMemberForm();

            // 팀원 목록 로드
            loadTeamMembers(teamId);

            // 모달 열기
            document.getElementById('teamMemberModal').classList.add('show');
        }

        async function loadTeamMembers(teamId) {
            try {
                const res = await fetch(`/api/admin/teams/${teamId}/members`);
                const data = await res.json();
                const members = data.members || [];
                const isHeadquarters = (currentTeamCategory === '본사');

                document.getElementById('teamMemberCount').textContent = '총 ' + members.length + '명';

                document.getElementById('teamMembersTable').innerHTML = members.map(m => `
                    <tr>
                        <td>${m.name}</td>
                        <td>${m.position || '-'}</td>
                        ${isHeadquarters ? `<td>${m.duties || '-'}</td>` : ''}
                        ${!isHeadquarters ? `<td>${m.region || '-'}</td>` : ''}
                        ${!isHeadquarters ? `<td>${m.hire_year || '-'}</td>` : ''}
                        ${!isHeadquarters ? `<td>${m.phone || '-'}</td>` : ''}
                        <td>${m.email || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editMember(${m.id})">수정</button>
                            <button class="btn btn-sm" style="background:#ef4444;color:#fff;" onclick="deleteMember(${m.id})">삭제</button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="8" style="text-align:center;color:#94a3b8;">등록된 인원이 없습니다</td></tr>';
            } catch (e) {
                console.error('팀원 로드 실패:', e);
            }
        }

        function showAddMemberForm() {
            document.getElementById('editMemberId').value = '';
            document.getElementById('memberName').value = '';
            document.getElementById('memberPosition').value = '';
            document.getElementById('memberDuties').value = '';
            document.getElementById('memberRegion').value = '';
            document.getElementById('memberHireYear').value = '';
            document.getElementById('memberPhone').value = '';
            document.getElementById('memberEmail').value = '';
            document.getElementById('memberNotes').value = '';
            document.getElementById('memberFormContainer').style.display = 'block';
        }

        function hideMemberForm() {
            document.getElementById('memberFormContainer').style.display = 'none';
        }

        async function editMember(memberId) {
            try {
                const res = await fetch(`/api/admin/team-members/${memberId}`);
                const data = await res.json();
                if (data.member) {
                    const m = data.member;
                    document.getElementById('editMemberId').value = m.id;
                    document.getElementById('memberName').value = m.name || '';
                    document.getElementById('memberPosition').value = m.position || '';
                    document.getElementById('memberDuties').value = m.duties || '';
                    document.getElementById('memberRegion').value = m.region || '';
                    document.getElementById('memberHireYear').value = m.hire_year || '';
                    document.getElementById('memberPhone').value = m.phone || '';
                    document.getElementById('memberEmail').value = m.email || '';
                    document.getElementById('memberNotes').value = m.notes || '';
                    document.getElementById('memberFormContainer').style.display = 'block';
                }
            } catch (e) {
                console.error('팀원 정보 로드 실패:', e);
            }
        }

        async function saveMember() {
            const memberId = document.getElementById('editMemberId').value;
            const data = {
                team_id: currentTeamId,
                name: document.getElementById('memberName').value,
                position: document.getElementById('memberPosition').value,
                duties: document.getElementById('memberDuties').value,
                region: document.getElementById('memberRegion').value,
                hire_year: document.getElementById('memberHireYear').value || null,
                phone: document.getElementById('memberPhone').value,
                email: document.getElementById('memberEmail').value,
                notes: document.getElementById('memberNotes').value
            };

            if (!data.name) {
                alert('이름을 입력하세요.');
                return;
            }

            try {
                const url = memberId ? `/api/admin/team-members/${memberId}` : '/api/admin/team-members';
                const method = memberId ? 'PUT' : 'POST';
                await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                hideMemberForm();
                loadTeamMembers(currentTeamId);
            } catch (e) {
                console.error('팀원 저장 실패:', e);
                alert('저장에 실패했습니다.');
            }
        }

        async function deleteMember(memberId) {
            if (!confirm('이 인원을 삭제하시겠습니까?')) return;
            try {
                await fetch(`/api/admin/team-members/${memberId}`, { method: 'DELETE' });
                loadTeamMembers(currentTeamId);
            } catch (e) {
                console.error('팀원 삭제 실패:', e);
            }
        }

        // 권한 그룹 선택
        let selectedPermissionGroup = null;
        function selectPermissionGroup(groupId) {
            selectedPermissionGroup = groupId;
            document.querySelectorAll('#permissionGroups .goal-card').forEach(card => {
                card.style.border = '1px solid #e2e8f0';
            });
            event.currentTarget.style.border = '2px solid #6366f1';
            loadPermissionSettings(groupId);
        }

        async function loadPermissionSettings(groupId) {
            try {
                const response = await fetch(`/api/admin/permission-groups/${groupId}`);
                const data = await response.json();
                if (data.group) {
                    // 권한 설정 UI 업데이트
                    const g = data.group;
                    document.getElementById('permDataScope').value = g.data_scope || 'team';
                    document.getElementById('permCanEdit').checked = g.can_edit || false;
                    document.getElementById('permCanDelete').checked = g.can_delete || false;
                    document.getElementById('permCanExport').checked = g.can_export || false;
                }
            } catch (e) {
                console.error('권한 설정 로드 실패:', e);
            }
        }

        // 초기 로드
        loadGoals();
        loadUsers();
    </script>
</body>
</html>
'''

HTML_TEMPLATE = '''
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:,">
    <title>경영지표 대시보드</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #e0e7ff;
            --success: #10b981;
            --success-light: #d1fae5;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --info: #06b6d4;
            --info-light: #cffafe;
            --purple: #8b5cf6;
            --purple-light: #ede9fe;
            --pink: #ec4899;
            --pink-light: #fce7f3;
            --orange: #f97316;
            --orange-light: #ffedd5;
            --teal: #14b8a6;
            --teal-light: #ccfbf1;
            --rose: #f43f5e;
            --rose-light: #ffe4e6;
            --sky: #0ea5e9;
            --sky-light: #e0f2fe;
            --lime: #84cc16;
            --lime-light: #ecfccb;
            --amber: #f59e0b;
            --amber-light: #fef3c7;
            --cyan: #06b6d4;
            --cyan-light: #cffafe;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Malgun Gothic', sans-serif;
            background: var(--gray-100);
            color: var(--gray-800);
            min-height: 100vh;
        }

        /* 헤더 */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-md);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }

        .header-title {
            color: white;
            font-size: 22px;
            font-weight: 700;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .token-badge {
            background: rgba(255,255,255,0.15);
            padding: 8px 14px;
            border-radius: 10px;
            color: white;
            font-size: 12px;
            line-height: 1.4;
        }

        .token-badge .current { font-weight: 600; }
        .token-badge .prev { opacity: 0.7; font-size: 11px; }

        /* 헤더 메뉴 버튼 */
        .header-menu-buttons {
            display: flex;
            gap: 8px;
            margin-left: 16px;
        }
        .header-menu-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
        }
        .header-menu-btn.ai-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }
        .header-menu-btn.ai-btn:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }
        .header-menu-btn.info-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .header-menu-btn.info-btn:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        .header-menu-btn.terminal-btn {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        }
        .header-menu-btn.terminal-btn:hover {
            background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 41, 59, 0.4);
        }
        .header-menu-btn span:first-child {
            font-size: 14px;
        }

        /* 메인 컨테이너 */
        .main-container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 24px;
        }

        /* 필터 섹션 */
        .filter-section {
            background: white;
            border-radius: 16px;
            padding: 20px 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .filter-row {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--gray-50);
            padding: 8px 14px;
            border-radius: 10px;
            border: 1px solid var(--gray-200);
        }

        .filter-label {
            font-size: 13px;
            color: var(--gray-500);
            font-weight: 500;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            font-size: 14px;
            color: var(--gray-700);
            background: white;
            cursor: pointer;
            min-width: 90px;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .filter-btn {
            padding: 6px 14px;
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            background: white;
            font-size: 13px;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-btn:hover {
            background: var(--gray-50);
            border-color: var(--gray-300);
        }
        .filter-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .filter-divider {
            width: 1px;
            height: 32px;
            background: var(--gray-200);
        }

        .filter-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            padding: 8px 12px;
            background: var(--gray-50);
            border-radius: 8px;
            border: 1px solid var(--gray-200);
        }

        .filter-checkbox input {
            width: 16px;
            height: 16px;
            accent-color: var(--primary);
        }

        .filter-checkbox span {
            font-size: 13px;
            color: var(--gray-600);
        }

        .btn-search {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            margin-left: auto;
        }

        .btn-search:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-search:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* 탭 카드 그리드 */
        .tab-cards {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .tab-card {
            background: white;
            border-radius: 12px;
            padding: 14px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            box-shadow: var(--shadow-sm);
            min-width: 90px;
            flex: 1;
            max-width: 120px;
        }

        .tab-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
            border-color: var(--gray-200);
        }

        .tab-card.active {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .tab-card.active .tab-icon {
            background: var(--primary);
            color: white;
        }

        .tab-card.active .tab-label {
            color: var(--primary-dark);
            font-weight: 600;
        }

        .tab-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            margin: 0 auto 8px;
            background: var(--gray-100);
            color: var(--gray-500);
            transition: all 0.2s;
        }

        .tab-label {
            font-size: 12px;
            color: var(--gray-600);
            font-weight: 500;
            white-space: nowrap;
        }

        /* 특수 탭 스타일 */
        .tab-card.main-tab {
            background: linear-gradient(135deg, #0ea5e9, #06b6d4);
        }
        .tab-card.main-tab .tab-icon {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        .tab-card.main-tab .tab-label {
            color: white;
        }
        .tab-card.main-tab.active {
            border-color: rgba(255,255,255,0.5);
        }

        .tab-card.ai-tab {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
        }
        .tab-card.ai-tab .tab-icon {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        .tab-card.ai-tab .tab-label {
            color: white;
        }

        .tab-card.info-tab {
            background: linear-gradient(135deg, #10b981, #34d399);
        }
        .tab-card.info-tab .tab-icon {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        .tab-card.info-tab .tab-label {
            color: white;
        }

        .tab-card.terminal-tab {
            background: linear-gradient(135deg, #1e293b, #334155);
        }
        .tab-card.terminal-tab .tab-icon {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        .tab-card.terminal-tab .tab-label {
            color: #10b981;
        }

        /* KPI 카드 섹션 */
        .kpi-section {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .kpi-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .kpi-card.sales::before { background: linear-gradient(90deg, #6366f1, #8b5cf6); }
        .kpi-card.count::before { background: linear-gradient(90deg, #10b981, #34d399); }
        .kpi-card.price::before { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .kpi-card.goal::before { background: linear-gradient(90deg, #ec4899, #f472b6); }

        .kpi-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .kpi-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .kpi-card.sales .kpi-icon { background: var(--primary-light); color: var(--primary); }
        .kpi-card.count .kpi-icon { background: var(--success-light); color: var(--success); }
        .kpi-card.price .kpi-icon { background: var(--warning-light); color: var(--warning); }
        .kpi-card.goal .kpi-icon { background: var(--pink-light); color: var(--pink); }

        .kpi-trend {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .kpi-trend.up { background: var(--success-light); color: var(--success); }
        .kpi-trend.down { background: var(--danger-light); color: var(--danger); }

        .kpi-label {
            font-size: 14px;
            color: var(--gray-500);
            margin-bottom: 6px;
        }

        .kpi-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--gray-800);
        }

        .kpi-compare {
            font-size: 13px;
            color: var(--gray-400);
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed var(--gray-200);
        }

        .kpi-compare span {
            color: var(--gray-600);
            font-weight: 500;
        }

        /* KPI 카드 호버 오버레이 */
        .kpi-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(2px);
            border-radius: 16px;
            padding: 24px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            z-index: 10;
            border: 2px solid var(--gray-200);
        }

        .kpi-card:hover .kpi-overlay:not(:empty) {
            opacity: 1;
            visibility: visible;
        }

        .kpi-overlay .overlay-year-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--gray-600);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .kpi-overlay .overlay-label {
            font-size: 12px;
            color: var(--gray-500);
            margin-bottom: 6px;
        }

        .kpi-overlay .overlay-value {
            font-size: 26px;
            font-weight: 700;
            color: var(--gray-700);
            margin-bottom: 8px;
        }

        .kpi-overlay .overlay-change {
            font-size: 13px;
            color: var(--gray-500);
        }

        .kpi-overlay .overlay-change .up { color: var(--success); font-weight: 600; }
        .kpi-overlay .overlay-change .down { color: var(--danger); font-weight: 600; }

        /* 검사 목적별 카드 섹션 */
        .purpose-kpi-section {
            margin-bottom: 24px;
        }

        .section-title-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-800);
        }

        .section-badge {
            background: var(--primary-light);
            color: var(--primary);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .purpose-kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }

        /* 부서별 카드 스타일 */
        .dept-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border: 1px solid var(--gray-100);
            position: relative;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .dept-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        }

        .dept-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .dept-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .dept-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--gray-800);
        }

        .dept-card-body {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .dept-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dept-label {
            font-size: 13px;
            color: var(--gray-500);
        }

        .dept-value {
            font-size: 15px;
            font-weight: 600;
            color: var(--gray-800);
        }

        .dept-card-compare {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px dashed var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dept-card-compare .compare-label {
            font-size: 12px;
            color: var(--gray-400);
        }

        .dept-card-compare .compare-value {
            font-size: 14px;
            font-weight: 700;
        }

        .dept-ratio {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary);
            background: var(--primary-light);
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
        }

        .dept-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            border-radius: 16px;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            padding: 16px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .dept-card:hover .dept-overlay.active {
            display: flex;
            opacity: 1;
        }

        .dept-overlay .overlay-title {
            font-size: 13px;
            color: rgba(255,255,255,0.7);
            margin-bottom: 8px;
        }

        .dept-overlay .overlay-value {
            font-size: 28px;
            font-weight: 700;
        }

        .dept-overlay .overlay-value.positive { color: #4ade80; }
        .dept-overlay .overlay-value.negative { color: #f87171; }

        .dept-overlay .overlay-detail {
            font-size: 12px;
            color: rgba(255,255,255,0.6);
            margin-top: 8px;
        }

        @media (max-width: 1200px) {
            .department-cards {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }

        @media (max-width: 768px) {
            .department-cards {
                grid-template-columns: 1fr !important;
            }
        }

        .purpose-kpi-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
        }

        .purpose-kpi-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .purpose-kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .purpose-kpi-card[data-color="blue"]::before { background: var(--primary); }
        .purpose-kpi-card[data-color="green"]::before { background: var(--success); }
        .purpose-kpi-card[data-color="orange"]::before { background: var(--orange); }
        .purpose-kpi-card[data-color="purple"]::before { background: var(--purple); }
        .purpose-kpi-card[data-color="pink"]::before { background: var(--pink); }
        .purpose-kpi-card[data-color="info"]::before { background: var(--info); }
        .purpose-kpi-card[data-color="teal"]::before { background: var(--teal); }
        .purpose-kpi-card[data-color="amber"]::before { background: var(--amber); }
        .purpose-kpi-card[data-color="rose"]::before { background: var(--rose); }
        .purpose-kpi-card[data-color="sky"]::before { background: var(--sky); }
        .purpose-kpi-card[data-color="lime"]::before { background: var(--lime); }
        .purpose-kpi-card[data-color="cyan"]::before { background: var(--cyan); }
        .purpose-kpi-card[data-color="danger"]::before { background: var(--danger); }

        .purpose-kpi-card[data-color="blue"] .purpose-kpi-icon { background: var(--primary-light); color: var(--primary); }
        .purpose-kpi-card[data-color="green"] .purpose-kpi-icon { background: var(--success-light); color: var(--success); }
        .purpose-kpi-card[data-color="orange"] .purpose-kpi-icon { background: var(--orange-light); color: var(--orange); }
        .purpose-kpi-card[data-color="purple"] .purpose-kpi-icon { background: var(--purple-light); color: var(--purple); }
        .purpose-kpi-card[data-color="pink"] .purpose-kpi-icon { background: var(--pink-light); color: var(--pink); }
        .purpose-kpi-card[data-color="info"] .purpose-kpi-icon { background: var(--info-light); color: var(--info); }
        .purpose-kpi-card[data-color="teal"] .purpose-kpi-icon { background: var(--teal-light); color: var(--teal); }
        .purpose-kpi-card[data-color="amber"] .purpose-kpi-icon { background: var(--amber-light); color: var(--amber); }
        .purpose-kpi-card[data-color="rose"] .purpose-kpi-icon { background: var(--rose-light); color: var(--rose); }
        .purpose-kpi-card[data-color="sky"] .purpose-kpi-icon { background: var(--sky-light); color: var(--sky); }
        .purpose-kpi-card[data-color="lime"] .purpose-kpi-icon { background: var(--lime-light); color: var(--lime); }
        .purpose-kpi-card[data-color="cyan"] .purpose-kpi-icon { background: var(--cyan-light); color: var(--cyan); }
        .purpose-kpi-card[data-color="danger"] .purpose-kpi-icon { background: var(--danger-light); color: var(--danger); }

        .purpose-kpi-card[data-color="danger"] .purpose-kpi-value { color: var(--danger); }

        .purpose-kpi-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .purpose-kpi-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .purpose-kpi-trend {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .purpose-kpi-trend.up { background: var(--success-light); color: var(--success); }
        .purpose-kpi-trend.down { background: var(--danger-light); color: var(--danger); }

        .purpose-kpi-name {
            font-size: 13px;
            color: var(--gray-500);
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .purpose-kpi-value {
            font-size: 22px;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 4px;
        }

        .purpose-kpi-sub {
            font-size: 12px;
            color: var(--gray-400);
        }

        .purpose-kpi-sub span {
            color: var(--gray-600);
            font-weight: 500;
        }

        /* 전년도 오버레이 스타일 */
        .purpose-kpi-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(2px);
            border-radius: 16px;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            z-index: 10;
            border: 2px solid var(--gray-200);
        }

        .purpose-kpi-card:hover .purpose-kpi-overlay {
            opacity: 1;
            visibility: visible;
        }

        .overlay-year-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--gray-600);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .overlay-label {
            font-size: 12px;
            color: var(--gray-500);
            margin-bottom: 4px;
        }

        .overlay-name {
            font-size: 13px;
            color: var(--gray-600);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .overlay-value {
            font-size: 22px;
            font-weight: 700;
            color: var(--gray-700);
            margin-bottom: 4px;
        }

        .overlay-sub {
            font-size: 12px;
            color: var(--gray-400);
        }

        .overlay-change {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--gray-200);
            font-size: 12px;
            color: var(--gray-500);
        }

        .overlay-change .up { color: var(--success); font-weight: 600; }
        .overlay-change .down { color: var(--danger); font-weight: 600; }

        /* ====== 개인별 탭 전용 스타일 ====== */
        .personal-kpi-section {
            margin-bottom: 24px;
        }

        /* 효율성 분석 4분면 범례 */
        .quadrant-legend {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .q-item {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 6px;
            background: var(--gray-100);
            color: var(--gray-600);
        }
        .q-item.q1 { background: rgba(37, 99, 235, 0.15); color: #1d4ed8; }   /* 고건수·고매출: 파란색 */
        .q-item.q2 { background: rgba(6, 182, 212, 0.15); color: #0891b2; }   /* 저건수·고매출: 청록색 */
        .q-item.q3 { background: rgba(249, 115, 22, 0.15); color: #ea580c; }  /* 고건수·저매출: 주황색 */
        .q-item.q4 { background: rgba(220, 38, 38, 0.15); color: #dc2626; }   /* 저건수·저매출: 빨간색 */

        /* 다중 선택 드롭다운 */
        .multi-select-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .preset-btns {
            display: flex;
            gap: 4px;
        }
        .preset-btn {
            padding: 4px 10px;
            border: 1px solid var(--gray-200);
            background: white;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .preset-btn:hover { background: var(--gray-50); }
        .preset-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .multi-select-dropdown { position: relative; }
        .multi-select-btn {
            padding: 6px 12px;
            border: 1px solid var(--gray-200);
            background: white;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .selected-count {
            color: var(--primary);
            font-weight: 600;
        }
        .multi-select-list {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            box-shadow: var(--shadow-md);
            z-index: 100;
            max-height: 250px;
            overflow-y: auto;
            min-width: 180px;
        }
        .multi-select-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.15s;
            font-size: 13px;
        }
        .multi-select-item:hover { background: var(--gray-50); }
        .multi-select-item input { accent-color: var(--primary); }
        .selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 8px 16px 0;
            min-height: 28px;
        }
        .selected-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: var(--primary-light);
            color: var(--primary);
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        .selected-tag .remove {
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
        }
        .selected-tag .remove:hover { color: var(--danger); }

        /* 차트 컨트롤 */
        .chart-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .sort-toggle-btn {
            padding: 6px 12px;
            border: 1px solid var(--gray-200);
            background: white;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .sort-toggle-btn:hover { background: var(--gray-50); }

        /* 긴급 배지 */
        .urgent-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            background: var(--danger-light);
            color: var(--danger);
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        /* 정렬 가능 테이블 */
        .sortable-table th.sortable {
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }
        .sortable-table th.sortable:hover { background: var(--gray-100); }

        /* 목적별 카드 그리드 스타일 */
        .purpose-card-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }
        @media (max-width: 1200px) { .purpose-card-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 900px) { .purpose-card-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .purpose-card-grid { grid-template-columns: 1fr; } }

        .purpose-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 14px;
            padding: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border-left: 4px solid var(--primary);
        }
        .purpose-card:hover {
            border-color: var(--primary);
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.18);
            transform: translateY(-3px);
        }
        .purpose-card.top-1 {
            background: linear-gradient(135deg, #fffbeb, white);
            border-left-color: #f59e0b;
        }
        .purpose-card.top-2 {
            background: linear-gradient(135deg, #f8fafc, white);
            border-left-color: #94a3b8;
        }
        .purpose-card.top-3 {
            background: linear-gradient(135deg, #fef3e2, white);
            border-left-color: #cd7f32;
        }
        .purpose-card-rank {
            position: absolute;
            top: 10px;
            left: 12px;
            font-size: 20px;
        }
        .purpose-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            padding-left: 28px;
        }
        .purpose-card-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-800);
            line-height: 1.3;
            flex: 1;
            word-break: keep-all;
        }
        .purpose-card-growth {
            font-size: 11px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 12px;
            white-space: nowrap;
            margin-left: 8px;
        }
        .purpose-card-growth.positive { background: #dcfce7; color: #166534; }
        .purpose-card-growth.negative { background: #fee2e2; color: #991b1b; }
        .purpose-card-growth.neutral { background: #f3f4f6; color: #6b7280; }
        .purpose-card-sales {
            font-size: 26px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 6px;
            padding-left: 28px;
        }
        .purpose-card-count {
            font-size: 13px;
            color: var(--gray-600);
            margin-bottom: 12px;
            padding-left: 28px;
        }
        .purpose-card-bar {
            height: 8px;
            background: var(--gray-100);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 6px;
        }
        .purpose-card-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #8b5cf6);
            border-radius: 4px;
            transition: width 0.6s ease;
        }
        .purpose-card-percent {
            font-size: 12px;
            color: var(--gray-500);
            text-align: right;
            margin-bottom: 10px;
        }
        .purpose-card-footer {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--gray-500);
            padding-top: 10px;
            border-top: 1px dashed var(--gray-200);
        }

        /* 목적별 호버 팝업 */
        .purpose-hover-popup {
            position: fixed;
            z-index: 10000;
            background: white;
            border: 2px solid var(--primary);
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
            padding: 20px;
            min-width: 360px;
            max-width: 420px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
            pointer-events: none;
        }
        .purpose-hover-popup.active {
            opacity: 1;
            visibility: visible;
        }
        .popup-purpose-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 14px;
            margin-bottom: 14px;
            border-bottom: 1px solid var(--gray-200);
        }
        .popup-purpose-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--gray-800);
        }
        .popup-purpose-rank {
            font-size: 24px;
        }
        .popup-purpose-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }
        .popup-stat-item {
            background: var(--gray-50);
            padding: 12px;
            border-radius: 10px;
        }
        .popup-stat-label {
            font-size: 11px;
            color: var(--gray-500);
            margin-bottom: 4px;
        }
        .popup-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--gray-800);
        }
        .popup-stat-sub {
            font-size: 11px;
            color: var(--gray-400);
            margin-top: 2px;
        }
        .popup-section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-600);
            margin-bottom: 10px;
        }
        .popup-manager-section { margin-bottom: 16px; }
        .popup-manager-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }
        .popup-manager-name {
            width: 65px;
            font-size: 11px;
            font-weight: 500;
            color: var(--gray-700);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .popup-manager-bar {
            flex: 1;
            height: 18px;
            background: var(--gray-100);
            border-radius: 4px;
            overflow: hidden;
        }
        .popup-manager-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 6px;
            min-width: 30px;
        }
        .popup-manager-bar-text {
            font-size: 9px;
            font-weight: 600;
            color: white;
        }
        .popup-manager-sales {
            width: 60px;
            font-size: 11px;
            font-weight: 600;
            color: var(--gray-700);
            text-align: right;
        }
        .popup-client-section { margin-bottom: 16px; }
        .popup-client-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .popup-client-tag {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 6px;
            background: var(--gray-100);
            color: var(--gray-700);
        }
        .popup-client-tag.top {
            background: var(--primary);
            color: white;
        }
        .popup-insight {
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            border-radius: 10px;
            padding: 12px;
            border-left: 3px solid #3b82f6;
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }
        .popup-insight-icon { font-size: 16px; }
        .popup-insight-text {
            font-size: 12px;
            color: #1e40af;
            line-height: 1.5;
        }

        /* 모달 스타일 */
        .modal-overlay, .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: modalSlideIn 0.3s ease-out;
            transform-origin: center center;
        }
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-200);
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }
        .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-800);
        }
        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--gray-100);
            color: var(--gray-600);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .modal-close:hover {
            background: var(--danger-light);
            color: var(--danger);
        }
        .modal-body { padding: 24px; }
        .modal-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }
        .modal-section h4 {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 12px;
        }
        .modal-client-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .modal-client-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: var(--gray-50);
            border-radius: 8px;
        }
        .modal-client-name {
            font-size: 13px;
            color: var(--gray-700);
            font-weight: 500;
        }
        .modal-client-value {
            font-size: 13px;
            color: var(--primary);
            font-weight: 600;
        }
        .modal-region-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .region-tag {
            padding: 6px 12px;
            background: var(--primary-light);
            color: var(--primary);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        /* SVG Korea Map Styles */
        .region-path {
            fill: #dbeafe;
            stroke: #fff;
            stroke-width: 2;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .region-path:hover {
            fill: #93c5fd;
            transform: scale(1.02);
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.15));
        }
        .region-path.selected {
            fill: #3b82f6;
            stroke: #1e40af;
            stroke-width: 3;
        }
        .region-path.level-1 { fill: #dbeafe; }
        .region-path.level-2 { fill: #93c5fd; }
        .region-path.level-3 { fill: #3b82f6; }
        .region-path.level-4 { fill: #1e3a8a; }
        .map-label {
            font-size: 11px;
            font-weight: 600;
            fill: #374151;
            pointer-events: auto;
            text-anchor: middle;
        }
        .map-label.small {
            font-size: 9px;
        }

        /* Region KPI Overlay */
        .region-kpi-overlay {
            position: absolute;
            top: 100%;
            left: 0;
            width: 280px;
            background: white;
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 12px;
        }

        /* Region Detail Panel */
        .region-detail-section {
            margin-bottom: 20px;
        }
        .region-detail-section:last-child {
            margin-bottom: 0;
        }
        .region-detail-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--gray-100);
        }
        .region-stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        .region-stat-item {
            background: var(--gray-50);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        .region-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--gray-800);
        }
        .region-stat-label {
            font-size: 11px;
            color: var(--gray-500);
            margin-top: 4px;
        }
        .region-manager-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .region-manager-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--gray-50);
            border-radius: 6px;
        }
        .region-ai-opinion {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #7dd3fc;
            border-radius: 10px;
            padding: 14px;
            font-size: 13px;
            line-height: 1.6;
            color: var(--gray-700);
        }
        .region-top-clients {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .region-client-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px dashed var(--gray-100);
        }
        .region-client-item:last-child {
            border-bottom: none;
        }
        .heatmap-cell {
            padding: 4px 8px;
            border-radius: 4px;
            text-align: center;
            font-weight: 600;
        }
        .heatmap-high { background: #dcfce7; color: #166534; }
        .heatmap-medium { background: #fef9c3; color: #854d0e; }
        .heatmap-low { background: #fee2e2; color: #991b1b; }
        .region-distribution {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        .region-chip {
            padding: 2px 8px;
            background: var(--primary-light);
            color: var(--primary);
            border-radius: 12px;
            font-size: 11px;
        }

        /* 상세 버튼 */
        .btn-detail {
            padding: 6px 12px;
            background: var(--gray-100);
            border: none;
            border-radius: 6px;
            font-size: 12px;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-detail:hover {
            background: var(--primary-light);
            color: var(--primary);
        }
        .text-center { text-align: center; }

        /* 콘텐츠 영역 */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .card {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-100);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-800);
        }

        .card-badge {
            background: var(--primary-light);
            color: var(--primary);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .card-body {
            padding: 24px;
        }

        /* 차트 */
        .chart-container {
            position: relative;
            height: 320px;
        }

        .chart-legend {
            display: flex;
            gap: 20px;
            margin-bottom: 16px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--gray-600);
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        /* 테이블 */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            padding: 12px 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-500);
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
        }

        .data-table th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 24px;
        }

        .data-table th.sortable:hover {
            background: var(--gray-100);
        }

        .data-table th.sortable::after {
            content: '⇅';
            position: absolute;
            right: 8px;
            color: var(--gray-300);
            font-size: 12px;
        }

        .data-table th.sortable.asc::after {
            content: '↑';
            color: var(--primary);
        }

        .data-table th.sortable.desc::after {
            content: '↓';
            color: var(--primary);
        }

        .data-table td {
            padding: 14px 16px;
            font-size: 14px;
            border-bottom: 1px solid var(--gray-100);
        }

        .data-table tbody tr:hover {
            background: var(--gray-50);
        }

        .data-table .text-right {
            text-align: right;
        }

        .progress-cell {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 4px;
        }

        .progress-value {
            font-size: 12px;
            color: var(--gray-500);
            min-width: 40px;
            text-align: right;
        }

        .change-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .change-badge.positive {
            background: var(--success-light);
            color: var(--success);
        }

        .change-badge.negative {
            background: var(--danger-light);
            color: var(--danger);
        }

        /* 탭 콘텐츠 */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* KPI 섹션 표시 제어 */
        .kpi-section.hidden {
            display: none;
        }

        /* 토스트 */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 14px 24px;
            background: var(--success);
            color: white;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            z-index: 1000;
            display: none;
            font-size: 14px;
        }

        .toast.error { background: var(--danger); }
        .toast.loading { background: var(--primary); }

        /* 반응형 */
        @media (max-width: 1400px) {
            .kpi-section { grid-template-columns: repeat(2, 1fr); }
            .content-grid { grid-template-columns: 1fr; }
            .purpose-kpi-grid { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); }
        }

        @media (max-width: 768px) {
            .tab-cards { overflow-x: auto; flex-wrap: nowrap; padding-bottom: 10px; }
            .tab-card { flex: 0 0 auto; }
            .filter-row { flex-direction: column; align-items: stretch; }
            .btn-search { margin-left: 0; justify-content: center; }
            .kpi-section { grid-template-columns: 1fr; }
        }

        /* 스크롤바 */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--gray-100); }
        ::-webkit-scrollbar-thumb { background: var(--gray-300); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--gray-400); }

        .scroll-table { max-height: 400px; overflow-y: auto; }

        /* AI 분석 섹션 */
        .ai-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; padding: 30px; margin-bottom: 24px; }
        .ai-header { color: white; margin-bottom: 20px; }
        .ai-header h2 { font-size: 24px; margin-bottom: 8px; }
        .ai-header p { opacity: 0.9; font-size: 14px; }
        .ai-input-container { background: white; border-radius: 16px; padding: 20px; }
        .ai-input-wrapper { display: flex; gap: 12px; margin-bottom: 16px; align-items: flex-start; }
        .ai-input { flex: 1; padding: 14px 18px; border: 2px solid var(--gray-200); border-radius: 12px; font-size: 15px; outline: none; resize: vertical; font-family: inherit; min-height: 80px; }
        .ai-input:focus { border-color: var(--primary); }
        .ai-btn { padding: 14px 28px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .ai-btn:hover { background: var(--primary-dark); }
        .ai-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .ai-examples { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
        .ai-example { background: var(--gray-100); padding: 8px 14px; border-radius: 20px; font-size: 13px; color: var(--gray-600); cursor: pointer; transition: all 0.2s; }
        .ai-example:hover { background: var(--primary-light); color: var(--primary); }
        .ai-result { margin-top: 20px; padding: 24px; background: var(--gray-50); border-radius: 12px; display: none; }
        .ai-result.show { display: block; }
        .ai-result-table { width: 100%; }
        .ai-result-table th, .ai-result-table td { padding: 10px; text-align: left; border-bottom: 1px solid var(--gray-200); }
        .ai-insight { margin-top: 16px; padding: 12px 16px; background: var(--warning-light); border-radius: 8px; font-size: 14px; }
        .ai-section-title { font-size: 16px; font-weight: 600; color: var(--gray-800); margin: 20px 0 12px; padding-bottom: 8px; border-bottom: 2px solid var(--primary); }
        .ai-section-title:first-child { margin-top: 0; }
        .ai-pros { background: var(--success-light); padding: 16px; border-radius: 10px; margin-bottom: 16px; }
        .ai-cons { background: var(--danger-light); padding: 16px; border-radius: 10px; margin-bottom: 16px; }
        .ai-improve { background: var(--info-light); padding: 16px; border-radius: 10px; margin-bottom: 16px; }
        .ai-evidence { background: var(--gray-100); padding: 16px; border-radius: 10px; font-size: 13px; }
        .ai-list { margin: 8px 0; padding-left: 20px; }
        .ai-list li { margin-bottom: 8px; line-height: 1.6; }
    </style>
</head>
<body>
    <div id="toast" class="toast"></div>

    <!-- 헤더 -->
    <header class="header">
        <div class="header-left">
            <div class="logo">📊</div>
            <h1 class="header-title">경영지표 대시보드</h1>
        </div>
        <div class="header-right">
            <div class="token-badge">
                <div class="current">
                    <span style="opacity:0.8;">이번달</span>
                    <span style="margin-left:8px;">🎫 <span id="thisMonthTokens">0</span></span>
                    <span style="margin-left:6px;">💵 $<span id="thisMonthUSD">0</span></span>
                    <span style="margin-left:6px;">🇰🇷 ₩<span id="thisMonthKRW">0</span></span>
                </div>
                <div class="prev">
                    <span style="opacity:0.8;">지난달</span>
                    <span style="margin-left:8px;">🎫 <span id="lastMonthTokens">0</span></span>
                    <span style="margin-left:6px;">💵 $<span id="lastMonthUSD">0</span></span>
                    <span style="margin-left:6px;">🇰🇷 ₩<span id="lastMonthKRW">0</span></span>
                </div>
            </div>
            <div class="header-menu-buttons">
                <button class="header-menu-btn ai-btn" onclick="showTab('aiAnalysis')" title="AI 분석">
                    <span>🤖</span>
                    <span>AI 분석</span>
                </button>
                <button class="header-menu-btn info-btn" onclick="showTab('companyInfo')" title="기업 정보">
                    <span>🏛️</span>
                    <span>기업 정보</span>
                </button>
                <button class="header-menu-btn terminal-btn" onclick="showTab('webTerminal')" title="터미널">
                    <span>💻</span>
                    <span>터미널</span>
                </button>
            </div>
            <div class="user-menu" style="display:flex; align-items:center; gap:10px; margin-left:15px;">
                <span id="userInfo" style="color:#fff; font-size:14px;">로딩중...</span>
                <a href="/admin" id="adminBtn" style="display:none; background:rgba(255,255,255,0.2); color:#fff; padding:6px 12px; border-radius:5px; text-decoration:none; font-size:13px;">관리자</a>
                <button type="button" id="passwordChangeBtn" onclick="openPasswordModal()" style="background:rgba(255,255,255,0.2); color:#fff; padding:6px 12px; border-radius:5px; border:none; font-size:13px; cursor:pointer;">🔐 비밀번호 변경</button>
                <a href="/api/auth/logout" style="background:rgba(255,255,255,0.2); color:#fff; padding:6px 12px; border-radius:5px; text-decoration:none; font-size:13px;">로그아웃</a>
            </div>
        </div>
    </header>

    <main class="main-container">
        <!-- 필터 섹션 -->
        <section class="filter-section">
            <div class="filter-row">
                <div class="filter-group">
                    📅
                    <span class="filter-label">조회기간</span>
                    <select id="yearSelect" class="filter-select">
                        <!-- 연도 목록은 API에서 동적으로 로드됨 -->
                    </select>
                    <select id="monthSelect" class="filter-select">
                        <option value="">전체</option>
                        <option value="1">1월</option>
                        <option value="2">2월</option>
                        <option value="3">3월</option>
                        <option value="4">4월</option>
                        <option value="5">5월</option>
                        <option value="6">6월</option>
                        <option value="7">7월</option>
                        <option value="8">8월</option>
                        <option value="9">9월</option>
                        <option value="10">10월</option>
                        <option value="11">11월</option>
                        <option value="12">12월</option>
                    </select>
                </div>

                <div class="filter-divider"></div>

                <label class="filter-checkbox">
                    <input type="checkbox" id="compareCheck">
                    <span>연도비교</span>
                </label>

                <div class="filter-group" id="compareYearGroup" style="display: none;">
                    <div id="compareYearCheckboxes" style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <!-- 비교 연도 체크박스는 API에서 동적으로 로드됨 -->
                    </div>
                </div>

                <div class="filter-group" id="compareMonthGroup" style="display: none;">
                    <select id="compareMonthSelect" class="filter-select" style="min-width: 80px;">
                        <option value="">동일월</option>
                        <option value="1">1월</option>
                        <option value="2">2월</option>
                        <option value="3">3월</option>
                        <option value="4">4월</option>
                        <option value="5">5월</option>
                        <option value="6">6월</option>
                        <option value="7">7월</option>
                        <option value="8">8월</option>
                        <option value="9">9월</option>
                        <option value="10">10월</option>
                        <option value="11">11월</option>
                        <option value="12">12월</option>
                    </select>
                </div>

                <div class="filter-divider"></div>

                <div class="filter-group">
                    🎯
                    <select id="purposeSelect" class="filter-select" style="min-width: 180px;">
                        <option value="전체">검사목적: 전체</option>
                    </select>
                </div>

                <button id="btnSearch" class="btn-search" onclick="loadData()">
                    🔍 조회하기
                </button>
            </div>
        </section>

        <!-- 탭 카드 -->
        <section class="tab-cards">
            <div class="tab-card main-tab active" onclick="showTab('main')">
                <div class="tab-icon">🏠</div>
                <div class="tab-label">메인</div>
            </div>
            <div class="tab-card" onclick="showTab('personal')">
                <div class="tab-icon">👤</div>
                <div class="tab-label">개인별</div>
            </div>
            <div class="tab-card" onclick="showTab('team')">
                <div class="tab-icon">👥</div>
                <div class="tab-label">팀별</div>
            </div>
            <div class="tab-card" onclick="showTab('monthly')">
                <div class="tab-icon">📆</div>
                <div class="tab-label">월별</div>
            </div>
            <div class="tab-card" onclick="showTab('client')">
                <div class="tab-icon">🏢</div>
                <div class="tab-label">업체별</div>
            </div>
            <div class="tab-card" onclick="showTab('region')">
                <div class="tab-icon">📍</div>
                <div class="tab-label">지역별</div>
            </div>
            <div class="tab-card" onclick="showTab('purpose')">
                <div class="tab-icon">🎯</div>
                <div class="tab-label">목적별</div>
            </div>
            <div class="tab-card" onclick="showTab('sampleType')">
                <div class="tab-icon">🧪</div>
                <div class="tab-label">유형</div>
            </div>
            <div class="tab-card" onclick="showTab('defect')">
                <div class="tab-icon">⚠️</div>
                <div class="tab-label">부적합</div>
            </div>
            <div class="tab-card" onclick="showTab('foodItem')">
                <div class="tab-icon">🔬</div>
                <div class="tab-label">검사항목</div>
            </div>
            <div class="tab-card" onclick="showTab('collection')">
                <div class="tab-icon">💵</div>
                <div class="tab-label">수금</div>
            </div>
            <div class="tab-card" onclick="showTab('profitAnalysis')">
                <div class="tab-icon">📊</div>
                <div class="tab-label">손익분석</div>
            </div>
        </section>

        <!-- KPI 카드 -->
        <section class="kpi-section" id="kpiSection">
            <div class="kpi-card sales">
                <div class="kpi-header">
                    <div class="kpi-icon">💰</div>
                    <div class="kpi-trend up" id="salesTrend" style="visibility: hidden;"><span>0%</span></div>
                </div>
                <div class="kpi-label">총 매출</div>
                <div class="kpi-value" id="totalSales">-</div>
                <div class="kpi-compare" id="compareTotalSales" style="display: none;"></div>
                <div class="kpi-overlay" id="salesOverlay"></div>
            </div>

            <div class="kpi-card count">
                <div class="kpi-header">
                    <div class="kpi-icon">📋</div>
                    <div class="kpi-trend up" id="countTrend" style="visibility: hidden;"><span>0%</span></div>
                </div>
                <div class="kpi-label">총 건수</div>
                <div class="kpi-value" id="totalCount">-</div>
                <div class="kpi-compare" id="compareTotalCount" style="display: none;"></div>
                <div class="kpi-overlay" id="countOverlay"></div>
            </div>

            <div class="kpi-card price">
                <div class="kpi-header">
                    <div class="kpi-icon">🏷️</div>
                    <div class="kpi-trend up" id="priceTrend" style="visibility: hidden;"><span>0%</span></div>
                </div>
                <div class="kpi-label">평균 단가</div>
                <div class="kpi-value" id="avgPrice">-</div>
                <div class="kpi-compare" id="compareAvgPrice" style="display: none;"></div>
                <div class="kpi-overlay" id="priceOverlay"></div>
            </div>

            <div class="kpi-card goal">
                <div class="kpi-header">
                    <div class="kpi-icon">🏆</div>
                </div>
                <div class="kpi-label">목표 달성률</div>
                <div class="kpi-value" id="goalRate">-</div>
                <div class="kpi-compare">목표: <span id="goalTarget">70억</span></div>
                <div class="kpi-compare" id="goalCompare" style="display: none;"></div>
                <div class="kpi-overlay" id="goalOverlay"></div>
            </div>
        </section>

        <!-- 메인 탭 콘텐츠 -->
        <div id="main" class="tab-content active">
            <!-- 부서별 현황 카드 -->
            <section class="department-section" style="margin-bottom: 24px;">
                <div class="section-title-bar">
                    <div class="section-title">🏢 부서별 현황</div>
                </div>
                <div class="department-cards" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-top: 16px;">
                    <!-- 본사 카드 -->
                    <div class="dept-card" id="deptCardBonsa">
                        <div class="dept-card-header">
                            <div class="dept-icon" style="background: linear-gradient(135deg, #6366f1, #8b5cf6);">🏛️</div>
                            <div class="dept-name">본사 <span class="dept-ratio" id="deptBonsaRatio">-</span></div>
                        </div>
                        <div class="dept-card-body">
                            <div class="dept-stat">
                                <span class="dept-label">총 매출</span>
                                <span class="dept-value" id="deptBonsaSales">-</span>
                            </div>
                            <div class="dept-stat">
                                <span class="dept-label">건수</span>
                                <span class="dept-value" id="deptBonsaCount">-</span>
                            </div>
                            <div class="dept-stat">
                                <span class="dept-label">평균단가</span>
                                <span class="dept-value" id="deptBonsaAvg">-</span>
                            </div>
                        </div>
                        <div class="dept-overlay" id="deptBonsaOverlay"></div>
                    </div>

                    <!-- 마케팅 카드 -->
                    <div class="dept-card" id="deptCardMarketing">
                        <div class="dept-card-header">
                            <div class="dept-icon" style="background: linear-gradient(135deg, #10b981, #059669);">📢</div>
                            <div class="dept-name">마케팅 <span class="dept-ratio" id="deptMarketingRatio">-</span></div>
                        </div>
                        <div class="dept-card-body">
                            <div class="dept-stat">
                                <span class="dept-label">총 매출</span>
                                <span class="dept-value" id="deptMarketingSales">-</span>
                            </div>
                            <div class="dept-stat">
                                <span class="dept-label">건수</span>
                                <span class="dept-value" id="deptMarketingCount">-</span>
                            </div>
                            <div class="dept-stat">
                                <span class="dept-label">평균단가</span>
                                <span class="dept-value" id="deptMarketingAvg">-</span>
                            </div>
                        </div>
                        <div class="dept-overlay" id="deptMarketingOverlay"></div>
                    </div>

                    <!-- 영업부 카드 -->
                    <div class="dept-card" id="deptCardSales">
                        <div class="dept-card-header">
                            <div class="dept-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">💼</div>
                            <div class="dept-name">영업부 <span class="dept-ratio" id="deptSalesRatio">-</span></div>
                        </div>
                        <div class="dept-card-body">
                            <div class="dept-stat">
                                <span class="dept-label">총 매출</span>
                                <span class="dept-value" id="deptSalesSales">-</span>
                            </div>
                            <div class="dept-stat">
                                <span class="dept-label">건수</span>
                                <span class="dept-value" id="deptSalesCount">-</span>
                            </div>
                            <div class="dept-stat">
                                <span class="dept-label">평균단가</span>
                                <span class="dept-value" id="deptSalesAvg">-</span>
                            </div>
                        </div>
                        <div class="dept-overlay" id="deptSalesOverlay"></div>
                    </div>

                    <!-- 지사 카드 -->
                    <div class="dept-card" id="deptCardBranch">
                        <div class="dept-card-header">
                            <div class="dept-icon" style="background: linear-gradient(135deg, #ec4899, #db2777);">🏬</div>
                            <div class="dept-name">지사 <span class="dept-ratio" id="deptBranchRatio">-</span></div>
                        </div>
                        <div class="dept-card-body">
                            <div class="dept-stat">
                                <span class="dept-label">총 매출</span>
                                <span class="dept-value" id="deptBranchSales">-</span>
                            </div>
                            <div class="dept-stat">
                                <span class="dept-label">건수</span>
                                <span class="dept-value" id="deptBranchCount">-</span>
                            </div>
                            <div class="dept-stat">
                                <span class="dept-label">평균단가</span>
                                <span class="dept-value" id="deptBranchAvg">-</span>
                            </div>
                        </div>
                        <div class="dept-overlay" id="deptBranchOverlay"></div>
                    </div>
                </div>
            </section>

            <section class="purpose-kpi-section" id="purposeKpiSection">
                <div class="section-title-bar">
                    <div class="section-title">🎯 검사 목적별 현황</div>
                    <div class="section-badge" id="purposeCount">0개 목적</div>
                </div>
                <div class="purpose-kpi-grid" id="purposeGrid"></div>
            </section>
        </div>

        <!-- 개인별 탭 -->
        <div id="personal" class="tab-content">
            <!-- 개인별 전용 KPI 카드 -->
            <div class="kpi-section personal-kpi-section">
                <div class="kpi-card sales">
                    <div class="kpi-header">
                        <div class="kpi-icon">👥</div>
                    </div>
                    <div class="kpi-label">총 영업담당자</div>
                    <div class="kpi-value" id="personalTotalManagers">-</div>
                    <div class="kpi-compare">활동 중인 담당자</div>
                </div>
                <div class="kpi-card count">
                    <div class="kpi-header">
                        <div class="kpi-icon">💵</div>
                    </div>
                    <div class="kpi-label">평균 매출</div>
                    <div class="kpi-value" id="personalAvgSales">-</div>
                    <div class="kpi-compare">담당자당 평균</div>
                </div>
                <div class="kpi-card price">
                    <div class="kpi-header">
                        <div class="kpi-icon">🚀</div>
                        <div class="kpi-trend up" id="topGrowthTrend" style="visibility: hidden;">↑ 0%</div>
                    </div>
                    <div class="kpi-label">최고 성장자</div>
                    <div class="kpi-value" id="personalTopGrowth" style="font-size: 20px;">-</div>
                    <div class="kpi-compare" id="personalTopGrowthRate">전년 대비</div>
                </div>
                <div class="kpi-card goal">
                    <div class="kpi-header">
                        <div class="kpi-icon">🚨</div>
                    </div>
                    <div class="kpi-label">긴급 최고 요청자 TOP 5</div>
                    <div class="kpi-value" id="personalUrgentTop" style="font-size: 13px; line-height: 1.5;">-</div>
                </div>
            </div>

            <!-- 효율성 분석 + 월별 추이 -->
            <div class="content-grid" style="margin-bottom: 24px;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">📈 효율성 분석 (건수 vs 매출)</div>
                        <div class="card-badge">4분면 분석</div>
                    </div>
                    <div class="card-body">
                        <div class="quadrant-legend">
                            <span class="q-item q1">🌟 고건수·고매출</span>
                            <span class="q-item q2">💎 저건수·고매출</span>
                            <span class="q-item q3">📈 고건수·저매출</span>
                            <span class="q-item q4">⚠️ 저건수·저매출</span>
                        </div>
                        <div class="chart-container" style="height: 300px;"><canvas id="efficiencyChart"></canvas></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">📆 월별 매출 추이</div>
                        <div class="multi-select-container">
                            <div class="preset-btns">
                                <button class="preset-btn active" onclick="setMonthlyPreset('all')">전체</button>
                                <button class="preset-btn" onclick="setMonthlyPreset('top3')">TOP 3</button>
                            </div>
                            <div class="multi-select-dropdown">
                                <button class="multi-select-btn" onclick="toggleMultiSelect()">
                                    담당자 선택 <span class="selected-count" id="selectedCount">(0)</span> ▼
                                </button>
                                <div class="multi-select-list" id="managerSelectList" style="display: none;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="selected-tags" id="selectedManagerTags"></div>
                    <div class="card-body">
                        <div id="mgrMonthlySummary" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; font-size: 13px;"></div>
                        <div class="chart-legend" id="mgrMonthlyLegend" style="display: none;"></div>
                        <div class="chart-container" style="height: 280px;"><canvas id="managerMonthlyChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- 매출 TOP 15 + 건당 매출 -->
            <div class="content-grid" style="margin-bottom: 24px;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">📊 영업담당별 매출 TOP 15</div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <select id="managerChartPurposeFilter" class="filter-select" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #e2e8f0;" onchange="updateManagerChart()">
                                <option value="전체">전체 검사목적</option>
                            </select>
                            <div class="card-badge" id="managerChartBadge">2025년</div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="managerChartSummary" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; font-size: 13px;"></div>
                        <div class="chart-legend" id="managerLegend" style="display: none;"></div>
                        <div class="chart-container"><canvas id="managerChart"></canvas></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">💰 건당 매출 (평균단가)</div>
                        <div class="chart-controls">
                            <select id="perCasePurposeSelect" class="filter-select" style="min-width: 140px;" onchange="updatePerCaseChart()">
                                <option value="전체">전체 목적</option>
                            </select>
                            <button class="sort-toggle-btn" id="perCaseSortBtn" onclick="togglePerCaseSort()">내림차순 ▼</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="perCaseSummary" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; font-size: 13px;"></div>
                        <div class="chart-legend" id="perCaseLegend" style="display: none;"></div>
                        <div class="chart-container"><canvas id="perCaseChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- 긴급 접수 + 일 방문 거래처 -->
            <div class="content-grid" style="margin-bottom: 24px;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">🚨 긴급 접수 건수</div>
                        <select id="urgentPurposeSelect" class="filter-select" style="min-width: 180px;" onchange="updateUrgentChart()">
                            <option value="전체">검사목적: 전체</option>
                        </select>
                    </div>
                    <div class="card-body">
                        <div id="urgentChartSummary" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px; font-size: 13px;"></div>
                        <div class="chart-legend" id="urgentChartLegend" style="display: flex; gap: 12px; margin-bottom: 8px; font-size: 11px;">
                            <span style="color: #ef4444;">● 상위 (80%↑)</span>
                            <span style="color: #f59e0b;">● 중위 (50%↑)</span>
                            <span style="color: #6366f1;">● 하위</span>
                        </div>
                        <div class="chart-container" style="height: 260px;"><canvas id="urgentChart"></canvas></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">🏢 일 방문 거래처 수</div>
                        <div class="card-badge">접수일 기준</div>
                    </div>
                    <div class="card-body">
                        <div id="dailyClientSummary" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; font-size: 13px;"></div>
                        <div class="chart-legend" id="dailyClientLegend" style="display: none;"></div>
                        <div class="chart-container" style="height: 280px;"><canvas id="dailyClientChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- 긴급 월별 추이 + 긴급 건당 단가 -->
            <div class="content-grid" style="margin-bottom: 24px;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">📈 긴급 월별 추이</div>
                    </div>
                    <div class="card-body">
                        <div id="urgentMonthlySummary" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; font-size: 13px;"></div>
                        <div class="chart-legend" id="urgentMonthlyLegend" style="display: none;"></div>
                        <div class="chart-container" style="height: 280px;"><canvas id="urgentMonthlyChart"></canvas></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">💰 긴급 건당 단가</div>
                    </div>
                    <div class="card-body">
                        <div id="urgentUnitPriceSummary" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; font-size: 13px;"></div>
                        <div class="chart-legend" id="urgentUnitPriceLegend" style="display: none;"></div>
                        <div class="chart-container" style="height: 280px;"><canvas id="urgentUnitPriceChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- 영업담당별 상세 테이블 -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">📋 영업담당별 상세</div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <select id="managerPurposeFilter" class="filter-select" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #e2e8f0;" onchange="updateManagerTable()">
                            <option value="전체">전체 검사목적</option>
                        </select>
                        <div class="card-badge" id="managerTableBadge">0명</div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="scroll-table" style="max-height: 500px;">
                        <table class="data-table sortable-table" id="managerTable">
                            <thead id="managerTableHead"></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

<!-- 담당자 상세 모달 -->
            <div id="managerModal" class="modal-overlay" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 id="modalManagerName">담당자 상세</h3>
                        <button class="modal-close" onclick="closeManagerModal()">✕</button>
                    </div>
                    <div class="modal-body">
                        <div class="modal-grid">
                            <div class="modal-section">
                                <h4>📊 주요 거래 업체 TOP 5</h4>
                                <div id="modalTopClients" class="modal-client-list"></div>
                            </div>
                            <div class="modal-section">
                                <h4>🎯 검사 목적별 비중</h4>
                                <div style="height: 200px;"><canvas id="modalPurposeCanvas"></canvas></div>
                            </div>
                        </div>
                        <div class="modal-section" style="margin-top: 20px;">
                            <h4>📍 담당 지역 분포</h4>
                            <div id="modalRegions" class="modal-region-tags"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 팀별 탭 -->
        <div id="team" class="tab-content">
            <!-- 팀별 전용 KPI 카드 -->
            <div class="kpi-section team-kpi-section">
                <div class="kpi-card sales" style="position: relative;">
                    <div class="kpi-header">
                        <div class="kpi-icon">🏢</div>
                    </div>
                    <div class="kpi-label">총 팀 수</div>
                    <div class="kpi-value" id="teamTotalBranches">-</div>
                    <div class="kpi-compare" id="teamBranchNames" style="font-size: 11px; line-height: 1.4; max-height: 40px; overflow: hidden;">활동 중인 팀</div>
                    <div class="kpi-compare-overlay" id="teamTotalBranchesCompare" style="display: none; position: absolute; top: 8px; right: 8px; background: rgba(99,102,241,0.1); padding: 4px 8px; border-radius: 6px; font-size: 11px; color: #6366f1;"></div>
                </div>
                <div class="kpi-card count" style="position: relative;">
                    <div class="kpi-header">
                        <div class="kpi-icon">💵</div>
                    </div>
                    <div class="kpi-label">팀 평균 매출</div>
                    <div class="kpi-value" id="teamAvgSales">-</div>
                    <div class="kpi-compare" id="teamTierInfo" style="font-size: 11px; line-height: 1.4;">팀당 평균</div>
                    <div class="kpi-compare-overlay" id="teamAvgSalesCompare" style="display: none; position: absolute; top: 8px; right: 8px; background: rgba(99,102,241,0.1); padding: 4px 8px; border-radius: 6px; font-size: 11px; color: #6366f1;"></div>
                </div>
                <div class="kpi-card price" style="position: relative;">
                    <div class="kpi-header">
                        <div class="kpi-icon">🏆</div>
                    </div>
                    <div class="kpi-label">최고 성과 팀</div>
                    <div class="kpi-value" id="teamTopBranch" style="font-size: 20px;">-</div>
                    <div class="kpi-compare" id="teamTopBranchSales">-</div>
                    <div class="kpi-compare" id="teamTopBranchReason" style="font-size: 10px; color: #10b981; margin-top: 2px;"></div>
                    <div class="kpi-compare" id="teamTopBranchPurposes" style="font-size: 10px; color: #64748b; margin-top: 4px; line-height: 1.4; max-height: 36px; overflow: hidden;"></div>
                    <div class="kpi-compare-overlay" id="teamTopBranchCompare" style="display: none; position: absolute; top: 8px; right: 8px; background: rgba(99,102,241,0.1); padding: 4px 8px; border-radius: 6px; font-size: 11px; color: #6366f1;"></div>
                </div>
                <div class="kpi-card goal" style="position: relative;">
                    <div class="kpi-header">
                        <div class="kpi-icon">🚀</div>
                        <div class="kpi-trend up" id="teamTopGrowthTrend" style="visibility: hidden;">↑ 0%</div>
                    </div>
                    <div class="kpi-label">최고 성장 팀</div>
                    <div class="kpi-value" id="teamTopGrowth" style="font-size: 20px;">-</div>
                    <div class="kpi-compare" id="teamTopGrowthRate">전년 대비</div>
                    <div class="kpi-compare" id="teamTopGrowthDetail" style="font-size: 10px; color: #f59e0b; margin-top: 2px;"></div>
                    <div class="kpi-compare" id="teamTopGrowthPurposes" style="font-size: 10px; color: #64748b; margin-top: 4px; line-height: 1.4; max-height: 36px; overflow: hidden;"></div>
                    <div class="kpi-compare-overlay" id="teamTopGrowthCompare" style="display: none; position: absolute; top: 8px; right: 8px; background: rgba(99,102,241,0.1); padding: 4px 8px; border-radius: 6px; font-size: 11px; color: #6366f1;"></div>
                </div>
            </div>

            <!-- 팀별 매출 TOP + 건당 매출 -->
            <div class="content-grid" style="margin-bottom: 24px;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">📊 팀별 매출 현황</div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <select id="branchChartSortBy" class="filter-select" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #e2e8f0;" onchange="updateBranchChart()">
                                <option value="sales">매출액순</option>
                                <option value="efficiency">효율성 (인당매출)</option>
                                <option value="count">건수순</option>
                                <option value="avgPrice">건당단가순</option>
                                <option value="growth">성장률순</option>
                            </select>
                            <select id="branchChartPurposeFilter" class="filter-select" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #e2e8f0;" onchange="updateBranchChart()">
                                <option value="전체">전체 검사목적</option>
                            </select>
                            <div class="card-badge" id="branchChartBadge">2025년</div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-legend" id="branchLegend" style="display: none;"></div>
                        <div class="chart-container"><canvas id="branchChart"></canvas></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">💰 팀별 건당 매출 (평균단가)</div>
                        <div class="chart-controls" style="display: flex; gap: 10px;">
                            <select id="branchPerCaseSortBy" class="filter-select" style="min-width: 140px;" onchange="updateBranchPerCaseChart()">
                                <option value="avgPrice">건당단가순</option>
                                <option value="efficiency">효율성 (인당매출)</option>
                                <option value="sales">매출액순</option>
                                <option value="count">건수순</option>
                            </select>
                            <select id="branchPerCasePurposeSelect" class="filter-select" style="min-width: 140px;" onchange="updateBranchPerCaseChart()">
                                <option value="전체">전체 목적</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-legend" id="branchPerCaseLegend" style="display: none;"></div>
                        <div class="chart-container"><canvas id="branchPerCaseChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- 효율성 분석 + 월별 추이 -->
            <div class="content-grid" style="margin-bottom: 24px;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">📈 팀별 효율성 분석</div>
                        <div class="card-badge">건수 vs 매출</div>
                    </div>
                    <div class="card-body">
                        <div class="quadrant-legend">
                            <span class="q-item q1">🌟 고건수·고매출</span>
                            <span class="q-item q2">💎 저건수·고매출</span>
                            <span class="q-item q3">📈 고건수·저매출</span>
                            <span class="q-item q4">⚠️ 저건수·저매출</span>
                        </div>
                        <div class="chart-container" style="height: 300px;"><canvas id="branchEfficiencyChart"></canvas></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">📆 팀별 월별 추이 <span id="branchMonthlyAvgDisplay" style="font-size: 11px; font-weight: normal; color: #64748b; margin-left: 12px;"></span></div>
                        <div class="chart-controls" style="display: flex; gap: 8px; align-items: center;">
                            <button class="filter-btn" onclick="setBranchMonthlyFilter('all')" id="branchMonthlyAll">전체</button>
                            <button class="filter-btn active" onclick="setBranchMonthlyFilter('top3')" id="branchMonthlyTop3">TOP 3</button>
                            <select id="branchMonthlySelect" class="filter-select" style="min-width: 120px;" onchange="setBranchMonthlyFilter('select')">
                                <option value="">팀 선택</option>
                            </select>
                            <select id="branchMonthlyCompareSelect" class="filter-select" style="min-width: 100px;" onchange="updateBranchMonthlyChart()">
                                <option value="">비교 없음</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-legend" id="branchMonthlyLegend" style="display: none;"></div>
                        <div class="chart-container" style="height: 280px;"><canvas id="branchMonthlyChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- 팀별 상세 테이블 -->
            <div class="card" style="margin-bottom: 24px;">
                <div class="card-header">
                    <div class="card-title">📋 팀별 상세</div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <select id="branchTablePurposeFilter" class="filter-select" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #e2e8f0;" onchange="updateBranchTable()">
                            <option value="전체">전체 검사목적</option>
                        </select>
                        <div class="card-badge" id="branchTableBadge">0개 팀</div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="scroll-table">
                        <table class="data-table" id="branchTable">
                            <thead id="branchTableHead"><tr><th>팀명</th><th class="text-right">매출액</th><th class="text-right">건수</th><th class="text-right">평균단가</th><th class="text-right">담당자수</th><th>비중</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 거래처 중복 분석 -->
            <div class="content-grid" style="margin-bottom: 24px;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">🔄 월별 기존/신규 거래처 현황</div>
                        <div class="chart-controls" style="display: flex; gap: 10px;">
                            <select id="clientChart1PurposeFilter" class="filter-select" style="min-width: 140px;" onchange="applyClientChartFilters(1)">
                                <option value="전체">전체 검사목적</option>
                            </select>
                            <select id="clientChart1BranchFilter" class="filter-select" style="min-width: 120px;" onchange="applyClientChartFilters(1)">
                                <option value="전체">전체 팀</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="clientRetentionSummary" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; font-size: 13px;"></div>
                        <div class="chart-container" style="height: 300px;"><canvas id="clientRetentionChart"></canvas></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">📊 거래처 리텐션율 추이</div>
                        <div class="chart-controls" style="display: flex; gap: 10px;">
                            <select id="clientChart2PurposeFilter" class="filter-select" style="min-width: 140px;" onchange="applyClientChartFilters(2)">
                                <option value="전체">전체 검사목적</option>
                            </select>
                            <select id="clientChart2BranchFilter" class="filter-select" style="min-width: 120px;" onchange="applyClientChartFilters(2)">
                                <option value="전체">전체 팀</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="height: 300px;"><canvas id="retentionRateChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- 팀별 거래처 리텐션 테이블 -->
            <div class="card" style="margin-bottom: 24px;">
                <div class="card-header">
                    <div class="card-title">📋 팀별 거래처 현황</div>
                    <div class="card-badge" id="branchRetentionBadge">0개</div>
                </div>
                <div class="card-body">
                    <!-- 색상 범례 -->
                    <div id="branchRetentionLegend" style="display: flex; gap: 20px; margin-bottom: 12px; font-size: 12px; color: #64748b; flex-wrap: wrap;">
                        <span><strong>거래처 수:</strong></span>
                        <span><span style="color: #10b981;">●</span> 리텐션 50% 이상</span>
                        <span><span style="color: #f59e0b;">●</span> 리텐션 30~50%</span>
                        <span><span style="color: #ef4444;">●</span> 리텐션 30% 미만</span>
                        <span style="margin-left: 20px;"><strong>증감:</strong></span>
                        <span><span style="color: #10b981;">(+)</span> 증가</span>
                        <span><span style="color: #ef4444;">(-)</span> 감소</span>
                    </div>
                    <div class="scroll-table">
                        <table class="data-table" id="branchRetentionTable">
                            <thead>
                                <tr>
                                    <th>팀명</th>
                                    <th class="text-right">누적 거래처</th>
                                    <th class="text-right">1월</th>
                                    <th class="text-right">2월</th>
                                    <th class="text-right">3월</th>
                                    <th class="text-right">4월</th>
                                    <th class="text-right">5월</th>
                                    <th class="text-right">6월</th>
                                    <th class="text-right">7월</th>
                                    <th class="text-right">8월</th>
                                    <th class="text-right">9월</th>
                                    <th class="text-right">10월</th>
                                    <th class="text-right">11월</th>
                                    <th class="text-right">12월</th>
                                </tr>
                            </thead>
                            <tbody id="branchRetentionBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 월별 탭 -->
        <div id="monthly" class="tab-content">
            <!-- 월별 KPI 카드 -->
            <section class="kpi-section monthly-kpi-section">
                <div class="kpi-card sales" style="position: relative; cursor: pointer;" onmouseenter="showMonthlyKpiOverlay('max')" onmouseleave="hideMonthlyKpiOverlay('max')">
                    <div class="kpi-header"><div class="kpi-icon">🏆</div></div>
                    <div class="kpi-label">최고 매출월</div>
                    <div class="kpi-value" id="monthlyMaxMonth">-</div>
                    <div class="kpi-compare" id="monthlyMaxValue">-</div>
                    <div class="monthly-kpi-overlay" id="monthlyMaxOverlay" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(30,41,59,0.95); border-radius: 12px; padding: 16px; z-index: 10; color: #e2e8f0;"></div>
                </div>
                <div class="kpi-card count" style="position: relative; cursor: pointer;" onmouseenter="showMonthlyKpiOverlay('min')" onmouseleave="hideMonthlyKpiOverlay('min')">
                    <div class="kpi-header"><div class="kpi-icon">📉</div></div>
                    <div class="kpi-label">최저 매출월</div>
                    <div class="kpi-value" id="monthlyMinMonth">-</div>
                    <div class="kpi-compare" id="monthlyMinValue">-</div>
                    <div class="monthly-kpi-overlay" id="monthlyMinOverlay" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(30,41,59,0.95); border-radius: 12px; padding: 16px; z-index: 10; color: #e2e8f0;"></div>
                </div>
                <div class="kpi-card price" style="position: relative; cursor: pointer;" onmouseenter="showMonthlyKpiOverlay('avg')" onmouseleave="hideMonthlyKpiOverlay('avg')">
                    <div class="kpi-header"><div class="kpi-icon">📊</div></div>
                    <div class="kpi-label">월평균 매출</div>
                    <div class="kpi-value" id="monthlyAvgSales">-</div>
                    <div class="kpi-compare" id="monthlyAvgCount">-</div>
                    <div class="monthly-kpi-overlay" id="monthlyAvgOverlay" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(30,41,59,0.95); border-radius: 12px; padding: 16px; z-index: 10; color: #e2e8f0;"></div>
                </div>
                <div class="kpi-card goal" style="position: relative; cursor: pointer;" onmouseenter="showMonthlyKpiOverlay('ytd')" onmouseleave="hideMonthlyKpiOverlay('ytd')">
                    <div class="kpi-header"><div class="kpi-icon">📅</div></div>
                    <div class="kpi-label">YTD 누적</div>
                    <div class="kpi-value" id="monthlyYtdSales">-</div>
                    <div class="kpi-compare" id="monthlyYtdCount">-</div>
                    <div class="monthly-kpi-overlay" id="monthlyYtdOverlay" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(30,41,59,0.95); border-radius: 12px; padding: 16px; z-index: 10; color: #e2e8f0;"></div>
                </div>
            </section>

            <!-- 매출/건수 추이 차트 -->
            <div class="content-grid" style="margin-bottom: 24px;">
                <div class="card">
                    <div class="card-header" style="flex-wrap: wrap; gap: 10px;">
                        <div class="card-title">📈 월별 매출 추이</div>
                        <div class="chart-controls" style="display: flex; gap: 8px; align-items: center;">
                            <select id="monthlySalesPurposeFilter" onchange="updateMonthlyChartWithFilter()" style="padding: 6px 10px; border-radius: 6px; border: 1px solid #cbd5e1; font-size: 12px; background: #fff; cursor: pointer;">
                                <option value="전체">전체 목적</option>
                            </select>
                            <select id="monthlySalesManagerFilter" onchange="updateMonthlyChartWithFilter()" style="padding: 6px 10px; border-radius: 6px; border: 1px solid #cbd5e1; font-size: 12px; background: #fff; cursor: pointer;">
                                <option value="전체">전체 담당</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-legend" id="monthlyLegend" style="display: none;"></div>
                        <div class="chart-summary" id="monthlySalesSummary" style="display: flex; gap: 12px; margin-bottom: 12px; font-size: 12px; justify-content: flex-end; flex-wrap: wrap;"></div>
                        <div class="chart-container" style="height: 350px;"><canvas id="monthlyChart"></canvas></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header" style="flex-wrap: wrap; gap: 10px;">
                        <div class="card-title">📊 월별 건수 추이</div>
                        <div class="chart-controls" style="display: flex; gap: 8px; align-items: center;">
                            <select id="monthlyCountPurposeFilter" onchange="updateMonthlyCountChartWithFilter()" style="padding: 6px 10px; border-radius: 6px; border: 1px solid #cbd5e1; font-size: 12px; background: #fff; cursor: pointer;">
                                <option value="전체">전체 목적</option>
                            </select>
                            <select id="monthlyCountManagerFilter" onchange="updateMonthlyCountChartWithFilter()" style="padding: 6px 10px; border-radius: 6px; border: 1px solid #cbd5e1; font-size: 12px; background: #fff; cursor: pointer;">
                                <option value="전체">전체 담당</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-summary" id="monthlyCountSummary" style="display: flex; gap: 12px; margin-bottom: 12px; font-size: 12px; justify-content: flex-end; flex-wrap: wrap;"></div>
                        <div class="chart-container" style="height: 350px;"><canvas id="monthlyCountChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- 월별 성장률 추이 차트 -->
            <div class="card" style="margin-bottom: 24px;" id="growthTrendCard">
                <div class="card-header" style="flex-wrap: wrap; gap: 10px;">
                    <div class="card-title">📈 월별 성장률 추이 (전년 대비)</div>
                    <div class="chart-controls" style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <select id="growthPurposeFilter" onchange="updateGrowthTrendChart()" style="padding: 4px 8px; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 12px;">
                            <option value="전체">전체 목적</option>
                        </select>
                        <select id="growthMetricSelect" onchange="updateGrowthTrendChart()" style="padding: 4px 8px; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 12px;">
                            <option value="sales">매출 성장률</option>
                            <option value="count">건수 성장률</option>
                            <option value="both">매출 + 건수</option>
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-legend" id="growthTrendLegend" style="display: flex; gap: 16px; margin-bottom: 10px; font-size: 12px; flex-wrap: wrap;">
                        <span style="color: #10b981;">● 성장 (0% 초과)</span>
                        <span style="color: #ef4444;">● 역성장 (0% 미만)</span>
                        <span style="color: #f59e0b;">--- 평균 성장률</span>
                    </div>
                    <div class="chart-summary" id="growthTrendSummary" style="display: flex; gap: 12px; margin-bottom: 10px; font-size: 12px; flex-wrap: wrap;"></div>
                    <div class="chart-container" style="height: 280px;"><canvas id="growthTrendChart"></canvas></div>
                </div>
            </div>

            <!-- 목적별 월별 히트맵 -->
            <div class="card" style="margin-bottom: 24px;">
                <div class="card-header" style="flex-wrap: wrap; gap: 10px;">
                    <div class="card-title">🔥 검사목적별 월별 히트맵</div>
                    <div class="chart-controls" style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                        <select id="heatmapYear" onchange="updateHeatmap()" style="padding: 4px 8px; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 12px;">
                            <option value="current">현재 연도</option>
                            <option value="compare">비교 연도</option>
                            <option value="both">양쪽 비교</option>
                        </select>
                        <select id="heatmapMetric" onchange="updateHeatmap()" style="padding: 4px 8px; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 12px;">
                            <option value="sales">매출</option>
                            <option value="count">건수</option>
                            <option value="growth">성장률</option>
                        </select>
                        <select id="heatmapColorScheme" onchange="updateHeatmap()" style="padding: 4px 8px; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 12px;">
                            <option value="blue">파란색 계열</option>
                            <option value="green">녹색 계열</option>
                            <option value="heat">열 지도 (빨강-노랑)</option>
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <div class="heatmap-legend" id="heatmapLegend" style="display: flex; gap: 16px; margin-bottom: 12px; font-size: 11px; color: #64748b; flex-wrap: wrap;"></div>
                    <div class="scroll-table" style="position: relative;">
                        <table class="data-table heatmap-table" id="purposeHeatmapTable">
                            <thead><tr id="heatmapHeader"><th>검사목적</th></tr></thead>
                            <tbody id="heatmapBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 월별 상세 테이블 -->
            <div class="card">
                <div class="card-header" style="flex-wrap: wrap; gap: 10px;">
                    <div class="card-title">📋 월별 상세</div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div class="card-badge" id="monthlyTableBadge">12개월</div>
                        <select id="monthlyDetailSort" onchange="updateMonthlyDetailTable()" style="padding: 4px 8px; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 12px;">
                            <option value="month">월순</option>
                            <option value="sales_desc">매출 높은순</option>
                            <option value="sales_asc">매출 낮은순</option>
                            <option value="growth_desc">성장률 높은순</option>
                            <option value="growth_asc">성장률 낮은순</option>
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <!-- 범례 -->
                    <div id="monthlyTableLegend" style="display: none; margin-bottom: 16px; font-size: 11px; color: #64748b; flex-wrap: wrap; gap: 16px; padding: 10px; background: #f8fafc; border-radius: 8px;">
                        <span><strong>전년 대비:</strong></span>
                        <span><span style="color: #10b981;">▲</span> 증가</span>
                        <span><span style="color: #ef4444;">▼</span> 감소</span>
                        <span style="margin-left: 10px;"><strong>성장률:</strong></span>
                        <span><span style="background: rgba(16,185,129,0.2); padding: 2px 6px; border-radius: 4px; color: #10b981;">+10%↑</span> 고성장</span>
                        <span><span style="background: rgba(239,68,68,0.2); padding: 2px 6px; border-radius: 4px; color: #ef4444;">-10%↓</span> 역성장</span>
                    </div>
                    <!-- 요약 통계 -->
                    <div id="monthlyDetailSummary" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px;"></div>
                    <div class="scroll-table">
                        <table class="data-table" id="monthlyDetailTable">
                            <thead><tr>
                                <th>월</th>
                                <th class="text-right">매출액</th>
                                <th class="text-right monthlyYoyCol" style="display: none;">전년매출</th>
                                <th class="text-right monthlyYoyCol" style="display: none;">증감</th>
                                <th class="text-right">건수</th>
                                <th class="text-right monthlyYoyCol" style="display: none;">전년건수</th>
                                <th class="text-right monthlyYoyCol" style="display: none;">증감</th>
                                <th class="text-right">평균단가</th>
                                <th class="text-right">비중</th>
                                <th>주요 검사목적</th>
                                <th>상세</th>
                            </tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 월 상세 모달 -->
        <div id="monthModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <span class="modal-title" id="monthModalTitle">월 상세</span>
                    <span class="modal-close" onclick="closeMonthModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="modal-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h4 style="margin-bottom: 10px;">검사목적별 구성</h4>
                            <div style="height: 250px;"><canvas id="monthPurposeChart"></canvas></div>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 10px;">담당자별 구성</h4>
                            <div style="height: 250px;"><canvas id="monthManagerChart"></canvas></div>
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <h4 style="margin-bottom: 10px;">주요 지표</h4>
                        <div id="monthDetailStats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 업체별 탭 -->
        <div id="client" class="tab-content">
            <!-- 업체 검색 및 필터 -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-body" style="padding: 16px;">
                    <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center;">
                        <div style="flex: 1; min-width: 200px;">
                            <input type="text" id="clientSearchInput" placeholder="🔍 업체명 검색..."
                                style="width: 100%; padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; transition: border-color 0.2s;"
                                oninput="filterClients()" onfocus="this.style.borderColor='#6366f1'" onblur="this.style.borderColor='#e2e8f0'">
                        </div>
                        <select id="clientStatusFilter" onchange="filterClients()" style="padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 13px; min-width: 120px;">
                            <option value="all">전체 업체</option>
                            <option value="new">🆕 신규 업체</option>
                            <option value="retained">🔄 유지 업체</option>
                            <option value="vip">⭐ VIP 업체</option>
                            <option value="growth">📈 성장 업체</option>
                            <option value="decline">📉 감소 업체</option>
                        </select>
                        <select id="clientManagerFilter" onchange="filterClients()" style="padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 13px; min-width: 120px;">
                            <option value="all">전체 담당자</option>
                        </select>
                        <select id="clientPurposeFilter" onchange="filterClients()" style="padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 13px; min-width: 140px;">
                            <option value="all">전체 검사목적</option>
                        </select>
                        <button onclick="resetClientFilters()" style="padding: 10px 16px; background: #f1f5f9; border: none; border-radius: 10px; cursor: pointer; font-size: 13px;">
                            ↺ 초기화
                        </button>
                    </div>
                    <div id="clientFilterSummary" style="margin-top: 12px; padding: 10px; background: #f8fafc; border-radius: 8px; font-size: 13px; color: #64748b; display: none;">
                        <span id="clientFilterResultText">검색 결과: 0개 업체</span>
                    </div>
                </div>
            </div>

            <!-- 업체 현황 KPI 카드 -->
            <section class="kpi-section client-kpi-section" style="grid-template-columns: repeat(5, 1fr);">
                <div class="kpi-card sales client-kpi-hover" id="kpiTotalCard" style="border-top: 4px solid var(--primary); cursor: pointer; position: relative;">
                    <div class="kpi-header"><div class="kpi-icon">🏢</div></div>
                    <div class="kpi-label">총 거래업체</div>
                    <div class="kpi-value" id="clientTotalCount">-</div>
                    <div class="kpi-compare" id="clientTotalCompare">전년: -</div>
                </div>
                <div class="kpi-card count client-kpi-hover" id="kpiNewCard" style="border-top: 4px solid var(--success); cursor: pointer; position: relative;">
                    <div class="kpi-header"><div class="kpi-icon">🆕</div></div>
                    <div class="kpi-label">신규 업체</div>
                    <div class="kpi-value" id="clientNewCount" style="color: var(--success);">-</div>
                    <div class="kpi-compare" id="clientNewCompare">올해 첫 거래</div>
                </div>
                <div class="kpi-card price client-kpi-hover" id="kpiRetainedCard" style="border-top: 4px solid var(--primary); cursor: pointer; position: relative;">
                    <div class="kpi-header"><div class="kpi-icon">🔄</div></div>
                    <div class="kpi-label">유지 업체</div>
                    <div class="kpi-value" id="clientRetainedCount">-</div>
                    <div class="kpi-compare" id="clientRetainedCompare">전년부터 지속</div>
                </div>
                <div class="kpi-card goal client-kpi-hover" id="kpiChurnedCard" style="border-top: 4px solid var(--danger); cursor: pointer; position: relative;">
                    <div class="kpi-header"><div class="kpi-icon">📤</div></div>
                    <div class="kpi-label">이탈 업체</div>
                    <div class="kpi-value" id="clientChurnedCount" style="color: var(--danger);">-</div>
                    <div class="kpi-compare" id="clientChurnedCompare">올해 거래 없음</div>
                </div>
                <div class="kpi-card client-kpi-hover" id="kpiVipCard" style="border-top: 4px solid var(--warning); cursor: pointer; position: relative;">
                    <div class="kpi-header"><div class="kpi-icon">⭐</div></div>
                    <div class="kpi-label">VIP 업체</div>
                    <div class="kpi-value" id="clientVipCount" style="color: var(--warning);">-</div>
                    <div class="kpi-compare" id="clientVipNames" style="font-size: 11px; max-height: 36px; overflow: hidden;">매출 1억 이상</div>
                </div>
            </section>

            <!-- 담당자 영업력 KPI -->
            <section class="manager-kpi-section" style="margin-bottom: 24px;">
                <div class="section-title-bar" style="margin-bottom: 12px;">
                    <div class="section-title">🎯 담당자 영업력 (업체 확보/성장)</div>
                </div>
                <section class="kpi-section" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="kpi-card manager-kpi-card" id="kpiClientKing" style="border-top: 4px solid #6366f1; cursor: pointer; position: relative;">
                        <div class="kpi-header"><div class="kpi-icon" style="background: #eef2ff; color: #6366f1;">👑</div></div>
                        <div class="kpi-label">업체 보유왕</div>
                        <div class="kpi-value" style="font-size: 20px; color: #1e293b;" id="kpiClientKingName">-</div>
                        <div class="kpi-compare" id="kpiClientKingValue">-</div>
                        <div class="manager-kpi-overlay" id="kpiClientKingOverlay" style="display: none;"></div>
                    </div>
                    <div class="kpi-card manager-kpi-card" id="kpiNewKing" style="border-top: 4px solid #10b981; cursor: pointer; position: relative;">
                        <div class="kpi-header"><div class="kpi-icon" style="background: #d1fae5; color: #10b981;">🌱</div></div>
                        <div class="kpi-label">신규 확보왕</div>
                        <div class="kpi-value" style="font-size: 20px; color: #1e293b;" id="kpiNewKingName">-</div>
                        <div class="kpi-compare" id="kpiNewKingValue">-</div>
                        <div class="manager-kpi-overlay" id="kpiNewKingOverlay" style="display: none;"></div>
                    </div>
                    <div class="kpi-card manager-kpi-card" id="kpiGrowthKing" style="border-top: 4px solid #8b5cf6; cursor: pointer; position: relative;">
                        <div class="kpi-header"><div class="kpi-icon" style="background: #ede9fe; color: #8b5cf6;">💰</div></div>
                        <div class="kpi-label">성장 기여왕</div>
                        <div class="kpi-value" style="font-size: 20px; color: #1e293b;" id="kpiGrowthKingName">-</div>
                        <div class="kpi-compare" id="kpiGrowthKingValue">-</div>
                        <div class="manager-kpi-overlay" id="kpiGrowthKingOverlay" style="display: none;"></div>
                    </div>
                    <div class="kpi-card manager-kpi-card" id="kpiVipKing" style="border-top: 4px solid #f59e0b; cursor: pointer; position: relative;">
                        <div class="kpi-header"><div class="kpi-icon" style="background: #fef3c7; color: #f59e0b;">💎</div></div>
                        <div class="kpi-label">VIP 확보왕</div>
                        <div class="kpi-value" style="font-size: 20px; color: #1e293b;" id="kpiVipKingName">-</div>
                        <div class="kpi-compare" id="kpiVipKingValue">-</div>
                        <div class="manager-kpi-overlay" id="kpiVipKingOverlay" style="display: none;"></div>
                    </div>
                </section>
            </section>

            <!-- 담당자 관리력 KPI -->
            <section class="manager-kpi-section" style="margin-bottom: 24px;">
                <div class="section-title-bar" style="margin-bottom: 12px;">
                    <div class="section-title">🤝 담당자 관리력 (유지/활성화)</div>
                </div>
                <section class="kpi-section" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="kpi-card manager-kpi-card" id="kpiRetentionKing" style="border-top: 4px solid #06b6d4; cursor: pointer; position: relative;">
                        <div class="kpi-header"><div class="kpi-icon" style="background: #cffafe; color: #06b6d4;">🔄</div></div>
                        <div class="kpi-label">유지율 TOP</div>
                        <div class="kpi-value" style="font-size: 20px; color: #1e293b;" id="kpiRetentionKingName">-</div>
                        <div class="kpi-compare" id="kpiRetentionKingValue">-</div>
                        <div class="manager-kpi-overlay" id="kpiRetentionKingOverlay" style="display: none;"></div>
                    </div>
                    <div class="kpi-card manager-kpi-card" id="kpiSteadyKing" style="border-top: 4px solid #14b8a6; cursor: pointer; position: relative;">
                        <div class="kpi-header"><div class="kpi-icon" style="background: #ccfbf1; color: #14b8a6;">📅</div></div>
                        <div class="kpi-label">꾸준 거래왕</div>
                        <div class="kpi-value" style="font-size: 20px; color: #1e293b;" id="kpiSteadyKingName">-</div>
                        <div class="kpi-compare" id="kpiSteadyKingValue">-</div>
                        <div class="manager-kpi-overlay" id="kpiSteadyKingOverlay" style="display: none;"></div>
                    </div>
                    <div class="kpi-card manager-kpi-card" id="kpiActiveKing" style="border-top: 4px solid #ec4899; cursor: pointer; position: relative;">
                        <div class="kpi-header"><div class="kpi-icon" style="background: #fce7f3; color: #ec4899;">🔥</div></div>
                        <div class="kpi-label">활성 관리왕</div>
                        <div class="kpi-value" style="font-size: 20px; color: #1e293b;" id="kpiActiveKingName">-</div>
                        <div class="kpi-compare" id="kpiActiveKingValue">-</div>
                        <div class="manager-kpi-overlay" id="kpiActiveKingOverlay" style="display: none;"></div>
                    </div>
                    <div class="kpi-card manager-kpi-card" id="kpiChurnWarning" style="border-top: 4px solid #ef4444; cursor: pointer; position: relative;">
                        <div class="kpi-header"><div class="kpi-icon" style="background: #fee2e2; color: #ef4444;">⚠️</div></div>
                        <div class="kpi-label">이탈 주의</div>
                        <div class="kpi-value" style="font-size: 20px; color: #1e293b;" id="kpiChurnWarningName">-</div>
                        <div class="kpi-compare" id="kpiChurnWarningValue">-</div>
                        <div class="manager-kpi-overlay" id="kpiChurnWarningOverlay" style="display: none;"></div>
                    </div>
                </section>
            </section>

            <!-- 매출/건수 TOP 10 차트 -->
            <div class="content-grid" style="margin-bottom: 24px;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">🏆 매출 TOP 10</div>
                        <div class="card-badge" id="clientSalesChartBadge">-</div>
                    </div>
                    <div class="card-body">
                        <div id="clientSalesChartSummary" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; font-size: 13px;"></div>
                        <div class="chart-container" style="height: 350px;"><canvas id="clientSalesChart"></canvas></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">📊 건수 TOP 10</div>
                        <div class="card-badge" id="clientCountChartBadge">-</div>
                    </div>
                    <div class="card-body">
                        <div id="clientCountChartSummary" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; font-size: 13px;"></div>
                        <div class="chart-container" style="height: 350px;"><canvas id="clientCountChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- 월별 업체수 / 효율 분류 추세 차트 -->
            <div class="content-grid" style="margin-bottom: 24px;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">📈 월별 거래 업체 수</div>
                        <div class="card-badge" id="clientMonthlyCountBadge">-</div>
                    </div>
                    <div class="card-body">
                        <div id="clientMonthlyCountSummary" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; font-size: 13px;"></div>
                        <div class="chart-container" style="height: 300px;"><canvas id="clientMonthlyCountChart"></canvas></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">📊 효율 분류별 월별 추세</div>
                        <div class="card-badge" id="efficiencyTrendBadge">업체 분류</div>
                    </div>
                    <div class="card-body">
                        <div id="clientEfficiencyTrendSummary" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; font-size: 13px;"></div>
                        <div class="chart-container" style="height: 300px;"><canvas id="clientEfficiencyTrendChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- 효율별 업체 상세 테이블 -->
            <div class="content-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 24px;">
                <div class="card" style="border-top: 3px solid #ef4444;">
                    <div class="card-header">
                        <div class="card-title">🔻 저효율 업체</div>
                        <div class="card-badge" id="lowEfficiencyBadge" style="background: #fee2e2; color: #ef4444;">0개</div>
                    </div>
                    <div class="card-body" style="font-size: 12px; color: #64748b; margin-bottom: 8px;">
                        건수 많음 + 단가 낮음 (평균의 70% 미만)
                    </div>
                    <div class="scroll-table" style="max-height: 250px;">
                        <table class="data-table" id="lowEfficiencyTable">
                            <thead><tr><th>업체명</th><th class="text-right">건수</th><th class="text-right">단가</th><th class="text-right">매출</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="card" style="border-top: 3px solid #f59e0b;">
                    <div class="card-header">
                        <div class="card-title">➖ 중효율 업체</div>
                        <div class="card-badge" id="midEfficiencyBadge" style="background: #fef3c7; color: #f59e0b;">0개</div>
                    </div>
                    <div class="card-body" style="font-size: 12px; color: #64748b; margin-bottom: 8px;">
                        건수/단가 평균 수준 (70%~130%)
                    </div>
                    <div class="scroll-table" style="max-height: 250px;">
                        <table class="data-table" id="midEfficiencyTable">
                            <thead><tr><th>업체명</th><th class="text-right">건수</th><th class="text-right">단가</th><th class="text-right">매출</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="card" style="border-top: 3px solid #10b981;">
                    <div class="card-header">
                        <div class="card-title">🔺 고효율 업체</div>
                        <div class="card-badge" id="highEfficiencyBadge" style="background: #d1fae5; color: #10b981;">0개</div>
                    </div>
                    <div class="card-body" style="font-size: 12px; color: #64748b; margin-bottom: 8px;">
                        건수 적음 + 단가 높음 (평균의 130% 초과)
                    </div>
                    <div class="scroll-table" style="max-height: 250px;">
                        <table class="data-table" id="highEfficiencyTable">
                            <thead><tr><th>업체명</th><th class="text-right">건수</th><th class="text-right">단가</th><th class="text-right">매출</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 유지 거래처 / 신규&이탈 테이블 -->
            <div class="content-grid" style="margin-bottom: 24px;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">🔄 유지 거래처 (전년 대비 성장)</div>
                        <div class="card-badge" id="retainedTableBadge">0개</div>
                    </div>
                    <div class="card-body">
                        <div class="scroll-table" style="max-height: 300px;">
                            <table class="data-table" id="retainedClientTable">
                                <thead><tr><th style="min-width:150px;">업체명</th><th style="white-space:nowrap;">담당자</th><th class="text-right" style="white-space:nowrap;">올해</th><th class="text-right" style="white-space:nowrap;">전년</th><th class="text-right" style="white-space:nowrap;">증감</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title" id="newChurnTableTitle">🆕 신규 업체</div>
                        <div style="display: flex; gap: 8px;">
                            <button class="filter-btn active" id="btnNewClients" onclick="setClientTableMode('new')">신규 <span id="newClientsBtnCount">0</span>개</button>
                            <button class="filter-btn" id="btnChurnedClients" onclick="setClientTableMode('churned')">이탈 <span id="churnedClientsBtnCount">0</span>개</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="scroll-table" style="max-height: 300px;">
                            <table class="data-table" id="newChurnClientTable">
                                <thead id="newChurnTableHead"><tr><th>업체명</th><th>담당자</th><th class="text-right">매출액</th><th class="text-right">건수</th><th>주요 검사</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 검사목적별 / 담당자별 거래처 현황 -->
            <div class="content-grid" style="margin-bottom: 24px;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">📋 검사목적별 거래처 현황</div>
                    </div>
                    <div class="card-body">
                        <div class="scroll-table" style="max-height: 300px;">
                            <table class="data-table" id="clientByPurposeTable">
                                <thead><tr><th>검사목적</th><th class="text-right">업체수</th><th class="text-right">총매출</th><th class="text-right">평균매출</th><th>주요업체</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">👤 담당자별 거래처 현황</div>
                    </div>
                    <div class="card-body">
                        <div class="scroll-table" style="max-height: 300px;">
                            <table class="data-table" id="clientByManagerTable">
                                <thead><tr><th>담당자</th><th class="text-right">업체수</th><th class="text-right">신규</th><th class="text-right">유지</th><th class="text-right">이탈</th><th class="text-right">총매출</th><th class="text-right">성장률</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 검색된 업체 목록 테이블 -->
            <div class="card" id="clientSearchResultCard" style="display: none; margin-bottom: 24px;">
                <div class="card-header">
                    <div class="card-title">🔍 검색 결과</div>
                    <div class="card-badge" id="clientSearchResultBadge">0개</div>
                </div>
                <div class="card-body">
                    <div class="scroll-table" style="max-height: 400px;">
                        <table class="data-table" id="clientSearchResultTable">
                            <thead><tr>
                                <th>업체명</th>
                                <th>담당자</th>
                                <th>상태</th>
                                <th class="text-right">올해 매출</th>
                                <th class="text-right">전년 매출</th>
                                <th class="text-right">증감</th>
                                <th class="text-right">건수</th>
                                <th>주요 검사목적</th>
                                <th>상세</th>
                            </tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 업체 상세 모달 -->
        <div id="clientModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 950px;">
                <div class="modal-header">
                    <span class="modal-title" id="clientModalTitle">🏢 업체 상세</span>
                    <span class="modal-close" onclick="closeClientModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <!-- 업체 기본 정보 -->
                    <div id="clientModalInfo" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;"></div>

                    <!-- 전년 비교 -->
                    <div id="clientModalCompare" style="display: none; margin-bottom: 20px;"></div>

                    <!-- 월별 추이 차트 -->
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 12px; font-size: 14px; color: #475569;">📈 월별 거래 추이</h4>
                        <div style="height: 200px;"><canvas id="clientMonthlyChart"></canvas></div>
                    </div>

                    <!-- 검사목적별 구성 -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h4 style="margin-bottom: 12px; font-size: 14px; color: #475569;">🔬 검사목적별 매출</h4>
                            <div style="height: 180px;"><canvas id="clientPurposeChart"></canvas></div>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 12px; font-size: 14px; color: #475569;">📊 검사목적별 상세</h4>
                            <div id="clientPurposeTable" style="max-height: 180px; overflow-y: auto;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 지역별 탭 -->
        <div id="region" class="tab-content">
            <!-- 지역 KPI 카드 -->
            <section class="kpi-section region-kpi-section" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 24px;">
                <div class="kpi-card region-kpi" id="kpiMainRegion" style="border-top: 4px solid var(--primary); position: relative; cursor: pointer;">
                    <div class="kpi-header"><div class="kpi-icon">🏆</div></div>
                    <div class="kpi-label">주력 지역</div>
                    <div class="kpi-value" id="mainRegionName" style="font-size: 20px;">-</div>
                    <div class="kpi-compare" id="mainRegionValue">-</div>
                    <div class="region-kpi-overlay" id="mainRegionOverlay" style="display: none;"></div>
                </div>
                <div class="kpi-card region-kpi" id="kpiGrowthRegion" style="border-top: 4px solid var(--success); position: relative; cursor: pointer;">
                    <div class="kpi-header"><div class="kpi-icon">📈</div></div>
                    <div class="kpi-label">성장 지역</div>
                    <div class="kpi-value" id="growthRegionName" style="font-size: 20px; color: var(--success);">-</div>
                    <div class="kpi-compare" id="growthRegionValue">-</div>
                    <div class="region-kpi-overlay" id="growthRegionOverlay" style="display: none;"></div>
                </div>
                <div class="kpi-card region-kpi" id="kpiNewRegion" style="border-top: 4px solid var(--info); position: relative; cursor: pointer;">
                    <div class="kpi-header"><div class="kpi-icon">🆕</div></div>
                    <div class="kpi-label">신규 진출</div>
                    <div class="kpi-value" id="newRegionName" style="font-size: 20px; color: var(--info);">-</div>
                    <div class="kpi-compare" id="newRegionValue">-</div>
                    <div class="region-kpi-overlay" id="newRegionOverlay" style="display: none;"></div>
                </div>
                <div class="kpi-card region-kpi" id="kpiWeakRegion" style="border-top: 4px solid var(--warning); position: relative; cursor: pointer;">
                    <div class="kpi-header"><div class="kpi-icon">🎯</div></div>
                    <div class="kpi-label">공략 필요</div>
                    <div class="kpi-value" id="weakRegionName" style="font-size: 20px; color: var(--warning);">-</div>
                    <div class="kpi-compare" id="weakRegionValue">-</div>
                    <div class="region-kpi-overlay" id="weakRegionOverlay" style="display: none;"></div>
                </div>
            </section>

            <!-- 드릴다운 지도 + 상세 패널 -->
            <div class="content-grid" style="margin-bottom: 24px;">
                <div class="card" style="min-height: 500px;">
                    <div class="card-header">
                        <div class="card-title" id="mapTitle">🗺️ 전국 시도별 업체 현황</div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <button id="mapBackBtn" onclick="mapDrillUp()" style="display: none; padding: 4px 12px; border-radius: 6px; border: 1px solid #e2e8f0; background: #f8fafc; cursor: pointer; font-size: 12px;">← 뒤로</button>
                            <span id="mapBreadcrumb" style="font-size: 12px; color: #64748b;">전국</span>
                        </div>
                    </div>
                    <div class="card-body" style="padding: 16px;">
                        <div id="mapSummary" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; font-size: 13px;"></div>
                        <!-- SVG 지도 컨테이너 -->
                        <div id="svgMapContainer" style="width: 100%; height: 420px; position: relative;">
                            <svg id="koreaMap" style="width: 100%; height: 100%;"></svg>
                            <div id="mapTooltip" style="position: absolute; display: none; background: rgba(30,41,59,0.95); color: #e2e8f0; padding: 12px 16px; border-radius: 8px; font-size: 12px; pointer-events: none; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.3); max-width: 250px;"></div>
                        </div>
                        <!-- 시/도 지도 범례 (매출 기준) -->
                        <div id="mapLegendSido" style="display: flex; gap: 12px; margin-top: 12px; font-size: 12px; flex-wrap: wrap; justify-content: center;">
                            <span style="font-weight: 600; color: #64748b;">매출:</span>
                            <div style="display: flex; align-items: center; gap: 4px;"><div style="width: 16px; height: 16px; background: #dc2626; border-radius: 3px;"></div><span>10억+</span></div>
                            <div style="display: flex; align-items: center; gap: 4px;"><div style="width: 16px; height: 16px; background: #f97316; border-radius: 3px;"></div><span>5~10억</span></div>
                            <div style="display: flex; align-items: center; gap: 4px;"><div style="width: 16px; height: 16px; background: #eab308; border-radius: 3px;"></div><span>1~5억</span></div>
                            <div style="display: flex; align-items: center; gap: 4px;"><div style="width: 16px; height: 16px; background: #22c55e; border-radius: 3px;"></div><span>1억 미만</span></div>
                        </div>
                        <!-- 시군구 지도 범례 (거래처 수 기준) -->
                        <div id="mapLegendSigungu" style="display: none; gap: 12px; margin-top: 12px; font-size: 12px; flex-wrap: wrap; justify-content: center;">
                            <span style="font-weight: 600; color: #64748b;">거래처:</span>
                            <div style="display: flex; align-items: center; gap: 4px;"><div style="width: 16px; height: 16px; background: #dc2626; border-radius: 3px;"></div><span>50개+</span></div>
                            <div style="display: flex; align-items: center; gap: 4px;"><div style="width: 16px; height: 16px; background: #f97316; border-radius: 3px;"></div><span>20~49개</span></div>
                            <div style="display: flex; align-items: center; gap: 4px;"><div style="width: 16px; height: 16px; background: #eab308; border-radius: 3px;"></div><span>10~19개</span></div>
                            <div style="display: flex; align-items: center; gap: 4px;"><div style="width: 16px; height: 16px; background: #22c55e; border-radius: 3px;"></div><span>5~9개</span></div>
                            <div style="display: flex; align-items: center; gap: 4px;"><div style="width: 16px; height: 16px; background: #06b6d4; border-radius: 3px;"></div><span>1~4개</span></div>
                        </div>
                    </div>
                </div>
                <div class="card" id="regionDetailCard" style="min-height: 500px;">
                    <div class="card-header">
                        <div class="card-title" id="regionDetailTitle">📍 지역 상세 정보</div>
                        <div class="card-badge" id="regionDetailBadge">지역 선택</div>
                    </div>
                    <div class="card-body" id="regionDetailBody" style="padding: 16px; overflow-y: auto; max-height: 440px;">
                        <div style="text-align: center; color: #94a3b8; padding: 60px 20px;">
                            <div style="font-size: 48px; margin-bottom: 16px;">🗺️</div>
                            <div style="font-size: 14px;">좌측 지도에서 지역을 클릭하면<br>상세 정보가 표시됩니다.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 시장 점유율 비교 테이블 -->
            <div class="card" style="margin-bottom: 24px;">
                <div class="card-header">
                    <div class="card-title">🏭 지역별 시장 점유율 (식품제조가공업)</div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <button id="loadFoodStatsBtn" class="btn btn-primary" onclick="loadFoodManufacturingStats()" style="padding: 6px 12px; font-size: 12px; border-radius: 6px; background: var(--primary); color: white; border: none; cursor: pointer;">
                            📊 데이터 불러오기
                        </button>
                        <div class="card-badge" id="foodStatsBadge">미로드</div>
                    </div>
                </div>
                <div class="card-body" style="padding: 0;">
                    <div id="foodStatsLoading" style="display: none; text-align: center; padding: 40px; color: #64748b;">
                        <div style="font-size: 24px; margin-bottom: 8px;">⏳</div>
                        <div>식품제조가공업소 데이터를 불러오는 중...</div>
                        <div style="font-size: 11px; margin-top: 4px;">(최초 로드 시 1~2분 소요)</div>
                    </div>
                    <div id="foodStatsEmpty" style="text-align: center; padding: 40px; color: #94a3b8;">
                        <div style="font-size: 32px; margin-bottom: 8px;">🏭</div>
                        <div style="font-size: 13px;">위 버튼을 클릭하여 전국 식품제조가공업소 데이터를 불러오세요.</div>
                        <div style="font-size: 11px; margin-top: 4px; color: #cbd5e1;">출처: 식품안전나라 Open API</div>
                    </div>
                    <table id="foodStatsTable" class="data-table" style="display: none; width: 100%;">
                        <thead>
                            <tr style="background: #f8fafc;">
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">지역</th>
                                <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e2e8f0;">전체 업소</th>
                                <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e2e8f0;">우리 거래처</th>
                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e2e8f0;">점유율</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0; width: 200px;">비율</th>
                            </tr>
                        </thead>
                        <tbody id="foodStatsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 축산물 가공업허가정보 시장 점유율 -->
            <div class="card" style="margin-bottom: 24px;">
                <div class="card-header">
                    <div class="card-title">🥩 지역별 시장 점유율 (축산물가공업)</div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <button id="loadLivestockStatsBtn" class="btn btn-primary" onclick="loadLivestockStats()" style="padding: 6px 12px; font-size: 12px; border-radius: 6px; background: #dc2626; color: white; border: none; cursor: pointer;">
                            📊 데이터 불러오기
                        </button>
                        <div class="card-badge" id="livestockStatsBadge">미로드</div>
                    </div>
                </div>
                <div class="card-body" style="padding: 0;">
                    <div id="livestockStatsLoading" style="display: none; text-align: center; padding: 40px; color: #64748b;">
                        <div style="font-size: 24px; margin-bottom: 8px;">⏳</div>
                        <div>축산물가공업소 데이터를 불러오는 중...</div>
                        <div style="font-size: 11px; margin-top: 4px;">(최초 로드 시 1~2분 소요)</div>
                    </div>
                    <div id="livestockStatsEmpty" style="text-align: center; padding: 40px; color: #94a3b8;">
                        <div style="font-size: 32px; margin-bottom: 8px;">🥩</div>
                        <div style="font-size: 13px;">위 버튼을 클릭하여 전국 축산물가공업소 데이터를 불러오세요.</div>
                        <div style="font-size: 11px; margin-top: 4px; color: #cbd5e1;">출처: 식품안전나라 Open API</div>
                    </div>
                    <table id="livestockStatsTable" class="data-table" style="display: none; width: 100%;">
                        <thead>
                            <tr style="background: #fef2f2;">
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #fecaca;">지역</th>
                                <th style="padding: 12px; text-align: right; border-bottom: 2px solid #fecaca;">전체 업소</th>
                                <th style="padding: 12px; text-align: right; border-bottom: 2px solid #fecaca;">우리 거래처</th>
                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #fecaca;">점유율</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #fecaca; width: 200px;">비율</th>
                            </tr>
                        </thead>
                        <tbody id="livestockStatsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 매출 차트 + 성장률 차트 -->
            <div class="content-grid" style="margin-bottom: 24px;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">📊 지역별 매출 순위</div>
                        <div class="card-badge" id="regionSalesChartBadge">-</div>
                    </div>
                    <div class="card-body">
                        <div id="regionSalesChartSummary" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; font-size: 13px;"></div>
                        <div class="chart-container" style="height: 350px;"><canvas id="regionSalesChart"></canvas></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">📈 지역별 성장률</div>
                        <div class="card-badge" id="regionGrowthChartBadge">전년 대비</div>
                    </div>
                    <div class="card-body">
                        <div id="regionGrowthChartSummary" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; font-size: 13px;"></div>
                        <div class="chart-container" style="height: 350px;"><canvas id="regionGrowthChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- 히트맵 테이블 + 지역 TOP 업체 -->
            <div class="content-grid" style="margin-bottom: 24px;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">🌡️ 지역별 현황 히트맵</div>
                    </div>
                    <div class="card-body">
                        <div class="scroll-table" style="max-height: 350px;">
                            <table class="data-table" id="regionHeatmapTable">
                                <thead><tr><th>지역</th><th class="text-right">매출액</th><th class="text-right">건수</th><th class="text-right">성장률</th><th>비중</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">🏢 지역별 TOP 업체</div>
                    </div>
                    <div class="card-body">
                        <div class="scroll-table" style="max-height: 350px;">
                            <table class="data-table" id="regionTopClientTable">
                                <thead><tr><th>지역</th><th>업체명</th><th class="text-right">매출액</th><th>담당자</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 담당자별 지역 분포 -->
            <div class="card" style="margin-bottom: 24px;">
                <div class="card-header">
                    <div class="card-title">👤 담당자별 지역 분포</div>
                    <div class="card-badge" id="managerRegionBadge">-</div>
                </div>
                <div class="card-body">
                    <div class="scroll-table" style="max-height: 350px;">
                        <table class="data-table" id="managerRegionTable">
                            <thead><tr><th>담당자</th><th>주력 지역</th><th class="text-right">지역수</th><th class="text-right">총매출</th><th>지역 분포</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 목적별 탭 -->
        <div id="purpose" class="tab-content">
            <!-- 목적별 KPI 카드 -->
            <section class="kpi-section" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 24px;">
                <div class="kpi-card" style="border-top: 4px solid #6366f1;">
                    <div class="kpi-header"><div class="kpi-icon">🎯</div></div>
                    <div class="kpi-label">총 검사목적</div>
                    <div class="kpi-value" id="purposeTotalCount">-</div>
                    <div class="kpi-compare">활성 목적 수</div>
                </div>
                <div class="kpi-card" style="border-top: 4px solid #10b981;">
                    <div class="kpi-header"><div class="kpi-icon">💰</div></div>
                    <div class="kpi-label">총 매출액</div>
                    <div class="kpi-value" id="purposeTotalSales" style="color: #10b981;">-</div>
                    <div class="kpi-compare" id="purposeTotalSalesCompare">-</div>
                </div>
                <div class="kpi-card" style="border-top: 4px solid #f59e0b;">
                    <div class="kpi-header"><div class="kpi-icon">📋</div></div>
                    <div class="kpi-label">총 건수</div>
                    <div class="kpi-value" id="purposeTotalCountNum" style="color: #f59e0b;">-</div>
                    <div class="kpi-compare" id="purposeTotalCountCompare">-</div>
                </div>
                <div class="kpi-card" style="border-top: 4px solid #ec4899;">
                    <div class="kpi-header"><div class="kpi-icon">🚀</div></div>
                    <div class="kpi-label">최고 성장 목적</div>
                    <div class="kpi-value" id="purposeTopGrowth" style="color: #ec4899; font-size: 18px;">-</div>
                    <div class="kpi-compare" id="purposeTopGrowthRate">-</div>
                </div>
            </section>

            <!-- 정렬 컨트롤 + 카드 그리드 -->
            <div class="card" style="margin-bottom: 24px;">
                <div class="card-header" style="flex-wrap: wrap; gap: 10px;">
                    <div class="card-title">🎯 검사목적별 현황</div>
                    <div class="chart-controls">
                        <button class="filter-btn active" data-sort="sales" onclick="sortPurposeCards('sales')">매출순</button>
                        <button class="filter-btn" data-sort="count" onclick="sortPurposeCards('count')">건수순</button>
                        <button class="filter-btn" data-sort="growth" onclick="sortPurposeCards('growth')">성장순</button>
                        <button class="filter-btn" data-sort="avgSales" onclick="sortPurposeCards('avgSales')">건당매출순</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="purposeCardGrid" class="purpose-card-grid"></div>
                </div>
            </div>

            <!-- 차트 영역 -->
            <div class="content-grid" style="margin-bottom: 24px;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">📊 TOP 5 월별 추이</div>
                        <div class="card-badge" id="purposeMonthlyBadge">-</div>
                    </div>
                    <div class="card-body">
                        <div id="purposeMonthlySummary" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; font-size: 13px;"></div>
                        <div class="chart-container" style="height: 320px;"><canvas id="purposeMonthlyChart"></canvas></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">📈 목적별 성장률</div>
                        <div class="card-badge" id="purposeGrowthBadge">전년 대비</div>
                    </div>
                    <div class="card-body">
                        <div id="purposeGrowthSummary" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; font-size: 13px;"></div>
                        <div class="chart-container" style="height: 320px;"><canvas id="purposeGrowthChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- 목적별 상세 테이블 -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">📋 목적별 상세 현황</div>
                    <div class="card-badge" id="purposeTableBadge">-</div>
                </div>
                <div class="card-body">
                    <div class="scroll-table">
                        <table class="data-table" id="purposeTable">
                            <thead><tr>
                                <th>순위</th>
                                <th>검사목적</th>
                                <th class="text-right">매출액</th>
                                <th class="text-right">전년</th>
                                <th class="text-right">증감</th>
                                <th class="text-right">건수</th>
                                <th class="text-right">건당단가</th>
                                <th class="text-right">비중</th>
                                <th>주요 담당자</th>
                            </tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 담당자별 유형 보유 수 차트 & 지속적인 거래 유형 테이블 -->
            <div class="grid grid-cols-2">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">👤 담당자별 유형 보유 수</div>
                        <div class="card-badge" id="managerPurposeTypeBadge">-</div>
                    </div>
                    <div class="card-body">
                        <div id="managerPurposeTypeSummary" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; font-size: 13px;"></div>
                        <div class="chart-container" style="height: 320px;"><canvas id="managerPurposeTypeChart"></canvas></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">🔄 지속적인 거래 유형</div>
                        <div class="card-badge" id="continuousTradeBadge">-</div>
                    </div>
                    <div class="card-body">
                        <div id="continuousTradeSummary" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; font-size: 13px;"></div>
                        <div class="scroll-table" style="max-height: 340px;">
                            <table class="data-table" id="continuousTradeTable">
                                <thead><tr>
                                    <th>업체명</th>
                                    <th>검사목적</th>
                                    <th class="text-right">지속개월</th>
                                    <th class="text-right">매출액</th>
                                    <th class="text-right">건수</th>
                                    <th>거래월</th>
                                </tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 목적별 호버 팝업 -->
        <div id="purposeHoverPopup" class="purpose-hover-popup">
            <div class="popup-purpose-header">
                <span class="popup-purpose-name" id="popupPurposeName">-</span>
                <span class="popup-purpose-rank" id="popupPurposeRank">-</span>
            </div>
            <div class="popup-purpose-stats">
                <div class="popup-stat-item">
                    <div class="popup-stat-label">💰 매출액</div>
                    <div class="popup-stat-value" id="popupPurposeSales">-</div>
                    <div class="popup-stat-sub" id="popupPurposeLastSales">-</div>
                </div>
                <div class="popup-stat-item">
                    <div class="popup-stat-label">📋 건수</div>
                    <div class="popup-stat-value" id="popupPurposeCount">-</div>
                    <div class="popup-stat-sub" id="popupPurposeLastCount">-</div>
                </div>
                <div class="popup-stat-item">
                    <div class="popup-stat-label">📊 비중</div>
                    <div class="popup-stat-value" id="popupPurposePercent">-</div>
                </div>
                <div class="popup-stat-item">
                    <div class="popup-stat-label">💵 건당 단가</div>
                    <div class="popup-stat-value" id="popupPurposeAvg">-</div>
                </div>
            </div>
            <div class="popup-manager-section">
                <div class="popup-section-title">👤 담당자별 매출</div>
                <div id="popupManagerBars"></div>
            </div>
            <div class="popup-client-section">
                <div class="popup-section-title">🏢 주요 업체</div>
                <div id="popupClientTags" class="popup-client-tags"></div>
            </div>
            <div class="popup-insight" id="popupInsight">
                <div class="popup-insight-icon">💡</div>
                <div class="popup-insight-text" id="popupInsightText">-</div>
            </div>
        </div>

        <!-- 유형별 탭 -->
        <div id="sampleType" class="tab-content">
            <section class="purpose-kpi-section">
                <div class="section-title-bar">
                    <div class="section-title">🧪 검체 유형별 현황</div>
                    <div class="section-badge" id="sampleTypeCount">0개 유형</div>
                </div>
                <!-- 필터 & 정렬 툴바 -->
                <div style="display: flex; align-items: center; gap: 16px; margin: 12px 0 16px 0; flex-wrap: wrap; padding: 12px 16px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 12px; border: 1px solid #e2e8f0;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 13px; font-weight: 600; color: #475569;">🎯 검사목적</span>
                        <select id="stPurposeFilter" onchange="filterSampleTypeByPurpose()" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #cbd5e1; background: white; font-size: 13px; min-width: 140px; cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                            <option value="전체">전체</option>
                        </select>
                    </div>
                    <div style="height: 24px; width: 1px; background: #cbd5e1;"></div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 13px; font-weight: 600; color: #475569;">정렬</span>
                        <div style="display: flex; gap: 6px;">
                            <button onclick="sortSampleTypeCards('sales')" id="stSortSales" style="padding: 8px 14px; border-radius: 8px; border: none; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; font-size: 12px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 4px rgba(99,102,241,0.3); transition: all 0.2s;">💰 매출순</button>
                            <button onclick="sortSampleTypeCards('count')" id="stSortCount" style="padding: 8px 14px; border-radius: 8px; border: 1px solid #e2e8f0; background: white; color: #64748b; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;">📋 건수순</button>
                            <button onclick="sortSampleTypeCards('avgSales')" id="stSortAvg" style="padding: 8px 14px; border-radius: 8px; border: 1px solid #e2e8f0; background: white; color: #64748b; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;">💵 건당매출순</button>
                        </div>
                    </div>
                </div>
                <div class="purpose-kpi-grid" id="sampleTypeGrid"></div>
            </section>

            <!-- 담당자별 유형 보유 수 & 지속적인 거래 유형 -->
            <div class="grid grid-cols-2" style="margin-top: 20px;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">👤 담당자별 유형 보유 수</div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <select id="stManagerPurposeFilter" onchange="updateSTManagerTypeChart()" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 12px;">
                                <option value="전체">전체 검사목적</option>
                            </select>
                            <div class="card-badge" id="stManagerTypeBadge">-</div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="stManagerTypeSummary" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; font-size: 13px;"></div>
                        <div class="chart-container" style="height: 320px;"><canvas id="stManagerTypeChart"></canvas></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">🔄 지속적인 거래 유형</div>
                        <div class="card-badge" id="stContinuousTradeBadge">-</div>
                    </div>
                    <div class="card-body">
                        <div id="stContinuousTradeSummary" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; font-size: 13px;"></div>
                        <div class="scroll-table" style="max-height: 340px;">
                            <table class="data-table" id="stContinuousTradeTable">
                                <thead><tr>
                                    <th>업체명</th>
                                    <th>검체유형</th>
                                    <th class="text-right">지속개월</th>
                                    <th class="text-right">매출액</th>
                                    <th class="text-right">건수</th>
                                    <th>거래월</th>
                                </tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 부적합 탭 -->
        <div id="defect" class="tab-content">
            <!-- KPI 요약 -->
            <div class="kpi-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 20px;">
                <div class="kpi-card" style="background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); border: 1px solid #fecaca; border-radius: 12px; padding: 16px; text-align: center;">
                    <div style="font-size: 12px; color: #991b1b; font-weight: 600;">📛 총 부적합</div>
                    <div id="defectTotalCount" style="font-size: 28px; font-weight: 700; color: #dc2626;">0건</div>
                </div>
                <div class="kpi-card" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 1px solid #fcd34d; border-radius: 12px; padding: 16px; text-align: center;">
                    <div style="font-size: 12px; color: #92400e; font-weight: 600;">📅 최다 발생월</div>
                    <div id="defectPeakMonth" style="font-size: 28px; font-weight: 700; color: #d97706;">-</div>
                </div>
                <div class="kpi-card" style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border: 1px solid #a7f3d0; border-radius: 12px; padding: 16px; text-align: center;">
                    <div style="font-size: 12px; color: #065f46; font-weight: 600;">🌡️ 최다 계절</div>
                    <div id="defectPeakSeason" style="font-size: 28px; font-weight: 700; color: #059669;">-</div>
                </div>
                <div class="kpi-card" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 1px solid #bfdbfe; border-radius: 12px; padding: 16px; text-align: center;">
                    <div style="font-size: 12px; color: #1e40af; font-weight: 600;">🏆 1위 항목</div>
                    <div id="defectTopItem" style="font-size: 18px; font-weight: 700; color: #2563eb; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">-</div>
                </div>
            </div>

            <!-- 검사목적 필터 -->
            <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px; padding: 12px 16px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 12px; border: 1px solid #e2e8f0;">
                <span style="font-size: 13px; font-weight: 600; color: #475569;">🎯 검사목적 필터</span>
                <select id="defectPurposeFilter" onchange="updateDefectCharts()" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 13px; background: white; min-width: 150px;">
                    <option value="전체">전체</option>
                </select>
            </div>

            <!-- 1행: 월별 추이 + 계절별 -->
            <div class="content-grid" style="margin-bottom: 20px;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">📈 월별 부적합 추이</div>
                        <div class="card-badge" id="defectMonthlyBadge">-</div>
                    </div>
                    <div class="card-body"><div class="chart-container"><canvas id="defectMonthlyChart"></canvas></div></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">🌸 계절별 부적합</div>
                        <div class="card-badge" id="defectSeasonBadge">-</div>
                    </div>
                    <div class="card-body"><div class="chart-container"><canvas id="defectSeasonChart"></canvas></div></div>
                </div>
            </div>

            <!-- 2행: 항목별 차트 + 항목별 상세 -->
            <div class="content-grid" style="margin-bottom: 20px;">
                <div class="card">
                    <div class="card-header"><div class="card-title">📊 부적합 항목별 현황</div></div>
                    <div class="card-body"><div class="chart-container"><canvas id="defectChart"></canvas></div></div>
                </div>
                <div class="card">
                    <div class="card-header"><div class="card-title">📋 부적합 항목 상세</div></div>
                    <div class="card-body">
                        <div class="scroll-table" style="max-height: 350px;">
                            <table class="data-table" id="defectTable">
                                <thead><tr><th>부적합항목</th><th class="text-right">건수</th><th>비중</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3행: 담당자별 + 업체별 -->
            <div class="content-grid" style="margin-bottom: 20px;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">👤 담당자별 부적합</div>
                        <div class="card-badge" id="defectManagerBadge">-</div>
                    </div>
                    <div class="card-body"><div class="chart-container"><canvas id="defectManagerChart"></canvas></div></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">🏢 업체별 부적합 순위</div>
                        <div class="card-badge" id="defectClientBadge">TOP 20</div>
                    </div>
                    <div class="card-body">
                        <div class="scroll-table" style="max-height: 350px;">
                            <table class="data-table" id="defectClientTable">
                                <thead><tr><th>순위</th><th>업체명</th><th class="text-right">건수</th><th>주요 부적합 항목</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4행: 검사목적별 부적합 항목 -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">🎯 검사목적별 부적합 항목 분석</div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <select id="defectPurposeDetailFilter" onchange="updateDefectByPurposeDetail()" style="padding: 6px 10px; border-radius: 6px; border: 1px solid #cbd5e1; font-size: 12px; background: white; min-width: 140px;">
                            <option value="">검사목적 선택</option>
                        </select>
                        <div class="card-badge" id="defectPurposeDetailBadge">-</div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="content-grid">
                        <div><canvas id="defectPurposeDetailChart"></canvas></div>
                        <div class="scroll-table" style="max-height: 300px;">
                            <table class="data-table" id="defectPurposeDetailTable">
                                <thead><tr><th>부적합항목</th><th class="text-right">건수</th><th>비중</th><th>월별 추이</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 검사항목 탭 -->
        <div id="foodItem" class="tab-content">
            <!-- KPI 요약 -->
            <div class="kpi-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 20px;">
                <div class="kpi-card" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 1px solid #bfdbfe; border-radius: 12px; padding: 16px; text-align: center;">
                    <div style="font-size: 12px; color: #1e40af; font-weight: 600;">🔬 총 검사건수</div>
                    <div id="foodItemTotalCount" style="font-size: 26px; font-weight: 700; color: #2563eb;">0건</div>
                </div>
                <div class="kpi-card" style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border: 1px solid #a7f3d0; border-radius: 12px; padding: 16px; text-align: center;">
                    <div style="font-size: 12px; color: #065f46; font-weight: 600;">💰 총 수수료</div>
                    <div id="foodItemTotalFee" style="font-size: 26px; font-weight: 700; color: #059669;">0원</div>
                </div>
                <div class="kpi-card" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 1px solid #fcd34d; border-radius: 12px; padding: 16px; text-align: center;">
                    <div style="font-size: 12px; color: #92400e; font-weight: 600;">📋 항목 종류</div>
                    <div id="foodItemTypeCount" style="font-size: 26px; font-weight: 700; color: #d97706;">0개</div>
                </div>
                <div class="kpi-card" style="background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); border: 1px solid #d8b4fe; border-radius: 12px; padding: 16px; text-align: center;">
                    <div style="font-size: 12px; color: #6b21a8; font-weight: 600;">👨‍🔬 분석자 수</div>
                    <div id="foodItemAnalyzerCount" style="font-size: 26px; font-weight: 700; color: #7c3aed;">0명</div>
                </div>
            </div>

            <!-- 1행: 검사목적별 항목 건수 -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <div class="card-title">🎯 검사목적별 검사항목 현황</div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <select id="foodItemPurposeFilter" onchange="updateFoodItemByPurpose()" style="padding: 6px 10px; border-radius: 6px; border: 1px solid #cbd5e1; font-size: 12px; background: white; min-width: 140px;">
                            <option value="">검사목적 선택</option>
                        </select>
                        <div class="card-badge" id="foodItemPurposeBadge">-</div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="content-grid">
                        <div><canvas id="foodItemPurposeChart"></canvas></div>
                        <div class="scroll-table" style="max-height: 350px;">
                            <table class="data-table" id="foodItemPurposeTable">
                                <thead><tr><th>항목명</th><th class="text-right">건수</th><th class="text-right">수수료</th><th>비중</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2행: 항목 TOP + 항목별 분석자 다양성 -->
            <div class="content-grid" style="margin-bottom: 20px;">
                <div class="card">
                    <div class="card-header"><div class="card-title">📊 검사항목 TOP 15</div></div>
                    <div class="card-body"><div class="chart-container"><canvas id="foodItemChart"></canvas></div></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">👥 항목별 분석자 현황</div>
                        <div class="card-badge" id="foodItemDiversityBadge">-</div>
                    </div>
                    <div class="card-body">
                        <div class="scroll-table" style="max-height: 350px;">
                            <table class="data-table" id="foodItemDiversityTable">
                                <thead><tr><th>항목명</th><th class="text-right">처리건수</th><th class="text-right">분석자수</th><th>주요 분석자</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3행: 분석자별 현황 + 월별 추이 -->
            <div class="content-grid" style="margin-bottom: 20px;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">👨‍🔬 분석자별 처리 현황</div>
                        <div class="card-badge" id="foodItemAnalyzerBadge">-</div>
                    </div>
                    <div class="card-body"><div class="chart-container"><canvas id="foodItemAnalyzerChart"></canvas></div></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">📈 월별 검사 추이</div>
                        <div class="card-badge" id="foodItemMonthlyBadge">-</div>
                    </div>
                    <div class="card-body"><div class="chart-container"><canvas id="foodItemMonthlyChart"></canvas></div></div>
                </div>
            </div>

            <!-- 4행: 상세 테이블 -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">📋 검사항목별 상세</div>
                    <div class="card-badge" id="foodItemTableBadge">0개</div>
                </div>
                <div class="card-body">
                    <div class="scroll-table" style="max-height: 400px;">
                        <table class="data-table" id="foodItemTable">
                            <thead><tr><th>항목명</th><th class="text-right">건수</th><th class="text-right">수수료</th><th>비중</th><th>월별 추이</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 수금 탭 -->
        <div id="collection" class="tab-content">
            <!-- 수금 KPI -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                <div class="card" style="text-align: center; padding: 20px;">
                    <div style="color: #6b7280; font-size: 13px; margin-bottom: 8px;">총 매출</div>
                    <div id="collectionTotalSales" style="font-size: 24px; font-weight: 700; color: #2563eb;">-</div>
                </div>
                <div class="card" style="text-align: center; padding: 20px;">
                    <div style="color: #6b7280; font-size: 13px; margin-bottom: 8px;">수금 완료</div>
                    <div id="collectionPaid" style="font-size: 24px; font-weight: 700; color: #059669;">-</div>
                </div>
                <div class="card" style="text-align: center; padding: 20px;">
                    <div style="color: #6b7280; font-size: 13px; margin-bottom: 8px;">미수금</div>
                    <div id="collectionUnpaid" style="font-size: 24px; font-weight: 700; color: #dc2626;">-</div>
                </div>
                <div class="card" style="text-align: center; padding: 20px;">
                    <div style="color: #6b7280; font-size: 13px; margin-bottom: 8px;">수금률</div>
                    <div id="collectionRate" style="font-size: 24px; font-weight: 700; color: #7c3aed;">-</div>
                </div>
            </div>

            <!-- 평균 수금 기간 -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                <div class="card" style="text-align: center; padding: 20px;">
                    <div style="color: #6b7280; font-size: 13px; margin-bottom: 8px;">평균 수금 기간</div>
                    <div id="avgCollectionDays" style="font-size: 24px; font-weight: 700; color: #0891b2;">-</div>
                </div>
                <div class="card" style="text-align: center; padding: 20px;">
                    <div style="color: #6b7280; font-size: 13px; margin-bottom: 8px;">최단 수금</div>
                    <div id="minCollectionDays" style="font-size: 24px; font-weight: 700; color: #059669;">-</div>
                </div>
                <div class="card" style="text-align: center; padding: 20px;">
                    <div style="color: #6b7280; font-size: 13px; margin-bottom: 8px;">최장 수금</div>
                    <div id="maxCollectionDays" style="font-size: 24px; font-weight: 700; color: #dc2626;">-</div>
                </div>
            </div>

            <!-- 차트 영역 -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">📊 담당별 수금 현황</span>
                    </div>
                    <div class="card-body"><div class="chart-container"><canvas id="collectionByManagerChart"></canvas></div></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">📈 월별 수금 추이</span>
                    </div>
                    <div class="card-body"><div class="chart-container"><canvas id="collectionMonthlyChart"></canvas></div></div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">⏱️ 수금 기간 분포</span>
                    </div>
                    <div class="card-body"><div class="chart-container"><canvas id="collectionDaysChart"></canvas></div></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">🥧 입금 구분별 현황</span>
                    </div>
                    <div class="card-body"><div class="chart-container"><canvas id="collectionTypeChart"></canvas></div></div>
                </div>
            </div>

            <!-- 미수금 업체 목록 -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">🚨 미수금 업체 현황</span>
                    <span class="card-badge" id="unpaidCountBadge">0건</span>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    <table class="data-table" id="unpaidTable">
                        <thead>
                            <tr>
                                <th>업체명</th>
                                <th>접수일자</th>
                                <th>미수금액</th>
                                <th>경과일</th>
                                <th>영업담당</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 손익분석 탭 -->
        <div id="profitAnalysis" class="tab-content">
            <!-- 손익계산서 요약 KPI -->
            <div id="profitKpiSource" style="text-align: right; font-size: 12px; color: #9ca3af; margin-bottom: 10px;">데이터 소스: -</div>
            <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 15px; margin-bottom: 20px;">
                <div class="card" style="text-align: center; padding: 20px;">
                    <div style="color: #6b7280; font-size: 13px; margin-bottom: 8px;">매출액</div>
                    <div id="profitTotalSales" style="font-size: 20px; font-weight: 700; color: #2563eb;">-</div>
                </div>
                <div class="card" style="text-align: center; padding: 20px;">
                    <div id="profitCostLabel" style="color: #6b7280; font-size: 13px; margin-bottom: 8px;">매출원가</div>
                    <div id="profitTotalCost" style="font-size: 20px; font-weight: 700; color: #dc2626;">-</div>
                    <div id="profitCostRate" style="font-size: 11px; color: #9ca3af; margin-top: 4px;">-</div>
                </div>
                <div class="card" style="text-align: center; padding: 20px;">
                    <div style="color: #6b7280; font-size: 13px; margin-bottom: 8px;">판관비</div>
                    <div id="profitSgaExpense" style="font-size: 20px; font-weight: 700; color: #f97316;">-</div>
                    <div id="profitSgaRate" style="font-size: 11px; color: #9ca3af; margin-top: 4px;">-</div>
                </div>
                <div class="card" style="text-align: center; padding: 20px;">
                    <div style="color: #6b7280; font-size: 13px; margin-bottom: 8px;">영업이익</div>
                    <div id="profitTotalProfit" style="font-size: 20px; font-weight: 700; color: #059669;">-</div>
                </div>
                <div class="card" style="text-align: center; padding: 20px;">
                    <div style="color: #6b7280; font-size: 13px; margin-bottom: 8px;">영업이익률</div>
                    <div id="profitMarginRate" style="font-size: 20px; font-weight: 700; color: #7c3aed;">-</div>
                </div>
                <div class="card" style="text-align: center; padding: 20px;">
                    <div style="color: #6b7280; font-size: 13px; margin-bottom: 8px;">세전이익</div>
                    <div id="profitNetProfit" style="font-size: 20px; font-weight: 700; color: #0891b2;">-</div>
                    <div id="profitDiscountRate" style="font-size: 11px; color: #9ca3af; margin-top: 4px;">-</div>
                </div>
            </div>

            <!-- 분석 선택 탭 -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn" id="btnProfitByPurpose" onclick="showProfitTab('purpose')" style="background: #2563eb; color: white;">검사목적별</button>
                <button class="btn" id="btnProfitByManager" onclick="showProfitTab('manager')">담당자별</button>
                <button class="btn" id="btnProfitByMonth" onclick="showProfitTab('month')">월별 추이</button>
            </div>

            <!-- 검사목적별 분석 -->
            <div id="profitByPurpose" class="profit-section">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">📊 검사목적별 매출 vs 이익</span>
                        </div>
                        <div class="card-body"><div class="chart-container"><canvas id="profitByPurposeChart"></canvas></div></div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">🥧 검사목적별 이익 비중</span>
                        </div>
                        <div class="card-body"><div class="chart-container"><canvas id="profitByPurposePieChart"></canvas></div></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">📋 검사목적별 손익 상세</span>
                    </div>
                    <div class="card-body" style="overflow-x: auto;">
                        <table class="data-table" id="profitByPurposeTable">
                            <thead>
                                <tr>
                                    <th>검사목적</th>
                                    <th>건수</th>
                                    <th>정상가 합계</th>
                                    <th>실제 매출</th>
                                    <th>할인율</th>
                                    <th>추정 원가</th>
                                    <th>추정 이익</th>
                                    <th>이익률</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 담당자별 분석 -->
            <div id="profitByManager" class="profit-section" style="display: none;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">📊 담당자별 매출 vs 이익</span>
                        </div>
                        <div class="card-body"><div class="chart-container"><canvas id="profitByManagerChart"></canvas></div></div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">📈 담당자별 이익률 비교</span>
                        </div>
                        <div class="card-body"><div class="chart-container"><canvas id="profitByManagerRateChart"></canvas></div></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">📋 담당자별 손익 상세</span>
                    </div>
                    <div class="card-body" style="overflow-x: auto;">
                        <table class="data-table" id="profitByManagerTable">
                            <thead>
                                <tr>
                                    <th>담당자</th>
                                    <th>건수</th>
                                    <th>정상가 합계</th>
                                    <th>실제 매출</th>
                                    <th>할인율</th>
                                    <th>추정 원가</th>
                                    <th>추정 이익</th>
                                    <th>이익률</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 월별 추이 -->
            <div id="profitByMonth" class="profit-section" style="display: none;">
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <span class="card-title">📈 월별 손익 추이</span>
                    </div>
                    <div class="card-body"><div class="chart-container" style="height: 350px;"><canvas id="profitMonthlyTrendChart"></canvas></div></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">📋 월별 손익 상세</span>
                    </div>
                    <div class="card-body" style="overflow-x: auto;">
                        <table class="data-table" id="profitByMonthTable">
                            <thead>
                                <tr>
                                    <th>월</th>
                                    <th>건수</th>
                                    <th>정상가 합계</th>
                                    <th>실제 매출</th>
                                    <th>할인율</th>
                                    <th>추정 원가</th>
                                    <th>추정 이익</th>
                                    <th>이익률</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI 분석 탭 -->
        <div id="aiAnalysis" class="tab-content">
            <section class="ai-section">
                <div class="ai-header">
                    <h2>🤖 AI 경영 분석 어시스턴트</h2>
                    <p>데이터 기반 경영 판단을 도와드립니다. 장점, 단점, 개선 방향을 근거와 함께 제시합니다.</p>
                </div>
                <div class="ai-input-container">
                    <div class="ai-input-wrapper">
                        <textarea id="aiQueryInput" class="ai-input" rows="3" placeholder="예: 올해 매출 성과를 분석하고 개선 방향을 제안해주세요"></textarea>
                        <button onclick="runAiAnalysis()" class="ai-btn" id="aiBtn">🔍 분석</button>
                    </div>
                    <div class="ai-examples">
                        <span class="ai-example" onclick="setAiQuery('올해 매출 성과를 분석하고 장단점과 개선 방향을 알려주세요')">📊 매출 성과 분석</span>
                        <span class="ai-example" onclick="setAiQuery('영업담당별 실적을 비교하고 우수사례와 개선이 필요한 부분을 알려주세요')">👥 영업 실적 분석</span>
                        <span class="ai-example" onclick="setAiQuery('거래처 현황을 분석하고 고객 유지 전략을 제안해주세요')">🏢 거래처 분석</span>
                        <span class="ai-example" onclick="setAiQuery('검사목적별 매출 추이를 분석하고 성장 기회를 알려주세요')">🔬 검사목적 분석</span>
                        <span class="ai-example" onclick="setAiQuery('전년 대비 성과를 비교하고 경영 개선 방향을 제안해주세요')">📈 전년 비교 분석</span>
                        <span class="ai-example" onclick="setAiQuery('수금 현황을 분석하고 현금흐름 개선 방안을 제안해주세요')">💰 수금 분석</span>
                    </div>
                    <div class="ai-result" id="aiResult">
                        <div id="aiLoading" style="text-align: center; display: none;">
                            <div style="font-size: 24px; margin-bottom: 10px;">⏳</div>
                            <div>AI가 데이터를 분석하고 있습니다...</div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">경영 인사이트 도출 중</div>
                        </div>
                        <div id="aiError" style="color: var(--danger); display: none;"></div>
                        <div id="aiContent"></div>
                    </div>
                </div>
            </section>
        </div>

        <!-- 기업 정보 탭 -->
        <div id="companyInfo" class="tab-content">
            <div class="card">
                <div class="card-header"><div class="card-title">🏛️ 기업 정보 관리</div></div>
                <div class="card-body">
                    <p style="color: var(--gray-500); text-align: center; padding: 40px;">기업 정보 관리 기능</p>
                </div>
            </div>
        </div>

        <!-- 터미널 탭 -->
        <div id="webTerminal" class="tab-content">
            <div class="card" style="background: #1e293b;">
                <div class="card-header" style="border-color: #334155;"><div class="card-title" style="color: #10b981;">💻 웹 터미널</div></div>
                <div class="card-body">
                    <div style="background: #0f172a; padding: 20px; border-radius: 12px; font-family: monospace; color: #10b981; min-height: 300px;">
                        <p>$ 터미널 기능</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 비밀번호 변경 모달 (전역 위치) -->
    <div id="passwordModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 420px;">
            <div class="modal-header">
                <h3>🔐 비밀번호 변경</h3>
                <button class="modal-close" onclick="closePasswordModal()">✕</button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <form id="passwordForm" onsubmit="return changePassword(event)">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">현재 비밀번호</label>
                        <input type="password" id="currentPassword" required autocomplete="current-password"
                            style="width: 100%; padding: 12px 14px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;"
                            placeholder="현재 비밀번호를 입력하세요">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">새 비밀번호</label>
                        <input type="password" id="newPassword" required minlength="4" autocomplete="new-password"
                            style="width: 100%; padding: 12px 14px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;"
                            placeholder="새 비밀번호 (4자 이상)">
                    </div>
                    <div style="margin-bottom: 24px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">새 비밀번호 확인</label>
                        <input type="password" id="confirmPassword" required minlength="4" autocomplete="new-password"
                            style="width: 100%; padding: 12px 14px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;"
                            placeholder="새 비밀번호를 다시 입력하세요">
                    </div>
                    <div id="passwordError" style="display: none; margin-bottom: 16px; padding: 12px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; color: #dc2626; font-size: 13px;"></div>
                    <div id="passwordSuccess" style="display: none; margin-bottom: 16px; padding: 12px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; color: #16a34a; font-size: 13px;"></div>
                    <div style="display: flex; gap: 12px;">
                        <button type="button" onclick="closePasswordModal()"
                            style="flex: 1; padding: 12px; border: 1px solid #d1d5db; background: white; border-radius: 8px; font-size: 14px; cursor: pointer;">
                            취소
                        </button>
                        <button type="submit" id="passwordSubmitBtn"
                            style="flex: 1; padding: 12px; border: none; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
                            변경하기
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // 디버깅: 스크립트 시작 로그
        console.log('[DEBUG] Main script starting...');

        // 전역 오류 핸들러
        window.onerror = function(message, source, lineno, colno, error) {
            console.error('[GLOBAL ERROR]', message, 'at', source, 'line:', lineno, 'col:', colno);
            // 오류 발생 시 로딩중 표시 변경
            const userInfo = document.getElementById('userInfo');
            if (userInfo && userInfo.textContent === '로딩중...') {
                userInfo.textContent = '오류 발생';
                userInfo.style.color = '#ef4444';
            }
            return false;
        };

        // 전역 변수
        let charts = {};
        let currentData = null;
        let compareData = null;  // 하위 호환성용 (첫 번째 비교 데이터)
        let compareDataList = [];  // 다중 비교 연도 데이터 배열
        let currentTab = 'main';
        let managerTableSort = { column: null, direction: 'desc' };
        let branchTableSort = { column: null, direction: 'desc' };
        let clientChartFiltersInitialized = false;  // 거래처 차트 필터 초기화 여부
        let availableYears = [];  // 사용 가능한 연도 목록 (API에서 동적 로드)

        // 담당자-팀 매핑 (JavaScript용)
        const MANAGER_TO_BRANCH_JS = {
            "장동욱": "충청지사", "지병훈": "충청지사", "박은태": "충청지사",
            "도준구": "기타지사", "정유경": "기타지사", "엄은정": "기타지사", "ISA": "기타지사",
            "이강현": "전라지사",
            "조봉현": "서울센터", "오세중": "서울센터", "장동주": "서울센터", "오석현": "서울센터",
            "엄상흠": "경북센터",
            "마케팅": "마케팅팀", "마케팅팀": "마케팅팀",
            "본사접수": "본사", "본사": "본사"
        };

        // 툴팁 hover 상태 관리 (스크롤 가능하도록)
        const tooltipHoverState = {};
        const tooltipHideTimers = {};
        const TOOLTIP_HIDE_DELAY = 400; // ms - 툴팁 위에 마우스 있을 때만 적용

        function setupTooltipHover(tooltipEl) {
            if (!tooltipEl || tooltipEl._hoverSetup) return;
            tooltipEl._hoverSetup = true;
            tooltipEl.addEventListener('mouseenter', () => {
                // 이미 보이는 상태일 때만 반응 (숨겨진 상태에서는 무시)
                if (parseFloat(tooltipEl.style.opacity) === 0) return;

                // 숨김 타이머 취소
                if (tooltipHideTimers[tooltipEl.id]) {
                    clearTimeout(tooltipHideTimers[tooltipEl.id]);
                    tooltipHideTimers[tooltipEl.id] = null;
                }
                tooltipHoverState[tooltipEl.id] = true;
            });
            tooltipEl.addEventListener('mouseleave', () => {
                tooltipHoverState[tooltipEl.id] = false;
                // 툴팁에서 벗어나면 지연 후 숨김 (스크롤 후 차트로 돌아갈 시간)
                tooltipHideTimers[tooltipEl.id] = setTimeout(() => {
                    if (!tooltipHoverState[tooltipEl.id]) {
                        tooltipEl.style.opacity = 0;
                        tooltipEl.style.pointerEvents = 'none'; // 숨김 시 이벤트 차단
                    }
                    tooltipHideTimers[tooltipEl.id] = null;
                }, TOOLTIP_HIDE_DELAY);
            });
        }
        function isTooltipHovered(tooltipEl) {
            return tooltipEl && tooltipHoverState[tooltipEl.id];
        }

        // 툴팁 즉시 숨김 (차트 데이터 영역 벗어날 때)
        function hideTooltipWithDelay(tooltipEl) {
            if (!tooltipEl) return;
            // 툴팁 위에 마우스가 있으면 숨기지 않음
            if (tooltipHoverState[tooltipEl.id]) return;

            // 타이머가 있으면 취소
            if (tooltipHideTimers[tooltipEl.id]) {
                clearTimeout(tooltipHideTimers[tooltipEl.id]);
                tooltipHideTimers[tooltipEl.id] = null;
            }

            // 즉시 숨김 + 이벤트 차단
            tooltipEl.style.opacity = 0;
            tooltipEl.style.pointerEvents = 'none';
        }

        // 툴팁 표시 (차트에서 호출)
        function showTooltipElement(tooltipEl) {
            if (!tooltipEl) return;
            tooltipEl.style.opacity = 1; tooltipEl.style.pointerEvents = 'auto';
            tooltipEl.style.pointerEvents = 'auto'; // 표시 시 이벤트 허용
        }

        // 유틸리티 함수
        function formatCurrency(value) {
            const sign = value < 0 ? '-' : '';
            const absValue = Math.abs(value);
            if (absValue >= 100000000) return sign + (absValue/100000000).toFixed(1) + '억';
            if (absValue >= 10000) return sign + (absValue/10000).toFixed(0) + '만';
            return Math.round(value).toLocaleString();
        }

        function showToast(message, type = 'success', duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type;
            toast.style.display = 'block';
            if (type !== 'loading') setTimeout(() => toast.style.display = 'none', duration);
        }

        function hideToast() { document.getElementById('toast').style.display = 'none'; }

        // 탭 전환
        function showTab(tabId) {
            currentTab = tabId;
            document.querySelectorAll('.tab-card').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            const card = document.querySelector(`.tab-card[onclick="showTab('${tabId}')"]`);
            if (card) card.classList.add('active');
            const content = document.getElementById(tabId);
            if (content) content.classList.add('active');
            document.getElementById('kpiSection').classList.toggle('hidden', tabId !== 'main');

            // 손익분석 탭이면 데이터 로드
            if (tabId === 'profitAnalysis') {
                loadProfitAnalysisData();
            }

            // 탭 이용 기록 저장
            const tabNames = {
                'main': '대시보드',
                'monthlySales': '월별매출',
                'sampleType': '검체유형',
                'branchChart': '지역별',
                'clientAnalysis': '업체분석',
                'defectAnalysis': '부적합분석',
                'livestockTab': '축산물분석',
                'collectionTab': '수금현황',
                'profitAnalysis': '손익분석',
                'aiAnalysis': 'AI분석'
            };
            const menuName = tabNames[tabId] || tabId;
            fetch('/api/log-menu', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({menu: menuName})
            }).catch(() => {});
        }

        // 비교 체크박스
        document.getElementById('compareCheck').addEventListener('change', function() {
            document.getElementById('compareYearGroup').style.display = this.checked ? 'flex' : 'none';
            document.getElementById('compareMonthGroup').style.display = this.checked ? 'flex' : 'none';
        });

        // 토큰 사용량 로드
        async function loadTokenUsage() {
            try {
                const res = await fetch('/api/token-usage');
                const data = await res.json();
                if (data.this_month) {
                    const tokens = data.this_month.tokens || 0;
                    const krw = Math.round(data.this_month.cost_krw || 0);
                    const usd = data.this_month.cost_usd || (krw / 1450).toFixed(2);
                    document.getElementById('thisMonthTokens').textContent = tokens.toLocaleString();
                    document.getElementById('thisMonthUSD').textContent = parseFloat(usd).toFixed(2);
                    document.getElementById('thisMonthKRW').textContent = krw.toLocaleString();
                }
                if (data.last_month) {
                    const tokens = data.last_month.tokens || 0;
                    const krw = Math.round(data.last_month.cost_krw || 0);
                    const usd = data.last_month.cost_usd || (krw / 1450).toFixed(2);
                    document.getElementById('lastMonthTokens').textContent = tokens.toLocaleString();
                    document.getElementById('lastMonthUSD').textContent = parseFloat(usd).toFixed(2);
                    document.getElementById('lastMonthKRW').textContent = krw.toLocaleString();
                }
            } catch (e) { console.log('토큰 로드 실패', e); }
        }

        // 사용 가능한 연도 목록 로드 및 드롭다운 초기화
        async function initializeYearSelects() {
            try {
                const res = await fetch('/api/available-years');
                const data = await res.json();
                availableYears = data.years || [2025, 2024];
                console.log('[DEBUG] 사용 가능한 연도:', availableYears);

                // 연도 드롭다운 채우기
                const yearSelect = document.getElementById('yearSelect');
                const compareYearCheckboxes = document.getElementById('compareYearCheckboxes');

                if (yearSelect && availableYears.length > 0) {
                    yearSelect.innerHTML = availableYears.map((y, i) =>
                        `<option value="${y}" ${i === 0 ? 'selected' : ''}>${y}년</option>`
                    ).join('');
                }

                // 비교 연도 체크박스 생성 (현재 선택 연도 제외, 동적으로 업데이트)
                if (compareYearCheckboxes && availableYears.length > 0) {
                    updateCompareYearCheckboxes();
                }

                // 조회 연도 변경 시 비교 연도 체크박스 업데이트
                if (yearSelect) {
                    yearSelect.addEventListener('change', updateCompareYearCheckboxes);
                }
            } catch (e) {
                console.error('[DEBUG] 연도 목록 로드 실패:', e);
                // 실패 시 기본값 사용
                availableYears = [2025, 2024];
                const yearSelect = document.getElementById('yearSelect');
                if (yearSelect) {
                    yearSelect.innerHTML = '<option value="2025" selected>2025년</option><option value="2024">2024년</option>';
                }
                updateCompareYearCheckboxes();
            }
        }

        // 비교 연도 체크박스 업데이트 (현재 연도 포함 - 월 비교용)
        function updateCompareYearCheckboxes() {
            const yearSelect = document.getElementById('yearSelect');
            const compareYearCheckboxes = document.getElementById('compareYearCheckboxes');
            if (!compareYearCheckboxes) return;

            const selectedYear = yearSelect ? parseInt(yearSelect.value) : availableYears[0];
            // 모든 연도 포함 (현재 연도도 포함하여 같은 연도 다른 월 비교 가능)
            const compareYears = availableYears;

            if (compareYears.length > 0) {
                compareYearCheckboxes.innerHTML = compareYears.map((y, i) => {
                    const isCurrent = (y === selectedYear);
                    const bgColor = isCurrent ? '#e0e7ff' : '#f1f5f9';  // 현재 연도는 다른 색상
                    return `<label style="display: flex; align-items: center; gap: 4px; cursor: pointer; padding: 4px 8px; background: ${bgColor}; border-radius: 6px; font-size: 13px;${isCurrent ? ' border: 1px dashed #6366f1;' : ''}">
                        <input type="checkbox" class="compare-year-checkbox" value="${y}" ${i === 1 ? 'checked' : ''}>
                        <span>${y}년${isCurrent ? ' (현재)' : ''}</span>
                    </label>`;
                }).join('');
            } else {
                compareYearCheckboxes.innerHTML = '<span style="color: #94a3b8; font-size: 12px;">비교할 연도 없음</span>';
            }
        }

        // 선택된 비교 연도 목록 가져오기
        function getSelectedCompareYears() {
            const checkboxes = document.querySelectorAll('.compare-year-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // 데이터 로드 (실제 API 호출)
        async function loadData() {
            console.log('[DEBUG] loadData() 시작');
            const btn = document.getElementById('btnSearch');
            if (!btn) {
                console.error('[DEBUG] btnSearch 버튼을 찾을 수 없음');
                return;
            }
            btn.disabled = true;
            btn.innerHTML = '⏳ 로딩중...';
            showToast('데이터를 불러오는 중...', 'loading');
            clientChartFiltersInitialized = false;  // 필터 초기화 플래그 리셋

            // 연도 목록이 비어있으면 먼저 초기화
            if (availableYears.length === 0) {
                await initializeYearSelects();
            }

            try {
                const year = document.getElementById('yearSelect').value;
                const month = document.getElementById('monthSelect').value;
                const purpose = document.getElementById('purposeSelect').value;
                const compareCheck = document.getElementById('compareCheck').checked;
                const compareYears = getSelectedCompareYears();
                const compareMonth = document.getElementById('compareMonthSelect').value;
                console.log('[DEBUG] 조회 조건:', { year, month, purpose, compareCheck, compareYears, compareMonth });

                let url = `/api/data?year=${year}`;
                if (month) url += `&month=${month}`;
                if (purpose !== '전체') url += `&purpose=${encodeURIComponent(purpose)}`;
                console.log('[DEBUG] API URL:', url);

                const res = await fetch(url);
                console.log('[DEBUG] API 응답 상태:', res.status);
                currentData = await res.json();
                console.log('[DEBUG] currentData 로드됨, 키:', Object.keys(currentData));
                currentData.year = year;

                // 다중 비교 데이터 로드
                if (compareCheck && compareYears.length > 0) {
                    // 비교할 월 결정 (동일월 또는 지정월)
                    const targetMonth = compareMonth || month;

                    // 병렬로 여러 연도 데이터 로드
                    const comparePromises = compareYears.map(async (compYear) => {
                        let compUrl = `/api/data?year=${compYear}`;
                        if (targetMonth) compUrl += `&month=${targetMonth}`;
                        if (purpose !== '전체') compUrl += `&purpose=${encodeURIComponent(purpose)}`;
                        const compRes = await fetch(compUrl);
                        const compData = await compRes.json();
                        compData.year = compYear;
                        compData.month = targetMonth;
                        return compData;
                    });

                    compareDataList = await Promise.all(comparePromises);
                    // 하위 호환성을 위해 첫 번째 비교 데이터를 compareData에도 저장
                    compareData = compareDataList.length > 0 ? compareDataList[0] : null;
                    console.log('[DEBUG] 비교 데이터 로드 완료:', compareDataList.map(d => d.year));
                } else {
                    compareData = null;
                    compareDataList = [];
                }

                updateAll();
                hideToast();
                showToast(`${year}년 데이터 로드 완료`, 'success');
            } catch (e) {
                console.error('[DEBUG] loadData 에러:', e);
                hideToast();
                showToast('데이터 로드 실패: ' + e.message, 'error');
            }

            btn.disabled = false;
            btn.innerHTML = '🔍 조회하기';
            console.log('[DEBUG] loadData() 완료');
        }

        function updateAll() {
            updateSummary();
            updatePurposeGrid();
            updateDepartmentCards();  // 부서별 카드 업데이트
            updatePersonalTab();  // 개인별 탭 전체 업데이트
            updateTeamTab();      // 팀별 탭 전체 업데이트
            updateManagerChart();
            updateBranchChart();
            updateMonthlyTab();   // 월별 탭 전체 업데이트
            updateManagerTable();
            updateBranchTable();
            updateClientTab();
            updateRegionTab();
            updateSampleTypeTab();
            updateDefectTab();
            updatePurposeTab();
            updateFoodItemTab();
            updateCollectionTab();
        }

        function updateSummary() {
            const totalSales = currentData.total_sales || 0;
            const totalCount = currentData.total_count || 0;
            const avgPrice = totalCount > 0 ? totalSales / totalCount : 0;
            const goalTarget = 7000000000;
            const goalRate = ((totalSales / goalTarget) * 100).toFixed(1);

            document.getElementById('totalSales').textContent = formatCurrency(totalSales);
            document.getElementById('totalCount').textContent = totalCount.toLocaleString() + '건';
            document.getElementById('avgPrice').textContent = formatCurrency(avgPrice);
            document.getElementById('goalRate').textContent = goalRate + '%';
            document.getElementById('managerChartBadge').textContent = currentData.year + '년';

            if (compareData) {
                const compSales = compareData.total_sales || 0;
                const compCount = compareData.total_count || 0;
                const compAvg = compCount > 0 ? compSales / compCount : 0;

                const salesDiff = compSales > 0 ? ((totalSales - compSales) / compSales * 100).toFixed(1) : 0;
                const countDiff = compCount > 0 ? ((totalCount - compCount) / compCount * 100).toFixed(1) : 0;
                const priceDiff = compAvg > 0 ? ((avgPrice - compAvg) / compAvg * 100).toFixed(1) : 0;

                updateTrendBadge('salesTrend', salesDiff);
                updateTrendBadge('countTrend', countDiff);
                updateTrendBadge('priceTrend', priceDiff);

                document.getElementById('compareTotalSales').innerHTML = `${compareData.year}년: <span>${formatCurrency(compSales)}</span>`;
                document.getElementById('compareTotalSales').style.display = 'block';
                document.getElementById('compareTotalCount').innerHTML = `${compareData.year}년: <span>${compCount.toLocaleString()}건</span>`;
                document.getElementById('compareTotalCount').style.display = 'block';
                document.getElementById('compareAvgPrice').innerHTML = `${compareData.year}년: <span>${formatCurrency(compAvg)}</span>`;
                document.getElementById('compareAvgPrice').style.display = 'block';

                // KPI 카드 호버 오버레이 업데이트
                const salesUp = parseFloat(salesDiff) >= 0;
                document.getElementById('salesOverlay').innerHTML = `
                    <div class="overlay-year-badge">${compareData.year}년</div>
                    <div class="overlay-label">전년도 총 매출</div>
                    <div class="overlay-value">${formatCurrency(compSales)}</div>
                    <div class="overlay-change">증감: <span class="${salesUp ? 'up' : 'down'}">${salesUp ? '+' : ''}${salesDiff}%</span></div>
                `;

                const countUp = parseFloat(countDiff) >= 0;
                document.getElementById('countOverlay').innerHTML = `
                    <div class="overlay-year-badge">${compareData.year}년</div>
                    <div class="overlay-label">전년도 총 건수</div>
                    <div class="overlay-value">${compCount.toLocaleString()}건</div>
                    <div class="overlay-change">증감: <span class="${countUp ? 'up' : 'down'}">${countUp ? '+' : ''}${countDiff}%</span></div>
                `;

                const priceUp = parseFloat(priceDiff) >= 0;
                document.getElementById('priceOverlay').innerHTML = `
                    <div class="overlay-year-badge">${compareData.year}년</div>
                    <div class="overlay-label">전년도 평균 단가</div>
                    <div class="overlay-value">${formatCurrency(compAvg)}</div>
                    <div class="overlay-change">증감: <span class="${priceUp ? 'up' : 'down'}">${priceUp ? '+' : ''}${priceDiff}%</span></div>
                `;

                // 목표달성률에 전년대비 성장률 표시
                document.getElementById('goalCompare').innerHTML = `성장률: <span class="${salesUp ? 'up' : 'down'}" style="color: var(--${salesUp ? 'success' : 'danger'}); font-weight: 600;">${salesUp ? '+' : ''}${salesDiff}%</span>`;
                document.getElementById('goalCompare').style.display = 'block';

                // 목표달성률 오버레이 (증감률 크게, 금액 차이 표시)
                const salesDiffAmount = totalSales - compSales;
                const diffAmountStr = (salesDiffAmount >= 0 ? '+' : '') + formatCurrency(salesDiffAmount);
                document.getElementById('goalOverlay').innerHTML = `
                    <div class="overlay-year-badge">${compareData.year}년 대비</div>
                    <div class="overlay-label">전년대비 성장률</div>
                    <div class="overlay-value" style="color: var(--${salesUp ? 'success' : 'danger'});">${salesUp ? '+' : ''}${salesDiff}%</div>
                    <div class="overlay-sub">전년 매출: ${formatCurrency(compSales)}</div>
                    <div class="overlay-change">차이: <span class="${salesUp ? 'up' : 'down'}">${diffAmountStr}</span></div>
                `;
            } else {
                ['compareTotalSales', 'compareTotalCount', 'compareAvgPrice', 'goalCompare'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = 'none';
                });
                ['salesTrend', 'countTrend', 'priceTrend'].forEach(id => document.getElementById(id).style.visibility = 'hidden');
                // 오버레이 비우기
                ['salesOverlay', 'countOverlay', 'priceOverlay', 'goalOverlay'].forEach(id => document.getElementById(id).innerHTML = '');
            }
        }

        function updateTrendBadge(id, diff) {
            const el = document.getElementById(id);
            el.style.visibility = 'visible';
            const isUp = parseFloat(diff) >= 0;
            el.className = 'kpi-trend ' + (isUp ? 'up' : 'down');
            el.innerHTML = `<span>${isUp ? '↑' : '↓'} ${isUp ? '+' : ''}${diff}%</span>`;
        }

        // 부서별 카드 업데이트
        function updateDepartmentCards() {
            const dept = currentData.by_department || {};
            const totalSales = currentData.total_sales || 1;
            const compareDept = compareData ? (compareData.by_department || {}) : {};

            // 부서별 데이터 매핑
            const deptMapping = [
                { key: '본사', prefix: 'Bonsa' },
                { key: '마케팅', prefix: 'Marketing' },
                { key: '영업부', prefix: 'Sales' },
                { key: '지사', prefix: 'Branch' }
            ];

            deptMapping.forEach(({ key, prefix }) => {
                const data = dept[key] || { sales: 0, count: 0 };
                const sales = data.sales || 0;
                const count = data.count || 0;
                const avg = count > 0 ? sales / count : 0;
                const ratio = totalSales > 0 ? (sales / totalSales * 100) : 0;

                // 값 업데이트
                const salesEl = document.getElementById(`dept${prefix}Sales`);
                const countEl = document.getElementById(`dept${prefix}Count`);
                const avgEl = document.getElementById(`dept${prefix}Avg`);
                const ratioEl = document.getElementById(`dept${prefix}Ratio`);

                if (salesEl) salesEl.textContent = formatCurrency(sales);
                if (countEl) countEl.textContent = count.toLocaleString() + '건';
                if (avgEl) avgEl.textContent = formatCurrency(avg);
                if (ratioEl) ratioEl.textContent = ratio.toFixed(1) + '%';

                // 오버레이 (전년 대비)
                const overlayEl = document.getElementById(`dept${prefix}Overlay`);

                if (compareData && compareDept[key]) {
                    const compSales = compareDept[key].sales || 0;
                    const compCount = compareDept[key].count || 0;
                    if (compSales > 0) {
                        const growth = ((sales - compSales) / compSales * 100).toFixed(1);
                        const isPositive = parseFloat(growth) >= 0;
                        const diff = sales - compSales;
                        if (overlayEl) {
                            overlayEl.className = 'dept-overlay active';
                            overlayEl.innerHTML = `
                                <div class="overlay-title">전년 대비</div>
                                <div class="overlay-value ${isPositive ? 'positive' : 'negative'}">${isPositive ? '+' : ''}${growth}%</div>
                                <div class="overlay-detail">${compareData.year}년: ${formatCurrency(compSales)}</div>
                                <div class="overlay-detail">차이: ${isPositive ? '+' : ''}${formatCurrency(diff)}</div>
                            `;
                        }
                    } else {
                        if (overlayEl) overlayEl.className = 'dept-overlay';
                    }
                } else {
                    if (overlayEl) overlayEl.className = 'dept-overlay';
                }
            });
        }

        function updatePurposeGrid() {
            const grid = document.getElementById('purposeGrid');
            const purposes = currentData.by_purpose || [];
            const colors = ['blue', 'green', 'orange', 'purple', 'pink', 'info', 'teal', 'amber', 'rose', 'sky', 'lime', 'cyan'];
            const icons = ['📋', '🥗', '⏰', '🥜', '🧬', '📄', '⚗️', '🏷️', '📤', '🌱', '☢️', '🔬', '💊', '🌙', '🥕', '❌'];

            document.getElementById('purposeCount').textContent = purposes.length + '개 목적';

            const compareMap = compareData ? Object.fromEntries(compareData.by_purpose || []) : {};

            grid.innerHTML = purposes.map((p, i) => {
                const name = p[0], sales = p[1].sales, count = p[1].count;
                const isCancel = name === '접수취소';
                const cardColor = isCancel ? 'danger' : colors[i % colors.length];
                const salesValue = isCancel ? '-' + formatCurrency(Math.abs(sales)) : formatCurrency(sales);

                let changeHtml = '';
                let overlayHtml = '';

                if (compareData && compareMap[name]) {
                    const compSales = compareMap[name].sales || 0;
                    const compCount = compareMap[name].count || 0;
                    const compSalesValue = isCancel ? '-' + formatCurrency(Math.abs(compSales)) : formatCurrency(compSales);

                    if (Math.abs(compSales) > 0) {
                        const diff = ((sales - compSales) / Math.abs(compSales) * 100).toFixed(1);
                        const isUp = parseFloat(diff) >= 0;
                        changeHtml = `<div class="purpose-kpi-trend ${isUp ? 'up' : 'down'}">${isUp ? '↑' : '↓'} ${isUp ? '+' : ''}${diff}%</div>`;

                        // 호버 오버레이 생성 (새 구조)
                        overlayHtml = `
                            <div class="purpose-kpi-overlay">
                                <div class="overlay-year-badge">${compareData.year}년</div>
                                <div class="overlay-label">전년도 실적</div>
                                <div class="overlay-name">${name}</div>
                                <div class="overlay-value">${compSalesValue}</div>
                                <div class="overlay-sub">건수: ${compCount.toLocaleString()}건</div>
                                <div class="overlay-change">증감: <span class="${isUp ? 'up' : 'down'}">${isUp ? '+' : ''}${diff}%</span></div>
                            </div>
                        `;
                    }
                }

                return `
                    <div class="purpose-kpi-card" data-color="${cardColor}" onclick="selectPurpose('${name}')">
                        <div class="purpose-kpi-header">
                            <div class="purpose-kpi-icon">${icons[i % icons.length]}</div>
                            ${changeHtml}
                        </div>
                        <div class="purpose-kpi-name">${name}</div>
                        <div class="purpose-kpi-value">${salesValue}</div>
                        <div class="purpose-kpi-sub">건수: <span>${count.toLocaleString()}건</span></div>
                        ${overlayHtml}
                    </div>
                `;
            }).join('');
        }

        function selectPurpose(name) {
            document.getElementById('purposeSelect').value = name;
            showToast(`"${name}" 선택됨`, 'success');
        }

        // ====== 개인별 탭 관련 변수 및 함수 ======
        let managerSortColumn = 'sales';
        let managerSortOrder = 'desc';
        let perCaseSortOrder = 'desc';
        let selectedManagers = [];
        let monthlyPreset = 'all';

        function updatePersonalTab() {
            const managers = currentData.by_manager || [];
            if (managers.length === 0) return;

            const totalManagers = managers.length;
            const totalSales = managers.reduce((sum, m) => sum + (m[1].sales || 0), 0);
            const avgSales = totalSales / totalManagers;

            // KPI 카드 업데이트
            document.getElementById('personalTotalManagers').textContent = totalManagers + '명';
            document.getElementById('personalAvgSales').textContent = formatCurrency(avgSales);

            // 긴급 최고 요청자 TOP 5
            const urgentTop5 = [...managers]
                .sort((a, b) => (b[1].urgent || 0) - (a[1].urgent || 0))
                .slice(0, 5);

            document.getElementById('personalUrgentTop').innerHTML = urgentTop5.map((m, i) =>
                `<div style="display: flex; gap: 8px; align-items: center; margin-bottom: 3px;">
                    <span style="min-width: 70px;">${i + 1}. ${m[0]}</span>
                    <span style="color: var(--danger); font-weight: 600;">${m[1].urgent || 0}건</span>
                </div>`
            ).join('');

            // 최고 성장자 (전년 비교 시)
            if (compareData && compareData.by_manager) {
                const compareMap = Object.fromEntries(compareData.by_manager);
                const withGrowth = managers.map(m => {
                    const compSales = compareMap[m[0]]?.sales || 0;
                    const growth = compSales > 0 ? ((m[1].sales - compSales) / compSales * 100) : 0;
                    return { name: m[0], growth };
                }).sort((a, b) => b.growth - a.growth);

                if (withGrowth.length > 0) {
                    document.getElementById('personalTopGrowth').textContent = withGrowth[0].name;
                    document.getElementById('personalTopGrowthRate').textContent = '전년 대비 +' + withGrowth[0].growth.toFixed(1) + '%';
                    document.getElementById('topGrowthTrend').style.visibility = 'visible';
                    document.getElementById('topGrowthTrend').innerHTML = '↑ +' + withGrowth[0].growth.toFixed(1) + '%';
                }
            } else {
                document.getElementById('personalTopGrowth').textContent = '-';
                document.getElementById('personalTopGrowthRate').textContent = '전년 비교 필요';
                document.getElementById('topGrowthTrend').style.visibility = 'hidden';
            }

            // 다중 선택 체크박스 목록 생성
            initManagerMultiSelect();

            // 건당 매출/긴급 목적 드롭다운 초기화
            initPerCasePurposeSelect();
            initUrgentPurposeSelect();
            initManagerPurposeFilter();
            initManagerChartPurposeFilter();

            // 차트들 업데이트
            updateEfficiencyChart();
            updateManagerMonthlyChart();
            updatePerCaseChart();
            updateUrgentChart();
            updateUrgentMonthlyChart();
            updateUrgentUnitPriceChart();
            updateDailyClientChart();
        }

        function initManagerMultiSelect() {
            const managers = currentData.by_manager || [];
            const listEl = document.getElementById('managerSelectList');
            if (!listEl) return;
            listEl.innerHTML = managers.map(m =>
                `<label class="multi-select-item">
                    <input type="checkbox" value="${m[0]}" onchange="onManagerCheckChange()">
                    <span>${m[0]}</span>
                </label>`
            ).join('');
            selectedManagers = [];
            updateSelectedCount();
            updateSelectedTags();
        }

        function onManagerCheckChange() {
            const checkboxes = document.querySelectorAll('#managerSelectList input:checked');
            selectedManagers = Array.from(checkboxes).map(cb => cb.value);
            document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
            monthlyPreset = 'custom';
            updateSelectedCount();
            updateSelectedTags();
            updateManagerMonthlyChart();
        }

        function updateSelectedCount() {
            const el = document.getElementById('selectedCount');
            if (el) el.textContent = `(${selectedManagers.length})`;
        }

        function updateSelectedTags() {
            const tagsEl = document.getElementById('selectedManagerTags');
            if (!tagsEl) return;
            if (monthlyPreset === 'all') {
                tagsEl.innerHTML = '<span class="selected-tag">📊 전체 합계</span>';
            } else if (monthlyPreset === 'top3') {
                const top3 = (currentData.by_manager || []).slice(0, 3).map(m => m[0]);
                tagsEl.innerHTML = top3.map(name => `<span class="selected-tag">${name}</span>`).join('');
            } else {
                tagsEl.innerHTML = selectedManagers.map(name =>
                    `<span class="selected-tag">${name} <span class="remove" onclick="removeManager('${name}')">×</span></span>`
                ).join('');
            }
        }

        function removeManager(name) {
            selectedManagers = selectedManagers.filter(n => n !== name);
            const cb = document.querySelector(`#managerSelectList input[value="${name}"]`);
            if (cb) cb.checked = false;
            updateSelectedCount();
            updateSelectedTags();
            updateManagerMonthlyChart();
        }

        function toggleMultiSelect() {
            const list = document.getElementById('managerSelectList');
            if (list) list.style.display = list.style.display === 'none' ? 'block' : 'none';
        }

        function setMonthlyPreset(preset) {
            monthlyPreset = preset;
            document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`.preset-btn[onclick="setMonthlyPreset('${preset}')"]`);
            if (activeBtn) activeBtn.classList.add('active');
            document.querySelectorAll('#managerSelectList input').forEach(cb => cb.checked = false);
            selectedManagers = [];
            updateSelectedCount();
            updateSelectedTags();
            updateManagerMonthlyChart();
        }

        function initPerCasePurposeSelect() {
            const purposes = new Set(['전체']);
            (currentData.by_purpose || []).forEach(p => purposes.add(p[0]));
            const select = document.getElementById('perCasePurposeSelect');
            if (select) {
                select.innerHTML = '<option value="전체">전체 목적</option>' +
                    Array.from(purposes).filter(p => p !== '전체' && p !== '접수취소').map(p =>
                        `<option value="${p}">${p}</option>`
                    ).join('');
            }
        }

        function initUrgentPurposeSelect() {
            const purposes = new Set(['전체']);
            (currentData.by_purpose || []).forEach(p => {
                if (p[0] !== '접수취소') purposes.add(p[0]);
            });
            const select = document.getElementById('urgentPurposeSelect');
            if (select) {
                select.innerHTML = '<option value="전체">검사목적: 전체</option>' +
                    Array.from(purposes).filter(p => p !== '전체').map(p =>
                        `<option value="${p}">${p}</option>`
                    ).join('');
            }
        }

        function initManagerPurposeFilter() {
            const purposes = new Set(['전체']);
            (currentData.by_purpose || []).forEach(p => {
                if (p[0] !== '접수취소') purposes.add(p[0]);
            });
            const select = document.getElementById('managerPurposeFilter');
            if (select) {
                select.innerHTML = '<option value="전체">전체 검사목적</option>' +
                    Array.from(purposes).filter(p => p !== '전체').map(p =>
                        `<option value="${p}">${p}</option>`
                    ).join('');
            }
        }

        function togglePerCaseSort() {
            perCaseSortOrder = perCaseSortOrder === 'desc' ? 'asc' : 'desc';
            const btn = document.getElementById('perCaseSortBtn');
            if (btn) btn.textContent = perCaseSortOrder === 'desc' ? '내림차순 ▼' : '오름차순 ▲';
            updatePerCaseChart();
        }

        // 효율성 분석 산점도 - 외부 HTML 툴팁 생성 함수
        const getOrCreateEfficiencyTooltip = (chart) => {
            let tooltipEl = document.getElementById('efficiencyChartTooltip');
            if (!tooltipEl) {
                tooltipEl = document.createElement('div');
                tooltipEl.id = 'efficiencyChartTooltip';
                tooltipEl.style.cssText = `
                    position: fixed;
                    background: rgba(30, 41, 59, 0.97);
                    border-radius: 12px;
                    padding: 16px;
                    pointer-events: auto;
                    z-index: 99999;
                    font-size: 13px;
                    color: #e2e8f0;
                    min-width: 340px;
                    max-width: 400px;
                    max-height: 85vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.4);
                    transition: opacity 0.15s ease;
                    line-height: 1.5;
                `;
                document.body.appendChild(tooltipEl);
                setupTooltipHover(tooltipEl);
            }
            return tooltipEl;
        };

        // 효율성 분석 산점도
        function updateEfficiencyChart() {
            const ctx = document.getElementById('efficiencyChart');
            if (!ctx) return;
            if (charts.efficiency) charts.efficiency.destroy();

            const managers = currentData.by_manager || [];
            if (managers.length === 0) return;

            const avgCount = managers.reduce((sum, m) => sum + (m[1].count || 0), 0) / managers.length;
            const avgSales = managers.reduce((sum, m) => sum + (m[1].sales || 0), 0) / managers.length;

            // 4분면별 색상 및 테두리
            const quadrantStyles = {
                q1: { bg: 'rgba(234, 179, 8, 0.85)', border: '#fbbf24', label: '스타 플레이어', icon: '🏆' },      // 고건수·고매출: 금색
                q2: { bg: 'rgba(59, 130, 246, 0.85)', border: '#3b82f6', label: '고효율 달성', icon: '💎' },       // 저건수·고매출: 파란색
                q3: { bg: 'rgba(249, 115, 22, 0.85)', border: '#f97316', label: '효율 개선 필요', icon: '⚠️' },    // 고건수·저매출: 주황색
                q4: { bg: 'rgba(220, 38, 38, 0.85)', border: '#dc2626', label: '집중 관리 필요', icon: '🔴' },     // 저건수·저매출: 빨간색
            };

            // 건당 단가 계산 및 순위 산출
            const managersWithPerCase = managers.map(m => {
                const count = m[1].count || 0;
                const sales = m[1].sales || 0;
                const perCase = count > 0 ? sales / count : 0;
                return { name: m[0], count, sales, perCase, data: m[1] };
            });
            const sortedByPerCase = [...managersWithPerCase].sort((a, b) => b.perCase - a.perCase);
            const perCaseRankMap = {};
            sortedByPerCase.forEach((m, i) => { perCaseRankMap[m.name] = i + 1; });
            const avgPerCase = managersWithPerCase.reduce((sum, m) => sum + m.perCase, 0) / managersWithPerCase.length;

            // 전년도 데이터 맵 생성
            const compareManagerMap = {};
            if (compareData && compareData.by_manager) {
                compareData.by_manager.forEach(m => {
                    const count = m[1].count || 0;
                    const sales = m[1].sales || 0;
                    compareManagerMap[m[0]] = { count, sales, perCase: count > 0 ? sales / count : 0 };
                });
            }

            const data = managersWithPerCase.map(m => {
                const isHighCount = m.count >= avgCount;
                const isHighSales = m.sales >= avgSales;
                let quadrant;
                if (isHighCount && isHighSales) quadrant = 'q1';
                else if (!isHighCount && isHighSales) quadrant = 'q2';
                else if (isHighCount && !isHighSales) quadrant = 'q3';
                else quadrant = 'q4';

                return {
                    x: m.count,
                    y: m.sales,
                    name: m.name,
                    perCase: m.perCase,
                    perCaseRank: perCaseRankMap[m.name],
                    quadrant,
                    color: quadrantStyles[quadrant].bg,
                    borderColor: quadrantStyles[quadrant].border,
                    quadrantLabel: quadrantStyles[quadrant].label,
                    quadrantIcon: quadrantStyles[quadrant].icon,
                    compareData: compareManagerMap[m.name] || null,
                    originalData: m.data
                };
            });

            // 데이터셋 구성 (현재 연도)
            const datasets = [{
                label: currentData.year + '년',
                data: data.map(d => ({ x: d.x, y: d.y })),
                backgroundColor: data.map(d => d.color),
                borderColor: data.map(d => d.borderColor),
                borderWidth: 3,
                pointRadius: 12,
                pointHoverRadius: 16,
                customData: data,
            }];

            // 전년도 비교 데이터 추가
            if (compareData && compareData.by_manager) {
                const compManagers = compareData.by_manager || [];
                const compData = compManagers.map(m => ({
                    x: m[1].count || 0,
                    y: m[1].sales || 0,
                    name: m[0],
                    perCase: (m[1].count || 0) > 0 ? (m[1].sales || 0) / (m[1].count || 0) : 0
                }));
                datasets.push({
                    label: compareData.year + '년',
                    data: compData.map(d => ({ x: d.x, y: d.y })),
                    backgroundColor: 'rgba(168, 85, 247, 0.4)',
                    borderColor: 'rgba(168, 85, 247, 0.8)',
                    borderWidth: 2,
                    pointRadius: 9,
                    pointHoverRadius: 12,
                    pointStyle: 'triangle',
                    customData: compData,
                });
            }

            charts.efficiency = new Chart(ctx.getContext('2d'), {
                type: 'scatter',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: true },
                    plugins: {
                        legend: { display: compareData ? true : false, position: 'top' },
                        tooltip: {
                            enabled: false,
                            external: function(context) {
                                const tooltipEl = getOrCreateEfficiencyTooltip(context.chart);
                                const tooltipModel = context.tooltip;

                                if (tooltipModel.opacity === 0 && !isTooltipHovered(tooltipEl)) {
                                    hideTooltipWithDelay(tooltipEl);
                                    return;
                                }

                                if (tooltipModel.dataPoints && tooltipModel.dataPoints.length > 0) {
                                    const dataPoint = tooltipModel.dataPoints[0];
                                    const dsIdx = dataPoint.datasetIndex;
                                    const idx = dataPoint.dataIndex;
                                    const dataset = context.chart.data.datasets[dsIdx];
                                    const customData = dataset.customData;

                                    if (!customData || !customData[idx]) {
                                        hideTooltipWithDelay(tooltipEl);
                                        return;
                                    }

                                    const d = customData[idx];
                                    const isCurrentYear = dsIdx === 0;
                                    const year = isCurrentYear ? currentData.year : compareData?.year;

                                    // 사분면별 테두리 색상
                                    let borderColor = 'rgba(99, 102, 241, 0.5)';
                                    if (isCurrentYear && d.quadrant) {
                                        if (d.quadrant === 'q1') borderColor = '#fbbf24';      // 금색
                                        else if (d.quadrant === 'q2') borderColor = '#3b82f6'; // 파란색
                                        else if (d.quadrant === 'q3') borderColor = '#f97316'; // 주황색
                                        else if (d.quadrant === 'q4') borderColor = '#dc2626'; // 빨간색
                                    }
                                    tooltipEl.style.border = `2px solid ${borderColor}`;

                                    let html = '';

                                    // === 1. 헤더 영역 ===
                                    if (isCurrentYear) {
                                        html += `<div style="font-size: 16px; font-weight: bold; color: #fff; margin-bottom: 8px;">
                                            ${d.name} (${year}년)
                                        </div>`;
                                        html += `<div style="display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 13px; font-weight: 600; margin-bottom: 12px;
                                            background: ${d.quadrant === 'q1' ? 'rgba(234, 179, 8, 0.3)' : d.quadrant === 'q2' ? 'rgba(59, 130, 246, 0.3)' : d.quadrant === 'q3' ? 'rgba(249, 115, 22, 0.3)' : 'rgba(220, 38, 38, 0.3)'};
                                            color: ${d.quadrant === 'q1' ? '#fbbf24' : d.quadrant === 'q2' ? '#60a5fa' : d.quadrant === 'q3' ? '#fb923c' : '#f87171'};">
                                            ${d.quadrantIcon} ${d.quadrantLabel}
                                        </div>`;
                                    } else {
                                        html += `<div style="font-size: 16px; font-weight: bold; color: #a78bfa; margin-bottom: 12px;">
                                            ${d.name} (${year}년)
                                        </div>`;
                                    }

                                    // === 2. 기본 지표 ===
                                    html += `<div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 12px;">`;
                                    html += `<div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                        <span style="color: #94a3b8;">매출:</span>
                                        <span style="font-weight: 600;">${(d.y / 100000000).toFixed(2)}억</span>
                                    </div>`;
                                    html += `<div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                        <span style="color: #94a3b8;">건수:</span>
                                        <span style="font-weight: 600;">${d.x.toLocaleString()}건</span>
                                    </div>`;
                                    html += `<div style="display: flex; justify-content: space-between;">
                                        <span style="color: #94a3b8;">⭐ 건당 단가:</span>
                                        <span style="font-weight: 600; color: #fbbf24;">${(d.perCase / 10000).toFixed(1)}만</span>
                                    </div>`;
                                    html += `</div>`;

                                    // 현재 연도 데이터에만 상세 분석 표시
                                    if (isCurrentYear) {
                                        // === 3. 효율성 분석 ===
                                        html += `<div style="color: #64748b; font-size: 11px; margin: 12px 0 8px 0; text-align: center;">── 효율성 분석 ──</div>`;
                                        html += `<div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 12px;">`;

                                        // 건당 단가 순위
                                        html += `<div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                            <span style="color: #94a3b8;">건당 단가 순위:</span>
                                            <span style="font-weight: 600;">${d.perCaseRank}위 / ${managers.length}명</span>
                                        </div>`;

                                        // 전체 평균 대비
                                        const avgDiff = d.perCase - avgPerCase;
                                        const avgDiffPct = avgPerCase > 0 ? (avgDiff / avgPerCase * 100) : 0;
                                        html += `<div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                            <span style="color: #94a3b8;">평균(${(avgPerCase / 10000).toFixed(1)}만) 대비:</span>
                                            <span style="font-weight: 600; color: ${avgDiff >= 0 ? '#10b981' : '#ef4444'};">
                                                ${avgDiff >= 0 ? '+' : ''}${avgDiffPct.toFixed(1)}%
                                            </span>
                                        </div>`;

                                        // 효율 등급
                                        const efficiencyPercentile = (managers.length - d.perCaseRank + 1) / managers.length * 100;
                                        let effGrade, effGradeLabel;
                                        if (efficiencyPercentile >= 80) {
                                            effGrade = '⭐⭐⭐';
                                            effGradeLabel = '상위 20%';
                                        } else if (efficiencyPercentile >= 20) {
                                            effGrade = '⭐⭐';
                                            effGradeLabel = '중위권';
                                        } else {
                                            effGrade = '⭐';
                                            effGradeLabel = '하위권';
                                        }
                                        html += `<div style="display: flex; justify-content: space-between;">
                                            <span style="color: #94a3b8;">효율 등급:</span>
                                            <span style="font-weight: 600;">${effGrade} <span style="color: #94a3b8; font-size: 11px;">(${effGradeLabel})</span></span>
                                        </div>`;
                                        html += `</div>`;

                                        // === 4. 2024 → 2025 이동 분석 ===
                                        if (d.compareData && compareData) {
                                            const prevData = d.compareData;
                                            html += `<div style="color: #64748b; font-size: 11px; margin: 12px 0 8px 0; text-align: center;">── ${compareData.year} → ${currentData.year} 이동 분석 ──</div>`;
                                            html += `<div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 12px;">`;

                                            // 전년 위치
                                            html += `<div style="margin-bottom: 6px; color: #94a3b8; font-size: 12px;">
                                                ${compareData.year}년 위치: 건수 ${prevData.count.toLocaleString()}건 / 매출 ${(prevData.sales / 100000000).toFixed(2)}억
                                            </div>`;

                                            // 이동 방향 판정
                                            const countUp = d.x >= prevData.count;
                                            const salesUp = d.y >= prevData.sales;
                                            let arrow, direction, dirColor;
                                            if (countUp && salesUp) {
                                                arrow = '↗'; direction = '우상향 (성장+효율 유지)'; dirColor = '#10b981';
                                            } else if (!countUp && salesUp) {
                                                arrow = '↖'; direction = '좌상향 (효율 급상승)'; dirColor = '#3b82f6';
                                            } else if (countUp && !salesUp) {
                                                arrow = '↘'; direction = '우하향 (효율 급하락)'; dirColor = '#f97316';
                                            } else {
                                                arrow = '↙'; direction = '좌하향 (전반적 하락)'; dirColor = '#ef4444';
                                            }
                                            html += `<div style="margin-bottom: 8px; font-size: 14px;">
                                                <span style="font-size: 18px; color: ${dirColor};">${arrow}</span>
                                                <span style="color: ${dirColor}; font-weight: 600;">${direction}</span>
                                            </div>`;

                                            // 변화량
                                            const countChange = d.x - prevData.count;
                                            const countChangePct = prevData.count > 0 ? (countChange / prevData.count * 100) : 0;
                                            const salesChange = d.y - prevData.sales;
                                            const salesChangePct = prevData.sales > 0 ? (salesChange / prevData.sales * 100) : 0;
                                            const effChange = d.perCase - prevData.perCase;
                                            const effChangePct = prevData.perCase > 0 ? (effChange / prevData.perCase * 100) : 0;

                                            html += `<div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                                <span style="color: #94a3b8;">건수 변화:</span>
                                                <span style="color: ${countChange >= 0 ? '#10b981' : '#ef4444'};">
                                                    ${countChange >= 0 ? '+' : ''}${countChange.toLocaleString()}건 (${countChange >= 0 ? '+' : ''}${countChangePct.toFixed(1)}%)
                                                </span>
                                            </div>`;
                                            html += `<div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                                <span style="color: #94a3b8;">매출 변화:</span>
                                                <span style="color: ${salesChange >= 0 ? '#10b981' : '#ef4444'};">
                                                    ${salesChange >= 0 ? '+' : ''}${(salesChange / 100000000).toFixed(2)}억 (${salesChange >= 0 ? '+' : ''}${salesChangePct.toFixed(1)}%)
                                                </span>
                                            </div>`;
                                            html += `<div style="display: flex; justify-content: space-between;">
                                                <span style="color: #94a3b8;">효율 변화:</span>
                                                <span style="color: ${effChange >= 0 ? '#10b981' : '#ef4444'};">
                                                    ${(prevData.perCase / 10000).toFixed(1)}만 → ${(d.perCase / 10000).toFixed(1)}만 (${effChange >= 0 ? '+' : ''}${effChangePct.toFixed(1)}%)
                                                </span>
                                            </div>`;
                                            html += `</div>`;
                                        }

                                        // === 5. 포지션 인사이트 ===
                                        html += `<div style="color: #64748b; font-size: 11px; margin: 12px 0 8px 0; text-align: center;">── 포지션 인사이트 ──</div>`;
                                        html += `<div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 12px;">`;

                                        if (d.quadrant === 'q1') {
                                            // 고건수-고매출: 스타 플레이어
                                            html += `<div style="margin-bottom: 4px;">✅ 건수와 매출 모두 평균 이상 달성</div>`;
                                            html += `<div style="margin-bottom: 8px;">✅ 현재 성과를 유지하며 역할 모델로 활용</div>`;
                                            html += `<div style="color: #fbbf24;">💡 노하우 공유 및 멘토링 역할 추천</div>`;
                                            html += `<div style="color: #fbbf24;">💡 고단가 거래처 추가 확보로 효율 극대화</div>`;
                                        } else if (d.quadrant === 'q2') {
                                            // 저건수-고매출: 고효율 달성
                                            html += `<div style="margin-bottom: 4px;">✅ 높은 건당 단가로 효율적인 영업 수행</div>`;
                                            html += `<div style="margin-bottom: 8px;">⚠️ 건수 증가 시 매출 대폭 상승 가능</div>`;
                                            html += `<div style="color: #60a5fa;">💡 신규 거래처 발굴에 집중 권장</div>`;
                                            html += `<div style="color: #60a5fa;">💡 기존 고객 재구매 유도 전략 검토</div>`;
                                            // 벤치마크 대상 (건수 높은 담당자)
                                            const highCountManager = data.find(m => m.quadrant === 'q1' && m.name !== d.name);
                                            if (highCountManager) {
                                                html += `<div style="margin-top: 6px; color: #94a3b8; font-size: 11px;">📈 벤치마크: ${highCountManager.name} (건수 ${highCountManager.x.toLocaleString()}건)</div>`;
                                            }
                                        } else if (d.quadrant === 'q3') {
                                            // 고건수-저매출: 효율 개선 필요
                                            html += `<div style="margin-bottom: 4px;">⚠️ 활동량은 많으나 건당 단가가 낮음</div>`;
                                            html += `<div style="margin-bottom: 8px;">⚠️ 저단가 거래에 시간 소모 가능성</div>`;
                                            html += `<div style="color: #fb923c;">💡 고단가 검사 항목 교육 및 제안 강화</div>`;
                                            html += `<div style="color: #fb923c;">💡 거래처별 수익성 분석 후 선택과 집중</div>`;
                                            // 벤치마크 대상 (효율 높은 담당자)
                                            const highEffManager = data.find(m => m.quadrant === 'q2' && m.name !== d.name);
                                            if (highEffManager) {
                                                html += `<div style="margin-top: 6px; color: #94a3b8; font-size: 11px;">📈 벤치마크: ${highEffManager.name} (단가 ${(highEffManager.perCase / 10000).toFixed(1)}만)</div>`;
                                            }
                                        } else {
                                            // 저건수-저매출: 집중 관리 필요
                                            html += `<div style="margin-bottom: 4px;">⚠️ 건수와 매출 모두 평균 미달</div>`;
                                            html += `<div style="margin-bottom: 8px;">⚠️ 즉각적인 개선 조치 필요</div>`;
                                            html += `<div style="color: #f87171;">💡 영업 활동량 증대 우선 필요</div>`;
                                            html += `<div style="color: #f87171;">💡 담당 구역/거래처 재검토 권장</div>`;
                                            // 벤치마크 대상
                                            const benchmarkManager = data.find(m => m.quadrant === 'q1' && m.name !== d.name);
                                            if (benchmarkManager) {
                                                html += `<div style="margin-top: 6px; color: #94a3b8; font-size: 11px;">📈 벤치마크: ${benchmarkManager.name}</div>`;
                                            }
                                        }
                                        html += `</div>`;

                                        // === 6. 평균선 대비 거리 ===
                                        html += `<div style="color: #64748b; font-size: 11px; margin: 12px 0 8px 0; text-align: center;">── 평균선 대비 거리 ──</div>`;
                                        html += `<div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 12px;">`;

                                        const countDist = d.x - avgCount;
                                        const salesDist = d.y - avgSales;

                                        html += `<div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                            <span style="color: #94a3b8;">↔️ 건수 평균(${Math.round(avgCount).toLocaleString()}건)까지:</span>
                                            <span style="color: ${countDist >= 0 ? '#10b981' : '#ef4444'};">
                                                ${countDist >= 0 ? '+' + Math.round(countDist).toLocaleString() + '건 초과' : Math.round(Math.abs(countDist)).toLocaleString() + '건 부족'}
                                            </span>
                                        </div>`;
                                        html += `<div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                            <span style="color: #94a3b8;">↕️ 매출 평균(${(avgSales / 100000000).toFixed(2)}억)까지:</span>
                                            <span style="color: ${salesDist >= 0 ? '#10b981' : '#ef4444'};">
                                                ${salesDist >= 0 ? '+' + (salesDist / 100000000).toFixed(2) + '억 초과' : (Math.abs(salesDist) / 100000000).toFixed(2) + '억 부족'}
                                            </span>
                                        </div>`;

                                        // 위치 요약
                                        let positionSummary;
                                        if (d.quadrant === 'q1') positionSummary = '평균 우상단 (우수 영역)';
                                        else if (d.quadrant === 'q2') positionSummary = '평균 좌상단 (고효율 영역)';
                                        else if (d.quadrant === 'q3') positionSummary = '평균 우하단 (개선 영역)';
                                        else positionSummary = '평균 좌하단 (관리 영역)';
                                        html += `<div style="text-align: center; padding: 6px; background: rgba(255,255,255,0.05); border-radius: 6px;">
                                            📍 위치 요약: <strong>${positionSummary}</strong>
                                        </div>`;
                                        html += `</div>`;

                                        // === 7. 개선 시뮬레이션 (저효율 사분면만) ===
                                        if (d.quadrant === 'q3' || d.quadrant === 'q4') {
                                            html += `<div style="color: #64748b; font-size: 11px; margin: 12px 0 8px 0; text-align: center;">── 개선 시뮬레이션 ──</div>`;
                                            html += `<div style="background: rgba(16, 185, 129, 0.1); padding: 10px; border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.3);">`;

                                            // 목표 단가 = 전체 평균 단가
                                            const targetPerCase = avgPerCase;
                                            const projectedSales = d.x * targetPerCase;
                                            const salesIncrease = projectedSales - d.y;

                                            html += `<div style="margin-bottom: 6px;">
                                                🎯 목표 단가(${(targetPerCase / 10000).toFixed(1)}만) 달성 시:
                                                <span style="color: #10b981; font-weight: 600;">예상 매출 ${(projectedSales / 100000000).toFixed(2)}억</span>
                                            </div>`;
                                            html += `<div style="margin-bottom: 6px;">
                                                🎯 효율 상위권 진입 시:
                                                <span style="color: #10b981; font-weight: 600;">+${(salesIncrease / 100000000).toFixed(2)}억 증가</span>
                                            </div>`;

                                            // 목표 사분면
                                            let targetQuadrant;
                                            if (d.quadrant === 'q3') targetQuadrant = 'Q1 (스타 플레이어) 이동';
                                            else targetQuadrant = 'Q2 (고효율 달성) 이동';
                                            html += `<div>📍 목표 위치: <strong style="color: #10b981;">${targetQuadrant}</strong></div>`;

                                            html += `</div>`;
                                        }
                                    }

                                    tooltipEl.innerHTML = html;
                                }

                                // 위치 조정
                                const position = context.chart.canvas.getBoundingClientRect();
                                let left = position.left + window.scrollX + tooltipModel.caretX + 15;
                                let top = position.top + window.scrollY + tooltipModel.caretY - 20;

                                // 오른쪽 경계 체크
                                const tooltipWidth = 400;
                                if (left + tooltipWidth > window.innerWidth - 20) {
                                    left = position.left + window.scrollX + tooltipModel.caretX - tooltipWidth - 15;
                                }
                                // 하단 경계 체크
                                const tooltipHeight = tooltipEl.offsetHeight || 500;
                                if (top + tooltipHeight > window.innerHeight + window.scrollY - 20) {
                                    top = window.innerHeight + window.scrollY - tooltipHeight - 20;
                                }
                                // 상단 경계 체크
                                if (top < window.scrollY + 10) {
                                    top = window.scrollY + 10;
                                }

                                tooltipEl.style.opacity = 1; tooltipEl.style.pointerEvents = 'auto';
                                tooltipEl.style.left = left + 'px';
                                tooltipEl.style.top = top + 'px';
                            }
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: '건수' }, grid: { color: 'rgba(0,0,0,0.05)' } },
                        y: { title: { display: true, text: '매출 (공급가액)' }, ticks: { callback: v => formatCurrency(v) }, grid: { color: 'rgba(0,0,0,0.05)' } }
                    }
                }
            });
        }

        // 담당자별 월별 매출 추이
        function updateManagerMonthlyChart() {
            const ctx = document.getElementById('managerMonthlyChart');
            if (!ctx) return;
            if (charts.managerMonthly) charts.managerMonthly.destroy();

            const labels = ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'];
            const colors = ['#6366f1', '#10b981', '#f59e0b', '#ec4899', '#06b6d4', '#8b5cf6', '#ef4444', '#14b8a6', '#f97316', '#84cc16'];
            const managers = currentData.by_manager || [];

            // 요약 정보 계산 및 표시
            const summaryEl = document.getElementById('mgrMonthlySummary');
            if (summaryEl) {
                const monthMap = Object.fromEntries(currentData.by_month || []);
                let totalSales = 0, totalCount = 0, monthsWithData = 0;
                Object.values(monthMap).forEach(m => {
                    totalSales += m.sales || 0;
                    totalCount += m.count || 0;
                    if ((m.sales || 0) > 0) monthsWithData++;
                });
                const avgSales = monthsWithData > 0 ? totalSales / monthsWithData : 0;
                const avgPrice = totalCount > 0 ? totalSales / totalCount : 0;

                // 전년도 비교
                let compTotalSales = 0, compTotalCount = 0;
                if (compareData && compareData.by_month) {
                    const compMonthMap = Object.fromEntries(compareData.by_month || []);
                    Object.values(compMonthMap).forEach(m => {
                        compTotalSales += m.sales || 0;
                        compTotalCount += m.count || 0;
                    });
                }

                let html = `<span style="white-space:nowrap;background:#dbeafe;padding:4px 10px;border-radius:4px;color:#1e40af;"><strong style="color:#3b82f6;">${currentData.year}년:</strong> ${(totalSales / 100000000).toFixed(1)}억</span>`;
                if (compareData && compTotalSales > 0) {
                    const salesGrowth = ((totalSales - compTotalSales) / compTotalSales * 100);
                    const growthSign = salesGrowth >= 0 ? '+' : '';
                    const growthColor = salesGrowth >= 0 ? '#059669' : '#dc2626';
                    html += `<span style="white-space:nowrap;background:#fef3c7;padding:4px 10px;border-radius:4px;color:#92400e;"><strong style="color:#f59e0b;">${compareData.year}년:</strong> ${(compTotalSales / 100000000).toFixed(1)}억</span>`;
                    html += `<span style="white-space:nowrap;background:${salesGrowth >= 0 ? '#d1fae5' : '#fee2e2'};padding:4px 10px;border-radius:4px;color:${growthColor};">증감: <strong>${growthSign}${salesGrowth.toFixed(1)}%</strong></span>`;
                }
                html += `<span style="white-space:nowrap;background:#e0e7ff;padding:4px 10px;border-radius:4px;color:#3730a3;">건수: <strong>${totalCount.toLocaleString()}건</strong></span>`;
                html += `<span style="white-space:nowrap;background:#fce7f3;padding:4px 10px;border-radius:4px;color:#9d174d;">월평균: <strong>${(avgSales / 100000000).toFixed(2)}억</strong></span>`;
                html += `<span style="white-space:nowrap;background:#fef08a;padding:4px 10px;border-radius:4px;color:#854d0e;">단가: <strong>${Math.round(avgPrice / 10000).toLocaleString()}만</strong></span>`;
                summaryEl.innerHTML = html;
            }

            if (monthlyPreset === 'all') {
                // 전체 합계 - 월별 데이터 사용 (매출, 건수, 검사목적 포함)
                const monthMap = Object.fromEntries(currentData.by_month || []);
                const monthlyInfo = labels.map((_, i) => {
                    const m = monthMap[i+1] || {};
                    return {
                        sales: m.sales || 0,
                        count: m.count || 0,
                        perCase: (m.count > 0) ? (m.sales / m.count) : 0,
                        byPurpose: m.byPurpose || {}
                    };
                });
                const totalMonthly = monthlyInfo.map(m => m.sales);
                const nonZeroSales = totalMonthly.filter(v => v > 0);
                const ownAvg = nonZeroSales.length > 0 ? nonZeroSales.reduce((a,b) => a+b, 0) / nonZeroSales.length : 0;

                // 검사목적별 월평균 계산 (매출 + 건수)
                const purposeAvg = {};
                const purposeAvgCount = {};
                const allPurposes = new Set();
                monthlyInfo.forEach(m => Object.keys(m.byPurpose).forEach(p => allPurposes.add(p)));
                allPurposes.forEach(purpose => {
                    const salesValues = monthlyInfo.map(m => m.byPurpose[purpose]?.sales || 0);
                    const countValues = monthlyInfo.map(m => m.byPurpose[purpose]?.count || 0);
                    const nonZeroSales = salesValues.filter(v => v > 0);
                    const nonZeroCount = countValues.filter(v => v > 0);
                    purposeAvg[purpose] = nonZeroSales.length > 0 ? nonZeroSales.reduce((a,b) => a+b, 0) / nonZeroSales.length : 0;
                    purposeAvgCount[purpose] = nonZeroCount.length > 0 ? nonZeroCount.reduce((a,b) => a+b, 0) / nonZeroCount.length : 0;
                });

                // 데이터셋 구성
                const datasets = [{
                    label: currentData.year + '년 전체',
                    data: totalMonthly,
                    monthlyInfo,
                    ownAvg,
                    borderColor: '#6366f1',
                    backgroundColor: 'rgba(99, 102, 241, 0.2)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 8,
                    pointHoverRadius: 12,
                    pointStyle: totalMonthly.map(v => v < ownAvg ? 'triangle' : 'circle'),
                    pointBackgroundColor: totalMonthly.map(v => v < ownAvg ? '#ef4444' : '#6366f1'),
                    isComparison: false,
                }];

                // 전년도 비교 데이터 추가
                if (compareData && compareData.by_month) {
                    const compMonthMap = Object.fromEntries(compareData.by_month || []);
                    const compMonthlyInfo = labels.map((_, i) => {
                        const m = compMonthMap[i+1] || {};
                        return {
                            sales: m.sales || 0,
                            count: m.count || 0,
                            perCase: (m.count > 0) ? (m.sales / m.count) : 0,
                            byPurpose: m.byPurpose || {}
                        };
                    });
                    datasets.push({
                        label: compareData.year + '년 전체',
                        data: compMonthlyInfo.map(m => m.sales),
                        monthlyInfo: compMonthlyInfo,
                        borderColor: 'rgba(156, 163, 175, 0.8)',
                        backgroundColor: 'rgba(156, 163, 175, 0.1)',
                        fill: false,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: 'rgba(156, 163, 175, 0.8)',
                        borderDash: [5, 5],
                        isComparison: true,
                    });
                }

                // 외부 HTML 툴팁 생성 함수 (개인별탭 - 전체 모드)
                const getOrCreateMgrMonthlyTooltip = (chart) => {
                    let tooltipEl = document.getElementById('mgrMonthlyChartTooltip');
                    if (!tooltipEl) {
                        tooltipEl = document.createElement('div');
                        tooltipEl.id = 'mgrMonthlyChartTooltip';
                        tooltipEl.style.cssText = `
                            position: fixed;
                            background: rgba(30, 41, 59, 0.98);
                            border-radius: 12px;
                            padding: 16px;
                            pointer-events: auto;
                            z-index: 99999;
                            font-size: 13px;
                            color: #e2e8f0;
                            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
                            min-width: 340px;
                            max-width: 400px;
                            max-height: 85vh;
                            overflow-y: auto;
                            transition: opacity 0.15s ease;
                            line-height: 1.5;
                        `;
                        document.body.appendChild(tooltipEl);
                setupTooltipHover(tooltipEl);
                    }
                    return tooltipEl;
                };

                // 추세 계산 함수
                const calcTrendAll = (monthIdx, monthlyInfo) => {
                    let upCount = 0, downCount = 0;
                    for (let i = monthIdx; i > 0; i--) {
                        if (monthlyInfo[i].sales > monthlyInfo[i-1].sales) {
                            if (downCount > 0) break;
                            upCount++;
                        } else if (monthlyInfo[i].sales < monthlyInfo[i-1].sales) {
                            if (upCount > 0) break;
                            downCount++;
                        } else break;
                    }
                    return upCount > 0 ? { type: 'up', count: upCount } : { type: 'down', count: downCount };
                };

                // 외부 툴팁 핸들러 (전체 모드)
                const externalTooltipHandlerAll = (context) => {
                    const { chart, tooltip } = context;
                    const tooltipEl = getOrCreateMgrMonthlyTooltip(chart);

                    if (tooltip.opacity === 0 && !isTooltipHovered(tooltipEl)) {
                        hideTooltipWithDelay(tooltipEl);
                        return;
                    }

                    if (tooltip.body && tooltip.dataPoints && tooltip.dataPoints.length > 0) {
                        const dp = tooltip.dataPoints[0];
                        const monthIdx = dp.dataIndex;
                        const ds = dp.dataset;
                        const info = ds.monthlyInfo?.[monthIdx];
                        if (!info) return;

                        const isComparison = ds.isComparison;
                        const isIncrease = !isComparison && ds.ownAvg && info.sales >= ds.ownAvg;
                        const borderColor = isIncrease ? 'rgba(99, 102, 241, 0.8)' : 'rgba(239, 68, 68, 0.8)';
                        tooltipEl.style.border = `2px solid ${borderColor}`;

                        let html = '';

                        // 1. 헤더
                        const headerBg = isIncrease ? 'rgba(99, 102, 241, 0.3)' : 'rgba(239, 68, 68, 0.3)';
                        const yearLabel = isComparison ? compareData.year : currentData.year;
                        html += `<div style="font-size: 16px; font-weight: bold; color: #fff; margin: -16px -16px 12px -16px; padding: 12px 16px; background: ${headerBg}; border-radius: 10px 10px 0 0;">📅 ${yearLabel}년 ${monthIdx + 1}월 ${isComparison ? '(비교)' : ''}</div>`;

                        // 2. 기본 지표 - 모든 연도 표시 (다중 비교 지원)
                        const tooltipYearColors = ['#60a5fa', '#f59e0b', '#8b5cf6', '#10b981', '#ef4444'];
                        html += `<div style="margin-bottom: 4px;">💰 ${currentData.year}년 매출: <strong style="color:${tooltipYearColors[0]};">${(info.sales / 100000000).toFixed(2)}억</strong></div>`;
                        html += `<div style="margin-bottom: 4px;">📋 ${currentData.year}년 건수: <strong>${info.count.toLocaleString()}건</strong> | 건당: <strong>${formatCurrency(Math.round(info.perCase))}</strong></div>`;

                        // 모든 비교 연도 데이터 표시
                        if (compareDataList && compareDataList.length > 0) {
                            compareDataList.forEach((compData, compIdx) => {
                                const compMonthMap = Object.fromEntries(compData.by_month || []);
                                const compInfo = compMonthMap[monthIdx + 1];
                                const colorIdx = (compIdx + 1) % tooltipYearColors.length;
                                if (compInfo && compInfo.sales > 0) {
                                    const compPerCase = compInfo.count > 0 ? compInfo.sales / compInfo.count : 0;
                                    html += `<div style="margin-bottom: 4px;">💰 ${compData.year}년 매출: <strong style="color:${tooltipYearColors[colorIdx]};">${(compInfo.sales / 100000000).toFixed(2)}억</strong></div>`;
                                    html += `<div style="margin-bottom: 4px;">📋 ${compData.year}년 건수: <strong>${compInfo.count.toLocaleString()}건</strong> | 건당: <strong>${formatCurrency(Math.round(compPerCase))}</strong></div>`;
                                }
                            });
                        } else if (compareData) {
                            const compMonthMapForBasic = Object.fromEntries(compareData.by_month || []);
                            const compInfoForBasic = compMonthMapForBasic[monthIdx + 1];
                            if (compInfoForBasic && compInfoForBasic.sales > 0) {
                                const compPerCase = compInfoForBasic.sales / compInfoForBasic.count;
                                html += `<div style="margin-bottom: 4px;">💰 ${compareData.year}년 매출: <strong style="color:#f59e0b;">${(compInfoForBasic.sales / 100000000).toFixed(2)}억</strong></div>`;
                                html += `<div style="margin-bottom: 8px;">📋 ${compareData.year}년 건수: <strong>${compInfoForBasic.count.toLocaleString()}건</strong> | 건당: <strong>${formatCurrency(Math.round(compPerCase))}</strong></div>`;
                            }
                        }

                        if (!isComparison && ds.ownAvg) {
                            // 3. 비교 분석
                            html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 비교 분석 ──</div>`;

                            // 월평균 대비
                            const avgDiff = info.sales - ds.ownAvg;
                            const avgDiffPct = ds.ownAvg > 0 ? (avgDiff / ds.ownAvg * 100) : 0;
                            const avgColor = avgDiff >= 0 ? '#10b981' : '#ef4444';
                            const avgSign = avgDiff >= 0 ? '+' : '';
                            html += `<div style="margin-bottom: 4px;">📊 월평균 대비: <span style="color: ${avgColor}; font-weight: bold;">${avgSign}${avgDiffPct.toFixed(1)}% (${avgSign}${(avgDiff / 10000).toFixed(0)}만)</span></div>`;

                            // 각 비교 연도 동월 대비
                            if (compareDataList && compareDataList.length > 0) {
                                compareDataList.forEach((compData) => {
                                    const compMonthMap = Object.fromEntries(compData.by_month || []);
                                    const compInfo = compMonthMap[monthIdx + 1];
                                    if (compInfo && compInfo.sales > 0) {
                                        const yoyDiff = info.sales - compInfo.sales;
                                        const yoyPct = (yoyDiff / compInfo.sales * 100);
                                        const yoyColor = yoyDiff >= 0 ? '#10b981' : '#ef4444';
                                        const yoySign = yoyDiff >= 0 ? '+' : '';
                                        html += `<div style="margin-bottom: 4px;">📆 ${compData.year}년 대비: <span style="color: ${yoyColor}; font-weight: bold;">${yoySign}${yoyPct.toFixed(1)}% (${yoySign}${(yoyDiff / 10000).toFixed(0)}만)</span></div>`;
                                    }
                                });
                            } else if (compareData) {
                                const compMonthMapForBasic = Object.fromEntries(compareData.by_month || []);
                                const compInfoForBasic = compMonthMapForBasic[monthIdx + 1];
                                if (compInfoForBasic && compInfoForBasic.sales > 0) {
                                    const yoyDiff = info.sales - compInfoForBasic.sales;
                                    const yoyPct = (yoyDiff / compInfoForBasic.sales * 100);
                                    const yoyColor = yoyDiff >= 0 ? '#10b981' : '#ef4444';
                                    const yoySign = yoyDiff >= 0 ? '+' : '';
                                    html += `<div style="margin-bottom: 4px;">📆 전년 동월 대비: <span style="color: ${yoyColor}; font-weight: bold;">${yoySign}${yoyPct.toFixed(1)}% (${yoySign}${(yoyDiff / 10000).toFixed(0)}만)</span></div>`;
                                }
                            }

                            // 전월 대비
                            if (monthIdx > 0 && ds.monthlyInfo[monthIdx - 1].sales > 0) {
                                const prevInfo = ds.monthlyInfo[monthIdx - 1];
                                const momDiff = info.sales - prevInfo.sales;
                                const momPct = (momDiff / prevInfo.sales * 100);
                                const momColor = momDiff >= 0 ? '#10b981' : '#ef4444';
                                const momSign = momDiff >= 0 ? '+' : '';

                                // 추세
                                const trend = calcTrendAll(monthIdx, ds.monthlyInfo);
                                let trendText = '';
                                if (trend.count >= 2) {
                                    const trendIcon = trend.type === 'up' ? '↗' : '↘';
                                    const trendColor = trend.type === 'up' ? '#10b981' : '#ef4444';
                                    trendText = ` <span style="color: ${trendColor};">${trendIcon} ${trend.count}개월 연속${trend.type === 'up' ? '↑' : '↓'}</span>`;
                                }
                                html += `<div style="margin-bottom: 8px;">📈 전월 대비: <span style="color: ${momColor}; font-weight: bold;">${momSign}${momPct.toFixed(1)}%</span>${trendText}</div>`;

                                // 4. 변화 원인 분해
                                const countEffect = (info.count - prevInfo.count) * prevInfo.perCase;
                                const priceEffect = (info.perCase - prevInfo.perCase) * info.count;
                                const totalChange = info.sales - prevInfo.sales;

                                html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 변화 원인 분해 ──</div>`;

                                const countColor = countEffect >= 0 ? '#10b981' : '#ef4444';
                                const countSign = countEffect >= 0 ? '+' : '';
                                const countPct = totalChange !== 0 ? Math.abs(countEffect / totalChange * 100) : 0;
                                html += `<div style="margin-bottom: 4px;">📋 건수 효과: <span style="color: ${countColor};">${countSign}${(countEffect / 10000).toFixed(0)}만</span> <span style="color: #94a3b8;">(${countPct.toFixed(0)}%)</span></div>`;

                                const priceColor = priceEffect >= 0 ? '#10b981' : '#ef4444';
                                const priceSign = priceEffect >= 0 ? '+' : '';
                                const pricePct = totalChange !== 0 ? Math.abs(priceEffect / totalChange * 100) : 0;
                                html += `<div style="margin-bottom: 4px;">💵 단가 효과: <span style="color: ${priceColor};">${priceSign}${(priceEffect / 10000).toFixed(0)}만</span> <span style="color: #94a3b8;">(${pricePct.toFixed(0)}%)</span></div>`;

                                const mainCause = Math.abs(countEffect) > Math.abs(priceEffect) ? '건수' : '단가';
                                const causeDirection = (mainCause === '건수' ? countEffect : priceEffect) >= 0 ? '증가' : '감소';
                                html += `<div style="color: #60a5fa; font-size: 11px; margin-top: 4px;">→ ${mainCause} ${causeDirection}가 주요 원인</div>`;
                            }

                            // 5. 증감 요인 (검사목적별) - 건수, 매출, 단가 상세 분석
                            const purposeChanges = Object.entries(info.byPurpose || {}).map(([purpose, data]) => {
                                const avgP = purposeAvg[purpose] || 0;
                                const avgPCount = purposeAvgCount?.[purpose] || 0;
                                const salesDiff = data.sales - avgP;
                                const countDiff = (data.count || 0) - avgPCount;
                                const avgPrice = data.count > 0 ? data.sales / data.count : 0;
                                const avgPriceAvg = avgPCount > 0 ? avgP / avgPCount : 0;
                                const priceDiff = avgPrice - avgPriceAvg;
                                const salesDiffPct = avgP > 0 ? (salesDiff / avgP * 100) : (data.sales > 0 ? 100 : 0);
                                const countDiffPct = avgPCount > 0 ? (countDiff / avgPCount * 100) : (data.count > 0 ? 100 : 0);
                                return {
                                    purpose,
                                    sales: data.sales,
                                    count: data.count || 0,
                                    avgPrice,
                                    avgPriceAvg,
                                    priceDiff,
                                    salesDiff,
                                    countDiff,
                                    salesDiffPct,
                                    countDiffPct
                                };
                            }).sort((a, b) => b.salesDiff - a.salesDiff);

                            // 전체 증감 합계 계산
                            const allIncreases = purposeChanges.filter(p => p.salesDiff > 0);
                            const allDecreases = purposeChanges.filter(p => p.salesDiff < 0);
                            const totalIncrease = allIncreases.reduce((sum, p) => sum + p.salesDiff, 0);
                            const totalDecrease = allDecreases.reduce((sum, p) => sum + p.salesDiff, 0);

                            // 건수 증가했지만 단가 하락으로 매출 감소한 항목 (단가 효과)
                            const priceDropItems = purposeChanges.filter(p => p.salesDiff < 0 && p.countDiff > 0);
                            // 건수 감소로 매출 감소한 항목 (건수 효과)
                            const countDropItems = purposeChanges.filter(p => p.salesDiff < 0 && p.countDiff <= 0);

                            const topIncreases = allIncreases.slice(0, 3);
                            const topDecreases = allDecreases.slice(0, 5);

                            if (isIncrease && topIncreases.length > 0) {
                                const top3Sum = topIncreases.reduce((sum, p) => sum + p.salesDiff, 0);
                                const explainPct = totalIncrease > 0 ? (top3Sum / totalIncrease * 100) : 0;
                                html += `<div style="color: #10b981; margin: 12px 0 6px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2); font-weight: 600;">▲ 증가 요인 TOP ${topIncreases.length} <span style="font-weight: normal; font-size: 11px; color: #94a3b8;">(전체 +${(totalIncrease/10000).toFixed(0)}만 중 ${explainPct.toFixed(0)}%)</span></div>`;
                                topIncreases.forEach(p => {
                                    const countColor = p.countDiff >= 0 ? '#10b981' : '#ef4444';
                                    const countSign = p.countDiff >= 0 ? '+' : '';
                                    html += `<div style="margin-left: 8px; margin-bottom: 6px; padding: 6px 8px; background: rgba(16, 185, 129, 0.1); border-radius: 6px; border-left: 3px solid #10b981;">
                                        <div style="font-weight: 600; margin-bottom: 4px;">• ${p.purpose}</div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 11px;">
                                            <div>📋 건수: <span style="color: ${countColor};">${countSign}${p.countDiff.toLocaleString()}건</span> <span style="color: #94a3b8;">(${countSign}${p.countDiffPct.toFixed(0)}%)</span></div>
                                            <div>💰 매출: <span style="color: #10b981;">+${(p.salesDiff / 10000).toFixed(0)}만</span></div>
                                            <div>💵 단가: ${formatCurrency(Math.round(p.avgPrice))}</div>
                                            <div>📊 현재: ${p.count.toLocaleString()}건 / ${(p.sales / 10000).toFixed(0)}만</div>
                                        </div>
                                    </div>`;
                                });
                                // 기타 증가분
                                if (allIncreases.length > 3) {
                                    const otherSum = totalIncrease - top3Sum;
                                    html += `<div style="margin-left: 8px; color: #94a3b8; font-size: 11px;">+ 기타 ${allIncreases.length - 3}개 항목: +${(otherSum/10000).toFixed(0)}만</div>`;
                                }
                            } else if (!isIncrease && topDecreases.length > 0) {
                                const topSum = topDecreases.reduce((sum, p) => sum + p.salesDiff, 0);
                                const explainPct = totalDecrease < 0 ? (topSum / totalDecrease * 100) : 0;
                                html += `<div style="color: #ef4444; margin: 12px 0 6px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2); font-weight: 600;">▼ 감소 요인 TOP ${topDecreases.length} <span style="font-weight: normal; font-size: 11px; color: #94a3b8;">(전체 ${(totalDecrease/10000).toFixed(0)}만 중 ${explainPct.toFixed(0)}%)</span></div>`;

                                // 건수 감소로 인한 매출 감소
                                const countDropInTop = topDecreases.filter(p => p.countDiff <= 0);
                                if (countDropInTop.length > 0) {
                                    html += `<div style="color: #f97316; font-size: 11px; margin: 4px 0 6px 8px;">📉 건수 감소 영향:</div>`;
                                    countDropInTop.forEach(p => {
                                        const countSign = p.countDiff >= 0 ? '+' : '';
                                        html += `<div style="margin-left: 8px; margin-bottom: 6px; padding: 6px 8px; background: rgba(239, 68, 68, 0.1); border-radius: 6px; border-left: 3px solid #ef4444;">
                                            <div style="font-weight: 600; margin-bottom: 4px;">• ${p.purpose}</div>
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 11px;">
                                                <div>📋 건수: <span style="color: #ef4444;">${countSign}${p.countDiff.toLocaleString()}건</span> <span style="color: #94a3b8;">(${countSign}${p.countDiffPct.toFixed(0)}%)</span></div>
                                                <div>💰 매출: <span style="color: #ef4444;">${(p.salesDiff / 10000).toFixed(0)}만</span></div>
                                                <div>💵 단가: ${formatCurrency(Math.round(p.avgPrice))}</div>
                                                <div>📊 현재: ${p.count.toLocaleString()}건 / ${(p.sales / 10000).toFixed(0)}만</div>
                                            </div>
                                        </div>`;
                                    });
                                }

                                // 단가 하락으로 인한 매출 감소 (건수는 증가)
                                const priceDropInTop = topDecreases.filter(p => p.countDiff > 0);
                                if (priceDropInTop.length > 0) {
                                    html += `<div style="color: #a855f7; font-size: 11px; margin: 8px 0 6px 8px;">💸 단가 하락 영향 (건수↑ 단가↓):</div>`;
                                    priceDropInTop.forEach(p => {
                                        html += `<div style="margin-left: 8px; margin-bottom: 6px; padding: 6px 8px; background: rgba(168, 85, 247, 0.1); border-radius: 6px; border-left: 3px solid #a855f7;">
                                            <div style="font-weight: 600; margin-bottom: 4px;">• ${p.purpose}</div>
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 11px;">
                                                <div>📋 건수: <span style="color: #10b981;">+${p.countDiff.toLocaleString()}건</span> <span style="color: #94a3b8;">(+${p.countDiffPct.toFixed(0)}%)</span></div>
                                                <div>💰 매출: <span style="color: #ef4444;">${(p.salesDiff / 10000).toFixed(0)}만</span></div>
                                                <div>💵 단가: ${formatCurrency(Math.round(p.avgPrice))} <span style="color: #ef4444;">(↓${formatCurrency(Math.round(Math.abs(p.priceDiff)))})</span></div>
                                                <div>📊 현재: ${p.count.toLocaleString()}건 / ${(p.sales / 10000).toFixed(0)}만</div>
                                            </div>
                                        </div>`;
                                    });
                                }

                                // 기타 감소분
                                if (allDecreases.length > 5) {
                                    const otherSum = totalDecrease - topSum;
                                    html += `<div style="margin-left: 8px; margin-top: 6px; color: #94a3b8; font-size: 11px;">+ 기타 ${allDecreases.length - 5}개 항목: ${(otherSum/10000).toFixed(0)}만</div>`;
                                }
                            }

                            // 6. YTD 누적 현황
                            const ytdSales = ds.monthlyInfo.slice(0, monthIdx + 1).reduce((s, m) => s + m.sales, 0);
                            let ytdCompSales = 0;
                            if (compareData && compareData.by_month) {
                                const compMonthMap = Object.fromEntries(compareData.by_month || []);
                                for (let i = 1; i <= monthIdx + 1; i++) {
                                    ytdCompSales += compMonthMap[i]?.sales || 0;
                                }
                            }
                            const ytdYoyPct = ytdCompSales > 0 ? ((ytdSales - ytdCompSales) / ytdCompSales * 100) : 0;

                            html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── YTD 누적 현황 ──</div>`;
                            html += `<div style="margin-bottom: 4px;">📊 1~${monthIdx + 1}월 누적: <strong>${(ytdSales / 100000000).toFixed(2)}억</strong></div>`;

                            if (ytdCompSales > 0) {
                                const ytdYoyColor = ytdYoyPct >= 0 ? '#10b981' : '#ef4444';
                                const ytdYoySign = ytdYoyPct >= 0 ? '+' : '';
                                html += `<div style="margin-bottom: 4px;">📅 전년 동기 대비: <span style="color: ${ytdYoyColor}; font-weight: bold;">${ytdYoySign}${ytdYoyPct.toFixed(1)}%</span></div>`;
                            }
                        }

                        tooltipEl.innerHTML = html;
                    }

                    // 위치 계산
                    const canvasRect = chart.canvas.getBoundingClientRect();
                    let left = canvasRect.left + tooltip.caretX + 15;
                    let top = canvasRect.top + tooltip.caretY - 10;

                    const tooltipWidth = tooltipEl.offsetWidth || 380;
                    if (left + tooltipWidth > window.innerWidth - 20) {
                        left = canvasRect.left + tooltip.caretX - tooltipWidth - 15;
                    }

                    const tooltipHeight = tooltipEl.offsetHeight || 500;
                    if (top + tooltipHeight > window.innerHeight - 20) {
                        top = window.innerHeight - tooltipHeight - 20;
                    }
                    if (top < 10) top = 10;

                    tooltipEl.style.opacity = 1; tooltipEl.style.pointerEvents = 'auto';
                    tooltipEl.style.left = left + 'px';
                    tooltipEl.style.top = top + 'px';
                };

                charts.managerMonthly = new Chart(ctx.getContext('2d'), {
                    type: 'line',
                    data: { labels, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                    interaction: { intersect: true },
                        plugins: {
                            legend: { display: compareData ? true : false, position: 'top' },
                            tooltip: {
                                enabled: false,
                                external: externalTooltipHandlerAll
                            }
                        },
                        scales: { y: { ticks: { callback: v => formatCurrency(v) } } }
                    }
                });
            } else if (monthlyPreset === 'top3') {
                // TOP 3 - by_month의 byManager 실제 데이터 사용
                const monthMap = Object.fromEntries(currentData.by_month || []);
                const top3Labels = managers.slice(0, 3).map(m => m[0]);

                // 현재 연도 데이터셋 (매출, 건수, 검사목적, 자체 월평균 포함)
                const datasets = top3Labels.map((name, i) => {
                    const monthlyInfo = labels.map((_, mi) => {
                        const monthData = monthMap[mi+1];
                        const mgrData = monthData?.byManager?.[name];
                        const sales = mgrData?.sales || 0;
                        const count = mgrData?.count || 0;
                        const byPurpose = mgrData?.byPurpose || {};
                        return { sales, count, perCase: count > 0 ? sales / count : 0, byPurpose };
                    });
                    const salesArr = monthlyInfo.map(d => d.sales);
                    const nonZeroSales = salesArr.filter(v => v > 0);
                    const ownAvg = nonZeroSales.length > 0 ? nonZeroSales.reduce((a,b) => a+b, 0) / nonZeroSales.length : 0;
                    return {
                        label: name,
                        data: salesArr,
                        monthlyInfo,
                        ownAvg,
                        borderColor: colors[i],
                        backgroundColor: colors[i] + '20',
                        fill: false,
                        tension: 0.4,
                        pointRadius: 5,
                        isComparison: false,
                    };
                });

                // 담당자별 검사목적별 월평균 계산 (매출 + 건수)
                const managerPurposeAvg = {};
                const managerPurposeAvgCount = {};
                datasets.filter(ds => !ds.isComparison).forEach(ds => {
                    managerPurposeAvg[ds.label] = {};
                    managerPurposeAvgCount[ds.label] = {};
                    const allPurposes = new Set();
                    ds.monthlyInfo.forEach(m => Object.keys(m.byPurpose).forEach(p => allPurposes.add(p)));
                    allPurposes.forEach(purpose => {
                        const salesValues = ds.monthlyInfo.map(m => m.byPurpose[purpose]?.sales || 0);
                        const countValues = ds.monthlyInfo.map(m => m.byPurpose[purpose]?.count || 0);
                        const nonZeroSales = salesValues.filter(v => v > 0);
                        const nonZeroCount = countValues.filter(v => v > 0);
                        managerPurposeAvg[ds.label][purpose] = nonZeroSales.length > 0 ? nonZeroSales.reduce((a,b) => a+b, 0) / nonZeroSales.length : 0;
                        managerPurposeAvgCount[ds.label][purpose] = nonZeroCount.length > 0 ? nonZeroCount.reduce((a,b) => a+b, 0) / nonZeroCount.length : 0;
                    });
                });

                // 전년도 비교 데이터 추가
                if (compareData && compareData.by_month) {
                    const compMonthMap = Object.fromEntries(compareData.by_month || []);
                    top3Labels.forEach((name, i) => {
                        const monthlyInfo = labels.map((_, mi) => {
                            const monthData = compMonthMap[mi+1];
                            const mgrData = monthData?.byManager?.[name];
                            const sales = mgrData?.sales || 0;
                            const count = mgrData?.count || 0;
                            const byPurpose = mgrData?.byPurpose || {};
                            return { sales, count, perCase: count > 0 ? sales / count : 0, byPurpose };
                        });
                        datasets.push({
                            label: name + ' (' + compareData.year + ')',
                            data: monthlyInfo.map(d => d.sales),
                            monthlyInfo,
                            borderColor: colors[i] + '60',
                            backgroundColor: 'transparent',
                            fill: false,
                            tension: 0.4,
                            pointRadius: 3,
                            borderDash: [5, 5],
                            isComparison: true,
                        });
                    });
                }

                // 외부 HTML 툴팁 생성 함수 (개인별탭 - TOP3 모드)
                const getOrCreateMgrMonthlyTooltipTop3 = (chart) => {
                    let tooltipEl = document.getElementById('mgrMonthlyChartTooltipTop3');
                    if (!tooltipEl) {
                        tooltipEl = document.createElement('div');
                        tooltipEl.id = 'mgrMonthlyChartTooltipTop3';
                        tooltipEl.style.cssText = `
                            position: fixed;
                            background: rgba(30, 41, 59, 0.98);
                            border-radius: 12px;
                            padding: 16px;
                            pointer-events: auto;
                            z-index: 99999;
                            font-size: 13px;
                            color: #e2e8f0;
                            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
                            min-width: 340px;
                            max-width: 400px;
                            max-height: 85vh;
                            overflow-y: auto;
                            transition: opacity 0.15s ease;
                            line-height: 1.5;
                        `;
                        document.body.appendChild(tooltipEl);
                setupTooltipHover(tooltipEl);
                    }
                    return tooltipEl;
                };

                // 추세 계산 함수 (TOP3)
                const calcTrendTop3 = (monthIdx, monthlyInfo) => {
                    let upCount = 0, downCount = 0;
                    for (let i = monthIdx; i > 0; i--) {
                        if (monthlyInfo[i].sales > monthlyInfo[i-1].sales) {
                            if (downCount > 0) break;
                            upCount++;
                        } else if (monthlyInfo[i].sales < monthlyInfo[i-1].sales) {
                            if (upCount > 0) break;
                            downCount++;
                        } else break;
                    }
                    return upCount > 0 ? { type: 'up', count: upCount } : { type: 'down', count: downCount };
                };

                // 외부 툴팁 핸들러 (TOP3 모드)
                const externalTooltipHandlerTop3 = (context) => {
                    const { chart, tooltip } = context;
                    const tooltipEl = getOrCreateMgrMonthlyTooltipTop3(chart);

                    if (tooltip.opacity === 0 && !isTooltipHovered(tooltipEl)) {
                        hideTooltipWithDelay(tooltipEl);
                        return;
                    }

                    if (tooltip.body && tooltip.dataPoints && tooltip.dataPoints.length > 0) {
                        const dp = tooltip.dataPoints[0];
                        const monthIdx = dp.dataIndex;
                        const ds = dp.dataset;
                        const info = ds.monthlyInfo?.[monthIdx];
                        if (!info) return;

                        const isComparison = ds.isComparison;
                        const managerName = ds.label.replace(/ [(]\\d{4}[)]$/, '');
                        const isIncrease = !isComparison && ds.ownAvg && info.sales >= ds.ownAvg;
                        const borderColor = isIncrease ? 'rgba(99, 102, 241, 0.8)' : 'rgba(239, 68, 68, 0.8)';
                        tooltipEl.style.border = `2px solid ${borderColor}`;

                        let html = '';

                        // 1. 헤더
                        const headerBg = isIncrease ? 'rgba(99, 102, 241, 0.3)' : 'rgba(239, 68, 68, 0.3)';
                        const yearLabel = isComparison ? compareData.year : currentData.year;
                        html += `<div style="font-size: 16px; font-weight: bold; color: #fff; margin: -16px -16px 12px -16px; padding: 12px 16px; background: ${headerBg}; border-radius: 10px 10px 0 0;">👤 ${managerName} - ${yearLabel}년 ${monthIdx + 1}월</div>`;

                        // 2. 기본 지표 - 모든 연도 표시 (다중 비교 지원)
                        const tooltipYearColors = ['#60a5fa', '#f59e0b', '#8b5cf6', '#10b981', '#ef4444'];
                        html += `<div style="margin-bottom: 4px;">💰 ${currentData.year}년 매출: <strong style="color:${tooltipYearColors[0]};">${(info.sales / 100000000).toFixed(2)}억</strong></div>`;
                        html += `<div style="margin-bottom: 4px;">📋 ${currentData.year}년 건수: <strong>${info.count.toLocaleString()}건</strong> | 건당: <strong>${formatCurrency(Math.round(info.perCase))}</strong></div>`;

                        // 모든 비교 연도 데이터 표시
                        const compInfoList = [];
                        if (compareDataList && compareDataList.length > 0) {
                            compareDataList.forEach((compData, compIdx) => {
                                const compMonthMap = Object.fromEntries(compData.by_month || []);
                                const compMonthData = compMonthMap[monthIdx + 1];
                                const compInfo = compMonthData?.byManager?.[managerName];
                                const colorIdx = (compIdx + 1) % tooltipYearColors.length;
                                compInfoList.push({ year: compData.year, info: compInfo, colorIdx });
                                if (compInfo && compInfo.sales > 0) {
                                    const compPerCase = compInfo.count > 0 ? compInfo.sales / compInfo.count : 0;
                                    html += `<div style="margin-bottom: 4px;">💰 ${compData.year}년 매출: <strong style="color:${tooltipYearColors[colorIdx]};">${(compInfo.sales / 100000000).toFixed(2)}억</strong></div>`;
                                    html += `<div style="margin-bottom: 4px;">📋 ${compData.year}년 건수: <strong>${compInfo.count.toLocaleString()}건</strong> | 건당: <strong>${formatCurrency(Math.round(compPerCase))}</strong></div>`;
                                }
                            });
                        } else if (compareData && compareData.by_month) {
                            const compMonthMapBasic = Object.fromEntries(compareData.by_month || []);
                            const compMonthDataBasic = compMonthMapBasic[monthIdx + 1];
                            const compInfoForManager = compMonthDataBasic?.byManager?.[managerName];
                            compInfoList.push({ year: compareData.year, info: compInfoForManager, colorIdx: 1 });
                            if (compInfoForManager && compInfoForManager.sales > 0) {
                                const compPerCase = compInfoForManager.sales / compInfoForManager.count;
                                html += `<div style="margin-bottom: 4px;">💰 ${compareData.year}년 매출: <strong style="color:#f59e0b;">${(compInfoForManager.sales / 100000000).toFixed(2)}억</strong></div>`;
                                html += `<div style="margin-bottom: 8px;">📋 ${compareData.year}년 건수: <strong>${compInfoForManager.count.toLocaleString()}건</strong> | 건당: <strong>${formatCurrency(Math.round(compPerCase))}</strong></div>`;
                            }
                        }

                        if (!isComparison && ds.ownAvg) {
                            // 3. 비교 분석
                            html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 비교 분석 ──</div>`;

                            // 월평균 대비
                            const avgDiff = info.sales - ds.ownAvg;
                            const avgDiffPct = ds.ownAvg > 0 ? (avgDiff / ds.ownAvg * 100) : 0;
                            const avgColor = avgDiff >= 0 ? '#10b981' : '#ef4444';
                            const avgSign = avgDiff >= 0 ? '+' : '';
                            html += `<div style="margin-bottom: 4px;">📊 자체 월평균 대비: <span style="color: ${avgColor}; font-weight: bold;">${avgSign}${avgDiffPct.toFixed(1)}% (${avgSign}${(avgDiff / 10000).toFixed(0)}만)</span></div>`;

                            // 각 비교 연도 동월 대비 (해당 담당자)
                            compInfoList.forEach((compItem) => {
                                if (compItem.info && compItem.info.sales > 0) {
                                    const yoyDiff = info.sales - compItem.info.sales;
                                    const yoyPct = (yoyDiff / compItem.info.sales * 100);
                                    const yoyColor = yoyDiff >= 0 ? '#10b981' : '#ef4444';
                                    const yoySign = yoyDiff >= 0 ? '+' : '';
                                    html += `<div style="margin-bottom: 4px;">📆 ${compItem.year}년 대비: <span style="color: ${yoyColor}; font-weight: bold;">${yoySign}${yoyPct.toFixed(1)}% (${yoySign}${(yoyDiff / 10000).toFixed(0)}만)</span></div>`;
                                }
                            });

                            // 전월 대비
                            if (monthIdx > 0 && ds.monthlyInfo[monthIdx - 1].sales > 0) {
                                const prevInfo = ds.monthlyInfo[monthIdx - 1];
                                const momDiff = info.sales - prevInfo.sales;
                                const momPct = (momDiff / prevInfo.sales * 100);
                                const momColor = momDiff >= 0 ? '#10b981' : '#ef4444';
                                const momSign = momDiff >= 0 ? '+' : '';

                                // 추세
                                const trend = calcTrendTop3(monthIdx, ds.monthlyInfo);
                                let trendText = '';
                                if (trend.count >= 2) {
                                    const trendIcon = trend.type === 'up' ? '↗' : '↘';
                                    const trendColor = trend.type === 'up' ? '#10b981' : '#ef4444';
                                    trendText = ` <span style="color: ${trendColor};">${trendIcon} ${trend.count}개월 연속${trend.type === 'up' ? '↑' : '↓'}</span>`;
                                }
                                html += `<div style="margin-bottom: 8px;">📈 전월 대비: <span style="color: ${momColor}; font-weight: bold;">${momSign}${momPct.toFixed(1)}%</span>${trendText}</div>`;

                                // 4. 변화 원인 분해
                                const countEffect = (info.count - prevInfo.count) * prevInfo.perCase;
                                const priceEffect = (info.perCase - prevInfo.perCase) * info.count;
                                const totalChange = info.sales - prevInfo.sales;

                                html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 변화 원인 분해 ──</div>`;

                                const countColor = countEffect >= 0 ? '#10b981' : '#ef4444';
                                const countSign = countEffect >= 0 ? '+' : '';
                                const countPct = totalChange !== 0 ? Math.abs(countEffect / totalChange * 100) : 0;
                                html += `<div style="margin-bottom: 4px;">📋 건수 효과: <span style="color: ${countColor};">${countSign}${(countEffect / 10000).toFixed(0)}만</span> <span style="color: #94a3b8;">(${countPct.toFixed(0)}%)</span></div>`;

                                const priceColor = priceEffect >= 0 ? '#10b981' : '#ef4444';
                                const priceSign = priceEffect >= 0 ? '+' : '';
                                const pricePct = totalChange !== 0 ? Math.abs(priceEffect / totalChange * 100) : 0;
                                html += `<div style="margin-bottom: 4px;">💵 단가 효과: <span style="color: ${priceColor};">${priceSign}${(priceEffect / 10000).toFixed(0)}만</span> <span style="color: #94a3b8;">(${pricePct.toFixed(0)}%)</span></div>`;

                                const mainCause = Math.abs(countEffect) > Math.abs(priceEffect) ? '건수' : '단가';
                                const causeDirection = (mainCause === '건수' ? countEffect : priceEffect) >= 0 ? '증가' : '감소';
                                html += `<div style="color: #60a5fa; font-size: 11px; margin-top: 4px;">→ ${mainCause} ${causeDirection}가 주요 원인</div>`;
                            }

                            // 5. 증감 요인 (검사목적별) - 건수, 매출, 단가 상세 분석
                            const purposeAvgT3 = managerPurposeAvg[managerName] || {};
                            const purposeAvgCntT3 = managerPurposeAvgCount[managerName] || {};
                            const purposeChangesT3 = Object.entries(info.byPurpose || {}).map(([purpose, data]) => {
                                const avgP = purposeAvgT3[purpose] || 0;
                                const avgPCount = purposeAvgCntT3[purpose] || 0;
                                const salesDiff = data.sales - avgP;
                                const countDiff = (data.count || 0) - avgPCount;
                                const avgPrice = data.count > 0 ? data.sales / data.count : 0;
                                const avgPriceAvg = avgPCount > 0 ? avgP / avgPCount : 0;
                                const priceDiff = avgPrice - avgPriceAvg;
                                const salesDiffPct = avgP > 0 ? (salesDiff / avgP * 100) : (data.sales > 0 ? 100 : 0);
                                const countDiffPct = avgPCount > 0 ? (countDiff / avgPCount * 100) : (data.count > 0 ? 100 : 0);
                                return {
                                    purpose,
                                    sales: data.sales,
                                    count: data.count || 0,
                                    avgPrice,
                                    avgPriceAvg,
                                    priceDiff,
                                    salesDiff,
                                    countDiff,
                                    salesDiffPct,
                                    countDiffPct
                                };
                            }).sort((a, b) => b.salesDiff - a.salesDiff);

                            // 전체 증감 합계 계산
                            const allIncreasesT3 = purposeChangesT3.filter(p => p.salesDiff > 0);
                            const allDecreasesT3 = purposeChangesT3.filter(p => p.salesDiff < 0);
                            const totalIncreaseT3 = allIncreasesT3.reduce((sum, p) => sum + p.salesDiff, 0);
                            const totalDecreaseT3 = allDecreasesT3.reduce((sum, p) => sum + p.salesDiff, 0);

                            const topIncreasesT3 = allIncreasesT3.slice(0, 3);
                            const topDecreasesT3 = allDecreasesT3.slice(0, 5);

                            if (isIncrease && topIncreasesT3.length > 0) {
                                const top3Sum = topIncreasesT3.reduce((sum, p) => sum + p.salesDiff, 0);
                                const explainPct = totalIncreaseT3 > 0 ? (top3Sum / totalIncreaseT3 * 100) : 0;
                                html += `<div style="color: #10b981; margin: 12px 0 6px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2); font-weight: 600;">▲ 증가 요인 TOP ${topIncreasesT3.length} <span style="font-weight: normal; font-size: 11px; color: #94a3b8;">(전체 +${(totalIncreaseT3/10000).toFixed(0)}만 중 ${explainPct.toFixed(0)}%)</span></div>`;
                                topIncreasesT3.forEach(p => {
                                    const countColor = p.countDiff >= 0 ? '#10b981' : '#ef4444';
                                    const countSign = p.countDiff >= 0 ? '+' : '';
                                    html += `<div style="margin-left: 8px; margin-bottom: 6px; padding: 6px 8px; background: rgba(16, 185, 129, 0.1); border-radius: 6px; border-left: 3px solid #10b981;">
                                        <div style="font-weight: 600; margin-bottom: 4px;">• ${p.purpose}</div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 11px;">
                                            <div>📋 건수: <span style="color: ${countColor};">${countSign}${p.countDiff.toLocaleString()}건</span> <span style="color: #94a3b8;">(${countSign}${p.countDiffPct.toFixed(0)}%)</span></div>
                                            <div>💰 매출: <span style="color: #10b981;">+${(p.salesDiff / 10000).toFixed(0)}만</span></div>
                                            <div>💵 단가: ${formatCurrency(Math.round(p.avgPrice))}</div>
                                            <div>📊 현재: ${p.count.toLocaleString()}건 / ${(p.sales / 10000).toFixed(0)}만</div>
                                        </div>
                                    </div>`;
                                });
                                if (allIncreasesT3.length > 3) {
                                    const otherSum = totalIncreaseT3 - top3Sum;
                                    html += `<div style="margin-left: 8px; color: #94a3b8; font-size: 11px;">+ 기타 ${allIncreasesT3.length - 3}개 항목: +${(otherSum/10000).toFixed(0)}만</div>`;
                                }
                            } else if (!isIncrease && topDecreasesT3.length > 0) {
                                const topSum = topDecreasesT3.reduce((sum, p) => sum + p.salesDiff, 0);
                                const explainPct = totalDecreaseT3 < 0 ? (topSum / totalDecreaseT3 * 100) : 0;
                                html += `<div style="color: #ef4444; margin: 12px 0 6px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2); font-weight: 600;">▼ 감소 요인 TOP ${topDecreasesT3.length} <span style="font-weight: normal; font-size: 11px; color: #94a3b8;">(전체 ${(totalDecreaseT3/10000).toFixed(0)}만 중 ${explainPct.toFixed(0)}%)</span></div>`;

                                // 건수 감소로 인한 매출 감소
                                const countDropInTopT3 = topDecreasesT3.filter(p => p.countDiff <= 0);
                                if (countDropInTopT3.length > 0) {
                                    html += `<div style="color: #f97316; font-size: 11px; margin: 4px 0 6px 8px;">📉 건수 감소 영향:</div>`;
                                    countDropInTopT3.forEach(p => {
                                        const countSign = p.countDiff >= 0 ? '+' : '';
                                        html += `<div style="margin-left: 8px; margin-bottom: 6px; padding: 6px 8px; background: rgba(239, 68, 68, 0.1); border-radius: 6px; border-left: 3px solid #ef4444;">
                                            <div style="font-weight: 600; margin-bottom: 4px;">• ${p.purpose}</div>
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 11px;">
                                                <div>📋 건수: <span style="color: #ef4444;">${countSign}${p.countDiff.toLocaleString()}건</span> <span style="color: #94a3b8;">(${countSign}${p.countDiffPct.toFixed(0)}%)</span></div>
                                                <div>💰 매출: <span style="color: #ef4444;">${(p.salesDiff / 10000).toFixed(0)}만</span></div>
                                                <div>💵 단가: ${formatCurrency(Math.round(p.avgPrice))}</div>
                                                <div>📊 현재: ${p.count.toLocaleString()}건 / ${(p.sales / 10000).toFixed(0)}만</div>
                                            </div>
                                        </div>`;
                                    });
                                }

                                // 단가 하락으로 인한 매출 감소 (건수는 증가)
                                const priceDropInTopT3 = topDecreasesT3.filter(p => p.countDiff > 0);
                                if (priceDropInTopT3.length > 0) {
                                    html += `<div style="color: #a855f7; font-size: 11px; margin: 8px 0 6px 8px;">💸 단가 하락 영향 (건수↑ 단가↓):</div>`;
                                    priceDropInTopT3.forEach(p => {
                                        html += `<div style="margin-left: 8px; margin-bottom: 6px; padding: 6px 8px; background: rgba(168, 85, 247, 0.1); border-radius: 6px; border-left: 3px solid #a855f7;">
                                            <div style="font-weight: 600; margin-bottom: 4px;">• ${p.purpose}</div>
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 11px;">
                                                <div>📋 건수: <span style="color: #10b981;">+${p.countDiff.toLocaleString()}건</span> <span style="color: #94a3b8;">(+${p.countDiffPct.toFixed(0)}%)</span></div>
                                                <div>💰 매출: <span style="color: #ef4444;">${(p.salesDiff / 10000).toFixed(0)}만</span></div>
                                                <div>💵 단가: ${formatCurrency(Math.round(p.avgPrice))} <span style="color: #ef4444;">(↓${formatCurrency(Math.round(Math.abs(p.priceDiff)))})</span></div>
                                                <div>📊 현재: ${p.count.toLocaleString()}건 / ${(p.sales / 10000).toFixed(0)}만</div>
                                            </div>
                                        </div>`;
                                    });
                                }

                                if (allDecreasesT3.length > 5) {
                                    const otherSum = totalDecreaseT3 - topSum;
                                    html += `<div style="margin-left: 8px; margin-top: 6px; color: #94a3b8; font-size: 11px;">+ 기타 ${allDecreasesT3.length - 5}개 항목: ${(otherSum/10000).toFixed(0)}만</div>`;
                                }
                            }

                            // 6. YTD 누적 현황
                            const ytdSales = ds.monthlyInfo.slice(0, monthIdx + 1).reduce((s, m) => s + m.sales, 0);
                            let ytdCompSales = 0;
                            if (compareData && compareData.by_month) {
                                const compMonthMap = Object.fromEntries(compareData.by_month || []);
                                for (let i = 1; i <= monthIdx + 1; i++) {
                                    const compMonthData = compMonthMap[i];
                                    ytdCompSales += compMonthData?.byManager?.[managerName]?.sales || 0;
                                }
                            }
                            const ytdYoyPct = ytdCompSales > 0 ? ((ytdSales - ytdCompSales) / ytdCompSales * 100) : 0;

                            html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── YTD 누적 현황 ──</div>`;
                            html += `<div style="margin-bottom: 4px;">📊 1~${monthIdx + 1}월 누적: <strong>${(ytdSales / 100000000).toFixed(2)}억</strong></div>`;

                            if (ytdCompSales > 0) {
                                const ytdYoyColor = ytdYoyPct >= 0 ? '#10b981' : '#ef4444';
                                const ytdYoySign = ytdYoyPct >= 0 ? '+' : '';
                                html += `<div style="margin-bottom: 4px;">📅 전년 동기 대비: <span style="color: ${ytdYoyColor}; font-weight: bold;">${ytdYoySign}${ytdYoyPct.toFixed(1)}%</span></div>`;
                            }
                        }

                        tooltipEl.innerHTML = html;
                    }

                    // 위치 계산
                    const canvasRect = chart.canvas.getBoundingClientRect();
                    let left = canvasRect.left + tooltip.caretX + 15;
                    let top = canvasRect.top + tooltip.caretY - 10;

                    const tooltipWidth = tooltipEl.offsetWidth || 380;
                    if (left + tooltipWidth > window.innerWidth - 20) {
                        left = canvasRect.left + tooltip.caretX - tooltipWidth - 15;
                    }

                    const tooltipHeight = tooltipEl.offsetHeight || 500;
                    if (top + tooltipHeight > window.innerHeight - 20) {
                        top = window.innerHeight - tooltipHeight - 20;
                    }
                    if (top < 10) top = 10;

                    tooltipEl.style.opacity = 1; tooltipEl.style.pointerEvents = 'auto';
                    tooltipEl.style.left = left + 'px';
                    tooltipEl.style.top = top + 'px';
                };

                charts.managerMonthly = new Chart(ctx.getContext('2d'), {
                    type: 'line',
                    data: { labels, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                    interaction: { intersect: true },
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: {
                                enabled: false,
                                external: externalTooltipHandlerTop3
                            }
                        },
                        scales: { y: { ticks: { callback: v => formatCurrency(v) } } }
                    }
                });
            } else {
                if (selectedManagers.length === 0) {
                    charts.managerMonthly = new Chart(ctx.getContext('2d'), {
                        type: 'line',
                        data: { labels, datasets: [] },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                    interaction: { intersect: true },
                            plugins: { title: { display: true, text: '담당자를 선택해주세요', font: { size: 14 } } }
                        }
                    });
                } else {
                    const monthMap = Object.fromEntries(currentData.by_month || []);

                    // 현재 연도 데이터셋 (매출, 건수, 검사목적, 자체 월평균 포함)
                    const datasets = selectedManagers.map((name, i) => {
                        const monthlyInfo = labels.map((_, mi) => {
                            const monthData = monthMap[mi+1];
                            const mgrData = monthData?.byManager?.[name];
                            const sales = mgrData?.sales || 0;
                            const count = mgrData?.count || 0;
                            const byPurpose = mgrData?.byPurpose || {};
                            return { sales, count, perCase: count > 0 ? sales / count : 0, byPurpose };
                        });
                        const salesArr = monthlyInfo.map(d => d.sales);
                        const nonZeroSales = salesArr.filter(v => v > 0);
                        const ownAvg = nonZeroSales.length > 0 ? nonZeroSales.reduce((a,b) => a+b, 0) / nonZeroSales.length : 0;
                        return {
                            label: name,
                            data: salesArr,
                            monthlyInfo,
                            ownAvg,
                            borderColor: colors[i % colors.length],
                            backgroundColor: colors[i % colors.length] + '20',
                            fill: false,
                            tension: 0.4,
                            pointRadius: 5,
                            isComparison: false,
                        };
                    });

                    // 담당자별 검사목적별 월평균 계산 (매출 + 건수)
                    const managerPurposeAvg = {};
                    const managerPurposeAvgCount = {};
                    datasets.forEach(ds => {
                        managerPurposeAvg[ds.label] = {};
                        managerPurposeAvgCount[ds.label] = {};
                        const allPurposes = new Set();
                        ds.monthlyInfo.forEach(m => Object.keys(m.byPurpose).forEach(p => allPurposes.add(p)));
                        allPurposes.forEach(purpose => {
                            const salesValues = ds.monthlyInfo.map(m => m.byPurpose[purpose]?.sales || 0);
                            const countValues = ds.monthlyInfo.map(m => m.byPurpose[purpose]?.count || 0);
                            const nonZeroSales = salesValues.filter(v => v > 0);
                            const nonZeroCount = countValues.filter(v => v > 0);
                            managerPurposeAvg[ds.label][purpose] = nonZeroSales.length > 0 ? nonZeroSales.reduce((a,b) => a+b, 0) / nonZeroSales.length : 0;
                            managerPurposeAvgCount[ds.label][purpose] = nonZeroCount.length > 0 ? nonZeroCount.reduce((a,b) => a+b, 0) / nonZeroCount.length : 0;
                        });
                    });

                    // 전년도 비교 데이터 추가
                    if (compareData && compareData.by_month) {
                        const compMonthMap = Object.fromEntries(compareData.by_month || []);
                        selectedManagers.forEach((name, i) => {
                            const monthlyInfo = labels.map((_, mi) => {
                                const monthData = compMonthMap[mi+1];
                                const mgrData = monthData?.byManager?.[name];
                                const sales = mgrData?.sales || 0;
                                const count = mgrData?.count || 0;
                                const byPurpose = mgrData?.byPurpose || {};
                                return { sales, count, perCase: count > 0 ? sales / count : 0, byPurpose };
                            });
                            datasets.push({
                                label: name + ' (' + compareData.year + ')',
                                data: monthlyInfo.map(d => d.sales),
                                monthlyInfo,
                                borderColor: colors[i % colors.length] + '60',
                                backgroundColor: 'transparent',
                                fill: false,
                                tension: 0.4,
                                pointRadius: 3,
                                borderDash: [5, 5],
                                isComparison: true,
                            });
                        });
                    }

                    // 외부 HTML 툴팁 생성 함수 (개인별탭 - 선택 모드)
                    const getOrCreateMgrMonthlyTooltipSelected = (chart) => {
                        let tooltipEl = document.getElementById('mgrMonthlyChartTooltipSelected');
                        if (!tooltipEl) {
                            tooltipEl = document.createElement('div');
                            tooltipEl.id = 'mgrMonthlyChartTooltipSelected';
                            tooltipEl.style.cssText = `
                                position: fixed;
                                background: rgba(30, 41, 59, 0.98);
                                border-radius: 12px;
                                padding: 16px;
                                pointer-events: auto;
                                z-index: 99999;
                                font-size: 13px;
                                color: #e2e8f0;
                                box-shadow: 0 20px 40px rgba(0,0,0,0.4);
                                min-width: 340px;
                                max-width: 400px;
                                transition: opacity 0.15s ease;
                                line-height: 1.5;
                            `;
                            document.body.appendChild(tooltipEl);
                setupTooltipHover(tooltipEl);
                        }
                        return tooltipEl;
                    };

                    // 추세 계산 함수 (선택)
                    const calcTrendSelected = (monthIdx, monthlyInfo) => {
                        let upCount = 0, downCount = 0;
                        for (let i = monthIdx; i > 0; i--) {
                            if (monthlyInfo[i].sales > monthlyInfo[i-1].sales) {
                                if (downCount > 0) break;
                                upCount++;
                            } else if (monthlyInfo[i].sales < monthlyInfo[i-1].sales) {
                                if (upCount > 0) break;
                                downCount++;
                            } else break;
                        }
                        return upCount > 0 ? { type: 'up', count: upCount } : { type: 'down', count: downCount };
                    };

                    // 외부 툴팁 핸들러 (선택 모드)
                    const externalTooltipHandlerSelected = (context) => {
                        const { chart, tooltip } = context;
                        const tooltipEl = getOrCreateMgrMonthlyTooltipSelected(chart);

                        if (tooltip.opacity === 0 && !isTooltipHovered(tooltipEl)) {
                            hideTooltipWithDelay(tooltipEl);
                            return;
                        }

                        if (tooltip.body && tooltip.dataPoints && tooltip.dataPoints.length > 0) {
                            const dp = tooltip.dataPoints[0];
                            const monthIdx = dp.dataIndex;
                            const ds = dp.dataset;
                            const info = ds.monthlyInfo?.[monthIdx];
                            if (!info) return;

                            const isComparison = ds.isComparison;
                            const managerName = ds.label.replace(/ [(]\\d{4}[)]$/, '');
                            const isIncrease = !isComparison && ds.ownAvg && info.sales >= ds.ownAvg;
                            const borderColor = isIncrease ? 'rgba(99, 102, 241, 0.8)' : 'rgba(239, 68, 68, 0.8)';
                            tooltipEl.style.border = `2px solid ${borderColor}`;

                            let html = '';

                            // 1. 헤더
                            const headerBg = isIncrease ? 'rgba(99, 102, 241, 0.3)' : 'rgba(239, 68, 68, 0.3)';
                            const yearLabel = isComparison ? compareData.year : currentData.year;
                            html += `<div style="font-size: 16px; font-weight: bold; color: #fff; margin: -16px -16px 12px -16px; padding: 12px 16px; background: ${headerBg}; border-radius: 10px 10px 0 0;">👤 ${managerName} - ${yearLabel}년 ${monthIdx + 1}월</div>`;

                            // 2. 기본 지표 - 모든 연도 표시 (다중 비교 지원)
                            const tooltipYearColors = ['#60a5fa', '#f59e0b', '#8b5cf6', '#10b981', '#ef4444'];
                            html += `<div style="margin-bottom: 4px;">💰 ${currentData.year}년 매출: <strong style="color:${tooltipYearColors[0]};">${(info.sales / 100000000).toFixed(2)}억</strong></div>`;
                            html += `<div style="margin-bottom: 4px;">📋 ${currentData.year}년 건수: <strong>${info.count.toLocaleString()}건</strong> | 건당: <strong>${formatCurrency(Math.round(info.perCase))}</strong></div>`;

                            // 모든 비교 연도 데이터 표시
                            const compInfoListSel = [];
                            if (compareDataList && compareDataList.length > 0) {
                                compareDataList.forEach((compData, compIdx) => {
                                    const compMonthMap = Object.fromEntries(compData.by_month || []);
                                    const compMonthData = compMonthMap[monthIdx + 1];
                                    const compInfo = compMonthData?.byManager?.[managerName];
                                    const colorIdx = (compIdx + 1) % tooltipYearColors.length;
                                    compInfoListSel.push({ year: compData.year, info: compInfo, colorIdx });
                                    if (compInfo && compInfo.sales > 0) {
                                        const compPerCase = compInfo.count > 0 ? compInfo.sales / compInfo.count : 0;
                                        html += `<div style="margin-bottom: 4px;">💰 ${compData.year}년 매출: <strong style="color:${tooltipYearColors[colorIdx]};">${(compInfo.sales / 100000000).toFixed(2)}억</strong></div>`;
                                        html += `<div style="margin-bottom: 4px;">📋 ${compData.year}년 건수: <strong>${compInfo.count.toLocaleString()}건</strong> | 건당: <strong>${formatCurrency(Math.round(compPerCase))}</strong></div>`;
                                    }
                                });
                            } else if (compareData && compareData.by_month) {
                                const compMonthMapB = Object.fromEntries(compareData.by_month || []);
                                const compMonthDataB = compMonthMapB[monthIdx + 1];
                                const compInfoForMgr = compMonthDataB?.byManager?.[managerName];
                                compInfoListSel.push({ year: compareData.year, info: compInfoForMgr, colorIdx: 1 });
                                if (compInfoForMgr && compInfoForMgr.sales > 0) {
                                    const compPerCaseM = compInfoForMgr.sales / compInfoForMgr.count;
                                    html += `<div style="margin-bottom: 4px;">💰 ${compareData.year}년 매출: <strong style="color:#f59e0b;">${(compInfoForMgr.sales / 100000000).toFixed(2)}억</strong></div>`;
                                    html += `<div style="margin-bottom: 8px;">📋 ${compareData.year}년 건수: <strong>${compInfoForMgr.count.toLocaleString()}건</strong> | 건당: <strong>${formatCurrency(Math.round(compPerCaseM))}</strong></div>`;
                                }
                            }

                            if (!isComparison && ds.ownAvg) {
                                // 3. 비교 분석
                                html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 비교 분석 ──</div>`;

                                // 월평균 대비
                                const avgDiff = info.sales - ds.ownAvg;
                                const avgDiffPct = ds.ownAvg > 0 ? (avgDiff / ds.ownAvg * 100) : 0;
                                const avgColor = avgDiff >= 0 ? '#10b981' : '#ef4444';
                                const avgSign = avgDiff >= 0 ? '+' : '';
                                html += `<div style="margin-bottom: 4px;">📊 자체 월평균 대비: <span style="color: ${avgColor}; font-weight: bold;">${avgSign}${avgDiffPct.toFixed(1)}% (${avgSign}${(avgDiff / 10000).toFixed(0)}만)</span></div>`;

                                // 각 비교 연도 동월 대비 (해당 담당자)
                                compInfoListSel.forEach((compItem) => {
                                    if (compItem.info && compItem.info.sales > 0) {
                                        const yoyDiff = info.sales - compItem.info.sales;
                                        const yoyPct = (yoyDiff / compItem.info.sales * 100);
                                        const yoyColor = yoyDiff >= 0 ? '#10b981' : '#ef4444';
                                        const yoySign = yoyDiff >= 0 ? '+' : '';
                                        html += `<div style="margin-bottom: 4px;">📆 ${compItem.year}년 대비: <span style="color: ${yoyColor}; font-weight: bold;">${yoySign}${yoyPct.toFixed(1)}% (${yoySign}${(yoyDiff / 10000).toFixed(0)}만)</span></div>`;
                                    }
                                });

                                // 전월 대비
                                if (monthIdx > 0 && ds.monthlyInfo[monthIdx - 1].sales > 0) {
                                    const prevInfo = ds.monthlyInfo[monthIdx - 1];
                                    const momDiff = info.sales - prevInfo.sales;
                                    const momPct = (momDiff / prevInfo.sales * 100);
                                    const momColor = momDiff >= 0 ? '#10b981' : '#ef4444';
                                    const momSign = momDiff >= 0 ? '+' : '';

                                    // 추세
                                    const trend = calcTrendSelected(monthIdx, ds.monthlyInfo);
                                    let trendText = '';
                                    if (trend.count >= 2) {
                                        const trendIcon = trend.type === 'up' ? '↗' : '↘';
                                        const trendColor = trend.type === 'up' ? '#10b981' : '#ef4444';
                                        trendText = ` <span style="color: ${trendColor};">${trendIcon} ${trend.count}개월 연속${trend.type === 'up' ? '↑' : '↓'}</span>`;
                                    }
                                    html += `<div style="margin-bottom: 8px;">📈 전월 대비: <span style="color: ${momColor}; font-weight: bold;">${momSign}${momPct.toFixed(1)}%</span>${trendText}</div>`;

                                    // 4. 변화 원인 분해
                                    const countEffect = (info.count - prevInfo.count) * prevInfo.perCase;
                                    const priceEffect = (info.perCase - prevInfo.perCase) * info.count;
                                    const totalChange = info.sales - prevInfo.sales;

                                    html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 변화 원인 분해 ──</div>`;

                                    const countColor = countEffect >= 0 ? '#10b981' : '#ef4444';
                                    const countSign = countEffect >= 0 ? '+' : '';
                                    const countPct = totalChange !== 0 ? Math.abs(countEffect / totalChange * 100) : 0;
                                    html += `<div style="margin-bottom: 4px;">📋 건수 효과: <span style="color: ${countColor};">${countSign}${(countEffect / 10000).toFixed(0)}만</span> <span style="color: #94a3b8;">(${countPct.toFixed(0)}%)</span></div>`;

                                    const priceColor = priceEffect >= 0 ? '#10b981' : '#ef4444';
                                    const priceSign = priceEffect >= 0 ? '+' : '';
                                    const pricePct = totalChange !== 0 ? Math.abs(priceEffect / totalChange * 100) : 0;
                                    html += `<div style="margin-bottom: 4px;">💵 단가 효과: <span style="color: ${priceColor};">${priceSign}${(priceEffect / 10000).toFixed(0)}만</span> <span style="color: #94a3b8;">(${pricePct.toFixed(0)}%)</span></div>`;

                                    const mainCause = Math.abs(countEffect) > Math.abs(priceEffect) ? '건수' : '단가';
                                    const causeDirection = (mainCause === '건수' ? countEffect : priceEffect) >= 0 ? '증가' : '감소';
                                    html += `<div style="color: #60a5fa; font-size: 11px; margin-top: 4px;">→ ${mainCause} ${causeDirection}가 주요 원인</div>`;
                                }

                                // 5. 증감 요인 (검사목적별) - 건수, 매출, 단가 상세 분석
                                const purposeAvgSel = managerPurposeAvg[managerName] || {};
                                const purposeAvgCntSel = managerPurposeAvgCount[managerName] || {};
                                const purposeChangesSel = Object.entries(info.byPurpose || {}).map(([purpose, data]) => {
                                    const avgP = purposeAvgSel[purpose] || 0;
                                    const avgPCount = purposeAvgCntSel[purpose] || 0;
                                    const salesDiff = data.sales - avgP;
                                    const countDiff = (data.count || 0) - avgPCount;
                                    const avgPrice = data.count > 0 ? data.sales / data.count : 0;
                                    const avgPriceAvg = avgPCount > 0 ? avgP / avgPCount : 0;
                                    const priceDiff = avgPrice - avgPriceAvg;
                                    const salesDiffPct = avgP > 0 ? (salesDiff / avgP * 100) : (data.sales > 0 ? 100 : 0);
                                    const countDiffPct = avgPCount > 0 ? (countDiff / avgPCount * 100) : (data.count > 0 ? 100 : 0);
                                    return {
                                        purpose,
                                        sales: data.sales,
                                        count: data.count || 0,
                                        avgPrice,
                                        avgPriceAvg,
                                        priceDiff,
                                        salesDiff,
                                        countDiff,
                                        salesDiffPct,
                                        countDiffPct
                                    };
                                }).sort((a, b) => b.salesDiff - a.salesDiff);

                                // 전체 증감 합계 계산
                                const allIncreasesSel = purposeChangesSel.filter(p => p.salesDiff > 0);
                                const allDecreasesSel = purposeChangesSel.filter(p => p.salesDiff < 0);
                                const totalIncreaseSel = allIncreasesSel.reduce((sum, p) => sum + p.salesDiff, 0);
                                const totalDecreaseSel = allDecreasesSel.reduce((sum, p) => sum + p.salesDiff, 0);

                                const topIncreasesSel = allIncreasesSel.slice(0, 3);
                                const topDecreasesSel = allDecreasesSel.slice(0, 5);

                                if (isIncrease && topIncreasesSel.length > 0) {
                                    const top3Sum = topIncreasesSel.reduce((sum, p) => sum + p.salesDiff, 0);
                                    const explainPct = totalIncreaseSel > 0 ? (top3Sum / totalIncreaseSel * 100) : 0;
                                    html += `<div style="color: #10b981; margin: 12px 0 6px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2); font-weight: 600;">▲ 증가 요인 TOP ${topIncreasesSel.length} <span style="font-weight: normal; font-size: 11px; color: #94a3b8;">(전체 +${(totalIncreaseSel/10000).toFixed(0)}만 중 ${explainPct.toFixed(0)}%)</span></div>`;
                                    topIncreasesSel.forEach(p => {
                                        const countColor = p.countDiff >= 0 ? '#10b981' : '#ef4444';
                                        const countSign = p.countDiff >= 0 ? '+' : '';
                                        html += `<div style="margin-left: 8px; margin-bottom: 6px; padding: 6px 8px; background: rgba(16, 185, 129, 0.1); border-radius: 6px; border-left: 3px solid #10b981;">
                                            <div style="font-weight: 600; margin-bottom: 4px;">• ${p.purpose}</div>
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 11px;">
                                                <div>📋 건수: <span style="color: ${countColor};">${countSign}${p.countDiff.toLocaleString()}건</span> <span style="color: #94a3b8;">(${countSign}${p.countDiffPct.toFixed(0)}%)</span></div>
                                                <div>💰 매출: <span style="color: #10b981;">+${(p.salesDiff / 10000).toFixed(0)}만</span></div>
                                                <div>💵 단가: ${formatCurrency(Math.round(p.avgPrice))}</div>
                                                <div>📊 현재: ${p.count.toLocaleString()}건 / ${(p.sales / 10000).toFixed(0)}만</div>
                                            </div>
                                        </div>`;
                                    });
                                    if (allIncreasesSel.length > 3) {
                                        const otherSum = totalIncreaseSel - top3Sum;
                                        html += `<div style="margin-left: 8px; color: #94a3b8; font-size: 11px;">+ 기타 ${allIncreasesSel.length - 3}개 항목: +${(otherSum/10000).toFixed(0)}만</div>`;
                                    }
                                } else if (!isIncrease && topDecreasesSel.length > 0) {
                                    const topSum = topDecreasesSel.reduce((sum, p) => sum + p.salesDiff, 0);
                                    const explainPct = totalDecreaseSel < 0 ? (topSum / totalDecreaseSel * 100) : 0;
                                    html += `<div style="color: #ef4444; margin: 12px 0 6px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2); font-weight: 600;">▼ 감소 요인 TOP ${topDecreasesSel.length} <span style="font-weight: normal; font-size: 11px; color: #94a3b8;">(전체 ${(totalDecreaseSel/10000).toFixed(0)}만 중 ${explainPct.toFixed(0)}%)</span></div>`;

                                    // 건수 감소로 인한 매출 감소
                                    const countDropInTopSel = topDecreasesSel.filter(p => p.countDiff <= 0);
                                    if (countDropInTopSel.length > 0) {
                                        html += `<div style="color: #f97316; font-size: 11px; margin: 4px 0 6px 8px;">📉 건수 감소 영향:</div>`;
                                        countDropInTopSel.forEach(p => {
                                            const countSign = p.countDiff >= 0 ? '+' : '';
                                            html += `<div style="margin-left: 8px; margin-bottom: 6px; padding: 6px 8px; background: rgba(239, 68, 68, 0.1); border-radius: 6px; border-left: 3px solid #ef4444;">
                                                <div style="font-weight: 600; margin-bottom: 4px;">• ${p.purpose}</div>
                                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 11px;">
                                                    <div>📋 건수: <span style="color: #ef4444;">${countSign}${p.countDiff.toLocaleString()}건</span> <span style="color: #94a3b8;">(${countSign}${p.countDiffPct.toFixed(0)}%)</span></div>
                                                    <div>💰 매출: <span style="color: #ef4444;">${(p.salesDiff / 10000).toFixed(0)}만</span></div>
                                                    <div>💵 단가: ${formatCurrency(Math.round(p.avgPrice))}</div>
                                                    <div>📊 현재: ${p.count.toLocaleString()}건 / ${(p.sales / 10000).toFixed(0)}만</div>
                                                </div>
                                            </div>`;
                                        });
                                    }

                                    // 단가 하락으로 인한 매출 감소 (건수는 증가)
                                    const priceDropInTopSel = topDecreasesSel.filter(p => p.countDiff > 0);
                                    if (priceDropInTopSel.length > 0) {
                                        html += `<div style="color: #a855f7; font-size: 11px; margin: 8px 0 6px 8px;">💸 단가 하락 영향 (건수↑ 단가↓):</div>`;
                                        priceDropInTopSel.forEach(p => {
                                            html += `<div style="margin-left: 8px; margin-bottom: 6px; padding: 6px 8px; background: rgba(168, 85, 247, 0.1); border-radius: 6px; border-left: 3px solid #a855f7;">
                                                <div style="font-weight: 600; margin-bottom: 4px;">• ${p.purpose}</div>
                                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 11px;">
                                                    <div>📋 건수: <span style="color: #10b981;">+${p.countDiff.toLocaleString()}건</span> <span style="color: #94a3b8;">(+${p.countDiffPct.toFixed(0)}%)</span></div>
                                                    <div>💰 매출: <span style="color: #ef4444;">${(p.salesDiff / 10000).toFixed(0)}만</span></div>
                                                    <div>💵 단가: ${formatCurrency(Math.round(p.avgPrice))} <span style="color: #ef4444;">(↓${formatCurrency(Math.round(Math.abs(p.priceDiff)))})</span></div>
                                                    <div>📊 현재: ${p.count.toLocaleString()}건 / ${(p.sales / 10000).toFixed(0)}만</div>
                                                </div>
                                            </div>`;
                                        });
                                    }

                                    if (allDecreasesSel.length > 5) {
                                        const otherSum = totalDecreaseSel - topSum;
                                        html += `<div style="margin-left: 8px; margin-top: 6px; color: #94a3b8; font-size: 11px;">+ 기타 ${allDecreasesSel.length - 5}개 항목: ${(otherSum/10000).toFixed(0)}만</div>`;
                                    }
                                }

                                // 6. YTD 누적 현황
                                const ytdSales = ds.monthlyInfo.slice(0, monthIdx + 1).reduce((s, m) => s + m.sales, 0);
                                let ytdCompSales = 0;
                                if (compareData && compareData.by_month) {
                                    const compMonthMap = Object.fromEntries(compareData.by_month || []);
                                    for (let i = 1; i <= monthIdx + 1; i++) {
                                        const compMonthData = compMonthMap[i];
                                        ytdCompSales += compMonthData?.byManager?.[managerName]?.sales || 0;
                                    }
                                }
                                const ytdYoyPct = ytdCompSales > 0 ? ((ytdSales - ytdCompSales) / ytdCompSales * 100) : 0;

                                html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── YTD 누적 현황 ──</div>`;
                                html += `<div style="margin-bottom: 4px;">📊 1~${monthIdx + 1}월 누적: <strong>${(ytdSales / 100000000).toFixed(2)}억</strong></div>`;

                                if (ytdCompSales > 0) {
                                    const ytdYoyColor = ytdYoyPct >= 0 ? '#10b981' : '#ef4444';
                                    const ytdYoySign = ytdYoyPct >= 0 ? '+' : '';
                                    html += `<div style="margin-bottom: 4px;">📅 전년 동기 대비: <span style="color: ${ytdYoyColor}; font-weight: bold;">${ytdYoySign}${ytdYoyPct.toFixed(1)}%</span></div>`;
                                }
                            }

                            tooltipEl.innerHTML = html;
                        }

                        // 위치 계산
                        const canvasRect = chart.canvas.getBoundingClientRect();
                        let left = canvasRect.left + tooltip.caretX + 15;
                        let top = canvasRect.top + tooltip.caretY - 10;

                        const tooltipWidth = tooltipEl.offsetWidth || 380;
                        if (left + tooltipWidth > window.innerWidth - 20) {
                            left = canvasRect.left + tooltip.caretX - tooltipWidth - 15;
                        }

                        const tooltipHeight = tooltipEl.offsetHeight || 500;
                        if (top + tooltipHeight > window.innerHeight - 20) {
                            top = window.innerHeight - tooltipHeight - 20;
                        }
                        if (top < 10) top = 10;

                        tooltipEl.style.opacity = 1; tooltipEl.style.pointerEvents = 'auto';
                        tooltipEl.style.left = left + 'px';
                        tooltipEl.style.top = top + 'px';
                    };

                    charts.managerMonthly = new Chart(ctx.getContext('2d'), {
                        type: 'line',
                        data: { labels, datasets },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                    interaction: { intersect: true },
                            plugins: {
                                legend: { position: 'top' },
                                tooltip: {
                                    enabled: false,
                                    external: externalTooltipHandlerSelected
                                }
                            },
                            scales: { y: { ticks: { callback: v => formatCurrency(v) } } }
                        }
                    });
                }
            }

            // 요약 정보 표시 (Legend에 추가)
            const legendEl = document.getElementById('mgrMonthlyLegend');
            if (legendEl) {
                const totalSales = managers.reduce((s, m) => s + (m[1].sales || 0), 0);
                const totalCount = managers.reduce((s, m) => s + (m[1].count || 0), 0);
                const avgPrice = totalCount > 0 ? totalSales / totalCount : 0;

                let legendHtml = '';
                if (compareData && compareData.by_manager) {
                    legendHtml = `
                        <div class="legend-item"><div class="legend-color" style="background: #6366f1;"></div><span>${currentData.year}년</span></div>
                        <div class="legend-item"><div class="legend-color" style="background: rgba(156, 163, 175, 0.5);"></div><span>${compareData.year}년</span></div>`;
                }
                legendHtml += `<div style="margin-left: auto; display: flex; gap: 20px; font-size: 12px; color: #666;">
                    <span>총매출: <strong>${formatCurrency(totalSales)}</strong></span>
                    <span>총건수: <strong>${totalCount.toLocaleString()}건</strong></span>
                    <span>평균단가: <strong>${formatCurrency(Math.round(avgPrice))}</strong></span>
                </div>`;
                legendEl.innerHTML = legendHtml;
                legendEl.style.display = 'flex';
            }
        }

        // 건당 매출 차트
        function updatePerCaseChart() {
            const ctx = document.getElementById('perCaseChart');
            if (!ctx) return;
            if (charts.perCase) charts.perCase.destroy();

            const selectedPurpose = document.getElementById('perCasePurposeSelect')?.value || '전체';
            const managers = currentData.by_manager || [];

            // 검사목적별 필터 적용 + 검사목적별 데이터 포함
            let chartData = managers.map(m => {
                let sales = 0, count = 0;
                const byPurpose = m[1].by_purpose || {};

                if (selectedPurpose === '전체') {
                    sales = m[1].sales || 0;
                    count = m[1].count || 0;
                } else {
                    const purposeData = byPurpose[selectedPurpose];
                    if (purposeData) {
                        sales = purposeData.sales || 0;
                        count = purposeData.count || 0;
                    }
                }
                const avgPrice = count > 0 ? sales / count : 0;

                // 검사목적별 건당 매출 계산
                const purposeAvgPrices = {};
                Object.entries(byPurpose).forEach(([purpose, data]) => {
                    if (data.count > 0) {
                        purposeAvgPrices[purpose] = {
                            avgPrice: data.sales / data.count,
                            sales: data.sales,
                            count: data.count
                        };
                    }
                });

                return {
                    name: m[0],
                    avgPrice,
                    sales,
                    count,
                    byPurpose,
                    purposeAvgPrices
                };
            }).filter(d => d.avgPrice > 0);

            chartData.sort((a, b) => perCaseSortOrder === 'desc' ? b.avgPrice - a.avgPrice : a.avgPrice - b.avgPrice);
            const avgAll = chartData.reduce((s, d) => s + d.avgPrice, 0) / (chartData.length || 1);
            const totalSalesAll = chartData.reduce((s, d) => s + d.sales, 0);
            const totalCountAll = chartData.reduce((s, d) => s + d.count, 0);
            const avgPriceAll = totalCountAll > 0 ? totalSalesAll / totalCountAll : 0;

            // perCaseSummary 요약 정보 표시
            const perCaseSummaryEl = document.getElementById('perCaseSummary');
            if (perCaseSummaryEl) {
                let pcHtml = `<span style="white-space:nowrap;background:#dbeafe;padding:4px 10px;border-radius:4px;color:#1e40af;">매출: <strong style="color:#3b82f6;">${(totalSalesAll / 100000000).toFixed(1)}억</strong></span>`;
                pcHtml += `<span style="white-space:nowrap;background:#e0e7ff;padding:4px 10px;border-radius:4px;color:#3730a3;">건수: <strong>${totalCountAll.toLocaleString()}건</strong></span>`;
                pcHtml += `<span style="white-space:nowrap;background:#fce7f3;padding:4px 10px;border-radius:4px;color:#9d174d;">평균단가: <strong>${Math.round(avgPriceAll / 10000).toLocaleString()}만</strong></span>`;
                pcHtml += `<span style="white-space:nowrap;background:#fef08a;padding:4px 10px;border-radius:4px;color:#854d0e;">담당자수: <strong>${chartData.length}명</strong></span>`;
                perCaseSummaryEl.innerHTML = pcHtml;
            }

            // 전체 담당자 검사목적별 평균 건당 매출 계산
            const purposeGlobalAvg = {};
            const purposeTotals = {};
            chartData.forEach(d => {
                Object.entries(d.purposeAvgPrices).forEach(([purpose, data]) => {
                    if (!purposeTotals[purpose]) {
                        purposeTotals[purpose] = { totalSales: 0, totalCount: 0, managerCount: 0 };
                    }
                    purposeTotals[purpose].totalSales += data.sales;
                    purposeTotals[purpose].totalCount += data.count;
                    purposeTotals[purpose].managerCount++;
                });
            });
            Object.entries(purposeTotals).forEach(([purpose, data]) => {
                purposeGlobalAvg[purpose] = data.totalCount > 0 ? data.totalSales / data.totalCount : 0;
            });

            // 고단가/저단가 기준
            const HIGH_PRICE_THRESHOLD = 150000; // 15만원
            const LOW_PRICE_THRESHOLD = 50000;   // 5만원

            // 전체 평균 고단가/저단가 비중 계산
            let totalHighCount = 0, totalLowCount = 0, totalAllCount = 0;
            chartData.forEach(d => {
                Object.entries(d.purposeAvgPrices).forEach(([purpose, data]) => {
                    totalAllCount += data.count;
                    if (data.avgPrice >= HIGH_PRICE_THRESHOLD) {
                        totalHighCount += data.count;
                    }
                    if (data.avgPrice <= LOW_PRICE_THRESHOLD) {
                        totalLowCount += data.count;
                    }
                });
            });
            const avgHighRatio = totalAllCount > 0 ? (totalHighCount / totalAllCount * 100) : 0;
            const avgLowRatio = totalAllCount > 0 ? (totalLowCount / totalAllCount * 100) : 0;

            // 데이터셋 구성 (현재 연도)
            const datasets = [{
                label: currentData.year + '년 건당 매출',
                data: chartData.map(d => d.avgPrice),
                backgroundColor: chartData.map(d => d.avgPrice >= avgAll ? 'rgba(16, 185, 129, 0.7)' : 'rgba(245, 158, 11, 0.7)'),
                borderRadius: 6,
            }];

            // 전년도 데이터 맵
            const compManagerMap = compareData ? Object.fromEntries((compareData.by_manager || []).map(m => [m[0], m[1]])) : {};

            // 전년도 비교 데이터 추가 (검사목적 필터 적용)
            const compChartData = [];
            if (compareData && compareData.by_manager) {
                chartData.forEach(d => {
                    const comp = compManagerMap[d.name];
                    if (!comp) {
                        compChartData.push({ avgPrice: 0, count: 0 });
                        return;
                    }
                    let compSales = 0, compCount = 0;
                    if (selectedPurpose === '전체') {
                        compSales = comp.sales || 0;
                        compCount = comp.count || 0;
                    } else {
                        const purposeData = comp.by_purpose?.[selectedPurpose];
                        if (purposeData) {
                            compSales = purposeData.sales || 0;
                            compCount = purposeData.count || 0;
                        }
                    }
                    compChartData.push({ avgPrice: compCount > 0 ? compSales / compCount : 0, count: compCount });
                });

                datasets.push({
                    label: compareData.year + '년 건당 매출',
                    data: compChartData.map(d => d.avgPrice),
                    backgroundColor: 'rgba(156, 163, 175, 0.5)',
                    borderRadius: 6,
                });
            }

            // Legend에 요약 정보 표시
            const legendEl = document.getElementById('perCaseLegend');
            if (legendEl) {
                if (compareData) {
                    legendEl.innerHTML = `
                        <div class="legend-item"><div class="legend-color" style="background: rgba(16, 185, 129, 0.7);"></div><span>${currentData.year}년</span></div>
                        <div class="legend-item"><div class="legend-color" style="background: rgba(156, 163, 175, 0.5);"></div><span>${compareData.year}년</span></div>
                        <div style="margin-left: auto; display: flex; gap: 20px; font-size: 12px; color: #666;">
                            <span>총매출: <strong>${formatCurrency(totalSalesAll)}</strong></span>
                            <span>총건수: <strong>${totalCountAll.toLocaleString()}건</strong></span>
                            <span>평균단가: <strong>${formatCurrency(Math.round(avgAll))}</strong></span>
                        </div>`;
                    legendEl.style.display = 'flex';
                } else {
                    legendEl.innerHTML = `
                        <div style="display: flex; gap: 20px; font-size: 12px; color: #666;">
                            <span>총매출: <strong>${formatCurrency(totalSalesAll)}</strong></span>
                            <span>총건수: <strong>${totalCountAll.toLocaleString()}건</strong></span>
                            <span>평균단가: <strong>${formatCurrency(Math.round(avgAll))}</strong></span>
                        </div>`;
                    legendEl.style.display = 'flex';
                }
            }

            // 외부 HTML 툴팁 생성 함수
            const getOrCreatePerCaseTooltip = (chart) => {
                let tooltipEl = document.getElementById('perCaseChartTooltip');
                if (!tooltipEl) {
                    tooltipEl = document.createElement('div');
                    tooltipEl.id = 'perCaseChartTooltip';
                    tooltipEl.style.cssText = `
                        position: fixed;
                        background: rgba(30, 41, 59, 0.95);
                        border: 1px solid rgba(99, 102, 241, 0.5);
                        border-radius: 12px;
                        padding: 16px;
                        pointer-events: auto;
                        z-index: 99999;
                        font-size: 12px;
                        color: #e2e8f0;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                        max-width: 320px;
                        max-height: 85vh;
                        overflow-y: auto;
                        transition: opacity 0.2s ease;
                    `;
                    document.body.appendChild(tooltipEl);
                setupTooltipHover(tooltipEl);
                }
                return tooltipEl;
            };

            // 순위 계산 (단가 높은 순)
            const rankSortedData = [...chartData].sort((a, b) => b.avgPrice - a.avgPrice);
            const rankMap = {};
            rankSortedData.forEach((d, i) => { rankMap[d.name] = i + 1; });

            // 외부 툴팁 핸들러
            const externalTooltipHandler = (context) => {
                const { chart, tooltip } = context;
                const tooltipEl = getOrCreatePerCaseTooltip(chart);

                if (tooltip.opacity === 0 && !isTooltipHovered(tooltipEl)) {
                    hideTooltipWithDelay(tooltipEl);
                    return;
                }

                if (tooltip.body) {
                    const dataIndex = tooltip.dataPoints[0].dataIndex;
                    const datasetIndex = tooltip.dataPoints[0].datasetIndex;
                    const d = chartData[dataIndex];
                    const rank = rankMap[d.name];
                    const isTop3 = rank <= 3;
                    const isBottom3 = rank >= chartData.length - 2;
                    const isAboveAvg = d.avgPrice >= avgAll;

                    // 스타일 결정
                    let borderColor, headerBg, rankIcon;
                    if (rank === 1) {
                        borderColor = 'rgba(255, 215, 0, 0.8)';
                        headerBg = 'linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 180, 0, 0.2))';
                        rankIcon = '🏆';
                    } else if (rank === 2) {
                        borderColor = 'rgba(192, 192, 192, 0.8)';
                        headerBg = 'linear-gradient(135deg, rgba(192, 192, 192, 0.3), rgba(160, 160, 160, 0.2))';
                        rankIcon = '🥈';
                    } else if (rank === 3) {
                        borderColor = 'rgba(205, 127, 50, 0.8)';
                        headerBg = 'linear-gradient(135deg, rgba(205, 127, 50, 0.3), rgba(180, 100, 30, 0.2))';
                        rankIcon = '🥉';
                    } else if (isBottom3) {
                        borderColor = 'rgba(239, 68, 68, 0.6)';
                        headerBg = 'rgba(239, 68, 68, 0.15)';
                        rankIcon = '⚠️';
                    } else {
                        borderColor = isAboveAvg ? 'rgba(16, 185, 129, 0.6)' : 'rgba(245, 158, 11, 0.6)';
                        headerBg = isAboveAvg ? 'rgba(16, 185, 129, 0.15)' : 'rgba(245, 158, 11, 0.15)';
                        rankIcon = '';
                    }
                    tooltipEl.style.border = `2px solid ${borderColor}`;

                    let html = '';

                    // 헤더 (순위 포함)
                    html += `<div style="font-size: 16px; font-weight: bold; color: #fff; margin: -16px -16px 12px -16px; padding: 12px 16px; background: ${headerBg}; border-radius: 10px 10px 0 0; display: flex; justify-content: space-between; align-items: center;">
                        <span>${rankIcon} ${d.name}</span>
                        <span style="background: rgba(255,255,255,0.2); padding: 2px 10px; border-radius: 12px; font-size: 12px;">단가 ${rank}위/${chartData.length}명</span>
                    </div>`;

                    if (datasetIndex !== 0 && compChartData[dataIndex]) {
                        // 전년도 데이터
                        const compD = compChartData[dataIndex];
                        html += `<div>${compareData.year}년 건당: ${formatCurrency(Math.round(compD.avgPrice))}</div>`;
                    } else {
                        // 현재 연도 데이터 - 상세 오버레이

                        // 1. 기본 지표
                        html += `<div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 12px;">`;
                        html += `<div style="display: flex; justify-content: space-between; margin-bottom: 4px;"><span>💰 건당 매출</span><strong>${formatCurrency(Math.round(d.avgPrice))}</strong></div>`;
                        html += `<div style="display: flex; justify-content: space-between; margin-bottom: 4px;"><span>📋 총 건수</span><strong>${d.count.toLocaleString()}건</strong></div>`;
                        html += `<div style="display: flex; justify-content: space-between;"><span>📊 총 매출</span><strong>${(d.sales / 100000000).toFixed(2)}억</strong></div>`;
                        html += `</div>`;

                        // 전체 평균 대비
                        const diffFromAvg = ((d.avgPrice - avgAll) / avgAll * 100);
                        const diffIcon = diffFromAvg >= 0 ? '📈' : '📉';
                        const diffSign = diffFromAvg >= 0 ? '+' : '';
                        const diffColor = diffFromAvg >= 0 ? '#10b981' : '#ef4444';
                        html += `<div style="margin-bottom: 12px; padding: 8px; border-radius: 6px; background: ${diffFromAvg >= 0 ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'};">
                            ${diffIcon} 전체 평균 대비: <span style="color: ${diffColor}; font-weight: bold;">${diffSign}${diffFromAvg.toFixed(1)}%</span>
                            <span style="color: #94a3b8; font-size: 11px;">(평균: ${formatCurrency(Math.round(avgAll))})</span>
                        </div>`;

                        // 전년 대비 (compareData 있을 때)
                        if (compareData && compChartData[dataIndex]) {
                            const compD = compChartData[dataIndex];
                            if (compD.avgPrice > 0) {
                                const yoyDiff = ((d.avgPrice - compD.avgPrice) / compD.avgPrice * 100);
                                const yoyColor = yoyDiff >= 0 ? '#10b981' : '#ef4444';
                                const yoySign = yoyDiff >= 0 ? '+' : '';
                                html += `<div style="margin-bottom: 12px; padding: 8px; border-radius: 6px; background: rgba(99, 102, 241, 0.1);">
                                    📅 ${compareData.year}년 대비: <span style="color: ${yoyColor}; font-weight: bold;">${yoySign}${yoyDiff.toFixed(1)}%</span>
                                    <span style="color: #94a3b8; font-size: 11px;">(${formatCurrency(Math.round(compD.avgPrice))} → ${formatCurrency(Math.round(d.avgPrice))})</span>
                                </div>`;
                            }
                        }

                        // 2. 단가 구성 분석
                        html += `<div style="color: #94a3b8; margin: 8px 0 8px; font-size: 12px;">── 단가 구성 분석 ──</div>`;

                        // 담당자별 고단가/저단가 비중 계산
                        let mgrHighCount = 0, mgrLowCount = 0, mgrTotalCount = 0;
                        Object.entries(d.purposeAvgPrices).forEach(([purpose, data]) => {
                            mgrTotalCount += data.count;
                            if (data.avgPrice >= HIGH_PRICE_THRESHOLD) mgrHighCount += data.count;
                            if (data.avgPrice <= LOW_PRICE_THRESHOLD) mgrLowCount += data.count;
                        });
                        const mgrHighRatio = mgrTotalCount > 0 ? (mgrHighCount / mgrTotalCount * 100) : 0;
                        const mgrLowRatio = mgrTotalCount > 0 ? (mgrLowCount / mgrTotalCount * 100) : 0;
                        const highDiff = mgrHighRatio - avgHighRatio;
                        const lowDiff = mgrLowRatio - avgLowRatio;

                        const highDiffColor = highDiff >= 0 ? '#10b981' : '#f59e0b';
                        const lowDiffColor = lowDiff <= 0 ? '#10b981' : '#f59e0b';
                        html += `<div style="margin-bottom: 4px;">🔺 고단가(15만↑): ${mgrHighRatio.toFixed(1)}% <span style="color: ${highDiffColor}; font-size: 11px;">(평균 대비 ${highDiff >= 0 ? '+' : ''}${highDiff.toFixed(1)}%p)</span></div>`;
                        html += `<div style="margin-bottom: 8px;">🔻 저단가(5만↓): ${mgrLowRatio.toFixed(1)}% <span style="color: ${lowDiffColor}; font-size: 11px;">(평균 대비 ${lowDiff >= 0 ? '+' : ''}${lowDiff.toFixed(1)}%p)</span></div>`;

                        // 3. 검사목적별 분포 TOP 5
                        const purposeRanked = Object.entries(d.purposeAvgPrices)
                            .sort((a, b) => b[1].count - a[1].count)
                            .slice(0, 5);

                        if (purposeRanked.length > 0) {
                            html += `<div style="color: #94a3b8; margin: 12px 0 8px; font-size: 12px;">── 검사목적별 분포 (TOP ${purposeRanked.length}) ──</div>`;
                            purposeRanked.forEach(([purpose, data]) => {
                                const pctOfTotal = (data.count / d.count * 100).toFixed(1);
                                const globalAvg = purposeGlobalAvg[purpose] || 0;
                                const vsGlobal = globalAvg > 0 ? ((data.avgPrice - globalAvg) / globalAvg * 100) : 0;
                                const vsColor = vsGlobal >= 0 ? '#10b981' : '#ef4444';
                                html += `<div style="display: flex; justify-content: space-between; margin-bottom: 3px; font-size: 12px;">
                                    <span>${purpose}</span>
                                    <span>${formatCurrency(Math.round(data.avgPrice))} <span style="color: ${vsColor};">(${vsGlobal >= 0 ? '+' : ''}${vsGlobal.toFixed(0)}%)</span> · ${pctOfTotal}%</span>
                                </div>`;
                            });
                        }

                        // 4. 강점 검사목적
                        const strengths = Object.entries(d.purposeAvgPrices)
                            .map(([purpose, data]) => {
                                const globalAvg = purposeGlobalAvg[purpose] || 0;
                                const diff = globalAvg > 0 ? ((data.avgPrice - globalAvg) / globalAvg * 100) : 0;
                                return { purpose, avgPrice: data.avgPrice, globalAvg, diff, count: data.count };
                            })
                            .filter(item => item.diff > 0 && item.count >= 3)
                            .sort((a, b) => b.diff - a.diff)
                            .slice(0, 3);

                        if (strengths.length > 0) {
                            html += `<div style="color: #10b981; margin: 12px 0 6px; font-weight: 600; font-size: 12px;">💪 강점 검사목적</div>`;
                            strengths.forEach(s => {
                                html += `<div style="margin-left: 8px; margin-bottom: 2px; font-size: 12px;">• ${s.purpose}: ${formatCurrency(Math.round(s.avgPrice))} <span style="color: #10b981;">(+${s.diff.toFixed(0)}%)</span></div>`;
                            });
                        }

                        // 5. 개선 기회
                        const improvements = Object.entries(d.purposeAvgPrices)
                            .map(([purpose, data]) => {
                                const globalAvg = purposeGlobalAvg[purpose] || 0;
                                const diff = globalAvg > 0 ? ((data.avgPrice - globalAvg) / globalAvg * 100) : 0;
                                return { purpose, avgPrice: data.avgPrice, globalAvg, diff, count: data.count };
                            })
                            .filter(item => item.diff < -10 && item.count >= 3)
                            .sort((a, b) => a.diff - b.diff)
                            .slice(0, 3);

                        if (improvements.length > 0) {
                            html += `<div style="color: #f59e0b; margin: 12px 0 6px; font-weight: 600; font-size: 12px;">📌 개선 기회</div>`;
                            improvements.forEach(s => {
                                html += `<div style="margin-left: 8px; margin-bottom: 2px; font-size: 12px;">• ${s.purpose}: ${formatCurrency(Math.round(s.avgPrice))} <span style="color: #f59e0b;">(${s.diff.toFixed(0)}%)</span></div>`;
                            });
                        }
                    }

                    tooltipEl.innerHTML = html;
                }

                // 위치 계산 (화면 밖으로 나가지 않도록)
                const { offsetLeft: positionX, offsetTop: positionY } = chart.canvas;
                const canvasRect = chart.canvas.getBoundingClientRect();

                let left = canvasRect.left + tooltip.caretX + 15;
                let top = canvasRect.top + tooltip.caretY - 10;

                // 우측 경계 체크
                const tooltipWidth = tooltipEl.offsetWidth || 320;
                if (left + tooltipWidth > window.innerWidth - 20) {
                    left = canvasRect.left + tooltip.caretX - tooltipWidth - 15;
                }

                // 하단 경계 체크
                const tooltipHeight = tooltipEl.offsetHeight || 300;
                if (top + tooltipHeight > window.innerHeight - 20) {
                    top = window.innerHeight - tooltipHeight - 20;
                }

                // 상단 경계 체크
                if (top < 10) top = 10;

                tooltipEl.style.opacity = 1; tooltipEl.style.pointerEvents = 'auto';
                tooltipEl.style.left = left + 'px';
                tooltipEl.style.top = top + 'px';
            };

            charts.perCase = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: chartData.map(d => d.name),
                    datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: true },
                    plugins: {
                        legend: { display: compareData ? true : false, position: 'top' },
                        tooltip: {
                            enabled: false,
                            external: externalTooltipHandler
                        }
                    },
                    scales: { y: { beginAtZero: true, ticks: { callback: v => formatCurrency(v) } } }
                }
            });
        }

        // 긴급 접수 건수 차트
        function updateUrgentChart() {
            const ctx = document.getElementById('urgentChart');
            if (!ctx) return;
            if (charts.urgent) charts.urgent.destroy();

            const selectedPurpose = document.getElementById('urgentPurposeSelect')?.value || '전체';
            const managers = currentData.by_manager || [];

            // 월 수 계산 (실제 데이터가 있는 월)
            const byMonth = currentData.by_month || [];
            const monthCount = byMonth.length || 12;

            // 전체 평균 계산 (목적별 긴급 건수)
            const purposeAvgMap = {};
            let totalUrgent = 0;
            let managerWithUrgent = 0;
            managers.forEach(m => {
                const urgentByPurpose = m[1].urgent_by_purpose || {};
                const urgent = m[1].urgent || 0;
                if (urgent > 0) {
                    managerWithUrgent++;
                    totalUrgent += urgent;
                }
                Object.entries(urgentByPurpose).forEach(([purpose, count]) => {
                    if (!purposeAvgMap[purpose]) purposeAvgMap[purpose] = { total: 0, count: 0 };
                    purposeAvgMap[purpose].total += count;
                    purposeAvgMap[purpose].count++;
                });
            });
            // 평균 계산
            Object.keys(purposeAvgMap).forEach(purpose => {
                purposeAvgMap[purpose].avg = purposeAvgMap[purpose].total / (managerWithUrgent || 1);
            });
            const overallAvg = totalUrgent / (managerWithUrgent || 1);

            // 검사목적별 필터 적용
            const urgentData = managers.map(m => {
                let urgentCount = 0;
                const urgentByPurpose = m[1].urgent_by_purpose || {};
                if (selectedPurpose === '전체') {
                    urgentCount = m[1].urgent || 0;
                } else {
                    urgentCount = urgentByPurpose[selectedPurpose] || 0;
                }
                return {
                    name: m[0],
                    urgent: urgentCount,
                    urgentByPurpose: urgentByPurpose,
                    totalUrgent: m[1].urgent || 0,
                    monthlyAvg: (m[1].urgent || 0) / monthCount
                };
            }).sort((a, b) => b.urgent - a.urgent);

            const maxUrgent = Math.max(...urgentData.map(d => d.urgent)) || 1;
            const urgentTotalCount = urgentData.reduce((s, d) => s + d.urgent, 0);
            const avgUrgentPerManager = managerWithUrgent > 0 ? urgentTotalCount / managerWithUrgent : 0;

            // urgentChartSummary 요약 정보 표시
            const urgentSummaryEl = document.getElementById('urgentChartSummary');
            if (urgentSummaryEl) {
                let uHtml = `<span style="white-space:nowrap;background:#fee2e2;padding:4px 10px;border-radius:4px;color:#dc2626;">긴급: <strong>${urgentTotalCount.toLocaleString()}건</strong></span>`;
                uHtml += `<span style="white-space:nowrap;background:#fce7f3;padding:4px 10px;border-radius:4px;color:#9d174d;">담당자별 평균: <strong>${avgUrgentPerManager.toFixed(1)}건</strong></span>`;
                uHtml += `<span style="white-space:nowrap;background:#fef08a;padding:4px 10px;border-radius:4px;color:#854d0e;">담당자수: <strong>${managerWithUrgent}명</strong></span>`;
                urgentSummaryEl.innerHTML = uHtml;
            }

            // 데이터셋 구성
            const datasets = [{
                label: currentData.year + '년 긴급',
                data: urgentData.map(d => d.urgent),
                backgroundColor: urgentData.map(d => {
                    const ratio = d.urgent / maxUrgent;
                    if (ratio >= 0.8) return 'rgba(239, 68, 68, 0.8)';
                    if (ratio >= 0.5) return 'rgba(245, 158, 11, 0.8)';
                    return 'rgba(99, 102, 241, 0.8)';
                }),
                borderRadius: 6,
            }];

            // 전년도 비교 데이터 추가
            if (compareData && compareData.by_manager) {
                const compManagerMap = Object.fromEntries((compareData.by_manager || []).map(m => [m[0], m[1]]));
                datasets.push({
                    label: compareData.year + '년 긴급',
                    data: urgentData.map(d => {
                        const comp = compManagerMap[d.name];
                        if (!comp) return 0;
                        if (selectedPurpose === '전체') {
                            return comp.urgent || 0;
                        } else {
                            const purposeUrgent = comp.urgent_by_purpose || {};
                            return purposeUrgent[selectedPurpose] || 0;
                        }
                    }),
                    backgroundColor: 'rgba(156, 163, 175, 0.5)',
                    borderRadius: 6,
                });
            }

            // 외부 HTML 툴팁 생성 함수 (긴급 접수 건수)
            const getOrCreateUrgentTooltip = (chart) => {
                let tooltipEl = document.getElementById('urgentChartTooltip');
                if (!tooltipEl) {
                    tooltipEl = document.createElement('div');
                    tooltipEl.id = 'urgentChartTooltip';
                    tooltipEl.style.cssText = `
                        position: fixed;
                        background: rgba(30, 41, 59, 0.98);
                        border-radius: 12px;
                        padding: 16px;
                        pointer-events: auto;
                        z-index: 99999;
                        font-size: 13px;
                        color: #e2e8f0;
                        box-shadow: 0 20px 40px rgba(0,0,0,0.4);
                        min-width: 320px;
                        max-width: 380px;
                        max-height: 85vh;
                        overflow-y: auto;
                        transition: opacity 0.15s ease;
                        line-height: 1.5;
                    `;
                    document.body.appendChild(tooltipEl);
                setupTooltipHover(tooltipEl);
                }
                return tooltipEl;
            };

            // 전년도 비교 데이터 맵 생성
            const compManagerMap = compareData ? Object.fromEntries((compareData.by_manager || []).map(m => [m[0], m[1]])) : {};

            // 외부 툴팁 핸들러 (긴급 접수 건수)
            const externalUrgentTooltipHandler = (context) => {
                const { chart, tooltip } = context;
                const tooltipEl = getOrCreateUrgentTooltip(chart);

                if (tooltip.opacity === 0 && !isTooltipHovered(tooltipEl)) {
                    hideTooltipWithDelay(tooltipEl);
                    return;
                }

                if (tooltip.body && tooltip.dataPoints && tooltip.dataPoints.length > 0) {
                    const dp = tooltip.dataPoints[0];
                    const idx = dp.dataIndex;
                    const dsIdx = dp.datasetIndex;
                    const d = urgentData[idx];

                    // 비교 데이터인 경우 간단한 툴팁만 표시
                    if (dsIdx > 0) {
                        const compData = compManagerMap[d.name];
                        let compUrgent = 0;
                        if (compData) {
                            if (selectedPurpose === '전체') {
                                compUrgent = compData.urgent || 0;
                            } else {
                                compUrgent = (compData.urgent_by_purpose || {})[selectedPurpose] || 0;
                            }
                        }
                        tooltipEl.style.border = '2px solid rgba(156, 163, 175, 0.8)';
                        tooltipEl.innerHTML = `
                            <div style="font-size: 15px; font-weight: bold; color: #fff; margin-bottom: 8px;">👤 ${d.name} (${compareData.year}년)</div>
                            <div>🚨 긴급 건수: <strong>${compUrgent.toLocaleString()}건</strong></div>
                        `;
                    } else {
                        // 티어 판정
                        const ratio = d.urgent / maxUrgent;
                        let tierTag, tierIcon, tierColor, borderColor;
                        if (ratio >= 0.8) {
                            tierTag = '상위 (80%↑)'; tierIcon = '🔴'; tierColor = '#ef4444'; borderColor = '#ef4444';
                        } else if (ratio >= 0.5) {
                            tierTag = '중위 (50%↑)'; tierIcon = '🟠'; tierColor = '#f59e0b'; borderColor = '#f59e0b';
                        } else {
                            tierTag = '하위'; tierIcon = '🔵'; tierColor = '#6366f1'; borderColor = '#6366f1';
                        }
                        tooltipEl.style.border = `2px solid ${borderColor}`;

                        let html = '';

                        // 1. 헤더
                        html += `<div style="font-size: 16px; font-weight: bold; color: #fff; margin: -16px -16px 12px -16px; padding: 12px 16px; background: rgba(239, 68, 68, 0.3); border-radius: 10px 10px 0 0;">
                            👤 ${d.name} <span style="font-size: 12px; color: ${tierColor}; background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 10px; margin-left: 8px;">${tierIcon} ${tierTag}</span>
                        </div>`;

                        // 2. 기본 지표
                        html += `<div style="margin-bottom: 4px;">🚨 긴급 건수: <strong>${d.urgent.toLocaleString()}건</strong></div>`;
                        html += `<div style="margin-bottom: 8px;">📅 월평균: <strong>${d.monthlyAvg.toFixed(1)}건/월</strong></div>`;

                        // 3. 비교 분석
                        html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 비교 분석 ──</div>`;

                        // 전체 평균 대비
                        const diffFromAvg = d.totalUrgent - overallAvg;
                        const diffPct = overallAvg > 0 ? (diffFromAvg / overallAvg * 100) : 0;
                        const avgColor = diffFromAvg >= 0 ? '#ef4444' : '#10b981';
                        const avgSign = diffFromAvg >= 0 ? '+' : '';
                        html += `<div style="margin-bottom: 4px;">📊 전체 평균(${overallAvg.toFixed(0)}건) 대비: <span style="color: ${avgColor}; font-weight: bold;">${avgSign}${diffFromAvg.toFixed(0)}건 (${avgSign}${diffPct.toFixed(1)}%)</span></div>`;

                        // 전년 동기 대비
                        if (compareData) {
                            const compData = compManagerMap[d.name];
                            if (compData) {
                                let compUrgent = 0;
                                if (selectedPurpose === '전체') {
                                    compUrgent = compData.urgent || 0;
                                } else {
                                    compUrgent = (compData.urgent_by_purpose || {})[selectedPurpose] || 0;
                                }
                                if (compUrgent > 0) {
                                    const yoyDiff = d.urgent - compUrgent;
                                    const yoyPct = (yoyDiff / compUrgent * 100);
                                    const yoyColor = yoyDiff >= 0 ? '#ef4444' : '#10b981';
                                    const yoySign = yoyDiff >= 0 ? '+' : '';
                                    html += `<div style="margin-bottom: 8px;">📆 전년 대비: <span style="color: ${yoyColor}; font-weight: bold;">${yoySign}${yoyDiff}건 (${yoySign}${yoyPct.toFixed(1)}%)</span></div>`;
                                }
                            }
                        }

                        // 4. 검사목적별 분석
                        const purposeEntries = Object.entries(d.urgentByPurpose).filter(([_, v]) => v > 0);
                        if (purposeEntries.length > 0) {
                            html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 검사목적별 분석 ──</div>`;

                            // 평균 대비 높은 목적
                            const higherPurposes = [];
                            const lowerPurposes = [];

                            purposeEntries.forEach(([purpose, count]) => {
                                const avg = purposeAvgMap[purpose]?.avg || 0;
                                if (avg > 0) {
                                    const diff = count - avg;
                                    const pct = (diff / avg * 100);
                                    if (diff > 0) {
                                        higherPurposes.push({ purpose, count, avg, diff, pct });
                                    } else if (diff < 0) {
                                        lowerPurposes.push({ purpose, count, avg, diff, pct });
                                    }
                                }
                            });

                            if (higherPurposes.length > 0) {
                                higherPurposes.sort((a, b) => b.diff - a.diff);
                                html += `<div style="color: #ef4444; font-weight: 600; margin-bottom: 4px;">▲ 평균 대비 높음</div>`;
                                higherPurposes.slice(0, 3).forEach(p => {
                                    html += `<div style="margin-left: 8px; margin-bottom: 2px;">• ${p.purpose}: ${p.count}건 <span style="color: #ef4444;">(평균 ${p.avg.toFixed(0)}건, +${p.pct.toFixed(0)}%)</span></div>`;
                                });
                            }

                            if (lowerPurposes.length > 0) {
                                lowerPurposes.sort((a, b) => a.diff - b.diff);
                                html += `<div style="color: #10b981; font-weight: 600; margin-top: 8px; margin-bottom: 4px;">▼ 평균 대비 낮음</div>`;
                                lowerPurposes.slice(0, 3).forEach(p => {
                                    html += `<div style="margin-left: 8px; margin-bottom: 2px;">• ${p.purpose}: ${p.count}건 <span style="color: #10b981;">(평균 ${p.avg.toFixed(0)}건, ${p.pct.toFixed(0)}%)</span></div>`;
                                });
                            }
                        }

                        // 5. 인사이트
                        html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 인사이트 ──</div>`;

                        if (ratio >= 0.8) {
                            html += `<div style="color: #f59e0b; font-size: 12px;">⚠️ 긴급 건수 상위권 - 접수 프로세스 개선 또는 사전 일정 관리 필요</div>`;
                        } else if (ratio >= 0.5) {
                            html += `<div style="color: #60a5fa; font-size: 12px;">📋 긴급 건수 중위권 - 특정 목적 집중 관리로 개선 가능</div>`;
                        } else {
                            html += `<div style="color: #10b981; font-size: 12px;">✅ 긴급 건수 하위권 - 안정적인 접수 관리 중</div>`;
                        }

                        tooltipEl.innerHTML = html;
                    }
                }

                // 위치 계산
                const canvasRect = chart.canvas.getBoundingClientRect();
                let left = canvasRect.left + tooltip.caretX + 15;
                let top = canvasRect.top + tooltip.caretY - 10;

                const tooltipWidth = tooltipEl.offsetWidth || 360;
                if (left + tooltipWidth > window.innerWidth - 20) {
                    left = canvasRect.left + tooltip.caretX - tooltipWidth - 15;
                }

                const tooltipHeight = tooltipEl.offsetHeight || 400;
                if (top + tooltipHeight > window.innerHeight - 20) {
                    top = window.innerHeight - tooltipHeight - 20;
                }
                if (top < 10) top = 10;

                tooltipEl.style.opacity = 1; tooltipEl.style.pointerEvents = 'auto';
                tooltipEl.style.left = left + 'px';
                tooltipEl.style.top = top + 'px';
            };

            charts.urgent = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: urgentData.map(d => d.name),
                    datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: true },
                    plugins: {
                        legend: { display: compareData ? true : false, position: 'top' },
                        tooltip: {
                            enabled: false,
                            external: externalUrgentTooltipHandler
                        }
                    },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // 요약 정보 표시 (Legend에 추가)
            const legendEl = document.getElementById('urgentChartLegend');
            if (legendEl) {
                // 긴급 건수 기준 매출/건수 계산
                const urgentTotalCount = urgentData.reduce((s, d) => s + d.urgent, 0);
                const urgentTotalSales = managers.reduce((s, m) => s + (m[1].urgent_sales || 0), 0);
                const avgUrgentPrice = urgentTotalCount > 0 ? urgentTotalSales / urgentTotalCount : 0;

                let legendHtml = '';
                if (compareData && compareData.by_manager) {
                    legendHtml = `
                        <div class="legend-item"><div class="legend-color" style="background: rgba(239, 68, 68, 0.8);"></div><span>${currentData.year}년</span></div>
                        <div class="legend-item"><div class="legend-color" style="background: rgba(156, 163, 175, 0.5);"></div><span>${compareData.year}년</span></div>`;
                }
                legendHtml += `<div style="margin-left: auto; display: flex; gap: 20px; font-size: 12px; color: #666;">
                    <span>총건수: <strong>${urgentTotalCount.toLocaleString()}건</strong></span>
                    <span>총매출: <strong>${formatCurrency(urgentTotalSales)}</strong></span>
                    <span>평균단가: <strong>${formatCurrency(Math.round(avgUrgentPrice))}</strong></span>
                </div>`;
                legendEl.innerHTML = legendHtml;
                legendEl.style.display = 'flex';
            }
        }

        // 긴급 월별 추이 차트 - 외부 HTML 툴팁 생성 함수
        const getOrCreateUrgentMonthlyTooltip = (chart) => {
            let tooltipEl = document.getElementById('urgentMonthlyChartTooltip');
            if (!tooltipEl) {
                tooltipEl = document.createElement('div');
                tooltipEl.id = 'urgentMonthlyChartTooltip';
                tooltipEl.style.cssText = `
                    position: fixed;
                    background: rgba(30, 41, 59, 0.97);
                    border-radius: 12px;
                    padding: 16px;
                    pointer-events: auto;
                    z-index: 99999;
                    font-size: 13px;
                    color: #e2e8f0;
                    min-width: 320px;
                    max-width: 380px;
                    max-height: 85vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.4);
                    transition: opacity 0.15s ease;
                    line-height: 1.5;
                `;
                document.body.appendChild(tooltipEl);
                setupTooltipHover(tooltipEl);
            }
            return tooltipEl;
        };

        // 긴급 월별 추이 차트
        function updateUrgentMonthlyChart() {
            const ctx = document.getElementById('urgentMonthlyChart');
            if (!ctx) return;
            if (charts.urgentMonthly) charts.urgentMonthly.destroy();

            const labels = ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'];
            const urgentMonthMap = Object.fromEntries(currentData.by_urgent_month || []);
            const totalMonthMap = Object.fromEntries(currentData.by_month || []);

            // 월별 상세 데이터 구성
            const monthlyData = labels.map((label, i) => {
                const month = i + 1;
                const urgentData = urgentMonthMap[month] || { count: 0, sales: 0, byManager: {}, byPurpose: {} };
                const totalData = totalMonthMap[month] || { count: 0, sales: 0 };
                return {
                    month,
                    label,
                    urgentCount: urgentData.count || 0,
                    urgentSales: urgentData.sales || 0,
                    totalCount: totalData.count || 0,
                    totalSales: totalData.sales || 0,
                    byManager: urgentData.byManager || {},
                    byPurpose: urgentData.byPurpose || {}
                };
            });

            // 월평균 계산 (0이 아닌 월만)
            const nonZeroMonths = monthlyData.filter(m => m.urgentCount > 0);
            const avgUrgentCount = nonZeroMonths.length > 0 ? nonZeroMonths.reduce((sum, m) => sum + m.urgentCount, 0) / nonZeroMonths.length : 0;
            const avgUrgentRatio = nonZeroMonths.length > 0 ? nonZeroMonths.reduce((sum, m) => sum + (m.totalCount > 0 ? m.urgentCount / m.totalCount : 0), 0) / nonZeroMonths.length : 0;

            // urgentMonthlySummary 요약 정보 표시
            const totalUrgent = monthlyData.reduce((s, m) => s + m.urgentCount, 0);
            const totalUrgentSales = monthlyData.reduce((s, m) => s + m.urgentSales, 0);
            const urgentMonthlySummaryEl = document.getElementById('urgentMonthlySummary');
            if (urgentMonthlySummaryEl) {
                let umHtml = `<span style="white-space:nowrap;background:#fee2e2;padding:4px 10px;border-radius:4px;color:#dc2626;">긴급: <strong>${totalUrgent.toLocaleString()}건</strong></span>`;
                umHtml += `<span style="white-space:nowrap;background:#dbeafe;padding:4px 10px;border-radius:4px;color:#1e40af;">매출: <strong style="color:#3b82f6;">${(totalUrgentSales / 100000000).toFixed(1)}억</strong></span>`;
                umHtml += `<span style="white-space:nowrap;background:#fce7f3;padding:4px 10px;border-radius:4px;color:#9d174d;">월평균: <strong>${avgUrgentCount.toFixed(0)}건</strong></span>`;
                umHtml += `<span style="white-space:nowrap;background:#fef08a;padding:4px 10px;border-radius:4px;color:#854d0e;">긴급비율: <strong>${(avgUrgentRatio * 100).toFixed(1)}%</strong></span>`;
                urgentMonthlySummaryEl.innerHTML = umHtml;
            }

            // 전년도 비교 데이터
            const compUrgentMonthMap = compareData ? Object.fromEntries(compareData.by_urgent_month || []) : {};
            const compTotalMonthMap = compareData ? Object.fromEntries(compareData.by_month || []) : {};

            const compMonthlyData = labels.map((_, i) => {
                const month = i + 1;
                const urgentData = compUrgentMonthMap[month] || { count: 0, sales: 0, byManager: {}, byPurpose: {} };
                const totalData = compTotalMonthMap[month] || { count: 0, sales: 0 };
                return {
                    month,
                    urgentCount: urgentData.count || 0,
                    urgentSales: urgentData.sales || 0,
                    totalCount: totalData.count || 0,
                    byManager: urgentData.byManager || {},
                    byPurpose: urgentData.byPurpose || {}
                };
            });

            // YoY 증감율 순위 계산
            const yoyChanges = monthlyData.map((m, i) => {
                const comp = compMonthlyData[i];
                const change = m.urgentCount - comp.urgentCount;
                const changePct = comp.urgentCount > 0 ? (change / comp.urgentCount * 100) : (m.urgentCount > 0 ? 100 : 0);
                return { month: m.month, change, changePct };
            });
            const sortedByChange = [...yoyChanges].sort((a, b) => b.changePct - a.changePct);
            const yoyRankMap = {};
            sortedByChange.forEach((item, idx) => { yoyRankMap[item.month] = idx + 1; });

            const datasets = [{
                label: currentData.year + '년 긴급',
                data: monthlyData.map(m => m.urgentCount),
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.2)',
                fill: true,
                tension: 0.4,
                pointRadius: 6,
                pointHoverRadius: 10,
                pointBackgroundColor: '#ef4444',
                customData: monthlyData,
            }];

            // 전년도 비교 데이터
            if (compareData && compareData.by_urgent_month) {
                datasets.push({
                    label: compareData.year + '년 긴급',
                    data: compMonthlyData.map(m => m.urgentCount),
                    borderColor: 'rgba(156, 163, 175, 0.8)',
                    backgroundColor: 'rgba(156, 163, 175, 0.1)',
                    fill: false,
                    tension: 0.4,
                    pointRadius: 4,
                    borderDash: [5, 5],
                    customData: compMonthlyData,
                });
            }

            charts.urgentMonthly = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: true },
                    plugins: {
                        legend: { display: compareData ? true : false, position: 'top' },
                        tooltip: {
                            enabled: false,
                            external: function(context) {
                                const tooltipEl = getOrCreateUrgentMonthlyTooltip(context.chart);
                                const tooltipModel = context.tooltip;

                                if (tooltipModel.opacity === 0 && !isTooltipHovered(tooltipEl)) {
                                    hideTooltipWithDelay(tooltipEl);
                                    return;
                                }

                                if (tooltipModel.dataPoints && tooltipModel.dataPoints.length > 0) {
                                    const dataPoint = tooltipModel.dataPoints[0];
                                    const monthIdx = dataPoint.dataIndex;
                                    const d = monthlyData[monthIdx];
                                    const comp = compMonthlyData[monthIdx];

                                    // 시즌 태그 판정
                                    let seasonTag, seasonIcon, seasonColor, borderColor;
                                    if (d.urgentCount > avgUrgentCount * 1.15) {
                                        seasonTag = '성수기'; seasonIcon = '📈';
                                        seasonColor = '#ef4444'; borderColor = '#ef4444';
                                    } else if (d.urgentCount < avgUrgentCount * 0.85) {
                                        seasonTag = '비수기'; seasonIcon = '📉';
                                        seasonColor = '#60a5fa'; borderColor = '#3b82f6';
                                    } else {
                                        seasonTag = '평시'; seasonIcon = '📊';
                                        seasonColor = '#94a3b8'; borderColor = 'rgba(99, 102, 241, 0.5)';
                                    }
                                    tooltipEl.style.border = `2px solid ${borderColor}`;

                                    let html = '';

                                    // === 1. 헤더 영역 ===
                                    html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                        <div style="font-size: 18px; font-weight: bold; color: #fff;">${d.label}</div>
                                        <div style="display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600;
                                            background: ${seasonTag === '성수기' ? 'rgba(239, 68, 68, 0.2)' : seasonTag === '비수기' ? 'rgba(59, 130, 246, 0.2)' : 'rgba(148, 163, 184, 0.2)'};
                                            color: ${seasonColor};">
                                            ${seasonIcon} ${seasonTag}
                                        </div>
                                    </div>`;

                                    // === 2. 기본 지표 ===
                                    html += `<div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 12px;">`;
                                    html += `<div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                        <span style="color: #ef4444;">■ ${currentData.year}년 긴급:</span>
                                        <span style="font-weight: 600;">${d.urgentCount.toLocaleString()}건</span>
                                    </div>`;
                                    if (compareData) {
                                        html += `<div style="display: flex; justify-content: space-between;">
                                            <span style="color: #9ca3af;">□ ${compareData.year}년 긴급:</span>
                                            <span style="font-weight: 600; color: #9ca3af;">${comp.urgentCount.toLocaleString()}건</span>
                                        </div>`;
                                    }
                                    html += `</div>`;

                                    // === 3. 전년 동월 비교 ===
                                    if (compareData && comp.urgentCount > 0) {
                                        const yoyChange = d.urgentCount - comp.urgentCount;
                                        const yoyChangePct = (yoyChange / comp.urgentCount * 100);
                                        const yoyRank = yoyRankMap[d.month];
                                        const isIncrease = yoyChange >= 0;
                                        const isMaxDecrease = yoyRank === 12;

                                        html += `<div style="color: #64748b; font-size: 11px; margin: 12px 0 8px 0; text-align: center;">── 전년 동월 비교 ──</div>`;
                                        html += `<div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 12px;">`;
                                        html += `<div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                            <span style="color: #94a3b8;">전년 대비:</span>
                                            <span style="color: ${isIncrease ? '#10b981' : '#ef4444'}; font-weight: 600;">
                                                ${isIncrease ? '+' : ''}${yoyChange.toLocaleString()}건 (${isIncrease ? '+' : ''}${yoyChangePct.toFixed(1)}%)
                                            </span>
                                        </div>`;
                                        html += `<div style="display: flex; justify-content: space-between;">
                                            <span style="color: #94a3b8;">${isIncrease ? '증가율' : '감소율'} 순위:</span>
                                            <span style="font-weight: 600;">
                                                ${isMaxDecrease ? '⚠️ ' : isIncrease ? '📈 ' : '📉 '}${yoyRank}위 / 12개월
                                            </span>
                                        </div>`;
                                        html += `</div>`;
                                    }

                                    // === 4. 월별 추세 ===
                                    html += `<div style="color: #64748b; font-size: 11px; margin: 12px 0 8px 0; text-align: center;">── 월별 추세 ──</div>`;
                                    html += `<div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 12px;">`;

                                    // 전월 대비
                                    if (monthIdx > 0) {
                                        const prevMonth = monthlyData[monthIdx - 1];
                                        const momChange = d.urgentCount - prevMonth.urgentCount;
                                        const momChangePct = prevMonth.urgentCount > 0 ? (momChange / prevMonth.urgentCount * 100) : 0;
                                        html += `<div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                            <span style="color: #94a3b8;">전월 대비:</span>
                                            <span style="color: ${momChange >= 0 ? '#10b981' : '#ef4444'};">
                                                ${momChange >= 0 ? '+' : ''}${momChange.toLocaleString()}건 (${momChange >= 0 ? '+' : ''}${momChangePct.toFixed(1)}%)
                                            </span>
                                        </div>`;
                                    }

                                    // 추세 계산 (연속 상승/하락)
                                    let trendCount = 0;
                                    let trendDir = null;
                                    for (let i = monthIdx; i >= 1; i--) {
                                        const curr = monthlyData[i].urgentCount;
                                        const prev = monthlyData[i - 1].urgentCount;
                                        if (prev === 0) break;
                                        const changePct = ((curr - prev) / prev) * 100;

                                        if (Math.abs(changePct) <= 5) {
                                            // 횡보 판정
                                            if (trendDir === null) {
                                                trendDir = 'flat';
                                                trendCount = 1;
                                            } else if (trendDir === 'flat') {
                                                trendCount++;
                                            } else {
                                                break;
                                            }
                                        } else if (changePct > 5) {
                                            if (trendDir === null) {
                                                trendDir = 'up';
                                                trendCount = 1;
                                            } else if (trendDir === 'up') {
                                                trendCount++;
                                            } else {
                                                break;
                                            }
                                        } else {
                                            if (trendDir === null) {
                                                trendDir = 'down';
                                                trendCount = 1;
                                            } else if (trendDir === 'down') {
                                                trendCount++;
                                            } else {
                                                break;
                                            }
                                        }
                                    }

                                    let trendText, trendColor, trendArrow;
                                    if (trendDir === 'up') {
                                        trendArrow = '↗'; trendText = `${trendCount}개월 연속 상승`; trendColor = '#10b981';
                                    } else if (trendDir === 'down') {
                                        trendArrow = '↘'; trendText = `${trendCount}개월 연속 하락`; trendColor = '#ef4444';
                                    } else {
                                        trendArrow = '→'; trendText = '횡보'; trendColor = '#94a3b8';
                                    }
                                    html += `<div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                        <span style="color: #94a3b8;">추세:</span>
                                        <span style="color: ${trendColor}; font-weight: 600;">${trendArrow} ${trendText}</span>
                                    </div>`;

                                    // 월평균 대비
                                    const avgDiff = d.urgentCount - avgUrgentCount;
                                    const avgDiffPct = avgUrgentCount > 0 ? (avgDiff / avgUrgentCount * 100) : 0;
                                    html += `<div style="display: flex; justify-content: space-between;">
                                        <span style="color: #94a3b8;">월평균(${Math.round(avgUrgentCount).toLocaleString()}건) 대비:</span>
                                        <span style="color: ${avgDiff >= 0 ? '#10b981' : '#ef4444'};">
                                            ${avgDiff >= 0 ? '+' : ''}${Math.round(avgDiff).toLocaleString()}건 (${avgDiff >= 0 ? '+' : ''}${avgDiffPct.toFixed(1)}%)
                                        </span>
                                    </div>`;
                                    html += `</div>`;

                                    // === 5. 긴급 비율 분석 ===
                                    html += `<div style="color: #64748b; font-size: 11px; margin: 12px 0 8px 0; text-align: center;">── 긴급 비율 분석 ──</div>`;
                                    html += `<div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 12px;">`;

                                    const urgentRatio = d.totalCount > 0 ? (d.urgentCount / d.totalCount * 100) : 0;
                                    const avgRatioPct = avgUrgentRatio * 100;
                                    const ratioDiff = urgentRatio - avgRatioPct;

                                    html += `<div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                        <span style="color: #94a3b8;">해당 월 전체 건수:</span>
                                        <span style="font-weight: 600;">${d.totalCount.toLocaleString()}건</span>
                                    </div>`;
                                    html += `<div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                        <span style="color: #94a3b8;">긴급 비율:</span>
                                        <span style="font-weight: 600; color: #ef4444;">
                                            ${urgentRatio.toFixed(1)}%
                                            <span style="color: ${ratioDiff >= 0 ? '#10b981' : '#60a5fa'}; font-size: 11px;">
                                                (평균 ${avgRatioPct.toFixed(1)}% 대비 ${ratioDiff >= 0 ? '+' : ''}${ratioDiff.toFixed(1)}%p)
                                            </span>
                                        </span>
                                    </div>`;

                                    const ratioInsight = urgentRatio > avgRatioPct ? '🔥 긴급 수요 집중 시기' : '📋 일반 건수 중심 시기';
                                    html += `<div style="text-align: center; padding: 4px; background: rgba(255,255,255,0.05); border-radius: 4px; font-size: 12px;">${ratioInsight}</div>`;
                                    html += `</div>`;

                                    // === 6. 긴급 매출 기여 ===
                                    html += `<div style="color: #64748b; font-size: 11px; margin: 12px 0 8px 0; text-align: center;">── 긴급 매출 기여 ──</div>`;
                                    html += `<div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 12px;">`;

                                    const urgentSalesRatio = d.totalSales > 0 ? (d.urgentSales / d.totalSales * 100) : 0;
                                    const urgentPerCase = d.urgentCount > 0 ? d.urgentSales / d.urgentCount : 0;

                                    html += `<div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                        <span style="color: #94a3b8;">긴급 매출:</span>
                                        <span style="font-weight: 600;">
                                            ${(d.urgentSales / 100000000).toFixed(2)}억
                                            <span style="color: #94a3b8; font-size: 11px;">(전체 ${(d.totalSales / 100000000).toFixed(2)}억의 ${urgentSalesRatio.toFixed(1)}%)</span>
                                        </span>
                                    </div>`;
                                    html += `<div style="display: flex; justify-content: space-between;">
                                        <span style="color: #94a3b8;">긴급 건당 단가:</span>
                                        <span style="font-weight: 600; color: #f59e0b;">${(urgentPerCase / 10000).toFixed(1)}만</span>
                                    </div>`;
                                    html += `</div>`;

                                    // === 7. 주요 기여자 / 감소 원인 (조건부) ===
                                    const yoyChange = d.urgentCount - (comp?.urgentCount || 0);
                                    const isIncrease = yoyChange >= 0;

                                    if (isIncrease && Object.keys(d.byManager).length > 0) {
                                        // 증가 월 - 주요 기여자 TOP 3
                                        html += `<div style="color: #64748b; font-size: 11px; margin: 12px 0 8px 0; text-align: center;">── 주요 기여자 TOP 3 ──</div>`;
                                        html += `<div style="background: rgba(16, 185, 129, 0.1); padding: 10px; border-radius: 8px; margin-bottom: 12px; border: 1px solid rgba(16, 185, 129, 0.3);">`;

                                        const topManagers = Object.entries(d.byManager)
                                            .map(([name, data]) => ({ name, count: data.count, ratio: d.urgentCount > 0 ? (data.count / d.urgentCount * 100) : 0 }))
                                            .sort((a, b) => b.count - a.count)
                                            .slice(0, 3);

                                        const medals = ['🥇', '🥈', '🥉'];
                                        topManagers.forEach((m, i) => {
                                            html += `<div style="display: flex; justify-content: space-between; margin-bottom: ${i < 2 ? '4px' : '0'};">
                                                <span>${medals[i]} ${m.name}:</span>
                                                <span style="font-weight: 600;">${m.count.toLocaleString()}건 (${m.ratio.toFixed(1)}%)</span>
                                            </div>`;
                                        });
                                        html += `</div>`;
                                    } else if (!isIncrease && compareData) {
                                        // 감소 월 - 감소 원인 분석
                                        html += `<div style="color: #64748b; font-size: 11px; margin: 12px 0 8px 0; text-align: center;">── 감소 원인 분석 ──</div>`;
                                        html += `<div style="background: rgba(239, 68, 68, 0.1); padding: 10px; border-radius: 8px; margin-bottom: 12px; border: 1px solid rgba(239, 68, 68, 0.3);">`;

                                        // 검사목적별 감소 분석
                                        const purposeChanges = [];
                                        const allPurposes = new Set([...Object.keys(d.byPurpose), ...Object.keys(comp.byPurpose || {})]);
                                        allPurposes.forEach(purpose => {
                                            const curr = d.byPurpose[purpose]?.count || 0;
                                            const prev = comp.byPurpose?.[purpose]?.count || 0;
                                            if (prev > curr) {
                                                purposeChanges.push({ name: purpose, change: curr - prev });
                                            }
                                        });
                                        purposeChanges.sort((a, b) => a.change - b.change);

                                        if (purposeChanges.length > 0) {
                                            html += `<div style="margin-bottom: 6px; color: #94a3b8; font-size: 11px;">▼ 감소 검사목적:</div>`;
                                            purposeChanges.slice(0, 2).forEach(p => {
                                                html += `<div style="margin-left: 12px; margin-bottom: 2px;">
                                                    • ${p.name}: <span style="color: #ef4444;">${p.change.toLocaleString()}건</span>
                                                </div>`;
                                            });
                                        }

                                        // 담당자별 감소 분석
                                        const managerChanges = [];
                                        const allManagers = new Set([...Object.keys(d.byManager), ...Object.keys(comp.byManager || {})]);
                                        allManagers.forEach(manager => {
                                            const curr = d.byManager[manager]?.count || 0;
                                            const prev = comp.byManager?.[manager]?.count || 0;
                                            if (prev > curr) {
                                                managerChanges.push({ name: manager, change: curr - prev });
                                            }
                                        });
                                        managerChanges.sort((a, b) => a.change - b.change);

                                        if (managerChanges.length > 0) {
                                            html += `<div style="margin-top: 8px; margin-bottom: 6px; color: #94a3b8; font-size: 11px;">▼ 감소 담당자:</div>`;
                                            managerChanges.slice(0, 2).forEach(m => {
                                                html += `<div style="margin-left: 12px; margin-bottom: 2px;">
                                                    • ${m.name}: <span style="color: #ef4444;">${m.change.toLocaleString()}건</span>
                                                </div>`;
                                            });
                                        }
                                        html += `</div>`;
                                    }

                                    // === 8. YTD 누적 현황 / 계절성 인사이트 (조건부) ===
                                    if (isIncrease) {
                                        // YTD 누적 현황
                                        html += `<div style="color: #64748b; font-size: 11px; margin: 12px 0 8px 0; text-align: center;">── YTD 누적 현황 ──</div>`;
                                        html += `<div style="background: rgba(16, 185, 129, 0.1); padding: 10px; border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.3);">`;

                                        const ytdCurrent = monthlyData.slice(0, monthIdx + 1).reduce((sum, m) => sum + m.urgentCount, 0);
                                        const ytdCompare = compMonthlyData.slice(0, monthIdx + 1).reduce((sum, m) => sum + m.urgentCount, 0);
                                        const ytdChangePct = ytdCompare > 0 ? ((ytdCurrent - ytdCompare) / ytdCompare * 100) : 0;

                                        html += `<div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                            <span style="color: #94a3b8;">1~${d.month}월 누적:</span>
                                            <span style="font-weight: 600;">${ytdCurrent.toLocaleString()}건</span>
                                        </div>`;
                                        if (compareData) {
                                            html += `<div style="display: flex; justify-content: space-between;">
                                                <span style="color: #94a3b8;">전년 동기 대비:</span>
                                                <span style="color: ${ytdChangePct >= 0 ? '#10b981' : '#ef4444'}; font-weight: 600;">
                                                    ${ytdChangePct >= 0 ? '+' : ''}${ytdChangePct.toFixed(1)}%
                                                </span>
                                            </div>`;
                                        }
                                        html += `</div>`;
                                    } else {
                                        // 계절성 인사이트
                                        html += `<div style="color: #64748b; font-size: 11px; margin: 12px 0 8px 0; text-align: center;">── 계절성 인사이트 ──</div>`;
                                        html += `<div style="background: rgba(59, 130, 246, 0.1); padding: 10px; border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">`;

                                        // 해당 월 특성 (연중 최저/최고)
                                        const sortedByCount = [...monthlyData].sort((a, b) => a.urgentCount - b.urgentCount);
                                        const isLowest = sortedByCount[0].month === d.month;
                                        const isHighest = sortedByCount[sortedByCount.length - 1].month === d.month;
                                        const compSameMonth = comp?.urgentCount || 0;
                                        const isNormalPattern = compSameMonth > 0 && Math.abs((d.urgentCount - compSameMonth) / compSameMonth) < 0.3;

                                        let seasonInsight;
                                        if (isLowest) seasonInsight = '연중 최저 시기';
                                        else if (isHighest) seasonInsight = '연중 최고 시기';
                                        else seasonInsight = '중간 수준';

                                        html += `<div style="margin-bottom: 6px;">
                                            해당 월 특성: <strong>${seasonInsight}</strong>
                                            <span style="color: ${isNormalPattern ? '#10b981' : '#f59e0b'}; font-size: 11px;">(${isNormalPattern ? '정상 패턴' : '이상 패턴'})</span>
                                        </div>`;

                                        // 평균 대비
                                        if (compareData && compSameMonth > 0) {
                                            const twoYearAvg = (d.urgentCount + compSameMonth) / 2;
                                            const avgDiff = d.urgentCount - twoYearAvg;
                                            const avgDiffPct = (avgDiff / twoYearAvg * 100);
                                            html += `<div style="margin-bottom: 8px;">
                                                2년 평균: ${Math.round(twoYearAvg).toLocaleString()}건
                                                <span style="color: ${avgDiff >= 0 ? '#10b981' : '#ef4444'}; font-size: 11px;">
                                                    (올해 대비 ${avgDiff >= 0 ? '+' : ''}${avgDiffPct.toFixed(1)}%)
                                                </span>
                                            </div>`;
                                        }

                                        // 대응 제안
                                        let suggestion;
                                        if (isLowest) {
                                            suggestion = '💡 비수기 활용: 일반 건수 영업 강화 권장';
                                        } else if (d.urgentCount < avgUrgentCount * 0.85) {
                                            suggestion = '💡 대응: 긴급 수요 촉진 프로모션 검토';
                                        } else {
                                            suggestion = '💡 대응: 현 수준 유지 및 효율 개선 집중';
                                        }
                                        html += `<div style="font-size: 12px;">${suggestion}</div>`;
                                        html += `</div>`;
                                    }

                                    tooltipEl.innerHTML = html;
                                }

                                // 위치 조정 (position: fixed 사용 - 스크롤 오프셋 불필요)
                                const canvasRect = context.chart.canvas.getBoundingClientRect();
                                let left = canvasRect.left + tooltipModel.caretX + 15;
                                let top = canvasRect.top + tooltipModel.caretY - 10;

                                const tooltipWidth = tooltipEl.offsetWidth || 380;
                                if (left + tooltipWidth > window.innerWidth - 20) {
                                    left = canvasRect.left + tooltipModel.caretX - tooltipWidth - 15;
                                }

                                const tooltipHeight = tooltipEl.offsetHeight || 600;
                                if (top + tooltipHeight > window.innerHeight - 20) {
                                    top = window.innerHeight - tooltipHeight - 20;
                                }
                                if (top < 10) top = 10;

                                tooltipEl.style.opacity = 1; tooltipEl.style.pointerEvents = 'auto';
                                tooltipEl.style.left = left + 'px';
                                tooltipEl.style.top = top + 'px';
                            }
                        }
                    },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // 요약 정보 표시 (Legend에 추가)
            const urgentLegendEl = document.getElementById('urgentMonthlyLegend');
            if (urgentLegendEl) {
                const totalUrgentCount = monthlyData.reduce((s, m) => s + m.urgentCount, 0);
                const totalUrgentSales = monthlyData.reduce((s, m) => s + m.urgentSales, 0);
                const avgUrgentPrice = totalUrgentCount > 0 ? totalUrgentSales / totalUrgentCount : 0;

                let legendHtml = '';
                if (compareData && compareData.by_urgent_month) {
                    legendHtml = `
                        <div class="legend-item"><div class="legend-color" style="background: #ef4444;"></div><span>${currentData.year}년</span></div>
                        <div class="legend-item"><div class="legend-color" style="background: rgba(156, 163, 175, 0.5);"></div><span>${compareData.year}년</span></div>`;
                }
                legendHtml += `<div style="margin-left: auto; display: flex; gap: 20px; font-size: 12px; color: #666;">
                    <span>총건수: <strong>${totalUrgentCount.toLocaleString()}건</strong></span>
                    <span>총매출: <strong>${formatCurrency(totalUrgentSales)}</strong></span>
                    <span>평균단가: <strong>${formatCurrency(Math.round(avgUrgentPrice))}</strong></span>
                </div>`;
                urgentLegendEl.innerHTML = legendHtml;
                urgentLegendEl.style.display = 'flex';
            }
        }

        // 긴급 건당 단가 차트 - 외부 HTML 툴팁 생성 함수
        const getOrCreateUrgentUnitPriceTooltip = (chart) => {
            let tooltipEl = document.getElementById('urgentUnitPriceChartTooltip');
            if (!tooltipEl) {
                tooltipEl = document.createElement('div');
                tooltipEl.id = 'urgentUnitPriceChartTooltip';
                tooltipEl.style.cssText = `
                    position: fixed;
                    background: rgba(30, 41, 59, 0.97);
                    border-radius: 12px;
                    padding: 16px;
                    pointer-events: auto;
                    z-index: 99999;
                    font-size: 13px;
                    color: #e2e8f0;
                    min-width: 340px;
                    max-width: 400px;
                    max-height: 85vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.4);
                    transition: opacity 0.15s ease;
                    line-height: 1.5;
                `;
                document.body.appendChild(tooltipEl);
                setupTooltipHover(tooltipEl);
            }
            return tooltipEl;
        };

        // 긴급 건당 단가 차트
        function updateUrgentUnitPriceChart() {
            const ctx = document.getElementById('urgentUnitPriceChart');
            if (!ctx) return;
            if (charts.urgentUnitPrice) charts.urgentUnitPrice.destroy();

            const labels = ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'];
            const urgentMonthMap = Object.fromEntries(currentData.by_urgent_month || []);
            const totalMonthMap = Object.fromEntries(currentData.by_month || []);

            // 월별 상세 데이터 구성
            const monthlyData = labels.map((label, i) => {
                const month = i + 1;
                const urgentData = urgentMonthMap[month] || { count: 0, sales: 0, byManager: {}, byPurpose: {} };
                const totalData = totalMonthMap[month] || { count: 0, sales: 0 };

                const urgentCount = urgentData.count || 0;
                const urgentSales = urgentData.sales || 0;
                const urgentUnitPrice = urgentCount > 0 ? urgentSales / urgentCount : 0;

                // 일반 건 계산 (전체 - 긴급)
                const normalCount = (totalData.count || 0) - urgentCount;
                const normalSales = (totalData.sales || 0) - urgentSales;
                const normalUnitPrice = normalCount > 0 ? normalSales / normalCount : 0;

                // 검사목적별 긴급 단가 계산
                const purposeUnitPrices = Object.entries(urgentData.byPurpose || {}).map(([purpose, data]) => ({
                    purpose,
                    count: data.count,
                    sales: data.sales,
                    unitPrice: data.count > 0 ? data.sales / data.count : 0,
                    ratio: urgentCount > 0 ? (data.count / urgentCount * 100) : 0
                })).sort((a, b) => b.unitPrice - a.unitPrice);

                // 담당자별 긴급 단가 계산
                const managerUnitPrices = Object.entries(urgentData.byManager || {}).map(([name, data]) => ({
                    name,
                    count: data.count,
                    sales: data.sales,
                    unitPrice: data.count > 0 ? data.sales / data.count : 0
                })).sort((a, b) => b.unitPrice - a.unitPrice);

                return {
                    month,
                    label,
                    urgentCount,
                    urgentSales,
                    urgentUnitPrice,
                    normalCount,
                    normalSales,
                    normalUnitPrice,
                    purposeUnitPrices,
                    managerUnitPrices
                };
            });

            // 월평균 계산 (0이 아닌 월만)
            const nonZeroMonths = monthlyData.filter(m => m.urgentUnitPrice > 0);
            const avgUrgentUnitPrice = nonZeroMonths.length > 0 ? nonZeroMonths.reduce((sum, m) => sum + m.urgentUnitPrice, 0) / nonZeroMonths.length : 0;

            // urgentUnitPriceSummary 요약 정보 표시
            const totalUrgentCount = monthlyData.reduce((s, m) => s + m.urgentCount, 0);
            const totalUrgentSalesForSummary = monthlyData.reduce((s, m) => s + m.urgentSales, 0);
            const overallAvgUnitPrice = totalUrgentCount > 0 ? totalUrgentSalesForSummary / totalUrgentCount : 0;
            const urgentUnitPriceSummaryEl = document.getElementById('urgentUnitPriceSummary');
            if (urgentUnitPriceSummaryEl) {
                let upHtml = `<span style="white-space:nowrap;background:#dbeafe;padding:4px 10px;border-radius:4px;color:#1e40af;">매출: <strong style="color:#3b82f6;">${(totalUrgentSalesForSummary / 100000000).toFixed(1)}억</strong></span>`;
                upHtml += `<span style="white-space:nowrap;background:#e0e7ff;padding:4px 10px;border-radius:4px;color:#3730a3;">건수: <strong>${totalUrgentCount.toLocaleString()}건</strong></span>`;
                upHtml += `<span style="white-space:nowrap;background:#fce7f3;padding:4px 10px;border-radius:4px;color:#9d174d;">평균단가: <strong>${Math.round(overallAvgUnitPrice / 10000).toLocaleString()}만</strong></span>`;
                urgentUnitPriceSummaryEl.innerHTML = upHtml;
            }
            const avgNormalUnitPrice = nonZeroMonths.length > 0 ? nonZeroMonths.reduce((sum, m) => sum + m.normalUnitPrice, 0) / nonZeroMonths.length : 0;
            const avgPremium = avgNormalUnitPrice > 0 ? ((avgUrgentUnitPrice - avgNormalUnitPrice) / avgNormalUnitPrice * 100) : 0;

            // 전년도 비교 데이터
            const compUrgentMonthMap = compareData ? Object.fromEntries(compareData.by_urgent_month || []) : {};
            const compTotalMonthMap = compareData ? Object.fromEntries(compareData.by_month || []) : {};

            const compMonthlyData = labels.map((_, i) => {
                const month = i + 1;
                const urgentData = compUrgentMonthMap[month] || { count: 0, sales: 0, byManager: {}, byPurpose: {} };
                const totalData = compTotalMonthMap[month] || { count: 0, sales: 0 };

                const urgentCount = urgentData.count || 0;
                const urgentSales = urgentData.sales || 0;
                const urgentUnitPrice = urgentCount > 0 ? urgentSales / urgentCount : 0;

                const normalCount = (totalData.count || 0) - urgentCount;
                const normalSales = (totalData.sales || 0) - urgentSales;
                const normalUnitPrice = normalCount > 0 ? normalSales / normalCount : 0;

                const purposeUnitPrices = Object.entries(urgentData.byPurpose || {}).map(([purpose, data]) => ({
                    purpose,
                    count: data.count,
                    ratio: urgentCount > 0 ? (data.count / urgentCount * 100) : 0
                }));

                return {
                    month,
                    urgentCount,
                    urgentSales,
                    urgentUnitPrice,
                    normalUnitPrice,
                    purposeUnitPrices
                };
            });

            // YoY 증감율 순위 계산
            const yoyChanges = monthlyData.map((m, i) => {
                const comp = compMonthlyData[i];
                const change = m.urgentUnitPrice - comp.urgentUnitPrice;
                const changePct = comp.urgentUnitPrice > 0 ? (change / comp.urgentUnitPrice * 100) : (m.urgentUnitPrice > 0 ? 100 : 0);
                return { month: m.month, change, changePct };
            });
            const sortedByChange = [...yoyChanges].sort((a, b) => b.changePct - a.changePct);
            const yoyRankMap = {};
            sortedByChange.forEach((item, idx) => { yoyRankMap[item.month] = idx + 1; });

            const datasets = [{
                label: currentData.year + '년 긴급 건당 단가',
                data: monthlyData.map(m => m.urgentUnitPrice),
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245, 158, 11, 0.2)',
                fill: true,
                tension: 0.4,
                pointRadius: 6,
                pointHoverRadius: 10,
                pointBackgroundColor: '#f59e0b',
                customData: monthlyData,
            }];

            // 전년도 비교 데이터
            if (compareData && compareData.by_urgent_month) {
                datasets.push({
                    label: compareData.year + '년 긴급 건당 단가',
                    data: compMonthlyData.map(m => m.urgentUnitPrice),
                    borderColor: 'rgba(156, 163, 175, 0.8)',
                    backgroundColor: 'rgba(156, 163, 175, 0.1)',
                    fill: false,
                    tension: 0.4,
                    pointRadius: 4,
                    borderDash: [5, 5],
                    customData: compMonthlyData,
                });
            }

            charts.urgentUnitPrice = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: true },
                    plugins: {
                        legend: { display: compareData ? true : false, position: 'top' },
                        tooltip: {
                            enabled: false,
                            external: function(context) {
                                const tooltipEl = getOrCreateUrgentUnitPriceTooltip(context.chart);
                                const tooltipModel = context.tooltip;

                                if (tooltipModel.opacity === 0 && !isTooltipHovered(tooltipEl)) {
                                    hideTooltipWithDelay(tooltipEl);
                                    return;
                                }

                                if (tooltipModel.dataPoints && tooltipModel.dataPoints.length > 0) {
                                    const dataPoint = tooltipModel.dataPoints[0];
                                    const monthIdx = dataPoint.dataIndex;
                                    const d = monthlyData[monthIdx];
                                    const comp = compMonthlyData[monthIdx];

                                    // 단가 수준 태그 판정
                                    let priceTag, priceIcon, priceColor, borderColor;
                                    if (d.urgentUnitPrice > avgUrgentUnitPrice * 1.05) {
                                        priceTag = '고단가'; priceIcon = '💰';
                                        priceColor = '#f59e0b'; borderColor = '#f59e0b';
                                    } else if (d.urgentUnitPrice < avgUrgentUnitPrice * 0.95) {
                                        priceTag = '저단가'; priceIcon = '📉';
                                        priceColor = '#60a5fa'; borderColor = '#3b82f6';
                                    } else {
                                        priceTag = '평균'; priceIcon = '📊';
                                        priceColor = '#94a3b8'; borderColor = 'rgba(99, 102, 241, 0.5)';
                                    }
                                    const isHighPrice = d.urgentUnitPrice >= avgUrgentUnitPrice;
                                    tooltipEl.style.border = `2px solid ${borderColor}`;

                                    let html = '';

                                    // === 1. 헤더 영역 ===
                                    html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                        <div style="font-size: 18px; font-weight: bold; color: #fff;">${d.label}</div>
                                        <div style="display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600;
                                            background: ${priceTag === '고단가' ? 'rgba(245, 158, 11, 0.2)' : priceTag === '저단가' ? 'rgba(59, 130, 246, 0.2)' : 'rgba(148, 163, 184, 0.2)'};
                                            color: ${priceColor};">
                                            ${priceIcon} ${priceTag}
                                        </div>
                                    </div>`;

                                    // === 2. 기본 지표 ===
                                    html += `<div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 12px;">`;
                                    html += `<div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                        <span style="color: #f59e0b;">■ ${currentData.year}년 긴급 건당 단가:</span>
                                        <span style="font-weight: 600;">${(d.urgentUnitPrice / 10000).toFixed(1)}만</span>
                                    </div>`;
                                    if (compareData) {
                                        html += `<div style="display: flex; justify-content: space-between;">
                                            <span style="color: #9ca3af;">□ ${compareData.year}년 긴급 건당 단가:</span>
                                            <span style="font-weight: 600; color: #9ca3af;">${(comp.urgentUnitPrice / 10000).toFixed(1)}만</span>
                                        </div>`;
                                    }
                                    html += `</div>`;

                                    // === 3. 전년 동월 비교 ===
                                    if (compareData && comp.urgentUnitPrice > 0) {
                                        const yoyChange = d.urgentUnitPrice - comp.urgentUnitPrice;
                                        const yoyChangePct = (yoyChange / comp.urgentUnitPrice * 100);
                                        const yoyRank = yoyRankMap[d.month];
                                        const isUp = yoyChange >= 0;

                                        html += `<div style="color: #64748b; font-size: 11px; margin: 12px 0 8px 0; text-align: center;">── 전년 동월 비교 ──</div>`;
                                        html += `<div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 12px;">`;
                                        html += `<div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                            <span style="color: #94a3b8;">전년 대비:</span>
                                            <span style="color: ${isUp ? '#10b981' : '#ef4444'}; font-weight: 600;">
                                                ${isUp ? '+' : ''}${Math.round(yoyChange).toLocaleString()}원 (${isUp ? '+' : ''}${yoyChangePct.toFixed(1)}%)
                                            </span>
                                        </div>`;
                                        html += `<div style="display: flex; justify-content: space-between;">
                                            <span style="color: #94a3b8;">단가 ${isUp ? '상승률' : '하락률'} 순위:</span>
                                            <span style="font-weight: 600;">
                                                ${isUp ? '📈 ' : '📉 '}${yoyRank}위 / 12개월
                                            </span>
                                        </div>`;
                                        html += `</div>`;
                                    }

                                    // === 4. 긴급 프리미엄 분석 ===
                                    html += `<div style="color: #64748b; font-size: 11px; margin: 12px 0 8px 0; text-align: center;">── 긴급 프리미엄 분석 ──</div>`;
                                    html += `<div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 12px;">`;

                                    const premium = d.urgentUnitPrice - d.normalUnitPrice;
                                    const premiumPct = d.normalUnitPrice > 0 ? (premium / d.normalUnitPrice * 100) : 0;
                                    const premiumDiff = premiumPct - avgPremium;

                                    html += `<div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                        <span style="color: #94a3b8;">일반 건당 단가:</span>
                                        <span style="font-weight: 600;">${(d.normalUnitPrice / 10000).toFixed(1)}만</span>
                                    </div>`;
                                    html += `<div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                        <span style="color: #94a3b8;">긴급 프리미엄:</span>
                                        <span style="font-weight: 600; color: ${premium >= 0 ? '#10b981' : '#ef4444'};">
                                            ${premium >= 0 ? '+' : ''}${(premium / 10000).toFixed(1)}만 (${premium >= 0 ? '+' : ''}${premiumPct.toFixed(1)}%)
                                        </span>
                                    </div>`;

                                    if (premium > 0) {
                                        html += `<div style="text-align: center; padding: 4px; background: rgba(16, 185, 129, 0.1); border-radius: 4px; font-size: 12px; color: #10b981;">
                                            💎 긴급 건이 일반보다 ${premiumPct.toFixed(1)}% 높은 수익성
                                        </div>`;
                                    }

                                    // 프리미엄 축소 경고
                                    if (Math.abs(premiumDiff) >= 10) {
                                        const isReduced = premiumDiff < 0;
                                        html += `<div style="margin-top: 6px; padding: 4px; background: ${isReduced ? 'rgba(245, 158, 11, 0.1)' : 'rgba(16, 185, 129, 0.1)'}; border-radius: 4px; font-size: 11px; color: ${isReduced ? '#f59e0b' : '#10b981'};">
                                            ${isReduced ? '⚠️' : '📈'} 프리미엄 ${isReduced ? '축소' : '확대'} (평균 ${avgPremium.toFixed(1)}% → ${premiumPct.toFixed(1)}%)
                                        </div>`;
                                    }
                                    html += `</div>`;

                                    // === 5. 월별 추세 ===
                                    html += `<div style="color: #64748b; font-size: 11px; margin: 12px 0 8px 0; text-align: center;">── 월별 추세 ──</div>`;
                                    html += `<div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 12px;">`;

                                    // 전월 대비
                                    if (monthIdx > 0) {
                                        const prevMonth = monthlyData[monthIdx - 1];
                                        const momChange = d.urgentUnitPrice - prevMonth.urgentUnitPrice;
                                        const momChangePct = prevMonth.urgentUnitPrice > 0 ? (momChange / prevMonth.urgentUnitPrice * 100) : 0;
                                        html += `<div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                            <span style="color: #94a3b8;">전월 대비:</span>
                                            <span style="color: ${momChange >= 0 ? '#10b981' : '#ef4444'};">
                                                ${momChange >= 0 ? '+' : ''}${Math.round(momChange).toLocaleString()}원 (${momChange >= 0 ? '+' : ''}${momChangePct.toFixed(1)}%)
                                            </span>
                                        </div>`;
                                    }

                                    // 추세 계산
                                    let trendCount = 0;
                                    let trendDir = null;
                                    for (let i = monthIdx; i >= 1; i--) {
                                        const curr = monthlyData[i].urgentUnitPrice;
                                        const prev = monthlyData[i - 1].urgentUnitPrice;
                                        if (prev === 0) break;
                                        const changePct = ((curr - prev) / prev) * 100;

                                        if (Math.abs(changePct) <= 3) {
                                            if (trendDir === null) { trendDir = 'flat'; trendCount = 1; }
                                            else if (trendDir === 'flat') { trendCount++; }
                                            else { break; }
                                        } else if (changePct > 3) {
                                            if (trendDir === null) { trendDir = 'up'; trendCount = 1; }
                                            else if (trendDir === 'up') { trendCount++; }
                                            else { break; }
                                        } else {
                                            if (trendDir === null) { trendDir = 'down'; trendCount = 1; }
                                            else if (trendDir === 'down') { trendCount++; }
                                            else { break; }
                                        }
                                    }

                                    let trendText, trendColor, trendArrow;
                                    if (trendDir === 'up') { trendArrow = '↗'; trendText = `${trendCount}개월 연속 상승`; trendColor = '#10b981'; }
                                    else if (trendDir === 'down') { trendArrow = '↘'; trendText = `${trendCount}개월 연속 하락`; trendColor = '#ef4444'; }
                                    else { trendArrow = '→'; trendText = '횡보'; trendColor = '#94a3b8'; }

                                    html += `<div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                        <span style="color: #94a3b8;">추세:</span>
                                        <span style="color: ${trendColor}; font-weight: 600;">${trendArrow} ${trendText}</span>
                                    </div>`;

                                    // 월평균 대비
                                    const avgDiff = d.urgentUnitPrice - avgUrgentUnitPrice;
                                    const avgDiffPct = avgUrgentUnitPrice > 0 ? (avgDiff / avgUrgentUnitPrice * 100) : 0;
                                    html += `<div style="display: flex; justify-content: space-between;">
                                        <span style="color: #94a3b8;">월평균(${(avgUrgentUnitPrice / 10000).toFixed(1)}만) 대비:</span>
                                        <span style="color: ${avgDiff >= 0 ? '#10b981' : '#ef4444'};">
                                            ${avgDiff >= 0 ? '+' : ''}${Math.round(avgDiff).toLocaleString()}원 (${avgDiff >= 0 ? '+' : ''}${avgDiffPct.toFixed(1)}%)
                                        </span>
                                    </div>`;
                                    html += `</div>`;

                                    // === 6. 단가 구성 분석 ===
                                    if (d.purposeUnitPrices.length > 0) {
                                        html += `<div style="color: #64748b; font-size: 11px; margin: 12px 0 8px 0; text-align: center;">── 단가 구성 분석 ──</div>`;
                                        html += `<div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 12px;">`;

                                        if (isHighPrice) {
                                            // 고단가 월
                                            const highPurposes = d.purposeUnitPrices.filter(p => p.unitPrice > avgUrgentUnitPrice).slice(0, 2);
                                            const lowPurposes = d.purposeUnitPrices.filter(p => p.unitPrice < avgUrgentUnitPrice).slice(-1);

                                            if (highPurposes.length > 0) {
                                                html += `<div style="margin-bottom: 6px; color: #10b981; font-size: 11px;">▲ 단가 상승 요인:</div>`;
                                                highPurposes.forEach(p => {
                                                    html += `<div style="margin-left: 12px; margin-bottom: 2px; font-size: 12px;">
                                                        • ${p.purpose}: <span style="color: #f59e0b;">${(p.unitPrice / 10000).toFixed(1)}만</span>
                                                        <span style="color: #94a3b8;">(비중 ${p.ratio.toFixed(1)}%)</span>
                                                    </div>`;
                                                });
                                            }
                                            if (lowPurposes.length > 0) {
                                                html += `<div style="margin-top: 6px; margin-bottom: 4px; color: #ef4444; font-size: 11px;">▼ 단가 하락 요인:</div>`;
                                                lowPurposes.forEach(p => {
                                                    html += `<div style="margin-left: 12px; font-size: 12px;">
                                                        • ${p.purpose}: <span style="color: #60a5fa;">${(p.unitPrice / 10000).toFixed(1)}만</span>
                                                        <span style="color: #94a3b8;">(비중 ${p.ratio.toFixed(1)}%)</span>
                                                    </div>`;
                                                });
                                            }
                                        } else {
                                            // 저단가 월
                                            const lowPurposes = d.purposeUnitPrices.filter(p => p.unitPrice < avgUrgentUnitPrice * 0.9).slice(-2).reverse();
                                            const highPurposes = d.purposeUnitPrices.filter(p => p.unitPrice > avgUrgentUnitPrice).slice(0, 1);

                                            // 전년 동월 비교로 비중 변화 확인
                                            const compPurposeMap = {};
                                            if (comp && comp.purposeUnitPrices) {
                                                comp.purposeUnitPrices.forEach(p => { compPurposeMap[p.purpose] = p.ratio; });
                                            }

                                            if (lowPurposes.length > 0) {
                                                html += `<div style="margin-bottom: 6px; color: #f59e0b; font-size: 11px;">⚠️ 저단가 검사 비중:</div>`;
                                                lowPurposes.forEach(p => {
                                                    const prevRatio = compPurposeMap[p.purpose] || 0;
                                                    const ratioChange = p.ratio - prevRatio;
                                                    html += `<div style="margin-left: 12px; margin-bottom: 2px; font-size: 12px;">
                                                        • ${p.purpose}: <span style="color: #60a5fa;">${(p.unitPrice / 10000).toFixed(1)}만</span>
                                                        <span style="color: #94a3b8;">(${p.ratio.toFixed(1)}%${ratioChange !== 0 ? `, ${ratioChange >= 0 ? '+' : ''}${ratioChange.toFixed(1)}%p` : ''})</span>
                                                    </div>`;
                                                });
                                            }
                                            if (highPurposes.length > 0) {
                                                html += `<div style="margin-top: 6px; margin-bottom: 4px; color: #ef4444; font-size: 11px;">📉 고단가 검사 비중 감소:</div>`;
                                                highPurposes.forEach(p => {
                                                    const prevRatio = compPurposeMap[p.purpose] || 0;
                                                    const ratioChange = p.ratio - prevRatio;
                                                    html += `<div style="margin-left: 12px; font-size: 12px;">
                                                        • ${p.purpose}: <span style="color: #f59e0b;">${(p.unitPrice / 10000).toFixed(1)}만</span>
                                                        <span style="color: #94a3b8;">(${p.ratio.toFixed(1)}%${ratioChange < 0 ? `, ${ratioChange.toFixed(1)}%p` : ''})</span>
                                                    </div>`;
                                                });
                                            }
                                        }
                                        html += `</div>`;
                                    }

                                    // === 7. 매출 영향 분석 ===
                                    html += `<div style="color: #64748b; font-size: 11px; margin: 12px 0 8px 0; text-align: center;">── ${isHighPrice ? '매출 영향 분석' : '매출 손실 분석'} ──</div>`;
                                    html += `<div style="background: ${isHighPrice ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; padding: 10px; border-radius: 8px; margin-bottom: 12px; border: 1px solid ${isHighPrice ? 'rgba(16, 185, 129, 0.3)' : 'rgba(239, 68, 68, 0.3)'};">`;

                                    html += `<div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                        <span style="color: #94a3b8;">해당 월 긴급 건수:</span>
                                        <span style="font-weight: 600;">${d.urgentCount.toLocaleString()}건</span>
                                    </div>`;
                                    html += `<div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                        <span style="color: #94a3b8;">긴급 매출:</span>
                                        <span style="font-weight: 600;">${(d.urgentSales / 100000000).toFixed(2)}억</span>
                                    </div>`;

                                    if (isHighPrice) {
                                        const priceEffect = (d.urgentUnitPrice - avgUrgentUnitPrice) * d.urgentCount;
                                        html += `<div style="padding-top: 6px; border-top: 1px solid rgba(255,255,255,0.1);">
                                            📈 단가 +${((d.urgentUnitPrice - avgUrgentUnitPrice) / 10000).toFixed(1)}만 시 매출 효과:
                                            <span style="color: #10b981; font-weight: 600;">+${(priceEffect / 10000).toFixed(0)}만</span>
                                        </div>`;
                                    } else {
                                        const lostSales = (avgUrgentUnitPrice - d.urgentUnitPrice) * d.urgentCount;
                                        const expectedSales = avgUrgentUnitPrice * d.urgentCount;
                                        html += `<div style="padding-top: 6px; border-top: 1px solid rgba(255,255,255,0.1);">
                                            ⚠️ 평균 단가였다면:
                                            <span style="font-weight: 600;">${(expectedSales / 100000000).toFixed(2)}억</span>
                                            <span style="color: #ef4444;">(-${(lostSales / 10000).toFixed(0)}만 손실)</span>
                                        </div>`;
                                    }
                                    html += `</div>`;

                                    // === 8. 단가 TOP 담당자 / 개선 기회 ===
                                    if (isHighPrice && d.managerUnitPrices.length > 0) {
                                        // 고단가 월 - 단가 TOP 담당자
                                        html += `<div style="color: #64748b; font-size: 11px; margin: 12px 0 8px 0; text-align: center;">── 단가 TOP 담당자 ──</div>`;
                                        html += `<div style="background: rgba(245, 158, 11, 0.1); padding: 10px; border-radius: 8px; border: 1px solid rgba(245, 158, 11, 0.3);">`;

                                        const topManagers = d.managerUnitPrices.slice(0, 3);
                                        const medals = ['🥇', '🥈', '🥉'];
                                        topManagers.forEach((m, i) => {
                                            const diffPct = avgUrgentUnitPrice > 0 ? ((m.unitPrice - avgUrgentUnitPrice) / avgUrgentUnitPrice * 100) : 0;
                                            html += `<div style="display: flex; justify-content: space-between; margin-bottom: ${i < 2 ? '4px' : '0'};">
                                                <span>${medals[i]} ${m.name}:</span>
                                                <span style="font-weight: 600;">${(m.unitPrice / 10000).toFixed(1)}만
                                                    <span style="color: ${diffPct >= 0 ? '#10b981' : '#ef4444'}; font-size: 11px;">(평균 ${diffPct >= 0 ? '+' : ''}${diffPct.toFixed(1)}%)</span>
                                                </span>
                                            </div>`;
                                        });
                                        html += `</div>`;
                                    } else if (!isHighPrice) {
                                        // 저단가 월 - 개선 기회
                                        html += `<div style="color: #64748b; font-size: 11px; margin: 12px 0 8px 0; text-align: center;">── 개선 기회 ──</div>`;
                                        html += `<div style="background: rgba(59, 130, 246, 0.1); padding: 10px; border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">`;

                                        // 고단가 검사 비중 +10%p 시 효과
                                        const highPricePurpose = d.purposeUnitPrices.find(p => p.unitPrice > avgUrgentUnitPrice);
                                        if (highPricePurpose) {
                                            const addCount = Math.round(d.urgentCount * 0.1);
                                            const addSales = addCount * (highPricePurpose.unitPrice - d.urgentUnitPrice);
                                            html += `<div style="margin-bottom: 6px;">
                                                💡 고단가 검사 비중 +10%p 시:
                                                <span style="color: #10b981; font-weight: 600;">+${(addSales / 10000).toFixed(0)}만</span>
                                            </div>`;
                                        }

                                        // 프리미엄 회복 시 효과
                                        if (premiumPct < avgPremium) {
                                            const targetPremium = avgPremium / 100;
                                            const targetUrgentPrice = d.normalUnitPrice * (1 + targetPremium);
                                            const recoveryEffect = (targetUrgentPrice - d.urgentUnitPrice) * d.urgentCount;
                                            html += `<div style="margin-bottom: 6px;">
                                                💡 긴급 프리미엄 ${avgPremium.toFixed(0)}% 회복 시:
                                                <span style="color: #10b981; font-weight: 600;">+${(recoveryEffect / 10000).toFixed(0)}만</span>
                                            </div>`;
                                        }

                                        // 벤치마크 월
                                        const bestMonth = [...monthlyData].sort((a, b) => b.urgentUnitPrice - a.urgentUnitPrice)[0];
                                        if (bestMonth.month !== d.month) {
                                            html += `<div>🎯 벤치마크: ${bestMonth.label} 단가 구성 참고</div>`;
                                        }
                                        html += `</div>`;
                                    }

                                    tooltipEl.innerHTML = html;
                                }

                                // 위치 조정 (position: fixed 사용 - 스크롤 오프셋 불필요)
                                const canvasRect = context.chart.canvas.getBoundingClientRect();
                                let left = canvasRect.left + tooltipModel.caretX + 15;
                                let top = canvasRect.top + tooltipModel.caretY - 10;

                                const tooltipWidth = tooltipEl.offsetWidth || 400;
                                if (left + tooltipWidth > window.innerWidth - 20) {
                                    left = canvasRect.left + tooltipModel.caretX - tooltipWidth - 15;
                                }

                                const tooltipHeight = tooltipEl.offsetHeight || 700;
                                if (top + tooltipHeight > window.innerHeight - 20) {
                                    top = window.innerHeight - tooltipHeight - 20;
                                }
                                if (top < 10) top = 10;

                                tooltipEl.style.opacity = 1; tooltipEl.style.pointerEvents = 'auto';
                                tooltipEl.style.left = left + 'px';
                                tooltipEl.style.top = top + 'px';
                            }
                        }
                    },
                    scales: { y: { beginAtZero: true, ticks: { callback: v => formatCurrency(v) } } }
                }
            });

            // 요약 정보 표시 (Legend에 추가)
            const unitPriceLegendEl = document.getElementById('urgentUnitPriceLegend');
            if (unitPriceLegendEl) {
                const totalUrgentCount = monthlyData.reduce((s, m) => s + m.urgentCount, 0);
                const totalUrgentSales = monthlyData.reduce((s, m) => s + m.urgentSales, 0);
                const avgUrgentUnitPriceAll = totalUrgentCount > 0 ? totalUrgentSales / totalUrgentCount : 0;

                let legendHtml = '';
                if (compareData && compareData.by_urgent_month) {
                    legendHtml = `
                        <div class="legend-item"><div class="legend-color" style="background: #f59e0b;"></div><span>${currentData.year}년</span></div>
                        <div class="legend-item"><div class="legend-color" style="background: rgba(156, 163, 175, 0.5);"></div><span>${compareData.year}년</span></div>`;
                }
                legendHtml += `<div style="margin-left: auto; display: flex; gap: 20px; font-size: 12px; color: #666;">
                    <span>총매출: <strong>${formatCurrency(totalUrgentSales)}</strong></span>
                    <span>총건수: <strong>${totalUrgentCount.toLocaleString()}건</strong></span>
                    <span>평균단가: <strong>${formatCurrency(Math.round(avgUrgentUnitPriceAll))}</strong></span>
                </div>`;
                unitPriceLegendEl.innerHTML = legendHtml;
                unitPriceLegendEl.style.display = 'flex';
            }
        }

        // 일 방문 거래처 수 차트
        function updateDailyClientChart() {
            const ctx = document.getElementById('dailyClientChart');
            if (!ctx) return;
            if (charts.dailyClient) charts.dailyClient.destroy();

            const managers = currentData.by_manager || [];
            const BUSINESS_DAYS = 250; // 연간 영업일

            // 거래처 수는 클라이언트 데이터에서 추정 (데이터가 없으면 건수 기준으로 추정)
            const chartData = managers.map(m => {
                const count = m[1].count || 0;
                const sales = m[1].sales || 0;
                const avgDailyClients = Math.round(count / BUSINESS_DAYS * 10) / 10;
                const monthlyClients = Math.round(count / 12);
                const revenuePerVisit = monthlyClients > 0 ? (sales / 12) / monthlyClients : 0;
                const casesPerVisit = monthlyClients > 0 ? (count / 12) / monthlyClients : 0;

                return {
                    name: m[0],
                    avgDailyClients,
                    monthlyClients,
                    count,
                    sales,
                    revenuePerVisit,
                    casesPerVisit
                };
            }).sort((a, b) => b.avgDailyClients - a.avgDailyClients);

            const avgAll = chartData.reduce((s, d) => s + d.avgDailyClients, 0) / (chartData.length || 1);
            const avgRevenuePerVisit = chartData.reduce((s, d) => s + d.revenuePerVisit, 0) / (chartData.length || 1);
            const avgCasesPerVisit = chartData.reduce((s, d) => s + d.casesPerVisit, 0) / (chartData.length || 1);

            // 전년도 비교 데이터
            const compareMap = compareData ? Object.fromEntries((compareData.by_manager || []).map(m => [m[0], m[1]])) : {};
            const compChartData = chartData.map(d => {
                const compData = compareMap[d.name];
                if (!compData) return { avgDailyClients: 0, sales: 0, count: 0 };
                const compCount = compData.count || 0;
                const compSales = compData.sales || 0;
                return {
                    avgDailyClients: Math.round(compCount / BUSINESS_DAYS * 10) / 10,
                    sales: compSales,
                    count: compCount
                };
            });

            const datasets = [{
                label: currentData.year + '년',
                data: chartData.map(d => d.avgDailyClients),
                backgroundColor: 'rgba(99, 102, 241, 0.8)',
                borderRadius: 6,
            }];

            // 요약 정보 계산
            const totalSalesAll = chartData.reduce((s, d) => s + d.sales, 0);
            const totalCountAll = chartData.reduce((s, d) => s + d.count, 0);
            const avgPriceAll = totalCountAll > 0 ? totalSalesAll / totalCountAll : 0;

            // dailyClientSummary 요약 정보 표시
            const dailyClientSummaryEl = document.getElementById('dailyClientSummary');
            if (dailyClientSummaryEl) {
                let dcHtml = `<span style="white-space:nowrap;background:#dbeafe;padding:4px 10px;border-radius:4px;color:#1e40af;">매출: <strong style="color:#3b82f6;">${(totalSalesAll / 100000000).toFixed(1)}억</strong></span>`;
                dcHtml += `<span style="white-space:nowrap;background:#e0e7ff;padding:4px 10px;border-radius:4px;color:#3730a3;">건수: <strong>${totalCountAll.toLocaleString()}건</strong></span>`;
                dcHtml += `<span style="white-space:nowrap;background:#fce7f3;padding:4px 10px;border-radius:4px;color:#9d174d;">평균단가: <strong>${Math.round(avgPriceAll / 10000).toLocaleString()}만</strong></span>`;
                dcHtml += `<span style="white-space:nowrap;background:#fef08a;padding:4px 10px;border-radius:4px;color:#854d0e;">일평균: <strong>${avgAll.toFixed(1)}건</strong></span>`;
                dailyClientSummaryEl.innerHTML = dcHtml;
            }

            const summaryHtml = `<div style="margin-left: auto; display: flex; gap: 20px; font-size: 12px; color: #666;">
                <span>총매출: <strong>${formatCurrency(totalSalesAll)}</strong></span>
                <span>총건수: <strong>${totalCountAll.toLocaleString()}건</strong></span>
                <span>평균단가: <strong>${formatCurrency(Math.round(avgPriceAll))}</strong></span>
            </div>`;

            if (compareData && compareData.by_manager) {
                datasets.push({
                    label: compareData.year + '년',
                    data: compChartData.map(d => d.avgDailyClients),
                    backgroundColor: 'rgba(139, 92, 246, 0.5)',
                    borderRadius: 6,
                });
                document.getElementById('dailyClientLegend').innerHTML = `<div class="legend-item"><div class="legend-color" style="background: rgba(99, 102, 241, 0.8);"></div><span>${currentData.year}년</span></div><div class="legend-item"><div class="legend-color" style="background: rgba(139, 92, 246, 0.5);"></div><span>${compareData.year}년</span></div>${summaryHtml}`;
                document.getElementById('dailyClientLegend').style.display = 'flex';
            } else {
                document.getElementById('dailyClientLegend').innerHTML = summaryHtml;
                document.getElementById('dailyClientLegend').style.display = 'flex';
            }

            // 외부 HTML 툴팁 생성 함수
            const getOrCreateDailyClientTooltip = (chart) => {
                let tooltipEl = document.getElementById('dailyClientChartTooltip');
                if (!tooltipEl) {
                    tooltipEl = document.createElement('div');
                    tooltipEl.id = 'dailyClientChartTooltip';
                    tooltipEl.style.cssText = `
                        position: fixed;
                        background: rgba(30, 41, 59, 0.95);
                        border: 1px solid rgba(99, 102, 241, 0.5);
                        border-radius: 12px;
                        padding: 16px;
                        pointer-events: auto;
                        z-index: 99999;
                        font-size: 12px;
                        color: #e2e8f0;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                        max-width: 320px;
                        max-height: 85vh;
                        overflow-y: auto;
                        transition: opacity 0.2s ease;
                    `;
                    document.body.appendChild(tooltipEl);
                setupTooltipHover(tooltipEl);
                }
                return tooltipEl;
            };

            // 외부 툴팁 핸들러
            const externalTooltipHandler = (context) => {
                const { chart, tooltip } = context;
                const tooltipEl = getOrCreateDailyClientTooltip(chart);

                if (tooltip.opacity === 0 && !isTooltipHovered(tooltipEl)) {
                    hideTooltipWithDelay(tooltipEl);
                    return;
                }

                if (tooltip.body) {
                    const dataIndex = tooltip.dataPoints[0].dataIndex;
                    const datasetIndex = tooltip.dataPoints[0].datasetIndex;
                    const d = chartData[dataIndex];
                    const compD = compChartData[dataIndex];

                    let html = '';

                    // 헤더
                    html += `<div style="font-size: 14px; font-weight: bold; color: #fff; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.2);">👤 ${d.name}</div>`;

                    // 1. 기본 지표
                    html += `<div style="margin-bottom: 4px;">🏢 일 방문 거래처: <strong>${d.avgDailyClients}개</strong></div>`;

                    if (compareData && compD.avgDailyClients > 0) {
                        html += `<div style="margin-bottom: 4px;">📅 ${compareData.year}년: <strong>${compD.avgDailyClients}개</strong></div>`;

                        // 전년 대비
                        const visitDiff = d.avgDailyClients - compD.avgDailyClients;
                        const visitDiffPct = compD.avgDailyClients > 0 ? (visitDiff / compD.avgDailyClients * 100) : 0;
                        const visitColor = visitDiff >= 0 ? '#10b981' : '#ef4444';
                        const visitSign = visitDiff >= 0 ? '+' : '';
                        html += `<div style="margin-bottom: 8px;">📊 전년 대비: <span style="color: ${visitColor}; font-weight: bold;">${visitSign}${visitDiff.toFixed(1)}개 (${visitSign}${visitDiffPct.toFixed(1)}%)</span></div>`;
                    }

                    // 2. 활동량 상세
                    html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 활동량 분석 ──</div>`;
                    html += `<div style="margin-bottom: 4px;">📋 월 총 방문 거래처: <strong>${d.monthlyClients.toLocaleString()}개</strong></div>`;
                    html += `<div style="margin-bottom: 4px;">📆 영업일수: <strong>${Math.round(BUSINESS_DAYS / 12)}일/월</strong></div>`;

                    // 전체 평균 대비
                    const avgDiff = ((d.avgDailyClients - avgAll) / avgAll * 100);
                    const avgDiffColor = avgDiff >= 0 ? '#10b981' : '#ef4444';
                    const avgDiffSign = avgDiff >= 0 ? '+' : '';
                    html += `<div style="margin-bottom: 8px;">📈 전체 평균(${avgAll.toFixed(1)}개) 대비: <span style="color: ${avgDiffColor}; font-weight: bold;">${avgDiffSign}${avgDiff.toFixed(1)}%</span></div>`;

                    // 3. 방문 효율성
                    html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 방문 효율성 ──</div>`;

                    // 방문당 매출
                    const revPerVisitDiff = avgRevenuePerVisit > 0 ? ((d.revenuePerVisit - avgRevenuePerVisit) / avgRevenuePerVisit * 100) : 0;
                    const revDiffColor = revPerVisitDiff >= 0 ? '#10b981' : '#f59e0b';
                    const revDiffSign = revPerVisitDiff >= 0 ? '+' : '';
                    html += `<div style="margin-bottom: 4px;">💰 방문당 매출: <strong>${formatCurrency(Math.round(d.revenuePerVisit))}</strong> <span style="color: ${revDiffColor};">(평균 대비 ${revDiffSign}${revPerVisitDiff.toFixed(0)}%)</span></div>`;

                    // 방문당 접수 건수
                    const casePerVisitDiff = avgCasesPerVisit > 0 ? ((d.casesPerVisit - avgCasesPerVisit) / avgCasesPerVisit * 100) : 0;
                    const caseDiffColor = casePerVisitDiff >= 0 ? '#10b981' : '#f59e0b';
                    const caseDiffSign = casePerVisitDiff >= 0 ? '+' : '';
                    html += `<div style="margin-bottom: 8px;">📝 방문당 접수 건수: <strong>${d.casesPerVisit.toFixed(1)}건</strong> <span style="color: ${caseDiffColor};">(평균 대비 ${caseDiffSign}${casePerVisitDiff.toFixed(0)}%)</span></div>`;

                    // 4. 인사이트 태그
                    if (compareData && compD.avgDailyClients > 0 && compD.sales > 0) {
                        const visitUp = d.avgDailyClients >= compD.avgDailyClients;
                        const salesUp = d.sales >= compD.sales;

                        let tagHtml = '';
                        let tagColor = '';
                        let tagText = '';
                        let tagIcon = '';

                        if (visitUp && salesUp) {
                            tagIcon = '🏆';
                            tagText = '활발한 영업활동';
                            tagColor = 'background: rgba(59, 130, 246, 0.3); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.5);';
                        } else if (visitUp && !salesUp) {
                            tagIcon = '⚠️';
                            tagText = '방문 효율 개선 필요';
                            tagColor = 'background: rgba(245, 158, 11, 0.3); color: #fbbf24; border: 1px solid rgba(245, 158, 11, 0.5);';
                        } else if (!visitUp && salesUp) {
                            tagIcon = '💎';
                            tagText = '고효율 영업';
                            tagColor = 'background: rgba(16, 185, 129, 0.3); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.5);';
                        } else {
                            tagIcon = '🔴';
                            tagText = '활동량 증대 필요';
                            tagColor = 'background: rgba(239, 68, 68, 0.3); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.5);';
                        }

                        html += `<div style="margin-top: 12px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">`;
                        html += `<span style="display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; ${tagColor}">${tagIcon} ${tagText}</span>`;
                        html += `</div>`;
                    }

                    tooltipEl.innerHTML = html;
                }

                // 위치 계산 (화면 밖으로 나가지 않도록)
                const canvasRect = chart.canvas.getBoundingClientRect();

                let left = canvasRect.left + tooltip.caretX + 15;
                let top = canvasRect.top + tooltip.caretY - 10;

                // 우측 경계 체크
                const tooltipWidth = tooltipEl.offsetWidth || 320;
                if (left + tooltipWidth > window.innerWidth - 20) {
                    left = canvasRect.left + tooltip.caretX - tooltipWidth - 15;
                }

                // 하단 경계 체크
                const tooltipHeight = tooltipEl.offsetHeight || 350;
                if (top + tooltipHeight > window.innerHeight - 20) {
                    top = window.innerHeight - tooltipHeight - 20;
                }

                // 상단 경계 체크
                if (top < 10) top = 10;

                tooltipEl.style.opacity = 1; tooltipEl.style.pointerEvents = 'auto';
                tooltipEl.style.left = left + 'px';
                tooltipEl.style.top = top + 'px';
            };

            charts.dailyClient = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: chartData.map(d => d.name),
                    datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: true },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: false,
                            external: externalTooltipHandler
                        }
                    },
                    scales: { y: { beginAtZero: true, title: { display: true, text: '일평균 건수' } } }
                }
            });
        }

        // 담당자 상세 모달
        function showManagerDetail(managerName) {
            const managers = currentData.by_manager || [];
            const manager = managers.find(m => m[0] === managerName);
            if (!manager) return;

            // 현재 선택된 검사목적 필터 확인
            const purposeFilter = document.getElementById('managerPurposeFilter')?.value || '전체';
            const isPurposeFiltered = purposeFilter !== '전체';

            // 모달 제목 (필터 적용 시 표시)
            const titleSuffix = isPurposeFiltered ? ` (${purposeFilter})` : '';
            document.getElementById('modalManagerName').textContent = managerName + ' 상세' + titleSuffix;

            // 담당자별 주요 거래 업체 (manager_top_clients 사용)
            // 필터 적용 시 해당 목적의 업체만 표시
            let managerClients = currentData.manager_top_clients?.[managerName] || [];
            if (isPurposeFiltered) {
                // by_purpose 데이터가 있는 업체 필터링
                const byPurpose = manager[1].by_purpose || {};
                const purposeData = byPurpose[purposeFilter];
                if (purposeData) {
                    // 해당 목적에서의 매출 기준으로 정렬된 업체 표시
                    // (현재 manager_top_clients에서 해당 목적 데이터 필터링)
                    managerClients = managerClients.filter(c => {
                        // 업체별 목적 데이터 확인 (by_client에서)
                        const clientData = (currentData.by_client || []).find(cl => cl[0] === c[0]);
                        return clientData && clientData[1].purposes && clientData[1].purposes[purposeFilter];
                    });
                }
            }
            if (managerClients.length > 0) {
                document.getElementById('modalTopClients').innerHTML = managerClients.slice(0, 5).map(c => `
                    <div class="modal-client-item">
                        <span class="modal-client-name">${c[0]}</span>
                        <span class="modal-client-value">${formatCurrency(c[1].sales)}</span>
                    </div>
                `).join('');
            } else {
                document.getElementById('modalTopClients').innerHTML = '<div style="color: var(--gray-400); font-size: 13px;">데이터 없음</div>';
            }

            // 담당자별 검사 목적별 비중 차트 (purpose_managers 사용)
            const modalCtx = document.getElementById('modalPurposeCanvas');
            if (charts.modalPurpose) charts.modalPurpose.destroy();

            // 목적별 담당자 데이터에서 해당 담당자 데이터 추출
            const managerPurposes = [];
            const purposeManagers = currentData.purpose_managers || {};

            if (isPurposeFiltered) {
                // 필터 적용 시: 해당 목적의 세부 정보만 표시 (by_purpose 사용)
                const byPurpose = manager[1].by_purpose || {};
                const purposeData = byPurpose[purposeFilter];
                if (purposeData) {
                    managerPurposes.push({
                        name: purposeFilter,
                        sales: purposeData.sales,
                        count: purposeData.count
                    });
                }
            } else {
                // 전체: 모든 목적별 데이터
                for (const [purpose, managers] of Object.entries(purposeManagers)) {
                    const mgrData = managers.find(m => m.name === managerName);
                    if (mgrData) {
                        managerPurposes.push({ name: purpose, sales: mgrData.sales });
                    }
                }
            }
            managerPurposes.sort((a, b) => b.sales - a.sales);
            const topPurposes = managerPurposes.slice(0, 5);

            if (topPurposes.length > 0) {
                charts.modalPurpose = new Chart(modalCtx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: topPurposes.map(p => p.name),
                        datasets: [{ data: topPurposes.map(p => p.sales), backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ec4899', '#06b6d4'] }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { font: { size: 11 } } } } }
                });
            }

            // 담당자별 담당 지역 (manager_regions 사용)
            const managerRegions = currentData.manager_regions?.[managerName] || [];
            if (managerRegions.length > 0) {
                document.getElementById('modalRegions').innerHTML = managerRegions.slice(0, 5).map(r =>
                    `<span class="region-tag">${r.region} (${formatCurrency(r.sales)})</span>`
                ).join('');
            } else {
                document.getElementById('modalRegions').innerHTML = '<span style="color: var(--gray-400); font-size: 13px;">데이터 없음</span>';
            }

            document.getElementById('managerModal').style.display = 'flex';
        }

        function closeManagerModal() {
            document.getElementById('managerModal').style.display = 'none';
        }

        // ====== 비밀번호 변경 관련 함수 ======
        function openPasswordModal() {
            console.log('[DEBUG] openPasswordModal() called');
            const modal = document.getElementById('passwordModal');
            console.log('[DEBUG] passwordModal element:', modal);
            if (!modal) {
                console.error('[ERROR] passwordModal element not found!');
                return;
            }
            modal.style.display = 'flex';
            document.getElementById('passwordForm').reset();
            document.getElementById('passwordError').style.display = 'none';
            document.getElementById('passwordSuccess').style.display = 'none';
            document.getElementById('currentPassword').focus();
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
            document.getElementById('passwordForm').reset();
            document.getElementById('passwordError').style.display = 'none';
            document.getElementById('passwordSuccess').style.display = 'none';
        }

        async function changePassword(e) {
            e.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorDiv = document.getElementById('passwordError');
            const successDiv = document.getElementById('passwordSuccess');
            const submitBtn = document.getElementById('passwordSubmitBtn');

            // 에러/성공 메시지 초기화
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';

            // 클라이언트 측 유효성 검사
            if (newPassword !== confirmPassword) {
                errorDiv.textContent = '새 비밀번호가 일치하지 않습니다.';
                errorDiv.style.display = 'block';
                return false;
            }

            if (newPassword.length < 4) {
                errorDiv.textContent = '비밀번호는 4자 이상이어야 합니다.';
                errorDiv.style.display = 'block';
                return false;
            }

            // 버튼 비활성화
            submitBtn.disabled = true;
            submitBtn.textContent = '변경 중...';

            try {
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword,
                        confirm_password: confirmPassword
                    })
                });

                const result = await response.json();

                if (result.success) {
                    successDiv.textContent = result.message || '비밀번호가 성공적으로 변경되었습니다.';
                    successDiv.style.display = 'block';
                    document.getElementById('passwordForm').reset();

                    // 2초 후 모달 닫기
                    setTimeout(() => {
                        closePasswordModal();
                    }, 2000);
                } else {
                    errorDiv.textContent = result.error || '비밀번호 변경에 실패했습니다.';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = '서버 오류가 발생했습니다. 다시 시도해주세요.';
                errorDiv.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '변경하기';
            }

            return false;
        }

        // ESC 키로 모달 닫기
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const passwordModal = document.getElementById('passwordModal');
                if (passwordModal && passwordModal.style.display === 'flex') {
                    closePasswordModal();
                }
            }
        });

        // 모달 바깥 클릭 시 닫기 (DOMContentLoaded 후 실행)
        document.addEventListener('DOMContentLoaded', function() {
            const passwordModal = document.getElementById('passwordModal');
            if (passwordModal) {
                passwordModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closePasswordModal();
                    }
                });
            }
        });

        // ====== 팀별 탭 관련 함수 ======
        function updateTeamTab() {
            // "기타" 팀 제외
            const branches = (currentData.by_branch || []).filter(b => b[0] !== '기타');
            if (branches.length === 0) return;

            const totalBranches = branches.length;
            const totalSales = branches.reduce((sum, b) => sum + (b[1].sales || 0), 0);
            const totalCount = branches.reduce((sum, b) => sum + (b[1].count || 0), 0);
            const avgSales = totalSales / totalBranches;

            // 매출 기준 정렬
            const sortedBranches = [...branches].sort((a, b) => (b[1].sales || 0) - (a[1].sales || 0));

            // ===== 1. 총 팀 수 카드 =====
            document.getElementById('teamTotalBranches').textContent = totalBranches + '개';
            // 팀명 목록 표시
            const branchNames = sortedBranches.map(b => b[0]).join(', ');
            document.getElementById('teamBranchNames').textContent = branchNames;
            document.getElementById('teamBranchNames').title = branchNames; // 전체 보기용 툴팁

            // 비교년도 팀 수
            if (compareData && compareData.by_branch) {
                const compBranchesFiltered = compareData.by_branch.filter(b => b[0] !== '기타');
                const compBranches = compBranchesFiltered.length;
                const diff = totalBranches - compBranches;
                const diffText = diff > 0 ? `+${diff}` : diff.toString();
                document.getElementById('teamTotalBranchesCompare').textContent = `${compareData.year}년: ${compBranches}개 (${diffText})`;
                document.getElementById('teamTotalBranchesCompare').style.display = 'block';
            } else {
                document.getElementById('teamTotalBranchesCompare').style.display = 'none';
            }

            // ===== 2. 팀 평균 매출 카드 =====
            document.getElementById('teamAvgSales').textContent = formatCurrency(avgSales);

            // 상위/중간/하위 팀 분류
            const tierCount = Math.ceil(totalBranches / 3);
            const topTier = sortedBranches.slice(0, tierCount).map(b => b[0]);
            const midTier = sortedBranches.slice(tierCount, tierCount * 2).map(b => b[0]);
            const bottomTier = sortedBranches.slice(tierCount * 2).map(b => b[0]);

            let tierInfo = `🥇 상위: ${topTier.join(', ')}`;
            if (midTier.length > 0) tierInfo += ` | 중간: ${midTier.join(', ')}`;
            if (bottomTier.length > 0) tierInfo += ` | 🔻 하위: ${bottomTier.join(', ')}`;
            document.getElementById('teamTierInfo').textContent = tierInfo;
            document.getElementById('teamTierInfo').title = tierInfo;

            // 비교년도 평균
            if (compareData && compareData.by_branch) {
                const compBranchesForAvg = compareData.by_branch.filter(b => b[0] !== '기타');
                const compTotalSales = compBranchesForAvg.reduce((sum, b) => sum + (b[1].sales || 0), 0);
                const compAvgSales = compTotalSales / compBranchesForAvg.length;
                const avgDiff = ((avgSales - compAvgSales) / compAvgSales * 100).toFixed(1);
                const avgDiffSign = avgDiff > 0 ? '+' : '';
                document.getElementById('teamAvgSalesCompare').textContent = `${compareData.year}년: ${formatCurrency(compAvgSales)} (${avgDiffSign}${avgDiff}%)`;
                document.getElementById('teamAvgSalesCompare').style.display = 'block';
                document.getElementById('teamAvgSalesCompare').style.color = avgDiff >= 0 ? '#10b981' : '#ef4444';
            } else {
                document.getElementById('teamAvgSalesCompare').style.display = 'none';
            }

            // ===== 3. 최고 성과 팀 카드 =====
            const topBranch = sortedBranches[0];
            document.getElementById('teamTopBranch').textContent = topBranch[0];
            document.getElementById('teamTopBranchSales').textContent = '매출: ' + formatCurrency(topBranch[1].sales);

            // 최고 성과 이유 분석
            const topShare = (topBranch[1].sales / totalSales * 100).toFixed(1);
            const topCount = topBranch[1].count || 0;
            const topAvgPrice = topCount > 0 ? topBranch[1].sales / topCount : 0;
            const overallAvgPrice = totalCount > 0 ? totalSales / totalCount : 0;
            const priceVsAvg = overallAvgPrice > 0 ? ((topAvgPrice - overallAvgPrice) / overallAvgPrice * 100).toFixed(0) : 0;

            let reasonText = `전체의 ${topShare}% 점유`;
            if (priceVsAvg > 10) reasonText += ` | 단가 +${priceVsAvg}%`;
            document.getElementById('teamTopBranchReason').textContent = reasonText;

            // 검사목적별 평균 이상 달성 분석
            const topByPurpose = topBranch[1].by_purpose || {};
            const purposeAvgMap = {}; // 전체 팀의 목적별 평균
            branches.forEach(b => {
                const bp = b[1].by_purpose || {};
                Object.entries(bp).forEach(([purpose, data]) => {
                    if (!purposeAvgMap[purpose]) purposeAvgMap[purpose] = { totalSales: 0, totalCount: 0, teamCount: 0 };
                    purposeAvgMap[purpose].totalSales += data.sales || 0;
                    purposeAvgMap[purpose].totalCount += data.count || 0;
                    purposeAvgMap[purpose].teamCount += 1;
                });
            });

            // 평균 이상 달성한 목적 찾기
            const aboveAvgPurposes = [];
            Object.entries(topByPurpose).forEach(([purpose, data]) => {
                const avg = purposeAvgMap[purpose];
                if (avg && avg.teamCount > 0) {
                    const avgSalesPerTeam = avg.totalSales / avg.teamCount;
                    const avgCountPerTeam = avg.totalCount / avg.teamCount;
                    if ((data.sales || 0) > avgSalesPerTeam) {
                        const excessPercent = ((data.sales - avgSalesPerTeam) / avgSalesPerTeam * 100).toFixed(0);
                        aboveAvgPurposes.push({
                            name: purpose,
                            sales: data.sales,
                            count: data.count,
                            avgSales: avgSalesPerTeam,
                            excessPercent: parseFloat(excessPercent)
                        });
                    }
                }
            });
            aboveAvgPurposes.sort((a, b) => b.excessPercent - a.excessPercent);

            // 상위 3개 목적 표시
            if (aboveAvgPurposes.length > 0) {
                const topPurposes = aboveAvgPurposes.slice(0, 3);
                const purposeText = topPurposes.map(p => `${p.name}(+${p.excessPercent}%)`).join(', ');
                document.getElementById('teamTopBranchPurposes').textContent = `평균↑: ${purposeText}`;
                document.getElementById('teamTopBranchPurposes').title = aboveAvgPurposes.map(p =>
                    `${p.name}: ${formatCurrency(p.sales)} (평균 대비 +${p.excessPercent}%)`
                ).join('\\n');
            } else {
                document.getElementById('teamTopBranchPurposes').textContent = '';
            }

            // 비교년도 최고 성과 팀
            if (compareData && compareData.by_branch) {
                const compSorted = [...compareData.by_branch].filter(b => b[0] !== '기타').sort((a, b) => (b[1].sales || 0) - (a[1].sales || 0));
                if (compSorted.length > 0) {
                    const compTopSales = compSorted[0][1].sales || 0;
                    document.getElementById('teamTopBranchCompare').textContent = `${compareData.year}년: ${compSorted[0][0]} (${formatCurrency(compTopSales)})`;
                    document.getElementById('teamTopBranchCompare').style.display = 'block';
                }
            } else {
                document.getElementById('teamTopBranchCompare').style.display = 'none';
            }

            // ===== 4. 최고 성장 팀 카드 =====
            if (compareData && compareData.by_branch) {
                const compareBranchMap = Object.fromEntries(compareData.by_branch.filter(b => b[0] !== '기타'));
                const withGrowth = branches.map(b => {
                    const compData = compareBranchMap[b[0]];
                    const compSales = compData?.sales || 0;
                    const compCount = compData?.count || 0;
                    const salesGrowth = compSales > 0 ? ((b[1].sales - compSales) / compSales * 100) : 0;
                    const countGrowth = compCount > 0 ? ((b[1].count - compCount) / compCount * 100) : 0;
                    const salesDiff = b[1].sales - compSales;
                    const countDiff = (b[1].count || 0) - compCount;
                    return { name: b[0], data: b[1], compData, salesGrowth, countGrowth, salesDiff, countDiff };
                }).sort((a, b) => b.salesGrowth - a.salesGrowth);

                if (withGrowth.length > 0 && withGrowth[0].salesGrowth > 0) {
                    const top = withGrowth[0];
                    document.getElementById('teamTopGrowth').textContent = top.name;
                    document.getElementById('teamTopGrowthRate').textContent = '전년 대비 +' + top.salesGrowth.toFixed(1) + '%';
                    document.getElementById('teamTopGrowthTrend').style.visibility = 'visible';
                    document.getElementById('teamTopGrowthTrend').innerHTML = '↑ +' + top.salesGrowth.toFixed(1) + '%';

                    // 성장 상세 (매출 증가액, 건수 변화)
                    let detailParts = [];
                    if (top.salesDiff > 0) detailParts.push(`매출 +${formatCurrency(top.salesDiff)}`);
                    if (top.countDiff > 0) detailParts.push(`건수 +${top.countDiff.toLocaleString()}건`);
                    else if (top.countDiff < 0) detailParts.push(`건수 ${top.countDiff.toLocaleString()}건`);
                    document.getElementById('teamTopGrowthDetail').textContent = detailParts.join(' | ');

                    // 검사목적별 성장 분석
                    const topByPurposeGrowth = top.data.by_purpose || {};
                    const compByPurpose = top.compData?.by_purpose || {};
                    const purposeGrowthList = [];

                    Object.entries(topByPurposeGrowth).forEach(([purpose, data]) => {
                        const compPurpose = compByPurpose[purpose];
                        const compSales = compPurpose?.sales || 0;
                        if (compSales > 0) {
                            const growth = ((data.sales - compSales) / compSales * 100);
                            const diff = data.sales - compSales;
                            if (growth > 0) {
                                purposeGrowthList.push({
                                    name: purpose,
                                    growth: growth,
                                    diff: diff,
                                    sales: data.sales,
                                    count: data.count
                                });
                            }
                        } else if (data.sales > 0) {
                            // 신규 목적
                            purposeGrowthList.push({
                                name: purpose,
                                growth: 999,
                                diff: data.sales,
                                sales: data.sales,
                                count: data.count,
                                isNew: true
                            });
                        }
                    });
                    purposeGrowthList.sort((a, b) => b.diff - a.diff);

                    if (purposeGrowthList.length > 0) {
                        const topGrowthPurposes = purposeGrowthList.slice(0, 3);
                        const growthText = topGrowthPurposes.map(p =>
                            p.isNew ? `${p.name}(신규)` : `${p.name}(+${p.growth.toFixed(0)}%)`
                        ).join(', ');
                        document.getElementById('teamTopGrowthPurposes').textContent = `성장↑: ${growthText}`;
                        document.getElementById('teamTopGrowthPurposes').title = purposeGrowthList.map(p =>
                            `${p.name}: +${formatCurrency(p.diff)} (${p.isNew ? '신규' : '+' + p.growth.toFixed(0) + '%'})`
                        ).join('\\n');
                    } else {
                        document.getElementById('teamTopGrowthPurposes').textContent = '';
                    }

                    // 비교년도 최고 매출 팀 표시 (성장 비교 기준)
                    const compSortedForGrowth = [...compareData.by_branch].filter(b => b[0] !== '기타').sort((a, b) => (b[1].sales || 0) - (a[1].sales || 0));
                    if (compSortedForGrowth.length > 0) {
                        const compTopSales = compSortedForGrowth[0][1].sales || 0;
                        document.getElementById('teamTopGrowthCompare').textContent = `${compareData.year}년: ${compSortedForGrowth[0][0]} (${formatCurrency(compTopSales)})`;
                        document.getElementById('teamTopGrowthCompare').style.display = 'block';
                    }
                } else {
                    document.getElementById('teamTopGrowth').textContent = '-';
                    document.getElementById('teamTopGrowthRate').textContent = '성장팀 없음';
                    document.getElementById('teamTopGrowthTrend').style.visibility = 'hidden';
                    document.getElementById('teamTopGrowthDetail').textContent = '';
                    document.getElementById('teamTopGrowthPurposes').textContent = '';
                    document.getElementById('teamTopGrowthCompare').style.display = 'none';
                }
            } else {
                document.getElementById('teamTopGrowth').textContent = '-';
                document.getElementById('teamTopGrowthRate').textContent = '전년 비교 필요';
                document.getElementById('teamTopGrowthTrend').style.visibility = 'hidden';
                document.getElementById('teamTopGrowthDetail').textContent = '';
                document.getElementById('teamTopGrowthPurposes').textContent = '';
                document.getElementById('teamTopGrowthCompare').style.display = 'none';
            }

            // 드롭다운 초기화
            initBranchChartPurposeFilter();
            initBranchPerCasePurposeSelect();
            initBranchTablePurposeFilter();

            // 차트들 업데이트
            updateBranchChart();
            updateBranchPerCaseChart();
            updateBranchEfficiencyChart();
            updateBranchMonthlyChart();
            updateBranchTable();
            updateClientRetentionCharts();
            updateBranchRetentionTable();
        }

        // 팀별 목적 필터 초기화
        function initBranchChartPurposeFilter() {
            const purposes = new Set(['전체']);
            (currentData.by_purpose || []).forEach(p => {
                if (p[0] !== '접수취소') purposes.add(p[0]);
            });
            const select = document.getElementById('branchChartPurposeFilter');
            if (select) {
                select.innerHTML = '<option value="전체">전체 검사목적</option>' +
                    Array.from(purposes).filter(p => p !== '전체').map(p =>
                        `<option value="${p}">${p}</option>`
                    ).join('');
            }
        }

        function initBranchPerCasePurposeSelect() {
            const purposes = new Set(['전체']);
            (currentData.by_purpose || []).forEach(p => {
                if (p[0] !== '접수취소') purposes.add(p[0]);
            });
            const select = document.getElementById('branchPerCasePurposeSelect');
            if (select) {
                select.innerHTML = '<option value="전체">전체 목적</option>' +
                    Array.from(purposes).filter(p => p !== '전체').map(p =>
                        `<option value="${p}">${p}</option>`
                    ).join('');
            }
        }

        function initBranchTablePurposeFilter() {
            const purposes = new Set(['전체']);
            (currentData.by_purpose || []).forEach(p => {
                if (p[0] !== '접수취소') purposes.add(p[0]);
            });
            const select = document.getElementById('branchTablePurposeFilter');
            if (select) {
                select.innerHTML = '<option value="전체">전체 검사목적</option>' +
                    Array.from(purposes).filter(p => p !== '전체').map(p =>
                        `<option value="${p}">${p}</option>`
                    ).join('');
            }
        }

        // 팀별 건당 매출 차트
        function updateBranchPerCaseChart() {
            const ctx = document.getElementById('branchPerCaseChart');
            if (!ctx) return;
            if (charts.branchPerCase) charts.branchPerCase.destroy();

            const selectedPurpose = document.getElementById('branchPerCasePurposeSelect')?.value || '전체';
            const sortBy = document.getElementById('branchPerCaseSortBy')?.value || 'avgPrice';
            // "기타" 팀 제외
            const branches = (currentData.by_branch || []).filter(b => b[0] !== '기타');
            const managers = currentData.by_manager || [];
            const managerMap = Object.fromEntries(managers);
            if (branches.length === 0) return;

            // 검사목적별 필터 적용 + 상세 데이터 수집
            const branchData = branches.map(b => {
                let sales = 0, count = 0;
                const byPurpose = b[1].by_purpose || {};
                const memberNames = Array.from(b[1].managers || []);

                if (selectedPurpose === '전체') {
                    sales = b[1].sales || 0;
                    count = b[1].count || 0;
                } else {
                    const purposeData = byPurpose[selectedPurpose];
                    if (purposeData) {
                        sales = purposeData.sales || 0;
                        count = purposeData.count || 0;
                    }
                }
                const avgPrice = count > 0 ? sales / count : 0;

                // 팀원별 단가 정보
                const memberPrices = memberNames.map(name => {
                    const m = managerMap[name];
                    if (!m) return null;
                    let mSales = 0, mCount = 0;
                    if (selectedPurpose === '전체') {
                        mSales = m.sales || 0;
                        mCount = m.count || 0;
                    } else {
                        const pd = m.by_purpose?.[selectedPurpose];
                        if (pd) { mSales = pd.sales || 0; mCount = pd.count || 0; }
                    }
                    const mAvgPrice = mCount > 0 ? mSales / mCount : 0;
                    return { name, avgPrice: mAvgPrice, sales: mSales, count: mCount };
                }).filter(m => m && m.count > 0).sort((a, b) => b.avgPrice - a.avgPrice);

                // 검사목적별 단가 정보
                const purposePrices = Object.entries(byPurpose)
                    .map(([p, d]) => ({
                        name: p,
                        avgPrice: d.count > 0 ? d.sales / d.count : 0,
                        sales: d.sales,
                        count: d.count
                    }))
                    .filter(p => p.count > 0)
                    .sort((a, b) => b.avgPrice - a.avgPrice);

                const memberCount = memberNames.length;
                return {
                    name: b[0],
                    avgPrice,
                    sales,
                    count,
                    memberCount,
                    perPersonSales: memberCount > 0 ? sales / memberCount : 0,
                    memberPrices,
                    purposePrices
                };
            }).filter(d => d.avgPrice > 0);

            // 정렬 기준 적용
            branchData.sort((a, b) => {
                switch (sortBy) {
                    case 'efficiency':
                        return b.perPersonSales - a.perPersonSales;
                    case 'sales':
                        return b.sales - a.sales;
                    case 'count':
                        return b.count - a.count;
                    case 'avgPrice':
                    default:
                        return b.avgPrice - a.avgPrice;
                }
            });

            // 순위 부여
            branchData.forEach((d, i) => d.rank = i + 1);

            const avgAll = branchData.reduce((s, d) => s + d.avgPrice, 0) / (branchData.length || 1);
            const totalSales = branchData.reduce((s, d) => s + d.sales, 0);
            const totalCount = branchData.reduce((s, d) => s + d.count, 0);
            const overallAvgPrice = totalCount > 0 ? totalSales / totalCount : 0;

            // 비교 데이터 처리
            let compareMap = {};
            let compRankMap = {};
            if (compareData) {
                const compareBranches = (compareData.by_branch || []).filter(b => b[0] !== '기타');
                const compBranchData = compareBranches.map(b => {
                    let sales = 0, count = 0;
                    if (selectedPurpose === '전체') {
                        sales = b[1].sales || 0;
                        count = b[1].count || 0;
                    } else {
                        const purposeData = b[1].by_purpose?.[selectedPurpose];
                        if (purposeData) {
                            sales = purposeData.sales || 0;
                            count = purposeData.count || 0;
                        }
                    }
                    const avgPrice = count > 0 ? sales / count : 0;
                    return { name: b[0], avgPrice, sales, count };
                }).filter(d => d.avgPrice > 0).sort((a, b) => b.avgPrice - a.avgPrice);

                compBranchData.forEach((d, i) => {
                    compRankMap[d.name] = i + 1;
                    compareMap[d.name] = { avgPrice: d.avgPrice, sales: d.sales, count: d.count };
                });
            }

            // 외부 HTML 툴팁 생성 함수
            const getOrCreateBranchPerCaseTooltip = (chart) => {
                let tooltipEl = document.getElementById('branchPerCaseChartTooltip');
                if (!tooltipEl) {
                    tooltipEl = document.createElement('div');
                    tooltipEl.id = 'branchPerCaseChartTooltip';
                    tooltipEl.style.cssText = `
                        position: fixed;
                        background: rgba(30, 41, 59, 0.98);
                        border-radius: 12px;
                        padding: 16px;
                        pointer-events: auto;
                        z-index: 99999;
                        font-size: 13px;
                        color: #e2e8f0;
                        box-shadow: 0 20px 40px rgba(0,0,0,0.4);
                        min-width: 340px;
                        max-width: 400px;
                        max-height: 85vh;
                        overflow-y: auto;
                        transition: opacity 0.15s ease;
                        line-height: 1.5;
                    `;
                    document.body.appendChild(tooltipEl);
                setupTooltipHover(tooltipEl);
                }
                return tooltipEl;
            };

            // 외부 툴팁 핸들러
            const externalBranchPerCaseTooltipHandler = (context) => {
                const { chart, tooltip } = context;
                const tooltipEl = getOrCreateBranchPerCaseTooltip(chart);

                if (tooltip.opacity === 0 && !isTooltipHovered(tooltipEl)) {
                    hideTooltipWithDelay(tooltipEl);
                    return;
                }

                if (tooltip.body && tooltip.dataPoints && tooltip.dataPoints.length > 0) {
                    const dataIndex = tooltip.dataPoints[0].dataIndex;
                    const d = branchData[dataIndex];
                    const isTopTeam = d.rank <= 2;
                    const isBottomTeam = d.rank >= branchData.length - 1;
                    const isAboveAvg = d.avgPrice >= avgAll;

                    // 스타일 결정
                    let borderColor, headerBg, rankIcon;
                    if (d.rank === 1) {
                        borderColor = 'rgba(255, 215, 0, 0.8)';
                        headerBg = 'linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 180, 0, 0.2))';
                        rankIcon = '🏆';
                    } else if (d.rank === 2) {
                        borderColor = 'rgba(16, 185, 129, 0.8)';
                        headerBg = 'linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(16, 185, 129, 0.2))';
                        rankIcon = '💎';
                    } else if (isBottomTeam) {
                        borderColor = d.rank === branchData.length ? 'rgba(239, 68, 68, 0.8)' : 'rgba(245, 158, 11, 0.8)';
                        headerBg = d.rank === branchData.length ? 'rgba(239, 68, 68, 0.2)' : 'rgba(245, 158, 11, 0.2)';
                        rankIcon = d.rank === branchData.length ? '🔴' : '⚠️';
                    } else {
                        borderColor = isAboveAvg ? 'rgba(16, 185, 129, 0.6)' : 'rgba(245, 158, 11, 0.6)';
                        headerBg = isAboveAvg ? 'rgba(16, 185, 129, 0.2)' : 'rgba(245, 158, 11, 0.2)';
                        rankIcon = '';
                    }
                    tooltipEl.style.border = `2px solid ${borderColor}`;

                    let html = '';

                    // 1. 헤더
                    html += `<div style="font-size: 16px; font-weight: bold; color: #fff; margin: -16px -16px 12px -16px; padding: 12px 16px; background: ${headerBg}; border-radius: 10px 10px 0 0; display: flex; justify-content: space-between; align-items: center;">
                        <span>${rankIcon} ${d.name}</span>
                        <span style="background: rgba(255,255,255,0.2); padding: 2px 10px; border-radius: 12px; font-size: 12px;">단가 ${d.rank}위</span>
                    </div>`;

                    // 2. 기본 지표
                    html += `<div style="margin-bottom: 4px;">💵 건당 매출: <strong>${formatCurrency(Math.round(d.avgPrice))}</strong></div>`;
                    html += `<div style="margin-bottom: 8px;">📋 총건수: <strong>${d.count.toLocaleString()}건</strong> | 총매출: <strong>${(d.sales / 100000000).toFixed(2)}억</strong></div>`;

                    // 3. 팀 구성 & 생산성
                    html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 팀 구성 & 생산성 ──</div>`;
                    html += `<div style="margin-bottom: 4px;">👥 소속 인원: <strong>${d.memberCount}명</strong></div>`;

                    const perPersonCount = d.memberCount > 0 ? d.count / d.memberCount : 0;
                    const totalMembers = branchData.reduce((sum, b) => sum + b.memberCount, 0);
                    const avgCountPerPerson = totalMembers > 0 ? totalCount / totalMembers : 0;
                    const perCountVsAvg = avgCountPerPerson > 0 ? ((perPersonCount - avgCountPerPerson) / avgCountPerPerson * 100) : 0;
                    const pcColor = perCountVsAvg >= 0 ? '#10b981' : '#ef4444';
                    const pcSign = perCountVsAvg >= 0 ? '+' : '';
                    html += `<div style="margin-bottom: 4px;">📊 인당 건수: <strong>${Math.round(perPersonCount).toLocaleString()}건</strong> <span style="color: ${pcColor};">(평균 대비 ${pcSign}${perCountVsAvg.toFixed(1)}%)</span></div>`;

                    // 4. 전체 대비 점유율 & 단가 비교
                    const priceVsAvg = avgAll > 0 ? ((d.avgPrice - avgAll) / avgAll * 100) : 0;
                    const priceVsOverall = overallAvgPrice > 0 ? ((d.avgPrice - overallAvgPrice) / overallAvgPrice * 100) : 0;
                    html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 전체 대비 점유율 ──</div>`;

                    const avgColor = priceVsAvg >= 0 ? '#10b981' : '#ef4444';
                    const avgSign = priceVsAvg >= 0 ? '+' : '';
                    html += `<div style="margin-bottom: 4px;">📈 팀평균 대비: <span style="color: ${avgColor}; font-weight: bold;">${avgSign}${priceVsAvg.toFixed(1)}%</span> (${d.rank}위/${branchData.length}팀)</div>`;

                    const overallColor = priceVsOverall >= 0 ? '#10b981' : '#ef4444';
                    const overallSign = priceVsOverall >= 0 ? '+' : '';
                    html += `<div style="margin-bottom: 4px;">📊 전체평균 대비: <span style="color: ${overallColor};">${overallSign}${priceVsOverall.toFixed(1)}%</span> (전체: ${formatCurrency(Math.round(overallAvgPrice))})</div>`;

                    // 5. 전년 대비 성장률
                    if (compareData && compareMap[d.name]) {
                        const compData = compareMap[d.name];
                        const yoyDiff = d.avgPrice - compData.avgPrice;
                        const yoyPct = compData.avgPrice > 0 ? (yoyDiff / compData.avgPrice * 100) : 0;
                        const yoyColor = yoyDiff >= 0 ? '#10b981' : '#ef4444';
                        const yoySign = yoyDiff >= 0 ? '+' : '';

                        html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 전년 대비 성장률 ──</div>`;
                        html += `<div style="margin-bottom: 4px;">💵 단가 변화: <span style="color: ${yoyColor}; font-weight: bold;">${yoySign}${formatCurrency(Math.round(yoyDiff))} (${yoySign}${yoyPct.toFixed(1)}%)</span></div>`;

                        // 순위 변동
                        const compRank = compRankMap[d.name];
                        if (compRank) {
                            const rankDiff = compRank - d.rank;
                            const rankColor = rankDiff > 0 ? '#10b981' : (rankDiff < 0 ? '#ef4444' : '#94a3b8');
                            const rankIcon = rankDiff > 0 ? '▲' : (rankDiff < 0 ? '▼' : '─');
                            html += `<div style="margin-bottom: 4px;">🏅 순위 변동: ${compRank}위 → ${d.rank}위 <span style="color: ${rankColor};">(${rankIcon}${Math.abs(rankDiff)})</span></div>`;
                        }
                    }

                    // 6. 단가 구성 분석 (고단가/저단가 검사목적)
                    if (d.purposePrices && d.purposePrices.length > 0) {
                        html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 단가 구성 분석 ──</div>`;

                        // 고단가 TOP 3
                        const highPrices = d.purposePrices.slice(0, 3);
                        html += `<div style="margin-bottom: 4px; color: #10b981; font-weight: 600;">▲ 고단가 검사목적</div>`;
                        highPrices.forEach((p, idx) => {
                            const emoji = idx === 0 ? '🥇' : (idx === 1 ? '🥈' : '🥉');
                            html += `<div style="margin-left: 8px; margin-bottom: 2px;">${emoji} ${p.name}: ${formatCurrency(Math.round(p.avgPrice))} <span style="color: #94a3b8;">(${p.count}건)</span></div>`;
                        });

                        // 저단가 하위 2개 (있다면)
                        if (d.purposePrices.length > 3) {
                            const lowPrices = d.purposePrices.slice(-2).reverse();
                            html += `<div style="margin-top: 6px; margin-bottom: 4px; color: #f59e0b; font-weight: 600;">▼ 저단가 검사목적</div>`;
                            lowPrices.forEach(p => {
                                html += `<div style="margin-left: 8px; margin-bottom: 2px;">• ${p.name}: ${formatCurrency(Math.round(p.avgPrice))} <span style="color: #94a3b8;">(${p.count}건)</span></div>`;
                            });
                        }
                    }

                    // 7. 팀 내 단가 분포 (편차)
                    if (d.memberPrices && d.memberPrices.length > 1) {
                        const prices = d.memberPrices.map(m => m.avgPrice);
                        const maxPrice = Math.max(...prices);
                        const minPrice = Math.min(...prices);
                        const priceGap = maxPrice - minPrice;
                        const priceVariance = Math.sqrt(prices.reduce((sum, p) => sum + Math.pow(p - d.avgPrice, 2), 0) / prices.length);
                        const cv = d.avgPrice > 0 ? (priceVariance / d.avgPrice * 100) : 0;

                        html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 팀 내 단가 분포 ──</div>`;
                        html += `<div style="margin-bottom: 4px;">📊 최고: <span style="color: #10b981;">${formatCurrency(Math.round(maxPrice))}</span> | 최저: <span style="color: #ef4444;">${formatCurrency(Math.round(minPrice))}</span></div>`;
                        html += `<div style="margin-bottom: 4px;">📉 단가 편차: ${formatCurrency(Math.round(priceGap))} (CV: ${cv.toFixed(1)}%)</div>`;

                        // TOP/BOTTOM 담당자
                        const topMember = d.memberPrices[0];
                        const bottomMember = d.memberPrices[d.memberPrices.length - 1];
                        html += `<div style="margin-bottom: 2px;">🥇 최고: ${topMember.name} (${formatCurrency(Math.round(topMember.avgPrice))})</div>`;
                        html += `<div style="margin-bottom: 2px;">🔻 최저: ${bottomMember.name} (${formatCurrency(Math.round(bottomMember.avgPrice))})</div>`;
                    }

                    // 8. 수익성 기여도 (평균 대비 추가 매출)
                    const extraRevenue = (d.avgPrice - overallAvgPrice) * d.count;
                    html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 수익성 기여도 ──</div>`;

                    const extraColor = extraRevenue >= 0 ? '#10b981' : '#ef4444';
                    const extraSign = extraRevenue >= 0 ? '+' : '';
                    const extraLabel = extraRevenue >= 0 ? '추가 매출 기여' : '매출 손실';
                    html += `<div style="margin-bottom: 4px;">💰 ${extraLabel}: <span style="color: ${extraColor}; font-weight: bold;">${extraSign}${(extraRevenue / 10000).toFixed(0)}만</span></div>`;

                    if (extraRevenue >= 0) {
                        html += `<div style="color: #60a5fa; font-size: 11px; margin-top: 4px;">→ 전체 평균 단가보다 높은 단가로 수익성에 기여</div>`;
                    } else {
                        // 개선 기회
                        const potentialGain = (avgAll - d.avgPrice) * d.count;
                        html += `<div style="color: #f59e0b; font-size: 11px; margin-top: 4px;">💡 팀평균 달성 시: <span style="color: #10b981;">+${(potentialGain / 10000).toFixed(0)}만</span> 추가 가능</div>`;
                    }

                    tooltipEl.innerHTML = html;
                }

                // 위치 계산
                const canvasRect = chart.canvas.getBoundingClientRect();
                let left = canvasRect.left + tooltip.caretX + 15;
                let top = canvasRect.top + tooltip.caretY - 10;

                const tooltipWidth = tooltipEl.offsetWidth || 380;
                if (left + tooltipWidth > window.innerWidth - 20) {
                    left = canvasRect.left + tooltip.caretX - tooltipWidth - 15;
                }

                const tooltipHeight = tooltipEl.offsetHeight || 600;
                if (top + tooltipHeight > window.innerHeight - 20) {
                    top = window.innerHeight - tooltipHeight - 20;
                }
                if (top < 10) top = 10;

                tooltipEl.style.opacity = 1; tooltipEl.style.pointerEvents = 'auto';
                tooltipEl.style.left = left + 'px';
                tooltipEl.style.top = top + 'px';
            };

            const legendEl = document.getElementById('branchPerCaseLegend');

            if (compareData) {
                legendEl.innerHTML = `
                    <div class="legend-item"><div class="legend-color" style="background: rgba(16, 185, 129, 0.8);"></div><span>${currentData.year}년</span></div>
                    <div class="legend-item"><div class="legend-color" style="background: rgba(245, 158, 11, 0.6);"></div><span>${compareData.year}년</span></div>
                    <div style="margin-left: auto; display: flex; gap: 20px; font-size: 12px; color: #666;">
                        <span>총매출: <strong>${formatCurrency(totalSales)}</strong></span>
                        <span>총건수: <strong>${totalCount.toLocaleString()}건</strong></span>
                        <span>평균단가: <strong>${formatCurrency(Math.round(avgAll))}</strong></span>
                    </div>`;
                legendEl.style.display = 'flex';

                charts.branchPerCase = new Chart(ctx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: branchData.map(b => b.name),
                        datasets: [
                            { label: currentData.year + '년', data: branchData.map(b => b.avgPrice), backgroundColor: 'rgba(16, 185, 129, 0.8)', borderRadius: 6 },
                            { label: compareData.year + '년', data: branchData.map(b => compareMap[b.name]?.avgPrice || 0), backgroundColor: 'rgba(245, 158, 11, 0.6)', borderRadius: 6 }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                    interaction: { intersect: true },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                enabled: false,
                                external: externalBranchPerCaseTooltipHandler
                            }
                        },
                        scales: {
                            y: { beginAtZero: true, ticks: { callback: v => formatCurrency(v) } },
                            x: { grid: { display: false } }
                        }
                    }
                });
            } else {
                legendEl.innerHTML = `
                    <div style="display: flex; gap: 20px; font-size: 12px; color: #666;">
                        <span>총매출: <strong>${formatCurrency(totalSales)}</strong></span>
                        <span>총건수: <strong>${totalCount.toLocaleString()}건</strong></span>
                        <span>평균단가: <strong>${formatCurrency(Math.round(avgAll))}</strong></span>
                    </div>`;
                legendEl.style.display = 'flex';

                charts.branchPerCase = new Chart(ctx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: branchData.map(b => b.name),
                        datasets: [{
                            label: '건당 매출',
                            data: branchData.map(b => b.avgPrice),
                            backgroundColor: branchData.map(d => d.avgPrice >= avgAll ? 'rgba(16, 185, 129, 0.7)' : 'rgba(245, 158, 11, 0.7)'),
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                    interaction: { intersect: true },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                enabled: false,
                                external: externalBranchPerCaseTooltipHandler
                            }
                        },
                        scales: {
                            y: { beginAtZero: true, ticks: { callback: v => formatCurrency(v) } },
                            x: { grid: { display: false } }
                        }
                    }
                });
            }
        }

        // 지사별 효율성 분석 산점도
        function updateBranchEfficiencyChart() {
            const ctx = document.getElementById('branchEfficiencyChart');
            if (!ctx) return;
            if (charts.branchEfficiency) charts.branchEfficiency.destroy();

            const branches = currentData.by_branch || [];
            const managers = currentData.by_manager || [];
            const managerMap = Object.fromEntries(managers);
            if (branches.length === 0) return;

            const avgCount = branches.reduce((sum, b) => sum + (b[1].count || 0), 0) / branches.length;
            const avgSales = branches.reduce((sum, b) => sum + (b[1].sales || 0), 0) / branches.length;
            const totalCount = branches.reduce((sum, b) => sum + (b[1].count || 0), 0);
            const totalSales = branches.reduce((sum, b) => sum + (b[1].sales || 0), 0);

            // 비교 데이터 처리
            let compareMap = {};
            let compAvgCount = 0, compAvgSales = 0;
            if (compareData) {
                const compareBranches = compareData.by_branch || [];
                compAvgCount = compareBranches.reduce((sum, b) => sum + (b[1].count || 0), 0) / (compareBranches.length || 1);
                compAvgSales = compareBranches.reduce((sum, b) => sum + (b[1].sales || 0), 0) / (compareBranches.length || 1);
                compareBranches.forEach(b => {
                    compareMap[b[0]] = { count: b[1].count || 0, sales: b[1].sales || 0 };
                });
            }

            // 사분면 정의
            const getQuadrant = (count, sales) => {
                const isHighCount = count >= avgCount;
                const isHighSales = sales >= avgSales;
                if (isHighCount && isHighSales) return { name: '스타', icon: '⭐', color: 'rgba(16, 185, 129, 0.8)', desc: '고건수 + 고매출' };
                if (!isHighCount && isHighSales) return { name: '효율형', icon: '💎', color: 'rgba(99, 102, 241, 0.8)', desc: '저건수 + 고매출 (고단가)' };
                if (isHighCount && !isHighSales) return { name: '볼륨형', icon: '📦', color: 'rgba(245, 158, 11, 0.8)', desc: '고건수 + 저매출 (저단가)' };
                return { name: '개선필요', icon: '🔴', color: 'rgba(239, 68, 68, 0.8)', desc: '저건수 + 저매출' };
            };

            // 데이터 가공
            const data = branches.map(b => {
                const count = b[1].count || 0;
                const sales = b[1].sales || 0;
                const avgPrice = count > 0 ? sales / count : 0;
                const memberNames = Array.from(b[1].managers || []);
                const quadrant = getQuadrant(count, sales);

                // 팀원별 사분면 분포
                const memberQuadrants = { star: 0, efficient: 0, volume: 0, improve: 0 };
                memberNames.forEach(name => {
                    const m = managerMap[name];
                    if (!m) return;
                    const mq = getQuadrant(m.count || 0, m.sales || 0);
                    if (mq.name === '스타') memberQuadrants.star++;
                    else if (mq.name === '효율형') memberQuadrants.efficient++;
                    else if (mq.name === '볼륨형') memberQuadrants.volume++;
                    else memberQuadrants.improve++;
                });

                // 전년 대비 위치
                const compData = compareMap[b[0]];
                let movement = null;
                if (compData) {
                    const prevQuadrant = getQuadrant(compData.count, compData.sales);
                    const countDiff = count - compData.count;
                    const salesDiff = sales - compData.sales;
                    movement = {
                        prevQuadrant: prevQuadrant.name,
                        countDiff,
                        salesDiff,
                        direction: salesDiff >= 0 && countDiff >= 0 ? '↗' :
                                   salesDiff >= 0 && countDiff < 0 ? '↖' :
                                   salesDiff < 0 && countDiff >= 0 ? '↘' : '↙'
                    };
                }

                return {
                    x: count,
                    y: sales,
                    name: b[0],
                    avgPrice,
                    memberCount: memberNames.length,
                    memberQuadrants,
                    quadrant,
                    movement,
                    color: quadrant.color
                };
            });

            // 순위 부여 (매출 기준)
            const sortedBySales = [...data].sort((a, b) => b.y - a.y);
            sortedBySales.forEach((d, i) => d.salesRank = i + 1);

            // 외부 HTML 툴팁 생성 함수
            const getOrCreateEfficiencyTooltip = (chart) => {
                let tooltipEl = document.getElementById('branchEfficiencyChartTooltip');
                if (!tooltipEl) {
                    tooltipEl = document.createElement('div');
                    tooltipEl.id = 'branchEfficiencyChartTooltip';
                    tooltipEl.style.cssText = `
                        position: fixed;
                        background: rgba(30, 41, 59, 0.98);
                        border-radius: 12px;
                        padding: 16px;
                        pointer-events: auto;
                        z-index: 99999;
                        font-size: 13px;
                        color: #e2e8f0;
                        box-shadow: 0 20px 40px rgba(0,0,0,0.4);
                        min-width: 340px;
                        max-width: 400px;
                        max-height: 85vh;
                        overflow-y: auto;
                        transition: opacity 0.15s ease;
                        line-height: 1.5;
                    `;
                    document.body.appendChild(tooltipEl);
                setupTooltipHover(tooltipEl);
                }
                return tooltipEl;
            };

            // 외부 툴팁 핸들러
            const externalEfficiencyTooltipHandler = (context) => {
                const { chart, tooltip } = context;
                const tooltipEl = getOrCreateEfficiencyTooltip(chart);

                if (tooltip.opacity === 0 && !isTooltipHovered(tooltipEl)) {
                    hideTooltipWithDelay(tooltipEl);
                    return;
                }

                if (tooltip.body && tooltip.dataPoints && tooltip.dataPoints.length > 0) {
                    const dataIndex = tooltip.dataPoints[0].dataIndex;
                    const d = data[dataIndex];

                    // 스타일 결정
                    tooltipEl.style.border = `2px solid ${d.quadrant.color}`;
                    const headerBg = d.quadrant.name === '스타' ? 'linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(16, 185, 129, 0.2))' :
                                     d.quadrant.name === '효율형' ? 'linear-gradient(135deg, rgba(99, 102, 241, 0.3), rgba(139, 92, 246, 0.2))' :
                                     d.quadrant.name === '볼륨형' ? 'linear-gradient(135deg, rgba(245, 158, 11, 0.3), rgba(245, 158, 11, 0.2))' :
                                     'linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(239, 68, 68, 0.2))';

                    let html = '';

                    // 1. 헤더 (팀명 + 사분면 배지)
                    html += `<div style="font-size: 16px; font-weight: bold; color: #fff; margin: -16px -16px 12px -16px; padding: 12px 16px; background: ${headerBg}; border-radius: 10px 10px 0 0; display: flex; justify-content: space-between; align-items: center;">
                        <span>${d.quadrant.icon} ${d.name}</span>
                        <span style="background: rgba(255,255,255,0.2); padding: 2px 10px; border-radius: 12px; font-size: 12px;">${d.quadrant.name}</span>
                    </div>`;

                    // 2. 사분면 설명
                    html += `<div style="margin-bottom: 8px; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 6px; font-size: 12px;">📍 <strong>${d.quadrant.desc}</strong></div>`;

                    // 3. 기본 지표
                    html += `<div style="margin-bottom: 4px;">💰 매출: <strong>${(d.y / 100000000).toFixed(2)}억</strong> (${d.salesRank}위)</div>`;
                    html += `<div style="margin-bottom: 4px;">📋 건수: <strong>${d.x.toLocaleString()}건</strong></div>`;
                    html += `<div style="margin-bottom: 8px;">💵 건당 매출: <strong>${formatCurrency(Math.round(d.avgPrice))}</strong></div>`;

                    // 4. 팀 구성 & 생산성
                    html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 팀 구성 & 생산성 ──</div>`;
                    html += `<div style="margin-bottom: 4px;">👥 소속 인원: <strong>${d.memberCount}명</strong></div>`;

                    const perPersonSales = d.memberCount > 0 ? d.y / d.memberCount : 0;
                    const perPersonCount = d.memberCount > 0 ? d.x / d.memberCount : 0;
                    const totalMembers = data.reduce((sum, b) => sum + b.memberCount, 0);
                    const avgPerPersonSales = totalMembers > 0 ? totalSales / totalMembers : 0;
                    const avgPerPersonCount = totalMembers > 0 ? totalCount / totalMembers : 0;

                    const ppSalesVsAvg = avgPerPersonSales > 0 ? ((perPersonSales - avgPerPersonSales) / avgPerPersonSales * 100) : 0;
                    const ppSalesColor = ppSalesVsAvg >= 0 ? '#10b981' : '#ef4444';
                    const ppSalesSign = ppSalesVsAvg >= 0 ? '+' : '';
                    html += `<div style="margin-bottom: 4px;">💵 인당 매출: <strong>${(perPersonSales / 100000000).toFixed(2)}억</strong> <span style="color: ${ppSalesColor};">(${ppSalesSign}${ppSalesVsAvg.toFixed(1)}%)</span></div>`;

                    const ppCountVsAvg = avgPerPersonCount > 0 ? ((perPersonCount - avgPerPersonCount) / avgPerPersonCount * 100) : 0;
                    const ppCountColor = ppCountVsAvg >= 0 ? '#10b981' : '#ef4444';
                    const ppCountSign = ppCountVsAvg >= 0 ? '+' : '';
                    html += `<div style="margin-bottom: 4px;">📊 인당 건수: <strong>${Math.round(perPersonCount).toLocaleString()}건</strong> <span style="color: ${ppCountColor};">(${ppCountSign}${ppCountVsAvg.toFixed(1)}%)</span></div>`;

                    // 5. 평균선 대비 거리
                    html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 평균선 대비 거리 ──</div>`;

                    const countGap = d.x - avgCount;
                    const salesGap = d.y - avgSales;
                    const countGapPct = avgCount > 0 ? (countGap / avgCount * 100) : 0;
                    const salesGapPct = avgSales > 0 ? (salesGap / avgSales * 100) : 0;

                    const countGapColor = countGap >= 0 ? '#10b981' : '#ef4444';
                    const countGapSign = countGap >= 0 ? '+' : '';
                    html += `<div style="margin-bottom: 4px;">📋 건수 평균 대비: <span style="color: ${countGapColor};">${countGapSign}${countGap.toLocaleString()}건 (${countGapSign}${countGapPct.toFixed(1)}%)</span></div>`;

                    const salesGapColor = salesGap >= 0 ? '#10b981' : '#ef4444';
                    const salesGapSign = salesGap >= 0 ? '+' : '';
                    html += `<div style="margin-bottom: 4px;">💰 매출 평균 대비: <span style="color: ${salesGapColor};">${salesGapSign}${(salesGap / 10000).toFixed(0)}만 (${salesGapSign}${salesGapPct.toFixed(1)}%)</span></div>`;

                    // 6. 전년 대비 이동 방향
                    if (d.movement) {
                        html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 전년 대비 이동 ──</div>`;

                        const movementColor = d.movement.salesDiff >= 0 ? '#10b981' : '#ef4444';
                        html += `<div style="margin-bottom: 4px; font-size: 20px; text-align: center;">
                            <span style="color: ${movementColor};">${d.movement.direction}</span>
                        </div>`;

                        if (d.movement.prevQuadrant !== d.quadrant.name) {
                            html += `<div style="margin-bottom: 4px; text-align: center;">🔄 <span style="color: #f59e0b;">${d.movement.prevQuadrant}</span> → <span style="color: #10b981;">${d.quadrant.name}</span></div>`;
                        } else {
                            html += `<div style="margin-bottom: 4px; text-align: center; color: #94a3b8;">사분면 유지: ${d.quadrant.name}</div>`;
                        }

                        const cntDiffColor = d.movement.countDiff >= 0 ? '#10b981' : '#ef4444';
                        const cntDiffSign = d.movement.countDiff >= 0 ? '+' : '';
                        const slsDiffColor = d.movement.salesDiff >= 0 ? '#10b981' : '#ef4444';
                        const slsDiffSign = d.movement.salesDiff >= 0 ? '+' : '';
                        html += `<div style="margin-bottom: 2px;">📋 건수: <span style="color: ${cntDiffColor};">${cntDiffSign}${d.movement.countDiff.toLocaleString()}건</span></div>`;
                        html += `<div style="margin-bottom: 2px;">💰 매출: <span style="color: ${slsDiffColor};">${slsDiffSign}${(d.movement.salesDiff / 10000).toFixed(0)}만</span></div>`;
                    }

                    // 7. 팀원 사분면 분포
                    if (d.memberCount > 1) {
                        html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 팀원 사분면 분포 ──</div>`;

                        const mq = d.memberQuadrants;
                        const barColors = { star: '#10b981', efficient: '#6366f1', volume: '#f59e0b', improve: '#ef4444' };

                        let barHtml = '<div style="display: flex; height: 16px; border-radius: 4px; overflow: hidden; margin-bottom: 6px;">';
                        if (mq.star > 0) barHtml += `<div style="width: ${mq.star / d.memberCount * 100}%; background: ${barColors.star};" title="스타 ${mq.star}명"></div>`;
                        if (mq.efficient > 0) barHtml += `<div style="width: ${mq.efficient / d.memberCount * 100}%; background: ${barColors.efficient};" title="효율형 ${mq.efficient}명"></div>`;
                        if (mq.volume > 0) barHtml += `<div style="width: ${mq.volume / d.memberCount * 100}%; background: ${barColors.volume};" title="볼륨형 ${mq.volume}명"></div>`;
                        if (mq.improve > 0) barHtml += `<div style="width: ${mq.improve / d.memberCount * 100}%; background: ${barColors.improve};" title="개선필요 ${mq.improve}명"></div>`;
                        barHtml += '</div>';
                        html += barHtml;

                        html += `<div style="display: flex; flex-wrap: wrap; gap: 8px; font-size: 11px;">`;
                        if (mq.star > 0) html += `<span>⭐ 스타 ${mq.star}명</span>`;
                        if (mq.efficient > 0) html += `<span>💎 효율형 ${mq.efficient}명</span>`;
                        if (mq.volume > 0) html += `<span>📦 볼륨형 ${mq.volume}명</span>`;
                        if (mq.improve > 0) html += `<span>🔴 개선필요 ${mq.improve}명</span>`;
                        html += `</div>`;
                    }

                    // 8. 개선 시뮬레이션 (스타 사분면이 아닌 경우)
                    if (d.quadrant.name !== '스타') {
                        html += `<div style="color: #f59e0b; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2); font-weight: 600;">── 개선 시뮬레이션 ──</div>`;

                        if (d.quadrant.name === '효율형') {
                            // 건수 늘리면 스타
                            const neededCount = avgCount - d.x;
                            html += `<div style="margin-bottom: 4px;">🎯 스타 진입 조건: 건수 <span style="color: #10b981;">+${neededCount.toLocaleString()}건</span></div>`;
                            const potentialSales = neededCount * d.avgPrice;
                            html += `<div style="margin-left: 8px; color: #60a5fa; font-size: 11px;">→ 예상 추가 매출: +${(potentialSales / 10000).toFixed(0)}만</div>`;
                        } else if (d.quadrant.name === '볼륨형') {
                            // 단가 올리면 스타
                            const neededSales = avgSales - d.y;
                            const avgPriceTarget = d.x > 0 ? avgSales / d.x : 0;
                            html += `<div style="margin-bottom: 4px;">🎯 스타 진입 조건: 매출 <span style="color: #10b981;">+${(neededSales / 10000).toFixed(0)}만</span></div>`;
                            html += `<div style="margin-left: 8px; color: #60a5fa; font-size: 11px;">→ 필요 건당 단가: ${formatCurrency(Math.round(avgPriceTarget))}</div>`;
                        } else {
                            // 둘 다 필요
                            const neededCount = avgCount - d.x;
                            const neededSales = avgSales - d.y;
                            html += `<div style="margin-bottom: 4px;">🎯 스타 진입 조건:</div>`;
                            html += `<div style="margin-left: 8px; margin-bottom: 2px;">• 건수: <span style="color: #10b981;">+${neededCount.toLocaleString()}건</span></div>`;
                            html += `<div style="margin-left: 8px; margin-bottom: 2px;">• 매출: <span style="color: #10b981;">+${(neededSales / 10000).toFixed(0)}만</span></div>`;
                        }

                        // 벤치마크 대상
                        const starTeams = data.filter(t => t.quadrant.name === '스타').sort((a, b) => b.y - a.y);
                        if (starTeams.length > 0) {
                            html += `<div style="margin-top: 6px;">🏆 벤치마크: <span style="color: #60a5fa;">${starTeams[0].name}</span></div>`;
                        }
                    }

                    tooltipEl.innerHTML = html;
                }

                // 위치 계산
                const canvasRect = chart.canvas.getBoundingClientRect();
                let left = canvasRect.left + tooltip.caretX + 15;
                let top = canvasRect.top + tooltip.caretY - 10;

                const tooltipWidth = tooltipEl.offsetWidth || 380;
                if (left + tooltipWidth > window.innerWidth - 20) {
                    left = canvasRect.left + tooltip.caretX - tooltipWidth - 15;
                }

                const tooltipHeight = tooltipEl.offsetHeight || 600;
                if (top + tooltipHeight > window.innerHeight - 20) {
                    top = window.innerHeight - tooltipHeight - 20;
                }
                if (top < 10) top = 10;

                tooltipEl.style.opacity = 1; tooltipEl.style.pointerEvents = 'auto';
                tooltipEl.style.left = left + 'px';
                tooltipEl.style.top = top + 'px';
            };

            charts.branchEfficiency = new Chart(ctx.getContext('2d'), {
                type: 'scatter',
                data: {
                    datasets: [{
                        data: data.map(d => ({ x: d.x, y: d.y })),
                        backgroundColor: data.map(d => d.color),
                        pointRadius: 15,
                        pointHoverRadius: 20,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: true },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: false,
                            external: externalEfficiencyTooltipHandler
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: '건수' }, grid: { color: 'rgba(0,0,0,0.05)' } },
                        y: { title: { display: true, text: '매출 (공급가액)' }, ticks: { callback: v => formatCurrency(v) }, grid: { color: 'rgba(0,0,0,0.05)' } }
                    }
                }
            });
        }

        // 지사별 월별 추이
        let branchMonthlyFilter = 'top3';  // 기본값을 TOP 3으로 변경
        let branchMonthlySelected = '';

        function initBranchMonthlySelect() {
            // "기타" 팀 제외
            const branches = (currentData.by_branch || []).filter(b => b[0] !== '기타');
            const select = document.getElementById('branchMonthlySelect');
            if (select) {
                select.innerHTML = '<option value="">팀 선택</option>' +
                    branches.map(b => `<option value="${b[0]}">${b[0]}</option>`).join('');
            }
            // 비교년도 드롭다운 초기화
            const compareSelect = document.getElementById('branchMonthlyCompareSelect');
            if (compareSelect && availableYears && availableYears.length > 0) {
                const currentVal = compareSelect.value;
                compareSelect.innerHTML = '<option value="">비교 없음</option>' +
                    availableYears.filter(y => y !== currentData.year).map(y => `<option value="${y}">${y}년</option>`).join('');
                if (currentVal) compareSelect.value = currentVal;
            }
        }

        function setBranchMonthlyFilter(type) {
            branchMonthlyFilter = type;
            document.getElementById('branchMonthlyAll').classList.toggle('active', type === 'all');
            document.getElementById('branchMonthlyTop3').classList.toggle('active', type === 'top3');
            if (type === 'select') {
                branchMonthlySelected = document.getElementById('branchMonthlySelect').value;
            } else {
                document.getElementById('branchMonthlySelect').value = '';
                branchMonthlySelected = '';
            }
            updateBranchMonthlyChart();
        }

        function updateBranchMonthlyChart() {
            const ctx = document.getElementById('branchMonthlyChart');
            if (!ctx) return;
            if (charts.branchMonthly) charts.branchMonthly.destroy();

            // 드롭다운 초기화
            initBranchMonthlySelect();

            const labels = ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'];
            // 더 구분하기 쉬운 색상 배열
            const colors = ['#6366f1', '#10b981', '#f59e0b', '#ec4899', '#06b6d4', '#8b5cf6', '#ef4444', '#14b8a6'];
            // "기타" 팀 제외
            let branches = [...(currentData.by_branch || [])].filter(b => b[0] !== '기타');
            const monthMap = Object.fromEntries(currentData.by_month || []);
            // 비교년도 드롭다운에서 선택된 값 확인
            const selectedCompareYear = document.getElementById('branchMonthlyCompareSelect')?.value;

            // 필터 적용
            if (branchMonthlyFilter === 'top3') {
                branches = branches.slice(0, 3);
            } else if (branchMonthlyFilter === 'select' && branchMonthlySelected) {
                branches = branches.filter(b => b[0] === branchMonthlySelected);
            }

            // 팀별 월별 데이터 - 실제 byBranch 데이터 사용 (매출, 건수, 검사목적 포함)
            const branchMonthlyData = branches.map(b => {
                const branchName = b[0];
                const monthlyInfo = labels.map((_, mi) => {
                    const monthData = monthMap[mi+1];
                    const branchData = monthData?.byBranch?.[branchName];
                    const sales = branchData?.sales || 0;
                    const count = branchData?.count || 0;
                    const byPurpose = branchData?.byPurpose || {};
                    return { sales, count, perCase: count > 0 ? sales / count : 0, byPurpose };
                });
                const salesArr = monthlyInfo.map(d => d.sales);
                const nonZeroSales = salesArr.filter(v => v > 0);
                const ownAvg = nonZeroSales.length > 0 ? nonZeroSales.reduce((a,b) => a+b, 0) / nonZeroSales.length : 0;
                return { name: branchName, data: salesArr, monthlyInfo, ownAvg };
            });

            // 팀별 검사목적별 월평균 계산 (매출 + 건수)
            const branchPurposeAvg = {};
            const branchPurposeAvgCount = {};
            branchMonthlyData.forEach(b => {
                branchPurposeAvg[b.name] = {};
                branchPurposeAvgCount[b.name] = {};
                const allPurposes = new Set();
                b.monthlyInfo.forEach(m => Object.keys(m.byPurpose).forEach(p => allPurposes.add(p)));
                allPurposes.forEach(purpose => {
                    const salesValues = b.monthlyInfo.map(m => m.byPurpose[purpose]?.sales || 0);
                    const countValues = b.monthlyInfo.map(m => m.byPurpose[purpose]?.count || 0);
                    const nonZeroSales = salesValues.filter(v => v > 0);
                    const nonZeroCount = countValues.filter(v => v > 0);
                    branchPurposeAvg[b.name][purpose] = nonZeroSales.length > 0 ? nonZeroSales.reduce((a,b) => a+b, 0) / nonZeroSales.length : 0;
                    branchPurposeAvgCount[b.name][purpose] = nonZeroCount.length > 0 ? nonZeroCount.reduce((a,b) => a+b, 0) / nonZeroCount.length : 0;
                });
            });

            // 전체 월별 평균 계산 (차트에 표시되는 팀 기준)
            const monthlyAvg = labels.map((_, mi) => {
                const monthData = monthMap[mi+1];
                if (!monthData || !monthData.byBranch) return 0;
                const branchSales = Object.values(monthData.byBranch).map(b => b.sales || 0);
                return branchSales.length > 0 ? branchSales.reduce((a,b) => a+b, 0) / branchSales.length : 0;
            });

            // 전체 팀 평균 계산 (모든 팀 기준)
            const allBranchMonthlyAvg = labels.map((_, mi) => {
                const monthData = monthMap[mi+1];
                if (!monthData || !monthData.byBranch) return 0;
                const allBranchSales = Object.values(monthData.byBranch).map(b => b.sales || 0).filter(v => v > 0);
                return allBranchSales.length > 0 ? allBranchSales.reduce((a,b) => a+b, 0) / allBranchSales.length : 0;
            });
            const allBranchAvgNonZero = allBranchMonthlyAvg.filter(v => v > 0);
            const allBranchAvgValue = allBranchAvgNonZero.length > 0 ? allBranchAvgNonZero.reduce((a,b) => a+b, 0) / allBranchAvgNonZero.length : 0;

            // 전체 인원 평균 계산 (모든 담당자 기준)
            const allManagerMonthlyAvg = labels.map((_, mi) => {
                const monthData = monthMap[mi+1];
                if (!monthData || !monthData.byManager) return 0;
                const allManagerSales = Object.values(monthData.byManager).map(m => m.sales || 0).filter(v => v > 0);
                return allManagerSales.length > 0 ? allManagerSales.reduce((a,b) => a+b, 0) / allManagerSales.length : 0;
            });
            const allManagerAvgNonZero = allManagerMonthlyAvg.filter(v => v > 0);
            const allManagerAvgValue = allManagerAvgNonZero.length > 0 ? allManagerAvgNonZero.reduce((a,b) => a+b, 0) / allManagerAvgNonZero.length : 0;

            // 데이터셋 생성 (자체 월평균 포함) - 더 굵고 명확한 라인
            const datasets = branchMonthlyData.map((b, i) => ({
                label: b.name,
                data: b.data,
                monthlyInfo: b.monthlyInfo,
                ownAvg: b.ownAvg,
                borderColor: colors[i % colors.length],
                backgroundColor: colors[i % colors.length],
                fill: false,
                tension: 0.3,
                pointRadius: 6,
                pointHoverRadius: 10,
                pointStyle: b.data.map(v => v < b.ownAvg ? 'triangle' : 'circle'),
                pointBackgroundColor: b.data.map(v => v < b.ownAvg ? '#ef4444' : colors[i % colors.length]),
                pointBorderColor: b.data.map(v => v < b.ownAvg ? '#fff' : '#fff'),
                pointBorderWidth: 2,
                borderWidth: 3,
            }));

            // 전체 평균 표시 (팀 평균 + 인원 평균)
            document.getElementById('branchMonthlyAvgDisplay').innerHTML = `<span style="color: #6366f1;">팀평균: ${formatCurrency(allBranchAvgValue)}</span> · <span style="color: #10b981;">인원평균: ${formatCurrency(allManagerAvgValue)}</span>`;

            // 평균선 추가
            datasets.push({
                label: '평균',
                data: monthlyAvg,
                borderColor: '#94a3b8',
                borderDash: [5, 5],
                borderWidth: 2,
                pointRadius: 0,
                fill: false,
            });

            // 선택된 비교년도 데이터 추가
            if (selectedCompareYear && compareData && compareData.year == selectedCompareYear && compareData.by_month) {
                const compMonthMap = Object.fromEntries(compareData.by_month || []);
                branchMonthlyData.forEach((b, i) => {
                    const monthlyInfo = labels.map((_, mi) => {
                        const monthData = compMonthMap[mi+1];
                        const sales = monthData?.byBranch?.[b.name]?.sales || 0;
                        const count = monthData?.byBranch?.[b.name]?.count || 0;
                        return { sales, count, perCase: count > 0 ? sales / count : 0 };
                    });
                    datasets.push({
                        label: b.name + ' (' + selectedCompareYear + ')',
                        data: monthlyInfo.map(d => d.sales),
                        monthlyInfo,
                        compareYear: selectedCompareYear,
                        borderColor: colors[i % colors.length] + '40',
                        backgroundColor: 'transparent',
                        fill: false,
                        tension: 0.4,
                        pointRadius: 2,
                        borderDash: [4, 4],
                        borderWidth: 1,
                        isComparison: true,
                    });
                });
            }

            // 외부 HTML 툴팁 생성 함수 (팀별 월별 추이)
            const getOrCreateBranchMonthlyTooltip = (chart) => {
                let tooltipEl = document.getElementById('branchMonthlyChartTooltip');
                if (!tooltipEl) {
                    tooltipEl = document.createElement('div');
                    tooltipEl.id = 'branchMonthlyChartTooltip';
                    tooltipEl.style.cssText = `
                        position: fixed;
                        background: rgba(30, 41, 59, 0.98);
                        border-radius: 12px;
                        padding: 16px;
                        pointer-events: auto;
                        z-index: 99999;
                        font-size: 13px;
                        color: #e2e8f0;
                        box-shadow: 0 20px 40px rgba(0,0,0,0.4);
                        min-width: 360px;
                        max-width: 420px;
                        max-height: 85vh;
                        overflow-y: auto;
                        transition: opacity 0.15s ease;
                        line-height: 1.5;
                    `;
                    document.body.appendChild(tooltipEl);
                setupTooltipHover(tooltipEl);
                }
                return tooltipEl;
            };

            // 추세 계산 함수
            const calcBranchTrend = (monthIdx, monthlyInfo) => {
                let upCount = 0, downCount = 0;
                for (let i = monthIdx; i > 0; i--) {
                    if (monthlyInfo[i].sales > monthlyInfo[i-1].sales) {
                        if (downCount > 0) break;
                        upCount++;
                    } else if (monthlyInfo[i].sales < monthlyInfo[i-1].sales) {
                        if (upCount > 0) break;
                        downCount++;
                    } else break;
                }
                return upCount > 0 ? { type: 'up', count: upCount } : { type: 'down', count: downCount };
            };

            // 외부 툴팁 핸들러
            const branchMonthlyTooltipHandler = (context) => {
                const { chart, tooltip } = context;
                const tooltipEl = getOrCreateBranchMonthlyTooltip(chart);

                if (tooltip.opacity === 0 && !isTooltipHovered(tooltipEl)) {
                    hideTooltipWithDelay(tooltipEl);
                    return;
                }

                if (tooltip.body) {
                    const dataPoints = tooltip.dataPoints || [];
                    const monthIdx = dataPoints[0]?.dataIndex;
                    const monthLabel = labels[monthIdx];

                    // 클릭한 포인트가 비교 연도인지 확인
                    const clickedPoint = dataPoints[0];
                    const isClickedComparison = clickedPoint?.dataset?.isComparison;
                    const displayYear = isClickedComparison ? selectedCompareYear : currentData.year;

                    // 현재 연도 데이터만 필터링
                    const currentYearPoints = dataPoints.filter(p => !p.dataset.isComparison && p.dataset.label !== '평균');
                    const compYearPoints = dataPoints.filter(p => p.dataset.isComparison);

                    let html = `<div style="font-size: 16px; font-weight: bold; margin-bottom: 12px; color: #60a5fa;">📅 ${displayYear}년 ${monthLabel}</div>`;

                    // 비교 연도 포인트 클릭 시 비교 연도 데이터 표시
                    if (isClickedComparison && compYearPoints.length > 0) {
                        compYearPoints.forEach(point => {
                            const ds = point.dataset;
                            const rawLabel = ds.label || '';
                            const branchName = rawLabel.replace(` (${selectedCompareYear})`, '');
                            const value = point.raw || 0;

                            // 비교 연도의 월별 데이터 가져오기
                            const compMonthMap = Object.fromEntries(compareData?.by_month || []);
                            const compMonthData = compMonthMap[monthIdx + 1];
                            const branchData = compMonthData?.byBranch?.[branchName];
                            const count = branchData?.count || 0;
                            const perCase = count > 0 ? value / count : 0;

                            const borderColor = ds.borderColor || '#94a3b8';
                            html += `<div style="margin-bottom: 16px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; border-left: 4px solid ${borderColor};">`;
                            html += `<div style="font-size: 15px; font-weight: bold; margin-bottom: 8px; color: ${borderColor};">🏢 ${branchName}</div>`;

                            // 기본 정보
                            html += `<div style="margin-bottom: 4px;">💰 매출: <strong>${(value / 100000000).toFixed(2)}억</strong></div>`;
                            html += `<div style="margin-bottom: 4px;">📋 건수: ${count.toLocaleString()}건 | 건당: ${formatCurrency(perCase)}</div>`;

                            // 현재 연도와 비교
                            const currentMonthMap = Object.fromEntries(currentData?.by_month || []);
                            const currentMonthData = currentMonthMap[monthIdx + 1];
                            const currentBranchData = currentMonthData?.byBranch?.[branchName];
                            const currentSales = currentBranchData?.sales || 0;

                            if (currentSales > 0) {
                                const diff = currentSales - value;
                                const diffPct = value > 0 ? (diff / value * 100) : 0;
                                const diffColor = diff >= 0 ? '#10b981' : '#ef4444';
                                const diffSign = diff >= 0 ? '+' : '';
                                html += `<div style="color: #94a3b8; margin: 8px 0 6px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── ${currentData.year}년 대비 ──</div>`;
                                html += `<div style="margin-bottom: 4px;">📆 ${currentData.year}년 동월: <span style="color: #60a5fa; font-weight: bold;">${(currentSales / 100000000).toFixed(2)}억</span></div>`;
                                html += `<div style="margin-bottom: 4px;">📊 변화: <span style="color: ${diffColor}; font-weight: bold;">${diffSign}${diffPct.toFixed(1)}% (${diffSign}${(diff / 10000).toFixed(0)}만)</span></div>`;
                            }
                            html += '</div>';
                        });
                        tooltipEl.innerHTML = html;
                    } else {
                        // 현재 연도 포인트 클릭 시 기존 로직
                        currentYearPoints.forEach(point => {
                        const ds = point.dataset;
                        const branchName = ds.label;
                        const value = point.raw || 0;
                        const info = ds.monthlyInfo?.[monthIdx];

                        const borderColor = ds.borderColor || '#6366f1';
                        html += `<div style="margin-bottom: 16px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; border-left: 4px solid ${borderColor};">`;
                        html += `<div style="font-size: 15px; font-weight: bold; margin-bottom: 8px; color: ${borderColor};">🏢 ${branchName}</div>`;

                        // 1. 기본 정보
                        html += `<div style="margin-bottom: 4px;">💰 매출: <strong>${(value / 100000000).toFixed(2)}억</strong></div>`;
                        if (info) {
                            html += `<div style="margin-bottom: 4px;">📋 건수: ${info.count.toLocaleString()}건 | 건당: ${formatCurrency(info.perCase)}</div>`;
                        }

                        // 2. 비교 분석
                        if (info && ds.ownAvg) {
                            const ownAvg = ds.ownAvg;
                            const diff = value - ownAvg;
                            const diffPct = ownAvg > 0 ? (diff / ownAvg * 100) : 0;
                            const isIncrease = diff >= 0;
                            const avgColor = isIncrease ? '#10b981' : '#ef4444';
                            const avgSign = isIncrease ? '+' : '';

                            html += `<div style="color: #94a3b8; margin: 8px 0 6px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 비교 분석 ──</div>`;
                            html += `<div style="margin-bottom: 4px;">📊 월평균 대비: <span style="color: ${avgColor}; font-weight: bold;">${avgSign}${diffPct.toFixed(1)}% (${avgSign}${(diff / 10000).toFixed(0)}만)</span></div>`;

                            // 각 비교년도 동월 대비
                            if (compareDataList && compareDataList.length > 0) {
                                compareDataList.forEach((compData) => {
                                    const compMonthMap = Object.fromEntries(compData.by_month || []);
                                    const compMonthData = compMonthMap[monthIdx + 1];
                                    const compSales = compMonthData?.byBranch?.[branchName]?.sales || 0;
                                    if (compSales > 0) {
                                        const yoyDiff = value - compSales;
                                        const yoyPct = (yoyDiff / compSales * 100);
                                        const yoyColor = yoyDiff >= 0 ? '#10b981' : '#ef4444';
                                        const yoySign = yoyDiff >= 0 ? '+' : '';
                                        html += `<div style="margin-bottom: 4px;">📆 ${compData.year}년 대비: <span style="color: ${yoyColor}; font-weight: bold;">${yoySign}${yoyPct.toFixed(1)}% (${yoySign}${(yoyDiff / 10000).toFixed(0)}만)</span></div>`;
                                    }
                                });
                            } else if (selectedCompareYear && compareData && compareData.year == selectedCompareYear && compareData.by_month) {
                                // 하위 호환성
                                const compMonthMap = Object.fromEntries(compareData.by_month || []);
                                const compMonthData = compMonthMap[monthIdx + 1];
                                const compSales = compMonthData?.byBranch?.[branchName]?.sales || 0;
                                if (compSales > 0) {
                                    const yoyDiff = value - compSales;
                                    const yoyPct = (yoyDiff / compSales * 100);
                                    const yoyColor = yoyDiff >= 0 ? '#10b981' : '#ef4444';
                                    const yoySign = yoyDiff >= 0 ? '+' : '';
                                    html += `<div style="margin-bottom: 4px;">📆 ${selectedCompareYear}년 동월 대비: <span style="color: ${yoyColor}; font-weight: bold;">${yoySign}${yoyPct.toFixed(1)}% (${yoySign}${(yoyDiff / 10000).toFixed(0)}만)</span></div>`;
                                }
                            }

                            // 전월 대비
                            if (monthIdx > 0 && ds.monthlyInfo[monthIdx - 1].sales > 0) {
                                const prevInfo = ds.monthlyInfo[monthIdx - 1];
                                const momDiff = value - prevInfo.sales;
                                const momPct = (momDiff / prevInfo.sales * 100);
                                const momColor = momDiff >= 0 ? '#10b981' : '#ef4444';
                                const momSign = momDiff >= 0 ? '+' : '';

                                const trend = calcBranchTrend(monthIdx, ds.monthlyInfo);
                                let trendText = '';
                                if (trend.count >= 2) {
                                    const trendIcon = trend.type === 'up' ? '↗' : '↘';
                                    const trendColor = trend.type === 'up' ? '#10b981' : '#ef4444';
                                    trendText = ` <span style="color: ${trendColor};">${trendIcon} ${trend.count}개월 연속</span>`;
                                }
                                html += `<div style="margin-bottom: 4px;">📈 전월 대비: <span style="color: ${momColor}; font-weight: bold;">${momSign}${momPct.toFixed(1)}%</span>${trendText}</div>`;

                                // 변화 원인 분해
                                const countEffect = (info.count - prevInfo.count) * prevInfo.perCase;
                                const priceEffect = (info.perCase - prevInfo.perCase) * info.count;
                                const totalChange = value - prevInfo.sales;

                                html += `<div style="color: #94a3b8; margin: 8px 0 6px; padding-top: 6px; border-top: 1px dashed rgba(255,255,255,0.2);">── 변화 원인 분해 ──</div>`;
                                const countColor = countEffect >= 0 ? '#10b981' : '#ef4444';
                                const countSign = countEffect >= 0 ? '+' : '';
                                const countPct = totalChange !== 0 ? Math.abs(countEffect / totalChange * 100) : 0;
                                html += `<div style="margin-bottom: 4px;">📋 건수 효과: <span style="color: ${countColor};">${countSign}${(countEffect / 10000).toFixed(0)}만</span> <span style="color: #94a3b8;">(${countPct.toFixed(0)}%)</span></div>`;

                                const priceColor = priceEffect >= 0 ? '#10b981' : '#ef4444';
                                const priceSign = priceEffect >= 0 ? '+' : '';
                                const pricePct = totalChange !== 0 ? Math.abs(priceEffect / totalChange * 100) : 0;
                                html += `<div style="margin-bottom: 4px;">💵 단가 효과: <span style="color: ${priceColor};">${priceSign}${(priceEffect / 10000).toFixed(0)}만</span> <span style="color: #94a3b8;">(${pricePct.toFixed(0)}%)</span></div>`;

                                const mainCause = Math.abs(countEffect) > Math.abs(priceEffect) ? '건수' : '단가';
                                const causeDirection = (mainCause === '건수' ? countEffect : priceEffect) >= 0 ? '증가' : '감소';
                                html += `<div style="color: #60a5fa; font-size: 11px; margin-top: 4px;">→ ${mainCause} ${causeDirection}가 주요 원인</div>`;
                            }

                            // 3. 증감 요인 (검사목적별)
                            const purposeAvg = branchPurposeAvg[branchName] || {};
                            const purposeAvgCnt = branchPurposeAvgCount[branchName] || {};
                            const purposeChanges = Object.entries(info.byPurpose || {}).map(([purpose, data]) => {
                                const avgP = purposeAvg[purpose] || 0;
                                const avgPCount = purposeAvgCnt[purpose] || 0;
                                const salesDiff = data.sales - avgP;
                                const countDiff = (data.count || 0) - avgPCount;
                                const avgPrice = data.count > 0 ? data.sales / data.count : 0;
                                const avgPriceAvg = avgPCount > 0 ? avgP / avgPCount : 0;
                                const priceDiff = avgPrice - avgPriceAvg;
                                const salesDiffPct = avgP > 0 ? (salesDiff / avgP * 100) : (data.sales > 0 ? 100 : 0);
                                const countDiffPct = avgPCount > 0 ? (countDiff / avgPCount * 100) : (data.count > 0 ? 100 : 0);
                                return { purpose, sales: data.sales, count: data.count || 0, avgPrice, priceDiff, salesDiff, countDiff, salesDiffPct, countDiffPct };
                            }).sort((a, b) => b.salesDiff - a.salesDiff);

                            const allIncreases = purposeChanges.filter(p => p.salesDiff > 0);
                            const allDecreases = purposeChanges.filter(p => p.salesDiff < 0);
                            const totalIncrease = allIncreases.reduce((sum, p) => sum + p.salesDiff, 0);
                            const totalDecrease = allDecreases.reduce((sum, p) => sum + p.salesDiff, 0);

                            const topItems = isIncrease ? allIncreases.slice(0, 3) : allDecreases.slice(0, 5);

                            if (isIncrease && topItems.length > 0) {
                                const topSum = topItems.reduce((sum, p) => sum + p.salesDiff, 0);
                                const explainPct = totalIncrease > 0 ? (topSum / totalIncrease * 100) : 0;
                                html += `<div style="color: #10b981; margin: 8px 0 6px; padding-top: 6px; border-top: 1px dashed rgba(255,255,255,0.2); font-weight: 600;">▲ 증가 요인 TOP ${topItems.length} <span style="font-weight: normal; font-size: 11px; color: #94a3b8;">(전체 +${(totalIncrease/10000).toFixed(0)}만 중 ${explainPct.toFixed(0)}%)</span></div>`;
                                topItems.forEach(p => {
                                    const countColor = p.countDiff >= 0 ? '#10b981' : '#ef4444';
                                    const countSign = p.countDiff >= 0 ? '+' : '';
                                    html += `<div style="margin-left: 8px; margin-bottom: 4px; padding: 4px 6px; background: rgba(16, 185, 129, 0.1); border-radius: 4px; border-left: 2px solid #10b981; font-size: 11px;">
                                        <div style="font-weight: 600;">• ${p.purpose}</div>
                                        <div>건수: <span style="color: ${countColor};">${countSign}${p.countDiff.toLocaleString()}건</span> | 매출: <span style="color: #10b981;">+${(p.salesDiff / 10000).toFixed(0)}만</span></div>
                                    </div>`;
                                });
                            } else if (!isIncrease && topItems.length > 0) {
                                const topSum = topItems.reduce((sum, p) => sum + p.salesDiff, 0);
                                const explainPct = totalDecrease < 0 ? (topSum / totalDecrease * 100) : 0;
                                html += `<div style="color: #ef4444; margin: 8px 0 6px; padding-top: 6px; border-top: 1px dashed rgba(255,255,255,0.2); font-weight: 600;">▼ 감소 요인 TOP ${topItems.length} <span style="font-weight: normal; font-size: 11px; color: #94a3b8;">(전체 ${(totalDecrease/10000).toFixed(0)}만 중 ${explainPct.toFixed(0)}%)</span></div>`;

                                const countDropItems = topItems.filter(p => p.countDiff <= 0);
                                const priceDropItems = topItems.filter(p => p.countDiff > 0);

                                if (countDropItems.length > 0) {
                                    html += `<div style="color: #f97316; font-size: 11px; margin: 4px 0 4px 8px;">📉 건수 감소:</div>`;
                                    countDropItems.forEach(p => {
                                        const countSign = p.countDiff >= 0 ? '+' : '';
                                        html += `<div style="margin-left: 8px; margin-bottom: 4px; padding: 4px 6px; background: rgba(239, 68, 68, 0.1); border-radius: 4px; border-left: 2px solid #ef4444; font-size: 11px;">
                                            <div style="font-weight: 600;">• ${p.purpose}</div>
                                            <div>건수: <span style="color: #ef4444;">${countSign}${p.countDiff.toLocaleString()}건</span> | 매출: <span style="color: #ef4444;">${(p.salesDiff / 10000).toFixed(0)}만</span></div>
                                        </div>`;
                                    });
                                }

                                if (priceDropItems.length > 0) {
                                    html += `<div style="color: #a855f7; font-size: 11px; margin: 6px 0 4px 8px;">💸 단가 하락 (건수↑ 단가↓):</div>`;
                                    priceDropItems.forEach(p => {
                                        html += `<div style="margin-left: 8px; margin-bottom: 4px; padding: 4px 6px; background: rgba(168, 85, 247, 0.1); border-radius: 4px; border-left: 2px solid #a855f7; font-size: 11px;">
                                            <div style="font-weight: 600;">• ${p.purpose}</div>
                                            <div>건수: <span style="color: #10b981;">+${p.countDiff.toLocaleString()}건</span> | 매출: <span style="color: #ef4444;">${(p.salesDiff / 10000).toFixed(0)}만</span> | 단가: <span style="color: #ef4444;">(↓${formatCurrency(Math.round(Math.abs(p.priceDiff)))})</span></div>
                                        </div>`;
                                    });
                                }
                            }
                        }
                        html += '</div>';
                    });

                    tooltipEl.innerHTML = html;
                    }
                }

                // 위치 계산 (짤림 방지)
                const canvasRect = chart.canvas.getBoundingClientRect();
                let left = canvasRect.left + tooltip.caretX + 15;
                let top = canvasRect.top + tooltip.caretY - 10;

                const tooltipWidth = tooltipEl.offsetWidth || 400;
                const tooltipHeight = tooltipEl.offsetHeight || 500;

                // 우측 경계 체크
                if (left + tooltipWidth > window.innerWidth - 20) {
                    left = canvasRect.left + tooltip.caretX - tooltipWidth - 15;
                }
                if (left < 10) left = 10;

                // 하단 경계 체크 - 화면 85% 높이를 초과하면 상단으로
                if (top + tooltipHeight > window.innerHeight - 20) {
                    top = Math.max(10, window.innerHeight - tooltipHeight - 20);
                }
                if (top < 10) top = 10;

                tooltipEl.style.opacity = 1; tooltipEl.style.pointerEvents = 'auto';
                tooltipEl.style.left = left + 'px';
                tooltipEl.style.top = top + 'px';
            };

            charts.branchMonthly = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: true },
                    plugins: {
                        legend: { position: 'top', labels: { usePointStyle: true } },
                        tooltip: {
                            enabled: false,
                            external: branchMonthlyTooltipHandler
                        }
                    },
                    scales: {
                        y: {
                            ticks: { callback: v => formatCurrency(v) },
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // 거래처 차트 필터 초기화 (최초 1회만)
        function initClientChartFilters() {
            if (clientChartFiltersInitialized) return;

            const purposes = currentData.purposes || [];
            const branches = (currentData.by_branch || []).map(b => b[0]);

            const purposeOptions = '<option value="전체">전체 검사목적</option>' +
                purposes.map(p => `<option value="${p}">${p}</option>`).join('');
            const branchOptions = '<option value="전체">전체 팀</option>' +
                branches.map(b => `<option value="${b}">${b}</option>`).join('');

            // 차트1 필터
            const p1 = document.getElementById('clientChart1PurposeFilter');
            const b1 = document.getElementById('clientChart1BranchFilter');
            if (p1) p1.innerHTML = purposeOptions;
            if (b1) b1.innerHTML = branchOptions;

            // 차트2 필터
            const p2 = document.getElementById('clientChart2PurposeFilter');
            const b2 = document.getElementById('clientChart2BranchFilter');
            if (p2) p2.innerHTML = purposeOptions;
            if (b2) b2.innerHTML = branchOptions;

            clientChartFiltersInitialized = true;
        }

        // 필터 적용 및 차트 업데이트 (독립적)
        function applyClientChartFilters(source) {
            // 각 차트가 독립적으로 작동
            if (source === 1) {
                updateClientRetentionChart();
            } else if (source === 2) {
                updateRetentionRateChart();
            }
        }

        // 거래처 차트 통합 업데이트
        function updateClientRetentionCharts() {
            initClientChartFilters();
            updateClientRetentionChart();
            updateRetentionRateChart();
        }

        // 필터링된 거래처 데이터 계산 (차트 번호에 따라)
        function getFilteredClientRetention(chartNum = 1) {
            const purposeFilter = document.getElementById(`clientChart${chartNum}PurposeFilter`)?.value || '전체';
            const branchFilter = document.getElementById(`clientChart${chartNum}BranchFilter`)?.value || '전체';

            // 필터가 전체이면 기존 데이터 사용
            if (purposeFilter === '전체' && branchFilter === '전체') {
                return currentData.total_client_retention || [];
            }

            // 팀만 필터링 (검사목적은 전체)
            if (purposeFilter === '전체' && branchFilter !== '전체') {
                const branchRetention = currentData.branch_client_retention?.[branchFilter];
                if (branchRetention && branchRetention.length > 0) {
                    return branchRetention;
                }
            }

            // 검사목적만 필터링 (팀은 전체)
            if (purposeFilter !== '전체' && branchFilter === '전체') {
                const purposeRetention = currentData.purpose_client_retention?.[purposeFilter];
                if (purposeRetention && purposeRetention.length > 0) {
                    return purposeRetention;
                }
            }

            // 둘 다 필터링 - 교집합 계산 필요
            // 팀별 월별 거래처와 목적별 월별 거래처의 교집합
            const branchData = currentData.branch_client_retention?.[branchFilter] || [];
            const purposeData = currentData.purpose_client_retention?.[purposeFilter] || [];

            // 데이터가 없으면 빈 배열 리턴
            if (branchData.length === 0 && purposeData.length === 0) {
                return Array.from({length: 12}, (_, i) => ({
                    month: i + 1, total: 0, overlap: 0, new: 0, retention: 0
                }));
            }

            // 둘 중 하나만 있으면 그것 사용
            if (branchData.length > 0 && purposeData.length === 0) return branchData;
            if (purposeData.length > 0 && branchData.length === 0) return purposeData;

            // 둘 다 있으면 더 작은 값 사용 (교집합 근사치)
            const result = [];
            for (let i = 0; i < 12; i++) {
                const month = i + 1;
                const bd = branchData.find(d => d.month === month) || { total: 0, overlap: 0, new: 0, retention: 0 };
                const pd = purposeData.find(d => d.month === month) || { total: 0, overlap: 0, new: 0, retention: 0 };

                // 교집합은 두 집합 중 더 작은 값을 넘지 않음
                const total = Math.min(bd.total, pd.total);
                const overlap = Math.min(bd.overlap, pd.overlap);
                const newCount = Math.min(bd.new, pd.new);
                const prevMonth = result[result.length - 1];
                const retention = prevMonth && prevMonth.total > 0
                    ? Math.round(overlap / prevMonth.total * 100 * 10) / 10
                    : 0;

                result.push({ month, total, overlap, new: newCount, retention });
            }
            return result;
        }

        // 월별 기존/신규 거래처 현황 (Stacked Bar: 기존 vs 신규)
        function updateClientRetentionChart() {
            const ctx = document.getElementById('clientRetentionChart');
            if (!ctx) return;
            if (charts.clientRetention) charts.clientRetention.destroy();

            const retention = getFilteredClientRetention(1);  // 차트1 필터 사용
            const labels = retention.map(d => d.month + '월');
            const overlap = retention.map(d => d.overlap);
            const newClients = retention.map(d => d.new);
            const totals = retention.map(d => d.total);

            // 통계 계산
            const validMonths = retention.filter(d => d.total > 0);
            const avgTotal = validMonths.length > 0 ? validMonths.reduce((sum, d) => sum + d.total, 0) / validMonths.length : 0;
            const avgNew = validMonths.length > 0 ? validMonths.reduce((sum, d) => sum + d.new, 0) / validMonths.length : 0;
            const maxTotal = Math.max(...totals);
            const minTotal = Math.min(...totals.filter(t => t > 0));
            const totalYearClients = retention.reduce((sum, d) => sum + d.new, 0) + (retention[0]?.overlap || 0);

            // clientRetentionSummary 요약 정보 표시
            const retentionSummaryEl = document.getElementById('clientRetentionSummary');
            if (retentionSummaryEl) {
                const totalNew = retention.reduce((sum, d) => sum + d.new, 0);
                const totalOverlap = retention.reduce((sum, d) => sum + d.overlap, 0);
                let crHtml = `<span style="white-space:nowrap;background:#dbeafe;padding:4px 10px;border-radius:4px;color:#1e40af;">총거래처: <strong style="color:#3b82f6;">${totalYearClients.toLocaleString()}개</strong></span>`;
                crHtml += `<span style="white-space:nowrap;background:#d1fae5;padding:4px 10px;border-radius:4px;color:#059669;">신규: <strong>${totalNew.toLocaleString()}개</strong></span>`;
                crHtml += `<span style="white-space:nowrap;background:#fce7f3;padding:4px 10px;border-radius:4px;color:#9d174d;">월평균: <strong>${Math.round(avgTotal)}개</strong></span>`;
                retentionSummaryEl.innerHTML = crHtml;
            }

            // 외부 HTML 툴팁
            const getOrCreateTooltip = (chart) => {
                let tooltipEl = document.getElementById('clientRetentionTooltip');
                if (!tooltipEl) {
                    tooltipEl = document.createElement('div');
                    tooltipEl.id = 'clientRetentionTooltip';
                    tooltipEl.style.cssText = `
                        position: fixed; background: rgba(30, 41, 59, 0.98); border-radius: 12px;
                        padding: 16px; pointer-events: auto; z-index: 99999; font-size: 13px;
                        color: #e2e8f0; box-shadow: 0 20px 40px rgba(0,0,0,0.4); min-width: 320px;
                        max-width: 400px; transition: opacity 0.15s ease; line-height: 1.6;
                    `;
                    document.body.appendChild(tooltipEl);
                    setupTooltipHover(tooltipEl);
                }
                return tooltipEl;
            };

            const tooltipHandler = (context) => {
                const { chart, tooltip } = context;
                const tooltipEl = getOrCreateTooltip(chart);

                if (tooltip.opacity === 0 && !isTooltipHovered(tooltipEl)) {
                    hideTooltipWithDelay(tooltipEl);
                    return;
                }

                if (tooltip.body) {
                    const dataIndex = tooltip.dataPoints?.[0]?.dataIndex;
                    const month = dataIndex + 1;
                    const d = retention[dataIndex];
                    const prevD = dataIndex > 0 ? retention[dataIndex - 1] : null;

                    // 순위 계산
                    const sortedByTotal = [...retention].filter(r => r.total > 0).sort((a, b) => b.total - a.total);
                    const rank = sortedByTotal.findIndex(r => r.month === d.month) + 1;
                    const isTop = rank <= 2;
                    const isBottom = rank >= sortedByTotal.length - 1 && sortedByTotal.length > 2;

                    // 헤더 색상
                    let headerBg = 'rgba(99, 102, 241, 0.2)';
                    let borderColor = 'rgba(99, 102, 241, 0.6)';
                    if (isTop) { headerBg = 'rgba(16, 185, 129, 0.2)'; borderColor = 'rgba(16, 185, 129, 0.6)'; }
                    else if (isBottom) { headerBg = 'rgba(239, 68, 68, 0.2)'; borderColor = 'rgba(239, 68, 68, 0.6)'; }
                    tooltipEl.style.border = `2px solid ${borderColor}`;

                    let html = '';

                    // 1. 헤더 (월 + 순위 배지)
                    html += `<div style="font-size: 16px; font-weight: bold; color: #fff; margin: -16px -16px 12px -16px; padding: 12px 16px; background: ${headerBg}; border-radius: 10px 10px 0 0; display: flex; justify-content: space-between; align-items: center;">
                        <span>📅 ${currentData.year}년 ${month}월</span>
                        <span style="background: rgba(255,255,255,0.2); padding: 2px 10px; border-radius: 12px; font-size: 12px;">거래처 ${rank}위</span>
                    </div>`;

                    // 2. 기본 지표
                    html += `<div style="margin-bottom: 4px;">📊 <strong>총 거래처:</strong> <span style="color: #fbbf24; font-size: 18px; font-weight: bold;">${d.total}개</span></div>`;
                    html += `<div style="display: flex; gap: 16px; margin-bottom: 8px;">`;
                    html += `<div>🔵 기존: <strong style="color: #6366f1;">${d.overlap}개</strong></div>`;
                    html += `<div>🟢 신규: <strong style="color: #10b981;">${d.new}개</strong></div>`;
                    html += `</div>`;

                    // 3. 구성 비율 분석 (프로그레스 바)
                    const existingRate = d.total > 0 ? (d.overlap / d.total * 100) : 0;
                    const newRate = d.total > 0 ? (d.new / d.total * 100) : 0;
                    html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 구성 비율 분석 ──</div>`;
                    html += `<div style="display: flex; height: 16px; border-radius: 4px; overflow: hidden; margin-bottom: 8px;">
                        <div style="width: ${existingRate}%; background: #6366f1;" title="기존 ${existingRate.toFixed(1)}%"></div>
                        <div style="width: ${newRate}%; background: #10b981;" title="신규 ${newRate.toFixed(1)}%"></div>
                    </div>`;
                    html += `<div style="display: flex; gap: 16px; font-size: 12px;">`;
                    html += `<span><span style="display: inline-block; width: 8px; height: 8px; border-radius: 2px; background: #6366f1; margin-right: 3px;"></span>기존 ${existingRate.toFixed(1)}%</span>`;
                    html += `<span><span style="display: inline-block; width: 8px; height: 8px; border-radius: 2px; background: #10b981; margin-right: 3px;"></span>신규 ${newRate.toFixed(1)}%</span>`;
                    html += `</div>`;

                    // 4. 평균 대비 분석
                    const vsAvg = d.total - avgTotal;
                    const vsAvgPct = avgTotal > 0 ? (vsAvg / avgTotal * 100) : 0;
                    const avgColor = vsAvg >= 0 ? '#10b981' : '#ef4444';
                    const avgSign = vsAvg >= 0 ? '+' : '';
                    html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 평균 대비 분석 ──</div>`;
                    html += `<div style="margin-bottom: 4px;">📈 월평균 거래처: <strong>${avgTotal.toFixed(0)}개</strong></div>`;
                    html += `<div style="margin-bottom: 4px;">📊 평균 대비: <span style="color: ${avgColor}; font-weight: 600;">${avgSign}${vsAvg.toFixed(0)}개 (${avgSign}${vsAvgPct.toFixed(1)}%)</span></div>`;

                    // 5. 전월 대비
                    if (prevD && prevD.total > 0) {
                        const totalDiff = d.total - prevD.total;
                        const totalDiffPct = (totalDiff / prevD.total * 100);
                        const newDiff = d.new - prevD.new;
                        const diffColor = totalDiff >= 0 ? '#10b981' : '#ef4444';
                        const diffSign = totalDiff >= 0 ? '+' : '';
                        html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 전월 대비 ──</div>`;
                        html += `<div style="margin-bottom: 4px;">📋 거래처 변화: <span style="color: ${diffColor}; font-weight: 600;">${diffSign}${totalDiff}개 (${diffSign}${totalDiffPct.toFixed(1)}%)</span></div>`;
                        const newDiffColor = newDiff >= 0 ? '#10b981' : '#ef4444';
                        const newDiffSign = newDiff >= 0 ? '+' : '';
                        html += `<div style="margin-bottom: 4px;">🆕 신규 유입 변화: <span style="color: ${newDiffColor};">${newDiffSign}${newDiff}개</span></div>`;
                    }

                    // 6. 연간 누적 분석
                    const cumulative = retention.slice(0, dataIndex + 1).reduce((sum, r) => sum + r.new, 0) + (retention[0]?.overlap || 0);
                    html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 연간 누적 현황 ──</div>`;
                    html += `<div style="margin-bottom: 4px;">📈 ${month}월까지 총 거래처: <strong style="color: #fbbf24;">${cumulative}개</strong></div>`;
                    html += `<div style="margin-bottom: 4px;">🆕 신규 유입 누적: <strong style="color: #10b981;">${retention.slice(0, dataIndex + 1).reduce((sum, r) => sum + r.new, 0)}개</strong></div>`;

                    // 7. 인사이트
                    html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 인사이트 ──</div>`;
                    if (newRate > 40) {
                        html += `<div style="color: #10b981; font-size: 12px;">💡 신규 거래처 유입이 활발한 달입니다</div>`;
                    } else if (existingRate > 80) {
                        html += `<div style="color: #6366f1; font-size: 12px;">💡 기존 고객 유지율이 높은 안정적인 달입니다</div>`;
                    } else if (d.total === maxTotal) {
                        html += `<div style="color: #fbbf24; font-size: 12px;">🏆 연간 최다 거래처 달성!</div>`;
                    } else if (d.total === minTotal && d.total > 0) {
                        html += `<div style="color: #ef4444; font-size: 12px;">⚠️ 거래처 확보 강화 필요</div>`;
                    } else {
                        html += `<div style="color: #94a3b8; font-size: 12px;">📊 평균적인 거래처 현황입니다</div>`;
                    }

                    tooltipEl.innerHTML = html;
                }

                const canvasRect = chart.canvas.getBoundingClientRect();
                let left = canvasRect.left + tooltip.caretX + 15;
                let top = canvasRect.top + tooltip.caretY - 10;
                const tooltipWidth = tooltipEl.offsetWidth || 360;
                if (left + tooltipWidth > window.innerWidth - 20) left = canvasRect.left + tooltip.caretX - tooltipWidth - 15;
                const tooltipHeight = tooltipEl.offsetHeight || 450;
                if (top + tooltipHeight > window.innerHeight - 20) top = window.innerHeight - tooltipHeight - 20;
                if (top < 10) top = 10;
                tooltipEl.style.opacity = 1;
                tooltipEl.style.left = left + 'px';
                tooltipEl.style.top = top + 'px';
            };

            charts.clientRetention = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: '기존 거래처', data: overlap, backgroundColor: 'rgba(99, 102, 241, 0.8)', borderRadius: 4 },
                        { label: '신규 거래처', data: newClients, backgroundColor: 'rgba(16, 185, 129, 0.8)', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { enabled: false, external: tooltipHandler }
                    },
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true, title: { display: true, text: '거래처 수' } }
                    }
                }
            });
        }

        // 거래처 리텐션율 추이 (Line Chart)
        function updateRetentionRateChart() {
            const ctx = document.getElementById('retentionRateChart');
            if (!ctx) return;
            if (charts.retentionRate) charts.retentionRate.destroy();

            const retention = getFilteredClientRetention(2);  // 차트2 필터 사용
            const labels = retention.map(d => d.month + '월');
            const rates = retention.map(d => d.retention);
            const totals = retention.map(d => d.total);

            // 통계 계산
            const validRates = rates.filter(r => r > 0);
            const avgRetention = validRates.length > 0 ? validRates.reduce((a, b) => a + b, 0) / validRates.length : 0;
            const maxRetention = Math.max(...validRates);
            const minRetention = Math.min(...validRates);
            const avgTotal = totals.filter(t => t > 0).reduce((a, b) => a + b, 0) / (totals.filter(t => t > 0).length || 1);

            // 외부 HTML 툴팁
            const getOrCreateTooltip = (chart) => {
                let tooltipEl = document.getElementById('retentionRateTooltip');
                if (!tooltipEl) {
                    tooltipEl = document.createElement('div');
                    tooltipEl.id = 'retentionRateTooltip';
                    tooltipEl.style.cssText = `
                        position: fixed; background: rgba(30, 41, 59, 0.98); border-radius: 12px;
                        padding: 16px; pointer-events: auto; z-index: 99999; font-size: 13px;
                        color: #e2e8f0; box-shadow: 0 20px 40px rgba(0,0,0,0.4); min-width: 340px;
                        max-width: 420px; transition: opacity 0.15s ease; line-height: 1.6;
                    `;
                    document.body.appendChild(tooltipEl);
                    setupTooltipHover(tooltipEl);
                }
                return tooltipEl;
            };

            const tooltipHandler = (context) => {
                const { chart, tooltip } = context;
                const tooltipEl = getOrCreateTooltip(chart);

                if (tooltip.opacity === 0 && !isTooltipHovered(tooltipEl)) {
                    hideTooltipWithDelay(tooltipEl);
                    return;
                }

                if (tooltip.body) {
                    const dataIndex = tooltip.dataPoints?.[0]?.dataIndex;
                    const month = dataIndex + 1;
                    const d = retention[dataIndex];
                    const prevD = dataIndex > 0 ? retention[dataIndex - 1] : null;

                    // 순위 계산
                    const sortedByRate = [...retention].filter(r => r.retention > 0).sort((a, b) => b.retention - a.retention);
                    const rank = sortedByRate.findIndex(r => r.month === d.month) + 1;
                    const isTop = rank <= 2;
                    const isBottom = rank >= sortedByRate.length - 1 && sortedByRate.length > 2;

                    // 헤더 색상
                    let headerBg = 'rgba(99, 102, 241, 0.2)';
                    let borderColor = 'rgba(99, 102, 241, 0.6)';
                    if (isTop) { headerBg = 'rgba(16, 185, 129, 0.2)'; borderColor = 'rgba(16, 185, 129, 0.6)'; }
                    else if (isBottom) { headerBg = 'rgba(239, 68, 68, 0.2)'; borderColor = 'rgba(239, 68, 68, 0.6)'; }
                    tooltipEl.style.border = `2px solid ${borderColor}`;

                    let html = '';

                    // 1. 헤더 (월 + 순위 배지)
                    html += `<div style="font-size: 16px; font-weight: bold; color: #fff; margin: -16px -16px 12px -16px; padding: 12px 16px; background: ${headerBg}; border-radius: 10px 10px 0 0; display: flex; justify-content: space-between; align-items: center;">
                        <span>📅 ${currentData.year}년 ${month}월</span>
                        <span style="background: rgba(255,255,255,0.2); padding: 2px 10px; border-radius: 12px; font-size: 12px;">리텐션 ${rank}위</span>
                    </div>`;

                    // 2. 기본 지표
                    const retentionColor = d.retention >= avgRetention ? '#10b981' : '#ef4444';
                    html += `<div style="margin-bottom: 4px;">📈 <strong>리텐션율:</strong> <span style="color: ${retentionColor}; font-size: 20px; font-weight: bold;">${d.retention.toFixed(1)}%</span></div>`;
                    html += `<div style="margin-bottom: 8px;">📊 월별 거래처: <strong style="color: #fbbf24;">${d.total}개</strong> | 기존: <strong style="color: #6366f1;">${d.overlap}개</strong> | 신규: <strong style="color: #10b981;">${d.new}개</strong></div>`;

                    // 3. 리텐션 게이지
                    html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 리텐션 수준 ──</div>`;
                    const gaugeColor = d.retention >= 50 ? '#10b981' : (d.retention >= 30 ? '#fbbf24' : '#ef4444');
                    html += `<div style="background: rgba(255,255,255,0.1); height: 12px; border-radius: 6px; overflow: hidden; margin-bottom: 8px;">
                        <div style="width: ${Math.min(d.retention, 100)}%; height: 100%; background: ${gaugeColor}; border-radius: 6px;"></div>
                    </div>`;
                    const levelText = d.retention >= 50 ? '우수' : (d.retention >= 30 ? '보통' : '개선필요');
                    const levelIcon = d.retention >= 50 ? '🟢' : (d.retention >= 30 ? '🟡' : '🔴');
                    html += `<div style="margin-bottom: 4px;">${levelIcon} 수준: <strong>${levelText}</strong> (${d.retention >= 50 ? '상위' : (d.retention >= 30 ? '중위' : '하위')} 그룹)</div>`;

                    // 4. 평균 대비 분석
                    const avgDiff = d.retention - avgRetention;
                    const avgDiffColor = avgDiff >= 0 ? '#10b981' : '#ef4444';
                    const avgDiffSign = avgDiff >= 0 ? '+' : '';
                    html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 평균 대비 분석 ──</div>`;
                    html += `<div style="margin-bottom: 4px;">📊 연간 평균 리텐션: <strong>${avgRetention.toFixed(1)}%</strong></div>`;
                    html += `<div style="margin-bottom: 4px;">📈 평균 대비: <span style="color: ${avgDiffColor}; font-weight: 600;">${avgDiffSign}${avgDiff.toFixed(1)}%p</span></div>`;

                    // 5. 전월 대비
                    if (prevD && prevD.retention > 0) {
                        const momDiff = d.retention - prevD.retention;
                        const momColor = momDiff >= 0 ? '#10b981' : '#ef4444';
                        const momSign = momDiff >= 0 ? '+' : '';
                        html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 전월 대비 ──</div>`;
                        html += `<div style="margin-bottom: 4px;">📉 리텐션 변화: <span style="color: ${momColor}; font-weight: 600;">${momSign}${momDiff.toFixed(1)}%p</span></div>`;

                        const totalDiff = d.total - prevD.total;
                        const totalDiffColor = totalDiff >= 0 ? '#10b981' : '#ef4444';
                        const totalDiffSign = totalDiff >= 0 ? '+' : '';
                        html += `<div style="margin-bottom: 4px;">📋 거래처 변화: <span style="color: ${totalDiffColor};">${totalDiffSign}${totalDiff}개</span></div>`;
                    }

                    // 6. 해석 (상세)
                    html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 해석 ──</div>`;
                    if (prevD && prevD.total > 0) {
                        const retained = Math.round(prevD.total * d.retention / 100);
                        const churned = prevD.total - retained;
                        html += `<div style="margin-bottom: 4px;">전월 <strong>${prevD.total}개</strong> 거래처 중 <span style="color: #6366f1; font-weight: 600;">${retained}개</span>가 이번 달에도 거래</div>`;
                        html += `<div style="margin-bottom: 4px; color: #94a3b8;">이탈 거래처: <span style="color: #ef4444;">${churned}개</span> (이탈률: ${(100 - d.retention).toFixed(1)}%)</div>`;
                    }

                    // 7. 인사이트
                    html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 인사이트 ──</div>`;
                    if (d.retention === maxRetention) {
                        html += `<div style="color: #fbbf24; font-size: 12px;">🏆 연간 최고 리텐션율 달성!</div>`;
                    } else if (d.retention === minRetention && d.retention > 0) {
                        html += `<div style="color: #ef4444; font-size: 12px;">⚠️ 연간 최저 리텐션율 - 고객 유지 전략 점검 필요</div>`;
                    } else if (d.retention >= avgRetention) {
                        html += `<div style="color: #10b981; font-size: 12px;">💡 평균 이상의 고객 유지율을 보이고 있습니다</div>`;
                    } else {
                        const gapToAvg = avgRetention - d.retention;
                        html += `<div style="color: #f59e0b; font-size: 12px;">💡 평균까지 ${gapToAvg.toFixed(1)}%p 개선 필요</div>`;
                    }

                    // 추가 팁
                    if (d.new > d.overlap) {
                        html += `<div style="color: #60a5fa; font-size: 12px; margin-top: 4px;">→ 신규 유입 > 기존 유지: 신규 영업 활발</div>`;
                    } else if (d.overlap > d.total * 0.7) {
                        html += `<div style="color: #60a5fa; font-size: 12px; margin-top: 4px;">→ 기존 거래처 비중 높음: 안정적 거래 기반</div>`;
                    }

                    tooltipEl.innerHTML = html;
                }

                const canvasRect = chart.canvas.getBoundingClientRect();
                let left = canvasRect.left + tooltip.caretX + 15;
                let top = canvasRect.top + tooltip.caretY - 10;
                const tooltipWidth = tooltipEl.offsetWidth || 380;
                if (left + tooltipWidth > window.innerWidth - 20) left = canvasRect.left + tooltip.caretX - tooltipWidth - 15;
                const tooltipHeight = tooltipEl.offsetHeight || 500;
                if (top + tooltipHeight > window.innerHeight - 20) top = window.innerHeight - tooltipHeight - 20;
                if (top < 10) top = 10;
                tooltipEl.style.opacity = 1;
                tooltipEl.style.left = left + 'px';
                tooltipEl.style.top = top + 'px';
            };

            charts.retentionRate = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: '리텐션율 (%)',
                            data: rates,
                            borderColor: '#6366f1',
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 6,
                            pointHoverRadius: 10,
                            yAxisID: 'y'
                        },
                        {
                            label: '월별 거래처 수',
                            data: totals,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: false,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 8,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { enabled: false, external: tooltipHandler }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: { display: true, text: '리텐션율 (%)' },
                            min: 0,
                            max: 100
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: { display: true, text: '거래처 수' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        // 지사별 거래처 리텐션 테이블
        function updateBranchRetentionTable() {
            const tbody = document.getElementById('branchRetentionBody');
            if (!tbody) return;

            const branchRetention = currentData.branch_client_retention || {};
            // "기타" 제외
            const branches = Object.keys(branchRetention).filter(b => b !== '기타').sort();

            // 비교 데이터
            const compareBranchRetention = compareData?.branch_client_retention || {};

            // 범례 업데이트
            const legend = document.getElementById('branchRetentionLegend');
            if (legend) {
                if (compareData) {
                    legend.innerHTML = `
                        <span><strong>거래처 수:</strong></span>
                        <span><span style="color: #10b981;">●</span> 리텐션 50% 이상</span>
                        <span><span style="color: #f59e0b;">●</span> 리텐션 30~50%</span>
                        <span><span style="color: #ef4444;">●</span> 리텐션 30% 미만</span>
                        <span style="margin-left: 20px;"><strong>전년 대비:</strong></span>
                        <span><span style="color: #10b981;">(+)</span> 증가</span>
                        <span><span style="color: #ef4444;">(-)</span> 감소</span>
                    `;
                } else {
                    legend.innerHTML = `
                        <span><strong>거래처 수:</strong></span>
                        <span><span style="color: #10b981;">●</span> 리텐션 50% 이상</span>
                        <span><span style="color: #f59e0b;">●</span> 리텐션 30~50%</span>
                        <span><span style="color: #ef4444;">●</span> 리텐션 30% 미만</span>
                        <span style="margin-left: 20px;"><strong>신규:</strong></span>
                        <span><span style="color: #888;">(+N)</span> 신규 거래처 수</span>
                    `;
                }
            }

            document.getElementById('branchRetentionBadge').textContent = branches.length + '개';

            let html = '';
            for (const branch of branches) {
                const data = branchRetention[branch] || [];
                const monthMap = Object.fromEntries(data.map(d => [d.month, d]));

                // 비교 데이터
                const compData = compareBranchRetention[branch] || [];
                const compMonthMap = Object.fromEntries(compData.map(d => [d.month, d]));

                // 누적 거래처 수 계산
                let cumulative = 0;
                for (const d of data) {
                    cumulative += d.new;
                }

                // 전년 누적
                let compCumulative = 0;
                for (const d of compData) {
                    compCumulative += d.new;
                }

                // 누적 증감
                const cumulativeDiff = cumulative - compCumulative;
                const cumulativeColor = cumulativeDiff >= 0 ? '#10b981' : '#ef4444';
                const cumulativeSign = cumulativeDiff >= 0 ? '+' : '';

                html += `<tr><td><strong>${branch}</strong></td>`;
                if (compareData) {
                    html += `<td class="text-right">${cumulative}<br><small style="color:${cumulativeColor}">(${cumulativeSign}${cumulativeDiff})</small></td>`;
                } else {
                    html += `<td class="text-right">${cumulative}</td>`;
                }

                for (let m = 1; m <= 12; m++) {
                    const d = monthMap[m];
                    const cd = compMonthMap[m];
                    if (d) {
                        const color = d.retention > 50 ? '#10b981' : d.retention > 30 ? '#f59e0b' : '#ef4444';
                        if (compareData && cd) {
                            const diff = d.total - cd.total;
                            const diffColor = diff >= 0 ? '#10b981' : '#ef4444';
                            const diffSign = diff >= 0 ? '+' : '';
                            html += `<td class="text-right"><span style="color:${color}">${d.total}</span><br><small style="color:${diffColor}">(${diffSign}${diff})</small></td>`;
                        } else {
                            html += `<td class="text-right"><span style="color:${color}">${d.total}</span><br><small style="color:#888">(+${d.new})</small></td>`;
                        }
                    } else {
                        html += '<td class="text-right">-</td>';
                    }
                }
                html += '</tr>';
            }
            tbody.innerHTML = html;
        }

        function updateManagerChart() {
            const purposeFilter = document.getElementById('managerChartPurposeFilter')?.value || '전체';
            let managers = [];

            // 검사목적 필터 적용
            if (purposeFilter === '전체') {
                managers = currentData.by_manager || [];
            } else {
                const purposeManagerData = currentData.purpose_managers?.[purposeFilter] || [];
                managers = purposeManagerData.map(m => [m.name, { sales: m.sales, count: m.count }]);
            }

            // 전체 담당자의 검사목적별 평균 계산
            const allManagers = currentData.by_manager || [];
            const purposeAvgMap = {};
            let totalSales = 0;
            let managerCount = 0;
            allManagers.forEach(m => {
                const byPurpose = m[1].by_purpose || {};
                const sales = m[1].sales || 0;
                if (sales > 0) {
                    managerCount++;
                    totalSales += sales;
                }
                Object.entries(byPurpose).forEach(([purpose, data]) => {
                    if (!purposeAvgMap[purpose]) purposeAvgMap[purpose] = { totalSales: 0, totalCount: 0, managerCount: 0 };
                    purposeAvgMap[purpose].totalSales += data.sales || 0;
                    purposeAvgMap[purpose].totalCount += data.count || 0;
                    if ((data.sales || 0) > 0) purposeAvgMap[purpose].managerCount++;
                });
            });
            // 평균 계산
            Object.keys(purposeAvgMap).forEach(purpose => {
                const p = purposeAvgMap[purpose];
                p.avgSales = p.totalSales / (managerCount || 1);
                p.avgCount = p.totalCount / (managerCount || 1);
            });
            const overallAvgSales = totalSales / (managerCount || 1);

            // 담당자별 상세 정보 준비
            const top15 = managers.slice(0, 15);
            const managerInfoMap = {};
            allManagers.forEach(m => {
                managerInfoMap[m[0]] = m[1];
            });

            // 전년도 데이터 및 순위 계산
            const compareMap = compareData ? Object.fromEntries((compareData.by_manager || []).map(m => [m[0], m[1]])) : {};
            const compManagerRanks = {};
            if (compareData && compareData.by_manager) {
                compareData.by_manager.forEach((m, idx) => {
                    compManagerRanks[m[0]] = idx + 1;
                });
            }

            // 차트 데이터 준비
            const chartData = top15.map((d, idx) => {
                const name = d[0];
                const info = managerInfoMap[name] || d[1];
                const sales = info.sales || 0;
                const count = info.count || 0;
                const avgPrice = count > 0 ? sales / count : 0;

                const compInfo = compareMap[name] || { sales: 0, count: 0 };
                const compSales = compInfo.sales || 0;
                const compCount = compInfo.count || 0;
                const compAvgPrice = compCount > 0 ? compSales / compCount : 0;

                const currentRank = idx + 1;
                const prevRank = compManagerRanks[name] || 0;
                const rankChange = prevRank > 0 ? prevRank - currentRank : 0;

                // 거래처 데이터 (manager_top_clients 기반)
                const clientInfo = currentData.manager_top_clients?.[name] || [];
                const compClientInfo = compareData?.manager_top_clients?.[name] || [];
                const activeClients = clientInfo.length;
                const compActiveClients = compClientInfo.length;

                return {
                    name,
                    sales,
                    count,
                    avgPrice,
                    compSales,
                    compCount,
                    compAvgPrice,
                    currentRank,
                    prevRank,
                    rankChange,
                    byPurpose: info.by_purpose || {},
                    activeClients,
                    compActiveClients,
                    topClients: clientInfo.slice(0, 3)
                };
            });

            const ctx = document.getElementById('managerChart');
            if (!ctx) return;
            if (charts.manager) charts.manager.destroy();

            const datasets = [{ label: currentData.year + '년', data: chartData.map(d => d.sales), backgroundColor: 'rgba(99, 102, 241, 0.8)', borderRadius: 6 }];

            // 요약 정보 계산 및 표시
            const summaryTotalSales = chartData.reduce((s, d) => s + d.sales, 0);
            const summaryTotalCount = chartData.reduce((s, d) => s + d.count, 0);
            const summaryAvgPrice = summaryTotalCount > 0 ? summaryTotalSales / summaryTotalCount : 0;

            // 전년도 비교
            const compSummaryTotalSales = chartData.reduce((s, d) => s + d.compSales, 0);
            const compSummaryTotalCount = chartData.reduce((s, d) => s + d.compCount, 0);

            // managerChartSummary 업데이트
            const mgrSummaryEl = document.getElementById('managerChartSummary');
            if (mgrSummaryEl) {
                let mgrHtml = `<span style="white-space:nowrap;background:#dbeafe;padding:4px 10px;border-radius:4px;color:#1e40af;">매출: <strong style="color:#3b82f6;">${(summaryTotalSales / 100000000).toFixed(1)}억</strong></span>`;
                if (compareData && compSummaryTotalSales > 0) {
                    const salesGrowth = ((summaryTotalSales - compSummaryTotalSales) / compSummaryTotalSales * 100);
                    const growthSign = salesGrowth >= 0 ? '+' : '';
                    const growthColor = salesGrowth >= 0 ? '#059669' : '#dc2626';
                    mgrHtml += `<span style="white-space:nowrap;background:${salesGrowth >= 0 ? '#d1fae5' : '#fee2e2'};padding:4px 10px;border-radius:4px;color:${growthColor};">전년비: <strong>${growthSign}${salesGrowth.toFixed(1)}%</strong></span>`;
                }
                mgrHtml += `<span style="white-space:nowrap;background:#e0e7ff;padding:4px 10px;border-radius:4px;color:#3730a3;">건수: <strong>${summaryTotalCount.toLocaleString()}건</strong></span>`;
                mgrHtml += `<span style="white-space:nowrap;background:#fce7f3;padding:4px 10px;border-radius:4px;color:#9d174d;">평균단가: <strong>${Math.round(summaryAvgPrice / 10000).toLocaleString()}만</strong></span>`;
                mgrSummaryEl.innerHTML = mgrHtml;
            }

            const summaryHtml = `<div style="margin-left: auto; display: flex; gap: 20px; font-size: 12px; color: #666;">
                <span>총매출: <strong>${formatCurrency(summaryTotalSales)}</strong></span>
                <span>총건수: <strong>${summaryTotalCount.toLocaleString()}건</strong></span>
                <span>평균단가: <strong>${formatCurrency(Math.round(summaryAvgPrice))}</strong></span>
            </div>`;

            if (compareData && purposeFilter === '전체') {
                datasets.push({ label: compareData.year + '년', data: chartData.map(d => d.compSales), backgroundColor: 'rgba(139, 92, 246, 0.5)', borderRadius: 6 });
                document.getElementById('managerLegend').innerHTML = `<div class="legend-item"><div class="legend-color" style="background: rgba(99, 102, 241, 0.8);"></div><span>${currentData.year}년</span></div><div class="legend-item"><div class="legend-color" style="background: rgba(139, 92, 246, 0.5);"></div><span>${compareData.year}년</span></div>${summaryHtml}`;
                document.getElementById('managerLegend').style.display = 'flex';
            } else {
                document.getElementById('managerLegend').innerHTML = summaryHtml;
                document.getElementById('managerLegend').style.display = 'flex';
            }

            // 외부 HTML 툴팁 생성 함수
            const getOrCreateManagerTooltip = (chart) => {
                let tooltipEl = document.getElementById('managerChartTooltip');
                if (!tooltipEl) {
                    tooltipEl = document.createElement('div');
                    tooltipEl.id = 'managerChartTooltip';
                    tooltipEl.style.cssText = `
                        position: fixed;
                        background: rgba(30, 41, 59, 0.98);
                        border-radius: 12px;
                        padding: 16px;
                        pointer-events: auto;
                        z-index: 99999;
                        font-size: 12px;
                        color: #e2e8f0;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                        max-width: 380px;
                        max-height: 85vh;
                        overflow-y: auto;
                        transition: opacity 0.2s ease;
                    `;
                    document.body.appendChild(tooltipEl);
                setupTooltipHover(tooltipEl);
                }
                return tooltipEl;
            };

            // 외부 툴팁 핸들러
            const externalTooltipHandler = (context) => {
                const { chart, tooltip } = context;
                const tooltipEl = getOrCreateManagerTooltip(chart);

                if (tooltip.opacity === 0 && !isTooltipHovered(tooltipEl)) {
                    hideTooltipWithDelay(tooltipEl);
                    return;
                }

                if (tooltip.body && tooltip.dataPoints && tooltip.dataPoints.length > 0) {
                    const idx = tooltip.dataPoints[0].dataIndex;
                    const d = chartData[idx];

                    // 성장/감소 여부
                    const isGrowth = d.compSales > 0 ? d.sales >= d.compSales : d.sales >= overallAvgSales;
                    const isTopRank = d.currentRank <= 5;
                    const isBottomRank = d.currentRank >= 11;

                    // 테두리 색상
                    let borderColor = 'rgba(99, 102, 241, 0.8)';
                    if (isBottomRank || !isGrowth) borderColor = 'rgba(245, 158, 11, 0.8)';
                    if (!isGrowth && d.compSales > 0 && d.sales < d.compSales * 0.9) borderColor = 'rgba(239, 68, 68, 0.8)';
                    tooltipEl.style.border = `2px solid ${borderColor}`;

                    let html = '';

                    // 1. 헤더 (순위 배지 포함)
                    let rankIcon = '📍';
                    let rankBadge = `${d.currentRank}위`;
                    if (d.currentRank === 1) { rankIcon = '🥇'; rankBadge = '1위'; }
                    else if (d.currentRank === 2) { rankIcon = '🥈'; rankBadge = '2위'; }
                    else if (d.currentRank === 3) { rankIcon = '🥉'; rankBadge = '3위'; }
                    else if (d.currentRank <= 5) { rankIcon = '🏆'; }

                    const headerBg = isTopRank ? 'rgba(99, 102, 241, 0.3)' : (isBottomRank ? 'rgba(245, 158, 11, 0.2)' : 'rgba(71, 85, 105, 0.3)');
                    html += `<div style="font-size: 15px; font-weight: bold; color: #fff; margin: -16px -16px 12px -16px; padding: 12px 16px; background: ${headerBg}; border-radius: 10px 10px 0 0; display: flex; justify-content: space-between; align-items: center;">`;
                    html += `<span>👤 ${d.name}</span>`;
                    html += `<span style="background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 12px; font-size: 12px;">${rankIcon} ${rankBadge}</span>`;
                    html += `</div>`;

                    // 2. 기본 지표 - 양쪽 연도 표시
                    html += `<div style="margin-bottom: 4px;">💰 ${currentData.year}년 매출: <strong style="color:#60a5fa;">${(d.sales / 100000000).toFixed(2)}억</strong></div>`;
                    if (compareData && d.compSales > 0) {
                        html += `<div style="margin-bottom: 4px;">💰 ${compareData.year}년 매출: <strong style="color:#f59e0b;">${(d.compSales / 100000000).toFixed(2)}억</strong></div>`;
                    }
                    html += `<div style="margin-bottom: 4px;">📋 ${currentData.year}년 건수: <strong>${d.count.toLocaleString()}건</strong> | 건당: <strong>${formatCurrency(Math.round(d.avgPrice))}</strong></div>`;
                    if (compareData && d.compCount > 0) {
                        const compAvgP = d.compSales / d.compCount;
                        html += `<div style="margin-bottom: 8px;">📋 ${compareData.year}년 건수: <strong>${d.compCount.toLocaleString()}건</strong> | 건당: <strong>${formatCurrency(Math.round(compAvgP))}</strong></div>`;
                    }

                    // 3. 비교 분석
                    html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 비교 분석 ──</div>`;

                    // 평균 대비
                    const avgDiff = d.sales - overallAvgSales;
                    const avgDiffPct = overallAvgSales > 0 ? (avgDiff / overallAvgSales * 100) : 0;
                    const avgColor = avgDiff >= 0 ? '#10b981' : '#ef4444';
                    const avgSign = avgDiff >= 0 ? '+' : '';
                    html += `<div style="margin-bottom: 4px;">📊 평균(${(overallAvgSales / 100000000).toFixed(2)}억) 대비: <span style="color: ${avgColor}; font-weight: bold;">${avgSign}${avgDiffPct.toFixed(0)}% (${avgSign}${(avgDiff / 100000000).toFixed(2)}억)</span></div>`;

                    // 전년 대비
                    if (compareData && d.compSales > 0) {
                        const yoyDiff = d.sales - d.compSales;
                        const yoyDiffPct = (yoyDiff / d.compSales * 100);
                        const yoyColor = yoyDiff >= 0 ? '#10b981' : '#ef4444';
                        const yoySign = yoyDiff >= 0 ? '+' : '';
                        html += `<div style="margin-bottom: 4px;">📆 ${compareData.year}년 대비: <span style="color: ${yoyColor}; font-weight: bold;">${yoySign}${yoyDiffPct.toFixed(1)}% (${yoySign}${(yoyDiff / 100000000).toFixed(2)}억)</span></div>`;

                        // 순위 변동
                        if (d.prevRank > 0) {
                            let rankText = '';
                            let rankColor = '#94a3b8';
                            if (d.rankChange > 0) {
                                rankColor = '#10b981';
                                rankText = `▲${d.rankChange}`;
                                if (d.rankChange >= 3) rankText += ' 급상승!';
                            } else if (d.rankChange < 0) {
                                rankColor = '#ef4444';
                                rankText = `▼${Math.abs(d.rankChange)}`;
                                if (d.rankChange <= -3) rankText += ' 주의 필요';
                            } else {
                                rankText = '━ 유지';
                            }
                            html += `<div style="margin-bottom: 8px;">🏅 순위 변동: ${d.prevRank}위 → ${d.currentRank}위 <span style="color: ${rankColor}; font-weight: bold;">(${rankText})</span></div>`;
                        }
                    }

                    // 4. 성장/감소 원인 분해
                    if (compareData && d.compSales > 0 && d.compCount > 0) {
                        const countEffect = (d.count - d.compCount) * d.compAvgPrice;
                        const priceEffect = (d.avgPrice - d.compAvgPrice) * d.count;
                        const totalChange = d.sales - d.compSales;

                        const sectionTitle = isGrowth ? '── 성장 원인 분해 ──' : '── 감소 원인 분해 ──';
                        html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">${sectionTitle}</div>`;

                        const countColor = countEffect >= 0 ? '#10b981' : '#ef4444';
                        const countSign = countEffect >= 0 ? '+' : '';
                        const countPct = totalChange !== 0 ? Math.abs(countEffect / totalChange * 100) : 0;
                        html += `<div style="margin-bottom: 4px;">📋 건수 효과: <span style="color: ${countColor};">${countSign}${(countEffect / 10000).toFixed(0)}만</span> <span style="color: #94a3b8;">(${countPct.toFixed(0)}%)</span></div>`;

                        const priceColor = priceEffect >= 0 ? '#10b981' : '#ef4444';
                        const priceSign = priceEffect >= 0 ? '+' : '';
                        const pricePct = totalChange !== 0 ? Math.abs(priceEffect / totalChange * 100) : 0;
                        html += `<div style="margin-bottom: 4px;">💵 단가 효과: <span style="color: ${priceColor};">${priceSign}${(priceEffect / 10000).toFixed(0)}만</span> <span style="color: #94a3b8;">(${pricePct.toFixed(0)}%)</span></div>`;

                        // 한 줄 요약
                        const mainCause = Math.abs(countEffect) > Math.abs(priceEffect) ? '건수' : '단가';
                        const causeDirection = (mainCause === '건수' ? countEffect : priceEffect) >= 0 ? '증가' : '감소';
                        const summaryText = isGrowth ? `→ ${mainCause} ${causeDirection}가 주요 성장 동력` : `→ ${mainCause} ${causeDirection}가 주요 감소 원인`;
                        html += `<div style="color: #60a5fa; font-size: 11px; margin-top: 4px;">${summaryText}</div>`;
                    }

                    // 5. 강점/약점 (검사목적별) - 전체 필터일 때만
                    if (purposeFilter === '전체') {
                        const strengths = [];
                        const weaknesses = [];

                        Object.entries(d.byPurpose).forEach(([purpose, data]) => {
                            const avg = purposeAvgMap[purpose]?.avgSales || 0;
                            if (avg > 0) {
                                const diff = (data.sales || 0) - avg;
                                const pct = (diff / avg * 100);
                                if (diff > 0) {
                                    strengths.push({ purpose, sales: data.sales, diff, pct });
                                } else if (diff < 0) {
                                    weaknesses.push({ purpose, sales: data.sales, diff, pct });
                                }
                            }
                        });

                        if (isGrowth && strengths.length > 0) {
                            strengths.sort((a, b) => b.diff - a.diff);
                            html += `<div style="color: #10b981; margin: 12px 0 6px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2); font-weight: 600;">▲ 강점 (평균 대비 높음)</div>`;
                            strengths.slice(0, 3).forEach(s => {
                                html += `<div style="margin-left: 8px; margin-bottom: 2px;">• ${s.purpose}: ${formatCurrency(s.sales)} <span style="color: #10b981;">(+${s.pct.toFixed(0)}%)</span></div>`;
                            });
                        } else if (!isGrowth && weaknesses.length > 0) {
                            weaknesses.sort((a, b) => a.diff - b.diff);
                            html += `<div style="color: #f59e0b; margin: 12px 0 6px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2); font-weight: 600;">▼ 약점 (평균 대비 낮음)</div>`;
                            weaknesses.slice(0, 3).forEach(w => {
                                html += `<div style="margin-left: 8px; margin-bottom: 2px;">• ${w.purpose}: ${formatCurrency(w.sales)} <span style="color: #ef4444;">(${w.pct.toFixed(0)}%)</span></div>`;
                            });
                        }

                        // 6. 거래처 현황
                        html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 거래처 현황 ──</div>`;
                        const clientDiff = d.activeClients - d.compActiveClients;
                        const clientDiffText = clientDiff >= 0 ? `<span style="color: #10b981;">+${clientDiff}개</span>` : `<span style="color: #ef4444;">${clientDiff}개</span>`;
                        html += `<div style="margin-bottom: 4px;">🏢 활성 거래처: <strong>${d.activeClients}개</strong> (전년 ${clientDiffText})</div>`;

                        if (d.topClients.length > 0) {
                            html += `<div style="margin-bottom: 4px; color: #94a3b8; font-size: 11px;">TOP 거래처: ${d.topClients.map(c => c[0]).join(', ')}</div>`;
                        }

                        // 7. 목표 달성 현황 / 개선 기회
                        if (isGrowth) {
                            // 목표 달성 현황
                            const yearlyTarget = overallAvgSales * 1.2; // 평균의 120%를 목표로 가정
                            const achievementRate = (d.sales / yearlyTarget * 100);
                            const remaining = yearlyTarget - d.sales;

                            html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 목표 달성 현황 ──</div>`;
                            html += `<div style="margin-bottom: 4px;">🎯 연간 목표: <strong>${(yearlyTarget / 100000000).toFixed(2)}억</strong></div>`;
                            const achColor = achievementRate >= 100 ? '#10b981' : '#f59e0b';
                            const achText = achievementRate >= 100 ? '달성!' : `목표까지 ${(remaining / 100000000).toFixed(2)}억`;
                            html += `<div style="margin-bottom: 4px;">📈 달성률: <span style="color: ${achColor}; font-weight: bold;">${achievementRate.toFixed(1)}%</span> <span style="color: #94a3b8;">(${achText})</span></div>`;
                        } else {
                            // 개선 기회
                            html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 개선 기회 ──</div>`;

                            let totalImprovement = 0;

                            // 약점 검사목적 개선
                            if (weaknesses.length > 0) {
                                const topWeak = weaknesses[0];
                                const improvePotential = Math.abs(topWeak.diff);
                                totalImprovement += improvePotential;
                                html += `<div style="margin-bottom: 4px;">💡 ${topWeak.purpose} 강화 시: <span style="color: #10b981;">+${formatCurrency(improvePotential)} 예상</span></div>`;
                            }

                            // 단가 개선
                            const avgPriceAll = totalSales / allManagers.reduce((s, m) => s + (m[1].count || 0), 0);
                            if (d.avgPrice < avgPriceAll) {
                                const priceImprove = (avgPriceAll - d.avgPrice) * d.count;
                                totalImprovement += priceImprove;
                                html += `<div style="margin-bottom: 4px;">💡 평균 단가 도달 시: <span style="color: #10b981;">+${formatCurrency(priceImprove)} 예상</span></div>`;
                            }

                            // 거래처 확대
                            if (d.activeClients < d.compActiveClients) {
                                const clientRecover = Math.abs(clientDiff) * (d.sales / Math.max(d.activeClients, 1));
                                totalImprovement += clientRecover;
                                html += `<div style="margin-bottom: 4px;">💡 휴면 거래처 재활성화 시: <span style="color: #10b981;">+${formatCurrency(clientRecover)} 예상</span></div>`;
                            }

                            if (totalImprovement > 0) {
                                html += `<div style="margin-top: 8px; padding: 8px; background: rgba(16, 185, 129, 0.1); border-radius: 6px; text-align: center;">`;
                                html += `<span style="color: #10b981; font-weight: bold;">총 개선 가능액: 약 ${formatCurrency(totalImprovement)}</span>`;
                                html += `</div>`;
                            }
                        }
                    }

                    tooltipEl.innerHTML = html;
                }

                // 위치 계산
                const canvasRect = chart.canvas.getBoundingClientRect();
                let left = canvasRect.left + tooltip.caretX + 15;
                let top = canvasRect.top + tooltip.caretY - 10;

                const tooltipWidth = tooltipEl.offsetWidth || 380;
                if (left + tooltipWidth > window.innerWidth - 20) {
                    left = canvasRect.left + tooltip.caretX - tooltipWidth - 15;
                }

                const tooltipHeight = tooltipEl.offsetHeight || 550;
                if (top + tooltipHeight > window.innerHeight - 20) {
                    top = window.innerHeight - tooltipHeight - 20;
                }
                if (top < 10) top = 10;

                tooltipEl.style.opacity = 1; tooltipEl.style.pointerEvents = 'auto';
                tooltipEl.style.left = left + 'px';
                tooltipEl.style.top = top + 'px';
            };

            charts.manager = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: { labels: chartData.map(d => d.name), datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: true },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: false,
                            external: externalTooltipHandler
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: v => formatCurrency(v) } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function initManagerChartPurposeFilter() {
            const purposes = new Set(['전체']);
            (currentData.by_purpose || []).forEach(p => {
                if (p[0] !== '접수취소') purposes.add(p[0]);
            });
            const select = document.getElementById('managerChartPurposeFilter');
            if (select) {
                select.innerHTML = '<option value="전체">전체 검사목적</option>' +
                    Array.from(purposes).filter(p => p !== '전체').map(p =>
                        `<option value="${p}">${p}</option>`
                    ).join('');
            }
        }

        function updateBranchChart() {
            const purposeFilter = document.getElementById('branchChartPurposeFilter')?.value || '전체';
            const sortBy = document.getElementById('branchChartSortBy')?.value || 'sales';
            // "기타" 팀 제외
            const branches = (currentData.by_branch || []).filter(b => b[0] !== '기타');
            const managers = currentData.by_manager || [];
            const managerMap = Object.fromEntries(managers);

            // 뱃지 업데이트
            document.getElementById('branchChartBadge').textContent = currentData.year + '년';

            const ctx = document.getElementById('branchChart').getContext('2d');
            if (charts.branch) charts.branch.destroy();

            // 검사목적 필터 적용 + 팀별 상세 데이터 수집
            const branchData = branches.map(b => {
                let sales = 0, count = 0;
                const byPurpose = b[1].by_purpose || {};
                const memberNames = Array.from(b[1].managers || []);

                if (purposeFilter === '전체') {
                    sales = b[1].sales || 0;
                    count = b[1].count || 0;
                } else {
                    const purposeData = byPurpose[purposeFilter];
                    if (purposeData) {
                        sales = purposeData.sales || 0;
                        count = purposeData.count || 0;
                    }
                }

                // 팀원별 매출/건수 정보
                const memberStats = memberNames.map(name => {
                    const m = managerMap[name];
                    if (!m) return null;
                    let mSales = 0, mCount = 0;
                    if (purposeFilter === '전체') {
                        mSales = m.sales || 0;
                        mCount = m.count || 0;
                    } else {
                        const pd = m.by_purpose?.[purposeFilter];
                        if (pd) { mSales = pd.sales || 0; mCount = pd.count || 0; }
                    }
                    return { name, sales: mSales, count: mCount };
                }).filter(Boolean).sort((a, b) => b.sales - a.sales);

                // 검사목적별 매출 TOP
                const topPurposes = Object.entries(byPurpose)
                    .map(([p, d]) => ({ name: p, sales: d.sales, count: d.count }))
                    .sort((a, b) => b.sales - a.sales)
                    .slice(0, 3);

                const memberCount = memberNames.length;
                return {
                    name: b[0],
                    sales,
                    count,
                    avgPrice: count > 0 ? sales / count : 0,
                    memberCount,
                    perPersonSales: memberCount > 0 ? sales / memberCount : 0,
                    memberStats,
                    topPurposes,
                    byPurpose
                };
            }).filter(d => d.sales > 0);

            // 비교 데이터 먼저 준비 (성장률 정렬을 위해)
            let compareMapForSort = {};
            if (compareData) {
                const compareBranches = (compareData.by_branch || []).filter(b => b[0] !== '기타');
                compareBranches.forEach(b => {
                    let sales = 0;
                    if (purposeFilter === '전체') {
                        sales = b[1].sales || 0;
                    } else {
                        const purposeData = b[1].by_purpose?.[purposeFilter];
                        if (purposeData) sales = purposeData.sales || 0;
                    }
                    compareMapForSort[b[0]] = sales;
                });
            }

            // 정렬 기준 적용
            branchData.sort((a, b) => {
                switch (sortBy) {
                    case 'efficiency':
                        return b.perPersonSales - a.perPersonSales;
                    case 'count':
                        return b.count - a.count;
                    case 'avgPrice':
                        return b.avgPrice - a.avgPrice;
                    case 'growth':
                        const aGrowth = compareMapForSort[a.name] ? ((a.sales - compareMapForSort[a.name]) / compareMapForSort[a.name]) : -999;
                        const bGrowth = compareMapForSort[b.name] ? ((b.sales - compareMapForSort[b.name]) / compareMapForSort[b.name]) : -999;
                        return bGrowth - aGrowth;
                    case 'sales':
                    default:
                        return b.sales - a.sales;
                }
            });

            // 순위 부여
            branchData.forEach((d, i) => d.rank = i + 1);

            // 총계/평균 계산
            const totalSales = branchData.reduce((sum, d) => sum + d.sales, 0);
            const totalCount = branchData.reduce((sum, d) => sum + d.count, 0);
            const avgSales = branchData.length > 0 ? totalSales / branchData.length : 0;
            const avgCount = branchData.length > 0 ? totalCount / branchData.length : 0;
            const totalMembers = branchData.reduce((sum, d) => sum + d.memberCount, 0);
            const avgPerPerson = totalMembers > 0 ? totalSales / totalMembers : 0;
            const avgCountPerPerson = totalMembers > 0 ? totalCount / totalMembers : 0;

            // 비교 데이터 처리
            let compareMap = {};
            let compTotalSales = 0, compTotalCount = 0;
            let compRankMap = {};

            if (compareData) {
                const compareBranches = (compareData.by_branch || []).filter(b => b[0] !== '기타');
                const compBranchData = compareBranches.map(b => {
                    let sales = 0, count = 0;
                    if (purposeFilter === '전체') {
                        sales = b[1].sales || 0;
                        count = b[1].count || 0;
                    } else {
                        const purposeData = b[1].by_purpose?.[purposeFilter];
                        if (purposeData) {
                            sales = purposeData.sales || 0;
                            count = purposeData.count || 0;
                        }
                    }
                    return { name: b[0], sales, count };
                }).filter(d => d.sales > 0).sort((a, b) => b.sales - a.sales);

                compBranchData.forEach((d, i) => {
                    compRankMap[d.name] = i + 1;
                    compareMap[d.name] = { sales: d.sales, count: d.count };
                    compTotalSales += d.sales;
                    compTotalCount += d.count;
                });
            }

            // 외부 HTML 툴팁 생성 함수
            const getOrCreateBranchTooltip = (chart) => {
                let tooltipEl = document.getElementById('branchChartTooltip');
                if (!tooltipEl) {
                    tooltipEl = document.createElement('div');
                    tooltipEl.id = 'branchChartTooltip';
                    tooltipEl.style.cssText = `
                        position: fixed;
                        background: rgba(30, 41, 59, 0.98);
                        border-radius: 12px;
                        padding: 16px;
                        pointer-events: auto;
                        z-index: 99999;
                        font-size: 13px;
                        color: #e2e8f0;
                        box-shadow: 0 20px 40px rgba(0,0,0,0.4);
                        min-width: 340px;
                        max-width: 400px;
                        max-height: 85vh;
                        overflow-y: auto;
                        transition: opacity 0.15s ease;
                        line-height: 1.5;
                    `;
                    document.body.appendChild(tooltipEl);
                setupTooltipHover(tooltipEl);
                }
                return tooltipEl;
            };

            // 외부 툴팁 핸들러
            const externalBranchTooltipHandler = (context) => {
                const { chart, tooltip } = context;
                const tooltipEl = getOrCreateBranchTooltip(chart);

                if (tooltip.opacity === 0 && !isTooltipHovered(tooltipEl)) {
                    hideTooltipWithDelay(tooltipEl);
                    return;
                }

                if (tooltip.body && tooltip.dataPoints && tooltip.dataPoints.length > 0) {
                    const dataIndex = tooltip.dataPoints[0].dataIndex;
                    const d = branchData[dataIndex];
                    const isTopTeam = d.rank <= 2;
                    const isBottomTeam = d.rank >= branchData.length - 1;

                    // 스타일 결정
                    let borderColor, headerBg, rankIcon;
                    if (d.rank === 1) {
                        borderColor = 'rgba(255, 215, 0, 0.8)';
                        headerBg = 'linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 180, 0, 0.2))';
                        rankIcon = '🏆';
                    } else if (d.rank === 2) {
                        borderColor = 'rgba(99, 102, 241, 0.8)';
                        headerBg = 'linear-gradient(135deg, rgba(99, 102, 241, 0.3), rgba(139, 92, 246, 0.2))';
                        rankIcon = '💎';
                    } else if (isBottomTeam) {
                        borderColor = d.rank === branchData.length ? 'rgba(239, 68, 68, 0.8)' : 'rgba(245, 158, 11, 0.8)';
                        headerBg = d.rank === branchData.length ? 'rgba(239, 68, 68, 0.2)' : 'rgba(245, 158, 11, 0.2)';
                        rankIcon = d.rank === branchData.length ? '🔴' : '⚠️';
                    } else {
                        borderColor = 'rgba(99, 102, 241, 0.6)';
                        headerBg = 'rgba(99, 102, 241, 0.2)';
                        rankIcon = '';
                    }
                    tooltipEl.style.border = `2px solid ${borderColor}`;

                    let html = '';

                    // 1. 헤더 (팀명 + 순위 배지)
                    html += `<div style="font-size: 16px; font-weight: bold; color: #fff; margin: -16px -16px 12px -16px; padding: 12px 16px; background: ${headerBg}; border-radius: 10px 10px 0 0; display: flex; justify-content: space-between; align-items: center;">
                        <span>${rankIcon} ${d.name}</span>
                        <span style="background: rgba(255,255,255,0.2); padding: 2px 10px; border-radius: 12px; font-size: 12px;">${d.rank}위</span>
                    </div>`;

                    // 2. 기본 지표 - 양쪽 연도 표시
                    const compTeamData = compareData ? compareMap[d.name] : null;
                    html += `<div style="margin-bottom: 4px;">💰 ${currentData.year}년 매출: <strong style="color:#60a5fa;">${(d.sales / 100000000).toFixed(2)}억</strong></div>`;
                    if (compTeamData && compTeamData.sales > 0) {
                        html += `<div style="margin-bottom: 4px;">💰 ${compareData.year}년 매출: <strong style="color:#f59e0b;">${(compTeamData.sales / 100000000).toFixed(2)}억</strong></div>`;
                    }
                    html += `<div style="margin-bottom: 4px;">📋 ${currentData.year}년 건수: <strong>${d.count.toLocaleString()}건</strong> | 건당: <strong>${formatCurrency(Math.round(d.avgPrice))}</strong></div>`;
                    if (compTeamData && compTeamData.count > 0) {
                        const compTeamAvgP = compTeamData.sales / compTeamData.count;
                        html += `<div style="margin-bottom: 8px;">📋 ${compareData.year}년 건수: <strong>${compTeamData.count.toLocaleString()}건</strong> | 건당: <strong>${formatCurrency(Math.round(compTeamAvgP))}</strong></div>`;
                    }

                    // 3. 팀 구성 & 생산성
                    const perPersonSales = d.memberCount > 0 ? d.sales / d.memberCount : 0;
                    const perPersonCount = d.memberCount > 0 ? d.count / d.memberCount : 0;
                    const perPersonVsAvg = avgPerPerson > 0 ? ((perPersonSales - avgPerPerson) / avgPerPerson * 100) : 0;
                    const perCountVsAvg = avgCountPerPerson > 0 ? ((perPersonCount - avgCountPerPerson) / avgCountPerPerson * 100) : 0;

                    html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 팀 구성 & 생산성 ──</div>`;
                    html += `<div style="margin-bottom: 4px;">👥 소속 인원: <strong>${d.memberCount}명</strong></div>`;

                    const ppColor = perPersonVsAvg >= 0 ? '#10b981' : '#ef4444';
                    const ppSign = perPersonVsAvg >= 0 ? '+' : '';
                    html += `<div style="margin-bottom: 4px;">💵 인당 매출: <strong>${(perPersonSales / 100000000).toFixed(2)}억</strong> <span style="color: ${ppColor};">(평균 대비 ${ppSign}${perPersonVsAvg.toFixed(1)}%)</span></div>`;

                    const pcColor = perCountVsAvg >= 0 ? '#10b981' : '#ef4444';
                    const pcSign = perCountVsAvg >= 0 ? '+' : '';
                    html += `<div style="margin-bottom: 4px;">📊 인당 건수: <strong>${Math.round(perPersonCount).toLocaleString()}건</strong> <span style="color: ${pcColor};">(평균 대비 ${pcSign}${perCountVsAvg.toFixed(1)}%)</span></div>`;

                    // 4. 전체 대비 점유율
                    const sharePercent = totalSales > 0 ? (d.sales / totalSales * 100) : 0;
                    html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 전체 대비 점유율 ──</div>`;
                    html += `<div style="margin-bottom: 4px;">📈 매출 점유율: <strong>${sharePercent.toFixed(1)}%</strong> (${d.rank}위/${branchData.length}팀)</div>`;

                    // 점유율 변화 (전년 대비)
                    if (compareData && compareMap[d.name]) {
                        const compShare = compTotalSales > 0 ? (compareMap[d.name].sales / compTotalSales * 100) : 0;
                        const shareDiff = sharePercent - compShare;
                        const shareColor = shareDiff >= 0 ? '#10b981' : '#ef4444';
                        const shareSign = shareDiff >= 0 ? '+' : '';
                        const shareStatus = shareDiff >= 0 ? '확대' : '축소';
                        html += `<div style="margin-bottom: 4px;">📊 점유율 변화: <span style="color: ${shareColor};">${shareSign}${shareDiff.toFixed(1)}%p (${shareStatus})</span></div>`;
                    }

                    // 5. 전년 대비 성장률
                    if (compareData && compareMap[d.name]) {
                        const compData = compareMap[d.name];
                        const yoyDiff = d.sales - compData.sales;
                        const yoyPct = compData.sales > 0 ? (yoyDiff / compData.sales * 100) : 0;
                        const yoyColor = yoyDiff >= 0 ? '#10b981' : '#ef4444';
                        const yoySign = yoyDiff >= 0 ? '+' : '';

                        html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 전년 대비 성장률 ──</div>`;
                        html += `<div style="margin-bottom: 4px;">💰 금액: <span style="color: ${yoyColor}; font-weight: bold;">${yoySign}${(yoyDiff / 100000000).toFixed(2)}억 (${yoySign}${yoyPct.toFixed(1)}%)</span></div>`;

                        // 순위 변동
                        const compRank = compRankMap[d.name];
                        if (compRank) {
                            const rankDiff = compRank - d.rank;
                            const rankColor = rankDiff > 0 ? '#10b981' : (rankDiff < 0 ? '#ef4444' : '#94a3b8');
                            const rankIcon = rankDiff > 0 ? '▲' : (rankDiff < 0 ? '▼' : '─');
                            html += `<div style="margin-bottom: 4px;">🏅 순위 변동: ${compRank}위 → ${d.rank}위 <span style="color: ${rankColor};">(${rankIcon}${Math.abs(rankDiff)})</span></div>`;
                        }

                        // 6. 성장/감소 원인 분해
                        const compAvgPrice = compData.count > 0 ? compData.sales / compData.count : 0;
                        const countEffect = (d.count - compData.count) * compAvgPrice;
                        const priceEffect = (d.avgPrice - compAvgPrice) * d.count;

                        html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 변화 원인 분해 ──</div>`;

                        const countColor = countEffect >= 0 ? '#10b981' : '#ef4444';
                        const countSign = countEffect >= 0 ? '+' : '';
                        const countPct = yoyDiff !== 0 ? Math.abs(countEffect / yoyDiff * 100) : 0;
                        html += `<div style="margin-bottom: 4px;">📋 건수 효과: <span style="color: ${countColor};">${countSign}${(countEffect / 10000).toFixed(0)}만</span> <span style="color: #94a3b8;">(${countPct.toFixed(0)}%)</span></div>`;

                        const priceColor = priceEffect >= 0 ? '#10b981' : '#ef4444';
                        const priceSign = priceEffect >= 0 ? '+' : '';
                        const pricePct = yoyDiff !== 0 ? Math.abs(priceEffect / yoyDiff * 100) : 0;
                        html += `<div style="margin-bottom: 4px;">💵 단가 효과: <span style="color: ${priceColor};">${priceSign}${(priceEffect / 10000).toFixed(0)}만</span> <span style="color: #94a3b8;">(${pricePct.toFixed(0)}%)</span></div>`;

                        const mainCause = Math.abs(countEffect) > Math.abs(priceEffect) ? '건수' : '단가';
                        const causeDirection = (mainCause === '건수' ? countEffect : priceEffect) >= 0 ? '증가' : '감소';
                        html += `<div style="color: #60a5fa; font-size: 11px; margin-top: 4px;">→ ${mainCause} ${causeDirection}가 주요 원인</div>`;
                    }

                    // 7. 강점 검사목적 (팀의 주력 검사)
                    if (d.topPurposes && d.topPurposes.length > 0) {
                        html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 강점 검사목적 TOP 3 ──</div>`;
                        d.topPurposes.forEach((p, idx) => {
                            const share = d.sales > 0 ? (p.sales / d.sales * 100) : 0;
                            const emoji = idx === 0 ? '🥇' : (idx === 1 ? '🥈' : '🥉');
                            html += `<div style="margin-left: 8px; margin-bottom: 2px;">${emoji} ${p.name}: ${(p.sales / 10000).toFixed(0)}만 <span style="color: #94a3b8;">(${share.toFixed(0)}%)</span></div>`;
                        });
                    }

                    // 8. 팀 내 TOP 기여자 (상위 팀) 또는 개선 기회 (하위 팀)
                    if (isTopTeam && d.memberStats && d.memberStats.length > 0) {
                        html += `<div style="color: #10b981; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2); font-weight: 600;">── 팀 내 TOP 기여자 ──</div>`;
                        d.memberStats.slice(0, 3).forEach((m, idx) => {
                            const contribution = d.sales > 0 ? (m.sales / d.sales * 100) : 0;
                            const emoji = idx === 0 ? '🥇' : (idx === 1 ? '🥈' : '🥉');
                            html += `<div style="margin-left: 8px; margin-bottom: 2px;">${emoji} ${m.name}: ${(m.sales / 10000).toFixed(0)}만 <span style="color: #94a3b8;">(기여율 ${contribution.toFixed(0)}%)</span></div>`;
                        });
                    } else if (isBottomTeam) {
                        html += `<div style="color: #f59e0b; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2); font-weight: 600;">── 개선 기회 ──</div>`;

                        // 평균 대비 부족분
                        const gapToAvg = avgSales - d.sales;
                        if (gapToAvg > 0) {
                            html += `<div style="margin-left: 8px; margin-bottom: 2px;">💡 평균 도달 시: <span style="color: #10b981;">+${(gapToAvg / 10000).toFixed(0)}만</span></div>`;
                        }

                        // 인당 생산성이 낮은 경우
                        if (perPersonVsAvg < 0) {
                            const potentialGain = d.memberCount * (avgPerPerson - perPersonSales);
                            html += `<div style="margin-left: 8px; margin-bottom: 2px;">💡 인당 생산성 평균 시: <span style="color: #10b981;">+${(potentialGain / 10000).toFixed(0)}만</span></div>`;
                        }

                        // 벤치마크 대상 팀
                        const topTeam = branchData[0];
                        html += `<div style="margin-left: 8px; margin-bottom: 2px;">🎯 벤치마크 대상: <span style="color: #60a5fa;">${topTeam.name}</span></div>`;
                    }

                    // 9. 담당자별 기여도 분포 바
                    if (d.memberStats && d.memberStats.length > 1) {
                        html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 담당자별 기여도 ──</div>`;
                        const barColors = ['#6366f1', '#8b5cf6', '#a855f7', '#d946ef', '#ec4899', '#f43f5e'];
                        let barHtml = '<div style="display: flex; height: 16px; border-radius: 4px; overflow: hidden; margin-bottom: 6px;">';
                        d.memberStats.forEach((m, idx) => {
                            const pct = d.sales > 0 ? (m.sales / d.sales * 100) : 0;
                            if (pct > 3) {
                                barHtml += `<div style="width: ${pct}%; background: ${barColors[idx % barColors.length]};" title="${m.name}: ${pct.toFixed(0)}%"></div>`;
                            }
                        });
                        barHtml += '</div>';
                        html += barHtml;

                        // 범례
                        let legendHtml = '<div style="display: flex; flex-wrap: wrap; gap: 8px; font-size: 11px;">';
                        d.memberStats.slice(0, 5).forEach((m, idx) => {
                            const pct = d.sales > 0 ? (m.sales / d.sales * 100) : 0;
                            legendHtml += `<span><span style="display: inline-block; width: 8px; height: 8px; border-radius: 2px; background: ${barColors[idx % barColors.length]}; margin-right: 3px;"></span>${m.name} ${pct.toFixed(0)}%</span>`;
                        });
                        legendHtml += '</div>';
                        html += legendHtml;
                    }

                    tooltipEl.innerHTML = html;
                }

                // 위치 계산
                const canvasRect = chart.canvas.getBoundingClientRect();
                let left = canvasRect.left + tooltip.caretX + 15;
                let top = canvasRect.top + tooltip.caretY - 10;

                const tooltipWidth = tooltipEl.offsetWidth || 380;
                if (left + tooltipWidth > window.innerWidth - 20) {
                    left = canvasRect.left + tooltip.caretX - tooltipWidth - 15;
                }

                const tooltipHeight = tooltipEl.offsetHeight || 600;
                if (top + tooltipHeight > window.innerHeight - 20) {
                    top = window.innerHeight - tooltipHeight - 20;
                }
                if (top < 10) top = 10;

                tooltipEl.style.opacity = 1; tooltipEl.style.pointerEvents = 'auto';
                tooltipEl.style.left = left + 'px';
                tooltipEl.style.top = top + 'px';
            };

            // 범례 업데이트
            if (compareData) {
                document.getElementById('branchLegend').innerHTML = `
                    <div class="legend-item"><div class="legend-color" style="background: rgba(99, 102, 241, 0.8);"></div><span>${currentData.year}년</span></div>
                    <div class="legend-item"><div class="legend-color" style="background: rgba(139, 92, 246, 0.5);"></div><span>${compareData.year}년</span></div>
                    <div style="margin-left: auto; display: flex; gap: 20px; font-size: 12px; color: #666;">
                        <span>총매출: <strong>${formatCurrency(totalSales)}</strong> (평균 ${formatCurrency(avgSales)})</span>
                        <span>총건수: <strong>${totalCount.toLocaleString()}건</strong> (평균 ${Math.round(avgCount).toLocaleString()}건)</span>
                    </div>`;
                document.getElementById('branchLegend').style.display = 'flex';

                charts.branch = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: branchData.map(d => d.name),
                        datasets: [
                            { label: currentData.year + '년', data: branchData.map(d => d.sales), backgroundColor: 'rgba(99, 102, 241, 0.8)', borderRadius: 6 },
                            { label: compareData.year + '년', data: branchData.map(d => compareMap[d.name]?.sales || 0), backgroundColor: 'rgba(139, 92, 246, 0.5)', borderRadius: 6 }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: true },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                enabled: false,
                                external: externalBranchTooltipHandler
                            }
                        },
                        scales: { y: { ticks: { callback: v => formatCurrency(v) } } }
                    }
                });
            } else {
                document.getElementById('branchLegend').innerHTML = `
                    <div style="display: flex; gap: 20px; font-size: 12px; color: #666;">
                        <span>총매출: <strong>${formatCurrency(totalSales)}</strong> (평균 ${formatCurrency(avgSales)})</span>
                        <span>총건수: <strong>${totalCount.toLocaleString()}건</strong> (평균 ${Math.round(avgCount).toLocaleString()}건)</span>
                    </div>`;
                document.getElementById('branchLegend').style.display = 'flex';

                charts.branch = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: branchData.map(d => d.name),
                        datasets: [{ data: branchData.map(d => d.sales), backgroundColor: 'rgba(99, 102, 241, 0.8)', borderRadius: 6 }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: true },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                enabled: false,
                                external: externalBranchTooltipHandler
                            }
                        },
                        scales: { y: { ticks: { callback: v => formatCurrency(v) } }, x: { grid: { display: false } } }
                    }
                });
            }
        }

        // 월별 탭 전체 업데이트
        function updateMonthlyTab() {
            initMonthlyChartFilters();
            initGrowthPurposeFilter();
            updateMonthlyKPI();
            updateMonthlyChartWithFilter();
            updateMonthlyCountChartWithFilter();
            updateGrowthTrendChart();
            updateHeatmap();
            updateMonthlyDetailTable();
        }

        // 월별 차트 필터 초기화
        function initMonthlyChartFilters() {
            const purposes = currentData.by_purpose || [];
            const managers = currentData.by_manager || [];

            // 매출 차트 필터
            const salesPurposeFilter = document.getElementById('monthlySalesPurposeFilter');
            const salesManagerFilter = document.getElementById('monthlySalesManagerFilter');
            // 건수 차트 필터
            const countPurposeFilter = document.getElementById('monthlyCountPurposeFilter');
            const countManagerFilter = document.getElementById('monthlyCountManagerFilter');

            if (salesPurposeFilter && salesManagerFilter && countPurposeFilter && countManagerFilter) {
                // 현재 선택값 저장
                const salesPurposeVal = salesPurposeFilter.value;
                const salesManagerVal = salesManagerFilter.value;
                const countPurposeVal = countPurposeFilter.value;
                const countManagerVal = countManagerFilter.value;

                // 목적 필터 옵션
                const purposeOptions = '<option value="전체">전체 목적</option>' +
                    purposes.map(p => `<option value="${p[0]}">${p[0]}</option>`).join('');
                salesPurposeFilter.innerHTML = purposeOptions;
                countPurposeFilter.innerHTML = purposeOptions;

                // 담당자 필터 옵션
                const managerOptions = '<option value="전체">전체 담당</option>' +
                    managers.map(m => `<option value="${m[0]}">${m[0]}</option>`).join('');
                salesManagerFilter.innerHTML = managerOptions;
                countManagerFilter.innerHTML = managerOptions;

                // 선택값 복원
                if (salesPurposeVal) salesPurposeFilter.value = salesPurposeVal;
                if (salesManagerVal) salesManagerFilter.value = salesManagerVal;
                if (countPurposeVal) countPurposeFilter.value = countPurposeVal;
                if (countManagerVal) countManagerFilter.value = countManagerVal;
            }
        }

        // 필터된 월별 데이터 가져오기
        function getFilteredMonthlyData(purposeFilter, managerFilter) {
            const monthly = currentData.by_month || [];
            const monthMap = Object.fromEntries(monthly);

            // 필터 없으면 원본 반환
            if (purposeFilter === '전체' && managerFilter === '전체') {
                return monthMap;
            }

            // 필터링된 데이터 계산
            const filteredMap = {};
            for (let m = 1; m <= 12; m++) {
                const data = monthMap[m];
                if (data) {
                    let sales = 0, count = 0;

                    // 목적별 필터
                    if (purposeFilter !== '전체' && managerFilter === '전체') {
                        const purposeData = data.byPurpose?.[purposeFilter];
                        if (purposeData) {
                            sales = purposeData.sales || 0;
                            count = purposeData.count || 0;
                        }
                    }
                    // 담당자별 필터
                    else if (purposeFilter === '전체' && managerFilter !== '전체') {
                        const managerData = data.byManager?.[managerFilter];
                        if (managerData) {
                            sales = managerData.sales || 0;
                            count = managerData.count || 0;
                        }
                    }
                    // 목적 + 담당자 필터 (근사치)
                    else {
                        const purposeData = data.byPurpose?.[purposeFilter];
                        const managerData = data.byManager?.[managerFilter];
                        if (purposeData && managerData) {
                            // 둘 중 작은 값 사용 (교집합 근사)
                            sales = Math.min(purposeData.sales || 0, managerData.sales || 0);
                            count = Math.min(purposeData.count || 0, managerData.count || 0);
                        }
                    }

                    filteredMap[m] = { sales, count };
                }
            }
            return filteredMap;
        }

        // 월별 KPI 오버레이 데이터 저장
        let monthlyKpiOverlayData = {};

        // 월별 KPI 업데이트
        function updateMonthlyKPI() {
            const monthly = currentData.by_month || [];
            const monthMap = Object.fromEntries(monthly);
            const compMonthMap = compareData ? Object.fromEntries(compareData.by_month || []) : {};
            const monthNames = ['', '1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'];

            let maxMonth = 0, maxSales = 0, minMonth = 0, minSales = Infinity;
            let totalSales = 0, totalCount = 0, monthCount = 0;

            // 전년도 데이터
            let compMaxMonth = 0, compMaxSales = 0, compMinMonth = 0, compMinSales = Infinity;
            let compTotalSales = 0, compTotalCount = 0, compMonthCount = 0;

            for (let m = 1; m <= 12; m++) {
                const data = monthMap[m];
                if (data && data.sales > 0) {
                    totalSales += data.sales;
                    totalCount += data.count;
                    monthCount++;
                    if (data.sales > maxSales) { maxSales = data.sales; maxMonth = m; }
                    if (data.sales < minSales) { minSales = data.sales; minMonth = m; }
                }

                // 전년도 계산
                const compData = compMonthMap[m];
                if (compData && compData.sales > 0) {
                    compTotalSales += compData.sales;
                    compTotalCount += compData.count;
                    compMonthCount++;
                    if (compData.sales > compMaxSales) { compMaxSales = compData.sales; compMaxMonth = m; }
                    if (compData.sales < compMinSales) { compMinSales = compData.sales; compMinMonth = m; }
                }
            }

            // 검사목적별 분석 (평균 대비)
            const purposes = currentData.by_purpose || [];
            const purposeData = purposes.map(p => ({ name: p[0], sales: p[1].sales, count: p[1].count }))
                .filter(p => p.name !== '접수취소' && p.sales > 0);
            const purposeTotalSales = purposeData.reduce((s, p) => s + p.sales, 0);
            const purposeAvg = purposeData.length > 0 ? purposeTotalSales / purposeData.length : 0;

            // 평균 대비 상위/하위 분류
            const aboveAvgPurposes = purposeData.filter(p => p.sales >= purposeAvg).sort((a, b) => b.sales - a.sales);
            const belowAvgPurposes = purposeData.filter(p => p.sales < purposeAvg).sort((a, b) => a.sales - b.sales);

            // 최고 매출 검사목적 (평균 이상 중 1위)
            const topPurpose = aboveAvgPurposes.length > 0 ? aboveAvgPurposes[0] : null;
            // 최저 매출 검사목적 (평균 미만 중 최하위)
            const bottomPurpose = belowAvgPurposes.length > 0 ? belowAvgPurposes[0] : null;

            // 기본 KPI 표시
            document.getElementById('monthlyMaxMonth').textContent = maxMonth > 0 ? monthNames[maxMonth] : '-';
            document.getElementById('monthlyMaxValue').innerHTML = maxMonth > 0 ?
                `${formatCurrency(maxSales)}${topPurpose ? `<div style="font-size:11px;color:#10b981;margin-top:4px;">🏆 ${topPurpose.name}</div>` : ''}` : '-';
            document.getElementById('monthlyMinMonth').textContent = minMonth > 0 && minMonth < 13 ? monthNames[minMonth] : '-';
            document.getElementById('monthlyMinValue').innerHTML = minMonth < Infinity ?
                `${formatCurrency(minSales)}${bottomPurpose ? `<div style="font-size:11px;color:#ef4444;margin-top:4px;">📉 ${bottomPurpose.name}</div>` : ''}` : '-';
            document.getElementById('monthlyAvgSales').textContent = monthCount > 0 ? formatCurrency(totalSales / monthCount) : '-';

            // 월평균에 상/중/하 검사목적 표시
            let avgPurposeHtml = monthCount > 0 ? `월평균 ${Math.round(totalCount / monthCount).toLocaleString()}건` : '-';
            if (purposeData.length >= 3) {
                const midIdx = Math.floor(purposeData.length / 2);
                const sortedByDiff = [...purposeData].sort((a, b) => Math.abs(a.sales - purposeAvg) - Math.abs(b.sales - purposeAvg));
                const midPurpose = sortedByDiff[0]; // 평균에 가장 가까운 목적
                avgPurposeHtml += `<div style="font-size:10px;color:#94a3b8;margin-top:4px;line-height:1.3;">
                    <span style="color:#10b981;">▲${topPurpose?.name?.substring(0,4) || '-'}</span>
                    <span style="color:#f59e0b;">■${midPurpose?.name?.substring(0,4) || '-'}</span>
                    <span style="color:#ef4444;">▼${bottomPurpose?.name?.substring(0,4) || '-'}</span>
                </div>`;
            }
            document.getElementById('monthlyAvgCount').innerHTML = avgPurposeHtml;
            document.getElementById('monthlyYtdSales').textContent = formatCurrency(totalSales);
            document.getElementById('monthlyYtdCount').textContent = `총 ${totalCount.toLocaleString()}건`;

            // 오버레이 데이터 저장 및 생성
            const compYear = compareData?.year || '전년';
            const currYear = currentData.year || '금년';
            const avgSales = monthCount > 0 ? totalSales / monthCount : 0;
            const compAvgSales = compMonthCount > 0 ? compTotalSales / compMonthCount : 0;
            const avgCount = monthCount > 0 ? totalCount / monthCount : 0;
            const compAvgCount = compMonthCount > 0 ? compTotalCount / compMonthCount : 0;

            // 최고 매출월 오버레이
            if (compareData && compMaxSales > 0) {
                const maxDiff = maxSales - compMaxSales;
                const maxPct = (maxDiff / compMaxSales * 100);
                const maxColor = maxDiff >= 0 ? '#10b981' : '#ef4444';
                const maxSign = maxDiff >= 0 ? '+' : '';
                monthlyKpiOverlayData.max = `
                    <div style="font-size:12px;font-weight:600;margin-bottom:10px;color:#94a3b8;">📊 ${compYear}년 대비</div>
                    <div style="margin-bottom:6px;"><span style="color:#94a3b8;">${compYear}년:</span> <strong>${monthNames[compMaxMonth]}</strong> (${formatCurrency(compMaxSales)})</div>
                    <div style="margin-bottom:6px;"><span style="color:#94a3b8;">${currYear}년:</span> <strong>${monthNames[maxMonth]}</strong> (${formatCurrency(maxSales)})</div>
                    <div style="padding-top:8px;border-top:1px dashed rgba(255,255,255,0.2);margin-top:8px;">
                        <span style="color:#94a3b8;">변화:</span> <span style="color:${maxColor};font-weight:bold;">${maxSign}${maxPct.toFixed(1)}%</span>
                        <span style="color:#94a3b8;font-size:11px;"> (${maxSign}${(maxDiff/10000).toFixed(0)}만)</span>
                    </div>
                `;
            } else {
                monthlyKpiOverlayData.max = `<div style="color:#94a3b8;">비교 연도를 선택하세요</div>`;
            }

            // 최저 매출월 오버레이
            if (compareData && compMinSales > 0 && compMinSales < Infinity) {
                const minDiff = minSales - compMinSales;
                const minPct = (minDiff / compMinSales * 100);
                const minColor = minDiff >= 0 ? '#10b981' : '#ef4444';
                const minSign = minDiff >= 0 ? '+' : '';
                monthlyKpiOverlayData.min = `
                    <div style="font-size:12px;font-weight:600;margin-bottom:10px;color:#94a3b8;">📊 ${compYear}년 대비</div>
                    <div style="margin-bottom:6px;"><span style="color:#94a3b8;">${compYear}년:</span> <strong>${monthNames[compMinMonth]}</strong> (${formatCurrency(compMinSales)})</div>
                    <div style="margin-bottom:6px;"><span style="color:#94a3b8;">${currYear}년:</span> <strong>${monthNames[minMonth]}</strong> (${formatCurrency(minSales)})</div>
                    <div style="padding-top:8px;border-top:1px dashed rgba(255,255,255,0.2);margin-top:8px;">
                        <span style="color:#94a3b8;">변화:</span> <span style="color:${minColor};font-weight:bold;">${minSign}${minPct.toFixed(1)}%</span>
                        <span style="color:#94a3b8;font-size:11px;"> (${minSign}${(minDiff/10000).toFixed(0)}만)</span>
                    </div>
                `;
            } else {
                monthlyKpiOverlayData.min = `<div style="color:#94a3b8;">비교 연도를 선택하세요</div>`;
            }

            // 월평균 오버레이
            if (compareData && compAvgSales > 0) {
                const avgDiff = avgSales - compAvgSales;
                const avgPct = (avgDiff / compAvgSales * 100);
                const avgColor = avgDiff >= 0 ? '#10b981' : '#ef4444';
                const avgSign = avgDiff >= 0 ? '+' : '';
                const countDiff = avgCount - compAvgCount;
                const countColor = countDiff >= 0 ? '#10b981' : '#ef4444';
                const countSign = countDiff >= 0 ? '+' : '';
                monthlyKpiOverlayData.avg = `
                    <div style="font-size:12px;font-weight:600;margin-bottom:10px;color:#94a3b8;">📊 ${compYear}년 대비</div>
                    <div style="margin-bottom:4px;"><span style="color:#94a3b8;">${compYear}년 평균:</span></div>
                    <div style="margin-bottom:8px;margin-left:8px;">${formatCurrency(compAvgSales)} / ${Math.round(compAvgCount).toLocaleString()}건</div>
                    <div style="margin-bottom:4px;"><span style="color:#94a3b8;">${currYear}년 평균:</span></div>
                    <div style="margin-bottom:8px;margin-left:8px;">${formatCurrency(avgSales)} / ${Math.round(avgCount).toLocaleString()}건</div>
                    <div style="padding-top:8px;border-top:1px dashed rgba(255,255,255,0.2);">
                        <div><span style="color:#94a3b8;">매출:</span> <span style="color:${avgColor};font-weight:bold;">${avgSign}${avgPct.toFixed(1)}%</span></div>
                        <div><span style="color:#94a3b8;">건수:</span> <span style="color:${countColor};font-weight:bold;">${countSign}${((countDiff/compAvgCount)*100).toFixed(1)}%</span></div>
                    </div>
                `;
            } else {
                monthlyKpiOverlayData.avg = `<div style="color:#94a3b8;">비교 연도를 선택하세요</div>`;
            }

            // YTD 오버레이
            if (compareData && compTotalSales > 0) {
                const ytdDiff = totalSales - compTotalSales;
                const ytdPct = (ytdDiff / compTotalSales * 100);
                const ytdColor = ytdDiff >= 0 ? '#10b981' : '#ef4444';
                const ytdSign = ytdDiff >= 0 ? '+' : '';
                const ytdCountDiff = totalCount - compTotalCount;
                const ytdCountColor = ytdCountDiff >= 0 ? '#10b981' : '#ef4444';
                const ytdCountSign = ytdCountDiff >= 0 ? '+' : '';
                monthlyKpiOverlayData.ytd = `
                    <div style="font-size:12px;font-weight:600;margin-bottom:10px;color:#94a3b8;">📊 ${compYear}년 대비</div>
                    <div style="margin-bottom:4px;"><span style="color:#94a3b8;">${compYear}년 누적:</span></div>
                    <div style="margin-bottom:8px;margin-left:8px;">${formatCurrency(compTotalSales)} / ${compTotalCount.toLocaleString()}건</div>
                    <div style="margin-bottom:4px;"><span style="color:#94a3b8;">${currYear}년 누적:</span></div>
                    <div style="margin-bottom:8px;margin-left:8px;">${formatCurrency(totalSales)} / ${totalCount.toLocaleString()}건</div>
                    <div style="padding-top:8px;border-top:1px dashed rgba(255,255,255,0.2);">
                        <div><span style="color:#94a3b8;">매출:</span> <span style="color:${ytdColor};font-weight:bold;">${ytdSign}${ytdPct.toFixed(1)}%</span> <span style="color:#94a3b8;">(${ytdSign}${(ytdDiff/100000000).toFixed(2)}억)</span></div>
                        <div><span style="color:#94a3b8;">건수:</span> <span style="color:${ytdCountColor};font-weight:bold;">${ytdCountSign}${((ytdCountDiff/compTotalCount)*100).toFixed(1)}%</span> <span style="color:#94a3b8;">(${ytdCountSign}${ytdCountDiff.toLocaleString()}건)</span></div>
                    </div>
                `;
            } else {
                monthlyKpiOverlayData.ytd = `<div style="color:#94a3b8;">비교 연도를 선택하세요</div>`;
            }
        }

        // 월별 KPI 오버레이 표시
        function showMonthlyKpiOverlay(type) {
            const overlay = document.getElementById(`monthly${type.charAt(0).toUpperCase() + type.slice(1)}Overlay`);
            if (overlay && monthlyKpiOverlayData[type]) {
                overlay.innerHTML = monthlyKpiOverlayData[type];
                overlay.style.display = 'flex';
                overlay.style.flexDirection = 'column';
                overlay.style.justifyContent = 'center';
            }
        }

        // 월별 KPI 오버레이 숨기기
        function hideMonthlyKpiOverlay(type) {
            const overlay = document.getElementById(`monthly${type.charAt(0).toUpperCase() + type.slice(1)}Overlay`);
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        // 월별 매출 차트 (필터 적용)
        function updateMonthlyChartWithFilter() {
            const purposeFilter = document.getElementById('monthlySalesPurposeFilter')?.value || '전체';
            const managerFilter = document.getElementById('monthlySalesManagerFilter')?.value || '전체';

            // 원본 데이터에서 요약 정보 계산
            const monthly = currentData.by_month || [];
            const monthMap = Object.fromEntries(monthly);

            let totalSales = 0, totalCount = 0, monthCount = 0;

            if (purposeFilter === '전체' && managerFilter === '전체') {
                // 전체 데이터 사용
                for (let m = 1; m <= 12; m++) {
                    const data = monthMap[m];
                    if (data && data.sales > 0) {
                        totalSales += data.sales;
                        totalCount += data.count || 0;
                        monthCount++;
                    }
                }
            } else {
                // 필터된 데이터 계산
                for (let m = 1; m <= 12; m++) {
                    const data = monthMap[m];
                    if (data) {
                        let sales = 0, count = 0;
                        if (purposeFilter !== '전체' && managerFilter === '전체') {
                            const purposeData = data.byPurpose?.[purposeFilter];
                            if (purposeData) { sales = purposeData.sales || 0; count = purposeData.count || 0; }
                        } else if (purposeFilter === '전체' && managerFilter !== '전체') {
                            const managerData = data.byManager?.[managerFilter];
                            if (managerData) { sales = managerData.sales || 0; count = managerData.count || 0; }
                        } else {
                            const purposeData = data.byPurpose?.[purposeFilter];
                            const managerData = data.byManager?.[managerFilter];
                            if (purposeData && managerData) {
                                sales = Math.min(purposeData.sales || 0, managerData.sales || 0);
                                count = Math.min(purposeData.count || 0, managerData.count || 0);
                            }
                        }
                        if (sales > 0) {
                            totalSales += sales;
                            totalCount += count;
                            monthCount++;
                        }
                    }
                }
            }

            const avgPrice = totalCount > 0 ? totalSales / totalCount : 0;
            const avgSales = monthCount > 0 ? totalSales / monthCount : 0;

            // 전년도 요약 계산
            const compMonthly = compareData?.by_month || [];
            const compMonthMapSum = Object.fromEntries(compMonthly);
            let compTotalSales = 0, compTotalCount = 0;

            if (purposeFilter === '전체' && managerFilter === '전체') {
                for (let m = 1; m <= 12; m++) {
                    const cData = compMonthMapSum[m];
                    if (cData && cData.sales > 0) {
                        compTotalSales += cData.sales;
                        compTotalCount += cData.count || 0;
                    }
                }
            }

            const salesGrowth = compTotalSales > 0 ? ((totalSales - compTotalSales) / compTotalSales * 100) : 0;
            const growthColor = salesGrowth >= 0 ? '#10b981' : '#ef4444';
            const growthSign = salesGrowth >= 0 ? '+' : '';

            // 연도별 색상
            const summaryColors = [
                { bg: '#dbeafe', text: '#1e40af', strong: '#3b82f6' },  // 현재 연도 (파랑)
                { bg: '#fef3c7', text: '#92400e', strong: '#f59e0b' },  // 비교1 (주황)
                { bg: '#e9d5ff', text: '#6b21a8', strong: '#a855f7' },  // 비교2 (보라)
                { bg: '#d1fae5', text: '#065f46', strong: '#10b981' },  // 비교3 (초록)
            ];

            // 요약 정보 표시
            const summaryEl = document.getElementById('monthlySalesSummary');
            if (summaryEl) {
                let html = `<span style="white-space:nowrap;background:${summaryColors[0].bg};padding:4px 10px;border-radius:4px;color:${summaryColors[0].text};"><strong style="color:${summaryColors[0].strong};">${currentData.year}년:</strong> ${(totalSales / 100000000).toFixed(1)}억</span>`;

                // 다중 비교 연도 표시
                if (compareDataList && compareDataList.length > 0) {
                    compareDataList.forEach((compData, idx) => {
                        const colorIdx = (idx + 1) % summaryColors.length;
                        const compMonthly = compData.by_month || [];
                        const compTotal = compMonthly.reduce((sum, [m, d]) => sum + (d?.sales || 0), 0);
                        html += `<span style="white-space:nowrap;background:${summaryColors[colorIdx].bg};padding:4px 10px;border-radius:4px;color:${summaryColors[colorIdx].text};"><strong style="color:${summaryColors[colorIdx].strong};">${compData.year}년:</strong> ${(compTotal / 100000000).toFixed(1)}억</span>`;
                    });
                } else if (compareData && compTotalSales > 0) {
                    html += `<span style="white-space:nowrap;background:${summaryColors[1].bg};padding:4px 10px;border-radius:4px;color:${summaryColors[1].text};"><strong style="color:${summaryColors[1].strong};">${compareData.year}년:</strong> ${(compTotalSales / 100000000).toFixed(1)}억</span>`;
                }

                if (compTotalSales > 0) {
                    html += `<span style="white-space:nowrap;background:${salesGrowth >= 0 ? '#d1fae5' : '#fee2e2'};padding:4px 10px;border-radius:4px;color:${growthColor};">증감: <strong>${growthSign}${salesGrowth.toFixed(1)}%</strong></span>`;
                }
                html += `<span style="white-space:nowrap;background:#e0e7ff;padding:4px 10px;border-radius:4px;color:#3730a3;">건수: <strong>${totalCount.toLocaleString()}건</strong></span>`;
                html += `<span style="white-space:nowrap;background:#fce7f3;padding:4px 10px;border-radius:4px;color:#9d174d;">평균: <strong>${(avgSales / 100000000).toFixed(2)}억</strong></span>`;
                html += `<span style="white-space:nowrap;background:#fef08a;padding:4px 10px;border-radius:4px;color:#854d0e;">단가: <strong>${Math.round(avgPrice / 10000).toLocaleString()}만</strong></span>`;
                summaryEl.innerHTML = html;
            }

            // 차트 업데이트
            updateMonthlyChart(purposeFilter, managerFilter);
        }

        // 월별 매출 차트
        function updateMonthlyChart(purposeFilter = '전체', managerFilter = '전체') {
            const monthly = currentData.by_month || [];
            const ctx = document.getElementById('monthlyChart');
            if (!ctx) return;
            if (charts.monthly) charts.monthly.destroy();

            const labels = ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'];
            const originalMonthMap = Object.fromEntries(monthly);
            const filteredMap = getFilteredMonthlyData(purposeFilter, managerFilter);
            const monthMap = (purposeFilter === '전체' && managerFilter === '전체') ? originalMonthMap : filteredMap;

            // 비교 연도 데이터도 동일한 필터 적용
            const compMonthly = compareData?.by_month || [];
            const originalCompMonthMap = Object.fromEntries(compMonthly);
            let compMonthMap = originalCompMonthMap;

            // 필터가 있으면 비교 데이터도 필터링
            if (purposeFilter !== '전체' || managerFilter !== '전체') {
                compMonthMap = {};
                for (let m = 1; m <= 12; m++) {
                    const data = originalCompMonthMap[m];
                    if (data) {
                        let sales = 0, count = 0;
                        if (purposeFilter !== '전체' && managerFilter === '전체') {
                            const purposeData = data.byPurpose?.[purposeFilter];
                            if (purposeData) { sales = purposeData.sales || 0; count = purposeData.count || 0; }
                        } else if (purposeFilter === '전체' && managerFilter !== '전체') {
                            const managerData = data.byManager?.[managerFilter];
                            if (managerData) { sales = managerData.sales || 0; count = managerData.count || 0; }
                        } else {
                            const purposeData = data.byPurpose?.[purposeFilter];
                            const managerData = data.byManager?.[managerFilter];
                            if (purposeData && managerData) {
                                sales = Math.min(purposeData.sales || 0, managerData.sales || 0);
                                count = Math.min(purposeData.count || 0, managerData.count || 0);
                            }
                        }
                        compMonthMap[m] = { sales, count, byPurpose: data.byPurpose || {}, byManager: data.byManager || {} };
                    }
                }
            }

            // 월별 데이터 배열 생성
            const monthlyData = labels.map((label, i) => {
                const m = i + 1;
                const origData = originalMonthMap[m] || { sales: 0, count: 0, byPurpose: {}, byManager: {} };
                const filtData = monthMap[m] || { sales: 0, count: 0 };
                const compData = compMonthMap[m] || { sales: 0, count: 0, byPurpose: {}, byManager: {} };

                // 필터된 데이터가 있으면 사용, 아니면 원본 사용
                const sales = filtData.sales || 0;
                const count = filtData.count || 0;
                const avgPrice = count > 0 ? sales / count : 0;
                const compSales = compData.sales || 0;
                const compCount = compData.count || 0;
                const compAvgPrice = compCount > 0 ? compSales / compCount : 0;

                return {
                    month: m,
                    label,
                    sales,
                    count,
                    avgPrice,
                    byPurpose: origData.byPurpose || {},
                    byManager: origData.byManager || {},
                    compSales,
                    compCount,
                    compAvgPrice,
                    compByPurpose: compData.byPurpose || {},
                    compByManager: compData.byManager || {}
                };
            });

            // 월평균 계산 (데이터가 있는 월만)
            const validMonths = monthlyData.filter(d => d.sales > 0);
            const monthlyAvg = validMonths.length > 0 ? validMonths.reduce((s, d) => s + d.sales, 0) / validMonths.length : 0;
            const monthlyAvgCount = validMonths.length > 0 ? validMonths.reduce((s, d) => s + d.count, 0) / validMonths.length : 0;

            // 연간 목표 (임의 설정 - 전년 대비 10% 증가)
            const lastYearTotal = monthlyData.reduce((s, d) => s + d.compSales, 0);
            const yearlyTarget = lastYearTotal > 0 ? lastYearTotal * 1.1 : monthlyAvg * 12;

            // 연속 상승/하락 계산
            const calculateTrend = (monthIdx) => {
                if (monthIdx < 1) return { type: null, count: 0 };
                let count = 0;
                let direction = null;
                for (let i = monthIdx; i >= 1; i--) {
                    const current = monthlyData[i].sales;
                    const prev = monthlyData[i - 1].sales;
                    if (prev === 0) break;
                    const isUp = current >= prev;
                    if (direction === null) {
                        direction = isUp ? 'up' : 'down';
                        count = 1;
                    } else if ((direction === 'up' && isUp) || (direction === 'down' && !isUp)) {
                        count++;
                    } else {
                        break;
                    }
                }
                return { type: direction, count };
            };

            // 전월 대비 방향 전환 체크
            const checkTurnAround = (monthIdx) => {
                if (monthIdx < 2) return null;
                const current = monthlyData[monthIdx].sales;
                const prev = monthlyData[monthIdx - 1].sales;
                const prevPrev = monthlyData[monthIdx - 2].sales;
                if (prev === 0 || prevPrev === 0) return null;

                const currentDir = current >= prev ? 'up' : 'down';
                const prevDir = prev >= prevPrev ? 'up' : 'down';

                if (currentDir !== prevDir) {
                    return currentDir === 'up' ? '상승 전환' : '하락 전환';
                }
                return null;
            };

            // 다중 연도 색상 팔레트
            const yearColors = [
                { border: '#6366f1', bg: 'rgba(99, 102, 241, 0.1)' },   // 현재 연도 (파랑)
                { border: '#8b5cf6', bg: 'rgba(139, 92, 246, 0.1)' },   // 비교1 (보라)
                { border: '#f59e0b', bg: 'rgba(245, 158, 11, 0.1)' },   // 비교2 (주황)
                { border: '#10b981', bg: 'rgba(16, 185, 129, 0.1)' },   // 비교3 (초록)
                { border: '#ef4444', bg: 'rgba(239, 68, 68, 0.1)' },    // 비교4 (빨강)
            ];

            const datasets = [{
                label: currentData.year + '년',
                data: monthlyData.map(d => d.sales),
                borderColor: yearColors[0].border,
                backgroundColor: yearColors[0].bg,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 8
            }];

            // 다중 비교 연도 데이터 추가
            let legendHtml = `<div class="legend-item"><div class="legend-color" style="background: ${yearColors[0].border};"></div><span>${currentData.year}년</span></div>`;

            if (compareDataList && compareDataList.length > 0) {
                compareDataList.forEach((compData, idx) => {
                    const colorIdx = (idx + 1) % yearColors.length;
                    const compMonthly = compData.by_month || [];
                    const compMonthMap = Object.fromEntries(compMonthly);

                    datasets.push({
                        label: compData.year + '년',
                        data: labels.map((_, i) => {
                            const m = i + 1;
                            return compMonthMap[m]?.sales || 0;
                        }),
                        borderColor: yearColors[colorIdx].border,
                        backgroundColor: yearColors[colorIdx].bg,
                        fill: idx === 0,  // 첫 번째 비교 연도만 fill
                        tension: 0.4,
                        pointRadius: 4,
                        borderDash: idx > 0 ? [5, 5] : []  // 두 번째부터 점선
                    });

                    legendHtml += `<div class="legend-item"><div class="legend-color" style="background: ${yearColors[colorIdx].border};${idx > 0 ? ' border-style: dashed;' : ''}"></div><span>${compData.year}년</span></div>`;
                });

                document.getElementById('monthlyLegend').innerHTML = legendHtml;
                document.getElementById('monthlyLegend').style.display = 'flex';
            } else if (compareData) {
                // 하위 호환성: 단일 비교 데이터
                datasets.push({
                    label: compareData.year + '년',
                    data: monthlyData.map(d => d.compSales),
                    borderColor: yearColors[1].border,
                    backgroundColor: yearColors[1].bg,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4
                });
                document.getElementById('monthlyLegend').innerHTML = legendHtml + `<div class="legend-item"><div class="legend-color" style="background: ${yearColors[1].border};"></div><span>${compareData.year}년</span></div>`;
                document.getElementById('monthlyLegend').style.display = 'flex';
            } else {
                document.getElementById('monthlyLegend').style.display = 'none';
            }

            // 외부 HTML 툴팁 생성 함수 (v2 - 2026-01-02 업데이트)
            const getOrCreateMonthlyTooltip = (chart) => {
                let tooltipEl = document.getElementById('monthlyChartTooltip');
                if (!tooltipEl) {
                    tooltipEl = document.createElement('div');
                    tooltipEl.id = 'monthlyChartTooltip';
                    tooltipEl.style.cssText = `
                        position: fixed;
                        background: rgba(30, 41, 59, 0.98);
                        border-radius: 12px;
                        padding: 16px;
                        pointer-events: auto;
                        z-index: 99999;
                        font-size: 13px;
                        color: #e2e8f0;
                        box-shadow: 0 20px 40px rgba(0,0,0,0.4);
                        min-width: 340px;
                        max-width: 380px;
                        max-height: 85vh;
                        overflow-y: auto;
                        transition: opacity 0.15s ease;
                        line-height: 1.5;
                    `;
                    document.body.appendChild(tooltipEl);
                setupTooltipHover(tooltipEl);
                }
                return tooltipEl;
            };

            // 외부 툴팁 핸들러
            const externalTooltipHandler = (context) => {
                const { chart, tooltip } = context;
                const tooltipEl = getOrCreateMonthlyTooltip(chart);

                if (tooltip.opacity === 0 && !isTooltipHovered(tooltipEl)) {
                    hideTooltipWithDelay(tooltipEl);
                    return;
                }

                if (tooltip.body && tooltip.dataPoints && tooltip.dataPoints.length > 0) {
                    const monthIdx = tooltip.dataPoints[0].dataIndex;
                    const d = monthlyData[monthIdx];

                    // 증감 여부 판단 (월평균 대비)
                    const isIncrease = d.sales >= monthlyAvg;
                    const borderColor = isIncrease ? 'rgba(99, 102, 241, 0.8)' : 'rgba(239, 68, 68, 0.8)';
                    tooltipEl.style.border = `2px solid ${borderColor}`;

                    let html = '';

                    // 1. 헤더
                    const headerBg = isIncrease ? 'rgba(99, 102, 241, 0.3)' : 'rgba(239, 68, 68, 0.3)';
                    html += `<div style="font-size: 16px; font-weight: bold; color: #fff; margin: -16px -16px 12px -16px; padding: 12px 16px; background: ${headerBg}; border-radius: 10px 10px 0 0;">📅 ${d.label}</div>`;

                    // 2. 기본 지표 - 모든 연도 표시 (다중 비교 지원)
                    const tooltipYearColors = ['#60a5fa', '#8b5cf6', '#f59e0b', '#10b981', '#ef4444'];
                    html += `<div style="margin-bottom: 4px;">💰 ${currentData.year}년 매출: <strong style="color:${tooltipYearColors[0]};">${(d.sales / 100000000).toFixed(2)}억</strong></div>`;
                    html += `<div style="margin-bottom: 4px;">📋 ${currentData.year}년 건수: <strong>${d.count.toLocaleString()}건</strong> | 건당: <strong>${formatCurrency(Math.round(d.avgPrice))}</strong></div>`;

                    // 모든 비교 연도 데이터 표시
                    if (compareDataList && compareDataList.length > 0) {
                        compareDataList.forEach((compData, idx) => {
                            const compMonthly = compData.by_month || [];
                            const compMonthMap = Object.fromEntries(compMonthly);
                            const monthData = compMonthMap[d.month];
                            const colorIdx = (idx + 1) % tooltipYearColors.length;

                            if (monthData && monthData.sales > 0) {
                                const compAvgPrice = monthData.count > 0 ? monthData.sales / monthData.count : 0;
                                html += `<div style="margin-bottom: 4px;">💰 ${compData.year}년 매출: <strong style="color:${tooltipYearColors[colorIdx]};">${(monthData.sales / 100000000).toFixed(2)}억</strong></div>`;
                                html += `<div style="margin-bottom: 4px;">📋 ${compData.year}년 건수: <strong>${monthData.count.toLocaleString()}건</strong> | 건당: <strong>${formatCurrency(Math.round(compAvgPrice))}</strong></div>`;
                            } else {
                                html += `<div style="margin-bottom: 4px; color: #94a3b8;">💰 ${compData.year}년: 데이터 없음</div>`;
                            }
                        });
                    } else if (d.compSales > 0) {
                        // 하위 호환성: 단일 비교 데이터
                        const compAvgPrice = d.compSales / d.compCount;
                        html += `<div style="margin-bottom: 4px;">💰 ${compareData?.year || '전년'}년 매출: <strong style="color:#f59e0b;">${(d.compSales / 100000000).toFixed(2)}억</strong></div>`;
                        html += `<div style="margin-bottom: 8px;">📋 ${compareData?.year || '전년'}년 건수: <strong>${d.compCount.toLocaleString()}건</strong> | 건당: <strong>${formatCurrency(Math.round(compAvgPrice))}</strong></div>`;
                    }

                    // 3. 비교 분석
                    html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 비교 분석 ──</div>`;

                    // 월평균 대비
                    const avgDiff = d.sales - monthlyAvg;
                    const avgDiffPct = monthlyAvg > 0 ? (avgDiff / monthlyAvg * 100) : 0;
                    const avgColor = avgDiff >= 0 ? '#10b981' : '#ef4444';
                    const avgSign = avgDiff >= 0 ? '+' : '';
                    html += `<div style="margin-bottom: 4px;">📊 월평균 대비: <span style="color: ${avgColor}; font-weight: bold;">${avgSign}${avgDiffPct.toFixed(1)}% (${avgSign}${(avgDiff / 10000).toFixed(0)}만)</span></div>`;

                    // 각 비교 연도 동월 대비
                    if (compareDataList && compareDataList.length > 0) {
                        compareDataList.forEach((compData, idx) => {
                            const compMonthly = compData.by_month || [];
                            const compMonthMap = Object.fromEntries(compMonthly);
                            const monthData = compMonthMap[d.month];

                            if (monthData && monthData.sales > 0) {
                                const yoyDiff = d.sales - monthData.sales;
                                const yoyDiffPct = (yoyDiff / monthData.sales * 100);
                                const yoyColor = yoyDiff >= 0 ? '#10b981' : '#ef4444';
                                const yoySign = yoyDiff >= 0 ? '+' : '';
                                html += `<div style="margin-bottom: 4px;">📆 ${compData.year}년 대비: <span style="color: ${yoyColor}; font-weight: bold;">${yoySign}${yoyDiffPct.toFixed(1)}% (${yoySign}${(yoyDiff / 10000).toFixed(0)}만)</span></div>`;
                            }
                        });
                    } else if (d.compSales > 0) {
                        // 하위 호환성: 단일 비교 데이터
                        const yoyDiff = d.sales - d.compSales;
                        const yoyDiffPct = (yoyDiff / d.compSales * 100);
                        const yoyColor = yoyDiff >= 0 ? '#10b981' : '#ef4444';
                        const yoySign = yoyDiff >= 0 ? '+' : '';
                        html += `<div style="margin-bottom: 4px;">📆 전년 동월 대비: <span style="color: ${yoyColor}; font-weight: bold;">${yoySign}${yoyDiffPct.toFixed(1)}% (${yoySign}${(yoyDiff / 10000).toFixed(0)}만)</span></div>`;
                    }

                    // 전월 대비
                    if (monthIdx > 0 && monthlyData[monthIdx - 1].sales > 0) {
                        const prevMonth = monthlyData[monthIdx - 1];
                        const momDiff = d.sales - prevMonth.sales;
                        const momDiffPct = (momDiff / prevMonth.sales * 100);
                        const momColor = momDiff >= 0 ? '#10b981' : '#ef4444';
                        const momSign = momDiff >= 0 ? '+' : '';

                        // 추세 표시
                        const trend = calculateTrend(monthIdx);
                        const turnAround = checkTurnAround(monthIdx);
                        let trendText = '';
                        if (turnAround) {
                            trendText = ` <span style="color: ${turnAround === '상승 전환' ? '#10b981' : '#ef4444'};">↗ ${turnAround}</span>`;
                        } else if (trend.count >= 2) {
                            const trendIcon = trend.type === 'up' ? '↗' : '↘';
                            const trendColor = trend.type === 'up' ? '#10b981' : '#ef4444';
                            trendText = ` <span style="color: ${trendColor};">${trendIcon} ${trend.count}개월 연속${trend.type === 'up' ? '↑' : '↓'}</span>`;
                        }
                        html += `<div style="margin-bottom: 8px;">📈 전월 대비: <span style="color: ${momColor}; font-weight: bold;">${momSign}${momDiffPct.toFixed(1)}%</span>${trendText}</div>`;
                    }

                    // 4. 변화 원인 분해 (전월 대비)
                    if (monthIdx > 0 && monthlyData[monthIdx - 1].sales > 0) {
                        const prevMonth = monthlyData[monthIdx - 1];
                        const countEffect = (d.count - prevMonth.count) * prevMonth.avgPrice;
                        const priceEffect = (d.avgPrice - prevMonth.avgPrice) * d.count;
                        const totalChange = d.sales - prevMonth.sales;

                        html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 변화 원인 분해 ──</div>`;

                        const countColor = countEffect >= 0 ? '#10b981' : '#ef4444';
                        const countSign = countEffect >= 0 ? '+' : '';
                        const countPct = totalChange !== 0 ? Math.abs(countEffect / totalChange * 100) : 0;
                        html += `<div style="margin-bottom: 4px;">📋 건수 효과: <span style="color: ${countColor};">${countSign}${(countEffect / 10000).toFixed(0)}만</span> <span style="color: #94a3b8;">(${countPct.toFixed(0)}%)</span></div>`;

                        const priceColor = priceEffect >= 0 ? '#10b981' : '#ef4444';
                        const priceSign = priceEffect >= 0 ? '+' : '';
                        const pricePct = totalChange !== 0 ? Math.abs(priceEffect / totalChange * 100) : 0;
                        html += `<div style="margin-bottom: 4px;">💵 단가 효과: <span style="color: ${priceColor};">${priceSign}${(priceEffect / 10000).toFixed(0)}만</span> <span style="color: #94a3b8;">(${pricePct.toFixed(0)}%)</span></div>`;

                        // 한 줄 요약
                        const mainCause = Math.abs(countEffect) > Math.abs(priceEffect) ? '건수' : '단가';
                        const causeDirection = (mainCause === '건수' ? countEffect : priceEffect) >= 0 ? '증가' : '감소';
                        html += `<div style="color: #60a5fa; font-size: 11px; margin-top: 4px;">→ ${mainCause} ${causeDirection}가 주요 원인</div>`;
                    }

                    // 5. 증감 요인 (검사목적별) - 건수, 매출, 단가 상세 분석
                    const purposeChanges = Object.entries(d.byPurpose).map(([purpose, data]) => {
                        const compPurpose = d.compByPurpose[purpose] || { sales: 0, count: 0 };
                        const salesDiff = data.sales - compPurpose.sales;
                        const countDiff = (data.count || 0) - (compPurpose.count || 0);
                        const avgPrice = data.count > 0 ? data.sales / data.count : 0;
                        const compAvgPrice = compPurpose.count > 0 ? compPurpose.sales / compPurpose.count : 0;
                        const priceDiff = avgPrice - compAvgPrice;
                        const salesDiffPct = compPurpose.sales > 0 ? (salesDiff / compPurpose.sales * 100) : (data.sales > 0 ? 100 : 0);
                        const countDiffPct = compPurpose.count > 0 ? (countDiff / compPurpose.count * 100) : (data.count > 0 ? 100 : 0);
                        return {
                            purpose,
                            sales: data.sales,
                            count: data.count || 0,
                            avgPrice,
                            salesDiff,
                            countDiff,
                            priceDiff,
                            salesDiffPct,
                            countDiffPct
                        };
                    }).sort((a, b) => b.salesDiff - a.salesDiff);

                    const topIncreases = purposeChanges.filter(p => p.salesDiff > 0).slice(0, 3);
                    const topDecreases = purposeChanges.filter(p => p.salesDiff < 0).slice(0, 3);

                    if (isIncrease && topIncreases.length > 0) {
                        html += `<div style="color: #10b981; margin: 12px 0 6px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2); font-weight: 600;">▲ 증가 요인 (검사목적)</div>`;
                        topIncreases.forEach(p => {
                            const countColor = p.countDiff >= 0 ? '#10b981' : '#ef4444';
                            const countSign = p.countDiff >= 0 ? '+' : '';
                            const priceColor = p.priceDiff >= 0 ? '#10b981' : '#ef4444';
                            const priceSign = p.priceDiff >= 0 ? '+' : '';
                            html += `<div style="margin-left: 8px; margin-bottom: 6px; padding: 6px 8px; background: rgba(16, 185, 129, 0.1); border-radius: 6px; border-left: 3px solid #10b981;">
                                <div style="font-weight: 600; margin-bottom: 4px;">• ${p.purpose}</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 11px;">
                                    <div>📋 건수: <span style="color: ${countColor};">${countSign}${p.countDiff.toLocaleString()}건</span> <span style="color: #94a3b8;">(${countSign}${p.countDiffPct.toFixed(0)}%)</span></div>
                                    <div>💰 매출: <span style="color: #10b981;">+${(p.salesDiff / 10000).toFixed(0)}만</span></div>
                                    <div>💵 단가: <span style="color: ${priceColor};">${priceSign}${(p.priceDiff / 10000).toFixed(1)}만</span></div>
                                    <div>📊 현재: ${p.count.toLocaleString()}건 / ${(p.sales / 10000).toFixed(0)}만</div>
                                </div>
                            </div>`;
                        });
                    } else if (!isIncrease && topDecreases.length > 0) {
                        html += `<div style="color: #ef4444; margin: 12px 0 6px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2); font-weight: 600;">▼ 감소 요인 (검사목적)</div>`;
                        topDecreases.forEach(p => {
                            const countColor = p.countDiff >= 0 ? '#10b981' : '#ef4444';
                            const countSign = p.countDiff >= 0 ? '+' : '';
                            const priceColor = p.priceDiff >= 0 ? '#10b981' : '#ef4444';
                            const priceSign = p.priceDiff >= 0 ? '+' : '';
                            html += `<div style="margin-left: 8px; margin-bottom: 6px; padding: 6px 8px; background: rgba(239, 68, 68, 0.1); border-radius: 6px; border-left: 3px solid #ef4444;">
                                <div style="font-weight: 600; margin-bottom: 4px;">• ${p.purpose}</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 11px;">
                                    <div>📋 건수: <span style="color: ${countColor};">${countSign}${p.countDiff.toLocaleString()}건</span> <span style="color: #94a3b8;">(${countSign}${p.countDiffPct.toFixed(0)}%)</span></div>
                                    <div>💰 매출: <span style="color: #ef4444;">${(p.salesDiff / 10000).toFixed(0)}만</span></div>
                                    <div>💵 단가: <span style="color: ${priceColor};">${priceSign}${(p.priceDiff / 10000).toFixed(1)}만</span></div>
                                    <div>📊 현재: ${p.count.toLocaleString()}건 / ${(p.sales / 10000).toFixed(0)}만</div>
                                </div>
                            </div>`;
                        });
                    }

                    // 6. 주요 기여자/영향자
                    const managerChanges = Object.entries(d.byManager).map(([manager, data]) => {
                        const compManager = d.compByManager[manager] || { sales: 0 };
                        const diff = data.sales - compManager.sales;
                        const contribution = d.sales > 0 ? (data.sales / d.sales * 100) : 0;
                        return { manager, sales: data.sales, diff, contribution };
                    }).sort((a, b) => b.diff - a.diff);

                    const topContributors = managerChanges.filter(m => m.diff > 0).slice(0, 3);
                    const topDecliners = managerChanges.filter(m => m.diff < 0).slice(0, 3);

                    if (isIncrease && topContributors.length > 0) {
                        html += `<div style="color: #60a5fa; margin: 12px 0 6px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2); font-weight: 600;">▲ 주요 기여자 TOP 3</div>`;
                        topContributors.forEach(m => {
                            html += `<div style="margin-left: 8px; margin-bottom: 2px;">• ${m.manager}: <span style="color: #10b981;">+${(m.diff / 10000).toFixed(0)}만</span> <span style="color: #94a3b8;">(기여도 ${m.contribution.toFixed(0)}%)</span></div>`;
                        });
                    } else if (!isIncrease && topDecliners.length > 0) {
                        html += `<div style="color: #f59e0b; margin: 12px 0 6px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2); font-weight: 600;">▼ 주요 감소 담당자</div>`;
                        topDecliners.forEach(m => {
                            html += `<div style="margin-left: 8px; margin-bottom: 2px;">• ${m.manager}: <span style="color: #ef4444;">${(m.diff / 10000).toFixed(0)}만</span> <span style="color: #94a3b8;">(영향도 ${Math.abs(m.contribution).toFixed(0)}%)</span></div>`;
                        });
                    }

                    // 6.5 계절성 패턴 분석 (전년도 동일 패턴 여부)
                    if (d.compSales > 0) {
                        // 전년도 이 월의 평균 대비 비교
                        const compValidMonths = monthlyData.filter(m => m.compSales > 0);
                        const compMonthlyAvg = compValidMonths.length > 0 ? compValidMonths.reduce((s, m) => s + m.compSales, 0) / compValidMonths.length : 0;

                        const currentBelowAvg = d.sales < monthlyAvg;
                        const compBelowAvg = d.compSales < compMonthlyAvg;

                        // 현재 연도 평균 대비 비율
                        const currentVsAvg = monthlyAvg > 0 ? ((d.sales - monthlyAvg) / monthlyAvg * 100) : 0;
                        // 전년도 평균 대비 비율
                        const compVsAvg = compMonthlyAvg > 0 ? ((d.compSales - compMonthlyAvg) / compMonthlyAvg * 100) : 0;

                        html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 계절성 패턴 분석 ──</div>`;

                        // 양쪽 모두 평균 이하인지 확인
                        if (currentBelowAvg && compBelowAvg) {
                            const seasonalIcon = '🔄';
                            html += `<div style="margin-bottom: 4px; color: #f59e0b;">${seasonalIcon} <strong>계절적 비수기 패턴 감지</strong></div>`;
                            html += `<div style="margin-left: 8px; margin-bottom: 2px; color: #94a3b8;">• ${currentData.year}년 ${d.month}월: 평균 대비 <span style="color: #ef4444;">${currentVsAvg.toFixed(1)}%</span></div>`;
                            html += `<div style="margin-left: 8px; margin-bottom: 2px; color: #94a3b8;">• ${compareData?.year || '전년'}년 ${d.month}월: 평균 대비 <span style="color: #ef4444;">${compVsAvg.toFixed(1)}%</span></div>`;
                            html += `<div style="color: #60a5fa; font-size: 11px; margin-top: 4px;">→ 2년 연속 이 달은 비수기로 보임</div>`;
                        } else if (currentBelowAvg && !compBelowAvg) {
                            html += `<div style="margin-bottom: 4px; color: #ef4444;">⚠️ <strong>이례적 하락</strong> - 전년도는 정상 수준</div>`;
                            html += `<div style="margin-left: 8px; color: #94a3b8;">• ${compareData?.year || '전년'}년 ${d.month}월: 평균 대비 <span style="color: #10b981;">+${compVsAvg.toFixed(1)}%</span></div>`;
                        } else if (!currentBelowAvg && compBelowAvg) {
                            html += `<div style="margin-bottom: 4px; color: #10b981;">✨ <strong>비수기 극복</strong> - 전년도 대비 개선</div>`;
                            html += `<div style="margin-left: 8px; color: #94a3b8;">• ${compareData?.year || '전년'}년 ${d.month}월: 평균 대비 <span style="color: #ef4444;">${compVsAvg.toFixed(1)}%</span></div>`;
                        }
                    }

                    // 6.6 검사목적별 매출 분포 (TOP 5)
                    const purposeBreakdown = Object.entries(d.byPurpose)
                        .map(([purpose, data]) => ({
                            purpose,
                            sales: data.sales,
                            count: data.count,
                            share: d.sales > 0 ? (data.sales / d.sales * 100) : 0,
                            compSales: d.compByPurpose[purpose]?.sales || 0
                        }))
                        .sort((a, b) => b.sales - a.sales)
                        .slice(0, 5);

                    if (purposeBreakdown.length > 0) {
                        html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── 검사목적별 분포 TOP 5 ──</div>`;
                        purposeBreakdown.forEach((p, idx) => {
                            const yoyChange = p.compSales > 0 ? ((p.sales - p.compSales) / p.compSales * 100) : 0;
                            const yoyColor = yoyChange >= 0 ? '#10b981' : '#ef4444';
                            const yoySign = yoyChange >= 0 ? '+' : '';
                            const rankEmoji = idx === 0 ? '🥇' : (idx === 1 ? '🥈' : (idx === 2 ? '🥉' : '•'));
                            html += `<div style="margin-left: 8px; margin-bottom: 3px;">
                                ${rankEmoji} <strong>${p.purpose}</strong>: ${(p.sales / 10000).toFixed(0)}만
                                <span style="color: #94a3b8;">(${p.share.toFixed(0)}%)</span>
                                ${p.compSales > 0 ? `<span style="color: ${yoyColor}; font-size: 11px;"> YoY ${yoySign}${yoyChange.toFixed(0)}%</span>` : ''}
                            </div>`;
                        });

                        // 기타 비중 표시
                        const top5Total = purposeBreakdown.reduce((s, p) => s + p.sales, 0);
                        const othersShare = d.sales > 0 ? ((d.sales - top5Total) / d.sales * 100) : 0;
                        if (othersShare > 0) {
                            html += `<div style="margin-left: 8px; color: #94a3b8; font-size: 11px;">• 기타: ${othersShare.toFixed(0)}%</div>`;
                        }
                    }

                    // 7. YTD 누적 현황
                    const ytdSales = monthlyData.slice(0, monthIdx + 1).reduce((s, m) => s + m.sales, 0);
                    const ytdCompSales = monthlyData.slice(0, monthIdx + 1).reduce((s, m) => s + m.compSales, 0);
                    const ytdTargetPct = yearlyTarget > 0 ? (ytdSales / (yearlyTarget * (monthIdx + 1) / 12) * 100) : 0;
                    const ytdYoyPct = ytdCompSales > 0 ? ((ytdSales - ytdCompSales) / ytdCompSales * 100) : 0;

                    html += `<div style="color: #94a3b8; margin: 12px 0 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2);">── YTD 누적 현황 ──</div>`;
                    html += `<div style="margin-bottom: 4px;">📊 1~${d.month}월 누적: <strong>${(ytdSales / 100000000).toFixed(2)}억</strong></div>`;

                    // 연간 목표 대비
                    const targetColor = ytdTargetPct >= 100 ? '#10b981' : '#f59e0b';
                    const targetStatus = ytdTargetPct >= 100 ? '정상 궤도' : `목표 대비 ${(ytdTargetPct - 100).toFixed(1)}%p`;
                    html += `<div style="margin-bottom: 4px;">🎯 연간 목표 대비: <span style="color: ${targetColor};">${ytdTargetPct.toFixed(1)}%</span> <span style="color: #94a3b8;">(${targetStatus})</span></div>`;

                    // 전년 동기 대비
                    if (ytdCompSales > 0) {
                        const ytdYoyColor = ytdYoyPct >= 0 ? '#10b981' : '#ef4444';
                        const ytdYoySign = ytdYoyPct >= 0 ? '+' : '';
                        html += `<div style="margin-bottom: 4px;">📅 전년 동기 대비: <span style="color: ${ytdYoyColor}; font-weight: bold;">${ytdYoySign}${ytdYoyPct.toFixed(1)}%</span></div>`;
                    }

                    // 회복 필요액 (목표 미달 시)
                    if (ytdTargetPct < 100 && monthIdx < 11) {
                        const remainingMonths = 12 - monthIdx - 1;
                        const remainingTarget = yearlyTarget - ytdSales;
                        const monthlyNeeded = remainingTarget / remainingMonths;
                        html += `<div style="color: #f59e0b; font-size: 11px; margin-top: 4px;">⚠️ 회복 필요: 남은 ${remainingMonths}개월간 월 ${(monthlyNeeded / 100000000).toFixed(2)}억 필요</div>`;
                    }

                    tooltipEl.innerHTML = html;
                }

                // 위치 계산 - 데이터 포인트 위쪽에 표시
                const canvasRect = chart.canvas.getBoundingClientRect();
                const tooltipHeight = tooltipEl.offsetHeight || 500;
                const tooltipWidth = tooltipEl.offsetWidth || 360;

                let left = canvasRect.left + tooltip.caretX + 15;
                let top = canvasRect.top + tooltip.caretY - tooltipHeight - 20;

                // 오른쪽 화면 벗어나면 왼쪽에 표시
                if (left + tooltipWidth > window.innerWidth - 20) {
                    left = canvasRect.left + tooltip.caretX - tooltipWidth - 15;
                }

                // 위쪽 화면 벗어나면 아래쪽에 표시
                if (top < 10) {
                    top = canvasRect.top + tooltip.caretY + 20;
                }

                // 아래쪽 화면 벗어나면 조정
                if (top + tooltipHeight > window.innerHeight - 20) {
                    top = window.innerHeight - tooltipHeight - 20;
                }

                tooltipEl.style.opacity = 1; tooltipEl.style.pointerEvents = 'auto';
                tooltipEl.style.left = left + 'px';
                tooltipEl.style.top = top + 'px';
            };

            charts.monthly = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: true },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: false,
                            external: externalTooltipHandler
                        }
                    },
                    scales: {
                        y: { ticks: { callback: v => formatCurrency(v) } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // 월별 건수 차트 (필터 적용)
        function updateMonthlyCountChartWithFilter() {
            const purposeFilter = document.getElementById('monthlyCountPurposeFilter')?.value || '전체';
            const managerFilter = document.getElementById('monthlyCountManagerFilter')?.value || '전체';

            // 원본 데이터에서 요약 정보 계산
            const monthly = currentData.by_month || [];
            const monthMap = Object.fromEntries(monthly);

            let totalSales = 0, totalCount = 0, monthCount = 0;

            if (purposeFilter === '전체' && managerFilter === '전체') {
                // 전체 데이터 사용
                for (let m = 1; m <= 12; m++) {
                    const data = monthMap[m];
                    if (data && data.count > 0) {
                        totalSales += data.sales || 0;
                        totalCount += data.count;
                        monthCount++;
                    }
                }
            } else {
                // 필터된 데이터 계산
                for (let m = 1; m <= 12; m++) {
                    const data = monthMap[m];
                    if (data) {
                        let sales = 0, count = 0;
                        if (purposeFilter !== '전체' && managerFilter === '전체') {
                            const purposeData = data.byPurpose?.[purposeFilter];
                            if (purposeData) { sales = purposeData.sales || 0; count = purposeData.count || 0; }
                        } else if (purposeFilter === '전체' && managerFilter !== '전체') {
                            const managerData = data.byManager?.[managerFilter];
                            if (managerData) { sales = managerData.sales || 0; count = managerData.count || 0; }
                        } else {
                            const purposeData = data.byPurpose?.[purposeFilter];
                            const managerData = data.byManager?.[managerFilter];
                            if (purposeData && managerData) {
                                sales = Math.min(purposeData.sales || 0, managerData.sales || 0);
                                count = Math.min(purposeData.count || 0, managerData.count || 0);
                            }
                        }
                        if (count > 0) {
                            totalSales += sales;
                            totalCount += count;
                            monthCount++;
                        }
                    }
                }
            }

            const avgCount = monthCount > 0 ? totalCount / monthCount : 0;
            const avgPrice = totalCount > 0 ? totalSales / totalCount : 0;

            // 전년도 요약 계산
            const compMonthly = compareData?.by_month || [];
            const compMonthMapSummary = Object.fromEntries(compMonthly);
            let compTotalCountSummary = 0, compTotalSalesSummary = 0, compMonthCountSummary = 0;

            if (purposeFilter === '전체' && managerFilter === '전체') {
                for (let m = 1; m <= 12; m++) {
                    const cData = compMonthMapSummary[m];
                    if (cData && cData.count > 0) {
                        compTotalCountSummary += cData.count;
                        compTotalSalesSummary += cData.sales || 0;
                        compMonthCountSummary++;
                    }
                }
            } else {
                for (let m = 1; m <= 12; m++) {
                    const cData = compMonthMapSummary[m];
                    if (cData) {
                        let cCount = 0, cSales = 0;
                        if (purposeFilter !== '전체' && managerFilter === '전체') {
                            const pd = cData.byPurpose?.[purposeFilter];
                            if (pd) { cCount = pd.count || 0; cSales = pd.sales || 0; }
                        } else if (purposeFilter === '전체' && managerFilter !== '전체') {
                            const md = cData.byManager?.[managerFilter];
                            if (md) { cCount = md.count || 0; cSales = md.sales || 0; }
                        }
                        if (cCount > 0) {
                            compTotalCountSummary += cCount;
                            compTotalSalesSummary += cSales;
                            compMonthCountSummary++;
                        }
                    }
                }
            }

            const countGrowth = compTotalCountSummary > 0 ? ((totalCount - compTotalCountSummary) / compTotalCountSummary * 100) : 0;
            const growthColor = countGrowth >= 0 ? '#10b981' : '#ef4444';
            const growthSign = countGrowth >= 0 ? '+' : '';

            // 요약 정보 표시
            const summaryEl = document.getElementById('monthlyCountSummary');
            if (summaryEl) {
                let summaryHtml = `
                    <span style="white-space:nowrap;background:#dbeafe;padding:4px 10px;border-radius:4px;color:#1e40af;"><strong style="color:#60a5fa;">${currentData.year}년:</strong> ${totalCount.toLocaleString()}건</span>
                `;
                if (compareData && compTotalCountSummary > 0) {
                    summaryHtml += `
                        <span style="white-space:nowrap;background:#fef3c7;padding:4px 10px;border-radius:4px;color:#92400e;"><strong style="color:#f59e0b;">${compareData.year}년:</strong> ${compTotalCountSummary.toLocaleString()}건</span>
                        <span style="white-space:nowrap;background:${countGrowth >= 0 ? '#d1fae5' : '#fee2e2'};padding:4px 10px;border-radius:4px;color:${growthColor};">증감: <strong>${growthSign}${countGrowth.toFixed(1)}%</strong></span>
                    `;
                }
                summaryHtml += `<span style="white-space:nowrap;background:#e0e7ff;padding:4px 10px;border-radius:4px;color:#3730a3;">매출: <strong>${formatCurrency(totalSales)}</strong></span>`;
                summaryHtml += `<span style="white-space:nowrap;background:#fce7f3;padding:4px 10px;border-radius:4px;color:#9d174d;">평균: <strong>${Math.round(avgCount).toLocaleString()}건</strong></span>`;
                summaryHtml += `<span style="white-space:nowrap;background:#fef08a;padding:4px 10px;border-radius:4px;color:#854d0e;">평균단가: <strong>${Math.round(avgPrice / 10000).toLocaleString()}만</strong></span>`;
                summaryEl.innerHTML = summaryHtml;
            }

            // 차트 업데이트
            updateMonthlyCountChart(purposeFilter, managerFilter);
        }

        // 월별 건수 차트
        function updateMonthlyCountChart(purposeFilter = '전체', managerFilter = '전체') {
            const monthly = currentData.by_month || [];
            const ctx = document.getElementById('monthlyCountChart').getContext('2d');
            if (charts.monthlyCount) charts.monthlyCount.destroy();

            const labels = ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'];
            const originalMonthMap = Object.fromEntries(monthly);
            const filteredMap = getFilteredMonthlyData(purposeFilter, managerFilter);
            const monthMap = (purposeFilter === '전체' && managerFilter === '전체') ? originalMonthMap : filteredMap;
            const data = labels.map((_, i) => monthMap[i+1]?.count || 0);
            const validMonths = data.filter(c => c > 0);
            const totalCount = data.reduce((s, v) => s + v, 0);
            const avgCount = validMonths.length > 0 ? totalCount / validMonths.length : 0;

            // 전년도 데이터 (동일한 필터 적용)
            const compMonthly = compareData?.by_month || [];
            const originalCompMap = Object.fromEntries(compMonthly);
            let compMap = originalCompMap;

            // 필터가 있으면 비교 데이터도 필터링
            if (purposeFilter !== '전체' || managerFilter !== '전체') {
                compMap = {};
                for (let m = 1; m <= 12; m++) {
                    const mData = originalCompMap[m];
                    if (mData) {
                        let count = 0;
                        if (purposeFilter !== '전체' && managerFilter === '전체') {
                            count = mData.byPurpose?.[purposeFilter]?.count || 0;
                        } else if (purposeFilter === '전체' && managerFilter !== '전체') {
                            count = mData.byManager?.[managerFilter]?.count || 0;
                        } else {
                            const pCount = mData.byPurpose?.[purposeFilter]?.count || 0;
                            const mCount = mData.byManager?.[managerFilter]?.count || 0;
                            count = Math.min(pCount, mCount);
                        }
                        compMap[m] = { count };
                    }
                }
            }

            const compData = labels.map((_, i) => compMap[i+1]?.count || 0);
            const compValidMonths = compData.filter(c => c > 0);
            const compTotalCount = compData.reduce((s, v) => s + v, 0);
            const compAvgCount = compValidMonths.length > 0 ? compTotalCount / compValidMonths.length : 0;

            // 트렌드 계산 함수
            const calcCountTrend = (monthIdx) => {
                if (monthIdx < 1) return { type: null, count: 0 };
                let cnt = 0, dir = null;
                for (let i = monthIdx; i >= 1; i--) {
                    const curr = data[i], prev = data[i - 1];
                    if (prev === 0) break;
                    const isUp = curr >= prev;
                    if (dir === null) { dir = isUp ? 'up' : 'down'; cnt = 1; }
                    else if ((dir === 'up' && isUp) || (dir === 'down' && !isUp)) { cnt++; }
                    else break;
                }
                return { type: dir, count: cnt };
            };

            // 외부 툴팁 생성
            const getOrCreateCountTooltip = (chart) => {
                let el = document.getElementById('monthlyCountTooltip');
                if (!el) {
                    el = document.createElement('div');
                    el.id = 'monthlyCountTooltip';
                    el.style.cssText = 'position:fixed;background:rgba(30,41,59,0.98);border-radius:12px;padding:16px;pointer-events:auto;z-index:99999;font-size:13px;color:#e2e8f0;box-shadow:0 20px 40px rgba(0,0,0,0.4);min-width:320px;max-width:380px;max-height:85vh;overflow-y:auto;transition:opacity 0.15s ease;line-height:1.5;';
                    document.body.appendChild(el); setupTooltipHover(el);
                }
                return el;
            };

            // 데이터셋 구성
            const datasets = [
                {
                    label: `${currentData.year}년 건수`,
                    data,
                    backgroundColor: 'rgba(34, 197, 94, 0.7)',
                    borderRadius: 6,
                    order: 2
                }
            ];

            // 비교 연도 라인 추가
            if (compareData && compValidMonths.length > 0) {
                datasets.push({
                    label: `${compareData.year}년 건수`,
                    data: compData.map(v => v > 0 ? v : null),
                    type: 'line',
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    borderWidth: 2,
                    pointRadius: 4,
                    pointBackgroundColor: '#f59e0b',
                    fill: false,
                    tension: 0.3,
                    order: 1
                });
            }

            charts.monthlyCount = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: true },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: false,
                            external: function(context) {
                                const tooltipEl = getOrCreateCountTooltip(context.chart);
                                if (context.tooltip.opacity === 0 && !isTooltipHovered(tooltipEl)) { hideTooltipWithDelay(tooltipEl); return; }

                                const idx = context.tooltip.dataPoints?.[0]?.dataIndex;
                                if (idx === undefined) return;

                                const count = data[idx];
                                const compCount = compData[idx];
                                const monthData = monthMap[idx + 1] || {};
                                const compMonthData = compMap[idx + 1] || {};
                                const vsAvg = avgCount > 0 ? ((count - avgCount) / avgCount * 100) : 0;
                                const vsAvgColor = vsAvg >= 0 ? '#10b981' : '#ef4444';
                                const isIncrease = count >= avgCount;

                                // 시즌 판단
                                let seasonTag = '평시', seasonIcon = '📊', seasonColor = '#94a3b8';
                                if (count > avgCount * 1.15) { seasonTag = '성수기'; seasonIcon = '🔥'; seasonColor = '#ef4444'; }
                                else if (count < avgCount * 0.85) { seasonTag = '비수기'; seasonIcon = '❄️'; seasonColor = '#3b82f6'; }

                                const borderColor = isIncrease ? 'rgba(34, 197, 94, 0.8)' : 'rgba(239, 68, 68, 0.8)';
                                tooltipEl.style.border = `2px solid ${borderColor}`;

                                // 1. 헤더
                                const headerBg = isIncrease ? 'rgba(34, 197, 94, 0.3)' : 'rgba(239, 68, 68, 0.3)';
                                let html = `<div style="display:flex;justify-content:space-between;align-items:center;margin:-16px -16px 12px -16px;padding:12px 16px;background:${headerBg};border-radius:10px 10px 0 0;">
                                    <span style="font-size:16px;font-weight:bold;color:#fff;">📅 ${labels[idx]}</span>
                                    <span style="background:${seasonColor}22;color:${seasonColor};padding:4px 10px;border-radius:6px;font-size:12px;">${seasonIcon} ${seasonTag}</span>
                                </div>`;

                                // 2. 기본 지표 - 양쪽 연도 표시
                                html += `<div style="background:rgba(255,255,255,0.05);padding:10px;border-radius:8px;margin-bottom:10px;">`;
                                html += `<div style="color:#60a5fa;font-weight:600;margin-bottom:6px;border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:4px;">📅 ${currentData.year}년</div>`;
                                html += `<div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>📋 건수</span><strong style="font-size:15px;">${count.toLocaleString()}건</strong></div>`;
                                if (monthData.sales) {
                                    const avgPrice = count > 0 ? monthData.sales / count : 0;
                                    html += `<div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>💰 매출액</span><strong>${formatCurrency(monthData.sales)}</strong></div>`;
                                    html += `<div style="display:flex;justify-content:space-between;"><span>💵 건당 단가</span><strong>${formatCurrency(Math.round(avgPrice))}</strong></div>`;
                                }
                                html += `</div>`;

                                // 전년도 기본 지표
                                if (compareData && compCount > 0) {
                                    html += `<div style="background:rgba(249,115,22,0.1);padding:10px;border-radius:8px;margin-bottom:10px;">`;
                                    html += `<div style="color:#f59e0b;font-weight:600;margin-bottom:6px;border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:4px;">📅 ${compareData.year}년</div>`;
                                    html += `<div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>📋 건수</span><strong style="font-size:15px;">${compCount.toLocaleString()}건</strong></div>`;
                                    if (compMonthData.sales) {
                                        const compAvgPrice = compCount > 0 ? compMonthData.sales / compCount : 0;
                                        html += `<div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>💰 매출액</span><strong>${formatCurrency(compMonthData.sales)}</strong></div>`;
                                        html += `<div style="display:flex;justify-content:space-between;"><span>💵 건당 단가</span><strong>${formatCurrency(Math.round(compAvgPrice))}</strong></div>`;
                                    }
                                    html += `</div>`;
                                }

                                // 3. 비교 분석
                                html += `<div style="color:#94a3b8;margin:12px 0 8px;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.2);">── 비교 분석 ──</div>`;

                                // 월평균 대비
                                html += `<div style="margin-bottom:4px;">📊 월평균 대비: <span style="color:${vsAvgColor};font-weight:bold;">${vsAvg >= 0 ? '+' : ''}${vsAvg.toFixed(1)}%</span> <span style="color:#94a3b8;">(${Math.round(count - avgCount).toLocaleString()}건)</span></div>`;

                                // 전년 동월 대비
                                if (compareData && compCount > 0) {
                                    const yoyDiff = count - compCount;
                                    const yoyPct = (yoyDiff / compCount * 100);
                                    const yoyColor = yoyDiff >= 0 ? '#10b981' : '#ef4444';
                                    html += `<div style="margin-bottom:4px;">📆 전년 동월 대비: <span style="color:${yoyColor};font-weight:bold;">${yoyDiff >= 0 ? '+' : ''}${yoyPct.toFixed(1)}%</span> <span style="color:#94a3b8;">(${yoyDiff >= 0 ? '+' : ''}${yoyDiff.toLocaleString()}건)</span></div>`;
                                }

                                // 전월 대비
                                if (idx > 0 && data[idx - 1] > 0) {
                                    const prevCount = data[idx - 1];
                                    const momDiff = count - prevCount;
                                    const momPct = (momDiff / prevCount * 100);
                                    const momColor = momDiff >= 0 ? '#10b981' : '#ef4444';

                                    // 트렌드
                                    const trend = calcCountTrend(idx);
                                    let trendText = '';
                                    if (trend.count >= 2) {
                                        const trendIcon = trend.type === 'up' ? '↗' : '↘';
                                        const trendColor = trend.type === 'up' ? '#10b981' : '#ef4444';
                                        trendText = ` <span style="color:${trendColor};">${trendIcon} ${trend.count}개월 연속${trend.type === 'up' ? '↑' : '↓'}</span>`;
                                    }
                                    html += `<div style="margin-bottom:8px;">📈 전월 대비: <span style="color:${momColor};font-weight:bold;">${momDiff >= 0 ? '+' : ''}${momPct.toFixed(1)}%</span>${trendText}</div>`;
                                }

                                // 4. 검사목적별 건수 분포
                                if (monthData.byPurpose) {
                                    const purposeBreakdown = Object.entries(monthData.byPurpose)
                                        .map(([purpose, d]) => ({
                                            purpose,
                                            count: d.count || 0,
                                            share: count > 0 ? ((d.count || 0) / count * 100) : 0,
                                            compCount: compMonthData.byPurpose?.[purpose]?.count || 0
                                        }))
                                        .sort((a, b) => b.count - a.count)
                                        .slice(0, 5);

                                    if (purposeBreakdown.length > 0) {
                                        html += `<div style="color:#94a3b8;margin:12px 0 8px;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.2);">── 검사목적별 건수 TOP 5 ──</div>`;
                                        purposeBreakdown.forEach((p, i) => {
                                            const yoyChange = p.compCount > 0 ? ((p.count - p.compCount) / p.compCount * 100) : 0;
                                            const yoyColor = yoyChange >= 0 ? '#10b981' : '#ef4444';
                                            const rankEmoji = i === 0 ? '🥇' : (i === 1 ? '🥈' : (i === 2 ? '🥉' : '•'));
                                            html += `<div style="margin-left:8px;margin-bottom:3px;">
                                                ${rankEmoji} <strong>${p.purpose}</strong>: ${p.count.toLocaleString()}건
                                                <span style="color:#94a3b8;">(${p.share.toFixed(0)}%)</span>
                                                ${p.compCount > 0 ? `<span style="color:${yoyColor};font-size:11px;"> YoY ${yoyChange >= 0 ? '+' : ''}${yoyChange.toFixed(0)}%</span>` : ''}
                                            </div>`;
                                        });
                                    }
                                }

                                // 5. 담당자별 건수 분포
                                if (monthData.byManager) {
                                    const managerBreakdown = Object.entries(monthData.byManager)
                                        .map(([manager, d]) => ({
                                            manager,
                                            count: d.count || 0,
                                            share: count > 0 ? ((d.count || 0) / count * 100) : 0
                                        }))
                                        .sort((a, b) => b.count - a.count)
                                        .slice(0, 3);

                                    if (managerBreakdown.length > 0) {
                                        html += `<div style="color:#94a3b8;margin:12px 0 8px;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.2);">── 담당자별 건수 TOP 3 ──</div>`;
                                        managerBreakdown.forEach(m => {
                                            html += `<div style="margin-left:8px;margin-bottom:3px;">• ${m.manager}: ${m.count.toLocaleString()}건 <span style="color:#94a3b8;">(${m.share.toFixed(0)}%)</span></div>`;
                                        });
                                    }
                                }

                                // 6. 계절성 패턴 분석
                                if (compareData && compCount > 0 && compAvgCount > 0) {
                                    const currBelowAvg = count < avgCount;
                                    const compBelowAvg = compCount < compAvgCount;

                                    html += `<div style="color:#94a3b8;margin:12px 0 8px;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.2);">── 계절성 분석 ──</div>`;
                                    if (currBelowAvg && compBelowAvg) {
                                        html += `<div style="color:#f59e0b;">🔄 <strong>2년 연속 비수기</strong> - 계절적 패턴</div>`;
                                    } else if (currBelowAvg && !compBelowAvg) {
                                        html += `<div style="color:#ef4444;">⚠️ <strong>이례적 감소</strong> - 전년도는 정상 수준</div>`;
                                    } else if (!currBelowAvg && compBelowAvg) {
                                        html += `<div style="color:#10b981;">✨ <strong>비수기 극복</strong> - 전년도 대비 개선</div>`;
                                    } else {
                                        html += `<div style="color:#60a5fa;">✓ <strong>안정적 성수기</strong> - 2년 연속 평균 이상</div>`;
                                    }
                                }

                                // 7. YTD 건수 누적
                                const ytdCount = data.slice(0, idx + 1).reduce((s, c) => s + c, 0);
                                const ytdCompCount = compData.slice(0, idx + 1).reduce((s, c) => s + c, 0);
                                html += `<div style="color:#94a3b8;margin:12px 0 8px;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.2);">── YTD 누적 ──</div>`;
                                html += `<div>📊 1~${idx + 1}월 누적: <strong>${ytdCount.toLocaleString()}건</strong>`;
                                if (ytdCompCount > 0) {
                                    const ytdDiff = ytdCount - ytdCompCount;
                                    const ytdPct = (ytdDiff / ytdCompCount * 100);
                                    const ytdColor = ytdDiff >= 0 ? '#10b981' : '#ef4444';
                                    html += ` <span style="color:${ytdColor};">(전년 대비 ${ytdDiff >= 0 ? '+' : ''}${ytdPct.toFixed(1)}%)</span>`;
                                }
                                html += `</div>`;

                                tooltipEl.innerHTML = html;
                                tooltipEl.style.opacity = 1; tooltipEl.style.pointerEvents = 'auto';

                                // 위치 계산 - 데이터 포인트 위쪽에 표시
                                const pos = context.chart.canvas.getBoundingClientRect();
                                const tooltipHeight = tooltipEl.offsetHeight || 500;
                                const tooltipWidth = tooltipEl.offsetWidth || 400;

                                let left = pos.left + context.tooltip.caretX + 15;
                                let top = pos.top + context.tooltip.caretY - tooltipHeight - 20;

                                // 오른쪽 화면 벗어나면 왼쪽에 표시
                                if (left + tooltipWidth > window.innerWidth - 20) {
                                    left = pos.left + context.tooltip.caretX - tooltipWidth - 15;
                                }
                                // 위쪽 화면 벗어나면 아래쪽에 표시
                                if (top < 10) {
                                    top = pos.top + context.tooltip.caretY + 20;
                                }

                                tooltipEl.style.left = left + 'px';
                                tooltipEl.style.top = top + 'px';
                            }
                        }
                    },
                    scales: { y: { beginAtZero: true }, x: { grid: { display: false } } }
                }
            });
        }

        // 월별 성장률 추이 차트 - 검사목적 필터 초기화
        function initGrowthPurposeFilter() {
            const select = document.getElementById('growthPurposeFilter');
            if (!select) return;

            const purposes = currentData.by_purpose || [];
            const currentValue = select.value;

            select.innerHTML = '<option value="전체">전체 목적</option>';
            purposes.forEach(p => {
                if (p[0] !== '접수취소') {
                    select.innerHTML += `<option value="${p[0]}">${p[0]}</option>`;
                }
            });

            // 이전 선택값 복원
            if (currentValue && Array.from(select.options).some(o => o.value === currentValue)) {
                select.value = currentValue;
            }
        }

        // 월별 성장률 추이 차트
        function updateGrowthTrendChart() {
            const monthly = currentData.by_month || [];
            const originalMonthMap = Object.fromEntries(monthly);
            const compMonthly = compareData?.by_month || [];
            const originalCompMap = Object.fromEntries(compMonthly);
            const hasCompare = compareData && compMonthly.length > 0;

            const ctx = document.getElementById('growthTrendChart');
            if (!ctx) return;

            // 차트와 범례 표시 여부
            const cardEl = document.getElementById('growthTrendCard');
            if (!hasCompare) {
                if (cardEl) cardEl.style.display = 'none';
                return;
            }
            if (cardEl) cardEl.style.display = '';

            // 검사목적 필터
            const purposeFilter = document.getElementById('growthPurposeFilter')?.value || '전체';

            // 필터 적용된 데이터 생성
            let monthMap = originalMonthMap;
            let compMap = originalCompMap;

            if (purposeFilter !== '전체') {
                monthMap = {};
                compMap = {};
                for (let m = 1; m <= 12; m++) {
                    const data = originalMonthMap[m];
                    if (data && data.byPurpose && data.byPurpose[purposeFilter]) {
                        const pd = data.byPurpose[purposeFilter];
                        monthMap[m] = { sales: pd.sales || 0, count: pd.count || 0 };
                    } else {
                        monthMap[m] = { sales: 0, count: 0 };
                    }

                    const compData = originalCompMap[m];
                    if (compData && compData.byPurpose && compData.byPurpose[purposeFilter]) {
                        const cpd = compData.byPurpose[purposeFilter];
                        compMap[m] = { sales: cpd.sales || 0, count: cpd.count || 0 };
                    } else {
                        compMap[m] = { sales: 0, count: 0 };
                    }
                }
            }

            if (charts.growthTrend) charts.growthTrend.destroy();

            const labels = ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'];
            const metric = document.getElementById('growthMetricSelect')?.value || 'sales';

            // 성장률 계산 및 실제 데이터
            const salesGrowth = [];
            const countGrowth = [];
            const currSalesData = [];
            const compSalesData = [];
            const currCountData = [];
            const compCountData = [];

            for (let m = 1; m <= 12; m++) {
                const curr = monthMap[m] || { sales: 0, count: 0 };
                const comp = compMap[m] || { sales: 0, count: 0 };

                currSalesData.push(curr.sales > 0 ? curr.sales : null);
                compSalesData.push(comp.sales > 0 ? comp.sales : null);
                currCountData.push(curr.count > 0 ? curr.count : null);
                compCountData.push(comp.count > 0 ? comp.count : null);

                if (comp.sales > 0 && curr.sales > 0) {
                    salesGrowth.push(((curr.sales - comp.sales) / comp.sales) * 100);
                } else {
                    salesGrowth.push(null);
                }

                if (comp.count > 0 && curr.count > 0) {
                    countGrowth.push(((curr.count - comp.count) / comp.count) * 100);
                } else {
                    countGrowth.push(null);
                }
            }

            // 요약 정보 표시
            const summaryEl = document.getElementById('growthTrendSummary');
            if (summaryEl) {
                const validCurr = currSalesData.filter(v => v !== null);
                const validComp = compSalesData.filter(v => v !== null);
                const totalCurr = validCurr.reduce((s, v) => s + v, 0);
                const totalComp = validComp.reduce((s, v) => s + v, 0);
                const totalGrowth = totalComp > 0 ? ((totalCurr - totalComp) / totalComp * 100) : 0;
                const growthColor = totalGrowth >= 0 ? '#10b981' : '#ef4444';
                const avgCurr = validCurr.length > 0 ? totalCurr / validCurr.length : 0;

                let html = `<span style="white-space:nowrap;background:#dbeafe;padding:4px 10px;border-radius:4px;color:#1e40af;"><strong style="color:#3b82f6;">${currentData.year}년:</strong> ${(totalCurr / 100000000).toFixed(1)}억</span>`;
                html += `<span style="white-space:nowrap;background:#fef3c7;padding:4px 10px;border-radius:4px;color:#92400e;"><strong style="color:#f59e0b;">${compareData.year}년:</strong> ${(totalComp / 100000000).toFixed(1)}억</span>`;
                html += `<span style="white-space:nowrap;background:${totalGrowth >= 0 ? '#d1fae5' : '#fee2e2'};padding:4px 10px;border-radius:4px;color:${growthColor};">성장률: <strong>${totalGrowth >= 0 ? '+' : ''}${totalGrowth.toFixed(1)}%</strong></span>`;
                html += `<span style="white-space:nowrap;background:#fce7f3;padding:4px 10px;border-radius:4px;color:#9d174d;">평균: <strong>${(avgCurr / 100000000).toFixed(2)}억</strong></span>`;
                summaryEl.innerHTML = html;
            }

            // 평균 성장률 계산
            const validSalesGrowth = salesGrowth.filter(v => v !== null);
            const avgSalesGrowth = validSalesGrowth.length > 0 ? validSalesGrowth.reduce((s, v) => s + v, 0) / validSalesGrowth.length : 0;
            const validCountGrowth = countGrowth.filter(v => v !== null);
            const avgCountGrowth = validCountGrowth.length > 0 ? validCountGrowth.reduce((s, v) => s + v, 0) / validCountGrowth.length : 0;

            // 막대 색상 - 양수/음수에 따라 구분
            const salesColors = salesGrowth.map(v => v === null ? 'rgba(148,163,184,0.5)' : (v >= 0 ? 'rgba(16, 185, 129, 0.7)' : 'rgba(239, 68, 68, 0.7)'));
            const countColors = countGrowth.map(v => v === null ? 'rgba(148,163,184,0.5)' : (v >= 0 ? 'rgba(59, 130, 246, 0.7)' : 'rgba(249, 115, 22, 0.7)'));

            const datasets = [];

            if (metric === 'sales' || metric === 'both') {
                // 성장률 막대
                datasets.push({
                    label: '성장률 (%)',
                    data: salesGrowth,
                    backgroundColor: salesColors,
                    borderRadius: 4,
                    order: 3,
                    yAxisID: 'y'
                });

                // 2025년 매출 라인
                datasets.push({
                    label: `${currentData.year}년 매출`,
                    data: currSalesData,
                    type: 'line',
                    borderColor: '#60a5fa',
                    backgroundColor: 'rgba(96,165,250,0.1)',
                    borderWidth: 2,
                    pointRadius: 4,
                    pointBackgroundColor: '#60a5fa',
                    fill: false,
                    order: 1,
                    yAxisID: 'y1',
                    tension: 0.3
                });

                // 2024년 매출 라인
                datasets.push({
                    label: `${compareData.year}년 매출`,
                    data: compSalesData,
                    type: 'line',
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245,158,11,0.1)',
                    borderWidth: 2,
                    pointRadius: 4,
                    pointBackgroundColor: '#f59e0b',
                    fill: false,
                    order: 2,
                    yAxisID: 'y1',
                    tension: 0.3
                });

                // 평균 성장률 라인
                datasets.push({
                    label: '평균 성장률',
                    data: Array(12).fill(avgSalesGrowth),
                    type: 'line',
                    borderColor: '#94a3b8',
                    borderWidth: 1,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false,
                    order: 4,
                    yAxisID: 'y'
                });
            }

            if (metric === 'count' || metric === 'both') {
                datasets.push({
                    label: '건수 성장률 (%)',
                    data: countGrowth,
                    backgroundColor: countColors,
                    borderRadius: 4,
                    order: 3,
                    yAxisID: 'y'
                });

                if (metric === 'count') {
                    // 2025년 건수 라인
                    datasets.push({
                        label: `${currentData.year}년 건수`,
                        data: currCountData,
                        type: 'line',
                        borderColor: '#60a5fa',
                        borderWidth: 2,
                        pointRadius: 4,
                        pointBackgroundColor: '#60a5fa',
                        fill: false,
                        order: 1,
                        yAxisID: 'y1',
                        tension: 0.3
                    });

                    // 2024년 건수 라인
                    datasets.push({
                        label: `${compareData.year}년 건수`,
                        data: compCountData,
                        type: 'line',
                        borderColor: '#f59e0b',
                        borderWidth: 2,
                        pointRadius: 4,
                        pointBackgroundColor: '#f59e0b',
                        fill: false,
                        order: 2,
                        yAxisID: 'y1',
                        tension: 0.3
                    });

                    datasets.push({
                        label: '평균 건수 성장률',
                        data: Array(12).fill(avgCountGrowth),
                        type: 'line',
                        borderColor: '#94a3b8',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false,
                        order: 4,
                        yAxisID: 'y'
                    });
                }
            }

            // 범례 업데이트
            const legendEl = document.getElementById('growthTrendLegend');
            if (metric === 'sales') {
                legendEl.innerHTML = `
                    <span style="color: #10b981;">■ 성장 (0% 초과)</span>
                    <span style="color: #ef4444;">■ 역성장 (0% 미만)</span>
                    <span style="color: #60a5fa;">─● ${currentData.year}년</span>
                    <span style="color: #f59e0b;">─● ${compareData.year}년</span>
                    <span style="color: #94a3b8;">--- 평균 ${avgSalesGrowth.toFixed(1)}%</span>
                `;
            } else if (metric === 'count') {
                legendEl.innerHTML = `
                    <span style="color: #3b82f6;">■ 성장 (0% 초과)</span>
                    <span style="color: #f97316;">■ 역성장 (0% 미만)</span>
                    <span style="color: #60a5fa;">─● ${currentData.year}년</span>
                    <span style="color: #f59e0b;">─● ${compareData.year}년</span>
                    <span style="color: #94a3b8;">--- 평균 ${avgCountGrowth.toFixed(1)}%</span>
                `;
            } else {
                legendEl.innerHTML = `
                    <span style="color: #10b981;">■ 매출 성장</span>
                    <span style="color: #ef4444;">■ 매출 역성장</span>
                    <span style="color: #3b82f6;">● 건수 성장</span>
                    <span style="color: #f97316;">● 건수 역성장</span>
                `;
            }

            // 외부 툴팁
            const getOrCreateGrowthTooltip = (chart) => {
                let el = document.getElementById('growthTrendTooltip');
                if (!el) {
                    el = document.createElement('div');
                    el.id = 'growthTrendTooltip';
                    el.style.cssText = 'position:fixed;background:rgba(30,41,59,0.98);border-radius:12px;padding:16px;pointer-events:auto;z-index:99999;font-size:13px;color:#e2e8f0;box-shadow:0 20px 40px rgba(0,0,0,0.4);min-width:260px;max-width:320px;transition:opacity 0.15s ease;line-height:1.5;';
                    document.body.appendChild(el); setupTooltipHover(el);
                }
                return el;
            };

            charts.growthTrend = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: false,
                            external: function(context) {
                                const tooltipEl = getOrCreateGrowthTooltip(context.chart);
                                if (context.tooltip.opacity === 0 && !isTooltipHovered(tooltipEl)) { hideTooltipWithDelay(tooltipEl); return; }

                                const idx = context.tooltip.dataPoints?.[0]?.dataIndex;
                                if (idx === undefined) return;

                                const m = idx + 1;
                                const curr = monthMap[m] || { sales: 0, count: 0 };
                                const comp = compMap[m] || { sales: 0, count: 0 };

                                // 원본 데이터에서 검사목적별 정보 가져오기
                                const origCurr = originalMonthMap[m] || {};
                                const origComp = originalCompMap[m] || {};
                                const currByPurpose = origCurr.byPurpose || {};
                                const compByPurpose = origComp.byPurpose || {};

                                let html = `<div style="font-size:16px;font-weight:bold;margin-bottom:12px;">📅 ${labels[idx]} 전년 대비</div>`;

                                // 매출 성장률
                                if (comp.sales > 0 && curr.sales > 0) {
                                    const salesPct = ((curr.sales - comp.sales) / comp.sales) * 100;
                                    const salesDiff = curr.sales - comp.sales;
                                    const salesColor = salesPct >= 0 ? '#10b981' : '#ef4444';
                                    html += `<div style="margin-bottom:8px;padding:8px;background:rgba(255,255,255,0.05);border-radius:6px;">
                                        <div style="margin-bottom:4px;">💰 <strong>매출 성장률</strong></div>
                                        <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                                            <span style="color:#94a3b8;">${compareData.year}년:</span>
                                            <span>${formatCurrency(comp.sales)}</span>
                                        </div>
                                        <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                                            <span style="color:#94a3b8;">${currentData.year}년:</span>
                                            <span>${formatCurrency(curr.sales)}</span>
                                        </div>
                                        <div style="display:flex;justify-content:space-between;">
                                            <span style="color:#94a3b8;">성장률:</span>
                                            <span style="color:${salesColor};font-weight:bold;">${salesPct >= 0 ? '+' : ''}${salesPct.toFixed(1)}% (${salesDiff >= 0 ? '+' : ''}${(salesDiff/10000).toFixed(0)}만)</span>
                                        </div>
                                    </div>`;

                                    // 검사목적별 기여도 분석
                                    const purposeChanges = [];
                                    const allPurposes = new Set([...Object.keys(currByPurpose), ...Object.keys(compByPurpose)]);
                                    allPurposes.forEach(purpose => {
                                        if (purpose === '접수취소') return;
                                        const currP = currByPurpose[purpose]?.sales || 0;
                                        const compP = compByPurpose[purpose]?.sales || 0;
                                        const diff = currP - compP;
                                        const pct = compP > 0 ? ((currP - compP) / compP * 100) : (currP > 0 ? 100 : 0);
                                        if (diff !== 0) {
                                            purposeChanges.push({ purpose, diff, pct, currP, compP });
                                        }
                                    });

                                    // 기여도 순으로 정렬
                                    purposeChanges.sort((a, b) => b.diff - a.diff);

                                    if (purposeChanges.length > 0) {
                                        const isGrowth = salesDiff >= 0;
                                        const topContributors = isGrowth ? purposeChanges.filter(p => p.diff > 0).slice(0, 3) : [];
                                        const topDecliners = !isGrowth ? purposeChanges.filter(p => p.diff < 0).slice(0, 3) : [];

                                        if (isGrowth && topContributors.length > 0) {
                                            html += `<div style="margin-bottom:8px;padding:8px;background:rgba(16,185,129,0.1);border-radius:6px;border-left:3px solid #10b981;">
                                                <div style="margin-bottom:6px;color:#10b981;font-weight:600;">📈 상승 주요 원인</div>`;
                                            topContributors.forEach((p, i) => {
                                                const icon = i === 0 ? '🥇' : (i === 1 ? '🥈' : '🥉');
                                                html += `<div style="display:flex;justify-content:space-between;margin-bottom:3px;font-size:12px;">
                                                    <span>${icon} ${p.purpose}</span>
                                                    <span style="color:#10b981;">+${(p.diff/10000).toFixed(0)}만 (+${p.pct.toFixed(0)}%)</span>
                                                </div>`;
                                            });
                                            html += `</div>`;
                                        } else if (!isGrowth && topDecliners.length > 0) {
                                            html += `<div style="margin-bottom:8px;padding:8px;background:rgba(239,68,68,0.1);border-radius:6px;border-left:3px solid #ef4444;">
                                                <div style="margin-bottom:6px;color:#ef4444;font-weight:600;">📉 하락 주요 원인</div>`;
                                            topDecliners.forEach((p, i) => {
                                                const icon = i === 0 ? '⚠️' : (i === 1 ? '🔻' : '▼');
                                                html += `<div style="display:flex;justify-content:space-between;margin-bottom:3px;font-size:12px;">
                                                    <span>${icon} ${p.purpose}</span>
                                                    <span style="color:#ef4444;">${(p.diff/10000).toFixed(0)}만 (${p.pct.toFixed(0)}%)</span>
                                                </div>`;
                                            });
                                            html += `</div>`;
                                        }

                                        // 반대 요인도 표시 (성장 시 하락 요인, 하락 시 상승 요인)
                                        if (isGrowth && purposeChanges.filter(p => p.diff < 0).length > 0) {
                                            const decliners = purposeChanges.filter(p => p.diff < 0).slice(0, 2);
                                            html += `<div style="padding:6px 8px;background:rgba(239,68,68,0.05);border-radius:4px;font-size:11px;color:#94a3b8;">
                                                <span style="color:#f59e0b;">⚠️ 하락 요인:</span> `;
                                            html += decliners.map(p => `${p.purpose}(${(p.diff/10000).toFixed(0)}만)`).join(', ');
                                            html += `</div>`;
                                        } else if (!isGrowth && purposeChanges.filter(p => p.diff > 0).length > 0) {
                                            const growers = purposeChanges.filter(p => p.diff > 0).slice(0, 2);
                                            html += `<div style="padding:6px 8px;background:rgba(16,185,129,0.05);border-radius:4px;font-size:11px;color:#94a3b8;">
                                                <span style="color:#10b981;">💡 상승 요인:</span> `;
                                            html += growers.map(p => `${p.purpose}(+${(p.diff/10000).toFixed(0)}만)`).join(', ');
                                            html += `</div>`;
                                        }
                                    }
                                }

                                // 건수 성장률
                                if (comp.count > 0 && curr.count > 0) {
                                    const countPct = ((curr.count - comp.count) / comp.count) * 100;
                                    const countDiff = curr.count - comp.count;
                                    const countColor = countPct >= 0 ? '#3b82f6' : '#f97316';
                                    html += `<div style="margin-top:8px;padding:8px;background:rgba(255,255,255,0.05);border-radius:6px;">
                                        <div style="margin-bottom:4px;">📋 <strong>건수 성장률</strong></div>
                                        <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                                            <span style="color:#94a3b8;">${compareData.year}년:</span>
                                            <span>${comp.count.toLocaleString()}건</span>
                                        </div>
                                        <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                                            <span style="color:#94a3b8;">${currentData.year}년:</span>
                                            <span>${curr.count.toLocaleString()}건</span>
                                        </div>
                                        <div style="display:flex;justify-content:space-between;">
                                            <span style="color:#94a3b8;">성장률:</span>
                                            <span style="color:${countColor};font-weight:bold;">${countPct >= 0 ? '+' : ''}${countPct.toFixed(1)}% (${countDiff >= 0 ? '+' : ''}${countDiff.toLocaleString()}건)</span>
                                        </div>
                                    </div>`;
                                }

                                tooltipEl.innerHTML = html;
                                tooltipEl.style.opacity = 1; tooltipEl.style.pointerEvents = 'auto';
                                const pos = context.chart.canvas.getBoundingClientRect();
                                tooltipEl.style.left = Math.min(pos.left + context.tooltip.caretX + 10, window.innerWidth - 340) + 'px';
                                tooltipEl.style.top = Math.min(pos.top + context.tooltip.caretY, window.innerHeight - 300) + 'px';
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            beginAtZero: false,
                            grid: { color: 'rgba(148, 163, 184, 0.1)' },
                            ticks: {
                                callback: function(value) { return value.toFixed(0) + '%'; }
                            },
                            title: {
                                display: true,
                                text: '성장률 (%)',
                                color: '#94a3b8',
                                font: { size: 11 }
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            beginAtZero: true,
                            grid: { display: false },
                            ticks: {
                                callback: function(value) { return formatCurrency(value); }
                            },
                            title: {
                                display: true,
                                text: metric === 'count' ? '건수' : '매출',
                                color: '#94a3b8',
                                font: { size: 11 }
                            }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // 분기별 차트
        function updateQuarterlyChart() {
            const monthly = currentData.by_month || [];
            const ctx = document.getElementById('quarterlyChart').getContext('2d');
            if (charts.quarterly) charts.quarterly.destroy();

            const monthMap = Object.fromEntries(monthly);
            const quarters = [0, 0, 0, 0];
            const quarterCounts = [0, 0, 0, 0];
            for (let m = 1; m <= 12; m++) {
                const q = Math.floor((m - 1) / 3);
                quarters[q] += monthMap[m]?.sales || 0;
                quarterCounts[q] += monthMap[m]?.count || 0;
            }
            const totalSales = quarters.reduce((s, v) => s + v, 0);
            const avgQuarter = totalSales / 4;

            // 다중 비교 연도 분기 데이터
            const compQuartersList = [];
            if (compareDataList && compareDataList.length > 0) {
                compareDataList.forEach((compData) => {
                    const compMonthly = compData.by_month || [];
                    const compMap = Object.fromEntries(compMonthly);
                    const compQuarters = [0, 0, 0, 0];
                    const compQuarterCounts = [0, 0, 0, 0];
                    for (let m = 1; m <= 12; m++) {
                        const q = Math.floor((m - 1) / 3);
                        compQuarters[q] += compMap[m]?.sales || 0;
                        compQuarterCounts[q] += compMap[m]?.count || 0;
                    }
                    compQuartersList.push({
                        year: compData.year,
                        quarters: compQuarters,
                        counts: compQuarterCounts,
                        total: compQuarters.reduce((s, v) => s + v, 0)
                    });
                });
            } else if (compareData) {
                // 하위 호환성
                const compMonthly = compareData.by_month || [];
                const compMap = Object.fromEntries(compMonthly);
                const compQuarters = [0, 0, 0, 0];
                const compQuarterCounts = [0, 0, 0, 0];
                for (let m = 1; m <= 12; m++) {
                    const q = Math.floor((m - 1) / 3);
                    compQuarters[q] += compMap[m]?.sales || 0;
                    compQuarterCounts[q] += compMap[m]?.count || 0;
                }
                compQuartersList.push({
                    year: compareData.year,
                    quarters: compQuarters,
                    counts: compQuarterCounts,
                    total: compQuarters.reduce((s, v) => s + v, 0)
                });
            }
            // 첫 번째 비교 연도 (하위 호환성)
            const compQuarters = compQuartersList[0]?.quarters || [0, 0, 0, 0];
            const compQuarterCounts = compQuartersList[0]?.counts || [0, 0, 0, 0];
            const compTotalSales = compQuartersList[0]?.total || 0;

            // 외부 툴팁
            const getOrCreateQuarterlyTooltip = (chart) => {
                let el = document.getElementById('quarterlyChartTooltip');
                if (!el) {
                    el = document.createElement('div');
                    el.id = 'quarterlyChartTooltip';
                    el.style.cssText = 'position:fixed;background:rgba(30,41,59,0.98);border-radius:12px;padding:16px;pointer-events:auto;z-index:99999;font-size:13px;color:#e2e8f0;box-shadow:0 20px 40px rgba(0,0,0,0.4);min-width:280px;max-width:350px;max-height:85vh;overflow-y:auto;transition:opacity 0.15s ease;line-height:1.5;';
                    document.body.appendChild(el); setupTooltipHover(el);
                }
                return el;
            };

            charts.quarterly = new Chart(ctx, {
                type: 'bar',
                data: { labels: ['1분기', '2분기', '3분기', '4분기'], datasets: [{ data: quarters, backgroundColor: ['#6366f1', '#8b5cf6', '#a855f7', '#d946ef'], borderRadius: 6 }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: true },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: false,
                            external: function(context) {
                                const tooltipEl = getOrCreateQuarterlyTooltip(context.chart);
                                if (context.tooltip.opacity === 0 && !isTooltipHovered(tooltipEl)) { hideTooltipWithDelay(tooltipEl); return; }

                                const idx = context.tooltip.dataPoints?.[0]?.dataIndex;
                                if (idx === undefined) return;

                                const sales = quarters[idx];
                                const count = quarterCounts[idx];
                                const compSales = compQuarters[idx];
                                const percent = totalSales > 0 ? (sales / totalSales * 100) : 0;
                                const avgPrice = count > 0 ? sales / count : 0;

                                // 순위 계산
                                const sorted = [...quarters].sort((a, b) => b - a);
                                const rank = sorted.indexOf(sales) + 1;
                                const rankIcon = rank === 1 ? '🏆' : rank === 2 ? '🥈' : rank === 3 ? '🥉' : '';

                                let html = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                                    <span style="font-size:16px;font-weight:bold;">${rankIcon} ${idx + 1}분기</span>
                                    <span style="background:rgba(255,255,255,0.2);padding:4px 10px;border-radius:6px;font-size:12px;">매출 ${rank}위</span>
                                </div>`;

                                // 현재 연도 데이터
                                html += `<div style="background:rgba(96,165,250,0.1);padding:10px;border-radius:8px;margin-bottom:10px;">`;
                                html += `<div style="color:#60a5fa;font-weight:600;margin-bottom:6px;border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:4px;">📅 ${currentData.year}년</div>`;
                                html += `<div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>💰 매출</span><strong>${formatCurrency(sales)}</strong></div>`;
                                html += `<div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>📋 건수</span><strong>${count.toLocaleString()}건</strong></div>`;
                                html += `<div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>📊 단가</span><strong>${formatCurrency(Math.round(avgPrice))}</strong></div>`;
                                html += `<div style="display:flex;justify-content:space-between;"><span>📈 비중</span><strong>${percent.toFixed(1)}%</strong></div>`;
                                html += `</div>`;

                                // 모든 비교 연도 데이터 표시
                                const compYearColors = ['#f59e0b', '#8b5cf6', '#10b981', '#ef4444'];
                                const compYearBgs = ['rgba(249,115,22,0.1)', 'rgba(139,92,246,0.1)', 'rgba(16,185,129,0.1)', 'rgba(239,68,68,0.1)'];

                                if (compQuartersList.length > 0) {
                                    compQuartersList.forEach((compYear, compIdx) => {
                                        const compSalesYear = compYear.quarters[idx];
                                        if (compSalesYear > 0) {
                                            const compCount = compYear.counts[idx];
                                            const compAvgPrice = compCount > 0 ? compSalesYear / compCount : 0;
                                            const colorIdx = compIdx % compYearColors.length;
                                            html += `<div style="background:${compYearBgs[colorIdx]};padding:10px;border-radius:8px;margin-bottom:10px;">`;
                                            html += `<div style="color:${compYearColors[colorIdx]};font-weight:600;margin-bottom:6px;border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:4px;">📅 ${compYear.year}년</div>`;
                                            html += `<div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>💰 매출</span><strong>${formatCurrency(compSalesYear)}</strong></div>`;
                                            if (compCount > 0) {
                                                html += `<div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>📋 건수</span><strong>${compCount.toLocaleString()}건</strong></div>`;
                                                html += `<div style="display:flex;justify-content:space-between;"><span>📊 단가</span><strong>${formatCurrency(Math.round(compAvgPrice))}</strong></div>`;
                                            }
                                            html += `</div>`;
                                        }
                                    });

                                    // 증감 비교 (모든 연도)
                                    html += `<div style="padding:8px;border-radius:6px;background:rgba(99,102,241,0.1);">`;
                                    compQuartersList.forEach((compYear, compIdx) => {
                                        const compSalesYear = compYear.quarters[idx];
                                        if (compSalesYear > 0) {
                                            const yoyDiff = ((sales - compSalesYear) / compSalesYear * 100);
                                            const yoyColor = yoyDiff >= 0 ? '#10b981' : '#ef4444';
                                            html += `<div style="margin-bottom:${compIdx < compQuartersList.length - 1 ? '4px' : '0'};">📆 ${compYear.year}년 대비: <span style="color:${yoyColor};font-weight:bold;">${yoyDiff >= 0 ? '+' : ''}${yoyDiff.toFixed(1)}%</span></div>`;
                                        }
                                    });
                                    html += `</div>`;
                                }

                                tooltipEl.innerHTML = html;
                                tooltipEl.style.opacity = 1; tooltipEl.style.pointerEvents = 'auto';
                                const pos = context.chart.canvas.getBoundingClientRect();
                                tooltipEl.style.left = Math.min(pos.left + context.tooltip.caretX + 10, window.innerWidth - 360) + 'px';
                                tooltipEl.style.top = Math.min(pos.top + context.tooltip.caretY, window.innerHeight - 300) + 'px';
                            }
                        }
                    },
                    scales: { y: { ticks: { callback: v => formatCurrency(v) } } }
                }
            });
        }

        // 월별 평균단가 차트
        function updateAvgPriceChart() {
            const monthly = currentData.by_month || [];
            const ctx = document.getElementById('monthlyAvgPriceChart').getContext('2d');
            if (charts.avgPrice) charts.avgPrice.destroy();

            const labels = ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'];
            const monthMap = Object.fromEntries(monthly);
            const data = labels.map((_, i) => {
                const m = monthMap[i+1];
                return m && m.count > 0 ? m.sales / m.count : 0;
            });
            const validData = data.filter(v => v > 0);
            const avgPrice = validData.length > 0 ? validData.reduce((s, v) => s + v, 0) / validData.length : 0;

            // 전년도 데이터
            const compMonthly = compareData?.by_month || [];
            const compMap = Object.fromEntries(compMonthly);
            const compData = labels.map((_, i) => {
                const m = compMap[i+1];
                return m && m.count > 0 ? m.sales / m.count : 0;
            });

            // 외부 툴팁
            const getOrCreateAvgPriceTooltip = (chart) => {
                let el = document.getElementById('avgPriceChartTooltip');
                if (!el) {
                    el = document.createElement('div');
                    el.id = 'avgPriceChartTooltip';
                    el.style.cssText = 'position:fixed;background:rgba(30,41,59,0.98);border-radius:12px;padding:16px;pointer-events:auto;z-index:99999;font-size:13px;color:#e2e8f0;box-shadow:0 20px 40px rgba(0,0,0,0.4);min-width:280px;max-width:350px;max-height:85vh;overflow-y:auto;transition:opacity 0.15s ease;line-height:1.5;';
                    document.body.appendChild(el); setupTooltipHover(el);
                }
                return el;
            };

            charts.avgPrice = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{ label: '평균단가', data, borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.1)', fill: true, tension: 0.4 }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: true },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: false,
                            external: function(context) {
                                const tooltipEl = getOrCreateAvgPriceTooltip(context.chart);
                                if (context.tooltip.opacity === 0 && !isTooltipHovered(tooltipEl)) { hideTooltipWithDelay(tooltipEl); return; }

                                const idx = context.tooltip.dataPoints?.[0]?.dataIndex;
                                if (idx === undefined) return;

                                const price = data[idx];
                                const compPrice = compData[idx];
                                const monthData = monthMap[idx + 1] || {};
                                const vsAvg = avgPrice > 0 ? ((price - avgPrice) / avgPrice * 100) : 0;
                                const vsAvgColor = vsAvg >= 0 ? '#10b981' : '#ef4444';

                                // 단가 수준 판단
                                let priceTag = '평균', priceIcon = '📊', priceColor = '#94a3b8';
                                if (price > avgPrice * 1.1) { priceTag = '고단가'; priceIcon = '💰'; priceColor = '#f59e0b'; }
                                else if (price < avgPrice * 0.9) { priceTag = '저단가'; priceIcon = '📉'; priceColor = '#3b82f6'; }

                                let html = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                                    <span style="font-size:16px;font-weight:bold;">${labels[idx]}</span>
                                    <span style="background:${priceColor}22;color:${priceColor};padding:4px 10px;border-radius:6px;font-size:12px;">${priceIcon} ${priceTag}</span>
                                </div>`;

                                html += `<div style="background:rgba(255,255,255,0.05);padding:10px;border-radius:8px;margin-bottom:10px;">`;
                                html += `<div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>💵 평균단가</span><strong>${formatCurrency(Math.round(price))}</strong></div>`;
                                html += `<div style="display:flex;justify-content:space-between;"><span>📊 연평균 대비</span><span style="color:${vsAvgColor};font-weight:bold;">${vsAvg >= 0 ? '+' : ''}${vsAvg.toFixed(1)}%</span></div>`;
                                html += `</div>`;

                                if (monthData.sales && monthData.count) {
                                    html += `<div style="color:#94a3b8;font-size:12px;margin-bottom:8px;">
                                        💰 매출: ${formatCurrency(monthData.sales)} · 📋 건수: ${monthData.count.toLocaleString()}건
                                    </div>`;
                                }

                                if (compareData && compPrice > 0) {
                                    const yoyDiff = ((price - compPrice) / compPrice * 100);
                                    const yoyColor = yoyDiff >= 0 ? '#10b981' : '#ef4444';
                                    html += `<div style="padding:8px;border-radius:6px;background:rgba(99,102,241,0.1);">
                                        📅 ${compareData.year}년 대비: <span style="color:${yoyColor};font-weight:bold;">${yoyDiff >= 0 ? '+' : ''}${yoyDiff.toFixed(1)}%</span>
                                        <span style="color:#94a3b8;font-size:11px;">(${formatCurrency(Math.round(compPrice))} → ${formatCurrency(Math.round(price))})</span>
                                    </div>`;
                                }

                                tooltipEl.innerHTML = html;
                                tooltipEl.style.opacity = 1; tooltipEl.style.pointerEvents = 'auto';
                                const pos = context.chart.canvas.getBoundingClientRect();
                                tooltipEl.style.left = Math.min(pos.left + context.tooltip.caretX + 10, window.innerWidth - 360) + 'px';
                                tooltipEl.style.top = Math.min(pos.top + context.tooltip.caretY, window.innerHeight - 300) + 'px';
                            }
                        }
                    },
                    scales: { y: { ticks: { callback: v => formatCurrency(v) } } }
                }
            });
        }

        // 전년 대비 차트
        function updateYoyChart() {
            if (!compareData) {
                const ctx = document.getElementById('yoyChart').getContext('2d');
                if (charts.yoy) charts.yoy.destroy();
                charts.yoy = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: ['비교 데이터 없음'], datasets: [{ data: [0], backgroundColor: '#ccc' }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
                return;
            }

            const monthly = currentData.by_month || [];
            const compMonthly = compareData.by_month || [];
            const ctx = document.getElementById('yoyChart').getContext('2d');
            if (charts.yoy) charts.yoy.destroy();

            const labels = ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'];
            const monthMap = Object.fromEntries(monthly);
            const compMap = Object.fromEntries(compMonthly);
            const data = labels.map((_, i) => {
                const curr = monthMap[i+1]?.sales || 0;
                const prev = compMap[i+1]?.sales || 0;
                return prev > 0 ? ((curr - prev) / prev * 100) : 0;
            });
            const validData = data.filter(v => v !== 0);
            const avgGrowth = validData.length > 0 ? validData.reduce((s, v) => s + v, 0) / validData.length : 0;

            // 외부 툴팁
            const getOrCreateYoyTooltip = (chart) => {
                let el = document.getElementById('yoyChartTooltip');
                if (!el) {
                    el = document.createElement('div');
                    el.id = 'yoyChartTooltip';
                    el.style.cssText = 'position:fixed;background:rgba(30,41,59,0.98);border-radius:12px;padding:16px;pointer-events:auto;z-index:99999;font-size:13px;color:#e2e8f0;box-shadow:0 20px 40px rgba(0,0,0,0.4);min-width:300px;max-width:380px;max-height:85vh;overflow-y:auto;transition:opacity 0.15s ease;line-height:1.5;';
                    document.body.appendChild(el); setupTooltipHover(el);
                }
                return el;
            };

            charts.yoy = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label: '전년대비 (%)', data, backgroundColor: data.map(v => v >= 0 ? 'rgba(34, 197, 94, 0.7)' : 'rgba(239, 68, 68, 0.7)'), borderRadius: 4 }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: true },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: false,
                            external: function(context) {
                                const tooltipEl = getOrCreateYoyTooltip(context.chart);
                                if (context.tooltip.opacity === 0 && !isTooltipHovered(tooltipEl)) { hideTooltipWithDelay(tooltipEl); return; }

                                const idx = context.tooltip.dataPoints?.[0]?.dataIndex;
                                if (idx === undefined) return;

                                const growth = data[idx];
                                const currSales = monthMap[idx + 1]?.sales || 0;
                                const prevSales = compMap[idx + 1]?.sales || 0;
                                const currCount = monthMap[idx + 1]?.count || 0;
                                const prevCount = compMap[idx + 1]?.count || 0;
                                const diff = currSales - prevSales;

                                // 성과 판단
                                let perfTag, perfIcon, perfColor;
                                if (growth >= 20) { perfTag = '급성장'; perfIcon = '🚀'; perfColor = '#10b981'; }
                                else if (growth >= 5) { perfTag = '성장'; perfIcon = '📈'; perfColor = '#22c55e'; }
                                else if (growth >= -5) { perfTag = '유지'; perfIcon = '➡️'; perfColor = '#94a3b8'; }
                                else if (growth >= -20) { perfTag = '하락'; perfIcon = '📉'; perfColor = '#f59e0b'; }
                                else { perfTag = '급감'; perfIcon = '⚠️'; perfColor = '#ef4444'; }

                                let html = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                                    <span style="font-size:16px;font-weight:bold;">${labels[idx]}</span>
                                    <span style="background:${perfColor}22;color:${perfColor};padding:4px 10px;border-radius:6px;font-size:12px;">${perfIcon} ${perfTag}</span>
                                </div>`;

                                html += `<div style="text-align:center;padding:16px;background:${growth >= 0 ? 'rgba(16,185,129,0.1)' : 'rgba(239,68,68,0.1)'};border-radius:8px;margin-bottom:12px;">
                                    <div style="font-size:28px;font-weight:bold;color:${growth >= 0 ? '#10b981' : '#ef4444'};">${growth >= 0 ? '+' : ''}${growth.toFixed(1)}%</div>
                                    <div style="color:#94a3b8;font-size:12px;">전년 동월 대비</div>
                                </div>`;

                                html += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;">`;
                                html += `<div style="background:rgba(255,255,255,0.05);padding:10px;border-radius:6px;text-align:center;">
                                    <div style="color:#94a3b8;font-size:11px;">${currentData.year}년</div>
                                    <div style="font-weight:bold;">${formatCurrency(currSales)}</div>
                                    <div style="color:#94a3b8;font-size:11px;">${currCount.toLocaleString()}건</div>
                                </div>`;
                                html += `<div style="background:rgba(255,255,255,0.05);padding:10px;border-radius:6px;text-align:center;">
                                    <div style="color:#94a3b8;font-size:11px;">${compareData.year}년</div>
                                    <div style="font-weight:bold;">${formatCurrency(prevSales)}</div>
                                    <div style="color:#94a3b8;font-size:11px;">${prevCount.toLocaleString()}건</div>
                                </div>`;
                                html += `</div>`;

                                html += `<div style="padding:8px;border-radius:6px;background:rgba(99,102,241,0.1);">
                                    💰 차이: <span style="color:${diff >= 0 ? '#10b981' : '#ef4444'};font-weight:bold;">${diff >= 0 ? '+' : ''}${formatCurrency(diff)}</span>
                                    <span style="color:#94a3b8;font-size:11px;">(연평균 성장률: ${avgGrowth >= 0 ? '+' : ''}${avgGrowth.toFixed(1)}%)</span>
                                </div>`;

                                tooltipEl.innerHTML = html;
                                tooltipEl.style.opacity = 1; tooltipEl.style.pointerEvents = 'auto';
                                const pos = context.chart.canvas.getBoundingClientRect();
                                tooltipEl.style.left = Math.min(pos.left + context.tooltip.caretX + 10, window.innerWidth - 390) + 'px';
                                tooltipEl.style.top = Math.min(pos.top + context.tooltip.caretY, window.innerHeight - 350) + 'px';
                            }
                        }
                    },
                    scales: { y: { ticks: { callback: v => v + '%' } } }
                }
            });
        }

        // 히트맵 정렬 상태
        let heatmapSortCol = 'total';
        let heatmapSortDir = 'desc';

        // 히트맵 정렬 함수
        function sortHeatmap(col) {
            if (heatmapSortCol === col) {
                heatmapSortDir = heatmapSortDir === 'desc' ? 'asc' : 'desc';
            } else {
                heatmapSortCol = col;
                heatmapSortDir = 'desc';
            }
            updateHeatmap();
        }

        // 히트맵 셀 호버 오버레이
        let heatmapTooltipEl = null;
        function showHeatmapTooltip(e, purpose, month, currData, compData) {
            if (!heatmapTooltipEl) {
                heatmapTooltipEl = document.createElement('div');
                heatmapTooltipEl.id = 'heatmapTooltip';
                heatmapTooltipEl.style.cssText = 'position:fixed;background:rgba(30,41,59,0.98);border-radius:12px;padding:16px;z-index:99999;font-size:12px;color:#e2e8f0;box-shadow:0 10px 30px rgba(0,0,0,0.4);min-width:280px;max-width:340px;pointer-events:none;';
                document.body.appendChild(heatmapTooltipEl);
            }

            const monthNames = ['', '1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'];
            const currYear = currentData.year || '2025';
            const compYear = compareData?.year || '2024';

            const currSales = currData.sales || 0;
            const currCount = currData.count || 0;
            const compSales = compData?.sales || 0;
            const compCount = compData?.count || 0;
            const hasComp = compSales > 0 || compCount > 0;

            // 증감 계산
            const salesDiff = currSales - compSales;
            const salesPct = compSales > 0 ? (salesDiff / compSales * 100) : (currSales > 0 ? 100 : 0);
            const countDiff = currCount - compCount;
            const countPct = compCount > 0 ? (countDiff / compCount * 100) : (currCount > 0 ? 100 : 0);

            const currAvg = currCount > 0 ? currSales / currCount : 0;
            const compAvg = compCount > 0 ? compSales / compCount : 0;
            const avgDiff = currAvg - compAvg;
            const avgPct = compAvg > 0 ? (avgDiff / compAvg * 100) : 0;

            // 상승/하락 판정
            const isGrowth = salesDiff >= 0;
            const mainColor = isGrowth ? '#10b981' : '#ef4444';
            const mainIcon = isGrowth ? '📈' : '📉';
            const mainLabel = isGrowth ? '상승' : '하락';

            let html = `<div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid rgba(255,255,255,0.15);">`;
            html += `<span style="font-size:20px;">${mainIcon}</span>`;
            html += `<div><div style="font-weight:bold;font-size:14px;">${purpose}</div>`;
            html += `<div style="color:#94a3b8;font-size:11px;">${monthNames[month]} 전년 비교</div></div>`;
            html += `</div>`;

            // 전년 대비 요약 (상단에 크게)
            if (hasComp) {
                html += `<div style="background:${isGrowth ? 'rgba(16,185,129,0.15)' : 'rgba(239,68,68,0.15)'};padding:12px;border-radius:8px;margin-bottom:12px;text-align:center;">`;
                html += `<div style="font-size:11px;color:#94a3b8;margin-bottom:4px;">전년 대비 매출</div>`;
                html += `<div style="font-size:22px;font-weight:bold;color:${mainColor};">${salesDiff >= 0 ? '+' : ''}${salesPct.toFixed(1)}%</div>`;
                html += `<div style="font-size:11px;color:${mainColor};margin-top:2px;">${salesDiff >= 0 ? '+' : ''}${formatCurrency(salesDiff)}</div>`;
                html += `</div>`;
            }

            // 상세 비교 테이블
            html += `<table style="width:100%;font-size:11px;border-collapse:collapse;">`;
            html += `<tr style="border-bottom:1px solid rgba(255,255,255,0.1);">`;
            html += `<th style="text-align:left;padding:6px 4px;color:#94a3b8;">항목</th>`;
            html += `<th style="text-align:right;padding:6px 4px;color:#60a5fa;">${currYear}</th>`;
            html += `<th style="text-align:right;padding:6px 4px;color:#f59e0b;">${compYear}</th>`;
            html += `<th style="text-align:right;padding:6px 4px;color:#94a3b8;">증감</th>`;
            html += `</tr>`;

            // 매출
            const salesColor = salesDiff >= 0 ? '#10b981' : '#ef4444';
            html += `<tr style="border-bottom:1px solid rgba(255,255,255,0.05);">`;
            html += `<td style="padding:6px 4px;">매출</td>`;
            html += `<td style="text-align:right;padding:6px 4px;font-weight:600;">${formatCurrency(currSales)}</td>`;
            html += `<td style="text-align:right;padding:6px 4px;">${formatCurrency(compSales)}</td>`;
            html += `<td style="text-align:right;padding:6px 4px;color:${salesColor};font-weight:600;">${salesDiff >= 0 ? '▲' : '▼'} ${Math.abs(salesPct).toFixed(1)}%</td>`;
            html += `</tr>`;

            // 건수
            const countColor = countDiff >= 0 ? '#10b981' : '#ef4444';
            html += `<tr style="border-bottom:1px solid rgba(255,255,255,0.05);">`;
            html += `<td style="padding:6px 4px;">건수</td>`;
            html += `<td style="text-align:right;padding:6px 4px;font-weight:600;">${currCount.toLocaleString()}건</td>`;
            html += `<td style="text-align:right;padding:6px 4px;">${compCount.toLocaleString()}건</td>`;
            html += `<td style="text-align:right;padding:6px 4px;color:${countColor};font-weight:600;">${countDiff >= 0 ? '▲' : '▼'} ${Math.abs(countPct).toFixed(1)}%</td>`;
            html += `</tr>`;

            // 건당 단가
            if (currCount > 0 || compCount > 0) {
                const avgColor = avgDiff >= 0 ? '#10b981' : '#ef4444';
                html += `<tr>`;
                html += `<td style="padding:6px 4px;">건당단가</td>`;
                html += `<td style="text-align:right;padding:6px 4px;font-weight:600;">${formatCurrency(Math.round(currAvg))}</td>`;
                html += `<td style="text-align:right;padding:6px 4px;">${formatCurrency(Math.round(compAvg))}</td>`;
                if (compAvg > 0) {
                    html += `<td style="text-align:right;padding:6px 4px;color:${avgColor};font-weight:600;">${avgDiff >= 0 ? '▲' : '▼'} ${Math.abs(avgPct).toFixed(1)}%</td>`;
                } else {
                    html += `<td style="text-align:right;padding:6px 4px;color:#94a3b8;">-</td>`;
                }
                html += `</tr>`;
            }
            html += `</table>`;

            // 분석 코멘트
            if (hasComp) {
                html += `<div style="margin-top:10px;padding:8px;background:rgba(99,102,241,0.1);border-radius:6px;font-size:11px;color:#a5b4fc;">`;
                if (Math.abs(salesPct) >= 20) {
                    if (salesDiff >= 0) {
                        html += `💡 <strong>대폭 상승</strong>: 전년 대비 ${salesPct.toFixed(0)}% 성장`;
                    } else {
                        html += `⚠️ <strong>대폭 하락</strong>: 전년 대비 ${Math.abs(salesPct).toFixed(0)}% 감소`;
                    }
                } else if (Math.abs(salesPct) >= 10) {
                    if (salesDiff >= 0) {
                        html += `📊 <strong>상승세</strong>: 전년 대비 ${salesPct.toFixed(0)}% 증가`;
                    } else {
                        html += `📉 <strong>하락세</strong>: 전년 대비 ${Math.abs(salesPct).toFixed(0)}% 감소`;
                    }
                } else if (Math.abs(salesPct) >= 5) {
                    html += `📌 <strong>소폭 ${salesDiff >= 0 ? '상승' : '하락'}</strong>: 비교적 안정적`;
                } else {
                    html += `✅ <strong>유지</strong>: 전년과 유사한 수준`;
                }
                html += `</div>`;
            }

            heatmapTooltipEl.innerHTML = html;
            heatmapTooltipEl.style.display = 'block';

            // 위치 계산
            let left = e.clientX + 15;
            let top = e.clientY - 10;
            if (left + 340 > window.innerWidth) left = e.clientX - 355;
            if (top + 350 > window.innerHeight) top = window.innerHeight - 360;
            if (top < 10) top = 10;
            heatmapTooltipEl.style.left = left + 'px';
            heatmapTooltipEl.style.top = top + 'px';
        }

        function hideHeatmapTooltip() {
            if (heatmapTooltipEl) heatmapTooltipEl.style.display = 'none';
        }

        function showHeatmapCellTooltip(e, el) {
            const purpose = el.dataset.purpose;
            const month = parseInt(el.dataset.month);
            const currData = JSON.parse(el.dataset.curr || '{}');
            const compData = JSON.parse(el.dataset.comp || '{}');
            showHeatmapTooltip(e, purpose, month, currData, compData);
        }

        // 히트맵 업데이트
        function updateHeatmap() {
            const monthly = currentData.by_month || [];
            const monthMap = Object.fromEntries(monthly);
            const compMonthly = compareData?.by_month || [];
            const compMap = Object.fromEntries(compMonthly);
            const hasCompare = compareData && compMonthly.length > 0;

            const yearView = document.getElementById('heatmapYear')?.value || 'current';
            const metric = document.getElementById('heatmapMetric')?.value || 'sales';
            const colorScheme = document.getElementById('heatmapColorScheme')?.value || 'blue';

            const purposes = {};

            // 모든 목적과 월별 데이터 수집
            const excludePurposes = ['접수취소', 'IGC', '참고용(유통기한설정)', '정도관리', '잔류농약(인증용)'];
            for (let m = 1; m <= 12; m++) {
                const byPurpose = monthMap[m]?.byPurpose || {};
                const compByPurpose = compMap[m]?.byPurpose || {};
                for (const [purpose, data] of Object.entries(byPurpose)) {
                    if (excludePurposes.includes(purpose)) continue;
                    if (!purposes[purpose]) purposes[purpose] = { months: {}, compMonths: {} };
                    purposes[purpose].months[m] = { sales: data.sales || 0, count: data.count || 0 };
                }
                // 비교 연도 데이터
                for (const [purpose, data] of Object.entries(compByPurpose)) {
                    if (excludePurposes.includes(purpose)) continue;
                    if (!purposes[purpose]) purposes[purpose] = { months: {}, compMonths: {} };
                    purposes[purpose].compMonths[m] = { sales: data.sales || 0, count: data.count || 0 };
                }
            }

            // 값 추출 함수 (연도 선택 반영)
            const getValue = (purposeData, m) => {
                const curr = purposeData.months[m] || { sales: 0, count: 0 };
                const comp = purposeData.compMonths[m] || { sales: 0, count: 0 };

                // 연도 선택에 따른 데이터 소스
                const useData = yearView === 'compare' ? comp : curr;

                if (metric === 'sales') return useData.sales;
                if (metric === 'count') return useData.count;
                if (metric === 'growth') {
                    if (!hasCompare || comp.sales <= 0) return null;
                    return ((curr.sales - comp.sales) / comp.sales * 100);
                }
                return useData.sales;
            };

            // 합계 계산 함수 (연도 선택 반영)
            const getTotal = (purposeData) => {
                let total = 0, compTotal = 0;
                for (let m = 1; m <= 12; m++) {
                    const curr = purposeData.months[m] || { sales: 0, count: 0 };
                    const comp = purposeData.compMonths[m] || { sales: 0, count: 0 };
                    if (metric === 'sales') { total += curr.sales; compTotal += comp.sales; }
                    else if (metric === 'count') { total += curr.count; compTotal += comp.count; }
                }
                if (metric === 'growth' && hasCompare && compTotal > 0) {
                    return ((total - compTotal) / compTotal * 100);
                }
                return yearView === 'compare' ? compTotal : total;
            };

            // 최대/최소값 계산
            let maxVal = -Infinity, minVal = Infinity;
            for (const [purpose, pData] of Object.entries(purposes)) {
                for (let m = 1; m <= 12; m++) {
                    const val = getValue(pData, m);
                    if (val !== null) {
                        if (val > maxVal) maxVal = val;
                        if (val < minVal) minVal = val;
                    }
                }
            }
            if (maxVal === -Infinity) maxVal = 0;
            if (minVal === Infinity) minVal = 0;

            // 색상 함수
            const getColor = (val, intensity) => {
                if (val === null || val === 0) return { bg: '', text: '#999' };

                if (metric === 'growth') {
                    // 성장률: 녹색(+) / 빨간색(-)
                    if (val >= 0) {
                        const int = Math.min(val / 50, 1);
                        return { bg: `rgba(16, 185, 129, ${0.15 + int * 0.6})`, text: int > 0.4 ? '#fff' : '#065f46' };
                    } else {
                        const int = Math.min(Math.abs(val) / 50, 1);
                        return { bg: `rgba(239, 68, 68, ${0.15 + int * 0.6})`, text: int > 0.4 ? '#fff' : '#991b1b' };
                    }
                }

                if (colorScheme === 'blue') {
                    return { bg: `rgba(59, 130, 246, ${0.1 + intensity * 0.7})`, text: intensity > 0.5 ? '#fff' : '#1e40af' };
                } else if (colorScheme === 'green') {
                    return { bg: `rgba(34, 197, 94, ${0.1 + intensity * 0.7})`, text: intensity > 0.5 ? '#fff' : '#166534' };
                } else if (colorScheme === 'heat') {
                    // 열 지도: 낮음(노랑) -> 높음(빨강)
                    const r = 255;
                    const g = Math.round(255 * (1 - intensity * 0.8));
                    const b = Math.round(100 * (1 - intensity));
                    return { bg: `rgba(${r}, ${g}, ${b}, ${0.3 + intensity * 0.5})`, text: intensity > 0.6 ? '#fff' : '#7c2d12' };
                }
                return { bg: '', text: '#333' };
            };

            // 범례 생성
            const legendEl = document.getElementById('heatmapLegend');
            if (metric === 'growth') {
                legendEl.innerHTML = `
                    <span>📈 <strong>성장률 기준</strong></span>
                    <span style="background:rgba(16,185,129,0.3);padding:2px 8px;border-radius:4px;color:#065f46;">+50%↑ 고성장</span>
                    <span style="background:rgba(16,185,129,0.15);padding:2px 8px;border-radius:4px;color:#065f46;">+0~50%</span>
                    <span style="background:rgba(239,68,68,0.15);padding:2px 8px;border-radius:4px;color:#991b1b;">-0~50%</span>
                    <span style="background:rgba(239,68,68,0.5);padding:2px 8px;border-radius:4px;color:#fff;">-50%↓ 급감</span>
                `;
            } else {
                const metricName = metric === 'sales' ? '매출' : '건수';
                const schemeColors = colorScheme === 'blue' ? ['#dbeafe', '#3b82f6'] :
                                     colorScheme === 'green' ? ['#dcfce7', '#22c55e'] : ['#fef3c7', '#ef4444'];
                legendEl.innerHTML = `
                    <span>📊 <strong>${metricName} 기준</strong></span>
                    <span style="background:${schemeColors[0]};padding:2px 8px;border-radius:4px;">낮음</span>
                    <span>→</span>
                    <span style="background:${schemeColors[1]};padding:2px 8px;border-radius:4px;color:#fff;">높음</span>
                    <span style="color:#94a3b8;margin-left:8px;">클릭하여 정렬</span>
                `;
            }

            // 헤더 구성 (정렬 기능 추가)
            const headerRow = document.getElementById('heatmapHeader');
            const sortIcon = (col) => {
                if (heatmapSortCol === col) return heatmapSortDir === 'desc' ? ' ▼' : ' ▲';
                return '';
            };
            const headerStyle = 'cursor:pointer;user-select:none;';
            headerRow.innerHTML = `<th style="${headerStyle}" onclick="sortHeatmap('name')">검사목적${sortIcon('name')}</th>` +
                ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'].map((m, i) =>
                    `<th class="text-center" style="${headerStyle}" onclick="sortHeatmap(${i+1})">${m}${sortIcon(i+1)}</th>`
                ).join('') +
                `<th class="text-right" style="${headerStyle}" onclick="sortHeatmap('total')">합계${sortIcon('total')}</th>`;

            // 정렬
            let purposeEntries = Object.entries(purposes);
            purposeEntries.sort((a, b) => {
                let aVal, bVal;
                if (heatmapSortCol === 'name') {
                    aVal = a[0]; bVal = b[0];
                    return heatmapSortDir === 'desc' ? bVal.localeCompare(aVal) : aVal.localeCompare(bVal);
                } else if (heatmapSortCol === 'total') {
                    aVal = getTotal(a[1]); bVal = getTotal(b[1]);
                } else {
                    aVal = getValue(a[1], heatmapSortCol) || 0;
                    bVal = getValue(b[1], heatmapSortCol) || 0;
                }
                return heatmapSortDir === 'desc' ? bVal - aVal : aVal - bVal;
            });

            // 본문 구성
            const tbody = document.getElementById('heatmapBody');
            tbody.innerHTML = purposeEntries.map(([purpose, pData]) => {
                const cells = [];
                const escapedPurpose = purpose.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                for (let m = 1; m <= 12; m++) {
                    const val = getValue(pData, m);
                    const range = maxVal - minVal;
                    const intensity = range > 0 && val !== null ? (val - minVal) / range : 0;
                    const { bg, text } = getColor(val, intensity);

                    // 호버 툴팁용 데이터
                    const currData = pData.months[m] || { sales: 0, count: 0 };
                    const compData = pData.compMonths[m] || { sales: 0, count: 0 };
                    const currStr = JSON.stringify(currData).replace(/"/g, '&quot;');
                    const compStr = JSON.stringify(compData).replace(/"/g, '&quot;');

                    // 전년 대비 증감 표시
                    let yoyIndicator = '';
                    if (hasCompare && metric !== 'growth') {
                        const currVal = metric === 'sales' ? currData.sales : currData.count;
                        const compVal = metric === 'sales' ? compData.sales : compData.count;
                        if (compVal > 0 && currVal > 0) {
                            const diff = currVal - compVal;
                            if (diff > 0) {
                                yoyIndicator = '<span style="color:#10b981;font-size:9px;margin-left:2px;">▲</span>';
                            } else if (diff < 0) {
                                yoyIndicator = '<span style="color:#ef4444;font-size:9px;margin-left:2px;">▼</span>';
                            }
                        } else if (currVal > 0 && compVal === 0) {
                            yoyIndicator = '<span style="color:#10b981;font-size:9px;margin-left:2px;">▲</span>';
                        } else if (currVal === 0 && compVal > 0) {
                            yoyIndicator = '<span style="color:#ef4444;font-size:9px;margin-left:2px;">▼</span>';
                        }
                    }

                    let displayVal = '-';
                    if (val !== null && val !== 0) {
                        if (metric === 'sales') displayVal = formatCurrency(val);
                        else if (metric === 'count') displayVal = val.toLocaleString() + '건';
                        else if (metric === 'growth') displayVal = (val >= 0 ? '+' : '') + val.toFixed(1) + '%';
                    }

                    cells.push(`<td class="text-center" style="background:${bg};color:${text};font-size:12px;cursor:pointer;transition:transform 0.1s;" data-purpose="${escapedPurpose}" data-month="${m}" data-curr="${currStr}" data-comp="${compStr}" onmouseenter="showHeatmapCellTooltip(event,this);this.style.transform='scale(1.1)';this.style.zIndex='10';" onmouseleave="hideHeatmapTooltip();this.style.transform='';this.style.zIndex='';">${displayVal}${yoyIndicator}</td>`);
                }
                const total = getTotal(pData);
                let totalDisplay = metric === 'sales' ? formatCurrency(total) :
                                   metric === 'count' ? total.toLocaleString() + '건' :
                                   (total >= 0 ? '+' : '') + total.toFixed(1) + '%';
                const totalColor = metric === 'growth' ? (total >= 0 ? '#10b981' : '#ef4444') : '#1e293b';
                return `<tr><td style="font-weight:500;">${purpose}</td>${cells.join('')}<td class="text-right" style="font-weight:700;color:${totalColor};">${totalDisplay}</td></tr>`;
            }).join('');
        }

        // 월별 상세 테이블
        function updateMonthlyDetailTable() {
            const monthly = currentData.by_month || [];
            const monthMap = Object.fromEntries(monthly);
            const totalSales = currentData.total_sales || 1;

            // 전년도 데이터
            const compMonthly = compareData?.by_month || [];
            const compMap = Object.fromEntries(compMonthly);
            const hasCompare = compareData && compMonthly.length > 0;

            // 헤더 및 범례 표시
            const legendEl = document.getElementById('monthlyTableLegend');
            const yoyCols = document.querySelectorAll('.monthlyYoyCol');

            if (hasCompare) {
                legendEl.style.display = 'flex';
                yoyCols.forEach(el => el.style.display = '');
            } else {
                legendEl.style.display = 'none';
                yoyCols.forEach(el => el.style.display = 'none');
            }

            // 월별 데이터 구성
            let monthlyData = [];
            let maxSales = 0;
            let totalGrowthCount = 0, totalDeclineCount = 0;
            let bestMonth = null, worstMonth = null;
            let bestGrowth = -Infinity, worstGrowth = Infinity;

            for (let m = 1; m <= 12; m++) {
                const data = monthMap[m];
                if (data && data.sales > 0) {
                    const avgPrice = data.count > 0 ? data.sales / data.count : 0;
                    const percent = (data.sales / totalSales * 100);
                    const compData = compMap[m];

                    let salesPct = null, countPct = null;
                    if (hasCompare && compData && compData.sales > 0) {
                        salesPct = ((data.sales - compData.sales) / compData.sales * 100);
                        countPct = compData.count > 0 ? ((data.count - compData.count) / compData.count * 100) : 0;
                        if (salesPct >= 0) totalGrowthCount++;
                        else totalDeclineCount++;
                        if (salesPct > bestGrowth) { bestGrowth = salesPct; bestMonth = m; }
                        if (salesPct < worstGrowth) { worstGrowth = salesPct; worstMonth = m; }
                    }

                    // 주요 검사목적 찾기
                    const byPurpose = data.byPurpose || {};
                    const topPurposes = Object.entries(byPurpose)
                        .sort((a, b) => b[1].sales - a[1].sales)
                        .slice(0, 2);

                    monthlyData.push({
                        month: m,
                        sales: data.sales,
                        count: data.count,
                        avgPrice,
                        percent,
                        compSales: compData?.sales || 0,
                        compCount: compData?.count || 0,
                        salesPct,
                        countPct,
                        topPurposes
                    });

                    if (data.sales > maxSales) maxSales = data.sales;
                }
            }

            // 정렬
            const sortBy = document.getElementById('monthlyDetailSort')?.value || 'month';
            if (sortBy === 'sales_desc') monthlyData.sort((a, b) => b.sales - a.sales);
            else if (sortBy === 'sales_asc') monthlyData.sort((a, b) => a.sales - b.sales);
            else if (sortBy === 'growth_desc') monthlyData.sort((a, b) => (b.salesPct || -999) - (a.salesPct || -999));
            else if (sortBy === 'growth_asc') monthlyData.sort((a, b) => (a.salesPct || 999) - (b.salesPct || 999));

            // 요약 통계 표시
            const summaryEl = document.getElementById('monthlyDetailSummary');
            if (hasCompare && monthlyData.length > 0) {
                const avgGrowth = monthlyData.filter(d => d.salesPct !== null).reduce((s, d) => s + d.salesPct, 0) / monthlyData.filter(d => d.salesPct !== null).length;
                summaryEl.innerHTML = `
                    <div style="background: linear-gradient(135deg, #dbeafe, #eff6ff); padding: 12px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 11px; color: #3b82f6; margin-bottom: 4px;">📈 성장 월</div>
                        <div style="font-size: 20px; font-weight: 700; color: #10b981;">${totalGrowthCount}개월</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fee2e2, #fef2f2); padding: 12px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 11px; color: #ef4444; margin-bottom: 4px;">📉 하락 월</div>
                        <div style="font-size: 20px; font-weight: 700; color: #ef4444;">${totalDeclineCount}개월</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #dcfce7, #f0fdf4); padding: 12px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 11px; color: #22c55e; margin-bottom: 4px;">🏆 최고 성장</div>
                        <div style="font-size: 16px; font-weight: 700; color: #16a34a;">${bestMonth}월 (+${bestGrowth.toFixed(1)}%)</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fef3c7, #fffbeb); padding: 12px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 11px; color: #f59e0b; margin-bottom: 4px;">📊 평균 성장률</div>
                        <div style="font-size: 20px; font-weight: 700; color: ${avgGrowth >= 0 ? '#10b981' : '#ef4444'};">${avgGrowth >= 0 ? '+' : ''}${avgGrowth.toFixed(1)}%</div>
                    </div>
                `;
                summaryEl.style.display = 'grid';
            } else {
                summaryEl.style.display = 'none';
            }

            // 테이블 본문 구성
            const tbody = document.querySelector('#monthlyDetailTable tbody');
            let rows = [];

            for (const d of monthlyData) {
                // 매출 바 너비 계산
                const barWidth = maxSales > 0 ? (d.sales / maxSales * 100) : 0;

                // 전년 대비 셀
                let compSalesCell = '', salesYoYCell = '', compCountCell = '', countYoYCell = '';

                if (hasCompare) {
                    compSalesCell = `<td class="text-right monthlyYoyCol" style="color: #94a3b8;">${d.compSales > 0 ? formatCurrency(d.compSales) : '-'}</td>`;
                    compCountCell = `<td class="text-right monthlyYoyCol" style="color: #94a3b8;">${d.compCount > 0 ? d.compCount.toLocaleString() + '건' : '-'}</td>`;

                    if (d.salesPct !== null) {
                        const salesColor = d.salesPct >= 0 ? '#10b981' : '#ef4444';
                        const salesIcon = d.salesPct >= 0 ? '▲' : '▼';
                        let salesBg = '';
                        if (d.salesPct >= 10) salesBg = 'background: rgba(16,185,129,0.15);';
                        else if (d.salesPct <= -10) salesBg = 'background: rgba(239,68,68,0.15);';
                        salesYoYCell = `<td class="text-right monthlyYoyCol"><span style="color: ${salesColor}; ${salesBg} padding: 3px 6px; border-radius: 4px; font-weight: 600;">${salesIcon} ${d.salesPct >= 0 ? '+' : ''}${d.salesPct.toFixed(1)}%</span></td>`;
                    } else {
                        salesYoYCell = `<td class="text-right monthlyYoyCol" style="color: #94a3b8;">-</td>`;
                    }

                    if (d.countPct !== null && d.compCount > 0) {
                        const countColor = d.countPct >= 0 ? '#10b981' : '#ef4444';
                        const countIcon = d.countPct >= 0 ? '▲' : '▼';
                        let countBg = '';
                        if (d.countPct >= 10) countBg = 'background: rgba(16,185,129,0.15);';
                        else if (d.countPct <= -10) countBg = 'background: rgba(239,68,68,0.15);';
                        countYoYCell = `<td class="text-right monthlyYoyCol"><span style="color: ${countColor}; ${countBg} padding: 3px 6px; border-radius: 4px; font-weight: 600;">${countIcon} ${d.countPct >= 0 ? '+' : ''}${d.countPct.toFixed(1)}%</span></td>`;
                    } else {
                        countYoYCell = `<td class="text-right monthlyYoyCol" style="color: #94a3b8;">-</td>`;
                    }
                }

                // 주요 검사목적 표시
                let purposeCell = '';
                if (d.topPurposes.length > 0) {
                    const purposeTags = d.topPurposes.map((p, i) => {
                        const pct = (p[1].sales / d.sales * 100).toFixed(0);
                        const bg = i === 0 ? 'background:#6366f1;color:white;' : 'background:#e2e8f0;color:#475569;';
                        return `<span style="${bg} padding:2px 6px;border-radius:4px;font-size:10px;white-space:nowrap;">${p[0].substring(0, 8)} ${pct}%</span>`;
                    }).join(' ');
                    purposeCell = `<td style="white-space:nowrap;">${purposeTags}</td>`;
                } else {
                    purposeCell = `<td style="color:#94a3b8;">-</td>`;
                }

                // 행 배경색 (성장/하락에 따라)
                let rowBg = '';
                if (hasCompare && d.salesPct !== null) {
                    if (d.salesPct >= 10) rowBg = 'background: rgba(16,185,129,0.03);';
                    else if (d.salesPct <= -10) rowBg = 'background: rgba(239,68,68,0.03);';
                }

                rows.push(`<tr style="${rowBg}">
                    <td style="font-weight: 600;">${d.month}월</td>
                    <td class="text-right">
                        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
                            <span style="font-weight:600;">${formatCurrency(d.sales)}</span>
                            <div style="width:100%;max-width:80px;height:4px;background:#e2e8f0;border-radius:2px;overflow:hidden;">
                                <div style="width:${barWidth}%;height:100%;background:linear-gradient(90deg,#6366f1,#8b5cf6);border-radius:2px;"></div>
                            </div>
                        </div>
                    </td>
                    ${compSalesCell}
                    ${salesYoYCell}
                    <td class="text-right" style="font-weight:500;">${d.count.toLocaleString()}건</td>
                    ${compCountCell}
                    ${countYoYCell}
                    <td class="text-right">${formatCurrency(d.avgPrice)}</td>
                    <td class="text-right"><span style="background:#f1f5f9;padding:2px 8px;border-radius:4px;">${d.percent.toFixed(1)}%</span></td>
                    ${purposeCell}
                    <td class="text-center"><button class="btn btn-sm" onclick="showMonthDetail(${d.month})" style="padding:4px 10px;">상세</button></td>
                </tr>`);
            }

            tbody.innerHTML = rows.join('');
            document.getElementById('monthlyTableBadge').textContent = `${monthlyData.length}개월`;
        }

        // 월 상세 모달
        let monthPurposeChart = null;
        let monthManagerChart = null;

        function showMonthDetail(month) {
            const monthly = currentData.by_month || [];
            const monthMap = Object.fromEntries(monthly);
            const data = monthMap[month];

            if (!data) return;

            document.getElementById('monthModalTitle').textContent = `${month}월 상세 분석`;
            document.getElementById('monthModal').style.display = 'flex';

            // 검사목적별 도넛 차트
            const purposeCtx = document.getElementById('monthPurposeChart').getContext('2d');
            if (monthPurposeChart) monthPurposeChart.destroy();

            const byPurpose = data.byPurpose || {};
            const purposeLabels = Object.keys(byPurpose);
            const purposeValues = purposeLabels.map(p => byPurpose[p].sales);

            monthPurposeChart = new Chart(purposeCtx, {
                type: 'doughnut',
                data: { labels: purposeLabels, datasets: [{ data: purposeValues, backgroundColor: ['#6366f1', '#8b5cf6', '#a855f7', '#d946ef', '#ec4899', '#f43f5e', '#f59e0b', '#22c55e'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 12 } } } }
            });

            // 담당자별 도넛 차트
            const managerCtx = document.getElementById('monthManagerChart').getContext('2d');
            if (monthManagerChart) monthManagerChart.destroy();

            const byManager = data.byManager || {};
            const managerEntries = Object.entries(byManager).sort((a, b) => b[1].sales - a[1].sales).slice(0, 8);
            const managerLabels = managerEntries.map(e => e[0]);
            const managerValues = managerEntries.map(e => e[1].sales);

            monthManagerChart = new Chart(managerCtx, {
                type: 'doughnut',
                data: { labels: managerLabels, datasets: [{ data: managerValues, backgroundColor: ['#6366f1', '#8b5cf6', '#a855f7', '#d946ef', '#ec4899', '#f43f5e', '#f59e0b', '#22c55e'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 12 } } } }
            });

            // 주요 지표
            const avgPrice = data.count > 0 ? data.sales / data.count : 0;
            const statsHtml = `
                <div style="background: #f1f5f9; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.85rem; color: #64748b;">매출액</div>
                    <div style="font-size: 1.3rem; font-weight: bold; color: #6366f1;">${formatCurrency(data.sales)}</div>
                </div>
                <div style="background: #f1f5f9; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.85rem; color: #64748b;">건수</div>
                    <div style="font-size: 1.3rem; font-weight: bold; color: #22c55e;">${data.count.toLocaleString()}건</div>
                </div>
                <div style="background: #f1f5f9; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.85rem; color: #64748b;">평균단가</div>
                    <div style="font-size: 1.3rem; font-weight: bold; color: #f59e0b;">${formatCurrency(avgPrice)}</div>
                </div>
                <div style="background: #f1f5f9; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.85rem; color: #64748b;">검사목적 수</div>
                    <div style="font-size: 1.3rem; font-weight: bold; color: #8b5cf6;">${Object.keys(byPurpose).length}개</div>
                </div>
            `;
            document.getElementById('monthDetailStats').innerHTML = statsHtml;
        }

        function closeMonthModal() {
            document.getElementById('monthModal').style.display = 'none';
        }

        // 모달 외부 클릭 시 닫기
        document.getElementById('monthModal')?.addEventListener('click', function(e) {
            if (e.target === this) closeMonthModal();
        });

        // 테이블 정렬 함수
        function sortManagerTable(column) {
            if (managerTableSort.column === column) {
                managerTableSort.direction = managerTableSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                managerTableSort.column = column;
                managerTableSort.direction = 'desc';
            }
            updateManagerTable();
        }

        function sortBranchTable(column) {
            if (branchTableSort.column === column) {
                branchTableSort.direction = branchTableSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                branchTableSort.column = column;
                branchTableSort.direction = 'desc';
            }
            updateBranchTable();
        }

        function updateManagerTable() {
            const purposeFilter = document.getElementById('managerPurposeFilter')?.value || '전체';
            let managers = [];

            // 원본 by_manager 데이터 맵 (긴급 데이터 참조용)
            const originalManagerMap = Object.fromEntries((currentData.by_manager || []).map(m => [m[0], m[1]]));

            // 검사목적 필터 적용
            if (purposeFilter === '전체') {
                managers = [...(currentData.by_manager || [])];
            } else {
                // purpose_managers에서 해당 목적의 담당자 데이터 가져오기
                const purposeManagerData = currentData.purpose_managers?.[purposeFilter] || [];
                managers = purposeManagerData.map(m => {
                    // 원본 데이터에서 해당 목적의 긴급 건수 가져오기
                    const originalData = originalManagerMap[m.name] || {};
                    const urgentByPurpose = originalData.urgent_by_purpose || {};
                    const urgentCount = urgentByPurpose[purposeFilter] || 0;
                    return [m.name, { sales: m.sales, count: m.count, urgent: urgentCount }];
                });
            }

            const tbody = document.querySelector('#managerTable tbody');
            const total = purposeFilter === '전체' ? (currentData.total_sales || 1) : managers.reduce((sum, m) => sum + m[1].sales, 0) || 1;
            const workingDays = 250;
            const compareMap = compareData ? Object.fromEntries(compareData.by_manager || []) : {};

            // 정렬 적용
            if (managerTableSort.column) {
                const col = managerTableSort.column;
                const dir = managerTableSort.direction === 'asc' ? 1 : -1;
                managers.sort((a, b) => {
                    let aVal, bVal;
                    const aComp = compareMap[a[0]] || {};
                    const bComp = compareMap[b[0]] || {};
                    switch(col) {
                        case 'name': aVal = a[0]; bVal = b[0]; return dir * aVal.localeCompare(bVal); break;
                        case 'sales': aVal = a[1].sales || 0; bVal = b[1].sales || 0; break;
                        case 'count': aVal = a[1].count || 0; bVal = b[1].count || 0; break;
                        case 'avgPrice': aVal = (a[1].count > 0 ? a[1].sales / a[1].count : 0); bVal = (b[1].count > 0 ? b[1].sales / b[1].count : 0); break;
                        case 'dailyAvg': aVal = a[1].sales / workingDays; bVal = b[1].sales / workingDays; break;
                        case 'urgent': aVal = a[1].urgent || 0; bVal = b[1].urgent || 0; break;
                        case 'compSales': aVal = aComp.sales || 0; bVal = bComp.sales || 0; break;
                        case 'compAvgPrice': aVal = aComp.count > 0 ? aComp.sales / aComp.count : 0; bVal = bComp.count > 0 ? bComp.sales / bComp.count : 0; break;
                        case 'change':
                            const aCompS = aComp.sales || 0;
                            const bCompS = bComp.sales || 0;
                            aVal = aCompS > 0 ? ((a[1].sales - aCompS) / aCompS * 100) : 0;
                            bVal = bCompS > 0 ? ((b[1].sales - bCompS) / bCompS * 100) : 0;
                            break;
                        case 'percent': aVal = a[1].sales / total; bVal = b[1].sales / total; break;
                        default: aVal = a[1].sales || 0; bVal = b[1].sales || 0;
                    }
                    return dir * (aVal - bVal);
                });
            }

            // 테이블 배지 업데이트
            const badgeEl = document.getElementById('managerTableBadge');
            if (badgeEl) badgeEl.textContent = managers.length + '명';

            // 정렬 클래스 헬퍼
            const sortClass = (col) => {
                if (managerTableSort.column === col) return `sortable ${managerTableSort.direction}`;
                return 'sortable';
            };

            if (compareData) {
                document.getElementById('managerTableHead').innerHTML = `<tr>
                    <th class="${sortClass('name')}" onclick="sortManagerTable('name')">담당자</th>
                    <th class="text-right ${sortClass('sales')}" onclick="sortManagerTable('sales')">${currentData.year}년</th>
                    <th class="text-right ${sortClass('avgPrice')}" onclick="sortManagerTable('avgPrice')">${currentData.year}년 평균단가</th>
                    <th class="text-right ${sortClass('compSales')}" onclick="sortManagerTable('compSales')">${compareData.year}년</th>
                    <th class="text-right ${sortClass('compAvgPrice')}" onclick="sortManagerTable('compAvgPrice')">${compareData.year}년 평균단가</th>
                    <th class="text-right ${sortClass('urgent')}" onclick="sortManagerTable('urgent')">긴급</th>
                    <th class="text-right ${sortClass('change')}" onclick="sortManagerTable('change')">증감</th>
                    <th class="${sortClass('percent')}" onclick="sortManagerTable('percent')">비중</th>
                    <th class="text-center">상세</th>
                </tr>`;
                // 평균 계산 (강조 기준)
                const avgSales = managers.reduce((s, m) => s + (m[1].sales || 0), 0) / (managers.length || 1);
                const avgPriceAll = managers.reduce((s, m) => {
                    const c = m[1].count || 0;
                    return s + (c > 0 ? m[1].sales / c : 0);
                }, 0) / (managers.length || 1);

                tbody.innerHTML = managers.map((d, idx) => {
                    const compData = compareMap[d[0]] || {};
                    const compSales = compData.sales || 0;
                    const compCount = compData.count || 0;
                    const diff = d[1].sales - compSales;
                    const diffRate = compSales > 0 ? ((diff / compSales) * 100).toFixed(1) : 0;
                    const percent = (d[1].sales / total * 100).toFixed(1);
                    const avgPrice = (d[1].count || 0) > 0 ? d[1].sales / d[1].count : 0;
                    const compAvgPrice = compCount > 0 ? compSales / compCount : 0;
                    const urgent = d[1].urgent || 0;

                    // 순위 배지 & 행 스타일
                    const rank = idx + 1;
                    let rankBadge = '';
                    let rowStyle = '';
                    if (rank === 1) {
                        rankBadge = '<span style="background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #000; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-right: 6px;">🥇 1위</span>';
                        rowStyle = 'background: linear-gradient(90deg, rgba(251, 191, 36, 0.15), transparent);';
                    } else if (rank === 2) {
                        rankBadge = '<span style="background: linear-gradient(135deg, #e5e7eb, #9ca3af); color: #000; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-right: 6px;">🥈 2위</span>';
                        rowStyle = 'background: linear-gradient(90deg, rgba(156, 163, 175, 0.12), transparent);';
                    } else if (rank === 3) {
                        rankBadge = '<span style="background: linear-gradient(135deg, #fcd9bd, #f97316); color: #000; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-right: 6px;">🥉 3위</span>';
                        rowStyle = 'background: linear-gradient(90deg, rgba(249, 115, 22, 0.1), transparent);';
                    } else if (rank >= managers.length - 1) {
                        rowStyle = 'background: linear-gradient(90deg, rgba(239, 68, 68, 0.08), transparent);';
                    }

                    // 매출액 강조 (평균 대비)
                    const salesVsAvg = d[1].sales >= avgSales;
                    const salesStyle = salesVsAvg ? 'color: #10b981; font-weight: 600;' : '';

                    // 단가 강조 (평균 대비)
                    const priceVsAvg = avgPrice >= avgPriceAll;
                    const priceStyle = priceVsAvg ? 'background: rgba(16, 185, 129, 0.1); padding: 2px 6px; border-radius: 4px;' : '';

                    // 증감 아이콘
                    const trendIcon = parseFloat(diffRate) >= 10 ? '🔥' : parseFloat(diffRate) <= -10 ? '⚠️' : '';

                    return `<tr style="${rowStyle}">
                        <td>${rankBadge}<strong>${d[0]}</strong></td>
                        <td class="text-right" style="${salesStyle}">${formatCurrency(d[1].sales)}</td>
                        <td class="text-right"><span style="${priceStyle}">${formatCurrency(avgPrice)}</span></td>
                        <td class="text-right" style="color: var(--gray-400);">${formatCurrency(compSales)}</td>
                        <td class="text-right" style="color: var(--gray-400);">${formatCurrency(compAvgPrice)}</td>
                        <td class="text-right"><span class="urgent-badge">🚨 ${urgent}건</span></td>
                        <td class="text-right">${trendIcon}<span class="change-badge ${diff >= 0 ? 'positive' : 'negative'}">${diff >= 0 ? '+' : ''}${diffRate}%</span></td>
                        <td><div class="progress-cell"><div class="progress-bar"><div class="progress-fill" style="width: ${percent}%;"></div></div><span class="progress-value">${percent}%</span></div></td>
                        <td class="text-center"><button class="btn-detail" onclick="showManagerDetail('${d[0]}')">상세</button></td>
                    </tr>`;
                }).join('');
            } else {
                document.getElementById('managerTableHead').innerHTML = `<tr>
                    <th class="${sortClass('name')}" onclick="sortManagerTable('name')">담당자</th>
                    <th class="text-right ${sortClass('sales')}" onclick="sortManagerTable('sales')">매출액</th>
                    <th class="text-right ${sortClass('count')}" onclick="sortManagerTable('count')">건수</th>
                    <th class="text-right ${sortClass('avgPrice')}" onclick="sortManagerTable('avgPrice')">평균단가</th>
                    <th class="text-right ${sortClass('dailyAvg')}" onclick="sortManagerTable('dailyAvg')">일평균</th>
                    <th class="text-right ${sortClass('urgent')}" onclick="sortManagerTable('urgent')">긴급</th>
                    <th class="${sortClass('percent')}" onclick="sortManagerTable('percent')">비중</th>
                    <th class="text-center">상세</th>
                </tr>`;
                // 평균 계산 (강조 기준)
                const avgSalesNo = managers.reduce((s, m) => s + (m[1].sales || 0), 0) / (managers.length || 1);
                const avgPriceAllNo = managers.reduce((s, m) => {
                    const c = m[1].count || 0;
                    return s + (c > 0 ? m[1].sales / c : 0);
                }, 0) / (managers.length || 1);

                tbody.innerHTML = managers.map((d, idx) => {
                    const percent = (d[1].sales / total * 100).toFixed(1);
                    const avgPrice = (d[1].count || 0) > 0 ? d[1].sales / d[1].count : 0;
                    const dailyAvg = d[1].sales / workingDays;
                    const urgent = d[1].urgent || 0;

                    // 순위 배지 & 행 스타일
                    const rank = idx + 1;
                    let rankBadge = '';
                    let rowStyle = '';
                    if (rank === 1) {
                        rankBadge = '<span style="background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #000; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-right: 6px;">🥇 1위</span>';
                        rowStyle = 'background: linear-gradient(90deg, rgba(251, 191, 36, 0.15), transparent);';
                    } else if (rank === 2) {
                        rankBadge = '<span style="background: linear-gradient(135deg, #e5e7eb, #9ca3af); color: #000; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-right: 6px;">🥈 2위</span>';
                        rowStyle = 'background: linear-gradient(90deg, rgba(156, 163, 175, 0.12), transparent);';
                    } else if (rank === 3) {
                        rankBadge = '<span style="background: linear-gradient(135deg, #fcd9bd, #f97316); color: #000; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-right: 6px;">🥉 3위</span>';
                        rowStyle = 'background: linear-gradient(90deg, rgba(249, 115, 22, 0.1), transparent);';
                    } else if (rank >= managers.length - 1) {
                        rowStyle = 'background: linear-gradient(90deg, rgba(239, 68, 68, 0.08), transparent);';
                    }

                    // 매출액 강조 (평균 대비)
                    const salesVsAvg = d[1].sales >= avgSalesNo;
                    const salesStyle = salesVsAvg ? 'color: #10b981; font-weight: 600;' : '';

                    // 단가 강조 (평균 대비)
                    const priceVsAvg = avgPrice >= avgPriceAllNo;
                    const priceStyle = priceVsAvg ? 'background: rgba(16, 185, 129, 0.1); padding: 2px 6px; border-radius: 4px;' : '';

                    return `<tr style="${rowStyle}">
                        <td>${rankBadge}<strong>${d[0]}</strong></td>
                        <td class="text-right" style="${salesStyle}">${formatCurrency(d[1].sales)}</td>
                        <td class="text-right">${(d[1].count || 0).toLocaleString()}</td>
                        <td class="text-right"><span style="${priceStyle}">${formatCurrency(avgPrice)}</span></td>
                        <td class="text-right">${formatCurrency(dailyAvg)}</td>
                        <td class="text-right"><span class="urgent-badge">🚨 ${urgent}건</span></td>
                        <td><div class="progress-cell"><div class="progress-bar"><div class="progress-fill" style="width: ${percent}%;"></div></div><span class="progress-value">${percent}%</span></div></td>
                        <td class="text-center"><button class="btn-detail" onclick="showManagerDetail('${d[0]}')">상세</button></td>
                    </tr>`;
                }).join('');
            }
        }

        function updateBranchTable() {
            const purposeFilter = document.getElementById('branchTablePurposeFilter')?.value || '전체';
            const branches = currentData.by_branch || [];
            const tbody = document.querySelector('#branchTable tbody');

            // 원본 by_branch 데이터 맵 (긴급 데이터 참조용)
            const originalBranchMap = Object.fromEntries((currentData.by_branch || []).map(b => [b[0], b[1]]));

            // 검사목적 필터 적용
            let branchData = branches.map(b => {
                let sales = 0, count = 0, urgent = 0;
                if (purposeFilter === '전체') {
                    sales = b[1].sales || 0;
                    count = b[1].count || 0;
                    urgent = b[1].urgent || 0;
                } else {
                    const purposeData = b[1].by_purpose?.[purposeFilter];
                    if (purposeData) {
                        sales = purposeData.sales || 0;
                        count = purposeData.count || 0;
                    }
                    // 긴급 건수는 원본에서
                    const originalData = originalBranchMap[b[0]] || {};
                    const urgentByPurpose = originalData.urgent_by_purpose || {};
                    urgent = urgentByPurpose[purposeFilter] || 0;
                }
                return { name: b[0], sales, count, urgent, managers: b[1].managers };
            }).filter(d => d.sales > 0);

            // 비교 데이터 맵 생성
            const compareMap = {};
            if (compareData) {
                const compareBranches = compareData.by_branch || [];
                compareBranches.forEach(b => {
                    let sales = 0, count = 0;
                    if (purposeFilter === '전체') {
                        sales = b[1].sales || 0;
                        count = b[1].count || 0;
                    } else {
                        const purposeData = b[1].by_purpose?.[purposeFilter];
                        if (purposeData) {
                            sales = purposeData.sales || 0;
                            count = purposeData.count || 0;
                        }
                    }
                    compareMap[b[0]] = { sales, count };
                });
            }

            // 정렬 적용
            if (branchTableSort.column) {
                const col = branchTableSort.column;
                const dir = branchTableSort.direction === 'asc' ? 1 : -1;
                branchData.sort((a, b) => {
                    let aVal, bVal;
                    const aComp = compareMap[a.name] || {};
                    const bComp = compareMap[b.name] || {};
                    switch(col) {
                        case 'name': aVal = a.name; bVal = b.name; return dir * aVal.localeCompare(bVal);
                        case 'sales': aVal = a.sales || 0; bVal = b.sales || 0; break;
                        case 'count': aVal = a.count || 0; bVal = b.count || 0; break;
                        case 'avgPrice': aVal = (a.count > 0 ? a.sales / a.count : 0); bVal = (b.count > 0 ? b.sales / b.count : 0); break;
                        case 'compSales': aVal = aComp.sales || 0; bVal = bComp.sales || 0; break;
                        case 'compCount': aVal = aComp.count || 0; bVal = bComp.count || 0; break;
                        case 'compAvgPrice': aVal = aComp.count > 0 ? aComp.sales / aComp.count : 0; bVal = bComp.count > 0 ? bComp.sales / bComp.count : 0; break;
                        case 'urgent': aVal = a.urgent || 0; bVal = b.urgent || 0; break;
                        case 'change':
                            const aCompS = aComp.sales || 0;
                            const bCompS = bComp.sales || 0;
                            aVal = aCompS > 0 ? ((a.sales - aCompS) / aCompS * 100) : 0;
                            bVal = bCompS > 0 ? ((b.sales - bCompS) / bCompS * 100) : 0;
                            break;
                        case 'percent':
                            const totalA = branchData.reduce((sum, x) => sum + x.sales, 0) || 1;
                            aVal = a.sales / totalA; bVal = b.sales / totalA;
                            break;
                        default: aVal = a.sales || 0; bVal = b.sales || 0;
                    }
                    return dir * (aVal - bVal);
                });
            } else {
                // 기본 정렬: 매출 내림차순
                branchData.sort((a, b) => b.sales - a.sales);
            }

            const total = branchData.reduce((sum, b) => sum + b.sales, 0) || 1;
            document.getElementById('branchTableBadge').textContent = branchData.length + '개 팀';

            // 정렬 클래스 헬퍼
            const sortClass = (col) => {
                if (branchTableSort.column === col) return `sortable ${branchTableSort.direction}`;
                return 'sortable';
            };

            if (compareData) {
                document.getElementById('branchTableHead').innerHTML = `<tr>
                    <th class="${sortClass('name')}" onclick="sortBranchTable('name')">팀명</th>
                    <th class="text-right ${sortClass('sales')}" onclick="sortBranchTable('sales')">${currentData.year}년</th>
                    <th class="text-right ${sortClass('count')}" onclick="sortBranchTable('count')">건수</th>
                    <th class="text-right ${sortClass('avgPrice')}" onclick="sortBranchTable('avgPrice')">평균단가</th>
                    <th class="text-right ${sortClass('compSales')}" onclick="sortBranchTable('compSales')">${compareData.year}년</th>
                    <th class="text-right ${sortClass('compCount')}" onclick="sortBranchTable('compCount')">건수</th>
                    <th class="text-right ${sortClass('compAvgPrice')}" onclick="sortBranchTable('compAvgPrice')">평균단가</th>
                    <th class="text-right ${sortClass('urgent')}" onclick="sortBranchTable('urgent')">긴급</th>
                    <th class="text-right ${sortClass('change')}" onclick="sortBranchTable('change')">증감</th>
                    <th class="${sortClass('percent')}" onclick="sortBranchTable('percent')">비중</th>
                </tr>`;

                // 평균 계산
                const avgBranchSales = branchData.reduce((s, b) => s + b.sales, 0) / (branchData.length || 1);
                const avgBranchCount = branchData.reduce((s, b) => s + b.count, 0) / (branchData.length || 1);
                const avgBranchPrice = branchData.reduce((s, b) => s + (b.count > 0 ? b.sales / b.count : 0), 0) / (branchData.length || 1);

                tbody.innerHTML = branchData.map((d, idx) => {
                    const compData = compareMap[d.name] || {};
                    const compSales = compData.sales || 0;
                    const compCount = compData.count || 0;
                    const diff = d.sales - compSales;
                    const diffRate = compSales > 0 ? ((diff / compSales) * 100).toFixed(1) : 0;
                    const avgPrice = d.count > 0 ? d.sales / d.count : 0;
                    const compAvgPrice = compCount > 0 ? compSales / compCount : 0;
                    const percent = (d.sales / total * 100).toFixed(1);

                    // 순위 배지 & 행 스타일
                    const rank = idx + 1;
                    let rankBadge = '';
                    let rowStyle = '';
                    if (rank === 1) {
                        rankBadge = '<span style="background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #000; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-right: 6px;">🥇</span>';
                        rowStyle = 'background: linear-gradient(90deg, rgba(251, 191, 36, 0.15), transparent);';
                    } else if (rank === 2) {
                        rankBadge = '<span style="background: linear-gradient(135deg, #e5e7eb, #9ca3af); color: #000; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-right: 6px;">🥈</span>';
                        rowStyle = 'background: linear-gradient(90deg, rgba(156, 163, 175, 0.12), transparent);';
                    } else if (rank === 3) {
                        rankBadge = '<span style="background: linear-gradient(135deg, #fcd9bd, #f97316); color: #000; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-right: 6px;">🥉</span>';
                        rowStyle = 'background: linear-gradient(90deg, rgba(249, 115, 22, 0.1), transparent);';
                    } else if (rank >= branchData.length - 1 && branchData.length > 3) {
                        rowStyle = 'background: linear-gradient(90deg, rgba(239, 68, 68, 0.08), transparent);';
                    }

                    // 매출액 강조
                    const salesStyle = d.sales >= avgBranchSales ? 'color: #10b981; font-weight: 600;' : '';

                    // 건수 강조
                    const countStyle = d.count >= avgBranchCount ? 'color: #6366f1; font-weight: 600;' : '';

                    // 단가 강조
                    const priceStyle = avgPrice >= avgBranchPrice ? 'background: rgba(16, 185, 129, 0.1); padding: 2px 6px; border-radius: 4px;' : '';

                    // 트렌드 아이콘
                    const trendIcon = parseFloat(diffRate) >= 10 ? '🔥' : parseFloat(diffRate) <= -10 ? '⚠️' : '';

                    return `<tr style="${rowStyle}">
                        <td>${rankBadge}<strong>${d.name}</strong></td>
                        <td class="text-right" style="${salesStyle}">${formatCurrency(d.sales)}</td>
                        <td class="text-right" style="${countStyle}">${d.count.toLocaleString()}건</td>
                        <td class="text-right"><span style="${priceStyle}">${formatCurrency(avgPrice)}</span></td>
                        <td class="text-right" style="color: var(--gray-400);">${formatCurrency(compSales)}</td>
                        <td class="text-right" style="color: var(--gray-400);">${compCount.toLocaleString()}건</td>
                        <td class="text-right" style="color: var(--gray-400);">${formatCurrency(compAvgPrice)}</td>
                        <td class="text-right"><span class="urgent-badge">🚨 ${d.urgent}건</span></td>
                        <td class="text-right">${trendIcon}<span class="change-badge ${diff >= 0 ? 'positive' : 'negative'}">${diff >= 0 ? '+' : ''}${diffRate}%</span></td>
                        <td><div class="progress-cell"><div class="progress-bar"><div class="progress-fill" style="width: ${percent}%;"></div></div><span class="progress-value">${percent}%</span></div></td>
                    </tr>`;
                }).join('');
            } else {
                document.getElementById('branchTableHead').innerHTML = `<tr>
                    <th class="${sortClass('name')}" onclick="sortBranchTable('name')">팀명</th>
                    <th class="text-right ${sortClass('sales')}" onclick="sortBranchTable('sales')">매출액</th>
                    <th class="text-right" onclick="sortBranchTable('count')">건수</th>
                    <th class="text-right ${sortClass('avgPrice')}" onclick="sortBranchTable('avgPrice')">평균단가</th>
                    <th class="text-right ${sortClass('urgent')}" onclick="sortBranchTable('urgent')">긴급</th>
                    <th class="${sortClass('percent')}" onclick="sortBranchTable('percent')">비중</th>
                </tr>`;

                // 평균 계산
                const avgBranchSalesNo = branchData.reduce((s, b) => s + b.sales, 0) / (branchData.length || 1);
                const avgBranchPriceNo = branchData.reduce((s, b) => s + (b.count > 0 ? b.sales / b.count : 0), 0) / (branchData.length || 1);

                tbody.innerHTML = branchData.map((d, idx) => {
                    const avgPrice = d.count > 0 ? d.sales / d.count : 0;
                    const percent = (d.sales / total * 100).toFixed(1);

                    // 순위 배지 & 행 스타일
                    const rank = idx + 1;
                    let rankBadge = '';
                    let rowStyle = '';
                    if (rank === 1) {
                        rankBadge = '<span style="background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #000; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-right: 6px;">🥇</span>';
                        rowStyle = 'background: linear-gradient(90deg, rgba(251, 191, 36, 0.15), transparent);';
                    } else if (rank === 2) {
                        rankBadge = '<span style="background: linear-gradient(135deg, #e5e7eb, #9ca3af); color: #000; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-right: 6px;">🥈</span>';
                        rowStyle = 'background: linear-gradient(90deg, rgba(156, 163, 175, 0.12), transparent);';
                    } else if (rank === 3) {
                        rankBadge = '<span style="background: linear-gradient(135deg, #fcd9bd, #f97316); color: #000; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-right: 6px;">🥉</span>';
                        rowStyle = 'background: linear-gradient(90deg, rgba(249, 115, 22, 0.1), transparent);';
                    } else if (rank >= branchData.length - 1 && branchData.length > 3) {
                        rowStyle = 'background: linear-gradient(90deg, rgba(239, 68, 68, 0.08), transparent);';
                    }

                    // 매출액 강조
                    const salesStyle = d.sales >= avgBranchSalesNo ? 'color: #10b981; font-weight: 600;' : '';

                    // 단가 강조
                    const priceStyle = avgPrice >= avgBranchPriceNo ? 'background: rgba(16, 185, 129, 0.1); padding: 2px 6px; border-radius: 4px;' : '';

                    return `<tr style="${rowStyle}">
                        <td>${rankBadge}<strong>${d.name}</strong></td>
                        <td class="text-right" style="${salesStyle}">${formatCurrency(d.sales)}</td>
                        <td class="text-right">${d.count.toLocaleString()}건</td>
                        <td class="text-right"><span style="${priceStyle}">${formatCurrency(avgPrice)}</span></td>
                        <td class="text-right"><span class="urgent-badge">🚨 ${d.urgent}건</span></td>
                        <td><div class="progress-cell"><div class="progress-bar"><div class="progress-fill" style="width: ${percent}%;"></div></div><span class="progress-value">${percent}%</span></div></td>
                    </tr>`;
                }).join('');
            }
        }

        // 업체별 탭 전역 변수
        let clientTableMode = 'new';
        let clientAnalysisData = null;

        function updateClientTab() {
            const clients = currentData.by_client || [];
            const compareClients = compareData?.by_client || [];

            // 비교 데이터로 신규/유지/이탈 분류
            const currentClientMap = Object.fromEntries(clients.map(c => [c[0], c[1]]));
            const compareClientMap = Object.fromEntries(compareClients.map(c => [c[0], c[1]]));

            const newClients = [];      // 신규: 올해만 있음
            const retainedClients = []; // 유지: 양쪽 모두 있음
            const churnedClients = [];  // 이탈: 전년만 있음

            // 현재 연도 업체 분류
            clients.forEach(c => {
                const name = c[0];
                const data = c[1];
                if (compareClientMap[name]) {
                    retainedClients.push({
                        name,
                        ...data,
                        lastYearSales: compareClientMap[name].sales,
                        lastYearCount: compareClientMap[name].count,
                        growth: data.sales - compareClientMap[name].sales,
                        growthRate: compareClientMap[name].sales > 0 ? ((data.sales - compareClientMap[name].sales) / compareClientMap[name].sales * 100) : 0,
                        status: 'retained'
                    });
                } else {
                    newClients.push({ name, ...data, status: 'new' });
                }
            });

            // 이탈 업체 (전년만 있고 올해 없음)
            compareClients.forEach(c => {
                if (!currentClientMap[c[0]]) {
                    churnedClients.push({
                        name: c[0],
                        lastYearSales: c[1].sales,
                        lastYearCount: c[1].count,
                        manager: c[1].manager || '미지정',
                        purpose: c[1].purpose || '',
                        status: 'churned'
                    });
                }
            });

            // VIP 업체 (1억 이상)
            const vipClients = clients.filter(c => c[1].sales >= 100000000);

            // 분석 데이터 저장
            clientAnalysisData = { newClients, retainedClients, churnedClients, vipClients, clients };

            // KPI 업데이트
            document.getElementById('clientTotalCount').textContent = clients.length + '개';
            document.getElementById('clientTotalCompare').textContent = '전년: ' + compareClients.length + '개';
            document.getElementById('clientNewCount').textContent = newClients.length + '개';
            document.getElementById('clientRetainedCount').textContent = retainedClients.length + '개';
            document.getElementById('clientChurnedCount').textContent = churnedClients.length + '개';
            document.getElementById('clientVipCount').textContent = vipClients.length + '개';

            // VIP 업체명 표시
            var vipNames = vipClients.slice(0, 5).map(function(c) { return c[0]; }).join(', ');
            document.getElementById('clientVipNames').textContent = vipNames || '매출 1억 이상';
            document.getElementById('clientVipNames').title = vipClients.map(function(c) { return c[0] + ' (' + formatCurrency(c[1].sales) + ')'; }).join('\\n');

            // 전년 비교 데이터 계산
            var compVipClients = compareClients.filter(function(c) { return c[1].sales >= 100000000; });
            var totalDiff = clients.length - compareClients.length;
            var retainedGrowth = retainedClients.filter(function(r) { return r.growthRate > 0; }).length;
            var retainedDecline = retainedClients.filter(function(r) { return r.growthRate < 0; }).length;
            var vipDiff = vipClients.length - compVipClients.length;

            // KPI 카드 호버 툴팁 설정
            setupClientKpiHover({
                total: { current: clients.length, prev: compareClients.length, diff: totalDiff },
                newC: { current: newClients.length, topClients: newClients.slice(0, 3) },
                retained: { current: retainedClients.length, growth: retainedGrowth, decline: retainedDecline },
                churned: { current: churnedClients.length, topClients: churnedClients.slice(0, 3) },
                vip: { current: vipClients.length, prev: compVipClients.length, diff: vipDiff, clients: vipClients }
            });

            // 담당자별 통계 계산
            updateManagerKPIs(clients, newClients, retainedClients, churnedClients, vipClients, compareClientMap);

            // 차트 업데이트
            updateClientSalesChart(clients, newClients, retainedClients);
            updateClientCountChart(clients, newClients, retainedClients);
            updateClientMonthlyCountChart();
            updateClientEfficiencyTrendChart(clients);

            // 테이블 업데이트
            updateRetainedClientTable(retainedClients);
            updateNewChurnClientTable();
            updateClientByPurposeTable(clients);
            updateClientByManagerTable(clients, newClients, retainedClients, churnedClients, compareClientMap);

            // 버튼 카운트
            document.getElementById('newClientsBtnCount').textContent = newClients.length;
            document.getElementById('churnedClientsBtnCount').textContent = churnedClients.length;

            // 필터 초기화
            populateClientFilters(clients);
        }

        // 필터 드롭다운 초기화
        function populateClientFilters(clients) {
            const managers = new Set();
            const purposes = new Set();

            clients.forEach(c => {
                if (c[1].manager) managers.add(c[1].manager);
                if (c[1].purpose) purposes.add(c[1].purpose);
                if (c[1].byPurpose) {
                    Object.keys(c[1].byPurpose).forEach(p => purposes.add(p));
                }
            });

            const managerSelect = document.getElementById('clientManagerFilter');
            const currentManager = managerSelect.value;
            managerSelect.innerHTML = '<option value="all">전체 담당자</option>' +
                [...managers].sort().map(m => `<option value="${m}">${m}</option>`).join('');
            if (currentManager !== 'all') managerSelect.value = currentManager;

            const purposeSelect = document.getElementById('clientPurposeFilter');
            const currentPurpose = purposeSelect.value;
            purposeSelect.innerHTML = '<option value="all">전체 검사목적</option>' +
                [...purposes].sort().map(p => `<option value="${p}">${p}</option>`).join('');
            if (currentPurpose !== 'all') purposeSelect.value = currentPurpose;
        }

        // 업체 필터링
        function filterClients() {
            if (!clientAnalysisData) return;

            const searchText = document.getElementById('clientSearchInput').value.toLowerCase().trim();
            const statusFilter = document.getElementById('clientStatusFilter').value;
            const managerFilter = document.getElementById('clientManagerFilter').value;
            const purposeFilter = document.getElementById('clientPurposeFilter').value;

            const hasFilter = searchText || statusFilter !== 'all' || managerFilter !== 'all' || purposeFilter !== 'all';

            if (!hasFilter) {
                document.getElementById('clientSearchResultCard').style.display = 'none';
                document.getElementById('clientFilterSummary').style.display = 'none';
                return;
            }

            const { newClients, retainedClients, churnedClients, vipClients } = clientAnalysisData;

            // 모든 업체 통합
            let allClients = [
                ...newClients.map(c => ({ ...c, statusLabel: '🆕 신규', statusKey: 'new' })),
                ...retainedClients.map(c => ({
                    ...c,
                    statusLabel: c.growthRate >= 0 ? '📈 성장' : '📉 감소',
                    statusKey: c.growthRate >= 0 ? 'growth' : 'decline'
                }))
            ];

            // VIP 표시 추가
            allClients = allClients.map(c => ({
                ...c,
                isVip: c.sales >= 100000000,
                statusLabel: c.sales >= 100000000 ? '⭐ VIP' : c.statusLabel
            }));

            // 필터 적용
            let filtered = allClients.filter(c => {
                // 검색어 필터
                if (searchText && !c.name.toLowerCase().includes(searchText)) return false;

                // 상태 필터
                if (statusFilter === 'new' && c.status !== 'new') return false;
                if (statusFilter === 'retained' && c.status !== 'retained') return false;
                if (statusFilter === 'vip' && !c.isVip) return false;
                if (statusFilter === 'growth' && !(c.status === 'retained' && c.growthRate >= 0)) return false;
                if (statusFilter === 'decline' && !(c.status === 'retained' && c.growthRate < 0)) return false;

                // 담당자 필터
                if (managerFilter !== 'all' && c.manager !== managerFilter) return false;

                // 검사목적 필터
                if (purposeFilter !== 'all') {
                    const hasPurpose = c.purpose === purposeFilter ||
                        (c.byPurpose && c.byPurpose[purposeFilter]);
                    if (!hasPurpose) return false;
                }

                return true;
            });

            // 결과 표시
            document.getElementById('clientFilterSummary').style.display = 'block';
            document.getElementById('clientFilterResultText').innerHTML =
                `검색 결과: <strong>${filtered.length}개</strong> 업체` +
                (filtered.length > 0 ? ` | 총 매출: <strong>${formatCurrency(filtered.reduce((s, c) => s + (c.sales || 0), 0))}</strong>` : '');

            // 테이블 표시
            const resultCard = document.getElementById('clientSearchResultCard');
            const tbody = document.querySelector('#clientSearchResultTable tbody');

            if (filtered.length > 0) {
                resultCard.style.display = 'block';
                document.getElementById('clientSearchResultBadge').textContent = filtered.length + '개';

                // 매출 순 정렬
                filtered.sort((a, b) => (b.sales || 0) - (a.sales || 0));

                tbody.innerHTML = filtered.slice(0, 100).map(c => {
                    const growthPct = c.growthRate || 0;
                    const growthColor = growthPct >= 0 ? '#10b981' : '#ef4444';
                    const growthIcon = growthPct >= 0 ? '▲' : '▼';

                    return `<tr style="cursor: pointer;" onclick="showClientDetail('${c.name.replace(/'/g, "\\'")}')">
                        <td style="font-weight: 600;">${c.name}</td>
                        <td>${c.manager || '-'}</td>
                        <td><span style="padding: 2px 8px; border-radius: 4px; font-size: 11px; ${c.isVip ? 'background: #fef3c7; color: #b45309;' : c.status === 'new' ? 'background: #dcfce7; color: #166534;' : 'background: #f1f5f9; color: #475569;'}">${c.statusLabel}</span></td>
                        <td class="text-right" style="font-weight: 600;">${formatCurrency(c.sales || 0)}</td>
                        <td class="text-right" style="color: #94a3b8;">${c.lastYearSales ? formatCurrency(c.lastYearSales) : '-'}</td>
                        <td class="text-right">${c.status === 'retained' ? `<span style="color: ${growthColor};">${growthIcon} ${growthPct >= 0 ? '+' : ''}${growthPct.toFixed(1)}%</span>` : '-'}</td>
                        <td class="text-right">${(c.count || 0).toLocaleString()}건</td>
                        <td style="font-size: 11px; color: #64748b;">${c.purpose || '-'}</td>
                        <td><button class="btn btn-sm" onclick="event.stopPropagation(); showClientDetail('${c.name.replace(/'/g, "\\'")}')">상세</button></td>
                    </tr>`;
                }).join('');
            } else {
                resultCard.style.display = 'none';
            }
        }

        // 필터 초기화
        function resetClientFilters() {
            document.getElementById('clientSearchInput').value = '';
            document.getElementById('clientStatusFilter').value = 'all';
            document.getElementById('clientManagerFilter').value = 'all';
            document.getElementById('clientPurposeFilter').value = 'all';
            document.getElementById('clientSearchResultCard').style.display = 'none';
            document.getElementById('clientFilterSummary').style.display = 'none';
        }

        // 업체 상세 모달
        let clientMonthlyChart = null;
        let clientPurposeChart = null;

        function showClientDetail(clientName) {
            const clients = currentData.by_client || [];
            const compareClients = compareData?.by_client || [];

            const clientEntry = clients.find(c => c[0] === clientName);
            const compareEntry = compareClients.find(c => c[0] === clientName);

            if (!clientEntry) {
                alert('업체 정보를 찾을 수 없습니다.');
                return;
            }

            const client = clientEntry[1];
            const compClient = compareEntry ? compareEntry[1] : null;

            document.getElementById('clientModalTitle').textContent = `🏢 ${clientName}`;
            document.getElementById('clientModal').style.display = 'flex';

            // 기본 정보 카드
            const avgPrice = client.count > 0 ? client.sales / client.count : 0;
            const isVip = client.sales >= 100000000;
            const isNew = !compClient;

            let statusBadge = '';
            if (isVip) statusBadge = '<span style="background: #fef3c7; color: #b45309; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600;">⭐ VIP</span>';
            else if (isNew) statusBadge = '<span style="background: #dcfce7; color: #166534; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600;">🆕 신규</span>';

            document.getElementById('clientModalInfo').innerHTML = `
                <div style="background: linear-gradient(135deg, #eff6ff, #dbeafe); padding: 16px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 12px; color: #3b82f6; margin-bottom: 6px;">총 매출</div>
                    <div style="font-size: 22px; font-weight: 700; color: #1e40af;">${formatCurrency(client.sales)}</div>
                </div>
                <div style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); padding: 16px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 12px; color: #22c55e; margin-bottom: 6px;">총 건수</div>
                    <div style="font-size: 22px; font-weight: 700; color: #166534;">${client.count.toLocaleString()}건</div>
                </div>
                <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 16px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 12px; color: #f59e0b; margin-bottom: 6px;">건당 단가</div>
                    <div style="font-size: 22px; font-weight: 700; color: #b45309;">${formatCurrency(avgPrice)}</div>
                </div>
                <div style="background: linear-gradient(135deg, #f5f3ff, #ede9fe); padding: 16px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 12px; color: #8b5cf6; margin-bottom: 6px;">담당자 ${statusBadge ? '/ 상태' : ''}</div>
                    <div style="font-size: 18px; font-weight: 700; color: #6d28d9;">${client.manager || '미지정'}</div>
                    ${statusBadge ? `<div style="margin-top: 6px;">${statusBadge}</div>` : ''}
                </div>
            `;

            // 전년 비교
            const compareDiv = document.getElementById('clientModalCompare');
            if (compClient) {
                const salesDiff = client.sales - compClient.sales;
                const salesPct = compClient.sales > 0 ? (salesDiff / compClient.sales * 100) : 0;
                const countDiff = client.count - compClient.count;
                const countPct = compClient.count > 0 ? (countDiff / compClient.count * 100) : 0;
                const salesColor = salesDiff >= 0 ? '#10b981' : '#ef4444';
                const countColor = countDiff >= 0 ? '#10b981' : '#ef4444';

                compareDiv.style.display = 'block';
                compareDiv.innerHTML = `
                    <div style="background: #f8fafc; border-radius: 12px; padding: 16px;">
                        <h4 style="font-size: 14px; color: #475569; margin-bottom: 12px;">📊 전년 대비 비교 (${compareData?.year || '전년'})</h4>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; text-align: center;">
                            <div>
                                <div style="font-size: 11px; color: #94a3b8;">전년 매출</div>
                                <div style="font-size: 16px; font-weight: 600; color: #64748b;">${formatCurrency(compClient.sales)}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #94a3b8;">매출 증감</div>
                                <div style="font-size: 16px; font-weight: 700; color: ${salesColor};">${salesDiff >= 0 ? '▲' : '▼'} ${salesPct >= 0 ? '+' : ''}${salesPct.toFixed(1)}%</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #94a3b8;">전년 건수</div>
                                <div style="font-size: 16px; font-weight: 600; color: #64748b;">${compClient.count.toLocaleString()}건</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #94a3b8;">건수 증감</div>
                                <div style="font-size: 16px; font-weight: 700; color: ${countColor};">${countDiff >= 0 ? '▲' : '▼'} ${countPct >= 0 ? '+' : ''}${countPct.toFixed(1)}%</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                compareDiv.style.display = 'none';
            }

            // 월별 추이 차트
            const monthlyCtx = document.getElementById('clientMonthlyChart').getContext('2d');
            if (clientMonthlyChart) clientMonthlyChart.destroy();

            const monthLabels = ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'];
            const byMonth = client.byMonth || {};
            const compByMonth = compClient?.byMonth || {};

            const datasets = [{
                label: currentData.year + '년',
                data: monthLabels.map((_, i) => byMonth[i + 1]?.sales || 0),
                backgroundColor: 'rgba(99, 102, 241, 0.2)',
                borderColor: '#6366f1',
                borderWidth: 2,
                fill: true,
                tension: 0.3
            }];

            if (compClient) {
                datasets.push({
                    label: compareData.year + '년',
                    data: monthLabels.map((_, i) => compByMonth[i + 1]?.sales || 0),
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    borderColor: '#f59e0b',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.3
                });
            }

            clientMonthlyChart = new Chart(monthlyCtx, {
                type: 'line',
                data: { labels: monthLabels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: v => formatCurrency(v) }
                        }
                    }
                }
            });

            // 검사목적별 도넛 차트
            const purposeCtx = document.getElementById('clientPurposeChart').getContext('2d');
            if (clientPurposeChart) clientPurposeChart.destroy();

            const byPurpose = client.byPurpose || {};
            const purposeEntries = Object.entries(byPurpose).sort((a, b) => b[1].sales - a[1].sales);
            const purposeLabels = purposeEntries.map(e => e[0]);
            const purposeValues = purposeEntries.map(e => e[1].sales);

            clientPurposeChart = new Chart(purposeCtx, {
                type: 'doughnut',
                data: {
                    labels: purposeLabels,
                    datasets: [{ data: purposeValues, backgroundColor: ['#6366f1', '#8b5cf6', '#a855f7', '#d946ef', '#ec4899', '#f43f5e', '#f59e0b', '#22c55e'] }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            // 검사목적별 테이블
            document.getElementById('clientPurposeTable').innerHTML = `
                <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                    ${purposeEntries.map(([p, d]) => `
                        <tr style="border-bottom: 1px solid #f1f5f9;">
                            <td style="padding: 6px 4px;">${p}</td>
                            <td style="padding: 6px 4px; text-align: right; font-weight: 600;">${formatCurrency(d.sales)}</td>
                            <td style="padding: 6px 4px; text-align: right; color: #64748b;">${d.count}건</td>
                            <td style="padding: 6px 4px; text-align: right; color: #94a3b8;">${(d.sales / client.sales * 100).toFixed(0)}%</td>
                        </tr>
                    `).join('')}
                </table>
            `;
        }

        function closeClientModal() {
            document.getElementById('clientModal').style.display = 'none';
        }

        // 모달 외부 클릭 시 닫기
        document.getElementById('clientModal')?.addEventListener('click', function(e) {
            if (e.target === this) closeClientModal();
        });

        function updateManagerKPIs(clients, newClients, retainedClients, churnedClients, vipClients, compareClientMap) {
            // 담당자별 집계
            const managerStats = {};

            clients.forEach(c => {
                const manager = c[1].manager || '미지정';
                if (!managerStats[manager]) {
                    managerStats[manager] = {
                        totalClients: 0, newClients: 0, retainedClients: 0, vipClients: 0,
                        totalSales: 0, lastYearSales: 0, totalTradeMonths: 0, activeClients: 0
                    };
                }
                managerStats[manager].totalClients++;
                managerStats[manager].totalSales += c[1].sales;
                managerStats[manager].totalTradeMonths += c[1].tradeMonths || 0;
                if (c[1].count >= 36) managerStats[manager].activeClients++;  // 월3회 이상
                if (c[1].sales >= 100000000) managerStats[manager].vipClients++;
            });

            newClients.forEach(c => {
                const manager = c.manager || '미지정';
                if (managerStats[manager]) managerStats[manager].newClients++;
            });

            retainedClients.forEach(c => {
                const manager = c.manager || '미지정';
                if (managerStats[manager]) {
                    managerStats[manager].retainedClients++;
                    managerStats[manager].lastYearSales += c.lastYearSales || 0;
                }
            });

            // 이탈 업체 담당자별 집계
            const churnByManager = {};
            churnedClients.forEach(c => {
                const manager = c.manager || '미지정';
                if (!churnByManager[manager]) churnByManager[manager] = 0;
                churnByManager[manager]++;
            });

            // 배열로 변환 및 정렬
            const managerArray = Object.entries(managerStats).map(([name, stats]) => ({
                name,
                ...stats,
                avgTradeMonths: stats.totalClients > 0 ? stats.totalTradeMonths / stats.totalClients : 0,
                activeRate: stats.totalClients > 0 ? (stats.activeClients / stats.totalClients * 100) : 0,
                salesGrowth: stats.totalSales - stats.lastYearSales,
                retentionRate: (stats.retainedClients + stats.newClients) > 0 ? (stats.retainedClients / (stats.retainedClients + (churnByManager[name] || 0)) * 100) : 0,
                churnedClients: churnByManager[name] || 0
            }));

            // 평균 계산
            const avgClients = managerArray.reduce((s, m) => s + m.totalClients, 0) / (managerArray.length || 1);
            const avgNew = managerArray.reduce((s, m) => s + m.newClients, 0) / (managerArray.length || 1);
            const avgGrowth = managerArray.reduce((s, m) => s + m.salesGrowth, 0) / (managerArray.length || 1);
            const avgVip = managerArray.reduce((s, m) => s + m.vipClients, 0) / (managerArray.length || 1);
            const avgRetention = managerArray.reduce((s, m) => s + m.retentionRate, 0) / (managerArray.length || 1);
            const avgTradeMonths = managerArray.reduce((s, m) => s + m.avgTradeMonths, 0) / (managerArray.length || 1);
            const avgActiveRate = managerArray.reduce((s, m) => s + m.activeRate, 0) / (managerArray.length || 1);
            const avgChurn = managerArray.reduce((s, m) => s + m.churnedClients, 0) / (managerArray.length || 1);

            // KPI 카드 업데이트 함수
            const updateKpiCard = (id, data, valueFormatter, avgValue, isLowerBetter = false) => {
                const sorted = [...data].sort((a, b) => isLowerBetter ? a.value - b.value : b.value - a.value);
                const qualified = sorted.filter(d => isLowerBetter ? d.value <= avgValue : d.value >= avgValue);

                const nameEl = document.getElementById(id + 'Name');
                const valueEl = document.getElementById(id + 'Value');

                if (qualified.length === 0) {
                    nameEl.textContent = '-';
                    valueEl.textContent = '-';
                } else if (qualified.length === 1) {
                    nameEl.textContent = qualified[0].name;
                    valueEl.textContent = valueFormatter(qualified[0].value);
                } else {
                    nameEl.textContent = qualified[0].name + ' 외 ' + (qualified.length - 1) + '명';
                    valueEl.textContent = '평균 ' + valueFormatter(avgValue) + '↑';
                }

                // 오버레이 생성
                const overlay = document.getElementById(id + 'Overlay');
                if (overlay) {
                    overlay.innerHTML = `
                        <div style="font-weight: 600; margin-bottom: 8px;">평균: ${valueFormatter(avgValue)}</div>
                        <div style="border-top: 1px dashed #e2e8f0; margin: 8px 0;"></div>
                        ${sorted.map((d, i) => {
                            const isAboveAvg = isLowerBetter ? d.value <= avgValue : d.value >= avgValue;
                            return `<div style="display: flex; justify-content: space-between; padding: 4px 0; ${i === sorted.findIndex(x => isLowerBetter ? x.value > avgValue : x.value < avgValue) ? 'border-top: 1px dashed #94a3b8; margin-top: 4px; padding-top: 8px;' : ''}">
                                <span>${i + 1}. ${d.name}</span>
                                <span>${valueFormatter(d.value)} ${isAboveAvg ? '⭐' : ''}</span>
                            </div>`;
                        }).join('')}
                    `;
                }
            };

            // 각 KPI 업데이트
            updateKpiCard('kpiClientKing', managerArray.map(m => ({ name: m.name, value: m.totalClients })), v => Math.round(v) + '개', avgClients);
            updateKpiCard('kpiNewKing', managerArray.map(m => ({ name: m.name, value: m.newClients })), v => Math.round(v) + '개 유치', avgNew);
            updateKpiCard('kpiGrowthKing', managerArray.map(m => ({ name: m.name, value: m.salesGrowth })), v => (v >= 0 ? '+' : '') + formatCurrency(v), avgGrowth);
            updateKpiCard('kpiVipKing', managerArray.map(m => ({ name: m.name, value: m.vipClients })), v => (v % 1 === 0 ? v : v.toFixed(1)) + '개 VIP', avgVip);
            updateKpiCard('kpiRetentionKing', managerArray.map(m => ({ name: m.name, value: m.retentionRate })), v => v.toFixed(0) + '% 유지', avgRetention);
            updateKpiCard('kpiSteadyKing', managerArray.map(m => ({ name: m.name, value: m.avgTradeMonths })), v => v.toFixed(1) + '월', avgTradeMonths);
            updateKpiCard('kpiActiveKing', managerArray.map(m => ({ name: m.name, value: m.activeRate })), v => v.toFixed(0) + '% 활성', avgActiveRate);
            updateKpiCard('kpiChurnWarning', managerArray.map(m => ({ name: m.name, value: m.churnedClients })), v => Math.round(v) + '개 이탈', avgChurn, true);

            // 오버레이 이벤트 등록 (다크 테마로 개선)
            document.querySelectorAll('.manager-kpi-card').forEach(card => {
                const overlay = card.querySelector('.manager-kpi-overlay');
                if (overlay) {
                    card.addEventListener('mouseenter', () => {
                        overlay.style.display = 'block';
                        overlay.style.position = 'absolute';
                        overlay.style.top = '100%';
                        overlay.style.left = '50%';
                        overlay.style.transform = 'translateX(-50%)';
                        overlay.style.marginTop = '8px';
                        overlay.style.width = '240px';
                        overlay.style.background = 'rgba(30, 41, 59, 0.98)';
                        overlay.style.border = 'none';
                        overlay.style.borderRadius = '12px';
                        overlay.style.padding = '14px';
                        overlay.style.boxShadow = '0 15px 40px rgba(0,0,0,0.35)';
                        overlay.style.zIndex = '1000';
                        overlay.style.fontSize = '12px';
                        overlay.style.color = '#e2e8f0';
                        overlay.style.lineHeight = '1.5';
                    });
                    card.addEventListener('mouseleave', () => { overlay.style.display = 'none'; });
                }
            });
        }

        // KPI 카드 호버 툴팁 설정 함수
        function setupClientKpiHover(data) {
            var cards = [
                { id: 'kpiTotalCard', content: function() {
                    var sign = data.total.diff >= 0 ? '+' : '';
                    return '<div style="background:rgba(30,41,59,0.98);padding:14px;border-radius:10px;color:#e2e8f0;font-size:12px;min-width:200px;">' +
                        '<div style="font-weight:700;margin-bottom:8px;color:#fff;font-size:14px;">총 거래업체 현황</div>' +
                        '<div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>올해:</span><span style="font-weight:600;">' + data.total.current + '개</span></div>' +
                        '<div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>전년:</span><span style="font-weight:600;">' + data.total.prev + '개</span></div>' +
                        '<div style="display:flex;justify-content:space-between;color:' + (data.total.diff >= 0 ? '#10b981' : '#ef4444') + ';font-weight:700;"><span>증감:</span><span>' + sign + data.total.diff + '개</span></div>' +
                    '</div>';
                }},
                { id: 'kpiNewCard', content: function() {
                    var topList = data.newC.topClients.map(function(c) {
                        return '<div style="display:flex;justify-content:space-between;margin-bottom:2px;"><span>' + c.name.substring(0, 12) + '</span><span style="color:#10b981;">' + formatCurrency(c.sales) + '</span></div>';
                    }).join('');
                    return '<div style="background:rgba(30,41,59,0.98);padding:14px;border-radius:10px;color:#e2e8f0;font-size:12px;min-width:220px;">' +
                        '<div style="font-weight:700;margin-bottom:8px;color:#fff;font-size:14px;">신규 업체 TOP 3</div>' +
                        (topList || '<div style="color:#94a3b8;">신규 업체 없음</div>') +
                    '</div>';
                }},
                { id: 'kpiRetainedCard', content: function() {
                    return '<div style="background:rgba(30,41,59,0.98);padding:14px;border-radius:10px;color:#e2e8f0;font-size:12px;min-width:200px;">' +
                        '<div style="font-weight:700;margin-bottom:8px;color:#fff;font-size:14px;">유지 업체 현황</div>' +
                        '<div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>총 유지업체:</span><span style="font-weight:600;">' + data.retained.current + '개</span></div>' +
                        '<div style="display:flex;justify-content:space-between;margin-bottom:4px;color:#10b981;"><span>📈 성장:</span><span style="font-weight:600;">' + data.retained.growth + '개</span></div>' +
                        '<div style="display:flex;justify-content:space-between;color:#ef4444;"><span>📉 하락:</span><span style="font-weight:600;">' + data.retained.decline + '개</span></div>' +
                    '</div>';
                }},
                { id: 'kpiChurnedCard', content: function() {
                    var topList = data.churned.topClients.map(function(c) {
                        return '<div style="display:flex;justify-content:space-between;margin-bottom:2px;"><span>' + (c.name || c[0] || '').substring(0, 12) + '</span><span style="color:#ef4444;">' + formatCurrency(c.lastYearSales || c[1]?.sales || 0) + '</span></div>';
                    }).join('');
                    return '<div style="background:rgba(30,41,59,0.98);padding:14px;border-radius:10px;color:#e2e8f0;font-size:12px;min-width:220px;">' +
                        '<div style="font-weight:700;margin-bottom:8px;color:#fff;font-size:14px;">이탈 업체 (전년 매출 TOP)</div>' +
                        (topList || '<div style="color:#94a3b8;">이탈 업체 없음</div>') +
                    '</div>';
                }},
                { id: 'kpiVipCard', content: function() {
                    var sign = data.vip.diff >= 0 ? '+' : '';
                    var vipList = data.vip.clients.slice(0, 5).map(function(c) {
                        return '<div style="display:flex;justify-content:space-between;margin-bottom:2px;"><span style="color:#fbbf24;">⭐ ' + c[0].substring(0, 10) + '</span><span style="font-weight:600;">' + formatCurrency(c[1].sales) + '</span></div>';
                    }).join('');
                    return '<div style="background:rgba(30,41,59,0.98);padding:14px;border-radius:10px;color:#e2e8f0;font-size:12px;min-width:240px;">' +
                        '<div style="font-weight:700;margin-bottom:8px;color:#fff;font-size:14px;">VIP 업체 (매출 1억 이상)</div>' +
                        '<div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>올해:</span><span style="font-weight:600;">' + data.vip.current + '개</span></div>' +
                        '<div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span>전년:</span><span style="font-weight:600;">' + data.vip.prev + '개 (' + sign + data.vip.diff + ')</span></div>' +
                        '<div style="border-top:1px solid #475569;padding-top:8px;">' + (vipList || '<div style="color:#94a3b8;">VIP 업체 없음</div>') + '</div>' +
                    '</div>';
                }}
            ];

            cards.forEach(function(cardInfo) {
                var card = document.getElementById(cardInfo.id);
                if (!card) return;

                var tooltip = null;
                card.addEventListener('mouseenter', function(e) {
                    if (tooltip) tooltip.remove();
                    tooltip = document.createElement('div');
                    tooltip.innerHTML = cardInfo.content();
                    tooltip.style.cssText = 'position:absolute;top:100%;left:50%;transform:translateX(-50%);margin-top:8px;z-index:1000;';
                    card.appendChild(tooltip);
                });
                card.addEventListener('mouseleave', function() {
                    if (tooltip) { tooltip.remove(); tooltip = null; }
                });
            });
        }

        // 효율 분류별 월별 추세 차트 (고효율/중간/저효율 업체)
        function updateClientEfficiencyTrendChart(clients) {
            var ctx = document.getElementById('clientEfficiencyTrendChart');
            if (!ctx) return;
            if (charts.clientEfficiencyTrend) charts.clientEfficiencyTrend.destroy();

            // 월별 데이터 (by_month는 [월번호, 데이터객체] 배열)
            var monthlyData = currentData.by_month || [];

            // 3개월 이상 지속 거래 업체만 필터링 (테이블용)
            var sustainedClients = clients.filter(function(c) { return (c[1].tradeMonths || 0) >= 3; });

            // 전체 평균 건당 단가 계산
            var totalSales = clients.reduce(function(s, c) { return s + c[1].sales; }, 0);
            var totalCount = clients.reduce(function(s, c) { return s + c[1].count; }, 0);
            var avgPerCase = totalCount > 0 ? totalSales / totalCount : 0;

            // 효율 분류 기준
            var lowThreshold = avgPerCase * 0.7;
            var highThreshold = avgPerCase * 1.3;
            var avgCount = sustainedClients.length > 0 ? totalCount / sustainedClients.length : 0;

            // 업체별 건당 단가 계산 및 효율 분류
            var highList = [], midList = [], lowList = [];
            var highClients = 0, midClients = 0, lowClients = 0;

            clients.forEach(function(c) {
                var perCase = c[1].count > 0 ? c[1].sales / c[1].count : 0;
                if (perCase >= avgPerCase) {
                    highClients++;
                } else if (perCase >= avgPerCase * 0.7) {
                    midClients++;
                } else {
                    lowClients++;
                }
            });

            // clientEfficiencyTrendSummary 요약 정보 표시
            var effTrendSummaryEl = document.getElementById('clientEfficiencyTrendSummary');
            if (effTrendSummaryEl) {
                var totalClientsEff = clients.length;
                var effHtml = '<span style="white-space:nowrap;background:#dbeafe;padding:4px 10px;border-radius:4px;color:#1e40af;">총업체: <strong style="color:#3b82f6;">' + totalClientsEff + '개</strong></span>';
                effHtml += '<span style="white-space:nowrap;background:#d1fae5;padding:4px 10px;border-radius:4px;color:#059669;">고효율: <strong>' + highClients + '개</strong></span>';
                effHtml += '<span style="white-space:nowrap;background:#fef3c7;padding:4px 10px;border-radius:4px;color:#92400e;">중효율: <strong>' + midClients + '개</strong></span>';
                effHtml += '<span style="white-space:nowrap;background:#fee2e2;padding:4px 10px;border-radius:4px;color:#dc2626;">저효율: <strong>' + lowClients + '개</strong></span>';
                effTrendSummaryEl.innerHTML = effHtml;
            }

            // 3개월 이상 지속 거래 업체 효율 분류 (테이블용)
            sustainedClients.forEach(function(c) {
                var clientAvgPrice = c[1].count > 0 ? c[1].sales / c[1].count : 0;
                var clientData = {
                    name: c[0],
                    count: c[1].count,
                    sales: c[1].sales,
                    avgPrice: clientAvgPrice,
                    manager: c[1].manager || '미지정'
                };

                if (clientAvgPrice < lowThreshold && c[1].count >= avgCount) {
                    lowList.push(clientData);
                } else if (clientAvgPrice > highThreshold) {
                    highList.push(clientData);
                } else {
                    midList.push(clientData);
                }
            });

            // 정렬
            lowList.sort(function(a, b) { return a.avgPrice - b.avgPrice; });
            midList.sort(function(a, b) { return b.sales - a.sales; });
            highList.sort(function(a, b) { return b.avgPrice - a.avgPrice; });

            // 배지 업데이트
            document.getElementById('lowEfficiencyBadge').textContent = lowList.length + '개';
            document.getElementById('midEfficiencyBadge').textContent = midList.length + '개';
            document.getElementById('highEfficiencyBadge').textContent = highList.length + '개';

            // 테이블 렌더링 함수
            var renderTable = function(tableId, data) {
                var tbody = document.querySelector('#' + tableId + ' tbody');
                if (!tbody) return;
                tbody.innerHTML = data.slice(0, 15).map(function(d) {
                    var priceColor = d.avgPrice < lowThreshold ? '#ef4444' :
                                    d.avgPrice > highThreshold ? '#10b981' : '#64748b';
                    return '<tr>' +
                        '<td title="' + d.manager + '">' + (d.name.length > 12 ? d.name.substring(0, 12) + '..' : d.name) + '</td>' +
                        '<td class="text-right">' + d.count.toLocaleString() + '</td>' +
                        '<td class="text-right" style="color:' + priceColor + ';font-weight:600;">' + formatCurrency(d.avgPrice) + '</td>' +
                        '<td class="text-right">' + formatCurrency(d.sales) + '</td>' +
                    '</tr>';
                }).join('');
            };

            renderTable('lowEfficiencyTable', lowList);
            renderTable('midEfficiencyTable', midList);
            renderTable('highEfficiencyTable', highList);

            // 월별 차트 데이터가 없으면 차트 생성 스킵
            if (monthlyData.length === 0) return;

            // 전체 비율 계산
            var totalClientCount = clients.length || 1;
            var highRatio = highClients / totalClientCount;
            var midRatio = midClients / totalClientCount;
            var lowRatio = lowClients / totalClientCount;

            // 월별로 효율 분류별 업체 수 집계 (비율 기반 추정)
            var labels = [];
            var highData = [];
            var midData = [];
            var lowData = [];

            monthlyData.forEach(function(m) {
                var month = m[0];  // 월 번호
                var data = m[1];   // 데이터 객체
                labels.push(month + '월');

                // 해당 월의 총 업체 수
                var monthlyClientCount = data.clientCount || 0;

                // 비율에 따라 분배
                var highCount = Math.round(monthlyClientCount * highRatio);
                var midCount = Math.round(monthlyClientCount * midRatio);
                var lowCount = monthlyClientCount - highCount - midCount;

                highData.push(highCount);
                midData.push(midCount);
                lowData.push(Math.max(0, lowCount));
            });

            // 배지 업데이트
            document.getElementById('efficiencyTrendBadge').textContent = '고' + highClients + ' / 중' + midClients + ' / 저' + lowClients;

            // 외부 툴팁 생성 함수
            var getOrCreateEffTrendTooltip = function() {
                var el = document.getElementById('efficiencyTrendTooltip');
                if (!el) {
                    el = document.createElement('div');
                    el.id = 'efficiencyTrendTooltip';
                    el.style.cssText = 'position:fixed;background:rgba(30,41,59,0.98);border-radius:12px;padding:16px;pointer-events:auto;z-index:99999;font-size:13px;color:#e2e8f0;box-shadow:0 20px 40px rgba(0,0,0,0.4);min-width:260px;max-width:340px;max-height:85vh;overflow-y:auto;transition:opacity 0.15s ease;line-height:1.5;';
                    document.body.appendChild(el);
                    setupTooltipHover(el);
                }
                return el;
            };

            charts.clientEfficiencyTrend = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '고효율 업체',
                            data: highData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.15)',
                            borderWidth: 3,
                            tension: 0.3,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 8
                        },
                        {
                            label: '중간 효율',
                            data: midData,
                            borderColor: '#eab308',
                            backgroundColor: 'rgba(234, 179, 8, 0.15)',
                            borderWidth: 3,
                            tension: 0.3,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 8
                        },
                        {
                            label: '저효율 업체',
                            data: lowData,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.15)',
                            borderWidth: 3,
                            tension: 0.3,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 8
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            enabled: false,
                            external: function(context) {
                                var tooltipEl = getOrCreateEffTrendTooltip();
                                if (context.tooltip.opacity === 0 && !isTooltipHovered(tooltipEl)) {
                                    hideTooltipWithDelay(tooltipEl);
                                    return;
                                }

                                var dataPoints = context.tooltip.dataPoints;
                                if (!dataPoints || dataPoints.length === 0) return;

                                var monthIdx = dataPoints[0].dataIndex;
                                var month = labels[monthIdx];
                                var high = highData[monthIdx];
                                var mid = midData[monthIdx];
                                var low = lowData[monthIdx];
                                var total = high + mid + low;

                                // 이전 월 데이터 (추세 비교용)
                                var prevHigh = monthIdx > 0 ? highData[monthIdx - 1] : 0;
                                var prevMid = monthIdx > 0 ? midData[monthIdx - 1] : 0;
                                var prevLow = monthIdx > 0 ? lowData[monthIdx - 1] : 0;
                                var prevTotal = prevHigh + prevMid + prevLow;

                                var html = '';

                                // 헤더
                                html += '<div style="font-size:16px;font-weight:bold;color:#fff;margin:-16px -16px 12px -16px;padding:12px 16px;background:linear-gradient(135deg, rgba(99, 102, 241, 0.3), rgba(79, 70, 229, 0.2));border-radius:10px 10px 0 0;display:flex;justify-content:space-between;align-items:center;">';
                                html += '<span>📊 ' + currentData.year + '년 ' + month + '</span>';
                                html += '<span style="background:rgba(99,102,241,0.4);color:#a5b4fc;padding:4px 10px;border-radius:6px;font-size:12px;">' + total + '개 업체</span>';
                                html += '</div>';

                                // 효율 분류 현황
                                html += '<div style="color:#94a3b8;margin-bottom:8px;">── 효율 분류 현황 ──</div>';
                                html += '<div style="display:flex;justify-content:space-between;margin-bottom:6px;padding:8px 10px;background:rgba(16,185,129,0.2);border-radius:6px;border-left:3px solid #10b981;">';
                                html += '<span style="color:#10b981;font-weight:600;">🌟 고효율 (평균 이상)</span>';
                                html += '<span style="font-weight:600;">' + high + '개 <span style="color:#94a3b8;">(' + (total > 0 ? Math.round(high/total*100) : 0) + '%)</span></span>';
                                html += '</div>';
                                html += '<div style="display:flex;justify-content:space-between;margin-bottom:6px;padding:8px 10px;background:rgba(234,179,8,0.2);border-radius:6px;border-left:3px solid #eab308;">';
                                html += '<span style="color:#eab308;font-weight:600;">📊 중간 (평균 ±30%)</span>';
                                html += '<span style="font-weight:600;">' + mid + '개 <span style="color:#94a3b8;">(' + (total > 0 ? Math.round(mid/total*100) : 0) + '%)</span></span>';
                                html += '</div>';
                                html += '<div style="display:flex;justify-content:space-between;margin-bottom:8px;padding:8px 10px;background:rgba(239,68,68,0.2);border-radius:6px;border-left:3px solid #ef4444;">';
                                html += '<span style="color:#ef4444;font-weight:600;">⚠️ 저효율 (평균 미만)</span>';
                                html += '<span style="font-weight:600;">' + low + '개 <span style="color:#94a3b8;">(' + (total > 0 ? Math.round(low/total*100) : 0) + '%)</span></span>';
                                html += '</div>';

                                // 전월 대비 변화
                                if (monthIdx > 0 && prevTotal > 0) {
                                    html += '<div style="color:#94a3b8;margin:12px 0 8px;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.2);">── 전월 대비 변화 ──</div>';
                                    var highDiff = high - prevHigh;
                                    var midDiff = mid - prevMid;
                                    var lowDiff = low - prevLow;
                                    var highColor = highDiff >= 0 ? '#10b981' : '#ef4444';
                                    var midColor = midDiff >= 0 ? '#eab308' : '#94a3b8';
                                    var lowColor = lowDiff <= 0 ? '#10b981' : '#ef4444';
                                    html += '<div style="margin-bottom:4px;">🌟 고효율: <span style="color:' + highColor + ';font-weight:bold;">' + (highDiff >= 0 ? '+' : '') + highDiff + '개</span></div>';
                                    html += '<div style="margin-bottom:4px;">📊 중간: <span style="color:' + midColor + ';font-weight:bold;">' + (midDiff >= 0 ? '+' : '') + midDiff + '개</span></div>';
                                    html += '<div style="margin-bottom:4px;">⚠️ 저효율: <span style="color:' + lowColor + ';font-weight:bold;">' + (lowDiff >= 0 ? '+' : '') + lowDiff + '개</span></div>';
                                }

                                // 효율 비율 바
                                html += '<div style="color:#94a3b8;margin:12px 0 8px;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.2);">── 효율 분포 ──</div>';
                                html += '<div style="display:flex;height:12px;border-radius:6px;overflow:hidden;margin-bottom:4px;">';
                                if (total > 0) {
                                    html += '<div style="width:' + (high/total*100) + '%;background:#10b981;" title="고효율"></div>';
                                    html += '<div style="width:' + (mid/total*100) + '%;background:#eab308;" title="중간"></div>';
                                    html += '<div style="width:' + (low/total*100) + '%;background:#ef4444;" title="저효율"></div>';
                                }
                                html += '</div>';
                                html += '<div style="display:flex;justify-content:space-between;font-size:10px;color:#94a3b8;">';
                                html += '<span>● 고효율 ' + (total > 0 ? Math.round(high/total*100) : 0) + '%</span>';
                                html += '<span>● 중간 ' + (total > 0 ? Math.round(mid/total*100) : 0) + '%</span>';
                                html += '<span>● 저효율 ' + (total > 0 ? Math.round(low/total*100) : 0) + '%</span>';
                                html += '</div>';

                                // 기준 정보
                                html += '<div style="margin-top:12px;padding-top:8px;border-top:1px solid #475569;font-size:11px;color:#94a3b8;">';
                                html += '📌 분류 기준: 건당단가 <strong>' + formatCurrency(avgPerCase) + '</strong>';
                                html += '</div>';

                                tooltipEl.innerHTML = html;
                                tooltipEl.style.border = '2px solid rgba(99, 102, 241, 0.6)';
                                tooltipEl.style.opacity = '1';
                                tooltipEl.style.display = 'block';

                                var pos = context.chart.canvas.getBoundingClientRect();
                                tooltipEl.style.left = Math.min(pos.left + context.tooltip.caretX + 15, window.innerWidth - 370) + 'px';
                                tooltipEl.style.top = Math.min(pos.top + context.tooltip.caretY - 10, window.innerHeight - 450) + 'px';
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.06)' },
                            ticks: { color: '#94a3b8' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });
        }

        function updateClientSalesChart(clients, newClients, retainedClients) {
            const top10 = clients.slice(0, 10);
            const newClientNames = new Set(newClients.map(c => c.name));
            const retainedMap = Object.fromEntries(retainedClients.map(c => [c.name, c]));
            const totalSales = clients.reduce((s, c) => s + c[1].sales, 0);
            const totalCount = clients.reduce((s, c) => s + c[1].count, 0);
            const avgClientSales = clients.length > 0 ? totalSales / clients.length : 0;
            const avgClientCount = clients.length > 0 ? totalCount / clients.length : 0;
            const hasCompare = compareData && compareData.by_client;
            const compareClientMap = hasCompare ? Object.fromEntries(compareData.by_client.map(c => [c[0], c[1]])) : {};
            const compTotalSales = hasCompare ? compareData.by_client.reduce((s, c) => s + c[1].sales, 0) : 0;

            document.getElementById('clientSalesChartBadge').textContent = hasCompare ?
                `${currentData.year} vs ${compareData.year}` : currentData.year + '년';

            // clientSalesChartSummary 요약 정보 표시
            const salesSummaryEl = document.getElementById('clientSalesChartSummary');
            if (salesSummaryEl) {
                const avgPrice = totalCount > 0 ? totalSales / totalCount : 0;
                const top10Sales = top10.reduce((s, c) => s + c[1].sales, 0);
                const top10Ratio = totalSales > 0 ? (top10Sales / totalSales * 100) : 0;
                let csHtml = `<span style="white-space:nowrap;background:#dbeafe;padding:4px 10px;border-radius:4px;color:#1e40af;">총매출: <strong style="color:#3b82f6;">${(totalSales / 100000000).toFixed(1)}억</strong></span>`;
                if (hasCompare && compTotalSales > 0) {
                    const salesGrowth = ((totalSales - compTotalSales) / compTotalSales * 100);
                    const growthColor = salesGrowth >= 0 ? '#059669' : '#dc2626';
                    csHtml += `<span style="white-space:nowrap;background:${salesGrowth >= 0 ? '#d1fae5' : '#fee2e2'};padding:4px 10px;border-radius:4px;color:${growthColor};">전년비: <strong>${salesGrowth >= 0 ? '+' : ''}${salesGrowth.toFixed(1)}%</strong></span>`;
                }
                csHtml += `<span style="white-space:nowrap;background:#e0e7ff;padding:4px 10px;border-radius:4px;color:#3730a3;">업체수: <strong>${clients.length.toLocaleString()}개</strong></span>`;
                csHtml += `<span style="white-space:nowrap;background:#fef08a;padding:4px 10px;border-radius:4px;color:#854d0e;">TOP10비중: <strong>${top10Ratio.toFixed(1)}%</strong></span>`;
                salesSummaryEl.innerHTML = csHtml;
            }

            const ctx = document.getElementById('clientSalesChart');
            if (!ctx) return;
            if (charts.clientSales) charts.clientSales.destroy();

            // 외부 툴팁
            const getOrCreateClientSalesTooltip = () => {
                let el = document.getElementById('clientSalesChartTooltip');
                if (!el) {
                    el = document.createElement('div');
                    el.id = 'clientSalesChartTooltip';
                    el.style.cssText = 'position:fixed;background:rgba(30,41,59,0.98);border-radius:12px;padding:16px;pointer-events:auto;z-index:99999;font-size:13px;color:#e2e8f0;box-shadow:0 20px 40px rgba(0,0,0,0.4);min-width:340px;max-width:420px;max-height:85vh;overflow-y:auto;transition:opacity 0.15s ease;line-height:1.5;';
                    document.body.appendChild(el); setupTooltipHover(el);
                }
                return el;
            };

            // 데이터셋 구성
            const datasets = [{
                label: currentData.year + '년 매출',
                data: top10.map(c => c[1].sales),
                backgroundColor: top10.map(c => newClientNames.has(c[0]) ? 'rgba(16, 185, 129, 0.8)' : 'rgba(99, 102, 241, 0.8)'),
                borderRadius: 6,
                order: 1
            }];

            // 전년 비교 데이터 추가
            if (hasCompare) {
                datasets.push({
                    label: compareData.year + '년 매출',
                    data: top10.map(c => {
                        const retained = retainedMap[c[0]];
                        return retained ? retained.lastYearSales : 0;
                    }),
                    backgroundColor: 'rgba(245, 158, 11, 0.5)',
                    borderColor: '#f59e0b',
                    borderWidth: 1,
                    borderRadius: 6,
                    order: 2
                });
            }

            charts.clientSales = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: top10.map(c => c[0].length > 8 ? c[0].substring(0, 8) + '..' : c[0]),
                    datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: true },
                    plugins: {
                        legend: { display: hasCompare, position: 'top', labels: { boxWidth: 12, padding: 10, font: { size: 11 } } },
                        tooltip: {
                            enabled: false,
                            external: function(context) {
                                const tooltipEl = getOrCreateClientSalesTooltip();
                                if (context.tooltip.opacity === 0 && !isTooltipHovered(tooltipEl)) { hideTooltipWithDelay(tooltipEl); return; }

                                const idx = context.tooltip.dataPoints?.[0]?.dataIndex;
                                if (idx === undefined) return;

                                const name = top10[idx][0];
                                const c = top10[idx][1];
                                const isNew = newClientNames.has(name);
                                const retained = retainedMap[name];
                                const compData = compareClientMap[name];
                                const percent = totalSales > 0 ? (c.sales / totalSales * 100) : 0;
                                const rank = idx + 1;

                                // 스타일 결정
                                let borderColor, headerBg, rankIcon;
                                if (rank === 1) {
                                    borderColor = 'rgba(255, 215, 0, 0.8)';
                                    headerBg = 'linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 180, 0, 0.2))';
                                    rankIcon = '🏆';
                                } else if (rank === 2) {
                                    borderColor = 'rgba(192, 192, 192, 0.8)';
                                    headerBg = 'linear-gradient(135deg, rgba(192, 192, 192, 0.3), rgba(169, 169, 169, 0.2))';
                                    rankIcon = '🥈';
                                } else if (rank === 3) {
                                    borderColor = 'rgba(205, 127, 50, 0.8)';
                                    headerBg = 'linear-gradient(135deg, rgba(205, 127, 50, 0.3), rgba(184, 115, 51, 0.2))';
                                    rankIcon = '🥉';
                                } else {
                                    borderColor = isNew ? 'rgba(16, 185, 129, 0.8)' : 'rgba(99, 102, 241, 0.6)';
                                    headerBg = isNew ? 'rgba(16, 185, 129, 0.2)' : 'rgba(99, 102, 241, 0.2)';
                                    rankIcon = '';
                                }
                                tooltipEl.style.border = '2px solid ' + borderColor;

                                const statusColor = isNew ? '#10b981' : '#6366f1';
                                const statusText = isNew ? '신규' : '유지';

                                let html = '';

                                // 1. 헤더 (업체명 + 순위/상태 배지)
                                html += '<div style="font-size:16px;font-weight:bold;color:#fff;margin:-16px -16px 12px -16px;padding:12px 16px;background:' + headerBg + ';border-radius:10px 10px 0 0;display:flex;justify-content:space-between;align-items:center;">';
                                html += '<span>' + rankIcon + ' ' + name + '</span>';
                                html += '<span style="background:' + statusColor + '33;color:' + statusColor + ';padding:4px 10px;border-radius:6px;font-size:12px;">' + statusText + ' · ' + rank + '위</span>';
                                html += '</div>';

                                // 2. 기본 지표 - 양쪽 연도 표시
                                html += '<div style="margin-bottom:4px;">💰 ' + currentData.year + '년 매출: <strong style="color:#60a5fa;">' + formatCurrency(c.sales) + '</strong></div>';
                                if (compData && compData.sales > 0) {
                                    html += '<div style="margin-bottom:4px;">💰 ' + compareData.year + '년 매출: <strong style="color:#f59e0b;">' + formatCurrency(compData.sales) + '</strong></div>';
                                }
                                html += '<div style="margin-bottom:4px;">📋 ' + currentData.year + '년 건수: <strong>' + c.count.toLocaleString() + '건</strong> | 건당: <strong>' + formatCurrency(c.count > 0 ? c.sales / c.count : 0) + '</strong></div>';
                                if (compData && compData.count > 0) {
                                    const compAvgPrice = compData.sales / compData.count;
                                    html += '<div style="margin-bottom:8px;">📋 ' + compareData.year + '년 건수: <strong>' + compData.count.toLocaleString() + '건</strong> | 건당: <strong>' + formatCurrency(compAvgPrice) + '</strong></div>';
                                }

                                // 3. 거래 현황
                                html += '<div style="color:#94a3b8;margin:12px 0 8px;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.2);">── 거래 현황 ──</div>';
                                html += '<div style="margin-bottom:4px;">📅 거래월수: <strong>' + (c.tradeMonths || '-') + '개월</strong></div>';
                                html += '<div style="margin-bottom:4px;">👤 주 담당자: <strong>' + (c.manager || '미지정') + '</strong></div>';

                                // 평균 대비
                                const vsAvgSales = avgClientSales > 0 ? ((c.sales - avgClientSales) / avgClientSales * 100) : 0;
                                const vsAvgColor = vsAvgSales >= 0 ? '#10b981' : '#ef4444';
                                const vsAvgSign = vsAvgSales >= 0 ? '+' : '';
                                html += '<div style="margin-bottom:4px;">📊 평균 대비: <span style="color:' + vsAvgColor + ';">' + vsAvgSign + vsAvgSales.toFixed(1) + '%</span> <span style="color:#94a3b8;">(평균: ' + formatCurrency(avgClientSales) + ')</span></div>';

                                // 4. 전체 대비 점유율
                                html += '<div style="color:#94a3b8;margin:12px 0 8px;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.2);">── 전체 대비 점유율 ──</div>';
                                html += '<div style="margin-bottom:4px;">📈 매출 점유율: <strong>' + percent.toFixed(2) + '%</strong> (' + rank + '위/' + clients.length + '업체)</div>';

                                // 점유율 변화 (전년 대비)
                                if (compData && compData.sales > 0 && compTotalSales > 0) {
                                    const compShare = (compData.sales / compTotalSales * 100);
                                    const shareDiff = percent - compShare;
                                    const shareColor = shareDiff >= 0 ? '#10b981' : '#ef4444';
                                    const shareSign = shareDiff >= 0 ? '+' : '';
                                    const shareStatus = shareDiff >= 0 ? '확대' : '축소';
                                    html += '<div style="margin-bottom:4px;">📊 점유율 변화: <span style="color:' + shareColor + ';">' + shareSign + shareDiff.toFixed(2) + '%p (' + shareStatus + ')</span></div>';
                                }

                                // 5. 전년 대비 성장률
                                if (retained && retained.lastYearSales > 0) {
                                    const yoyDiff = c.sales - retained.lastYearSales;
                                    const yoyPct = retained.growthRate || 0;
                                    const yoyColor = yoyDiff >= 0 ? '#10b981' : '#ef4444';
                                    const yoySign = yoyDiff >= 0 ? '+' : '';

                                    html += '<div style="color:#94a3b8;margin:12px 0 8px;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.2);">── 전년 대비 성장률 ──</div>';
                                    html += '<div style="margin-bottom:4px;">💰 금액: <span style="color:' + yoyColor + ';font-weight:bold;">' + yoySign + formatCurrency(yoyDiff) + ' (' + yoySign + yoyPct.toFixed(1) + '%)</span></div>';

                                    // 변화 원인 분해
                                    if (compData && compData.count > 0) {
                                        const compAvgPrice = compData.sales / compData.count;
                                        const currAvgPrice = c.count > 0 ? c.sales / c.count : 0;
                                        const countEffect = (c.count - compData.count) * compAvgPrice;
                                        const priceEffect = (currAvgPrice - compAvgPrice) * c.count;

                                        html += '<div style="color:#94a3b8;margin:12px 0 8px;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.2);">── 변화 원인 분해 ──</div>';

                                        const countColor = countEffect >= 0 ? '#10b981' : '#ef4444';
                                        const countSign = countEffect >= 0 ? '+' : '';
                                        const countPct = yoyDiff !== 0 ? Math.abs(countEffect / yoyDiff * 100) : 0;
                                        html += '<div style="margin-bottom:4px;">📋 건수 효과: <span style="color:' + countColor + ';">' + countSign + (countEffect / 10000).toFixed(0) + '만</span> <span style="color:#94a3b8;">(' + countPct.toFixed(0) + '%)</span></div>';

                                        const priceColor = priceEffect >= 0 ? '#10b981' : '#ef4444';
                                        const priceSign = priceEffect >= 0 ? '+' : '';
                                        const pricePct = yoyDiff !== 0 ? Math.abs(priceEffect / yoyDiff * 100) : 0;
                                        html += '<div style="margin-bottom:4px;">💵 단가 효과: <span style="color:' + priceColor + ';">' + priceSign + (priceEffect / 10000).toFixed(0) + '만</span> <span style="color:#94a3b8;">(' + pricePct.toFixed(0) + '%)</span></div>';

                                        const mainCause = Math.abs(countEffect) > Math.abs(priceEffect) ? '건수' : '단가';
                                        const causeDirection = (mainCause === '건수' ? countEffect : priceEffect) >= 0 ? '증가' : '감소';
                                        html += '<div style="color:#60a5fa;font-size:11px;margin-top:4px;">→ ' + mainCause + ' ' + causeDirection + '가 주요 원인</div>';
                                    }
                                }

                                // 6. 주요 검사목적 (byPurpose 데이터 활용)
                                if (c.byPurpose && Object.keys(c.byPurpose).length > 0) {
                                    const purposeEntries = Object.entries(c.byPurpose)
                                        .sort((a, b) => b[1].sales - a[1].sales)
                                        .slice(0, 3);

                                    html += '<div style="color:#94a3b8;margin:12px 0 8px;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.2);">── 주요 검사목적 TOP 3 ──</div>';
                                    purposeEntries.forEach((p, i) => {
                                        const purposeShare = c.sales > 0 ? (p[1].sales / c.sales * 100) : 0;
                                        const emoji = i === 0 ? '🥇' : (i === 1 ? '🥈' : '🥉');
                                        html += '<div style="margin-left:8px;margin-bottom:2px;">' + emoji + ' ' + p[0] + ': ' + (p[1].sales / 10000).toFixed(0) + '만 <span style="color:#94a3b8;">(' + purposeShare.toFixed(0) + '%)</span></div>';
                                    });
                                }

                                // 7. 담당자별 매출 (byManager 데이터 활용)
                                if (c.byManager && Object.keys(c.byManager).length > 1) {
                                    const managerEntries = Object.entries(c.byManager)
                                        .sort((a, b) => b[1].sales - a[1].sales)
                                        .slice(0, 3);

                                    html += '<div style="color:#94a3b8;margin:12px 0 8px;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.2);">── 담당자별 기여도 ──</div>';
                                    managerEntries.forEach((m, i) => {
                                        const mgrShare = c.sales > 0 ? (m[1].sales / c.sales * 100) : 0;
                                        html += '<div style="margin-left:8px;margin-bottom:2px;">👤 ' + m[0] + ': ' + (m[1].sales / 10000).toFixed(0) + '만 <span style="color:#94a3b8;">(' + mgrShare.toFixed(0) + '%)</span></div>';
                                    });

                                    // 담당자 기여도 바
                                    html += '<div style="display:flex;height:8px;border-radius:4px;overflow:hidden;margin-top:8px;">';
                                    const colors = ['#6366f1', '#10b981', '#f59e0b', '#ec4899', '#06b6d4'];
                                    managerEntries.forEach((m, i) => {
                                        const mgrShare = c.sales > 0 ? (m[1].sales / c.sales * 100) : 0;
                                        html += '<div style="width:' + mgrShare + '%;background:' + colors[i % colors.length] + ';" title="' + m[0] + '"></div>';
                                    });
                                    html += '</div>';
                                    html += '<div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:4px;font-size:10px;color:#94a3b8;">';
                                    managerEntries.forEach((m, i) => {
                                        html += '<span>● ' + m[0] + ' ' + (c.sales > 0 ? (m[1].sales / c.sales * 100).toFixed(0) : 0) + '%</span>';
                                    });
                                    html += '</div>';
                                }

                                tooltipEl.innerHTML = html;
                                tooltipEl.style.opacity = 1; tooltipEl.style.pointerEvents = 'auto';
                                const pos = context.chart.canvas.getBoundingClientRect();
                                tooltipEl.style.left = Math.min(pos.left + context.tooltip.caretX + 10, window.innerWidth - 430) + 'px';
                                tooltipEl.style.top = Math.min(pos.top + context.tooltip.caretY, window.innerHeight - 500) + 'px';
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: v => formatCurrency(v) } },
                        x: { ticks: { maxRotation: 45, minRotation: 45 } }
                    }
                }
            });
        }

        function updateClientCountChart(clients, newClients, retainedClients) {
            const sorted = [...clients].sort((a, b) => b[1].count - a[1].count);
            const top10 = sorted.slice(0, 10);
            const newClientNames = new Set(newClients.map(c => c.name));
            const retainedMap = Object.fromEntries(retainedClients.map(c => [c.name, c]));
            const totalCount = clients.reduce((s, c) => s + c[1].count, 0);
            const totalSales = clients.reduce((s, c) => s + c[1].sales, 0);
            const avgClientCount = clients.length > 0 ? totalCount / clients.length : 0;
            const hasCompare = compareData && compareData.by_client;
            const compareClientMap = hasCompare ? Object.fromEntries(compareData.by_client.map(c => [c[0], c[1]])) : {};
            const compTotalCount = hasCompare ? compareData.by_client.reduce((s, c) => s + c[1].count, 0) : 0;

            document.getElementById('clientCountChartBadge').textContent = hasCompare ?
                currentData.year + ' vs ' + compareData.year : currentData.year + '년';

            // clientCountChartSummary 요약 정보 표시
            const countSummaryEl = document.getElementById('clientCountChartSummary');
            if (countSummaryEl) {
                const avgPrice = totalCount > 0 ? totalSales / totalCount : 0;
                const top10Count = top10.reduce((s, c) => s + c[1].count, 0);
                const top10Ratio = totalCount > 0 ? (top10Count / totalCount * 100) : 0;
                let ccHtml = `<span style="white-space:nowrap;background:#dbeafe;padding:4px 10px;border-radius:4px;color:#1e40af;">총건수: <strong style="color:#3b82f6;">${totalCount.toLocaleString()}건</strong></span>`;
                if (hasCompare && compTotalCount > 0) {
                    const countGrowth = ((totalCount - compTotalCount) / compTotalCount * 100);
                    const growthColor = countGrowth >= 0 ? '#059669' : '#dc2626';
                    ccHtml += `<span style="white-space:nowrap;background:${countGrowth >= 0 ? '#d1fae5' : '#fee2e2'};padding:4px 10px;border-radius:4px;color:${growthColor};">전년비: <strong>${countGrowth >= 0 ? '+' : ''}${countGrowth.toFixed(1)}%</strong></span>`;
                }
                ccHtml += `<span style="white-space:nowrap;background:#e0e7ff;padding:4px 10px;border-radius:4px;color:#3730a3;">업체수: <strong>${clients.length.toLocaleString()}개</strong></span>`;
                ccHtml += `<span style="white-space:nowrap;background:#fce7f3;padding:4px 10px;border-radius:4px;color:#9d174d;">평균단가: <strong>${Math.round(avgPrice / 10000).toLocaleString()}만</strong></span>`;
                countSummaryEl.innerHTML = ccHtml;
            }

            const ctx = document.getElementById('clientCountChart');
            if (!ctx) return;
            if (charts.clientCount) charts.clientCount.destroy();

            // 외부 툴팁
            const getOrCreateClientCountTooltip = () => {
                let el = document.getElementById('clientCountChartTooltip');
                if (!el) {
                    el = document.createElement('div');
                    el.id = 'clientCountChartTooltip';
                    el.style.cssText = 'position:fixed;background:rgba(30,41,59,0.98);border-radius:12px;padding:16px;pointer-events:auto;z-index:99999;font-size:13px;color:#e2e8f0;box-shadow:0 20px 40px rgba(0,0,0,0.4);min-width:340px;max-width:420px;max-height:85vh;overflow-y:auto;transition:opacity 0.15s ease;line-height:1.5;';
                    document.body.appendChild(el); setupTooltipHover(el);
                }
                return el;
            };

            charts.clientCount = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: top10.map(c => c[0].length > 8 ? c[0].substring(0, 8) + '..' : c[0]),
                    datasets: [{
                        label: '건수',
                        data: top10.map(c => c[1].count),
                        backgroundColor: top10.map(c => newClientNames.has(c[0]) ? 'rgba(16, 185, 129, 0.8)' : 'rgba(99, 102, 241, 0.8)'),
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: true },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: false,
                            external: function(context) {
                                const tooltipEl = getOrCreateClientCountTooltip();
                                if (context.tooltip.opacity === 0 && !isTooltipHovered(tooltipEl)) { hideTooltipWithDelay(tooltipEl); return; }

                                const idx = context.tooltip.dataPoints?.[0]?.dataIndex;
                                if (idx === undefined) return;

                                const name = top10[idx][0];
                                const c = top10[idx][1];
                                const isNew = newClientNames.has(name);
                                const retained = retainedMap[name];
                                const compData = compareClientMap[name];
                                const percent = totalCount > 0 ? (c.count / totalCount * 100) : 0;
                                const avgPrice = c.count > 0 ? c.sales / c.count : 0;
                                const rank = idx + 1;

                                // 스타일 결정
                                let borderColor, headerBg, rankIcon;
                                if (rank === 1) {
                                    borderColor = 'rgba(255, 215, 0, 0.8)'; headerBg = 'linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 180, 0, 0.2))'; rankIcon = '🏆';
                                } else if (rank === 2) {
                                    borderColor = 'rgba(192, 192, 192, 0.8)'; headerBg = 'linear-gradient(135deg, rgba(192, 192, 192, 0.3), rgba(169, 169, 169, 0.2))'; rankIcon = '🥈';
                                } else if (rank === 3) {
                                    borderColor = 'rgba(205, 127, 50, 0.8)'; headerBg = 'linear-gradient(135deg, rgba(205, 127, 50, 0.3), rgba(184, 115, 51, 0.2))'; rankIcon = '🥉';
                                } else {
                                    borderColor = isNew ? 'rgba(16, 185, 129, 0.8)' : 'rgba(99, 102, 241, 0.6)';
                                    headerBg = isNew ? 'rgba(16, 185, 129, 0.2)' : 'rgba(99, 102, 241, 0.2)'; rankIcon = '';
                                }
                                tooltipEl.style.border = '2px solid ' + borderColor;

                                const statusColor = isNew ? '#10b981' : '#6366f1';
                                const statusText = isNew ? '신규' : '유지';

                                let html = '';

                                // 1. 헤더
                                html += '<div style="font-size:16px;font-weight:bold;color:#fff;margin:-16px -16px 12px -16px;padding:12px 16px;background:' + headerBg + ';border-radius:10px 10px 0 0;display:flex;justify-content:space-between;align-items:center;">';
                                html += '<span>' + rankIcon + ' ' + name + '</span>';
                                html += '<span style="background:' + statusColor + '33;color:' + statusColor + ';padding:4px 10px;border-radius:6px;font-size:12px;">' + statusText + ' · ' + rank + '위</span>';
                                html += '</div>';

                                // 2. 기본 지표
                                html += '<div style="margin-bottom:4px;">📋 ' + currentData.year + '년 건수: <strong style="color:#60a5fa;">' + c.count.toLocaleString() + '건</strong> | 건당: <strong>' + formatCurrency(avgPrice) + '</strong></div>';
                                if (compData && compData.count > 0) {
                                    const compAvgPrice = compData.sales / compData.count;
                                    html += '<div style="margin-bottom:4px;">📋 ' + compareData.year + '년 건수: <strong style="color:#f59e0b;">' + compData.count.toLocaleString() + '건</strong> | 건당: <strong>' + formatCurrency(compAvgPrice) + '</strong></div>';
                                }
                                html += '<div style="margin-bottom:4px;">💰 ' + currentData.year + '년 매출: <strong>' + formatCurrency(c.sales) + '</strong></div>';
                                if (compData && compData.sales > 0) {
                                    html += '<div style="margin-bottom:8px;">💰 ' + compareData.year + '년 매출: <strong>' + formatCurrency(compData.sales) + '</strong></div>';
                                }

                                // 3. 거래 현황
                                html += '<div style="color:#94a3b8;margin:12px 0 8px;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.2);">── 거래 현황 ──</div>';
                                html += '<div style="margin-bottom:4px;">📅 거래월수: <strong>' + (c.tradeMonths || '-') + '개월</strong></div>';
                                html += '<div style="margin-bottom:4px;">👤 주 담당자: <strong>' + (c.manager || '미지정') + '</strong></div>';

                                // 평균 대비
                                const vsAvgCount = avgClientCount > 0 ? ((c.count - avgClientCount) / avgClientCount * 100) : 0;
                                const vsAvgColor = vsAvgCount >= 0 ? '#10b981' : '#ef4444';
                                html += '<div style="margin-bottom:4px;">📊 평균 대비: <span style="color:' + vsAvgColor + ';">' + (vsAvgCount >= 0 ? '+' : '') + vsAvgCount.toFixed(1) + '%</span> <span style="color:#94a3b8;">(평균: ' + Math.round(avgClientCount).toLocaleString() + '건)</span></div>';

                                // 4. 전체 대비 점유율
                                html += '<div style="color:#94a3b8;margin:12px 0 8px;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.2);">── 전체 대비 점유율 ──</div>';
                                html += '<div style="margin-bottom:4px;">📈 건수 점유율: <strong>' + percent.toFixed(2) + '%</strong> (' + rank + '위/' + clients.length + '업체)</div>';

                                if (compData && compData.count > 0 && compTotalCount > 0) {
                                    const compShare = (compData.count / compTotalCount * 100);
                                    const shareDiff = percent - compShare;
                                    const shareColor = shareDiff >= 0 ? '#10b981' : '#ef4444';
                                    html += '<div style="margin-bottom:4px;">📊 점유율 변화: <span style="color:' + shareColor + ';">' + (shareDiff >= 0 ? '+' : '') + shareDiff.toFixed(2) + '%p (' + (shareDiff >= 0 ? '확대' : '축소') + ')</span></div>';
                                }

                                // 5. 전년 대비 성장률
                                if (retained && retained.lastYearCount > 0) {
                                    const countDiff = c.count - retained.lastYearCount;
                                    const countGrowth = (countDiff / retained.lastYearCount * 100);
                                    const growthColor = countDiff >= 0 ? '#10b981' : '#ef4444';

                                    html += '<div style="color:#94a3b8;margin:12px 0 8px;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.2);">── 전년 대비 성장률 ──</div>';
                                    html += '<div style="margin-bottom:4px;">📋 건수: <span style="color:' + growthColor + ';font-weight:bold;">' + (countDiff >= 0 ? '+' : '') + countDiff.toLocaleString() + '건 (' + (countGrowth >= 0 ? '+' : '') + countGrowth.toFixed(1) + '%)</span></div>';

                                    if (retained.lastYearSales > 0) {
                                        const salesDiff = c.sales - retained.lastYearSales;
                                        const salesGrowth = (salesDiff / retained.lastYearSales * 100);
                                        const salesColor = salesDiff >= 0 ? '#10b981' : '#ef4444';
                                        html += '<div style="margin-bottom:4px;">💰 매출: <span style="color:' + salesColor + ';font-weight:bold;">' + (salesDiff >= 0 ? '+' : '') + formatCurrency(salesDiff) + ' (' + (salesGrowth >= 0 ? '+' : '') + salesGrowth.toFixed(1) + '%)</span></div>';
                                    }
                                }

                                // 6. 주요 검사목적 TOP 3
                                if (c.byPurpose && Object.keys(c.byPurpose).length > 0) {
                                    const purposeEntries = Object.entries(c.byPurpose).sort((a, b) => b[1].count - a[1].count).slice(0, 3);
                                    html += '<div style="color:#94a3b8;margin:12px 0 8px;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.2);">── 주요 검사목적 TOP 3 ──</div>';
                                    purposeEntries.forEach((p, i) => {
                                        const purposeShare = c.count > 0 ? (p[1].count / c.count * 100) : 0;
                                        const emoji = i === 0 ? '🥇' : (i === 1 ? '🥈' : '🥉');
                                        html += '<div style="margin-left:8px;margin-bottom:2px;">' + emoji + ' ' + p[0] + ': ' + p[1].count.toLocaleString() + '건 <span style="color:#94a3b8;">(' + purposeShare.toFixed(0) + '%)</span></div>';
                                    });
                                }

                                tooltipEl.innerHTML = html;
                                tooltipEl.style.opacity = 1; tooltipEl.style.pointerEvents = 'auto';
                                const pos = context.chart.canvas.getBoundingClientRect();
                                tooltipEl.style.left = Math.min(pos.left + context.tooltip.caretX + 10, window.innerWidth - 430) + 'px';
                                tooltipEl.style.top = Math.min(pos.top + context.tooltip.caretY, window.innerHeight - 500) + 'px';
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true },
                        x: { ticks: { maxRotation: 45, minRotation: 45 } }
                    }
                }
            });
        }

        // 월별 거래 업체 수 차트
        function updateClientMonthlyCountChart() {
            const ctx = document.getElementById('clientMonthlyCountChart');
            if (!ctx) return;
            if (charts.clientMonthlyCount) charts.clientMonthlyCount.destroy();

            const monthData = currentData.by_month || [];
            const labels = ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'];
            const monthMap = Object.fromEntries(monthData.map(m => [m[0], m[1]]));

            const currentCounts = labels.map((_, i) => monthMap[i + 1]?.clientCount || 0);
            const currentSales = labels.map((_, i) => monthMap[i + 1]?.sales || 0);
            const currentCountsData = labels.map((_, i) => monthMap[i + 1]?.count || 0);
            const hasCompare = compareData && compareData.by_month;
            const compMonthMap = hasCompare ? Object.fromEntries(compareData.by_month.map(m => [m[0], m[1]])) : {};
            const compareCounts = hasCompare ? labels.map((_, i) => compMonthMap[i + 1]?.clientCount || 0) : [];
            const compareSales = hasCompare ? labels.map((_, i) => compMonthMap[i + 1]?.sales || 0) : [];

            document.getElementById('clientMonthlyCountBadge').textContent = hasCompare ?
                currentData.year + ' vs ' + compareData.year : currentData.year + '년';

            // clientMonthlyCountSummary 요약 정보 표시
            const monthlyCountSummaryEl = document.getElementById('clientMonthlyCountSummary');
            if (monthlyCountSummaryEl) {
                const totalClients = currentCounts.reduce((s, c) => s + c, 0);
                const avgClients = currentCounts.filter(c => c > 0).length > 0 ? totalClients / currentCounts.filter(c => c > 0).length : 0;
                const totalSalesSum = currentSales.reduce((s, c) => s + c, 0);
                const totalCountSum = currentCountsData.reduce((s, c) => s + c, 0);
                let mcHtml = `<span style="white-space:nowrap;background:#dbeafe;padding:4px 10px;border-radius:4px;color:#1e40af;">월평균: <strong style="color:#3b82f6;">${Math.round(avgClients)}개</strong></span>`;
                if (hasCompare) {
                    const compAvg = compareCounts.filter(c => c > 0).length > 0 ? compareCounts.reduce((s, c) => s + c, 0) / compareCounts.filter(c => c > 0).length : 0;
                    const growthPct = compAvg > 0 ? ((avgClients - compAvg) / compAvg * 100) : 0;
                    const growthColor = growthPct >= 0 ? '#059669' : '#dc2626';
                    mcHtml += `<span style="white-space:nowrap;background:${growthPct >= 0 ? '#d1fae5' : '#fee2e2'};padding:4px 10px;border-radius:4px;color:${growthColor};">전년비: <strong>${growthPct >= 0 ? '+' : ''}${growthPct.toFixed(1)}%</strong></span>`;
                }
                mcHtml += `<span style="white-space:nowrap;background:#e0e7ff;padding:4px 10px;border-radius:4px;color:#3730a3;">총건수: <strong>${totalCountSum.toLocaleString()}건</strong></span>`;
                mcHtml += `<span style="white-space:nowrap;background:#fce7f3;padding:4px 10px;border-radius:4px;color:#9d174d;">매출: <strong>${(totalSalesSum / 100000000).toFixed(1)}억</strong></span>`;
                monthlyCountSummaryEl.innerHTML = mcHtml;
            }

            // 외부 툴팁 생성
            const getOrCreateMonthlyTooltip = () => {
                let el = document.getElementById('clientMonthlyCountTooltip');
                if (!el) {
                    el = document.createElement('div');
                    el.id = 'clientMonthlyCountTooltip';
                    el.style.cssText = 'position:fixed;background:rgba(30,41,59,0.98);border-radius:12px;padding:16px;pointer-events:auto;z-index:99999;font-size:13px;color:#e2e8f0;box-shadow:0 20px 40px rgba(0,0,0,0.4);min-width:280px;max-width:360px;max-height:85vh;overflow-y:auto;transition:opacity 0.15s ease;line-height:1.5;';
                    document.body.appendChild(el);
                    setupTooltipHover(el);
                }
                return el;
            };

            const datasets = [{
                label: currentData.year + '년',
                data: currentCounts,
                borderColor: '#6366f1',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 3,
                pointRadius: 5,
                pointHoverRadius: 8
            }];

            if (hasCompare) {
                datasets.push({
                    label: compareData.year + '년',
                    data: compareCounts,
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 4,
                    pointHoverRadius: 7
                });
            }

            charts.clientMonthlyCount = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: hasCompare, position: 'top', labels: { boxWidth: 12 } },
                        tooltip: {
                            enabled: false,
                            external: function(context) {
                                const tooltipEl = getOrCreateMonthlyTooltip();
                                if (context.tooltip.opacity === 0 && !isTooltipHovered(tooltipEl)) {
                                    hideTooltipWithDelay(tooltipEl);
                                    return;
                                }

                                const dataPoints = context.tooltip.dataPoints;
                                if (!dataPoints || dataPoints.length === 0) return;

                                const monthIdx = dataPoints[0].dataIndex;
                                const month = labels[monthIdx];
                                const clientCount = currentCounts[monthIdx];
                                const sales = currentSales[monthIdx];
                                const caseCount = currentCountsData[monthIdx];
                                const avgSalesPerClient = clientCount > 0 ? sales / clientCount : 0;
                                const avgCasePerClient = clientCount > 0 ? caseCount / clientCount : 0;
                                const avgPricePerCase = caseCount > 0 ? sales / caseCount : 0;

                                // 연간 합계 계산
                                const yearTotalClients = currentCounts.reduce((s, v) => s + v, 0);
                                const yearTotalSales = currentSales.reduce((s, v) => s + v, 0);
                                const monthShare = yearTotalSales > 0 ? (sales / yearTotalSales * 100) : 0;

                                let html = '';

                                // 헤더
                                html += '<div style="font-size:16px;font-weight:bold;color:#fff;margin:-16px -16px 12px -16px;padding:12px 16px;background:linear-gradient(135deg, rgba(99, 102, 241, 0.3), rgba(79, 70, 229, 0.2));border-radius:10px 10px 0 0;display:flex;justify-content:space-between;align-items:center;">';
                                html += '<span>📅 ' + month + '</span>';
                                html += '<span style="background:rgba(99,102,241,0.4);color:#a5b4fc;padding:4px 10px;border-radius:6px;font-size:12px;">' + clientCount + '개 업체</span>';
                                html += '</div>';

                                // 올해 데이터
                                html += '<div style="margin-bottom:4px;">🏢 ' + currentData.year + '년 업체: <strong style="color:#60a5fa;">' + clientCount.toLocaleString() + '개</strong></div>';
                                html += '<div style="margin-bottom:4px;">💰 ' + currentData.year + '년 매출: <strong style="color:#60a5fa;">' + formatCurrency(sales) + '</strong></div>';
                                html += '<div style="margin-bottom:4px;">📋 ' + currentData.year + '년 건수: <strong>' + caseCount.toLocaleString() + '건</strong> | 건당: <strong>' + formatCurrency(avgPricePerCase) + '</strong></div>';

                                // 전년 데이터
                                if (hasCompare) {
                                    const compCount = compareCounts[monthIdx];
                                    const compSales = compareSales[monthIdx];
                                    const compCaseCount = compMonthMap[monthIdx + 1]?.count || 0;
                                    const compAvgPrice = compCaseCount > 0 ? compSales / compCaseCount : 0;
                                    html += '<div style="margin-bottom:4px;">🏢 ' + compareData.year + '년 업체: <strong style="color:#f59e0b;">' + compCount.toLocaleString() + '개</strong></div>';
                                    html += '<div style="margin-bottom:4px;">💰 ' + compareData.year + '년 매출: <strong style="color:#f59e0b;">' + formatCurrency(compSales) + '</strong></div>';
                                    html += '<div style="margin-bottom:8px;">📋 ' + compareData.year + '년 건수: <strong>' + compCaseCount.toLocaleString() + '건</strong> | 건당: <strong>' + formatCurrency(compAvgPrice) + '</strong></div>';
                                }

                                // 월별 현황
                                html += '<div style="color:#94a3b8;margin:12px 0 8px;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.2);">── 월별 현황 ──</div>';
                                html += '<div style="margin-bottom:4px;">📊 업체당 매출: <strong>' + formatCurrency(Math.round(avgSalesPerClient)) + '</strong></div>';
                                html += '<div style="margin-bottom:4px;">📋 업체당 건수: <strong>' + avgCasePerClient.toFixed(1) + '건</strong></div>';
                                html += '<div style="margin-bottom:4px;">📈 연간 매출 비중: <strong>' + monthShare.toFixed(1) + '%</strong></div>';

                                // 전년 대비 성장률
                                if (hasCompare) {
                                    const compCount = compareCounts[monthIdx];
                                    const compSales = compareSales[monthIdx];
                                    const countDiff = clientCount - compCount;
                                    const countGrowth = compCount > 0 ? ((clientCount - compCount) / compCount * 100) : 0;
                                    const salesDiff = sales - compSales;
                                    const salesGrowth = compSales > 0 ? ((sales - compSales) / compSales * 100) : 0;
                                    const countColor = countDiff >= 0 ? '#10b981' : '#ef4444';
                                    const salesColor = salesGrowth >= 0 ? '#10b981' : '#ef4444';

                                    html += '<div style="color:#94a3b8;margin:12px 0 8px;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.2);">── 전년 대비 성장률 ──</div>';
                                    html += '<div style="margin-bottom:4px;">🏢 업체 수: <span style="color:' + countColor + ';font-weight:bold;">' + (countDiff >= 0 ? '+' : '') + countDiff + '개 (' + (countGrowth >= 0 ? '+' : '') + countGrowth.toFixed(1) + '%)</span></div>';
                                    html += '<div style="margin-bottom:4px;">💰 매출: <span style="color:' + salesColor + ';font-weight:bold;">' + (salesDiff >= 0 ? '+' : '') + formatCurrency(salesDiff) + ' (' + (salesGrowth >= 0 ? '+' : '') + salesGrowth.toFixed(1) + '%)</span></div>';

                                    // 변화 원인 분해
                                    if (compCount > 0 && compSales > 0) {
                                        const compAvgSales = compSales / compCount;
                                        const currAvgSales = clientCount > 0 ? sales / clientCount : 0;
                                        const countEffect = (clientCount - compCount) * compAvgSales;
                                        const avgEffect = (currAvgSales - compAvgSales) * clientCount;

                                        if (Math.abs(salesDiff) > 0) {
                                            html += '<div style="color:#94a3b8;margin:12px 0 8px;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.2);">── 변화 원인 분해 ──</div>';
                                            const countEffColor = countEffect >= 0 ? '#10b981' : '#ef4444';
                                            const avgEffColor = avgEffect >= 0 ? '#10b981' : '#ef4444';
                                            const countPct = Math.abs(salesDiff) > 0 ? Math.abs(countEffect / salesDiff * 100) : 0;
                                            const avgPct = Math.abs(salesDiff) > 0 ? Math.abs(avgEffect / salesDiff * 100) : 0;
                                            html += '<div style="margin-bottom:4px;">🏢 업체 수 효과: <span style="color:' + countEffColor + ';">' + (countEffect >= 0 ? '+' : '') + formatCurrency(countEffect) + '</span> <span style="color:#94a3b8;">(' + countPct.toFixed(0) + '%)</span></div>';
                                            html += '<div style="margin-bottom:4px;">💵 업체당 단가 효과: <span style="color:' + avgEffColor + ';">' + (avgEffect >= 0 ? '+' : '') + formatCurrency(avgEffect) + '</span> <span style="color:#94a3b8;">(' + avgPct.toFixed(0) + '%)</span></div>';
                                            const mainCause = Math.abs(countEffect) > Math.abs(avgEffect) ? '업체 수' : '업체당 단가';
                                            const causeDir = (mainCause === '업체 수' ? countEffect : avgEffect) >= 0 ? '증가' : '감소';
                                            html += '<div style="color:#60a5fa;font-size:11px;margin-top:4px;">→ ' + mainCause + ' ' + causeDir + '가 주요 원인</div>';
                                        }
                                    }
                                }

                                tooltipEl.innerHTML = html;
                                tooltipEl.style.border = '2px solid rgba(99, 102, 241, 0.6)';
                                tooltipEl.style.opacity = '1';
                                tooltipEl.style.display = 'block';

                                const pos = context.chart.canvas.getBoundingClientRect();
                                tooltipEl.style.left = Math.min(pos.left + context.tooltip.caretX + 15, window.innerWidth - 370) + 'px';
                                tooltipEl.style.top = Math.min(pos.top + context.tooltip.caretY - 10, window.innerHeight - 300) + 'px';
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: v => v.toLocaleString() + '개' } }
                    }
                }
            });
        }

        function updateRetainedClientTable(retainedClients) {
            const sorted = [...retainedClients].sort((a, b) => b.growthRate - a.growthRate);
            document.getElementById('retainedTableBadge').textContent = sorted.length + '개';

            const tbody = document.querySelector('#retainedClientTable tbody');
            tbody.innerHTML = sorted.map(c => {
                const growthClass = c.growthRate >= 0 ? 'color: var(--success)' : 'color: var(--danger)';
                const growthSign = c.growthRate >= 0 ? '+' : '';
                return `<tr>
                    <td><strong>${c.name}</strong></td>
                    <td style="white-space:nowrap;">${c.manager || '-'}</td>
                    <td class="text-right" style="white-space:nowrap;">${formatCurrency(c.sales)}</td>
                    <td class="text-right" style="white-space:nowrap;">${formatCurrency(c.lastYearSales)}</td>
                    <td class="text-right" style="white-space:nowrap;"><span style="${growthClass}; font-weight: 600;">${growthSign}${c.growthRate.toFixed(1)}%</span></td>
                </tr>`;
            }).join('');
        }

        function setClientTableMode(mode) {
            clientTableMode = mode;
            document.getElementById('btnNewClients').classList.toggle('active', mode === 'new');
            document.getElementById('btnChurnedClients').classList.toggle('active', mode === 'churned');
            document.getElementById('newChurnTableTitle').textContent = mode === 'new' ? '🆕 신규 업체' : '📤 이탈 업체';

            const thead = document.getElementById('newChurnTableHead');
            if (mode === 'new') {
                thead.innerHTML = '<tr><th>업체명</th><th>담당자</th><th class="text-right">매출액</th><th class="text-right">건수</th><th>주요 검사</th></tr>';
            } else {
                thead.innerHTML = '<tr><th>업체명</th><th>담당자</th><th class="text-right">전년 매출</th><th>주요 검사</th></tr>';
            }
            updateNewChurnClientTable();
        }

        function updateNewChurnClientTable() {
            if (!clientAnalysisData) return;
            const tbody = document.querySelector('#newChurnClientTable tbody');

            if (clientTableMode === 'new') {
                const sorted = [...clientAnalysisData.newClients].sort((a, b) => b.sales - a.sales);
                tbody.innerHTML = sorted.map(c => `<tr>
                    <td><strong>${c.name}</strong></td>
                    <td>${c.manager || '-'}</td>
                    <td class="text-right">${formatCurrency(c.sales)}</td>
                    <td class="text-right">${c.count.toLocaleString()}</td>
                    <td>${c.purpose || '-'}</td>
                </tr>`).join('');
            } else {
                const sorted = [...clientAnalysisData.churnedClients].sort((a, b) => b.lastYearSales - a.lastYearSales);
                tbody.innerHTML = sorted.map(c => `<tr>
                    <td><strong>${c.name}</strong></td>
                    <td>${c.manager || '-'}</td>
                    <td class="text-right">${formatCurrency(c.lastYearSales)}</td>
                    <td>${c.purpose || '-'}</td>
                </tr>`).join('');
            }
        }

        function updateClientByPurposeTable(clients) {
            // 검사목적별 업체 집계
            const purposeStats = {};
            clients.forEach(c => {
                const purposes = c[1].purposes || {};
                Object.entries(purposes).forEach(([purpose, data]) => {
                    if (!purposeStats[purpose]) {
                        purposeStats[purpose] = { clients: new Set(), totalSales: 0, topClient: null, topClientSales: 0 };
                    }
                    purposeStats[purpose].clients.add(c[0]);
                    purposeStats[purpose].totalSales += data.sales;
                    if (data.sales > purposeStats[purpose].topClientSales) {
                        purposeStats[purpose].topClient = c[0];
                        purposeStats[purpose].topClientSales = data.sales;
                    }
                });
            });

            const sorted = Object.entries(purposeStats)
                .map(([purpose, stats]) => ({
                    purpose,
                    clientCount: stats.clients.size,
                    totalSales: stats.totalSales,
                    avgSales: stats.totalSales / stats.clients.size,
                    topClient: stats.topClient
                }))
                .sort((a, b) => b.totalSales - a.totalSales);

            const tbody = document.querySelector('#clientByPurposeTable tbody');
            tbody.innerHTML = sorted.slice(0, 15).map(p => `<tr>
                <td><strong>${p.purpose}</strong></td>
                <td class="text-right">${p.clientCount}개</td>
                <td class="text-right">${formatCurrency(p.totalSales)}</td>
                <td class="text-right">${formatCurrency(p.avgSales)}</td>
                <td>${p.topClient || '-'}</td>
            </tr>`).join('');
        }

        function updateClientByManagerTable(clients, newClients, retainedClients, churnedClients, compareClientMap) {
            const managerStats = {};

            clients.forEach(c => {
                const manager = c[1].manager || '미지정';
                if (!managerStats[manager]) {
                    managerStats[manager] = { total: 0, newCount: 0, retained: 0, churned: 0, sales: 0, lastYearSales: 0 };
                }
                managerStats[manager].total++;
                managerStats[manager].sales += c[1].sales;
            });

            newClients.forEach(c => {
                const manager = c.manager || '미지정';
                if (managerStats[manager]) managerStats[manager].newCount++;
            });

            retainedClients.forEach(c => {
                const manager = c.manager || '미지정';
                if (managerStats[manager]) {
                    managerStats[manager].retained++;
                    managerStats[manager].lastYearSales += c.lastYearSales || 0;
                }
            });

            churnedClients.forEach(c => {
                const manager = c.manager || '미지정';
                if (!managerStats[manager]) {
                    managerStats[manager] = { total: 0, newCount: 0, retained: 0, churned: 0, sales: 0, lastYearSales: 0 };
                }
                managerStats[manager].churned++;
            });

            const sorted = Object.entries(managerStats)
                .map(([name, stats]) => ({
                    name,
                    ...stats,
                    growthRate: stats.lastYearSales > 0 ? ((stats.sales - stats.lastYearSales) / stats.lastYearSales * 100) : 0
                }))
                .sort((a, b) => b.sales - a.sales);

            const tbody = document.querySelector('#clientByManagerTable tbody');
            tbody.innerHTML = sorted.map(m => {
                const growthClass = m.growthRate >= 0 ? 'color: var(--success)' : 'color: var(--danger)';
                const growthSign = m.growthRate >= 0 ? '+' : '';
                return `<tr>
                    <td><strong>${m.name}</strong></td>
                    <td class="text-right">${m.total}개</td>
                    <td class="text-right" style="color: var(--success);">${m.newCount}</td>
                    <td class="text-right">${m.retained}</td>
                    <td class="text-right" style="color: var(--danger);">${m.churned}</td>
                    <td class="text-right">${formatCurrency(m.sales)}</td>
                    <td class="text-right"><span style="${growthClass}; font-weight: 600;">${growthSign}${m.growthRate.toFixed(1)}%</span></td>
                </tr>`;
            }).join('');
        }

        // 지역별 탭 전역 변수
        let regionAnalysisData = null;
        let selectedRegion = null;
        let currentMapLevel = 'sido';  // 'sido' 또는 'sigungu'
        let currentSido = null;
        let sidoSalesData = {};
        let sigunguSalesData = {};

        // 시/도 이름 매핑 (SVG id → 짧은 이름)
        const SIDO_NAME_MAP = {
            '서울특별시': '서울', '부산광역시': '부산', '대구광역시': '대구',
            '인천광역시': '인천', '광주광역시': '광주', '대전광역시': '대전',
            '울산광역시': '울산', '세종특별자치시': '세종', '경기도': '경기',
            '강원도': '강원', '충청북도': '충북', '충청남도': '충남',
            '전라북도': '전북', '전라남도': '전남', '경상북도': '경북',
            '경상남도': '경남', '제주특별자치도': '제주'
        };

        // 역매핑 (짧은 이름 → SVG id)
        const SIDO_ID_MAP = Object.fromEntries(
            Object.entries(SIDO_NAME_MAP).map(([k, v]) => [v, k])
        );

        // 시/도별 SVG 파일명 매핑
        const SIDO_SVG_FILE = {
            '서울특별시': '서울특별시_시군구_경계.svg',
            '부산광역시': '부산광역시_시군구_경계.svg',
            '대구광역시': '대구광역시_시군구_경계.svg',
            '인천광역시': '인천광역시_시군구_경계.svg',
            '광주광역시': '광주광역시_시군구_경계.svg',
            '대전광역시': '대전광역시_시군구_경계.svg',
            '울산광역시': '울산광역시_시군구_경계.svg',
            '세종특별자치시': '세종특별자치시_시군구_경계.svg',
            '경기도': '경기도_시군구_경계.svg',
            '강원도': '강원도_시군구_경계.svg',
            '충청북도': '충청북도_시군구_경계.svg',
            '충청남도': '충청남도_시군구_경계.svg',
            '전라북도': '전라북도_시군구_경계.svg',
            '전라남도': '전라남도_시군구_경계.svg',
            '경상북도': '경상북도_시군구_경계.svg',
            '경상남도': '경상남도_시군구_경계.svg',
            '제주특별자치도': '제주특별자치도_시군구_경계.svg'
        };

        // 전국 시/도 지도 로드
        async function loadSidoMap() {
            const svg = d3.select('#koreaMap');
            if (svg.empty()) return;

            svg.selectAll('*').remove();
            currentMapLevel = 'sido';
            currentSido = null;

            // UI 업데이트
            document.getElementById('mapBackBtn').style.display = 'none';
            document.getElementById('mapBreadcrumb').textContent = '전국';

            // 범례 전환 (시/도 = 매출 기준)
            document.getElementById('mapLegendSido').style.display = 'flex';
            document.getElementById('mapLegendSigungu').style.display = 'none';

            try {
                const response = await fetch('https://raw.githubusercontent.com/statgarten/maps/main/svg/simple/전국_시도_경계.svg');
                const svgText = await response.text();

                const parser = new DOMParser();
                const svgDoc = parser.parseFromString(svgText, 'image/svg+xml');
                const paths = svgDoc.querySelectorAll('path');

                svg.attr('viewBox', '0 0 800 759')
                   .attr('preserveAspectRatio', 'xMidYMid meet');

                paths.forEach(path => {
                    const id = path.getAttribute('id');
                    const d = path.getAttribute('d');
                    const fillRule = path.getAttribute('fill-rule');

                    if (id && d) {
                        const pathEl = svg.append('path')
                            .attr('id', 'region-' + id)
                            .attr('d', d)
                            .attr('fill', '#dbeafe')
                            .attr('stroke', '#94a3b8')
                            .attr('stroke-width', '1')
                            .attr('cursor', 'pointer')
                            .attr('data-name', id);

                        if (fillRule) pathEl.attr('fill-rule', fillRule);

                        pathEl.on('mouseover', function(event) {
                            handleMapMouseOver(this, event, 'sido');
                        })
                        .on('mouseout', function() {
                            handleMapMouseOut(this);
                        })
                        .on('mousemove', function(event) {
                            handleMapMouseMove(event);
                        })
                        .on('click', function() {
                            const sidoName = d3.select(this).attr('data-name');
                            loadSigunguMap(sidoName);
                        });
                    }
                });

                updateSidoMapColors();
                console.log('[SVG MAP] 전국 지도 로드 완료');
            } catch (e) {
                console.error('[SVG MAP] 전국 지도 로드 실패:', e);
            }
        }

        // 시/군/구 지도 로드 (드릴다운)
        async function loadSigunguMap(sidoName) {
            const svg = d3.select('#koreaMap');
            if (svg.empty()) return;

            const svgFile = SIDO_SVG_FILE[sidoName];
            if (!svgFile) {
                console.error('[SVG MAP] 시군구 SVG 파일 없음:', sidoName);
                return;
            }

            svg.selectAll('*').remove();
            currentMapLevel = 'sigungu';
            currentSido = sidoName;

            // UI 업데이트
            document.getElementById('mapBackBtn').style.display = 'inline-block';
            document.getElementById('mapBreadcrumb').textContent = `전국 > ${sidoName}`;

            // 범례 전환 (시군구 = 거래처 수 기준)
            document.getElementById('mapLegendSido').style.display = 'none';
            document.getElementById('mapLegendSigungu').style.display = 'flex';

            // 해당 시/도의 시군구 데이터 준비
            prepareSigunguData(sidoName);

            try {
                const response = await fetch(`https://raw.githubusercontent.com/statgarten/maps/main/svg/simple/${encodeURIComponent(svgFile)}`);
                const svgText = await response.text();

                const parser = new DOMParser();
                const svgDoc = parser.parseFromString(svgText, 'image/svg+xml');
                const paths = svgDoc.querySelectorAll('path');
                const originalSvg = svgDoc.querySelector('svg');

                // viewBox 가져오기
                const viewBox = originalSvg?.getAttribute('viewBox') || '0 0 800 800';
                svg.attr('viewBox', viewBox)
                   .attr('preserveAspectRatio', 'xMidYMid meet');

                paths.forEach(path => {
                    const id = path.getAttribute('id');
                    const d = path.getAttribute('d');
                    const fillRule = path.getAttribute('fill-rule');

                    if (id && d) {
                        const pathEl = svg.append('path')
                            .attr('id', 'region-' + id)
                            .attr('d', d)
                            .attr('fill', '#dbeafe')
                            .attr('stroke', '#94a3b8')
                            .attr('stroke-width', '1')
                            .attr('cursor', 'pointer')
                            .attr('data-name', id);

                        if (fillRule) pathEl.attr('fill-rule', fillRule);

                        pathEl.on('mouseover', function(event) {
                            handleMapMouseOver(this, event, 'sigungu');
                        })
                        .on('mouseout', function() {
                            handleMapMouseOut(this);
                        })
                        .on('mousemove', function(event) {
                            handleMapMouseMove(event);
                        })
                        .on('click', function() {
                            const sigunguName = d3.select(this).attr('data-name');
                            showSigunguDetail(sigunguName);
                        });
                    }
                });

                // 라벨 추가 (지역명 + 거래처 수)
                setTimeout(() => {
                    paths.forEach(path => {
                        const id = path.getAttribute('id');
                        if (!id) return;

                        const pathEl = svg.select('#region-' + id);
                        if (pathEl.empty()) return;

                        // path의 바운딩 박스로 중심점 계산
                        try {
                            const bbox = pathEl.node().getBBox();
                            const cx = bbox.x + bbox.width / 2;
                            const cy = bbox.y + bbox.height / 2;

                            const data = sigunguSalesData[id] || { count: 0 };

                            // 배경색에 따른 글씨 색상 결정
                            const bgColor = getColorByCount(data.count);
                            const isDarkBg = ['#dc2626', '#f97316'].includes(bgColor);  // 빨강, 주황
                            const textColor = isDarkBg ? '#ffffff' : '#1e293b';
                            const countColor = isDarkBg ? '#ffffff' : '#7c2d12';  // 흰색 또는 진한 갈색

                            // 지역명 라벨
                            svg.append('text')
                                .attr('x', cx)
                                .attr('y', cy - 14)
                                .attr('text-anchor', 'middle')
                                .attr('font-size', '22px')
                                .attr('font-weight', '700')
                                .attr('fill', textColor)
                                .attr('pointer-events', 'none')
                                .text(id.length > 5 ? id.substring(0, 4) + '..' : id);

                            // 거래처 수 라벨
                            if (data.count > 0) {
                                svg.append('text')
                                    .attr('x', cx)
                                    .attr('y', cy + 18)
                                    .attr('text-anchor', 'middle')
                                    .attr('font-size', '20px')
                                    .attr('font-weight', '800')
                                    .attr('fill', countColor)
                                    .attr('pointer-events', 'none')
                                    .text(data.count + '개');
                            }
                        } catch (e) {}
                    });
                }, 100);

                updateSigunguMapColors();
                showSidoSummary(sidoName);
                console.log('[SVG MAP] 시군구 지도 로드 완료:', sidoName);
            } catch (e) {
                console.error('[SVG MAP] 시군구 지도 로드 실패:', e);
            }
        }

        // 뒤로가기 (전국 지도로)
        function mapDrillUp() {
            loadSidoMap();
        }

        // 시군구 데이터 준비 (거래처 주소 기반)
        function prepareSigunguData(sidoName) {
            sigunguSalesData = {};
            const clients = currentData.by_client || [];

            if (clients.length === 0) return;

            const shortName = SIDO_NAME_MAP[sidoName] || sidoName;

            // 거래처 주소에서 시군구 추출
            clients.forEach(c => {
                const clientData = c[1];
                const address = clientData.address || '';

                // 주소에서 시/도 확인
                const hasSido = address.includes(sidoName) || address.includes(shortName);
                if (!hasSido) return;

                // 시군구 추출 (예: "서울특별시 강남구 역삼동" → "강남구")
                let sigungu = null;

                // 패턴: ~구, ~시, ~군 찾기
                const match = address.match(/([가-힣]+[구시군])/g);
                if (match) {
                    for (const m of match) {
                        // 광역시/특별시/도 제외
                        if (!m.includes('특별') && !m.includes('광역') &&
                            m !== sidoName && m !== shortName &&
                            !['서울시', '부산시', '대구시', '인천시', '광주시', '대전시', '울산시'].includes(m)) {
                            sigungu = m;
                            break;
                        }
                    }
                }

                if (sigungu) {
                    if (!sigunguSalesData[sigungu]) {
                        sigunguSalesData[sigungu] = {
                            sales: 0,
                            count: 0,  // 거래처 수
                            clients: []
                        };
                    }
                    sigunguSalesData[sigungu].sales += clientData.sales || 0;
                    sigunguSalesData[sigungu].count += 1;  // 거래처 1개 추가
                    sigunguSalesData[sigungu].clients.push({
                        name: c[0],
                        sales: clientData.sales || 0,
                        address: address
                    });
                }
            });

            console.log('[SVG MAP] 시군구별 거래처:', Object.entries(sigunguSalesData).map(([k,v]) => `${k}:${v.count}개`).slice(0,10).join(', '));
        }

        // 마우스 오버 핸들러
        function handleMapMouseOver(element, event, level) {
            const name = d3.select(element).attr('data-name');
            d3.select(element).attr('stroke', '#1e3a8a').attr('stroke-width', '2');

            let data;
            if (level === 'sido') {
                const shortName = SIDO_NAME_MAP[name] || name;
                data = sidoSalesData[shortName];
            } else {
                data = sigunguSalesData[name];
            }

            if (data) {
                const tooltip = document.getElementById('mapTooltip');
                const countLabel = level === 'sigungu' ? '거래처' : '거래';
                const countUnit = level === 'sigungu' ? '개' : '건';
                tooltip.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 8px;">${name}</div>
                    <div>매출: ${formatCurrency(data.sales)}</div>
                    <div>${countLabel}: ${data.count.toLocaleString()}${countUnit}</div>
                `;
                tooltip.style.display = 'block';
                tooltip.style.left = (event.offsetX + 10) + 'px';
                tooltip.style.top = (event.offsetY + 10) + 'px';
            }
        }

        function handleMapMouseOut(element) {
            d3.select(element).attr('stroke', '#94a3b8').attr('stroke-width', '1');
            document.getElementById('mapTooltip').style.display = 'none';
        }

        function handleMapMouseMove(event) {
            const tooltip = document.getElementById('mapTooltip');
            tooltip.style.left = (event.offsetX + 10) + 'px';
            tooltip.style.top = (event.offsetY + 10) + 'px';
        }

        // 시/도 지도 색상 업데이트
        function updateSidoMapColors() {
            if (!regionAnalysisData || !regionAnalysisData.regionData) return;

            sidoSalesData = {};
            regionAnalysisData.regionData.forEach(r => {
                const sido = r.sido || r.name.split(' ')[0];
                if (!sidoSalesData[sido]) {
                    sidoSalesData[sido] = { sales: 0, count: 0 };
                }
                sidoSalesData[sido].sales += r.sales;
                sidoSalesData[sido].count += r.count;
            });

            Object.entries(SIDO_NAME_MAP).forEach(([fullName, shortName]) => {
                const path = d3.select('#region-' + fullName);
                if (path.empty()) return;

                const data = sidoSalesData[shortName];
                const color = getColorBySales(data?.sales || 0);
                path.transition().duration(300).attr('fill', color);
            });
        }

        // 시군구 지도 색상 업데이트 (거래처 수 기준)
        function updateSigunguMapColors() {
            Object.entries(sigunguSalesData).forEach(([name, data]) => {
                const path = d3.select('#region-' + name);
                if (path.empty()) return;

                const color = getColorByCount(data.count);
                path.transition().duration(300).attr('fill', color);
            });
        }

        // 매출액에 따른 색상 반환 (시/도 지도용)
        function getColorBySales(sales) {
            if (sales >= 1000000000) return '#dc2626';      // 10억+ 빨간색
            if (sales >= 500000000) return '#f97316';       // 5~10억 주황색
            if (sales >= 100000000) return '#eab308';       // 1~5억 노란색
            if (sales > 0) return '#22c55e';                 // 1억 미만 초록색
            return '#e2e8f0';                                // 데이터 없음 회색
        }

        // 거래처 수에 따른 색상 반환 (시군구 지도용)
        function getColorByCount(count) {
            if (count >= 50) return '#dc2626';      // 50개+ 빨간색
            if (count >= 20) return '#f97316';      // 20~49개 주황색
            if (count >= 10) return '#eab308';      // 10~19개 노란색
            if (count >= 5) return '#22c55e';       // 5~9개 초록색
            if (count > 0) return '#06b6d4';        // 1~4개 청록색
            return '#e2e8f0';                        // 데이터 없음 회색
        }

        // 시/도 요약 표시
        function showSidoSummary(sidoName) {
            const shortName = SIDO_NAME_MAP[sidoName] || sidoName;
            const data = sidoSalesData[shortName];
            if (!data) return;

            const detailTitle = document.getElementById('regionDetailTitle');
            const detailBadge = document.getElementById('regionDetailBadge');
            const detailBody = document.getElementById('regionDetailBody');

            if (detailTitle) detailTitle.textContent = `📍 ${sidoName}`;
            if (detailBadge) detailBadge.textContent = `${Object.keys(sigunguSalesData).length}개 시군구`;

            const sortedSigungu = Object.entries(sigunguSalesData)
                .sort((a, b) => b[1].count - a[1].count)  // 거래처 수 순 정렬
                .slice(0, 15);

            // 총 거래처 수 계산
            const totalClients = Object.values(sigunguSalesData).reduce((sum, d) => sum + d.count, 0);
            const totalSales = Object.values(sigunguSalesData).reduce((sum, d) => sum + d.sales, 0);

            if (detailBody) {
                detailBody.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                        <div style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; padding: 16px; border-radius: 12px;">
                            <div style="font-size: 12px; opacity: 0.9;">총 매출</div>
                            <div style="font-size: 20px; font-weight: bold;">${formatCurrency(totalSales)}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #10b981, #34d399); color: white; padding: 16px; border-radius: 12px;">
                            <div style="font-size: 12px; opacity: 0.9;">거래처 수</div>
                            <div style="font-size: 20px; font-weight: bold;">${totalClients.toLocaleString()}개</div>
                        </div>
                    </div>
                    <div style="font-weight: 600; margin-bottom: 8px; color: #374151;">📊 시/군/구별 거래처 분포</div>
                    <div style="font-size: 12px; color: #64748b; margin-bottom: 12px;">지도에서 시군구를 클릭하면 거래처 목록을 볼 수 있습니다</div>
                    <div class="scroll-table" style="max-height: 280px;">
                        <table class="data-table">
                            <thead><tr><th>시/군/구</th><th class="text-right">거래처</th><th class="text-right">매출</th></tr></thead>
                            <tbody>
                                ${sortedSigungu.map(([name, d]) => `
                                    <tr style="cursor: pointer;" onclick="showSigunguDetail('${name}')">
                                        <td>${name}</td>
                                        <td class="text-right" style="color: #dc2626; font-weight: 600;">${d.count}개</td>
                                        <td class="text-right">${formatCurrency(d.sales)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
        }

        // 시군구 상세 정보 표시
        function showSigunguDetail(sigunguName) {
            const data = sigunguSalesData[sigunguName];
            if (!data) return;

            const detailTitle = document.getElementById('regionDetailTitle');
            const detailBadge = document.getElementById('regionDetailBadge');
            const detailBody = document.getElementById('regionDetailBody');

            const fullRegionName = currentSido ? `${SIDO_NAME_MAP[currentSido] || currentSido} ${sigunguName}` : sigunguName;

            if (detailTitle) detailTitle.textContent = `📍 ${sigunguName}`;
            if (detailBadge) detailBadge.textContent = `${data.count}개 거래처`;

            // sigunguSalesData에 저장된 거래처 목록 사용
            const clients = (data.clients || []).sort((a, b) => b.sales - a.sales).slice(0, 15);

            if (detailBody) {
                detailBody.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                        <div style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; padding: 16px; border-radius: 12px;">
                            <div style="font-size: 12px; opacity: 0.9;">총 매출</div>
                            <div style="font-size: 20px; font-weight: bold;">${formatCurrency(data.sales)}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #dc2626, #f87171); color: white; padding: 16px; border-radius: 12px;">
                            <div style="font-size: 12px; opacity: 0.9;">거래처 수</div>
                            <div style="font-size: 20px; font-weight: bold;">${data.count.toLocaleString()}개</div>
                        </div>
                    </div>
                    ${clients.length > 0 ? `
                        <div style="font-weight: 600; margin-bottom: 8px; color: #374151;">🏢 거래처 목록 (매출순)</div>
                        <div class="scroll-table" style="max-height: 300px;">
                            <table class="data-table">
                                <thead><tr><th>거래처명</th><th class="text-right">매출</th></tr></thead>
                                <tbody>
                                    ${clients.map(c => `
                                        <tr>
                                            <td title="${c.address || ''}">${c.name}</td>
                                            <td class="text-right">${formatCurrency(c.sales)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : `
                        <div style="text-align: center; color: #94a3b8; padding: 40px;">
                            <div style="font-size: 32px; margin-bottom: 8px;">📭</div>
                            <div>거래처 정보가 없습니다</div>
                        </div>
                    `}
                `;
            }
        }

        // SVG 지도 초기화 (기존 함수 대체)
        async function initSvgMap() {
            await loadSidoMap();
        }

        // SVG 지도 색상 업데이트 (기존 함수 대체)
        function updateSvgMapColors() {
            if (currentMapLevel === 'sido') {
                updateSidoMapColors();
            } else {
                updateSigunguMapColors();
            }
        }

        // 식품제조가공업 통계 데이터
        let foodManufacturingData = null;

        async function loadFoodManufacturingStats() {
            const loadingEl = document.getElementById('foodStatsLoading');
            const emptyEl = document.getElementById('foodStatsEmpty');
            const tableEl = document.getElementById('foodStatsTable');
            const badgeEl = document.getElementById('foodStatsBadge');
            const btnEl = document.getElementById('loadFoodStatsBtn');

            // 로딩 상태
            loadingEl.style.display = 'block';
            emptyEl.style.display = 'none';
            tableEl.style.display = 'none';
            btnEl.disabled = true;
            btnEl.textContent = '⏳ 로딩 중...';

            try {
                const response = await fetch('/api/food-manufacturing/stats');
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || '데이터 로드 실패');
                }

                foodManufacturingData = result.data;
                renderFoodStatsTable();

                badgeEl.textContent = result.cached ? '캐시 데이터' : '최신 데이터';
                badgeEl.style.background = result.cached ? '#fef3c7' : '#dcfce7';
                badgeEl.style.color = result.cached ? '#92400e' : '#166534';

            } catch (error) {
                console.error('[FoodStats] 로드 실패:', error);
                emptyEl.innerHTML = `
                    <div style="font-size: 32px; margin-bottom: 8px;">❌</div>
                    <div style="font-size: 13px; color: #dc2626;">데이터 로드 실패: ${error.message}</div>
                    <div style="font-size: 11px; margin-top: 4px;">잠시 후 다시 시도해주세요.</div>
                `;
                emptyEl.style.display = 'block';
                badgeEl.textContent = '로드 실패';
                badgeEl.style.background = '#fee2e2';
                badgeEl.style.color = '#991b1b';
            } finally {
                loadingEl.style.display = 'none';
                btnEl.disabled = false;
                btnEl.textContent = '🔄 새로고침';
            }
        }

        function renderFoodStatsTable() {
            if (!foodManufacturingData || !currentData) return;

            const tableEl = document.getElementById('foodStatsTable');
            const tbodyEl = document.getElementById('foodStatsTableBody');
            const emptyEl = document.getElementById('foodStatsEmpty');

            // 제외할 거래처
            const EXCLUDED_CLIENTS = ['IBK', 'IGC'];

            // 우리 거래처 데이터 집계 (시도별)
            const ourClientsBySido = {};
            const clients = currentData.by_client || [];

            clients.forEach(c => {
                const clientName = c[0] || '';
                // 제외 대상 체크
                if (EXCLUDED_CLIENTS.includes(clientName)) return;

                const addr = c[1]?.address || '';
                if (!addr) return;

                // 식품제조가공업 필터: 시험분야="식품" AND 업체분류="식품" OR "식품,축산"
                const testFields = c[1]?.testFields || [];
                const companyTypes = c[1]?.companyTypes || [];
                const hasFood = testFields.includes('식품');  // 정확히 "식품" 일치
                const isFoodCompany = companyTypes.includes('식품') || companyTypes.includes('식품,축산');
                if (!hasFood || !isFoodCompany) return;

                // 시도 추출 (JavaScript 버전)
                const sidoPatterns = {
                    '서울특별시': '서울', '서울시': '서울', '서울': '서울',
                    '부산광역시': '부산', '부산시': '부산', '부산': '부산',
                    '대구광역시': '대구', '대구시': '대구', '대구': '대구',
                    '인천광역시': '인천', '인천시': '인천', '인천': '인천',
                    '광주광역시': '광주', '광주시': '광주', '광주': '광주',
                    '대전광역시': '대전', '대전시': '대전', '대전': '대전',
                    '울산광역시': '울산', '울산시': '울산', '울산': '울산',
                    '세종특별자치시': '세종', '세종시': '세종', '세종': '세종',
                    '경기도': '경기', '경기': '경기',
                    '강원도': '강원', '강원특별자치도': '강원', '강원': '강원',
                    '충청북도': '충북', '충북': '충북',
                    '충청남도': '충남', '충남': '충남',
                    '전라북도': '전북', '전북특별자치도': '전북', '전북': '전북',
                    '전라남도': '전남', '전남': '전남',
                    '경상북도': '경북', '경북': '경북',
                    '경상남도': '경남', '경남': '경남',
                    '제주특별자치도': '제주', '제주도': '제주', '제주': '제주'
                };

                let sido = null;
                for (const [pattern, short] of Object.entries(sidoPatterns).sort((a, b) => b[0].length - a[0].length)) {
                    if (addr.includes(pattern)) {
                        sido = short;
                        break;
                    }
                }

                if (sido) {
                    ourClientsBySido[sido] = (ourClientsBySido[sido] || 0) + 1;
                }
            });

            // 테이블 데이터 구성
            const tableData = [];
            const sidoOrder = ['서울', '경기', '인천', '부산', '대구', '광주', '대전', '울산', '세종',
                              '강원', '충북', '충남', '전북', '전남', '경북', '경남', '제주'];

            sidoOrder.forEach(sido => {
                const foodData = foodManufacturingData[sido];
                const totalBusinesses = foodData?.total || 0;
                const ourClients = ourClientsBySido[sido] || 0;
                const shareRate = totalBusinesses > 0 ? (ourClients / totalBusinesses * 100) : 0;

                if (totalBusinesses > 0 || ourClients > 0) {
                    tableData.push({
                        sido,
                        totalBusinesses,
                        ourClients,
                        shareRate
                    });
                }
            });

            // 점유율 순으로 정렬
            tableData.sort((a, b) => b.shareRate - a.shareRate);

            // 테이블 렌더링
            tbodyEl.innerHTML = tableData.map((row, idx) => {
                const barColor = row.shareRate >= 5 ? '#22c55e' : row.shareRate >= 2 ? '#eab308' : row.shareRate >= 1 ? '#f97316' : '#94a3b8';
                const barWidth = Math.min(row.shareRate * 10, 100);  // 10% = 100%

                return `
                    <tr style="border-bottom: 1px solid #f1f5f9;">
                        <td style="padding: 10px 12px; font-weight: 600;">${row.sido}</td>
                        <td style="padding: 10px 12px; text-align: right; color: #64748b;">${row.totalBusinesses.toLocaleString()}개</td>
                        <td style="padding: 10px 12px; text-align: right; font-weight: 600; color: var(--primary);">${row.ourClients.toLocaleString()}개</td>
                        <td style="padding: 10px 12px; text-align: center;">
                            <span style="font-weight: 700; color: ${barColor};">${row.shareRate.toFixed(2)}%</span>
                        </td>
                        <td style="padding: 10px 12px;">
                            <div style="background: #f1f5f9; border-radius: 4px; height: 8px; overflow: hidden;">
                                <div style="background: ${barColor}; height: 100%; width: ${barWidth}%; transition: width 0.3s;"></div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            // 합계 행 추가
            const totalBiz = tableData.reduce((s, r) => s + r.totalBusinesses, 0);
            const totalOur = tableData.reduce((s, r) => s + r.ourClients, 0);
            const totalRate = totalBiz > 0 ? (totalOur / totalBiz * 100) : 0;

            tbodyEl.innerHTML += `
                <tr style="background: #f8fafc; font-weight: 700;">
                    <td style="padding: 12px;">전체</td>
                    <td style="padding: 12px; text-align: right;">${totalBiz.toLocaleString()}개</td>
                    <td style="padding: 12px; text-align: right; color: var(--primary);">${totalOur.toLocaleString()}개</td>
                    <td style="padding: 12px; text-align: center; color: #166534;">${totalRate.toFixed(2)}%</td>
                    <td style="padding: 12px;"></td>
                </tr>
            `;

            emptyEl.style.display = 'none';
            tableEl.style.display = 'table';
        }

        // 축산물 가공업 통계 데이터
        let livestockManufacturingData = null;

        async function loadLivestockStats() {
            const loadingEl = document.getElementById('livestockStatsLoading');
            const emptyEl = document.getElementById('livestockStatsEmpty');
            const tableEl = document.getElementById('livestockStatsTable');
            const badgeEl = document.getElementById('livestockStatsBadge');
            const btnEl = document.getElementById('loadLivestockStatsBtn');

            // 로딩 상태
            loadingEl.style.display = 'block';
            emptyEl.style.display = 'none';
            tableEl.style.display = 'none';
            btnEl.disabled = true;
            btnEl.textContent = '⏳ 로딩 중...';

            try {
                const response = await fetch('/api/livestock-manufacturing/stats');
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || '데이터 로드 실패');
                }

                livestockManufacturingData = result.data;
                renderLivestockStatsTable();

                badgeEl.textContent = result.cached ? '캐시 데이터' : '최신 데이터';
                badgeEl.style.background = result.cached ? '#fef3c7' : '#dcfce7';
                badgeEl.style.color = result.cached ? '#92400e' : '#166534';

            } catch (error) {
                console.error('[LivestockStats] 로드 실패:', error);
                emptyEl.innerHTML = `
                    <div style="font-size: 32px; margin-bottom: 8px;">❌</div>
                    <div style="font-size: 13px; color: #dc2626;">데이터 로드 실패: ${error.message}</div>
                    <div style="font-size: 11px; margin-top: 4px;">잠시 후 다시 시도해주세요.</div>
                `;
                emptyEl.style.display = 'block';
                badgeEl.textContent = '로드 실패';
                badgeEl.style.background = '#fee2e2';
                badgeEl.style.color = '#991b1b';
            } finally {
                loadingEl.style.display = 'none';
                btnEl.disabled = false;
                btnEl.textContent = '🔄 새로고침';
            }
        }

        function renderLivestockStatsTable() {
            if (!livestockManufacturingData || !currentData) return;

            const tableEl = document.getElementById('livestockStatsTable');
            const tbodyEl = document.getElementById('livestockStatsTableBody');
            const emptyEl = document.getElementById('livestockStatsEmpty');

            // 제외할 거래처
            const EXCLUDED_CLIENTS = ['IBK', 'IGC'];

            // 우리 거래처 데이터 집계 (시도별)
            const ourClientsBySido = {};
            const clients = currentData.by_client || [];

            clients.forEach(c => {
                const clientName = c[0] || '';
                if (EXCLUDED_CLIENTS.includes(clientName)) return;

                const addr = c[1]?.address || '';
                if (!addr) return;

                // 축산물가공업 필터: 시험분야="축산" AND 업체분류="축산" OR "식품,축산"
                const testFields = c[1]?.testFields || [];
                const companyTypes = c[1]?.companyTypes || [];
                const hasLivestock = testFields.includes('축산');  // 정확히 "축산" 일치
                const isLivestockCompany = companyTypes.includes('축산') || companyTypes.includes('식품,축산');
                if (!hasLivestock || !isLivestockCompany) return;

                const sidoPatterns = {
                    '서울특별시': '서울', '서울시': '서울', '서울': '서울',
                    '부산광역시': '부산', '부산시': '부산', '부산': '부산',
                    '대구광역시': '대구', '대구시': '대구', '대구': '대구',
                    '인천광역시': '인천', '인천시': '인천', '인천': '인천',
                    '광주광역시': '광주', '광주시': '광주', '광주': '광주',
                    '대전광역시': '대전', '대전시': '대전', '대전': '대전',
                    '울산광역시': '울산', '울산시': '울산', '울산': '울산',
                    '세종특별자치시': '세종', '세종시': '세종', '세종': '세종',
                    '경기도': '경기', '경기': '경기',
                    '강원도': '강원', '강원특별자치도': '강원', '강원': '강원',
                    '충청북도': '충북', '충북': '충북',
                    '충청남도': '충남', '충남': '충남',
                    '전라북도': '전북', '전북특별자치도': '전북', '전북': '전북',
                    '전라남도': '전남', '전남': '전남',
                    '경상북도': '경북', '경북': '경북',
                    '경상남도': '경남', '경남': '경남',
                    '제주특별자치도': '제주', '제주도': '제주', '제주': '제주'
                };

                let sido = null;
                for (const [pattern, short] of Object.entries(sidoPatterns).sort((a, b) => b[0].length - a[0].length)) {
                    if (addr.includes(pattern)) {
                        sido = short;
                        break;
                    }
                }

                if (sido) {
                    ourClientsBySido[sido] = (ourClientsBySido[sido] || 0) + 1;
                }
            });

            // 테이블 데이터 구성
            const tableData = [];
            const sidoOrder = ['서울', '경기', '인천', '부산', '대구', '광주', '대전', '울산', '세종',
                              '강원', '충북', '충남', '전북', '전남', '경북', '경남', '제주'];

            sidoOrder.forEach(sido => {
                const livestockData = livestockManufacturingData[sido];
                const totalBusinesses = livestockData?.total || 0;
                const ourClients = ourClientsBySido[sido] || 0;
                const shareRate = totalBusinesses > 0 ? (ourClients / totalBusinesses * 100) : 0;

                if (totalBusinesses > 0 || ourClients > 0) {
                    tableData.push({
                        sido,
                        totalBusinesses,
                        ourClients,
                        shareRate
                    });
                }
            });

            // 점유율 순으로 정렬
            tableData.sort((a, b) => b.shareRate - a.shareRate);

            // 테이블 렌더링
            tbodyEl.innerHTML = tableData.map((row, idx) => {
                const barColor = row.shareRate >= 5 ? '#dc2626' : row.shareRate >= 2 ? '#f97316' : row.shareRate >= 1 ? '#eab308' : '#94a3b8';
                const barWidth = Math.min(row.shareRate * 10, 100);

                return `
                    <tr style="border-bottom: 1px solid #fef2f2;">
                        <td style="padding: 10px 12px; font-weight: 600;">${row.sido}</td>
                        <td style="padding: 10px 12px; text-align: right; color: #64748b;">${row.totalBusinesses.toLocaleString()}개</td>
                        <td style="padding: 10px 12px; text-align: right; font-weight: 600; color: #dc2626;">${row.ourClients.toLocaleString()}개</td>
                        <td style="padding: 10px 12px; text-align: center;">
                            <span style="font-weight: 700; color: ${barColor};">${row.shareRate.toFixed(2)}%</span>
                        </td>
                        <td style="padding: 10px 12px;">
                            <div style="background: #fef2f2; border-radius: 4px; height: 8px; overflow: hidden;">
                                <div style="background: ${barColor}; height: 100%; width: ${barWidth}%; transition: width 0.3s;"></div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            // 합계 행 추가
            const totalBiz = tableData.reduce((s, r) => s + r.totalBusinesses, 0);
            const totalOur = tableData.reduce((s, r) => s + r.ourClients, 0);
            const totalRate = totalBiz > 0 ? (totalOur / totalBiz * 100) : 0;

            tbodyEl.innerHTML += `
                <tr style="background: #fef2f2; font-weight: 700;">
                    <td style="padding: 12px;">전체</td>
                    <td style="padding: 12px; text-align: right;">${totalBiz.toLocaleString()}개</td>
                    <td style="padding: 12px; text-align: right; color: #dc2626;">${totalOur.toLocaleString()}개</td>
                    <td style="padding: 12px; text-align: center; color: #991b1b;">${totalRate.toFixed(2)}%</td>
                    <td style="padding: 12px;"></td>
                </tr>
            `;

            emptyEl.style.display = 'none';
            tableEl.style.display = 'table';
        }

        function updateRegionTab() {
            const regions = currentData.by_region || [];
            const compareRegions = compareData?.by_region || [];
            const regionTopManagers = currentData.region_top_managers || {};
            const managerRegions = currentData.manager_regions || {};
            const clients = currentData.by_client || [];

            const total = regions.reduce((s, r) => s + r[1].sales, 0) || 1;

            // 비교 데이터 맵 생성
            const currentRegionMap = Object.fromEntries(regions.map(r => [r[0], r[1]]));
            const compareRegionMap = Object.fromEntries(compareRegions.map(r => [r[0], r[1]]));

            // 지역별 분석 데이터 생성
            const regionData = regions.map(r => {
                const name = r[0];
                const data = r[1];
                const lastYear = compareRegionMap[name] || { sales: 0, count: 0 };
                const growth = data.sales - lastYear.sales;
                const growthRate = lastYear.sales > 0 ? ((growth / lastYear.sales) * 100) : (data.sales > 0 ? 100 : 0);
                return {
                    name,
                    sales: data.sales,
                    count: data.count,
                    sido: data.sido,
                    lastYearSales: lastYear.sales,
                    lastYearCount: lastYear.count,
                    growth,
                    growthRate,
                    isNew: !compareRegionMap[name] && data.sales > 0,
                    percent: (data.sales / total * 100)
                };
            });

            // 신규 지역 (전년 없고 올해 있음)
            const newRegions = regionData.filter(r => r.isNew);
            // 성장 지역 (성장률 높은 순)
            const growthRegions = [...regionData].filter(r => r.lastYearSales > 0).sort((a, b) => b.growthRate - a.growthRate);
            // 감소 지역 (공략 필요)
            const weakRegions = [...regionData].filter(r => r.growthRate < 0 && r.lastYearSales > 0).sort((a, b) => a.growthRate - b.growthRate);
            // 주력 지역 (매출 높은 순)
            const mainRegions = [...regionData].sort((a, b) => b.sales - a.sales);

            regionAnalysisData = { regionData, newRegions, growthRegions, weakRegions, mainRegions, regionTopManagers, managerRegions };

            // KPI 업데이트
            updateRegionKPIs(mainRegions, growthRegions, newRegions, weakRegions);

            // SVG 지도 업데이트
            initSvgMap().then(() => {
                updateSvgMapColors();
            });

            // 차트 업데이트
            updateRegionSalesChart(regionData);
            updateRegionGrowthChart(regionData);

            // 테이블 업데이트
            updateRegionHeatmapTable(regionData);
            updateRegionTopClientTable(regions, clients);
            updateManagerRegionTable(managerRegions);
        }

        function updateRegionKPIs(mainRegions, growthRegions, newRegions, weakRegions) {
            // 주력 지역
            if (mainRegions.length > 0) {
                const main = mainRegions[0];
                document.getElementById('mainRegionName').textContent = main.name;
                document.getElementById('mainRegionValue').textContent = formatCurrency(main.sales) + ' (' + main.percent.toFixed(1) + '%)';

                const overlay = document.getElementById('mainRegionOverlay');
                overlay.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 8px;">📊 매출 TOP 5 지역</div>
                    ${mainRegions.slice(0, 5).map((r, i) => `
                        <div style="display: flex; justify-content: space-between; padding: 4px 0;">
                            <span>${i + 1}. ${r.name}</span>
                            <span>${formatCurrency(r.sales)} (${r.percent.toFixed(1)}%)</span>
                        </div>
                    `).join('')}
                `;
            }

            // 성장 지역
            if (growthRegions.length > 0) {
                const growth = growthRegions[0];
                document.getElementById('growthRegionName').textContent = growth.name;
                document.getElementById('growthRegionValue').textContent = '+' + growth.growthRate.toFixed(1) + '% 성장';

                const overlay = document.getElementById('growthRegionOverlay');
                overlay.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 8px;">📈 성장률 TOP 5 지역</div>
                    ${growthRegions.slice(0, 5).map((r, i) => `
                        <div style="display: flex; justify-content: space-between; padding: 4px 0;">
                            <span>${i + 1}. ${r.name}</span>
                            <span style="color: var(--success);">+${r.growthRate.toFixed(1)}%</span>
                        </div>
                    `).join('')}
                `;
            } else {
                document.getElementById('growthRegionName').textContent = '-';
                document.getElementById('growthRegionValue').textContent = '비교 데이터 없음';
            }

            // 신규 진출
            if (newRegions.length > 0) {
                document.getElementById('newRegionName').textContent = newRegions.length + '개 지역';
                document.getElementById('newRegionValue').textContent = '올해 첫 거래';

                const overlay = document.getElementById('newRegionOverlay');
                overlay.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 8px;">🆕 신규 진출 지역</div>
                    ${newRegions.map((r, i) => `
                        <div style="display: flex; justify-content: space-between; padding: 4px 0;">
                            <span>${i + 1}. ${r.name}</span>
                            <span>${formatCurrency(r.sales)}</span>
                        </div>
                    `).join('')}
                `;
            } else {
                document.getElementById('newRegionName').textContent = '-';
                document.getElementById('newRegionValue').textContent = '신규 없음';
            }

            // 공략 필요
            if (weakRegions.length > 0) {
                const weak = weakRegions[0];
                document.getElementById('weakRegionName').textContent = weak.name;
                document.getElementById('weakRegionValue').textContent = weak.growthRate.toFixed(1) + '% 감소';

                const overlay = document.getElementById('weakRegionOverlay');
                overlay.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 8px;">⚠️ 공략 필요 지역</div>
                    ${weakRegions.slice(0, 5).map((r, i) => `
                        <div style="display: flex; justify-content: space-between; padding: 4px 0;">
                            <span>${i + 1}. ${r.name}</span>
                            <span style="color: var(--danger);">${r.growthRate.toFixed(1)}%</span>
                        </div>
                    `).join('')}
                `;
            } else {
                document.getElementById('weakRegionName').textContent = '-';
                document.getElementById('weakRegionValue').textContent = '감소 지역 없음';
            }

            // KPI 오버레이 이벤트
            document.querySelectorAll('.region-kpi').forEach(card => {
                const overlay = card.querySelector('.region-kpi-overlay');
                if (overlay) {
                    card.addEventListener('mouseenter', () => {
                        overlay.style.display = 'block';
                    });
                    card.addEventListener('mouseleave', () => { overlay.style.display = 'none'; });
                }
            });
        }


        function updateRegionSalesChart(regionData) {
            const sorted = [...regionData].sort((a, b) => b.sales - a.sales).slice(0, 15);
            const totalSales = sorted.reduce((s, r) => s + r.sales, 0);
            const totalCount = sorted.reduce((s, r) => s + r.count, 0);
            const allTotalSales = regionData.reduce((s, r) => s + r.sales, 0);
            const allTotalCount = regionData.reduce((s, r) => s + r.count, 0);

            document.getElementById('regionSalesChartBadge').textContent = currentData.year + '년';

            // regionSalesChartSummary 요약 정보 표시
            const regionSalesSummaryEl = document.getElementById('regionSalesChartSummary');
            if (regionSalesSummaryEl) {
                const avgPrice = allTotalCount > 0 ? allTotalSales / allTotalCount : 0;
                const top5Sales = sorted.slice(0, 5).reduce((s, r) => s + r.sales, 0);
                const top5Ratio = allTotalSales > 0 ? (top5Sales / allTotalSales * 100) : 0;
                let rsHtml = `<span style="white-space:nowrap;background:#dbeafe;padding:4px 10px;border-radius:4px;color:#1e40af;">총매출: <strong style="color:#3b82f6;">${(allTotalSales / 100000000).toFixed(1)}억</strong></span>`;
                rsHtml += `<span style="white-space:nowrap;background:#e0e7ff;padding:4px 10px;border-radius:4px;color:#3730a3;">건수: <strong>${allTotalCount.toLocaleString()}건</strong></span>`;
                rsHtml += `<span style="white-space:nowrap;background:#fce7f3;padding:4px 10px;border-radius:4px;color:#9d174d;">평균단가: <strong>${Math.round(avgPrice / 10000).toLocaleString()}만</strong></span>`;
                rsHtml += `<span style="white-space:nowrap;background:#fef08a;padding:4px 10px;border-radius:4px;color:#854d0e;">TOP5비중: <strong>${top5Ratio.toFixed(1)}%</strong></span>`;
                regionSalesSummaryEl.innerHTML = rsHtml;
            }

            const ctx = document.getElementById('regionSalesChart');
            if (!ctx) return;
            if (charts.regionSales) charts.regionSales.destroy();

            // 외부 툴팁
            const getOrCreateRegionSalesTooltip = () => {
                let el = document.getElementById('regionSalesChartTooltip');
                if (!el) {
                    el = document.createElement('div');
                    el.id = 'regionSalesChartTooltip';
                    el.style.cssText = 'position:fixed;background:rgba(30,41,59,0.98);border-radius:12px;padding:16px;pointer-events:auto;z-index:99999;font-size:13px;color:#e2e8f0;box-shadow:0 20px 40px rgba(0,0,0,0.4);min-width:280px;max-width:350px;max-height:85vh;overflow-y:auto;transition:opacity 0.15s ease;line-height:1.5;';
                    document.body.appendChild(el); setupTooltipHover(el);
                }
                return el;
            };

            charts.regionSales = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: sorted.map(r => r.name),
                    datasets: [{
                        label: '매출',
                        data: sorted.map(r => r.sales),
                        backgroundColor: sorted.map(r => r.growthRate >= 0 ? 'rgba(99, 102, 241, 0.8)' : 'rgba(239, 68, 68, 0.6)'),
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: true },
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: false,
                            external: function(context) {
                                const tooltipEl = getOrCreateRegionSalesTooltip();
                                if (context.tooltip.opacity === 0 && !isTooltipHovered(tooltipEl)) { hideTooltipWithDelay(tooltipEl); return; }

                                const idx = context.tooltip.dataPoints?.[0]?.dataIndex;
                                if (idx === undefined) return;

                                const r = sorted[idx];
                                const rank = idx + 1;
                                const avgPrice = r.count > 0 ? r.sales / r.count : 0;

                                const rankIcon = rank === 1 ? '🏆' : rank === 2 ? '🥈' : rank === 3 ? '🥉' : '';
                                const growthColor = r.growthRate >= 0 ? '#10b981' : '#ef4444';

                                let html = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                                    <span style="font-size:15px;font-weight:bold;">${rankIcon} 📍 ${r.name}</span>
                                    <span style="background:rgba(255,255,255,0.2);padding:4px 10px;border-radius:6px;font-size:12px;">매출 ${rank}위</span>
                                </div>`;

                                html += `<div style="background:rgba(255,255,255,0.05);padding:10px;border-radius:8px;margin-bottom:10px;">`;
                                html += `<div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>💰 매출</span><strong>${formatCurrency(r.sales)}</strong></div>`;
                                html += `<div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>📋 건수</span><strong>${r.count.toLocaleString()}건</strong></div>`;
                                html += `<div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>📊 건당 매출</span><strong>${formatCurrency(Math.round(avgPrice))}</strong></div>`;
                                html += `<div style="display:flex;justify-content:space-between;"><span>📈 비중</span><strong>${r.percent.toFixed(1)}%</strong></div>`;
                                html += `</div>`;

                                // 모든 비교 연도별 대비 정보
                                if (compareDataList && compareDataList.length > 0) {
                                    html += `<div style="padding:10px;border-radius:6px;background:rgba(99,102,241,0.1);">`;
                                    compareDataList.forEach((compData, compIdx) => {
                                        const compRegionMap = Object.fromEntries((compData.by_region || []).map(rg => [rg[0], rg[1]]));
                                        const compRegion = compRegionMap[r.name];
                                        if (compRegion && compRegion.sales > 0) {
                                            const compGrowth = r.sales - compRegion.sales;
                                            const compGrowthRate = (compGrowth / compRegion.sales * 100);
                                            const compGrowthColor = compGrowthRate >= 0 ? '#10b981' : '#ef4444';
                                            html += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:${compIdx < compareDataList.length - 1 ? '6px' : '0'};">
                                                <span>📅 ${compData.year}년 대비</span>
                                                <span style="color:${compGrowthColor};font-weight:bold;">${compGrowthRate >= 0 ? '+' : ''}${compGrowthRate.toFixed(1)}%</span>
                                            </div>
                                            <div style="color:#94a3b8;font-size:11px;margin-bottom:${compIdx < compareDataList.length - 1 ? '8px;border-bottom:1px dashed rgba(255,255,255,0.1);padding-bottom:6px' : '0'};">
                                                ${formatCurrency(compRegion.sales)} → ${formatCurrency(r.sales)}
                                            </div>`;
                                        }
                                    });
                                    html += `</div>`;
                                } else {
                                    html += `<div style="padding:10px;border-radius:6px;background:${r.growthRate >= 0 ? 'rgba(16,185,129,0.1)' : 'rgba(239,68,68,0.1)'};">
                                        <div style="display:flex;justify-content:space-between;align-items:center;">
                                            <span>📅 전년 대비</span>
                                            <span style="color:${growthColor};font-weight:bold;font-size:16px;">${r.growthRate >= 0 ? '+' : ''}${r.growthRate.toFixed(1)}%</span>
                                        </div>
                                        <div style="color:#94a3b8;font-size:11px;margin-top:4px;">
                                            ${formatCurrency(r.lastYearSales || 0)} → ${formatCurrency(r.sales)}
                                        </div>
                                    </div>`;
                                }

                                tooltipEl.innerHTML = html;
                                tooltipEl.style.opacity = 1; tooltipEl.style.pointerEvents = 'auto';
                                const pos = context.chart.canvas.getBoundingClientRect();
                                tooltipEl.style.left = Math.min(pos.left + context.tooltip.caretX + 10, window.innerWidth - 360) + 'px';
                                tooltipEl.style.top = Math.min(pos.top + context.tooltip.caretY, window.innerHeight - 300) + 'px';
                            }
                        }
                    },
                    scales: {
                        x: { beginAtZero: true, ticks: { callback: v => (v / 100000000).toFixed(0) + '억' } }
                    }
                }
            });
        }

        function updateRegionGrowthChart(regionData) {
            const sorted = [...regionData].filter(r => r.lastYearSales > 0)
                .sort((a, b) => b.growthRate - a.growthRate);
            const avgGrowth = sorted.reduce((s, r) => s + r.growthRate, 0) / (sorted.length || 1);

            // regionGrowthChartSummary 요약 정보 표시
            const regionGrowthSummaryEl = document.getElementById('regionGrowthChartSummary');
            if (regionGrowthSummaryEl) {
                const positiveCount = sorted.filter(r => r.growthRate >= 0).length;
                const negativeCount = sorted.filter(r => r.growthRate < 0).length;
                const avgGrowthColor = avgGrowth >= 0 ? '#059669' : '#dc2626';
                let rgHtml = `<span style="white-space:nowrap;background:${avgGrowth >= 0 ? '#d1fae5' : '#fee2e2'};padding:4px 10px;border-radius:4px;color:${avgGrowthColor};">평균성장률: <strong>${avgGrowth >= 0 ? '+' : ''}${avgGrowth.toFixed(1)}%</strong></span>`;
                rgHtml += `<span style="white-space:nowrap;background:#d1fae5;padding:4px 10px;border-radius:4px;color:#059669;">성장: <strong>${positiveCount}개</strong></span>`;
                rgHtml += `<span style="white-space:nowrap;background:#fee2e2;padding:4px 10px;border-radius:4px;color:#dc2626;">하락: <strong>${negativeCount}개</strong></span>`;
                rgHtml += `<span style="white-space:nowrap;background:#e0e7ff;padding:4px 10px;border-radius:4px;color:#3730a3;">지역수: <strong>${sorted.length}개</strong></span>`;
                regionGrowthSummaryEl.innerHTML = rgHtml;
            }

            const ctx = document.getElementById('regionGrowthChart');
            if (!ctx) return;
            if (charts.regionGrowth) charts.regionGrowth.destroy();

            // 외부 툴팁
            const getOrCreateRegionGrowthTooltip = () => {
                let el = document.getElementById('regionGrowthChartTooltip');
                if (!el) {
                    el = document.createElement('div');
                    el.id = 'regionGrowthChartTooltip';
                    el.style.cssText = 'position:fixed;background:rgba(30,41,59,0.98);border-radius:12px;padding:16px;pointer-events:auto;z-index:99999;font-size:13px;color:#e2e8f0;box-shadow:0 20px 40px rgba(0,0,0,0.4);min-width:300px;max-width:380px;max-height:85vh;overflow-y:auto;transition:opacity 0.15s ease;line-height:1.5;';
                    document.body.appendChild(el); setupTooltipHover(el);
                }
                return el;
            };

            charts.regionGrowth = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: sorted.map(r => r.name),
                    datasets: [{
                        label: '성장률',
                        data: sorted.map(r => r.growthRate),
                        backgroundColor: sorted.map(r => r.growthRate >= 0 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)'),
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: true },
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: false,
                            external: function(context) {
                                const tooltipEl = getOrCreateRegionGrowthTooltip();
                                if (context.tooltip.opacity === 0 && !isTooltipHovered(tooltipEl)) { hideTooltipWithDelay(tooltipEl); return; }

                                const idx = context.tooltip.dataPoints?.[0]?.dataIndex;
                                if (idx === undefined) return;

                                const r = sorted[idx];
                                const rank = idx + 1;

                                // 성과 판단
                                let perfTag, perfIcon, perfColor;
                                if (r.growthRate >= 20) { perfTag = '급성장'; perfIcon = '🚀'; perfColor = '#10b981'; }
                                else if (r.growthRate >= 5) { perfTag = '성장'; perfIcon = '📈'; perfColor = '#22c55e'; }
                                else if (r.growthRate >= -5) { perfTag = '유지'; perfIcon = '➡️'; perfColor = '#94a3b8'; }
                                else if (r.growthRate >= -20) { perfTag = '하락'; perfIcon = '📉'; perfColor = '#f59e0b'; }
                                else { perfTag = '급감'; perfIcon = '⚠️'; perfColor = '#ef4444'; }

                                let html = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                                    <span style="font-size:15px;font-weight:bold;">📍 ${r.name}</span>
                                    <span style="background:${perfColor}22;color:${perfColor};padding:4px 10px;border-radius:6px;font-size:12px;">${perfIcon} ${perfTag}</span>
                                </div>`;

                                html += `<div style="text-align:center;padding:16px;background:${r.growthRate >= 0 ? 'rgba(16,185,129,0.1)' : 'rgba(239,68,68,0.1)'};border-radius:8px;margin-bottom:12px;">
                                    <div style="font-size:28px;font-weight:bold;color:${r.growthRate >= 0 ? '#10b981' : '#ef4444'};">${r.growthRate >= 0 ? '+' : ''}${r.growthRate.toFixed(1)}%</div>
                                    <div style="color:#94a3b8;font-size:12px;">전년 대비 성장률 (${rank}위/${sorted.length}개)</div>
                                </div>`;

                                html += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;">`;
                                html += `<div style="background:rgba(255,255,255,0.05);padding:10px;border-radius:6px;text-align:center;">
                                    <div style="color:#94a3b8;font-size:11px;">${currentData.year}년</div>
                                    <div style="font-weight:bold;">${formatCurrency(r.sales)}</div>
                                </div>`;
                                html += `<div style="background:rgba(255,255,255,0.05);padding:10px;border-radius:6px;text-align:center;">
                                    <div style="color:#94a3b8;font-size:11px;">${compareData?.year || '전년'}년</div>
                                    <div style="font-weight:bold;">${formatCurrency(r.lastYearSales)}</div>
                                </div>`;
                                html += `</div>`;

                                const diff = r.sales - (r.lastYearSales || 0);
                                html += `<div style="padding:8px;border-radius:6px;background:rgba(99,102,241,0.1);">
                                    💰 증감액: <span style="color:${diff >= 0 ? '#10b981' : '#ef4444'};font-weight:bold;">${diff >= 0 ? '+' : ''}${formatCurrency(diff)}</span>
                                    <span style="color:#94a3b8;font-size:11px;">(평균 성장률: ${avgGrowth >= 0 ? '+' : ''}${avgGrowth.toFixed(1)}%)</span>
                                </div>`;

                                tooltipEl.innerHTML = html;
                                tooltipEl.style.opacity = 1; tooltipEl.style.pointerEvents = 'auto';
                                const pos = context.chart.canvas.getBoundingClientRect();
                                tooltipEl.style.left = Math.min(pos.left + context.tooltip.caretX + 10, window.innerWidth - 390) + 'px';
                                tooltipEl.style.top = Math.min(pos.top + context.tooltip.caretY, window.innerHeight - 380) + 'px';
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { callback: v => v + '%' }
                        }
                    }
                }
            });
        }

        function updateRegionHeatmapTable(regionData) {
            const sorted = [...regionData].sort((a, b) => b.sales - a.sales);
            const total = sorted.reduce((s, r) => s + r.sales, 0) || 1;
            const avgGrowth = sorted.reduce((s, r) => s + r.growthRate, 0) / (sorted.length || 1);

            const tbody = document.querySelector('#regionHeatmapTable tbody');
            tbody.innerHTML = sorted.map(r => {
                const percent = (r.sales / total * 100).toFixed(1);
                const growthClass = r.growthRate > avgGrowth ? 'heatmap-high' :
                                   r.growthRate < 0 ? 'heatmap-low' : 'heatmap-medium';
                return `<tr onclick="showRegionDetailFromTable('${r.name}')" style="cursor: pointer;">
                    <td><strong>${r.name}</strong></td>
                    <td class="text-right">${formatCurrency(r.sales)}</td>
                    <td class="text-right">${r.count.toLocaleString()}</td>
                    <td class="text-right"><span class="${growthClass}">${r.growthRate >= 0 ? '+' : ''}${r.growthRate.toFixed(1)}%</span></td>
                    <td><div class="progress-cell"><div class="progress-bar"><div class="progress-fill" style="width: ${percent}%;"></div></div><span class="progress-value">${percent}%</span></div></td>
                </tr>`;
            }).join('');
        }

        function showRegionDetailFromTable(regionName) {
            // 지도에서 해당 지역 선택
            const path = document.querySelector(`.region-path[data-region="${regionName}"]`);
            if (path) {
                path.click();
            }
        }

        function updateRegionTopClientTable(regions, clients) {
            const regionClientMap = {};

            // 지역별 TOP 업체 집계
            clients.forEach(c => {
                const clientName = c[0];
                const clientData = c[1];

                // 간단한 지역 매칭 (업체 데이터에 지역 정보가 있으면 사용)
                regions.forEach(r => {
                    const regionName = r[0];
                    // 지역명이 업체 데이터에 포함되어 있는지 확인 (간단한 매칭)
                    if (!regionClientMap[regionName]) {
                        regionClientMap[regionName] = [];
                    }
                });
            });

            // region_top_managers를 이용해 지역별 주요 업체 표시
            const regionTopManagers = currentData.region_top_managers || {};
            const rows = [];

            regions.slice(0, 10).forEach(r => {
                const regionName = r[0];
                const managers = regionTopManagers[regionName] || [];
                if (managers.length > 0) {
                    const topManager = managers[0];
                    rows.push(`<tr>
                        <td><strong>${regionName}</strong></td>
                        <td>-</td>
                        <td class="text-right">${formatCurrency(r[1].sales)}</td>
                        <td>${topManager.name}</td>
                    </tr>`);
                } else {
                    rows.push(`<tr>
                        <td><strong>${regionName}</strong></td>
                        <td>-</td>
                        <td class="text-right">${formatCurrency(r[1].sales)}</td>
                        <td>-</td>
                    </tr>`);
                }
            });

            const tbody = document.querySelector('#regionTopClientTable tbody');
            tbody.innerHTML = rows.join('');
        }

        function updateManagerRegionTable(managerRegions) {
            const managers = Object.entries(managerRegions).map(([name, regions]) => {
                const totalSales = regions.reduce((s, r) => s + r.sales, 0);
                const mainRegion = regions[0]?.region || '-';
                return { name, regions, totalSales, mainRegion, regionCount: regions.length };
            }).sort((a, b) => b.totalSales - a.totalSales);

            document.getElementById('managerRegionBadge').textContent = managers.length + '명';

            const tbody = document.querySelector('#managerRegionTable tbody');
            tbody.innerHTML = managers.map(m => `<tr>
                <td><strong>${m.name}</strong></td>
                <td>${m.mainRegion}</td>
                <td class="text-right">${m.regionCount}개</td>
                <td class="text-right">${formatCurrency(m.totalSales)}</td>
                <td>
                    <div class="region-distribution">
                        ${m.regions.slice(0, 5).map(r => `<span class="region-chip">${r.region}</span>`).join('')}
                        ${m.regions.length > 5 ? `<span class="region-chip">+${m.regions.length - 5}</span>` : ''}
                    </div>
                </td>
            </tr>`).join('');
        }

        function updateSampleTypeTab() {
            const types = currentData.by_sample_type || [];
            const colors = ['blue', 'green', 'orange', 'purple', 'pink', 'info', 'teal', 'amber'];
            const icons = ['📦', '🌿', '🥩', '🐟', '💊', '🥤', '🧀', '📁'];
            const total = types.reduce((s, t) => s + t[1].sales, 0) || 1;

            document.getElementById('sampleTypeCount').textContent = types.length + '개 유형';

            // 검사목적 드롭다운 채우기
            const purposeSelect = document.getElementById('stPurposeFilter');
            const purposes = currentData.purposes || [];
            purposeSelect.innerHTML = '<option value="전체">전체</option>' +
                purposes.map(p => `<option value="${p}">${p}</option>`).join('');

            const grid = document.getElementById('sampleTypeGrid');
            grid.innerHTML = types.map((t, i) => {
                const avgSales = t[1].count > 0 ? Math.round(t[1].sales / t[1].count) : 0;
                const percent = (t[1].sales / total * 100).toFixed(1);
                return `
                <div class="purpose-kpi-card" data-color="${colors[i % colors.length]}">
                    <div class="purpose-kpi-header"><div class="purpose-kpi-icon">${icons[i % icons.length]}</div></div>
                    <div class="purpose-kpi-name">${t[0]}</div>
                    <div class="purpose-kpi-value">${formatCurrency(t[1].sales)}</div>
                    <div class="purpose-kpi-sub">건수: ${t[1].count.toLocaleString()}건 · 💰 ${formatCurrency(avgSales)}/건</div>
                    <div class="purpose-kpi-sub" style="margin-top: 4px;"><span style="background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">비중 ${percent}%</span></div>
                </div>
            `}).join('');

            // 담당자별 유형 보유 수 차트 & 지속적인 거래 테이블 업데이트
            updateSTManagerTypeChart();
            updateSTContinuousTradeTable();
        }

        // 검체유형 정렬 상태
        let stSortType = 'sales';
        let stPurposeFilter = '전체';

        function sortSampleTypeCards(sortType) {
            stSortType = sortType;

            // 버튼 스타일 업데이트 (인라인 스타일)
            const activeStyle = 'padding: 8px 14px; border-radius: 8px; border: none; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; font-size: 12px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 4px rgba(99,102,241,0.3); transition: all 0.2s;';
            const inactiveStyle = 'padding: 8px 14px; border-radius: 8px; border: 1px solid #e2e8f0; background: white; color: #64748b; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;';

            document.getElementById('stSortSales').style.cssText = sortType === 'sales' ? activeStyle : inactiveStyle;
            document.getElementById('stSortCount').style.cssText = sortType === 'count' ? activeStyle : inactiveStyle;
            document.getElementById('stSortAvg').style.cssText = sortType === 'avgSales' ? activeStyle : inactiveStyle;

            // 현재 필터 확인
            const currentFilter = document.getElementById('stPurposeFilter')?.value || '전체';
            let types = [];

            if (currentFilter !== '전체') {
                // 필터가 적용된 경우: 해당 목적의 데이터만 사용
                const stPurposes = currentData.sample_type_purposes || {};
                Object.entries(stPurposes).forEach(([sampleType, purposes]) => {
                    const matchPurpose = purposes.find(p => p.name === currentFilter);
                    if (matchPurpose) {
                        types.push([sampleType, { sales: matchPurpose.sales, count: matchPurpose.count }]);
                    }
                });
            } else {
                // 전체 데이터
                types = [...(currentData.by_sample_type || [])];
            }

            // 정렬 적용
            if (sortType === 'sales') {
                types.sort((a, b) => b[1].sales - a[1].sales);
            } else if (sortType === 'count') {
                types.sort((a, b) => b[1].count - a[1].count);
            } else if (sortType === 'avgSales') {
                types.sort((a, b) => {
                    const avgA = a[1].count > 0 ? a[1].sales / a[1].count : 0;
                    const avgB = b[1].count > 0 ? b[1].sales / b[1].count : 0;
                    return avgB - avgA;
                });
            }

            // 그리드 업데이트
            const colors = ['blue', 'green', 'orange', 'purple', 'pink', 'info', 'teal', 'amber'];
            const icons = ['📦', '🌿', '🥩', '🐟', '💊', '🥤', '🧀', '📁'];
            const grid = document.getElementById('sampleTypeGrid');
            const total = types.reduce((s, t) => s + t[1].sales, 0) || 1;
            document.getElementById('sampleTypeCount').textContent = types.length + '개 유형';

            grid.innerHTML = types.map((t, i) => {
                const avgSales = t[1].count > 0 ? Math.round(t[1].sales / t[1].count) : 0;
                const percent = (t[1].sales / total * 100).toFixed(1);
                return `
                <div class="purpose-kpi-card" data-color="${colors[i % colors.length]}">
                    <div class="purpose-kpi-header"><div class="purpose-kpi-icon">${icons[i % icons.length]}</div></div>
                    <div class="purpose-kpi-name">${t[0]}</div>
                    <div class="purpose-kpi-value">${formatCurrency(t[1].sales)}</div>
                    <div class="purpose-kpi-sub">건수: ${t[1].count.toLocaleString()}건 · 💰 ${formatCurrency(avgSales)}/건</div>
                    <div class="purpose-kpi-sub" style="margin-top: 4px;"><span style="background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">비중 ${percent}%</span></div>
                </div>
            `}).join('');
        }

        // 검사목적별 필터링
        function filterSampleTypeByPurpose() {
            const filter = document.getElementById('stPurposeFilter').value;
            stPurposeFilter = filter;

            if (filter === '전체') {
                // 전체 데이터로 복원
                sortSampleTypeCards(stSortType);
                return;
            }

            // sample_type_purposes에서 해당 목적이 있는 검체유형만 필터링
            const stPurposes = currentData.sample_type_purposes || {};
            let filteredTypes = [];

            Object.entries(stPurposes).forEach(([sampleType, purposes]) => {
                const matchPurpose = purposes.find(p => p.name === filter);
                if (matchPurpose) {
                    filteredTypes.push([sampleType, { sales: matchPurpose.sales, count: matchPurpose.count }]);
                }
            });

            // 정렬 적용
            if (stSortType === 'sales') {
                filteredTypes.sort((a, b) => b[1].sales - a[1].sales);
            } else if (stSortType === 'count') {
                filteredTypes.sort((a, b) => b[1].count - a[1].count);
            } else if (stSortType === 'avgSales') {
                filteredTypes.sort((a, b) => {
                    const avgA = a[1].count > 0 ? a[1].sales / a[1].count : 0;
                    const avgB = b[1].count > 0 ? b[1].sales / b[1].count : 0;
                    return avgB - avgA;
                });
            }

            // 그리드 업데이트
            const colors = ['blue', 'green', 'orange', 'purple', 'pink', 'info', 'teal', 'amber'];
            const icons = ['📦', '🌿', '🥩', '🐟', '💊', '🥤', '🧀', '📁'];
            const grid = document.getElementById('sampleTypeGrid');
            const total = filteredTypes.reduce((s, t) => s + t[1].sales, 0) || 1;
            document.getElementById('sampleTypeCount').textContent = filteredTypes.length + '개 유형';

            grid.innerHTML = filteredTypes.map((t, i) => {
                const avgSales = t[1].count > 0 ? Math.round(t[1].sales / t[1].count) : 0;
                const percent = (t[1].sales / total * 100).toFixed(1);
                return `
                <div class="purpose-kpi-card" data-color="${colors[i % colors.length]}">
                    <div class="purpose-kpi-header"><div class="purpose-kpi-icon">${icons[i % icons.length]}</div></div>
                    <div class="purpose-kpi-name">${t[0]}</div>
                    <div class="purpose-kpi-value">${formatCurrency(t[1].sales)}</div>
                    <div class="purpose-kpi-sub">건수: ${t[1].count.toLocaleString()}건 · 💰 ${formatCurrency(avgSales)}/건</div>
                    <div class="purpose-kpi-sub" style="margin-top: 4px;"><span style="background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">비중 ${percent}%</span></div>
                </div>
            `}).join('');
        }

        // 담당자별 검체유형 보유 수 차트
        let stManagerChartData = [];

        function updateSTManagerTypeChart() {
            const ctx = document.getElementById('stManagerTypeChart');
            if (!ctx) return;
            if (charts.stManagerType) charts.stManagerType.destroy();

            // 검사목적 드롭다운 채우기
            const purposeSelect = document.getElementById('stManagerPurposeFilter');
            const purposes = currentData.purposes || [];
            const currentPurposeFilter = purposeSelect?.value || '전체';
            if (purposeSelect && purposeSelect.options.length <= 1) {
                purposeSelect.innerHTML = '<option value="전체">전체 검사목적</option>' +
                    purposes.map(p => `<option value="${p}">${p}</option>`).join('');
            }

            // 담당자별 검체유형 수 계산
            const managerSampleTypes = {};
            const stManagers = currentData.sample_type_managers || {};

            // sample_type_managers: { sample_type: [{ name, sales, count, by_purpose }, ...] }
            Object.entries(stManagers).forEach(([sampleType, managers]) => {
                managers.forEach(m => {
                    if (!m.name || m.name === '미지정') return;

                    // 검사목적 필터 적용
                    let sales = m.sales, count = m.count;
                    if (currentPurposeFilter !== '전체') {
                        const purposeData = m.by_purpose?.[currentPurposeFilter];
                        if (!purposeData) return;
                        sales = purposeData.sales || 0;
                        count = purposeData.count || 0;
                    }

                    if (!managerSampleTypes[m.name]) {
                        managerSampleTypes[m.name] = { count: 0, sales: 0, types: [] };
                    }
                    managerSampleTypes[m.name].count += 1;
                    managerSampleTypes[m.name].sales += sales;
                    managerSampleTypes[m.name].types.push({ name: sampleType, sales: sales, count: count });
                });
            });

            // 유형 수 기준 정렬
            const sorted = Object.entries(managerSampleTypes)
                .map(([name, data]) => [name, { ...data, types: data.types.sort((a, b) => b.sales - a.sales) }])
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 15);

            stManagerChartData = sorted;

            // 요약 정보
            const summaryEl = document.getElementById('stManagerTypeSummary');
            if (summaryEl && sorted.length > 0) {
                const avgTypes = sorted.reduce((s, [_, d]) => s + d.count, 0) / sorted.length;
                const maxTypes = sorted[0][1].count;
                const maxManager = sorted[0][0];
                let html = `<span style="white-space:nowrap;background:#dbeafe;padding:4px 10px;border-radius:4px;color:#1e40af;">TOP: <strong>${maxManager}</strong> (${maxTypes}개)</span>`;
                html += `<span style="white-space:nowrap;background:#e0e7ff;padding:4px 10px;border-radius:4px;color:#3730a3;">평균: <strong>${avgTypes.toFixed(1)}개</strong></span>`;
                html += `<span style="white-space:nowrap;background:#fce7f3;padding:4px 10px;border-radius:4px;color:#9d174d;">담당자: <strong>${sorted.length}명</strong></span>`;
                summaryEl.innerHTML = html;
            }

            document.getElementById('stManagerTypeBadge').textContent = `TOP ${sorted.length}`;

            // 부드러운 색상
            const softColors = [
                'rgba(99, 102, 241, 0.7)',   // indigo
                'rgba(59, 130, 246, 0.7)',   // blue
                'rgba(14, 165, 233, 0.7)',   // sky
                'rgba(20, 184, 166, 0.7)',   // teal
                'rgba(34, 197, 94, 0.7)',    // green
                'rgba(132, 204, 22, 0.7)',   // lime
                'rgba(234, 179, 8, 0.7)',    // yellow
                'rgba(249, 115, 22, 0.7)',   // orange
                'rgba(239, 68, 68, 0.7)',    // red
                'rgba(236, 72, 153, 0.7)',   // pink
                'rgba(168, 85, 247, 0.7)',   // purple
                'rgba(139, 92, 246, 0.7)',   // violet
                'rgba(107, 114, 128, 0.7)',  // gray
                'rgba(75, 85, 99, 0.7)',     // dark gray
                'rgba(156, 163, 175, 0.7)'   // light gray
            ];

            // 외부 툴팁 생성
            const getOrCreateTooltip = () => {
                let tooltipEl = document.getElementById('stManagerTypeTooltip');
                if (!tooltipEl) {
                    tooltipEl = document.createElement('div');
                    tooltipEl.id = 'stManagerTypeTooltip';
                    tooltipEl.style.cssText = `
                        position: fixed;
                        background: rgba(30, 41, 59, 0.98);
                        border-radius: 12px;
                        padding: 16px;
                        pointer-events: none;
                        z-index: 99999;
                        font-size: 13px;
                        color: #e2e8f0;
                        box-shadow: 0 20px 40px rgba(0,0,0,0.4);
                        min-width: 280px;
                        max-width: 350px;
                        transition: opacity 0.15s ease;
                        line-height: 1.6;
                    `;
                    document.body.appendChild(tooltipEl);
                }
                return tooltipEl;
            };

            // 외부 툴팁 핸들러
            const externalTooltipHandler = (context) => {
                const { chart, tooltip } = context;
                const tooltipEl = getOrCreateTooltip();

                if (tooltip.opacity === 0) {
                    tooltipEl.style.opacity = '0';
                    return;
                }

                const idx = tooltip.dataPoints[0].dataIndex;
                const [name, data] = stManagerChartData[idx];
                const top5Types = data.types.slice(0, 5);

                let html = `
                    <div style="border-bottom: 1px solid #475569; padding-bottom: 10px; margin-bottom: 10px;">
                        <div style="font-size: 16px; font-weight: 700; color: #f8fafc;">👤 ${name}</div>
                        <div style="font-size: 13px; color: #94a3b8; margin-top: 4px;">보유 유형: <span style="color: #60a5fa; font-weight: 600;">${data.count}개</span> · 매출: <span style="color: #34d399;">${formatCurrency(data.sales)}</span></div>
                    </div>
                    <div style="font-size: 12px; color: #94a3b8; margin-bottom: 8px;">📦 주요 유형 TOP 5</div>
                `;

                top5Types.forEach((t, i) => {
                    const barWidth = data.types[0]?.sales > 0 ? (t.sales / data.types[0].sales * 100) : 0;
                    html += `
                        <div style="display: flex; align-items: center; margin-bottom: 6px;">
                            <span style="width: 20px; color: #64748b; font-size: 11px;">${i + 1}</span>
                            <span style="flex: 1; font-size: 12px; color: #e2e8f0;">${t.name.length > 15 ? t.name.substring(0, 15) + '..' : t.name}</span>
                            <span style="font-size: 12px; color: #60a5fa; font-weight: 600;">${formatCurrency(t.sales)}</span>
                        </div>
                        <div style="height: 4px; background: #334155; border-radius: 2px; margin-bottom: 8px; margin-left: 20px;">
                            <div style="height: 100%; width: ${barWidth}%; background: linear-gradient(90deg, #6366f1, #8b5cf6); border-radius: 2px;"></div>
                        </div>
                    `;
                });

                tooltipEl.innerHTML = html;
                tooltipEl.style.opacity = '1';

                const position = chart.canvas.getBoundingClientRect();
                let left = position.left + tooltip.caretX + 15;
                let top = position.top + tooltip.caretY - 10;

                if (left + 350 > window.innerWidth) {
                    left = position.left + tooltip.caretX - 365;
                }
                if (top + tooltipEl.offsetHeight > window.innerHeight - 20) {
                    top = window.innerHeight - tooltipEl.offsetHeight - 20;
                }

                tooltipEl.style.left = left + 'px';
                tooltipEl.style.top = Math.max(10, top) + 'px';
            };

            charts.stManagerType = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: sorted.map(([name]) => name.length > 4 ? name.substring(0, 4) + '..' : name),
                    datasets: [{
                        label: '유형 수',
                        data: sorted.map(([_, d]) => d.count),
                        backgroundColor: softColors.slice(0, sorted.length),
                        borderColor: softColors.slice(0, sorted.length).map(c => c.replace('0.7)', '1)')),
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: false,
                            external: externalTooltipHandler
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1, callback: v => v + '개' } },
                        x: { ticks: { font: { size: 11 } } }
                    }
                }
            });
        }

        // 지속적인 거래 검체유형 테이블
        function updateSTContinuousTradeTable() {
            const tbody = document.querySelector('#stContinuousTradeTable tbody');
            if (!tbody) return;

            const data = currentData.client_sample_type_months || [];
            const summaryEl = document.getElementById('stContinuousTradeSummary');
            document.getElementById('stContinuousTradeBadge').textContent = `${data.length}건`;

            // 요약 정보
            if (summaryEl && data.length > 0) {
                const avg = data.reduce((s, d) => s + d.monthCount, 0) / data.length;
                const over6 = data.filter(d => d.monthCount >= 6).length;
                const over12 = data.filter(d => d.monthCount >= 12).length;
                let html = `<span style="white-space:nowrap;background:#d1fae5;padding:4px 10px;border-radius:4px;color:#059669;">12개월+: <strong>${over12}건</strong></span>`;
                html += `<span style="white-space:nowrap;background:#dbeafe;padding:4px 10px;border-radius:4px;color:#1e40af;">6개월+: <strong>${over6}건</strong></span>`;
                html += `<span style="white-space:nowrap;background:#fef08a;padding:4px 10px;border-radius:4px;color:#854d0e;">평균: <strong>${avg.toFixed(1)}개월</strong></span>`;
                summaryEl.innerHTML = html;
            }

            // 월별 표시를 작은 점으로 변환
            const renderMonthDots = (months) => {
                let dots = '';
                for (let i = 1; i <= 12; i++) {
                    const hasMonth = months.includes(i);
                    const color = hasMonth ? '#3b82f6' : '#e2e8f0';
                    dots += `<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${color};margin:0 1px;" title="${i}월"></span>`;
                }
                return dots;
            };

            tbody.innerHTML = data.slice(0, 50).map((d, idx) => {
                const monthCountColor = d.monthCount >= 12 ? '#059669' : d.monthCount >= 6 ? '#3b82f6' : '#f59e0b';
                const bgColor = idx % 2 === 0 ? '#fff' : '#f8fafc';
                return `<tr style="background:${bgColor};">
                    <td style="font-weight:600;padding:8px 10px;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${d.client}">${d.client}</td>
                    <td style="padding:8px 6px;"><span style="background:#f1f5f9;padding:2px 6px;border-radius:4px;font-size:10px;white-space:nowrap;">${d.sample_type.length > 10 ? d.sample_type.substring(0, 10) + '..' : d.sample_type}</span></td>
                    <td class="text-right" style="padding:8px 6px;"><span style="color:${monthCountColor};font-weight:700;font-size:12px;">${d.monthCount}개월</span></td>
                    <td class="text-right" style="padding:8px 6px;font-size:12px;">${formatCurrency(d.sales)}</td>
                    <td class="text-right" style="padding:8px 6px;font-size:11px;color:#64748b;">${d.count.toLocaleString()}건</td>
                    <td style="padding:8px 6px;white-space:nowrap;">${renderMonthDots(d.months)}</td>
                </tr>`;
            }).join('');
        }

        function updateDefectTab() {
            // 드롭다운 초기화
            const purposeFilter = document.getElementById('defectPurposeFilter');
            const purposeDetailFilter = document.getElementById('defectPurposeDetailFilter');
            const purposes = currentData.purposes || [];

            // 드롭다운 옵션 설정
            if (purposeFilter.options.length <= 1) {
                purposes.forEach(p => {
                    if (p && p !== '접수취소') {
                        purposeFilter.add(new Option(p, p));
                        purposeDetailFilter.add(new Option(p, p));
                    }
                });
            }

            updateDefectCharts();

            // 첫 번째 검사목적으로 상세 분석 초기화
            if (purposeDetailFilter.options.length > 1 && !purposeDetailFilter.value) {
                purposeDetailFilter.selectedIndex = 1;
                updateDefectByPurposeDetail();
            }
        }

        function updateDefectCharts() {
            const purposeFilter = document.getElementById('defectPurposeFilter').value;
            const isFiltered = purposeFilter && purposeFilter !== '전체';

            // 필터된 데이터 가져오기
            let defects, defectManagers, defectClients, defectSeason, defectMonthly;

            if (isFiltered) {
                // 검사목적별 필터된 부적합 데이터
                const byPurpose = currentData.by_defect_purpose || {};
                const purposeDefects = byPurpose[purposeFilter] || [];
                defects = purposeDefects.map(([name, data]) => [name, data]);

                // 담당자별 (필터된)
                const allManagers = currentData.by_defect_manager || [];
                defectManagers = allManagers.map(([name, data]) => {
                    const purposeCount = data.by_purpose?.[purposeFilter] || 0;
                    return [name, { count: purposeCount, defects: data.defects }];
                }).filter(([_, data]) => data.count > 0).sort((a, b) => b[1].count - a[1].count);

                // 업체별 (필터된)
                const allClients = currentData.by_defect_client || [];
                defectClients = allClients.map(([name, data]) => {
                    const purposeCount = data.by_purpose?.[purposeFilter] || 0;
                    return [name, { count: purposeCount, defects: data.defects }];
                }).filter(([_, data]) => data.count > 0).sort((a, b) => b[1].count - a[1].count);

                // 계절별 (필터된)
                const allSeasons = currentData.by_defect_season || {};
                defectSeason = {};
                Object.entries(allSeasons).forEach(([season, data]) => {
                    const purposeCount = data.by_purpose?.[purposeFilter] || 0;
                    if (purposeCount > 0) {
                        defectSeason[season] = { count: purposeCount, months: data.months, defects: data.defects };
                    }
                });

                // 월별 (필터된)
                const allMonthly = currentData.defect_monthly_total || {};
                defectMonthly = {};
                Object.entries(allMonthly).forEach(([month, data]) => {
                    const purposeCount = data.by_purpose?.[purposeFilter] || 0;
                    defectMonthly[month] = { count: purposeCount };
                });
            } else {
                defects = currentData.by_defect || [];
                defectManagers = currentData.by_defect_manager || [];
                defectClients = currentData.by_defect_client || [];
                defectSeason = currentData.by_defect_season || {};
                defectMonthly = currentData.defect_monthly_total || {};
            }

            const total = defects.reduce((s, d) => s + (d[1].count || 0), 0) || 1;

            // KPI 업데이트
            document.getElementById('defectTotalCount').textContent = total.toLocaleString() + '건';

            // 최다 발생월
            const monthlyEntries = Object.entries(defectMonthly).sort((a, b) => b[1].count - a[1].count);
            const peakMonth = monthlyEntries.length > 0 ? monthlyEntries[0][0] + '월' : '-';
            document.getElementById('defectPeakMonth').textContent = peakMonth;

            // 최다 계절
            const seasonEntries = Object.entries(defectSeason).sort((a, b) => b[1].count - a[1].count);
            const peakSeason = seasonEntries.length > 0 ? seasonEntries[0][0] : '-';
            document.getElementById('defectPeakSeason').textContent = peakSeason;

            // 1위 항목
            const topItem = defects.length > 0 ? defects[0][0] : '-';
            document.getElementById('defectTopItem').textContent = topItem;
            document.getElementById('defectTopItem').title = topItem;

            // 1. 월별 추이 차트
            updateDefectMonthlyChart(defectMonthly);

            // 2. 계절별 차트
            updateDefectSeasonChart(defectSeason);

            // 3. 항목별 차트
            updateDefectItemChart(defects);

            // 4. 항목별 테이블
            updateDefectItemTable(defects, total);

            // 5. 담당자별 차트
            updateDefectManagerChart(defectManagers);

            // 6. 업체별 테이블
            updateDefectClientTable(defectClients);
        }

        function updateDefectMonthlyChart(monthlyData) {
            const months = [];
            const counts = [];
            const monthDataArr = [];
            for (let i = 1; i <= 12; i++) {
                months.push(i + '월');
                const count = monthlyData[i]?.count || 0;
                counts.push(count);
                monthDataArr.push({ month: i, count, byPurpose: monthlyData[i]?.by_purpose || {} });
            }
            const total = counts.reduce((s, c) => s + c, 0);
            const maxCount = Math.max(...counts);
            const avgCount = total / 12;
            document.getElementById('defectMonthlyBadge').textContent = '총 ' + total.toLocaleString() + '건';

            // 오버레이 툴팁
            const getOrCreateTooltip = () => {
                let el = document.getElementById('defectMonthlyTooltip');
                if (!el) {
                    el = document.createElement('div');
                    el.id = 'defectMonthlyTooltip';
                    el.style.cssText = 'position:fixed;pointer-events:none;background:linear-gradient(135deg,#1e293b 0%,#334155 100%);color:#f8fafc;padding:16px;border-radius:12px;font-size:12px;z-index:9999;min-width:220px;box-shadow:0 20px 40px rgba(0,0,0,0.4);transition:opacity 0.15s;';
                    document.body.appendChild(el);
                }
                return el;
            };

            const externalTooltipHandler = (context) => {
                const { chart, tooltip } = context;
                const tooltipEl = getOrCreateTooltip();
                if (tooltip.opacity === 0) { tooltipEl.style.opacity = 0; return; }

                const idx = tooltip.dataPoints?.[0]?.dataIndex;
                if (idx === undefined) return;

                const data = monthDataArr[idx];
                const count = data.count;
                const percent = total > 0 ? (count / total * 100).toFixed(1) : 0;
                const vsAvg = avgCount > 0 ? ((count - avgCount) / avgCount * 100).toFixed(1) : 0;
                const rank = [...counts].sort((a, b) => b - a).indexOf(count) + 1;

                // 검사목적별 TOP 3
                const purposeTop = Object.entries(data.byPurpose).sort((a, b) => b[1] - a[1]).slice(0, 3);
                const maxPurpose = purposeTop.length > 0 ? purposeTop[0][1] : 1;

                let html = `
                    <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #475569;padding-bottom:10px;margin-bottom:10px;">
                        <div style="font-size:18px;font-weight:700;">📅 ${data.month}월</div>
                        <div style="background:${rank <= 3 ? '#ef4444' : '#64748b'};padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;">${rank}위</div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;">
                        <div style="background:#334155;padding:8px;border-radius:8px;text-align:center;">
                            <div style="font-size:10px;color:#94a3b8;">부적합 건수</div>
                            <div style="font-size:16px;font-weight:700;color:#f87171;">${count.toLocaleString()}건</div>
                        </div>
                        <div style="background:#334155;padding:8px;border-radius:8px;text-align:center;">
                            <div style="font-size:10px;color:#94a3b8;">전체 비중</div>
                            <div style="font-size:16px;font-weight:700;color:#fbbf24;">${percent}%</div>
                        </div>
                    </div>
                    <div style="margin-bottom:8px;padding:6px 10px;background:${parseFloat(vsAvg) >= 0 ? 'rgba(239,68,68,0.2)' : 'rgba(34,197,94,0.2)'};border-radius:6px;">
                        <span style="color:#94a3b8;">평균 대비:</span>
                        <span style="color:${parseFloat(vsAvg) >= 0 ? '#f87171' : '#4ade80'};font-weight:600;">${parseFloat(vsAvg) >= 0 ? '+' : ''}${vsAvg}%</span>
                    </div>
                `;

                if (purposeTop.length > 0) {
                    html += `<div style="font-size:11px;color:#94a3b8;margin:10px 0 6px 0;">── 검사목적별 부적합 ──</div>`;
                    purposeTop.forEach(([name, cnt]) => {
                        const pct = (cnt / maxPurpose * 100).toFixed(0);
                        html += `
                            <div style="margin:4px 0;">
                                <div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:2px;">
                                    <span>${name}</span><span style="color:#fbbf24;font-weight:600;">${cnt}건</span>
                                </div>
                                <div style="background:#475569;border-radius:4px;height:4px;overflow:hidden;">
                                    <div style="width:${pct}%;height:100%;background:linear-gradient(90deg,#f87171,#fbbf24);"></div>
                                </div>
                            </div>
                        `;
                    });
                }

                tooltipEl.innerHTML = html;
                tooltipEl.style.opacity = 1;
                const pos = chart.canvas.getBoundingClientRect();
                tooltipEl.style.left = Math.min(pos.left + tooltip.caretX + 15, window.innerWidth - 250) + 'px';
                tooltipEl.style.top = pos.top + tooltip.caretY - 20 + 'px';
            };

            const ctx = document.getElementById('defectMonthlyChart').getContext('2d');
            if (charts.defectMonthly) charts.defectMonthly.destroy();
            charts.defectMonthly = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: '부적합 건수',
                        data: counts,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointBackgroundColor: '#ef4444',
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false, external: externalTooltipHandler } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function updateDefectSeasonChart(seasonData) {
            const seasonOrder = ['봄', '여름', '가을', '겨울'];
            const seasonColors = {
                '봄': '#f472b6', '여름': '#34d399', '가을': '#fbbf24', '겨울': '#60a5fa'
            };
            const seasonIcons = { '봄': '🌸', '여름': '☀️', '가을': '🍂', '겨울': '❄️' };
            const seasonMonths = { '봄': '3~5월', '여름': '6~8월', '가을': '9~11월', '겨울': '12~2월' };
            const labels = [];
            const dataArr = [];
            const colors = [];

            seasonOrder.forEach(s => {
                if (seasonData[s]) {
                    labels.push(s);
                    dataArr.push({ name: s, count: seasonData[s].count, defects: seasonData[s].defects || [], byPurpose: seasonData[s].by_purpose || {} });
                    colors.push(seasonColors[s]);
                }
            });

            const total = dataArr.reduce((s, d) => s + d.count, 0);
            document.getElementById('defectSeasonBadge').textContent = '총 ' + total.toLocaleString() + '건';

            // 오버레이 툴팁
            const getOrCreateTooltip = () => {
                let el = document.getElementById('defectSeasonTooltip');
                if (!el) {
                    el = document.createElement('div');
                    el.id = 'defectSeasonTooltip';
                    el.style.cssText = 'position:fixed;pointer-events:none;background:linear-gradient(135deg,#1e293b 0%,#334155 100%);color:#f8fafc;padding:16px;border-radius:12px;font-size:12px;z-index:9999;min-width:240px;box-shadow:0 20px 40px rgba(0,0,0,0.4);transition:opacity 0.15s;';
                    document.body.appendChild(el);
                }
                return el;
            };

            const externalTooltipHandler = (context) => {
                const { chart, tooltip } = context;
                const tooltipEl = getOrCreateTooltip();
                if (tooltip.opacity === 0) { tooltipEl.style.opacity = 0; return; }

                const idx = tooltip.dataPoints?.[0]?.dataIndex;
                if (idx === undefined) return;

                const d = dataArr[idx];
                const percent = total > 0 ? (d.count / total * 100).toFixed(1) : 0;
                const rank = [...dataArr].sort((a, b) => b.count - a.count).findIndex(x => x.name === d.name) + 1;
                const topDefects = d.defects.slice(0, 5);
                const maxDefect = topDefects.length > 0 ? topDefects[0][1] : 1;

                let html = `
                    <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #475569;padding-bottom:10px;margin-bottom:10px;">
                        <div style="font-size:20px;font-weight:700;">${seasonIcons[d.name]} ${d.name}</div>
                        <div style="background:${seasonColors[d.name]};padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;">${rank}위</div>
                    </div>
                    <div style="color:#94a3b8;font-size:11px;margin-bottom:10px;">${seasonMonths[d.name]}</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;">
                        <div style="background:#334155;padding:10px;border-radius:8px;text-align:center;">
                            <div style="font-size:10px;color:#94a3b8;">부적합 건수</div>
                            <div style="font-size:18px;font-weight:700;color:${seasonColors[d.name]};">${d.count.toLocaleString()}건</div>
                        </div>
                        <div style="background:#334155;padding:10px;border-radius:8px;text-align:center;">
                            <div style="font-size:10px;color:#94a3b8;">전체 비중</div>
                            <div style="font-size:18px;font-weight:700;color:#f8fafc;">${percent}%</div>
                        </div>
                    </div>
                `;

                if (topDefects.length > 0) {
                    html += `<div style="font-size:11px;color:#94a3b8;margin:10px 0 6px 0;">── 주요 부적합 항목 TOP 5 ──</div>`;
                    topDefects.forEach(([name, cnt], i) => {
                        const pct = (cnt / maxDefect * 100).toFixed(0);
                        html += `
                            <div style="margin:4px 0;">
                                <div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:2px;">
                                    <span>${i+1}. ${name.length > 15 ? name.substring(0,15)+'..' : name}</span>
                                    <span style="color:${seasonColors[d.name]};font-weight:600;">${cnt}건</span>
                                </div>
                                <div style="background:#475569;border-radius:4px;height:4px;overflow:hidden;">
                                    <div style="width:${pct}%;height:100%;background:${seasonColors[d.name]};"></div>
                                </div>
                            </div>
                        `;
                    });
                }

                tooltipEl.innerHTML = html;
                tooltipEl.style.opacity = 1;
                const pos = chart.canvas.getBoundingClientRect();
                tooltipEl.style.left = Math.min(pos.left + tooltip.caretX + 15, window.innerWidth - 270) + 'px';
                tooltipEl.style.top = pos.top + tooltip.caretY - 20 + 'px';
            };

            const ctx = document.getElementById('defectSeasonChart').getContext('2d');
            if (charts.defectSeason) charts.defectSeason.destroy();
            charts.defectSeason = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: dataArr.map(d => d.count),
                        backgroundColor: colors,
                        borderWidth: 3,
                        borderColor: '#fff',
                        hoverBorderWidth: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: { enabled: false, external: externalTooltipHandler }
                    }
                }
            });
        }

        function updateDefectItemChart(defects) {
            const top10 = defects.slice(0, 10);
            const total = defects.reduce((s, d) => s + d[1].count, 0);
            const byDefectMonth = currentData.by_defect_month || {};

            // 오버레이 툴팁
            const getOrCreateTooltip = () => {
                let el = document.getElementById('defectItemTooltip');
                if (!el) {
                    el = document.createElement('div');
                    el.id = 'defectItemTooltip';
                    el.style.cssText = 'position:fixed;pointer-events:none;background:linear-gradient(135deg,#1e293b 0%,#334155 100%);color:#f8fafc;padding:16px;border-radius:12px;font-size:12px;z-index:9999;min-width:260px;box-shadow:0 20px 40px rgba(0,0,0,0.4);transition:opacity 0.15s;';
                    document.body.appendChild(el);
                }
                return el;
            };

            const externalTooltipHandler = (context) => {
                const { chart, tooltip } = context;
                const tooltipEl = getOrCreateTooltip();
                if (tooltip.opacity === 0) { tooltipEl.style.opacity = 0; return; }

                const idx = tooltip.dataPoints?.[0]?.dataIndex;
                if (idx === undefined) return;

                const [name, data] = top10[idx];
                const count = data.count;
                const percent = total > 0 ? (count / total * 100).toFixed(1) : 0;
                const rank = idx + 1;

                // 월별 데이터
                const monthData = byDefectMonth[name] || [];
                const monthCounts = [];
                for (let i = 1; i <= 12; i++) {
                    const found = monthData.find(m => m[0] === i);
                    monthCounts.push(found ? found[1] : 0);
                }
                const maxMonth = Math.max(...monthCounts) || 1;
                const peakMonthIdx = monthCounts.indexOf(Math.max(...monthCounts));

                let html = `
                    <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #475569;padding-bottom:10px;margin-bottom:10px;">
                        <div style="font-size:16px;font-weight:700;max-width:180px;overflow:hidden;text-overflow:ellipsis;">🔬 ${name}</div>
                        <div style="background:${rank <= 3 ? '#ef4444' : '#64748b'};padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;">${rank}위</div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;">
                        <div style="background:#334155;padding:10px;border-radius:8px;text-align:center;">
                            <div style="font-size:10px;color:#94a3b8;">발생 건수</div>
                            <div style="font-size:18px;font-weight:700;color:#f87171;">${count.toLocaleString()}건</div>
                        </div>
                        <div style="background:#334155;padding:10px;border-radius:8px;text-align:center;">
                            <div style="font-size:10px;color:#94a3b8;">전체 비중</div>
                            <div style="font-size:18px;font-weight:700;color:#fbbf24;">${percent}%</div>
                        </div>
                    </div>
                    <div style="background:#334155;padding:8px 10px;border-radius:8px;margin-bottom:12px;">
                        <span style="color:#94a3b8;">📅 최다 발생월:</span>
                        <span style="color:#60a5fa;font-weight:700;margin-left:6px;">${peakMonthIdx + 1}월 (${monthCounts[peakMonthIdx]}건)</span>
                    </div>
                    <div style="font-size:11px;color:#94a3b8;margin-bottom:6px;">── 월별 발생 추이 ──</div>
                    <div style="display:flex;align-items:end;gap:2px;height:40px;">
                `;

                monthCounts.forEach((cnt, i) => {
                    const h = maxMonth > 0 ? (cnt / maxMonth * 100) : 0;
                    const color = cnt === Math.max(...monthCounts) && cnt > 0 ? '#ef4444' : '#64748b';
                    html += `<div style="flex:1;background:${color};height:${Math.max(h, 5)}%;border-radius:2px 2px 0 0;" title="${i+1}월: ${cnt}건"></div>`;
                });

                html += `
                    </div>
                    <div style="display:flex;justify-content:space-between;font-size:9px;color:#64748b;margin-top:2px;">
                        <span>1월</span><span>6월</span><span>12월</span>
                    </div>
                `;

                tooltipEl.innerHTML = html;
                tooltipEl.style.opacity = 1;
                const pos = chart.canvas.getBoundingClientRect();
                tooltipEl.style.left = Math.min(pos.left + tooltip.caretX + 15, window.innerWidth - 290) + 'px';
                tooltipEl.style.top = pos.top + tooltip.caretY - 20 + 'px';
            };

            const ctx = document.getElementById('defectChart').getContext('2d');
            if (charts.defect) charts.defect.destroy();
            charts.defect = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top10.map(d => d[0].length > 8 ? d[0].substring(0, 8) + '..' : d[0]),
                    datasets: [{
                        data: top10.map(d => d[1].count),
                        backgroundColor: top10.map((_, i) => i < 3 ? 'rgba(239, 68, 68, 0.9)' : 'rgba(239, 68, 68, 0.6)'),
                        borderRadius: 6,
                        hoverBackgroundColor: '#ef4444'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false, external: externalTooltipHandler } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                        x: { grid: { display: false }, ticks: { maxRotation: 45, minRotation: 45 } }
                    }
                }
            });
        }

        function updateDefectItemTable(defects, total) {
            const tbody = document.querySelector('#defectTable tbody');
            tbody.innerHTML = defects.map(d => {
                const percent = (d[1].count / total * 100).toFixed(1);
                return `<tr>
                    <td><strong>${d[0]}</strong></td>
                    <td class="text-right">${d[1].count.toLocaleString()}</td>
                    <td><div class="progress-cell"><div class="progress-bar" style="background: var(--danger-light);"><div class="progress-fill" style="width: ${percent}%; background: var(--danger);"></div></div><span class="progress-value">${percent}%</span></div></td>
                </tr>`;
            }).join('');
        }

        function updateDefectManagerChart(managers) {
            const top15 = managers.slice(0, 15);
            document.getElementById('defectManagerBadge').textContent = managers.length + '명';

            const ctx = document.getElementById('defectManagerChart').getContext('2d');
            if (charts.defectManager) charts.defectManager.destroy();

            // 담당자별 부적합 차트 - 오버레이 툴팁
            const getOrCreateTooltip = () => {
                let tooltipEl = document.getElementById('defectManagerTooltip');
                if (!tooltipEl) {
                    tooltipEl = document.createElement('div');
                    tooltipEl.id = 'defectManagerTooltip';
                    tooltipEl.style.cssText = 'position:fixed;pointer-events:none;background:#1e293b;color:#f8fafc;padding:12px;border-radius:8px;font-size:12px;z-index:9999;max-width:280px;box-shadow:0 10px 25px rgba(0,0,0,0.3);transition:opacity 0.15s;';
                    document.body.appendChild(tooltipEl);
                }
                return tooltipEl;
            };

            const externalTooltipHandler = (context) => {
                const { chart, tooltip } = context;
                const tooltipEl = getOrCreateTooltip();

                if (tooltip.opacity === 0) {
                    tooltipEl.style.opacity = 0;
                    return;
                }

                const dataIndex = tooltip.dataPoints?.[0]?.dataIndex;
                if (dataIndex === undefined) return;

                const [name, data] = top15[dataIndex];
                const topDefects = data.defects?.slice(0, 5) || [];
                const maxDefect = topDefects.length > 0 ? topDefects[0][1] : 1;

                let html = `
                    <div style="border-bottom: 1px solid #475569; padding-bottom: 8px; margin-bottom: 8px;">
                        <div style="font-size: 14px; font-weight: 700;">👤 ${name}</div>
                        <div style="color: #94a3b8;">부적합 건수: ${data.count.toLocaleString()}건</div>
                    </div>
                    <div style="font-size: 11px; color: #cbd5e1; margin-bottom: 6px;">📋 주요 부적합 항목</div>
                `;

                topDefects.forEach(([defect, count]) => {
                    const pct = (count / maxDefect * 100).toFixed(0);
                    html += `
                        <div style="margin: 4px 0;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                                <span style="max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${defect}</span>
                                <span style="color: #f87171; font-weight: 600;">${count}건</span>
                            </div>
                            <div style="background: #334155; border-radius: 4px; height: 4px; overflow: hidden;">
                                <div style="width: ${pct}%; height: 100%; background: #f87171;"></div>
                            </div>
                        </div>
                    `;
                });

                tooltipEl.innerHTML = html;
                tooltipEl.style.opacity = 1;

                const pos = chart.canvas.getBoundingClientRect();
                tooltipEl.style.left = pos.left + tooltip.caretX + 15 + 'px';
                tooltipEl.style.top = pos.top + tooltip.caretY + 'px';
            };

            charts.defectManager = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top15.map(d => d[0]),
                    datasets: [{
                        data: top15.map(d => d[1].count),
                        backgroundColor: top15.map((_, i) => `hsla(${i * 24}, 70%, 60%, 0.8)`),
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false, external: externalTooltipHandler }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                        x: { grid: { display: false }, ticks: { maxRotation: 45 } }
                    }
                }
            });
        }

        function updateDefectClientTable(clients) {
            const top20 = clients.slice(0, 20);
            document.getElementById('defectClientBadge').textContent = 'TOP ' + top20.length;

            const tbody = document.querySelector('#defectClientTable tbody');
            tbody.innerHTML = top20.map(([name, data], idx) => {
                const topDefect = data.defects?.slice(0, 2).map(([d, _]) => d.length > 8 ? d.substring(0, 8) + '..' : d).join(', ') || '-';
                const bgColor = idx % 2 === 0 ? '#fff' : '#f8fafc';
                return `<tr style="background: ${bgColor};">
                    <td style="text-align: center; font-weight: 700; color: ${idx < 3 ? '#ef4444' : '#64748b'};">${idx + 1}</td>
                    <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${name}">${name}</td>
                    <td class="text-right" style="font-weight: 600; color: #ef4444;">${data.count.toLocaleString()}건</td>
                    <td style="font-size: 11px; color: #64748b;">${topDefect}</td>
                </tr>`;
            }).join('');
        }

        function updateDefectByPurposeDetail() {
            const purpose = document.getElementById('defectPurposeDetailFilter').value;
            if (!purpose) return;

            const byPurpose = currentData.by_defect_purpose || {};
            const byPurposeMonth = currentData.by_defect_purpose_month || {};

            const defects = byPurpose[purpose] || [];
            const monthData = byPurposeMonth[purpose] || {};

            const total = defects.reduce((s, d) => s + d[1].count, 0) || 1;
            document.getElementById('defectPurposeDetailBadge').textContent = total.toLocaleString() + '건';

            // 차트
            const top10 = defects.slice(0, 10);
            const ctx = document.getElementById('defectPurposeDetailChart').getContext('2d');
            if (charts.defectPurposeDetail) charts.defectPurposeDetail.destroy();
            charts.defectPurposeDetail = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top10.map(d => d[0].length > 8 ? d[0].substring(0, 8) + '..' : d[0]),
                    datasets: [{
                        data: top10.map(d => d[1].count),
                        backgroundColor: 'rgba(139, 92, 246, 0.8)',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                        x: { grid: { display: false }, ticks: { maxRotation: 45, minRotation: 45 } }
                    }
                }
            });

            // 테이블
            const renderMonthDots = (defectName) => {
                const defectMonths = monthData[defectName] || {};
                let dots = '';
                for (let i = 1; i <= 12; i++) {
                    const count = defectMonths[i] || 0;
                    const hasMonth = count > 0;
                    const color = hasMonth ? '#ef4444' : '#e2e8f0';
                    dots += `<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${color};margin:0 1px;" title="${i}월: ${count}건"></span>`;
                }
                return dots;
            };

            const tbody = document.querySelector('#defectPurposeDetailTable tbody');
            tbody.innerHTML = defects.slice(0, 20).map((d, idx) => {
                const percent = (d[1].count / total * 100).toFixed(1);
                const bgColor = idx % 2 === 0 ? '#fff' : '#f8fafc';
                return `<tr style="background: ${bgColor};">
                    <td style="font-weight: 600; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${d[0]}">${d[0]}</td>
                    <td class="text-right" style="color: #8b5cf6; font-weight: 600;">${d[1].count.toLocaleString()}</td>
                    <td style="color: #64748b;">${percent}%</td>
                    <td style="white-space: nowrap;">${renderMonthDots(d[0])}</td>
                </tr>`;
            }).join('');
        }

        // 목적별 데이터 저장
        let purposeAnalysisData = [];
        let purposeSortType = 'sales';

        function updatePurposeTab() {
            const purposes = currentData.by_purpose || [];
            const clients = currentData.by_client || [];
            const comparePurposes = compareData?.by_purpose || [];
            const compareMap = Object.fromEntries(comparePurposes.map(p => [p[0], p[1]]));
            const hasCompare = compareData && comparePurposes.length > 0;

            // 접수취소 제외한 총계 계산
            const validPurposes = purposes.filter(p => p[0] !== '접수취소' && p[1].sales > 0);
            const totalSales = validPurposes.reduce((s, p) => s + p[1].sales, 0) || 1;
            const totalCount = validPurposes.reduce((s, p) => s + p[1].count, 0);
            const compTotalSales = comparePurposes.filter(p => p[0] !== '접수취소' && p[1].sales > 0)
                .reduce((s, p) => s + p[1].sales, 0) || 1;

            // 목적별 상세 데이터 계산
            purposeAnalysisData = validPurposes.map(([name, data]) => {
                const compData = compareMap[name];
                const growth = hasCompare && compData && compData.sales > 0
                    ? ((data.sales - compData.sales) / compData.sales * 100)
                    : null;
                const percent = (data.sales / totalSales * 100);
                const avgPrice = data.count > 0 ? data.sales / data.count : 0;

                // 담당자별 집계
                const managerData = {};
                clients.forEach(([clientName, clientData]) => {
                    const clientPurpose = clientData.purpose || '';
                    if (clientPurpose === name || (clientData.byPurpose && clientData.byPurpose[name])) {
                        const mgr = clientData.manager || '미지정';
                        const purposeSales = clientData.byPurpose?.[name]?.sales || (clientPurpose === name ? clientData.sales : 0);
                        const purposeCount = clientData.byPurpose?.[name]?.count || (clientPurpose === name ? clientData.count : 0);
                        if (!managerData[mgr]) managerData[mgr] = { sales: 0, count: 0, clients: [] };
                        managerData[mgr].sales += purposeSales;
                        managerData[mgr].count += purposeCount;
                        if (purposeSales > 0 && !managerData[mgr].clients.includes(clientName)) {
                            managerData[mgr].clients.push(clientName);
                        }
                    }
                });

                const managers = Object.entries(managerData)
                    .map(([mgrName, mgrData]) => ({
                        name: mgrName,
                        sales: mgrData.sales,
                        count: mgrData.count,
                        clients: mgrData.clients,
                        percent: data.sales > 0 ? (mgrData.sales / data.sales * 100) : 0
                    }))
                    .filter(m => m.sales > 0)
                    .sort((a, b) => b.sales - a.sales)
                    .slice(0, 5);

                // 주요 업체 TOP 5
                const topClients = clients
                    .filter(([_, d]) => d.purpose === name || (d.byPurpose && d.byPurpose[name]))
                    .map(([n, d]) => ({
                        name: n,
                        sales: d.byPurpose?.[name]?.sales || (d.purpose === name ? d.sales : 0)
                    }))
                    .filter(c => c.sales > 0)
                    .sort((a, b) => b.sales - a.sales)
                    .slice(0, 5);

                return {
                    name,
                    sales: data.sales,
                    count: data.count,
                    percent,
                    avgPrice,
                    growth,
                    lastYearSales: compData?.sales || 0,
                    lastYearCount: compData?.count || 0,
                    managers,
                    topClients,
                    clientCount: topClients.length
                };
            });

            // KPI 업데이트
            document.getElementById('purposeTotalCount').textContent = validPurposes.length + '개';
            document.getElementById('purposeTotalSales').textContent = formatCurrency(totalSales);
            document.getElementById('purposeTotalCountNum').textContent = totalCount.toLocaleString() + '건';

            if (hasCompare) {
                const salesGrowth = ((totalSales - compTotalSales) / compTotalSales * 100);
                const growthColor = salesGrowth >= 0 ? '#10b981' : '#ef4444';
                document.getElementById('purposeTotalSalesCompare').innerHTML =
                    `전년 ${formatCurrency(compTotalSales)} <span style="color:${growthColor};">(${salesGrowth >= 0 ? '+' : ''}${salesGrowth.toFixed(1)}%)</span>`;
            } else {
                document.getElementById('purposeTotalSalesCompare').textContent = '-';
            }

            // 최고 성장 목적
            const growthData = purposeAnalysisData.filter(p => p.growth !== null).sort((a, b) => b.growth - a.growth);
            if (growthData.length > 0) {
                const top = growthData[0];
                document.getElementById('purposeTopGrowth').textContent =
                    top.name.length > 12 ? top.name.substring(0, 12) + '..' : top.name;
                document.getElementById('purposeTopGrowthRate').innerHTML =
                    `<span style="color:#10b981;">+${top.growth.toFixed(1)}%</span> 성장`;
            } else {
                document.getElementById('purposeTopGrowth').textContent = '-';
                document.getElementById('purposeTopGrowthRate').textContent = '전년 비교 필요';
            }

            // 카드 그리드 렌더링
            renderPurposeCards();

            // 차트 업데이트
            updatePurposeMonthlyChart();
            updatePurposeGrowthChart();

            // 테이블 업데이트
            updatePurposeDetailTable();

            // 담당자별 유형 보유 수 차트 & 지속적인 거래 유형 테이블
            updateManagerPurposeTypeChart();
            updateContinuousTradeTable();
        }

        // 정렬 기능
        function sortPurposeCards(sortType) {
            purposeSortType = sortType;

            // 버튼 상태 업데이트
            document.querySelectorAll('#purpose .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.sort === sortType);
            });

            renderPurposeCards();
        }

        // 카드 그리드 렌더링
        function renderPurposeCards() {
            let sorted = [...purposeAnalysisData];

            if (purposeSortType === 'sales') {
                sorted.sort((a, b) => b.sales - a.sales);
            } else if (purposeSortType === 'count') {
                sorted.sort((a, b) => b.count - a.count);
            } else if (purposeSortType === 'growth') {
                sorted.sort((a, b) => (b.growth ?? -9999) - (a.growth ?? -9999));
            } else if (purposeSortType === 'avgSales') {
                sorted.sort((a, b) => {
                    const avgA = a.count > 0 ? a.sales / a.count : 0;
                    const avgB = b.count > 0 ? b.sales / b.count : 0;
                    return avgB - avgA;
                });
            }

            const grid = document.getElementById('purposeCardGrid');
            grid.innerHTML = sorted.map((p, idx) => {
                const rank = idx + 1;
                const rankIcon = rank === 1 ? '🥇' : rank === 2 ? '🥈' : rank === 3 ? '🥉' : '';
                const topClass = rank === 1 ? 'top-1' : rank === 2 ? 'top-2' : rank === 3 ? 'top-3' : '';

                let growthBadge = '';
                if (p.growth !== null) {
                    const growthClass = p.growth >= 0 ? 'positive' : 'negative';
                    growthBadge = `<span class="purpose-card-growth ${growthClass}">${p.growth >= 0 ? '+' : ''}${p.growth.toFixed(1)}%</span>`;
                } else {
                    growthBadge = `<span class="purpose-card-growth neutral">-</span>`;
                }

                const topManager = p.managers[0];
                const managerText = topManager ? `👤 ${topManager.name} ${topManager.percent.toFixed(0)}%` : '👤 -';

                return `
                    <div class="purpose-card ${topClass}"
                         data-purpose="${p.name}"
                         onmouseenter="showPurposePopup(event, '${p.name.replace(/'/g, "\\'")}')"
                         onmouseleave="hidePurposePopup()">
                        <div class="purpose-card-rank">${rankIcon}</div>
                        <div class="purpose-card-header">
                            <div class="purpose-card-name">${p.name}</div>
                            ${growthBadge}
                        </div>
                        <div class="purpose-card-sales">${formatCurrency(p.sales)}</div>
                        <div class="purpose-card-count">📋 ${p.count.toLocaleString()}건 · 💰 ${formatCurrency(p.count > 0 ? Math.round(p.sales / p.count) : 0)}/건</div>
                        <div class="purpose-card-bar">
                            <div class="purpose-card-bar-fill" style="width: ${p.percent}%;"></div>
                        </div>
                        <div class="purpose-card-percent">${p.percent.toFixed(1)}%</div>
                        <div class="purpose-card-footer">
                            <span>${managerText}</span>
                            <span>🏢 ${p.clientCount}개</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 팝업 표시
        function showPurposePopup(event, purposeName) {
            const popup = document.getElementById('purposeHoverPopup');
            const p = purposeAnalysisData.find(d => d.name === purposeName);
            if (!p) return;

            // 순위 계산
            const sortedBySales = [...purposeAnalysisData].sort((a, b) => b.sales - a.sales);
            const rank = sortedBySales.findIndex(d => d.name === purposeName) + 1;
            const rankIcon = rank === 1 ? '🥇' : rank === 2 ? '🥈' : rank === 3 ? '🥉' : `${rank}위`;

            document.getElementById('popupPurposeName').textContent = p.name;
            document.getElementById('popupPurposeRank').textContent = rankIcon;
            document.getElementById('popupPurposeSales').textContent = formatCurrency(p.sales);
            document.getElementById('popupPurposeCount').textContent = p.count.toLocaleString() + '건';
            document.getElementById('popupPurposePercent').textContent = p.percent.toFixed(1) + '%';
            document.getElementById('popupPurposeAvg').textContent = formatCurrency(p.avgPrice);

            // 모든 비교 연도 데이터 표시
            if (compareDataList && compareDataList.length > 0) {
                let salesHtml = '', countHtml = '';
                compareDataList.forEach((compData) => {
                    const compPurposeMap = Object.fromEntries((compData.by_purpose || []).map(pp => [pp[0], pp[1]]));
                    const compPurpose = compPurposeMap[p.name];
                    if (compPurpose && compPurpose.sales > 0) {
                        salesHtml += `<div style="font-size:11px;color:#94a3b8;">${compData.year}년: ${formatCurrency(compPurpose.sales)}</div>`;
                        countHtml += `<div style="font-size:11px;color:#94a3b8;">${compData.year}년: ${compPurpose.count.toLocaleString()}건</div>`;
                    }
                });
                document.getElementById('popupPurposeLastSales').innerHTML = salesHtml || '';
                document.getElementById('popupPurposeLastCount').innerHTML = countHtml || '';
            } else if (p.lastYearSales > 0) {
                document.getElementById('popupPurposeLastSales').textContent = `전년 ${formatCurrency(p.lastYearSales)}`;
                document.getElementById('popupPurposeLastCount').textContent = `전년 ${p.lastYearCount.toLocaleString()}건`;
            } else {
                document.getElementById('popupPurposeLastSales').textContent = '';
                document.getElementById('popupPurposeLastCount').textContent = '';
            }

            // 담당자별 바
            const maxMgrSales = p.managers[0]?.sales || 1;
            document.getElementById('popupManagerBars').innerHTML = p.managers.slice(0, 4).map(m => `
                <div class="popup-manager-row">
                    <span class="popup-manager-name">${m.name}</span>
                    <div class="popup-manager-bar">
                        <div class="popup-manager-bar-fill" style="width: ${(m.sales / maxMgrSales * 100)}%;">
                            <span class="popup-manager-bar-text">${m.percent.toFixed(0)}%</span>
                        </div>
                    </div>
                    <span class="popup-manager-sales">${formatCurrency(m.sales)}</span>
                </div>
            `).join('') || '<div style="color: #94a3b8; font-size: 12px;">데이터 없음</div>';

            // 주요 업체 태그
            document.getElementById('popupClientTags').innerHTML = p.topClients.map((c, i) =>
                `<span class="popup-client-tag ${i === 0 ? 'top' : ''}">${i === 0 ? '👑 ' : ''}${c.name}</span>`
            ).join('') || '<span style="color: #94a3b8; font-size: 12px;">데이터 없음</span>';

            // AI 인사이트
            let insight = '';
            if (p.growth !== null) {
                if (p.growth > 10) {
                    insight = `전년 대비 <strong>${p.growth.toFixed(1)}%</strong> 성장 중입니다. ${p.managers[0]?.name || '담당자'}의 기여도가 높습니다.`;
                } else if (p.growth < -10) {
                    insight = `전년 대비 <strong>${Math.abs(p.growth).toFixed(1)}%</strong> 감소했습니다. 원인 분석이 필요합니다.`;
                } else {
                    insight = `전년과 비슷한 수준을 유지하고 있습니다.`;
                }
            } else {
                insight = `비중 ${p.percent.toFixed(1)}%로 ${p.percent > 10 ? '주요' : '소규모'} 검사 목적입니다.`;
            }
            document.getElementById('popupInsightText').innerHTML = insight;

            // 위치 계산
            const rect = event.currentTarget.getBoundingClientRect();
            const popupWidth = 400;
            const popupHeight = popup.offsetHeight || 450;

            let x = rect.right + 15;
            let y = rect.top;

            if (x + popupWidth > window.innerWidth - 20) {
                x = rect.left - popupWidth - 15;
            }
            if (y + popupHeight > window.innerHeight - 20) {
                y = window.innerHeight - popupHeight - 20;
            }
            y = Math.max(20, y);

            popup.style.left = x + 'px';
            popup.style.top = y + 'px';
            popup.classList.add('active');
        }

        function hidePurposePopup() {
            document.getElementById('purposeHoverPopup').classList.remove('active');
        }

        // TOP 5 월별 추이 차트
        function updatePurposeMonthlyChart() {
            const ctx = document.getElementById('purposeMonthlyChart');
            if (!ctx) return;
            if (charts.purposeMonthly) charts.purposeMonthly.destroy();

            const monthMap = Object.fromEntries(currentData.by_month || []);
            const labels = ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'];
            const colors = ['#6366f1', '#10b981', '#f59e0b', '#ec4899', '#06b6d4'];

            // TOP 5 목적별 월별 데이터
            const top5 = [...purposeAnalysisData].sort((a, b) => b.sales - a.sales).slice(0, 5);
            const datasets = top5.map((p, i) => {
                const monthlyData = labels.map((_, mIdx) => {
                    const monthData = monthMap[mIdx + 1]?.byPurpose?.[p.name];
                    return monthData?.sales || 0;
                });
                return {
                    label: p.name.length > 10 ? p.name.substring(0, 10) + '..' : p.name,
                    data: monthlyData,
                    borderColor: colors[i],
                    backgroundColor: colors[i] + '20',
                    tension: 0.4,
                    fill: false,
                    borderWidth: 2
                };
            });

            // purposeMonthlySummary 요약 정보 표시
            const purposeMonthlySummaryEl = document.getElementById('purposeMonthlySummary');
            if (purposeMonthlySummaryEl) {
                const totalSales = purposeAnalysisData.reduce((s, p) => s + p.sales, 0);
                const totalCount = purposeAnalysisData.reduce((s, p) => s + p.count, 0);
                const avgPrice = totalCount > 0 ? totalSales / totalCount : 0;
                const top5Sales = top5.reduce((s, p) => s + p.sales, 0);
                const top5Ratio = totalSales > 0 ? (top5Sales / totalSales * 100) : 0;
                let pmHtml = `<span style="white-space:nowrap;background:#dbeafe;padding:4px 10px;border-radius:4px;color:#1e40af;">전체매출: <strong style="color:#3b82f6;">${(totalSales / 100000000).toFixed(1)}억</strong></span>`;
                pmHtml += `<span style="white-space:nowrap;background:#e0e7ff;padding:4px 10px;border-radius:4px;color:#3730a3;">건수: <strong>${totalCount.toLocaleString()}건</strong></span>`;
                pmHtml += `<span style="white-space:nowrap;background:#fce7f3;padding:4px 10px;border-radius:4px;color:#9d174d;">평균단가: <strong>${Math.round(avgPrice / 10000).toLocaleString()}만</strong></span>`;
                pmHtml += `<span style="white-space:nowrap;background:#fef08a;padding:4px 10px;border-radius:4px;color:#854d0e;">TOP5비중: <strong>${top5Ratio.toFixed(1)}%</strong></span>`;
                purposeMonthlySummaryEl.innerHTML = pmHtml;
            }

            document.getElementById('purposeMonthlyBadge').textContent = `TOP 5 · ${currentData.year}년`;

            charts.purposeMonthly = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 } } }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: v => formatCurrency(v) } }
                    }
                }
            });
        }

        // 목적별 성장률 차트
        function updatePurposeGrowthChart() {
            const ctx = document.getElementById('purposeGrowthChart');
            if (!ctx) return;
            if (charts.purposeGrowth) charts.purposeGrowth.destroy();

            const hasCompare = compareData && compareData.by_purpose;
            document.getElementById('purposeGrowthBadge').textContent = hasCompare ? `${compareData.year} → ${currentData.year}` : '전년 비교 필요';

            if (!hasCompare) {
                charts.purposeGrowth = new Chart(ctx.getContext('2d'), {
                    type: 'bar',
                    data: { labels: ['전년 데이터를 선택하세요'], datasets: [{ data: [0], backgroundColor: '#e2e8f0' }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
                return;
            }

            const growthData = purposeAnalysisData
                .filter(p => p.growth !== null)
                .sort((a, b) => b.growth - a.growth)
                .slice(0, 12);

            // purposeGrowthSummary 요약 정보 표시
            const purposeGrowthSummaryEl = document.getElementById('purposeGrowthSummary');
            if (purposeGrowthSummaryEl) {
                const positiveGrowth = growthData.filter(p => p.growth >= 0);
                const negativeGrowth = growthData.filter(p => p.growth < 0);
                const avgGrowth = growthData.length > 0 ? growthData.reduce((s, p) => s + p.growth, 0) / growthData.length : 0;
                let pgHtml = `<span style="white-space:nowrap;background:${avgGrowth >= 0 ? '#d1fae5' : '#fee2e2'};padding:4px 10px;border-radius:4px;color:${avgGrowth >= 0 ? '#059669' : '#dc2626'};">평균성장률: <strong>${avgGrowth >= 0 ? '+' : ''}${avgGrowth.toFixed(1)}%</strong></span>`;
                pgHtml += `<span style="white-space:nowrap;background:#d1fae5;padding:4px 10px;border-radius:4px;color:#059669;">성장: <strong>${positiveGrowth.length}개</strong></span>`;
                pgHtml += `<span style="white-space:nowrap;background:#fee2e2;padding:4px 10px;border-radius:4px;color:#dc2626;">하락: <strong>${negativeGrowth.length}개</strong></span>`;
                purposeGrowthSummaryEl.innerHTML = pgHtml;
            }

            charts.purposeGrowth = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: growthData.map(p => p.name.length > 10 ? p.name.substring(0, 10) + '..' : p.name),
                    datasets: [{
                        label: '성장률(%)',
                        data: growthData.map(p => p.growth),
                        backgroundColor: growthData.map(p => p.growth >= 0 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)'),
                        borderRadius: 6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { callback: v => v.toFixed(0) + '%' } }
                    }
                }
            });
        }

        // 목적별 상세 테이블
        function updatePurposeDetailTable() {
            const tbody = document.querySelector('#purposeTable tbody');
            const sorted = [...purposeAnalysisData].sort((a, b) => b.sales - a.sales);
            document.getElementById('purposeTableBadge').textContent = sorted.length + '개 목적';

            tbody.innerHTML = sorted.map((p, idx) => {
                const rank = idx + 1;
                const rankIcon = rank === 1 ? '🥇' : rank === 2 ? '🥈' : rank === 3 ? '🥉' : rank;

                let growthCell = '-';
                if (p.growth !== null) {
                    const color = p.growth >= 0 ? '#10b981' : '#ef4444';
                    const icon = p.growth >= 0 ? '▲' : '▼';
                    growthCell = `<span style="color:${color};font-weight:600;">${icon} ${p.growth >= 0 ? '+' : ''}${p.growth.toFixed(1)}%</span>`;
                }

                const topManager = p.managers[0];
                const managerCell = topManager
                    ? `<span style="background:#f1f5f9;padding:2px 8px;border-radius:4px;font-size:11px;">${topManager.name} (${topManager.percent.toFixed(0)}%)</span>`
                    : '-';

                return `<tr>
                    <td style="text-align:center;font-weight:600;">${rankIcon}</td>
                    <td style="font-weight:600;">${p.name}</td>
                    <td class="text-right" style="font-weight:600;">${formatCurrency(p.sales)}</td>
                    <td class="text-right" style="color:#94a3b8;">${p.lastYearSales > 0 ? formatCurrency(p.lastYearSales) : '-'}</td>
                    <td class="text-right">${growthCell}</td>
                    <td class="text-right">${p.count.toLocaleString()}건</td>
                    <td class="text-right">${formatCurrency(p.avgPrice)}</td>
                    <td class="text-right"><span style="background:#f1f5f9;padding:2px 8px;border-radius:4px;">${p.percent.toFixed(1)}%</span></td>
                    <td>${managerCell}</td>
                </tr>`;
            }).join('');
        }

        // 담당자별 유형 보유 수 차트
        function updateManagerPurposeTypeChart() {
            const ctx = document.getElementById('managerPurposeTypeChart');
            if (!ctx) return;
            if (charts.managerPurposeType) charts.managerPurposeType.destroy();

            // 담당자별 보유 유형 수 계산
            const managerPurposeTypes = {};
            const managers = currentData.by_manager || [];

            managers.forEach(([name, data]) => {
                if (!name || name === '미지정') return;
                const purposeCount = Object.keys(data.by_purpose || {}).length;
                if (purposeCount > 0) {
                    managerPurposeTypes[name] = {
                        count: purposeCount,
                        sales: data.sales,
                        purposes: Object.entries(data.by_purpose || {}).map(([p, d]) => ({
                            name: p, sales: d.sales, count: d.count
                        })).sort((a, b) => b.sales - a.sales)
                    };
                }
            });

            // 유형 수 기준으로 정렬
            const sorted = Object.entries(managerPurposeTypes)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 15);

            // 요약 정보
            const summaryEl = document.getElementById('managerPurposeTypeSummary');
            if (summaryEl && sorted.length > 0) {
                const avgTypes = sorted.reduce((s, [_, d]) => s + d.count, 0) / sorted.length;
                const maxTypes = sorted[0][1].count;
                const maxManager = sorted[0][0];
                let html = `<span style="white-space:nowrap;background:#dbeafe;padding:4px 10px;border-radius:4px;color:#1e40af;">TOP: <strong>${maxManager}</strong> (${maxTypes}개)</span>`;
                html += `<span style="white-space:nowrap;background:#e0e7ff;padding:4px 10px;border-radius:4px;color:#3730a3;">평균: <strong>${avgTypes.toFixed(1)}개</strong></span>`;
                html += `<span style="white-space:nowrap;background:#fce7f3;padding:4px 10px;border-radius:4px;color:#9d174d;">담당자: <strong>${sorted.length}명</strong></span>`;
                summaryEl.innerHTML = html;
            }

            document.getElementById('managerPurposeTypeBadge').textContent = `TOP ${sorted.length}`;

            const colors = sorted.map((_, i) => {
                const hue = (i * 25) % 360;
                return `hsl(${hue}, 70%, 50%)`;
            });

            charts.managerPurposeType = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: sorted.map(([name]) => name.length > 6 ? name.substring(0, 6) + '..' : name),
                    datasets: [{
                        label: '유형 수',
                        data: sorted.map(([_, d]) => d.count),
                        backgroundColor: colors.map(c => c.replace('50%)', '50%, 0.7)')),
                        borderColor: colors,
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                afterBody: function(context) {
                                    const idx = context[0].dataIndex;
                                    const [name, data] = sorted[idx];
                                    const top3 = data.purposes.slice(0, 3);
                                    return ['', '주요 유형:'].concat(top3.map(p => `  • ${p.name}: ${formatCurrency(p.sales)}`));
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { stepSize: 1, callback: v => v + '개' }
                        }
                    }
                }
            });
        }

        // 지속적인 거래 유형 테이블
        function updateContinuousTradeTable() {
            const tbody = document.querySelector('#continuousTradeTable tbody');
            if (!tbody) return;

            const data = currentData.client_purpose_months || [];
            const summaryEl = document.getElementById('continuousTradeSummary');
            document.getElementById('continuousTradeBadge').textContent = `${data.length}건`;

            // 요약 정보
            if (summaryEl && data.length > 0) {
                const avg = data.reduce((s, d) => s + d.monthCount, 0) / data.length;
                const over6 = data.filter(d => d.monthCount >= 6).length;
                const over12 = data.filter(d => d.monthCount >= 12).length;
                let html = `<span style="white-space:nowrap;background:#d1fae5;padding:4px 10px;border-radius:4px;color:#059669;">12개월+: <strong>${over12}건</strong></span>`;
                html += `<span style="white-space:nowrap;background:#dbeafe;padding:4px 10px;border-radius:4px;color:#1e40af;">6개월+: <strong>${over6}건</strong></span>`;
                html += `<span style="white-space:nowrap;background:#fef08a;padding:4px 10px;border-radius:4px;color:#854d0e;">평균: <strong>${avg.toFixed(1)}개월</strong></span>`;
                summaryEl.innerHTML = html;
            }

            tbody.innerHTML = data.slice(0, 50).map((d, idx) => {
                const monthCountColor = d.monthCount >= 12 ? '#059669' : d.monthCount >= 6 ? '#3b82f6' : '#f59e0b';
                const monthsStr = d.months.map(m => m + '월').join(', ');

                return `<tr>
                    <td style="font-weight:600;">${d.client.length > 15 ? d.client.substring(0, 15) + '..' : d.client}</td>
                    <td><span style="background:#f1f5f9;padding:2px 8px;border-radius:4px;font-size:11px;">${d.purpose.length > 12 ? d.purpose.substring(0, 12) + '..' : d.purpose}</span></td>
                    <td class="text-right"><span style="color:${monthCountColor};font-weight:700;">${d.monthCount}개월</span></td>
                    <td class="text-right">${formatCurrency(d.sales)}</td>
                    <td class="text-right">${d.count.toLocaleString()}건</td>
                    <td style="font-size:11px;color:#64748b;">${monthsStr}</td>
                </tr>`;
            }).join('');
        }

        // ========================================
        // 검사항목 탭 기능
        // ========================================
        let foodItemData = null;

        async function updateFoodItemTab() {
            const year = document.getElementById('yearSelect').value;
            try {
                const res = await fetch(`/api/food_item?year=${year}`);
                foodItemData = await res.json();

                // KPI 업데이트
                document.getElementById('foodItemTotalCount').textContent = (foodItemData.total_count || 0).toLocaleString() + '건';
                document.getElementById('foodItemTotalFee').textContent = formatCurrency(foodItemData.total_fee || 0);
                document.getElementById('foodItemTypeCount').textContent = (foodItemData.items?.length || 0) + '개';
                document.getElementById('foodItemAnalyzerCount').textContent = (foodItemData.analyzers?.length || 0) + '명';

                // 검사목적 드롭다운 초기화
                const purposeFilter = document.getElementById('foodItemPurposeFilter');
                if (purposeFilter.options.length <= 1) {
                    (foodItemData.purposes || []).forEach(p => {
                        if (p && p !== '접수취소') purposeFilter.add(new Option(p, p));
                    });
                }

                // 첫 번째 목적으로 초기화
                if (purposeFilter.options.length > 1 && !purposeFilter.value) {
                    purposeFilter.selectedIndex = 1;
                }

                // 차트/테이블 업데이트
                updateFoodItemByPurpose();
                updateFoodItemChart();
                updateFoodItemDiversityTable();
                updateFoodItemAnalyzerChart();
                updateFoodItemMonthlyChart();
                updateFoodItemDetailTable();
            } catch (e) {
                console.log('검사항목 데이터 로드 실패:', e);
            }
        }

        // 검사목적별 항목 현황
        function updateFoodItemByPurpose() {
            if (!foodItemData) return;
            const purpose = document.getElementById('foodItemPurposeFilter').value;
            const byPurposeItem = foodItemData.by_purpose_item || {};
            const items = byPurposeItem[purpose] || [];

            const total = items.reduce((s, [n, d]) => s + d.count, 0);
            const totalFee = items.reduce((s, [n, d]) => s + d.fee, 0);
            document.getElementById('foodItemPurposeBadge').textContent = items.length + '개 항목 · ' + total.toLocaleString() + '건';

            // 차트 업데이트
            const ctx = document.getElementById('foodItemPurposeChart');
            if (!ctx) return;
            if (charts.foodItemPurpose) charts.foodItemPurpose.destroy();

            const top15 = items.slice(0, 15);
            const colors = top15.map((_, i) => `hsl(${210 + i * 8}, 70%, ${55 - i * 2}%)`);

            charts.foodItemPurpose = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: top15.map(([n]) => n.length > 12 ? n.substring(0, 12) + '..' : n),
                    datasets: [{
                        label: '건수',
                        data: top15.map(([_, d]) => d.count),
                        backgroundColor: colors.map(c => c.replace(')', ', 0.7)')),
                        borderColor: colors,
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                afterLabel: (ctx) => {
                                    const [name, data] = top15[ctx.dataIndex];
                                    const pct = total > 0 ? (data.count / total * 100).toFixed(1) : 0;
                                    return `수수료: ${formatCurrency(data.fee)} (${pct}%)`;
                                }
                            }
                        }
                    },
                    scales: { x: { beginAtZero: true } }
                }
            });

            // 테이블 업데이트
            const tbody = document.querySelector('#foodItemPurposeTable tbody');
            tbody.innerHTML = items.slice(0, 30).map(([name, data], idx) => {
                const pct = total > 0 ? (data.count / total * 100).toFixed(1) : 0;
                return `<tr>
                    <td style="font-weight:500;">${name}</td>
                    <td class="text-right" style="font-weight:600;color:#2563eb;">${data.count.toLocaleString()}건</td>
                    <td class="text-right" style="color:#64748b;">${formatCurrency(data.fee)}</td>
                    <td><span style="background:#dbeafe;padding:2px 8px;border-radius:4px;font-size:11px;color:#1e40af;">${pct}%</span></td>
                </tr>`;
            }).join('');
        }

        // 검사항목 TOP 15 차트
        function updateFoodItemChart() {
            if (!foodItemData) return;
            const ctx = document.getElementById('foodItemChart');
            if (!ctx) return;
            if (charts.foodItem) charts.foodItem.destroy();

            const items = (foodItemData.by_item || []).slice(0, 15);
            const total = items.reduce((s, [_, d]) => s + d.count, 0);

            const colors = items.map((_, i) => {
                const hue = (220 + i * 10) % 360;
                return `hsl(${hue}, 65%, 55%)`;
            });

            charts.foodItem = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: items.map(([n]) => n.length > 10 ? n.substring(0, 10) + '..' : n),
                    datasets: [{
                        label: '건수',
                        data: items.map(([_, d]) => d.count),
                        backgroundColor: colors.map(c => c.replace(')', ', 0.75)')),
                        borderColor: colors,
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                afterLabel: (ctx) => {
                                    const [name, data] = items[ctx.dataIndex];
                                    const pct = total > 0 ? (data.count / total * 100).toFixed(1) : 0;
                                    return `수수료: ${formatCurrency(data.fee)} (${pct}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true },
                        x: { ticks: { maxRotation: 45, minRotation: 45 } }
                    }
                }
            });
        }

        // 항목별 분석자 다양성 테이블
        function updateFoodItemDiversityTable() {
            if (!foodItemData) return;
            const diversity = foodItemData.item_analyzer_diversity || [];
            document.getElementById('foodItemDiversityBadge').textContent = diversity.length + '개 항목';

            const tbody = document.querySelector('#foodItemDiversityTable tbody');
            tbody.innerHTML = diversity.slice(0, 30).map(d => {
                const topAnalyzers = d.top_analyzers || [];
                const analyzerTags = topAnalyzers.slice(0, 3).map(([name, cnt]) =>
                    `<span style="background:#f1f5f9;padding:2px 6px;border-radius:4px;font-size:10px;margin-right:4px;">${name}(${cnt})</span>`
                ).join('');

                return `<tr>
                    <td style="font-weight:500;">${d.item}</td>
                    <td class="text-right" style="font-weight:600;color:#2563eb;">${d.total_count.toLocaleString()}건</td>
                    <td class="text-right"><span style="background:${d.analyzer_count > 1 ? '#fef3c7' : '#f1f5f9'};padding:2px 8px;border-radius:4px;font-size:12px;color:${d.analyzer_count > 1 ? '#92400e' : '#64748b'};">${d.analyzer_count}명</span></td>
                    <td style="font-size:11px;">${analyzerTags}</td>
                </tr>`;
            }).join('');
        }

        // 분석자별 처리 현황 차트
        function updateFoodItemAnalyzerChart() {
            if (!foodItemData) return;
            const ctx = document.getElementById('foodItemAnalyzerChart');
            if (!ctx) return;
            if (charts.foodItemAnalyzer) charts.foodItemAnalyzer.destroy();

            const analyzers = (foodItemData.by_analyzer || []).slice(0, 12);
            const total = analyzers.reduce((s, [_, d]) => s + d.count, 0);
            document.getElementById('foodItemAnalyzerBadge').textContent = (foodItemData.analyzers?.length || 0) + '명 분석자';

            const colors = analyzers.map((_, i) => {
                const hue = (140 + i * 20) % 360;
                return `hsl(${hue}, 60%, 50%)`;
            });

            charts.foodItemAnalyzer = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: analyzers.map(([n]) => n.length > 8 ? n.substring(0, 8) + '..' : n),
                    datasets: [{
                        label: '처리건수',
                        data: analyzers.map(([_, d]) => d.count),
                        backgroundColor: colors.map(c => c.replace(')', ', 0.75)')),
                        borderColor: colors,
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                afterLabel: (ctx) => {
                                    const [name, data] = analyzers[ctx.dataIndex];
                                    const pct = total > 0 ? (data.count / total * 100).toFixed(1) : 0;
                                    return `항목 종류: ${data.item_count || 0}개, 비중: ${pct}%`;
                                }
                            }
                        }
                    },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // 월별 검사 추이 차트
        function updateFoodItemMonthlyChart() {
            if (!foodItemData) return;
            const ctx = document.getElementById('foodItemMonthlyChart');
            if (!ctx) return;
            if (charts.foodItemMonthly) charts.foodItemMonthly.destroy();

            const monthFee = foodItemData.by_month_fee || [];
            const months = [];
            const fees = [];
            for (let i = 1; i <= 12; i++) {
                months.push(i + '월');
                const found = monthFee.find(([m]) => parseInt(m) === i);
                fees.push(found ? found[1] : 0);
            }

            const total = fees.reduce((s, f) => s + f, 0);
            document.getElementById('foodItemMonthlyBadge').textContent = '총 ' + formatCurrency(total);

            charts.foodItemMonthly = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: '수수료',
                        data: fees,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointBackgroundColor: '#6366f1',
                        pointRadius: 5,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => formatCurrency(ctx.raw)
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: v => formatCurrency(v) }
                        }
                    }
                }
            });
        }

        // 검사항목별 상세 테이블
        function updateFoodItemDetailTable() {
            if (!foodItemData) return;
            const items = foodItemData.by_item || [];
            const total = items.reduce((s, [_, d]) => s + d.count, 0);
            document.getElementById('foodItemTableBadge').textContent = items.length + '개';

            const tbody = document.querySelector('#foodItemTable tbody');
            tbody.innerHTML = items.slice(0, 50).map(([name, data], idx) => {
                const pct = total > 0 ? (data.count / total * 100).toFixed(1) : 0;

                // 월별 추이 (미니 바)
                const byMonth = foodItemData.by_item_month?.[name] || [];
                const maxMonth = Math.max(...byMonth.map(([_, c]) => c), 1);
                const monthBars = [];
                for (let m = 1; m <= 12; m++) {
                    const found = byMonth.find(([mon]) => parseInt(mon) === m);
                    const cnt = found ? found[1] : 0;
                    const h = cnt > 0 ? Math.max(4, (cnt / maxMonth) * 20) : 2;
                    const color = cnt > 0 ? '#6366f1' : '#e2e8f0';
                    monthBars.push(`<div style="width:6px;height:${h}px;background:${color};border-radius:1px;" title="${m}월: ${cnt}건"></div>`);
                }

                return `<tr>
                    <td style="font-weight:500;">${name}</td>
                    <td class="text-right" style="font-weight:600;color:#2563eb;">${data.count.toLocaleString()}건</td>
                    <td class="text-right" style="color:#64748b;">${formatCurrency(data.fee)}</td>
                    <td><span style="background:#f1f5f9;padding:2px 8px;border-radius:4px;font-size:11px;">${pct}%</span></td>
                    <td><div style="display:flex;gap:2px;align-items:flex-end;height:24px;">${monthBars.join('')}</div></td>
                </tr>`;
            }).join('');
        }

        // AI 분석
        function setAiQuery(text) { document.getElementById('aiQueryInput').value = text; }

        async function runAiAnalysis() {
            const query = document.getElementById('aiQueryInput').value.trim();
            if (!query) { alert('질문을 입력해주세요.'); return; }

            const btn = document.getElementById('aiBtn');
            const loading = document.getElementById('aiLoading');
            const error = document.getElementById('aiError');
            const content = document.getElementById('aiContent');
            const result = document.getElementById('aiResult');

            btn.disabled = true;
            loading.style.display = 'block';
            error.style.display = 'none';
            content.innerHTML = '';
            result.classList.add('show');

            try {
                const res = await fetch('/api/ai/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });
                const data = await res.json();

                loading.style.display = 'none';

                if (data.error) {
                    error.textContent = data.error;
                    error.style.display = 'block';
                } else if (data.analysis_type === 'management_insight' && data.response) {
                    // 새로운 경영 분석 응답 처리
                    const markdown = data.response;
                    let html = formatMarkdownToHtml(markdown);

                    // 데이터 요약 표시
                    if (data.data_summary) {
                        const summary = data.data_summary;
                        html += `<div class="ai-evidence" style="margin-top: 20px;">
                            <strong>📊 분석 기준 데이터</strong><br>
                            2025년 매출: ${formatCurrency(summary.total_sales_2025)} |
                            2024년 매출: ${formatCurrency(summary.total_sales_2024)} |
                            성장률: ${summary.growth_rate > 0 ? '+' : ''}${summary.growth_rate}%
                        </div>`;
                    }

                    content.innerHTML = html;
                } else {
                    // 기존 응답 형식 처리 (하위 호환성)
                    let html = `<p style="margin-bottom: 12px;"><strong>📝 ${data.description || '분석 결과'}</strong></p>`;

                    if (data.analysis_type === 'year_comparison' && data.comparison) {
                        const c = data.comparison;
                        html += `<table class="ai-result-table"><thead><tr><th>구분</th><th>건수</th><th>매출</th></tr></thead><tbody>`;
                        html += `<tr><td>${c.main_year?.year || '2025'}년</td><td>${(c.main_year?.count || 0).toLocaleString()}</td><td>${formatCurrency(c.main_year?.sales || 0)}</td></tr>`;
                        html += `<tr><td>${c.compare_year?.year || '2024'}년</td><td>${(c.compare_year?.count || 0).toLocaleString()}</td><td>${formatCurrency(c.compare_year?.sales || 0)}</td></tr>`;
                        const diff = c.difference || {};
                        const color = (diff.sales || 0) >= 0 ? 'var(--success)' : 'var(--danger)';
                        const sign = (diff.sales || 0) >= 0 ? '+' : '';
                        html += `<tr style="font-weight: bold; color: ${color};"><td>차이</td><td>${sign}${(diff.count || 0).toLocaleString()}</td><td>${sign}${formatCurrency(diff.sales || 0)} (${sign}${diff.growth_rate || 0}%)</td></tr>`;
                        html += `</tbody></table>`;
                    } else if (data.top_items) {
                        html += `<table class="ai-result-table"><thead><tr><th>순위</th><th>항목</th><th>매출</th></tr></thead><tbody>`;
                        data.top_items.forEach((item, i) => {
                            html += `<tr><td>${i+1}</td><td>${item.name}</td><td>${formatCurrency(item.sales || item.fee || 0)}</td></tr>`;
                        });
                        html += `</tbody></table>`;
                    } else if (data.summary) {
                        html += `<p>총 건수: <strong>${data.summary.total_count?.toLocaleString() || 0}건</strong></p>`;
                        html += `<p>총 매출: <strong>${formatCurrency(data.summary.total_sales || data.summary.total_fee || 0)}</strong></p>`;
                    } else if (data.direct_answer) {
                        html += `<p>${data.direct_answer}</p>`;
                    }

                    content.innerHTML = html;
                }
            } catch (e) {
                loading.style.display = 'none';
                error.textContent = '분석 실패: ' + e.message;
                error.style.display = 'block';
            } finally {
                btn.disabled = false;
                loadTokenUsage();
            }
        }

        // 마크다운을 HTML로 변환
        function formatMarkdownToHtml(markdown) {
            if (!markdown) return '';

            // 줄 단위로 처리
            const lines = markdown.split('\\n');
            let html = '';
            let inList = false;

            lines.forEach(line => {
                // 헤딩
                if (line.startsWith('## ')) {
                    if (inList) { html += '</ul>'; inList = false; }
                    const title = line.substring(3);
                    let color = '';
                    if (title.includes('장점') || title.includes('강점')) color = 'color: var(--success);';
                    else if (title.includes('개선') || title.includes('주의') || title.includes('단점')) color = 'color: var(--warning);';
                    else if (title.includes('제안') || title.includes('방향') || title.includes('방안')) color = 'color: var(--info);';
                    else if (title.includes('근거') || title.includes('데이터')) color = 'color: var(--gray-600);';
                    html += '<h3 class="ai-section-title" style="' + color + '">' + title + '</h3>';
                }
                // 리스트
                else if (line.startsWith('- ')) {
                    if (!inList) { html += '<ul class="ai-list">'; inList = true; }
                    html += '<li>' + formatInlineMarkdown(line.substring(2)) + '</li>';
                }
                // 일반 텍스트
                else if (line.trim()) {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += '<p>' + formatInlineMarkdown(line) + '</p>';
                }
            });

            if (inList) html += '</ul>';
            return '<div class="ai-response">' + html + '</div>';
        }

        function formatInlineMarkdown(text) {
            // 굵은 텍스트 변환: **text** -> <strong>text</strong>
            return text.replace(/[*][*]([^*]+)[*][*]/g, '<strong>$1</strong>');
        }

        // ============ 수금 탭 ============
        let collectionData = null;
        let collectionCharts = {};

        async function updateCollectionTab() {
            const year = document.getElementById('yearSelect').value;
            try {
                const res = await fetch(`/api/collection?year=${year}`);
                collectionData = await res.json();
                updateCollectionKPI();
                updateCollectionCharts();
                updateUnpaidTable();
            } catch (e) {
                console.error('수금 데이터 로드 실패:', e);
            }
        }

        function updateCollectionKPI() {
            if (!collectionData) return;
            document.getElementById('collectionTotalSales').textContent = formatCurrency(collectionData.total_sales || 0);
            document.getElementById('collectionPaid').textContent = formatCurrency(collectionData.paid_amount || 0);
            document.getElementById('collectionUnpaid').textContent = formatCurrency(collectionData.unpaid_amount || 0);
            document.getElementById('collectionRate').textContent = (collectionData.collection_rate || 0) + '%';
            document.getElementById('avgCollectionDays').textContent = (collectionData.avg_days || 0) + '일';
            document.getElementById('minCollectionDays').textContent = (collectionData.min_days || 0) + '일';
            document.getElementById('maxCollectionDays').textContent = (collectionData.max_days || 0) + '일';
        }

        function updateCollectionCharts() {
            if (!collectionData) return;

            // 담당별 수금 차트
            const managerCtx = document.getElementById('collectionByManagerChart');
            if (managerCtx) {
                if (collectionCharts.manager) collectionCharts.manager.destroy();
                const managerData = collectionData.by_manager || [];
                collectionCharts.manager = new Chart(managerCtx, {
                    type: 'bar',
                    data: {
                        labels: managerData.map(d => d[0]),
                        datasets: [{
                            label: '수금',
                            data: managerData.map(d => d[1].paid),
                            backgroundColor: 'rgba(34, 197, 94, 0.7)'
                        }, {
                            label: '미수금',
                            data: managerData.map(d => d[1].unpaid),
                            backgroundColor: 'rgba(239, 68, 68, 0.7)'
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true, ticks: { callback: v => (v/100000000).toFixed(1) + '억' } } } }
                });
            }

            // 월별 수금 차트
            const monthlyCtx = document.getElementById('collectionMonthlyChart');
            if (monthlyCtx) {
                if (collectionCharts.monthly) collectionCharts.monthly.destroy();
                const monthlyData = collectionData.by_month || [];
                collectionCharts.monthly = new Chart(monthlyCtx, {
                    type: 'line',
                    data: {
                        labels: monthlyData.map(d => d[0] + '월'),
                        datasets: [{
                            label: '수금액',
                            data: monthlyData.map(d => d[1].paid),
                            borderColor: '#22c55e',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { callback: v => (v/100000000).toFixed(1) + '억' } } } }
                });
            }

            // 수금 기간 분포 차트
            const daysCtx = document.getElementById('collectionDaysChart');
            if (daysCtx) {
                if (collectionCharts.days) collectionCharts.days.destroy();
                const daysData = collectionData.days_distribution || [];
                collectionCharts.days = new Chart(daysCtx, {
                    type: 'bar',
                    data: {
                        labels: daysData.map(d => d[0]),
                        datasets: [{
                            label: '건수',
                            data: daysData.map(d => d[1]),
                            backgroundColor: ['#22c55e', '#84cc16', '#eab308', '#f97316', '#ef4444']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            }

            // 입금 구분별 차트
            const typeCtx = document.getElementById('collectionTypeChart');
            if (typeCtx) {
                if (collectionCharts.type) collectionCharts.type.destroy();
                const typeData = collectionData.by_type || [];
                collectionCharts.type = new Chart(typeCtx, {
                    type: 'doughnut',
                    data: {
                        labels: typeData.map(d => d[0]),
                        datasets: [{
                            data: typeData.map(d => d[1]),
                            backgroundColor: ['#3b82f6', '#22c55e', '#eab308', '#f97316', '#ef4444', '#8b5cf6', '#ec4899']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }
        }

        function updateUnpaidTable() {
            if (!collectionData) return;
            const tbody = document.querySelector('#unpaidTable tbody');
            const unpaidList = collectionData.unpaid_list || [];
            document.getElementById('unpaidCountBadge').textContent = unpaidList.length + '건';

            tbody.innerHTML = unpaidList.map(item => `
                <tr>
                    <td>${item.company || '-'}</td>
                    <td>${item.date || '-'}</td>
                    <td style="text-align:right; color:#dc2626; font-weight:600;">${formatCurrency(item.amount)}</td>
                    <td style="text-align:center; ${item.days > 60 ? 'color:#dc2626; font-weight:bold;' : ''}">${item.days}일</td>
                    <td>${item.manager || '-'}</td>
                </tr>
            `).join('');
        }

        // 세션 정보 로드
        async function loadSessionInfo() {
            console.log('[DEBUG] loadSessionInfo() called');
            try {
                const response = await fetch('/api/auth/session');
                const data = await response.json();
                console.log('[DEBUG] Session data:', data);
                if (data.logged_in) {
                    document.getElementById('userInfo').textContent = (data.user.name || data.user.username) + '님';
                    if (data.user.role === 'admin') {
                        document.getElementById('adminBtn').style.display = 'inline-block';
                    }
                } else {
                    document.getElementById('userInfo').textContent = '로그인 필요';
                }
            } catch (e) {
                console.error('[DEBUG] Session load error:', e);
                document.getElementById('userInfo').textContent = '세션 오류';
            }
        }

        // ============ 손익분석 함수들 ============
        let profitCharts = {};
        let currentProfitTab = 'purpose';

        async function loadProfitAnalysisData() {
            console.log('[손익분석] loadProfitAnalysisData 호출됨');
            const yearEl = document.getElementById('yearSelect');
            if (!yearEl) {
                console.error('[손익분석] yearSelect 요소를 찾을 수 없음');
                return;
            }
            const year = yearEl.value;
            console.log('[손익분석] 조회 연도:', year);
            try {
                console.log('[손익분석] API 호출 시작...');
                const [summaryRes, purposeRes, managerRes, monthRes] = await Promise.all([
                    fetch(`/api/profit/summary?year=${year}`),
                    fetch(`/api/profit/by-purpose?year=${year}`),
                    fetch(`/api/profit/by-manager?year=${year}`),
                    fetch(`/api/profit/by-month?year=${year}`)
                ]);

                console.log('[손익분석] API 응답 상태:', summaryRes.status, purposeRes.status, managerRes.status, monthRes.status);

                const summary = await summaryRes.json();
                const purposeData = await purposeRes.json();
                const managerData = await managerRes.json();
                const monthData = await monthRes.json();

                console.log('[손익분석] summary:', summary);
                console.log('[손익분석] purposeData:', purposeData);

                // KPI 업데이트 (손익계산서 구조)
                const isFinSettings = summary.source === 'financial_settings';
                document.getElementById('profitKpiSource').textContent = `데이터 소스: ${isFinSettings ? '손익계산서 설정' : 'Excel 데이터'}`;

                document.getElementById('profitTotalSales').textContent = formatCurrency(summary.total_actual_sales || 0);
                document.getElementById('profitTotalCost').textContent = formatCurrency(summary.estimated_cost || summary.cost_of_sales || 0);
                document.getElementById('profitCostRate').textContent = `원가율: ${summary.cost_rate || 0}%`;

                // 판관비 (financial_settings에서만)
                const sgaEl = document.getElementById('profitSgaExpense');
                const sgaRateEl = document.getElementById('profitSgaRate');
                if (isFinSettings && summary.sga_expense) {
                    sgaEl.textContent = formatCurrency(summary.sga_expense);
                    sgaRateEl.textContent = `판관비율: ${summary.sga_rate || 0}%`;
                } else {
                    sgaEl.textContent = '-';
                    sgaRateEl.textContent = '데이터 없음';
                }

                // 영업이익 (음수면 빨간색)
                const profitEl = document.getElementById('profitTotalProfit');
                const profitVal = summary.estimated_profit || summary.operating_profit || 0;
                profitEl.textContent = formatCurrency(profitVal);
                profitEl.style.color = profitVal >= 0 ? '#059669' : '#dc2626';

                document.getElementById('profitMarginRate').textContent = (summary.profit_rate || 0) + '%';

                // 세전이익 (financial_settings에서만)
                const netProfitEl = document.getElementById('profitNetProfit');
                const discountEl = document.getElementById('profitDiscountRate');
                if (isFinSettings && summary.net_profit !== undefined) {
                    netProfitEl.textContent = formatCurrency(summary.net_profit);
                    netProfitEl.style.color = summary.net_profit >= 0 ? '#0891b2' : '#dc2626';
                    discountEl.textContent = `영업외: ${formatCurrency(summary.non_operating_income || 0)}`;
                } else {
                    netProfitEl.textContent = '-';
                    discountEl.textContent = `할인율: ${summary.discount_rate || 0}%`;
                }

                console.log('[손익분석] KPI 업데이트 완료');

                // 테이블 및 차트 업데이트
                updateProfitByPurposeTable(purposeData.data || []);
                updateProfitByManagerTable(managerData.data || []);
                updateProfitByMonthTable(monthData.data || []);
                updateProfitCharts(purposeData.data, managerData.data, monthData.data);
            } catch (e) {
                console.error('손익분석 데이터 로드 실패:', e);
            }
        }

        function showProfitTab(tab) {
            currentProfitTab = tab;
            document.querySelectorAll('.profit-section').forEach(s => s.style.display = 'none');
            document.getElementById('profitBy' + tab.charAt(0).toUpperCase() + tab.slice(1)).style.display = 'block';
            document.querySelectorAll('#profitAnalysis .btn').forEach(b => {
                b.style.background = '#e2e8f0';
                b.style.color = '#1e293b';
            });
            document.getElementById('btnProfitBy' + tab.charAt(0).toUpperCase() + tab.slice(1)).style.background = '#2563eb';
            document.getElementById('btnProfitBy' + tab.charAt(0).toUpperCase() + tab.slice(1)).style.color = 'white';
        }

        function updateProfitByPurposeTable(data) {
            const tbody = document.querySelector('#profitByPurposeTable tbody');
            tbody.innerHTML = data.map(d => `
                <tr>
                    <td>${d.purpose}</td>
                    <td style="text-align:right;">${d.count.toLocaleString()}</td>
                    <td style="text-align:right;">${formatCurrency(d.normal_price)}</td>
                    <td style="text-align:right;">${formatCurrency(d.actual_sales)}</td>
                    <td style="text-align:right; color:${d.discount_rate > 0 ? '#f59e0b' : '#059669'};">${d.discount_rate}%</td>
                    <td style="text-align:right; color:#dc2626;">${formatCurrency(d.estimated_cost)}</td>
                    <td style="text-align:right; color:${d.estimated_profit >= 0 ? '#059669' : '#dc2626'};">${formatCurrency(d.estimated_profit)}</td>
                    <td style="text-align:right; font-weight:bold;">${d.profit_rate}%</td>
                </tr>
            `).join('') || '<tr><td colspan="8" style="text-align:center;">데이터 없음</td></tr>';
        }

        function updateProfitByManagerTable(data) {
            const tbody = document.querySelector('#profitByManagerTable tbody');
            tbody.innerHTML = data.map(d => `
                <tr>
                    <td>${d.manager}</td>
                    <td style="text-align:right;">${d.count.toLocaleString()}</td>
                    <td style="text-align:right;">${formatCurrency(d.normal_price)}</td>
                    <td style="text-align:right;">${formatCurrency(d.actual_sales)}</td>
                    <td style="text-align:right; color:${d.discount_rate > 0 ? '#f59e0b' : '#059669'};">${d.discount_rate}%</td>
                    <td style="text-align:right; color:#dc2626;">${formatCurrency(d.estimated_cost)}</td>
                    <td style="text-align:right; color:${d.estimated_profit >= 0 ? '#059669' : '#dc2626'};">${formatCurrency(d.estimated_profit)}</td>
                    <td style="text-align:right; font-weight:bold;">${d.profit_rate}%</td>
                </tr>
            `).join('') || '<tr><td colspan="8" style="text-align:center;">데이터 없음</td></tr>';
        }

        function updateProfitByMonthTable(data) {
            const tbody = document.querySelector('#profitByMonthTable tbody');
            tbody.innerHTML = data.filter(d => d.count > 0).map(d => `
                <tr>
                    <td>${d.month_name}</td>
                    <td style="text-align:right;">${d.count.toLocaleString()}</td>
                    <td style="text-align:right;">${formatCurrency(d.normal_price)}</td>
                    <td style="text-align:right;">${formatCurrency(d.actual_sales)}</td>
                    <td style="text-align:right; color:${d.discount_rate > 0 ? '#f59e0b' : '#059669'};">${d.discount_rate}%</td>
                    <td style="text-align:right; color:#dc2626;">${formatCurrency(d.estimated_cost)}</td>
                    <td style="text-align:right; color:${d.estimated_profit >= 0 ? '#059669' : '#dc2626'};">${formatCurrency(d.estimated_profit)}</td>
                    <td style="text-align:right; font-weight:bold;">${d.profit_rate}%</td>
                </tr>
            `).join('') || '<tr><td colspan="8" style="text-align:center;">데이터 없음</td></tr>';
        }

        function updateProfitCharts(purposeData, managerData, monthData) {
            // 검사목적별 차트
            const purposeCtx = document.getElementById('profitByPurposeChart');
            if (purposeCtx && purposeData) {
                if (profitCharts.purpose) profitCharts.purpose.destroy();
                profitCharts.purpose = new Chart(purposeCtx, {
                    type: 'bar',
                    data: {
                        labels: purposeData.slice(0, 10).map(d => d.purpose),
                        datasets: [{
                            label: '매출',
                            data: purposeData.slice(0, 10).map(d => d.actual_sales),
                            backgroundColor: 'rgba(37, 99, 235, 0.7)'
                        }, {
                            label: '이익',
                            data: purposeData.slice(0, 10).map(d => d.estimated_profit),
                            backgroundColor: 'rgba(34, 197, 94, 0.7)'
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { callback: v => (v/100000000).toFixed(1) + '억' } } } }
                });
            }

            // 검사목적별 파이 차트
            const purposePieCtx = document.getElementById('profitByPurposePieChart');
            if (purposePieCtx && purposeData) {
                if (profitCharts.purposePie) profitCharts.purposePie.destroy();
                profitCharts.purposePie = new Chart(purposePieCtx, {
                    type: 'doughnut',
                    data: {
                        labels: purposeData.slice(0, 6).map(d => d.purpose),
                        datasets: [{
                            data: purposeData.slice(0, 6).map(d => d.estimated_profit),
                            backgroundColor: ['#2563eb', '#059669', '#f59e0b', '#8b5cf6', '#ec4899', '#64748b']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }

            // 담당자별 차트
            const managerCtx = document.getElementById('profitByManagerChart');
            if (managerCtx && managerData) {
                if (profitCharts.manager) profitCharts.manager.destroy();
                profitCharts.manager = new Chart(managerCtx, {
                    type: 'bar',
                    data: {
                        labels: managerData.slice(0, 10).map(d => d.manager),
                        datasets: [{
                            label: '매출',
                            data: managerData.slice(0, 10).map(d => d.actual_sales),
                            backgroundColor: 'rgba(37, 99, 235, 0.7)'
                        }, {
                            label: '이익',
                            data: managerData.slice(0, 10).map(d => d.estimated_profit),
                            backgroundColor: 'rgba(34, 197, 94, 0.7)'
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { callback: v => (v/100000000).toFixed(1) + '억' } } } }
                });
            }

            // 담당자별 이익률 차트
            const managerRateCtx = document.getElementById('profitByManagerRateChart');
            if (managerRateCtx && managerData) {
                if (profitCharts.managerRate) profitCharts.managerRate.destroy();
                profitCharts.managerRate = new Chart(managerRateCtx, {
                    type: 'bar',
                    data: {
                        labels: managerData.slice(0, 10).map(d => d.manager),
                        datasets: [{
                            label: '이익률 (%)',
                            data: managerData.slice(0, 10).map(d => d.profit_rate),
                            backgroundColor: managerData.slice(0, 10).map(d => d.profit_rate >= 30 ? 'rgba(34, 197, 94, 0.7)' : 'rgba(239, 68, 68, 0.7)')
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { max: 50 } } }
                });
            }

            // 월별 추이 차트
            const monthCtx = document.getElementById('profitMonthlyTrendChart');
            if (monthCtx && monthData) {
                if (profitCharts.month) profitCharts.month.destroy();
                profitCharts.month = new Chart(monthCtx, {
                    type: 'line',
                    data: {
                        labels: monthData.map(d => d.month_name),
                        datasets: [{
                            label: '매출',
                            data: monthData.map(d => d.actual_sales),
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            fill: true,
                            tension: 0.3
                        }, {
                            label: '이익',
                            data: monthData.map(d => d.estimated_profit),
                            borderColor: '#059669',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            fill: true,
                            tension: 0.3
                        }, {
                            label: '원가',
                            data: monthData.map(d => d.estimated_cost),
                            borderColor: '#dc2626',
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.3
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { callback: v => (v/100000000).toFixed(1) + '억' } } } }
                });
            }
        }

        // 초기화
        console.log('[DEBUG] Initializing...');
        loadTokenUsage();
        loadSessionInfo();
        initializeYearSelects();  // 연도 드롭다운 동적 로드
        showToast('조회 버튼을 클릭하세요.', 'loading', 3000);
        console.log('[DEBUG] Main script completed successfully');
    </script>
</body>
</html>

'''

# ============ 인증 관련 라우트 ============
@app.route('/login')
def login_page():
    session_id = request.cookies.get('session_id')
    if verify_user_session(session_id):
        return redirect('/')
    return render_template_string(LOGIN_TEMPLATE)

@app.route('/api/auth/login', methods=['POST'])
def api_login():
    data = request.get_json()
    username = data.get('username', '')
    password = data.get('password', '')

    if not username or not password:
        return jsonify({'success': False, 'error': '아이디와 비밀번호를 입력하세요'})

    password_hash = hashlib.sha256(password.encode()).hexdigest()

    try:
        conn = get_user_db()
        cursor = conn.cursor()
        cursor.execute(
            "SELECT id, username, name, role, status FROM users WHERE username = ? AND password_hash = ?",
            (username, password_hash)
        )
        user = cursor.fetchone()

        if not user:
            conn.close()
            return jsonify({'success': False, 'error': '아이디 또는 비밀번호가 올바르지 않습니다'})

        if user['status'] != 'active':
            conn.close()
            return jsonify({'success': False, 'error': '계정이 정지되었습니다'})

        # 마지막 로그인 시간 업데이트
        cursor.execute("UPDATE users SET last_login = CURRENT_TIMESTAMP WHERE id = ?", (user['id'],))
        conn.commit()
        conn.close()

        # 세션 생성
        session_id = secrets.token_hex(32)
        USER_SESSIONS[session_id] = {
            'user_id': user['id'],
            'username': user['username'],
            'name': user['name'],
            'role': user['role'],
            'login_time': datetime.now(),
            'last_activity': datetime.now()
        }

        # 활동 로그 기록
        log_user_activity(user['id'], 'login', f'로그인 성공', request.remote_addr)

        response = make_response(jsonify({'success': True}))
        response.set_cookie('session_id', session_id, httponly=True, max_age=8*60*60)
        return response

    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})

@app.route('/api/auth/logout')
def api_logout():
    session_id = request.cookies.get('session_id')
    if session_id and session_id in USER_SESSIONS:
        session = USER_SESSIONS[session_id]
        log_user_activity(session['user_id'], 'logout', '로그아웃', request.remote_addr)
        del USER_SESSIONS[session_id]

    response = make_response(redirect('/login'))
    response.delete_cookie('session_id')
    return response

@app.route('/api/auth/change-password', methods=['POST'])
@login_required
def api_change_password():
    """사용자 비밀번호 변경"""
    session_id = request.cookies.get('session_id')
    session = verify_user_session(session_id)

    if not session:
        return jsonify({'success': False, 'error': '로그인이 필요합니다'})

    data = request.get_json()
    current_password = data.get('current_password', '')
    new_password = data.get('new_password', '')
    confirm_password = data.get('confirm_password', '')

    # 유효성 검사
    if not current_password or not new_password or not confirm_password:
        return jsonify({'success': False, 'error': '모든 필드를 입력해주세요'})

    if new_password != confirm_password:
        return jsonify({'success': False, 'error': '새 비밀번호가 일치하지 않습니다'})

    if len(new_password) < 4:
        return jsonify({'success': False, 'error': '비밀번호는 4자 이상이어야 합니다'})

    try:
        conn = get_user_db()
        cursor = conn.cursor()

        # 현재 비밀번호 확인
        current_hash = hashlib.sha256(current_password.encode()).hexdigest()
        cursor.execute(
            "SELECT id FROM users WHERE id = ? AND password_hash = ?",
            (session['user_id'], current_hash)
        )
        user = cursor.fetchone()

        if not user:
            conn.close()
            return jsonify({'success': False, 'error': '현재 비밀번호가 올바르지 않습니다'})

        # 새 비밀번호로 업데이트
        new_hash = hashlib.sha256(new_password.encode()).hexdigest()
        cursor.execute(
            "UPDATE users SET password_hash = ? WHERE id = ?",
            (new_hash, session['user_id'])
        )
        conn.commit()
        conn.close()

        # 활동 로그 기록
        log_user_activity(session['user_id'], 'change_password', '비밀번호 변경', request.remote_addr)

        return jsonify({'success': True, 'message': '비밀번호가 성공적으로 변경되었습니다'})

    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})

@app.route('/api/auth/session')
def api_session():
    session_id = request.cookies.get('session_id')
    session = verify_user_session(session_id)
    if session:
        return jsonify({
            'logged_in': True,
            'user': {
                'username': session['username'],
                'name': session.get('name'),
                'role': session['role']
            }
        })
    return jsonify({'logged_in': False})

@app.route('/admin')
@admin_required
def admin_page():
    return render_template_string(ADMIN_TEMPLATE)

@app.route('/api/admin/users', methods=['GET', 'POST'])
@admin_required
def api_admin_users():
    if request.method == 'GET':
        conn = get_user_db()
        cursor = conn.cursor()
        cursor.execute('''
            SELECT u.id, u.username, u.name, u.email, u.team_id, u.role, u.status, u.last_login,
                   t.name as team_name
            FROM users u
            LEFT JOIN teams t ON u.team_id = t.id
            ORDER BY u.id
        ''')
        users = [dict(row) for row in cursor.fetchall()]
        conn.close()
        return jsonify({'users': users})

    elif request.method == 'POST':
        data = request.get_json()
        username = data.get('username', '').strip()
        name = data.get('name', '').strip()
        password = data.get('password', '')
        email = data.get('email', '').strip()
        team_id = data.get('team_id')
        role = data.get('role', 'user')

        if not username or not password:
            return jsonify({'success': False, 'error': '필수 항목을 입력하세요'})

        password_hash = hashlib.sha256(password.encode()).hexdigest()

        try:
            conn = get_user_db()
            cursor = conn.cursor()
            cursor.execute(
                "INSERT INTO users (username, password_hash, name, email, team_id, role) VALUES (?, ?, ?, ?, ?, ?)",
                (username, password_hash, name, email, team_id, role)
            )
            conn.commit()
            conn.close()
            return jsonify({'success': True})
        except sqlite3.IntegrityError:
            return jsonify({'success': False, 'error': '이미 존재하는 사용자명입니다'})

@app.route('/api/admin/users/<int:user_id>/status', methods=['PUT'])
@admin_required
def api_admin_user_status(user_id):
    data = request.get_json()
    status = data.get('status', 'active')

    conn = get_user_db()
    cursor = conn.cursor()
    cursor.execute("UPDATE users SET status = ? WHERE id = ?", (status, user_id))
    conn.commit()
    conn.close()
    return jsonify({'success': True})

@app.route('/api/admin/users/<int:user_id>', methods=['DELETE'])
@admin_required
def api_admin_delete_user(user_id):
    conn = get_user_db()
    cursor = conn.cursor()
    cursor.execute("DELETE FROM users WHERE id = ?", (user_id,))
    conn.commit()
    conn.close()
    return jsonify({'success': True})

@app.route('/api/admin/activity')
@admin_required
def api_admin_activity():
    from datetime import timezone, timedelta
    KST = timezone(timedelta(hours=9))

    conn = get_user_db()
    cursor = conn.cursor()
    cursor.execute('''
        SELECT a.*, u.username FROM user_activity a
        LEFT JOIN users u ON a.user_id = u.id
        ORDER BY a.created_at DESC LIMIT 100
    ''')
    activities = []
    for row in cursor.fetchall():
        activity = dict(row)
        # UTC -> KST 변환
        if activity.get('created_at'):
            try:
                utc_time = datetime.strptime(activity['created_at'], '%Y-%m-%d %H:%M:%S')
                kst_time = utc_time.replace(tzinfo=timezone.utc).astimezone(KST)
                activity['created_at'] = kst_time.strftime('%Y-%m-%d %H:%M:%S')
            except:
                pass
        activities.append(activity)
    conn.close()
    return jsonify({'activities': activities})

@app.route('/api/admin/ai-logs')
@admin_required
def api_admin_ai_logs():
    from datetime import timezone, timedelta
    KST = timezone(timedelta(hours=9))

    conn = get_user_db()
    cursor = conn.cursor()
    cursor.execute('''
        SELECT l.*, u.username FROM ai_logs l
        LEFT JOIN users u ON l.user_id = u.id
        ORDER BY l.created_at DESC LIMIT 100
    ''')
    logs = []
    for row in cursor.fetchall():
        log = dict(row)
        # UTC -> KST 변환
        if log.get('created_at'):
            try:
                utc_time = datetime.strptime(log['created_at'], '%Y-%m-%d %H:%M:%S')
                kst_time = utc_time.replace(tzinfo=timezone.utc).astimezone(KST)
                log['created_at'] = kst_time.strftime('%Y-%m-%d %H:%M:%S')
            except:
                pass
        logs.append(log)
    conn.close()
    return jsonify({'logs': logs})

@app.route('/api/admin/users/<int:user_id>', methods=['PUT'])
@admin_required
def api_admin_update_user(user_id):
    """사용자 정보 수정"""
    data = request.get_json()
    conn = get_user_db()
    cursor = conn.cursor()

    updates = []
    params = []

    if data.get('name'):
        updates.append('name = ?')
        params.append(data['name'])
    if data.get('email'):
        updates.append('email = ?')
        params.append(data['email'])
    if data.get('team_id'):
        updates.append('team_id = ?')
        params.append(data['team_id'])
    if data.get('role'):
        updates.append('role = ?')
        params.append(data['role'])
    if data.get('password'):
        updates.append('password_hash = ?')
        params.append(hashlib.sha256(data['password'].encode()).hexdigest())

    if updates:
        params.append(user_id)
        cursor.execute(f"UPDATE users SET {', '.join(updates)} WHERE id = ?", params)
        conn.commit()

    conn.close()
    return jsonify({'success': True})

@app.route('/api/admin/users/<int:user_id>/reset-password', methods=['POST'])
@admin_required
def api_admin_reset_password(user_id):
    """비밀번호 초기화"""
    new_password = hashlib.sha256("1234".encode()).hexdigest()
    conn = get_user_db()
    cursor = conn.cursor()
    cursor.execute("UPDATE users SET password_hash = ? WHERE id = ?", (new_password, user_id))
    conn.commit()
    conn.close()
    return jsonify({'success': True})

@app.route('/api/purposes')
@login_required
def api_purposes():
    """검사목적 목록 반환"""
    try:
        summary = get_ai_summary_data()
        purposes = summary.get('filter_values', {}).get('purposes', [])
        # 접수취소 제외
        purposes = [p for p in purposes if p != '접수취소']
        return jsonify({'purposes': purposes})
    except Exception as e:
        return jsonify({'purposes': [], 'error': str(e)})

@app.route('/api/available-years')
@login_required
def api_available_years():
    """DB와 데이터 폴더에서 사용 가능한 연도 목록 반환"""
    try:
        years_set = set()

        # 1. DB에서 연도 조회
        try:
            conn = sqlite3.connect(str(SQLITE_DB))
            cursor = conn.cursor()
            cursor.execute('SELECT DISTINCT year FROM excel_data ORDER BY year DESC')
            db_years = [int(row[0]) for row in cursor.fetchall()]  # 정수로 변환
            years_set.update(db_years)
            conn.close()
        except:
            pass

        # 2. 데이터 폴더에서 연도 조회 (data/2024, data/2025, data/2026 등)
        try:
            for item in DATA_DIR.iterdir():
                if item.is_dir() and item.name.isdigit():
                    year = int(item.name)
                    # 2020~2030 범위의 연도만 인식
                    if 2020 <= year <= 2030:
                        years_set.add(year)
        except:
            pass

        # 내림차순 정렬
        years = sorted(list(years_set), reverse=True)

        # 연도가 없으면 기본값
        if not years:
            years = [2025, 2024]

        return jsonify({'years': years})
    except Exception as e:
        return jsonify({'years': [2025, 2024], 'error': str(e)})

@app.route('/api/admin/teams', methods=['GET', 'POST'])
@admin_required
def api_admin_teams():
    """팀 목록/추가"""
    conn = get_user_db()
    cursor = conn.cursor()

    if request.method == 'GET':
        cursor.execute("SELECT * FROM teams ORDER BY id")
        teams = [dict(row) for row in cursor.fetchall()]
        conn.close()
        return jsonify({'teams': teams})

    elif request.method == 'POST':
        data = request.get_json()
        cursor.execute(
            "INSERT INTO teams (name, category, parent_id, track_details) VALUES (?, ?, ?, ?)",
            (data.get('name'), data.get('category'), data.get('parent_id'), data.get('track_details', 0))
        )
        conn.commit()
        conn.close()
        return jsonify({'success': True})

@app.route('/api/admin/teams/<int:team_id>/members')
@admin_required
def api_admin_team_members(team_id):
    """팀별 팀원 목록"""
    conn = get_user_db()
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM team_members WHERE team_id = ? AND is_active = 1 ORDER BY name", (team_id,))
    members = [dict(row) for row in cursor.fetchall()]
    conn.close()
    return jsonify({'members': members})

@app.route('/api/admin/team-members', methods=['POST'])
@admin_required
def api_admin_team_members_create():
    """팀원 추가"""
    conn = get_user_db()
    cursor = conn.cursor()
    data = request.get_json()
    cursor.execute('''
        INSERT INTO team_members (team_id, name, position, duties, region, hire_year, phone, email, notes)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
    ''', (
        data.get('team_id'),
        data.get('name'),
        data.get('position'),
        data.get('duties'),
        data.get('region'),
        data.get('hire_year'),
        data.get('phone'),
        data.get('email'),
        data.get('notes')
    ))
    conn.commit()
    conn.close()
    return jsonify({'success': True})

@app.route('/api/admin/team-members/<int:member_id>', methods=['GET', 'PUT', 'DELETE'])
@admin_required
def api_admin_team_member(member_id):
    """팀원 조회/수정/삭제"""
    conn = get_user_db()
    cursor = conn.cursor()

    if request.method == 'GET':
        cursor.execute("SELECT * FROM team_members WHERE id = ?", (member_id,))
        row = cursor.fetchone()
        conn.close()
        return jsonify({'member': dict(row) if row else None})

    elif request.method == 'PUT':
        data = request.get_json()
        cursor.execute('''
            UPDATE team_members SET
                name = ?, position = ?, duties = ?, region = ?,
                hire_year = ?, phone = ?, email = ?, notes = ?
            WHERE id = ?
        ''', (
            data.get('name'),
            data.get('position'),
            data.get('duties'),
            data.get('region'),
            data.get('hire_year'),
            data.get('phone'),
            data.get('email'),
            data.get('notes'),
            member_id
        ))
        conn.commit()
        conn.close()
        return jsonify({'success': True})

    elif request.method == 'DELETE':
        cursor.execute("UPDATE team_members SET is_active = 0 WHERE id = ?", (member_id,))
        conn.commit()
        conn.close()
        return jsonify({'success': True})

@app.route('/api/admin/goals', methods=['GET', 'POST'])
@admin_required
def api_admin_goals():
    """목표 목록/추가"""
    conn = get_user_db()
    cursor = conn.cursor()

    if request.method == 'GET':
        year = request.args.get('year', '2025')
        purpose = request.args.get('purpose', '전체')
        goal_type = request.args.get('type', 'overall')

        query = '''
            SELECT g.*,
                   CASE WHEN g.goal_type = 'team' THEN t.name
                        WHEN g.goal_type = 'individual' THEN u.name
                        ELSE '전체' END as target_name
            FROM goals g
            LEFT JOIN teams t ON g.goal_type = 'team' AND g.target_id = t.id
            LEFT JOIN users u ON g.goal_type = 'individual' AND g.target_id = u.id
            WHERE g.year = ?
        '''
        params = [year]

        if purpose != '전체':
            query += ' AND g.inspection_purpose = ?'
            params.append(purpose)

        if goal_type != 'all':
            query += ' AND g.goal_type = ?'
            params.append(goal_type)

        query += ' ORDER BY g.id DESC'
        cursor.execute(query, params)
        goals = [dict(row) for row in cursor.fetchall()]
        conn.close()
        return jsonify({'goals': goals})

    elif request.method == 'POST':
        data = request.get_json()
        cursor.execute('''
            INSERT INTO goals (year, month, goal_type, target_id, inspection_purpose, target_sales, target_count)
            VALUES (?, ?, ?, ?, ?, ?, ?)
        ''', (
            data.get('year'),
            data.get('month'),
            data.get('goal_type'),
            data.get('target_id'),
            data.get('inspection_purpose'),
            data.get('target_sales', 0),
            data.get('target_count', 0)
        ))
        conn.commit()
        conn.close()
        return jsonify({'success': True})

@app.route('/api/admin/goals/<int:goal_id>', methods=['PUT', 'DELETE'])
@admin_required
def api_admin_goal(goal_id):
    """목표 수정/삭제"""
    conn = get_user_db()
    cursor = conn.cursor()

    if request.method == 'DELETE':
        cursor.execute("DELETE FROM goals WHERE id = ?", (goal_id,))
        conn.commit()
        conn.close()
        return jsonify({'success': True})

    elif request.method == 'PUT':
        data = request.get_json()
        cursor.execute('''
            UPDATE goals SET target_sales = ?, target_count = ?, inspection_purpose = ?, updated_at = CURRENT_TIMESTAMP
            WHERE id = ?
        ''', (data.get('target_sales'), data.get('target_count'), data.get('inspection_purpose'), goal_id))
        conn.commit()
        conn.close()
        return jsonify({'success': True})

@app.route('/api/admin/permission-groups', methods=['GET', 'POST'])
@admin_required
def api_admin_permission_groups():
    """권한 그룹 목록/추가"""
    conn = get_user_db()
    cursor = conn.cursor()

    if request.method == 'GET':
        cursor.execute("SELECT * FROM permission_groups ORDER BY id")
        groups = [dict(row) for row in cursor.fetchall()]
        conn.close()
        return jsonify({'groups': groups})

    elif request.method == 'POST':
        data = request.get_json()
        cursor.execute(
            "INSERT INTO permission_groups (name, description) VALUES (?, ?)",
            (data.get('name'), data.get('description'))
        )
        conn.commit()
        conn.close()
        return jsonify({'success': True})

@app.route('/api/log-menu', methods=['POST'])
@login_required
def api_log_menu():
    """메뉴 접근 로깅 API"""
    session_id = request.cookies.get('session_id')
    session = verify_user_session(session_id)
    if not session:
        return jsonify({'error': '로그인 필요'}), 401

    menu_name = request.json.get('menu', '')
    if menu_name:
        log_menu_access(session.get('user_id'), menu_name)
    return jsonify({'success': True})

@app.route('/api/admin/menu-logs')
@admin_required
def api_admin_menu_logs():
    """메뉴 접근 로그"""
    from datetime import timezone, timedelta
    KST = timezone(timedelta(hours=9))

    # 메뉴명 한글 매핑
    menu_names_kr = {
        'main': '대시보드', '대시보드': '대시보드',
        'monthlySales': '월별매출', '월별매출': '월별매출',
        'sampleType': '검체유형', '검체유형': '검체유형',
        'branchChart': '지역별', '지역별': '지역별',
        'clientAnalysis': '업체분석', '업체분석': '업체분석',
        'defectAnalysis': '부적합분석', '부적합분석': '부적합분석',
        'livestockTab': '축산물분석', '축산물분석': '축산물분석',
        'collectionTab': '수금현황', '수금현황': '수금현황',
        'aiAnalysis': 'AI분석', 'AI분석': 'AI분석',
        'foodItem': '검사항목', 'purpose': '검사목적', 'team': '팀별',
        'monthly': '월별', 'personal': '개인별'
    }

    conn = get_user_db()
    cursor = conn.cursor()
    cursor.execute('''
        SELECT m.*, u.username, u.name as user_name FROM menu_logs m
        LEFT JOIN users u ON m.user_id = u.id
        ORDER BY m.created_at DESC LIMIT 100
    ''')
    logs = []
    for row in cursor.fetchall():
        log = dict(row)
        # 메뉴명 한글 변환
        log['menu_name_kr'] = menu_names_kr.get(log.get('menu_name', ''), log.get('menu_name', ''))
        # 사용자명 (이름 우선, 없으면 username)
        log['display_name'] = log.get('user_name') or log.get('username') or '알 수 없음'
        # UTC -> KST 변환 (진입시간)
        if log.get('created_at'):
            try:
                utc_time = datetime.strptime(log['created_at'], '%Y-%m-%d %H:%M:%S')
                kst_time = utc_time.replace(tzinfo=timezone.utc).astimezone(KST)
                log['entry_time'] = kst_time.strftime('%Y-%m-%d %H:%M:%S')
            except:
                log['entry_time'] = log['created_at']
        # UTC -> KST 변환 (종료시간)
        if log.get('exit_at'):
            try:
                utc_time = datetime.strptime(log['exit_at'], '%Y-%m-%d %H:%M:%S')
                kst_time = utc_time.replace(tzinfo=timezone.utc).astimezone(KST)
                log['exit_time'] = kst_time.strftime('%Y-%m-%d %H:%M:%S')
            except:
                log['exit_time'] = log['exit_at']
        else:
            log['exit_time'] = '-'
        logs.append(log)
    conn.close()
    return jsonify({'logs': logs})

@app.route('/api/admin/download-logs')
@admin_required
def api_admin_download_logs():
    """다운로드 로그"""
    conn = get_user_db()
    cursor = conn.cursor()
    cursor.execute('''
        SELECT d.*, u.username FROM download_logs d
        LEFT JOIN users u ON d.user_id = u.id
        ORDER BY d.created_at DESC LIMIT 100
    ''')
    logs = [dict(row) for row in cursor.fetchall()]
    conn.close()
    return jsonify({'logs': logs})

# ============ 원가 관리 API ============
@app.route('/api/admin/cost-data')
@admin_required
def api_admin_cost_data():
    """원가 데이터 조회"""
    data = get_cost_data()
    return jsonify({'success': True, 'data': data, 'count': len(data)})

@app.route('/api/admin/cost-data/reload', methods=['POST'])
@admin_required
def api_admin_reload_cost_data():
    """원가 데이터 엑셀에서 다시 로드"""
    result = load_cost_data_from_excel()
    return jsonify(result)

@app.route('/api/admin/cost-mapping')
@admin_required
def api_admin_cost_mapping():
    """원가-매출 매핑 목록 조회"""
    conn = get_user_db()
    cursor = conn.cursor()
    cursor.execute('SELECT * FROM cost_mapping ORDER BY cost_item_name')
    mappings = [dict(row) for row in cursor.fetchall()]
    conn.close()
    return jsonify({'success': True, 'mappings': mappings})

@app.route('/api/admin/cost-mapping', methods=['POST'])
@admin_required
def api_admin_add_cost_mapping():
    """원가-매출 매핑 추가"""
    cost_item = request.json.get('cost_item_name', '').strip()
    sales_item = request.json.get('sales_item_name', '').strip()
    group_name = request.json.get('group_name', '').strip() or None

    if not cost_item or not sales_item:
        return jsonify({'success': False, 'error': '항목명을 입력하세요'})

    try:
        conn = get_user_db()
        cursor = conn.cursor()
        cursor.execute('''
            INSERT OR REPLACE INTO cost_mapping (cost_item_name, sales_item_name, group_name)
            VALUES (?, ?, ?)
        ''', (cost_item, sales_item, group_name))
        conn.commit()
        conn.close()
        return jsonify({'success': True})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})

@app.route('/api/admin/cost-mapping/batch', methods=['POST'])
@admin_required
def api_admin_batch_cost_mapping():
    """원가-매출 일괄 매핑 (그룹)"""
    cost_item = request.json.get('cost_item_name', '').strip()
    sales_items = request.json.get('sales_item_names', [])
    group_name = request.json.get('group_name', '').strip()

    if not cost_item or not sales_items:
        return jsonify({'success': False, 'error': '원가 항목과 매출 항목을 선택하세요'})

    if not group_name:
        group_name = f"그룹_{cost_item}"

    try:
        conn = get_user_db()
        cursor = conn.cursor()
        count = 0
        for sales_item in sales_items:
            sales_item = sales_item.strip()
            if sales_item:
                cursor.execute('''
                    INSERT OR REPLACE INTO cost_mapping (cost_item_name, sales_item_name, group_name)
                    VALUES (?, ?, ?)
                ''', (cost_item, sales_item, group_name))
                count += 1
        conn.commit()
        conn.close()
        return jsonify({'success': True, 'count': count, 'group_name': group_name})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})

@app.route('/api/admin/cost-mapping/<int:mapping_id>', methods=['DELETE'])
@admin_required
def api_admin_delete_cost_mapping(mapping_id):
    """원가-매출 매핑 삭제"""
    conn = get_user_db()
    cursor = conn.cursor()
    cursor.execute('DELETE FROM cost_mapping WHERE id = ?', (mapping_id,))
    conn.commit()
    conn.close()
    return jsonify({'success': True})

@app.route('/api/cost/profit-analysis')
@login_required
def api_cost_profit_analysis():
    """손익 분석 API"""
    year = request.args.get('year', '2025')

    # 매출 데이터 로드
    sales_data = load_food_item_data(year)

    # 항목별 매출 집계
    item_sales = {}
    for row in sales_data:
        item_name = str(row.get('항목명', '')).strip()
        fee = row.get('항목수수료', 0) or 0
        if isinstance(fee, str):
            fee = float(fee.replace(',', '').replace('원', '')) if fee else 0

        if item_name:
            if item_name not in item_sales:
                item_sales[item_name] = {'count': 0, 'revenue': 0}
            item_sales[item_name]['count'] += 1
            item_sales[item_name]['revenue'] += fee

    # 원가 데이터와 매칭하여 손익 계산
    profit_data = []
    total_revenue = 0
    total_cost = 0
    matched_count = 0

    for item_name, sales in item_sales.items():
        cost_info = get_cost_by_item_name(item_name)

        if cost_info:
            unit_cost = cost_info.get('total_cost', 0)
            total_item_cost = unit_cost * sales['count']
            profit = sales['revenue'] - total_item_cost
            profit_rate = (profit / sales['revenue'] * 100) if sales['revenue'] > 0 else 0

            profit_data.append({
                'item_name': item_name,
                'count': sales['count'],
                'revenue': sales['revenue'],
                'unit_cost': unit_cost,
                'total_cost': total_item_cost,
                'profit': profit,
                'profit_rate': round(profit_rate, 1),
                'matched': True
            })

            total_revenue += sales['revenue']
            total_cost += total_item_cost
            matched_count += 1
        else:
            profit_data.append({
                'item_name': item_name,
                'count': sales['count'],
                'revenue': sales['revenue'],
                'unit_cost': 0,
                'total_cost': 0,
                'profit': sales['revenue'],
                'profit_rate': 100,
                'matched': False
            })
            total_revenue += sales['revenue']

    # 정렬 (매출액 기준 내림차순)
    profit_data.sort(key=lambda x: x['revenue'], reverse=True)

    return jsonify({
        'success': True,
        'year': year,
        'summary': {
            'total_revenue': total_revenue,
            'total_cost': total_cost,
            'total_profit': total_revenue - total_cost,
            'profit_rate': round((total_revenue - total_cost) / total_revenue * 100, 1) if total_revenue > 0 else 0,
            'total_items': len(item_sales),
            'matched_items': matched_count,
            'match_rate': round(matched_count / len(item_sales) * 100, 1) if item_sales else 0
        },
        'data': profit_data[:100]  # 상위 100개만
    })

# ============ 손익분석 (메인 대시보드용) ============
COST_RATE = 0.697  # 원가율 69.7%

def get_financial_settings(year):
    """손익계산서 설정 데이터 조회"""
    try:
        conn = get_user_db()
        cursor = conn.cursor()
        cursor.execute('SELECT * FROM financial_settings WHERE year = ?', (int(year),))
        row = cursor.fetchone()
        conn.close()
        if row:
            return dict(row)
        return None
    except Exception as e:
        print(f"[ERROR] get_financial_settings: {e}")
        return None

@app.route('/api/profit/summary')
@login_required
def api_profit_summary():
    """손익 요약 API - 실제 매출 데이터 + 원가율/판관비율 적용"""
    year = request.args.get('year', '2025')

    # 1. 실제 매출 데이터 가져오기 (Excel 데이터에서)
    data = load_excel_data(year)

    total_sales = 0  # 실제 매출액 (공급가액 합계)
    for row in data:
        fee = row.get('공급가액', 0) or 0
        if isinstance(fee, str):
            fee = float(fee.replace(',', '').replace('원', '')) if fee else 0
        total_sales += fee

    # 2. 원가율/판관비율 가져오기 (financial_settings에서)
    fin_settings = get_financial_settings(year)

    if fin_settings:
        cost_rate = fin_settings.get('cost_rate', 69.7) / 100  # % -> 비율
        sga_rate = fin_settings.get('sga_rate', 58.4) / 100
        non_operating = fin_settings.get('non_operating_income', 0)
    else:
        cost_rate = COST_RATE  # 기본값 69.7%
        sga_rate = 0.584  # 기본값 58.4%
        non_operating = 0

    # 3. 손익 계산 (실제 매출 × 비율)
    cost_of_sales = total_sales * cost_rate  # 매출원가
    gross_profit = total_sales - cost_of_sales  # 매출총이익
    sga_expense = total_sales * sga_rate  # 판관비
    operating_profit = gross_profit - sga_expense  # 영업이익
    net_profit = operating_profit + non_operating  # 세전이익

    profit_rate = (operating_profit / total_sales * 100) if total_sales > 0 else 0
    gross_margin = (gross_profit / total_sales * 100) if total_sales > 0 else 0

    return jsonify({
        'success': True,
        'year': year,
        'source': 'excel_data',
        'data_count': len(data),
        'total_actual_sales': total_sales,
        'cost_of_sales': cost_of_sales,
        'gross_profit': gross_profit,
        'sga_expense': sga_expense,
        'operating_profit': operating_profit,
        'non_operating_income': non_operating,
        'net_profit': net_profit,
        'estimated_cost': cost_of_sales,
        'estimated_profit': operating_profit,
        'profit_rate': round(profit_rate, 1),
        'gross_margin': round(gross_margin, 1),
        'cost_rate': round(cost_rate * 100, 1),
        'sga_rate': round(sga_rate * 100, 1),
        'discount_rate': 0,
        'total_normal_price': total_sales
    })

@app.route('/api/profit/by-purpose')
@login_required
def api_profit_by_purpose():
    """검사목적별 손익 분석 - 실제 매출 + 원가율/판관비율 적용"""
    year = request.args.get('year', '2025')
    data = load_excel_data(year)

    # 원가율/판관비율 가져오기
    fin_settings = get_financial_settings(year)
    if fin_settings:
        cost_rate = fin_settings.get('cost_rate', 69.7) / 100
        sga_rate = fin_settings.get('sga_rate', 58.4) / 100
    else:
        cost_rate = COST_RATE
        sga_rate = 0.584

    purpose_stats = {}
    for row in data:
        purpose = str(row.get('검사목적', '기타')).strip() or '기타'

        if purpose not in purpose_stats:
            purpose_stats[purpose] = {'count': 0, 'sales': 0}

        purpose_stats[purpose]['count'] += 1

        # 공급가액 사용
        fee = row.get('공급가액', 0) or 0
        if isinstance(fee, str):
            fee = float(fee.replace(',', '').replace('원', '')) if fee else 0
        purpose_stats[purpose]['sales'] += fee

    result = []
    for purpose, stats in purpose_stats.items():
        sales = stats['sales']
        cost_of_sales = sales * cost_rate
        sga_expense = sales * sga_rate
        operating_profit = sales - cost_of_sales - sga_expense
        profit_rate = (operating_profit / sales * 100) if sales > 0 else 0

        result.append({
            'purpose': purpose,
            'count': stats['count'],
            'actual_sales': sales,
            'cost_of_sales': cost_of_sales,
            'sga_expense': sga_expense,
            'estimated_cost': cost_of_sales + sga_expense,
            'estimated_profit': operating_profit,
            'profit_rate': round(profit_rate, 1)
        })

    result.sort(key=lambda x: x['actual_sales'], reverse=True)
    return jsonify({'success': True, 'data': result})

@app.route('/api/profit/by-manager')
@login_required
def api_profit_by_manager():
    """담당자별 손익 분석 - 실제 매출 + 원가율/판관비율 적용"""
    year = request.args.get('year', '2025')
    data = load_excel_data(year)

    # 원가율/판관비율 가져오기
    fin_settings = get_financial_settings(year)
    if fin_settings:
        cost_rate = fin_settings.get('cost_rate', 69.7) / 100
        sga_rate = fin_settings.get('sga_rate', 58.4) / 100
    else:
        cost_rate = COST_RATE
        sga_rate = 0.584

    manager_stats = {}
    for row in data:
        manager = str(row.get('영업담당', '미지정')).strip() or '미지정'

        if manager not in manager_stats:
            manager_stats[manager] = {'count': 0, 'sales': 0}

        manager_stats[manager]['count'] += 1

        # 공급가액 사용
        fee = row.get('공급가액', 0) or 0
        if isinstance(fee, str):
            fee = float(fee.replace(',', '').replace('원', '')) if fee else 0
        manager_stats[manager]['sales'] += fee

    result = []
    for manager, stats in manager_stats.items():
        sales = stats['sales']
        cost_of_sales = sales * cost_rate
        sga_expense = sales * sga_rate
        operating_profit = sales - cost_of_sales - sga_expense
        profit_rate = (operating_profit / sales * 100) if sales > 0 else 0

        result.append({
            'manager': manager,
            'count': stats['count'],
            'actual_sales': sales,
            'cost_of_sales': cost_of_sales,
            'sga_expense': sga_expense,
            'estimated_cost': cost_of_sales + sga_expense,
            'estimated_profit': operating_profit,
            'profit_rate': round(profit_rate, 1)
        })

    result.sort(key=lambda x: x['actual_sales'], reverse=True)
    return jsonify({'success': True, 'data': result})

@app.route('/api/profit/by-month')
@login_required
def api_profit_by_month():
    """월별 손익 분석 - 실제 매출 + 원가율/판관비율 적용"""
    year = request.args.get('year', '2025')
    data = load_excel_data(year)

    # 원가율/판관비율 가져오기
    fin_settings = get_financial_settings(year)
    if fin_settings:
        cost_rate = fin_settings.get('cost_rate', 69.7) / 100
        sga_rate = fin_settings.get('sga_rate', 58.4) / 100
    else:
        cost_rate = COST_RATE
        sga_rate = 0.584

    month_stats = {m: {'count': 0, 'sales': 0} for m in range(1, 13)}

    for row in data:
        date_str = row.get('접수일자', '')
        if not date_str:
            continue
        try:
            if isinstance(date_str, str):
                month = int(date_str.split('-')[1]) if '-' in date_str else int(date_str.split('/')[1])
            else:
                month = date_str.month
        except:
            continue

        if 1 <= month <= 12:
            month_stats[month]['count'] += 1

            # 공급가액 사용
            fee = row.get('공급가액', 0) or 0
            if isinstance(fee, str):
                fee = float(fee.replace(',', '').replace('원', '')) if fee else 0
            month_stats[month]['sales'] += fee

    result = []
    for month in range(1, 13):
        stats = month_stats[month]
        sales = stats['sales']
        cost_of_sales = sales * cost_rate
        sga_expense = sales * sga_rate
        operating_profit = sales - cost_of_sales - sga_expense
        profit_rate = (operating_profit / sales * 100) if sales > 0 else 0

        result.append({
            'month': month,
            'month_name': f'{month}월',
            'count': stats['count'],
            'actual_sales': sales,
            'cost_of_sales': cost_of_sales,
            'sga_expense': sga_expense,
            'estimated_cost': cost_of_sales + sga_expense,
            'estimated_profit': operating_profit,
            'profit_rate': round(profit_rate, 1)
        })

    return jsonify({'success': True, 'data': result})

# ============ 손익계산서 설정 API ============
@app.route('/api/admin/financial-settings')
@admin_required
def api_admin_get_financial_settings():
    """손익계산서 설정 조회"""
    year = request.args.get('year', 2025, type=int)

    conn = get_user_db()
    cursor = conn.cursor()

    # 설정 조회
    cursor.execute('SELECT * FROM financial_settings WHERE year = ?', (year,))
    row = cursor.fetchone()
    settings = dict(row) if row else None

    # 세부 항목 조회
    cursor.execute('SELECT * FROM financial_details WHERE year = ? ORDER BY category, item_name', (year,))
    details = [dict(r) for r in cursor.fetchall()]

    conn.close()

    return jsonify({
        'success': True,
        'year': year,
        'settings': settings,
        'details': details
    })

@app.route('/api/admin/financial-settings', methods=['POST'])
@admin_required
def api_admin_save_financial_settings():
    """손익계산서 설정 저장"""
    data = request.json
    year = data.get('year', 2025)

    try:
        conn = get_user_db()
        cursor = conn.cursor()

        # 기존 설정 업데이트 또는 삽입
        cursor.execute('SELECT id FROM financial_settings WHERE year = ?', (year,))
        existing = cursor.fetchone()

        if existing:
            cursor.execute('''
                UPDATE financial_settings SET
                    revenue = ?,
                    cost_of_sales = ?,
                    sga_expense = ?,
                    non_operating_income = ?,
                    cost_rate = ?,
                    sga_rate = ?,
                    notes = ?,
                    updated_at = CURRENT_TIMESTAMP
                WHERE year = ?
            ''', (
                data.get('revenue', 0),
                data.get('cost_of_sales', 0),
                data.get('sga_expense', 0),
                data.get('non_operating_income', 0),
                data.get('cost_rate', 0),
                data.get('sga_rate', 0),
                data.get('notes', ''),
                year
            ))
        else:
            cursor.execute('''
                INSERT INTO financial_settings
                (year, revenue, cost_of_sales, sga_expense, non_operating_income, cost_rate, sga_rate, notes)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?)
            ''', (
                year,
                data.get('revenue', 0),
                data.get('cost_of_sales', 0),
                data.get('sga_expense', 0),
                data.get('non_operating_income', 0),
                data.get('cost_rate', 0),
                data.get('sga_rate', 0),
                data.get('notes', '')
            ))

        # 세부 항목 저장 (기존 삭제 후 다시 삽입)
        cursor.execute('DELETE FROM financial_details WHERE year = ?', (year,))

        details = data.get('details', [])
        for detail in details:
            if detail.get('item_name'):  # 항목명이 있는 경우만
                cursor.execute('''
                    INSERT INTO financial_details (year, category, item_name, amount)
                    VALUES (?, ?, ?, ?)
                ''', (
                    year,
                    detail.get('category', '원가'),
                    detail.get('item_name', ''),
                    detail.get('amount', 0)
                ))

        conn.commit()
        conn.close()

        # COST_RATE 글로벌 변수 업데이트 (해당 연도가 현재 연도인 경우)
        global COST_RATE
        if year == 2025:
            new_rate = data.get('cost_rate', 69.7)
            COST_RATE = new_rate / 100

        return jsonify({'success': True, 'message': '손익계산서 설정이 저장되었습니다.'})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})

# ============ 사용자 탭 권한 API ============
@app.route('/api/admin/user-tab-permissions')
@admin_required
def api_admin_get_user_tab_permissions():
    """사용자별 탭 접근 권한 조회"""
    user_id = request.args.get('user_id', type=int)

    if not user_id:
        return jsonify({'success': False, 'error': '사용자 ID가 필요합니다'})

    conn = get_user_db()
    cursor = conn.cursor()

    # 사용자 정보 조회 (관리자 여부)
    cursor.execute('SELECT role FROM users WHERE id = ?', (user_id,))
    user = cursor.fetchone()
    is_admin = user['role'] == 'admin' if user else False

    # 탭 권한 조회
    cursor.execute('SELECT tab_name, can_access FROM user_tab_permissions WHERE user_id = ?', (user_id,))
    rows = cursor.fetchall()

    permissions = {}
    for row in rows:
        permissions[row['tab_name']] = bool(row['can_access'])

    conn.close()

    return jsonify({
        'success': True,
        'user_id': user_id,
        'is_admin': is_admin,
        'permissions': permissions
    })

@app.route('/api/admin/user-tab-permissions', methods=['POST'])
@admin_required
def api_admin_save_user_tab_permissions():
    """사용자별 탭 접근 권한 저장"""
    data = request.json
    user_id = data.get('user_id')
    permissions = data.get('permissions', {})
    is_admin = data.get('is_admin', False)

    if not user_id:
        return jsonify({'success': False, 'error': '사용자 ID가 필요합니다'})

    try:
        conn = get_user_db()
        cursor = conn.cursor()

        # 관리자 역할 업데이트
        new_role = 'admin' if is_admin else 'user'
        cursor.execute('UPDATE users SET role = ? WHERE id = ?', (new_role, user_id))

        # 기존 권한 삭제
        cursor.execute('DELETE FROM user_tab_permissions WHERE user_id = ?', (user_id,))

        # 새 권한 삽입
        for tab_name, can_access in permissions.items():
            cursor.execute('''
                INSERT INTO user_tab_permissions (user_id, tab_name, can_access)
                VALUES (?, ?, ?)
            ''', (user_id, tab_name, 1 if can_access else 0))

        conn.commit()
        conn.close()

        return jsonify({'success': True, 'message': '권한이 저장되었습니다.'})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})

# ============ 메인 페이지 ============
@app.route('/')
@login_required
def index():
    return render_template_string(HTML_TEMPLATE)

def filter_data_by_date(data, year, month=None, day=None, end_year=None, end_month=None, end_day=None):
    """날짜 조건으로 데이터 필터링"""
    from datetime import datetime, date

    filtered = []
    year = int(year)
    month = int(month) if month else None
    day = int(day) if day else None
    end_year = int(end_year) if end_year else None
    end_month = int(end_month) if end_month else None
    end_day = int(end_day) if end_day else None

    # 범위 모드인 경우
    if end_year:
        # 시작 날짜 결정
        if month and day:
            start_date = date(year, month, day)
        elif month:
            start_date = date(year, month, 1)
        else:
            start_date = date(year, 1, 1)

        # 종료 날짜 결정
        if end_month and end_day:
            end_date = date(end_year, end_month, end_day)
        elif end_month:
            # 해당 월의 마지막 날
            import calendar
            last_day = calendar.monthrange(end_year, end_month)[1]
            end_date = date(end_year, end_month, last_day)
        else:
            end_date = date(end_year, 12, 31)

        for row in data:
            row_date = row.get('접수일자')
            if not row_date:
                continue

            # datetime 또는 date 객체로 변환
            if hasattr(row_date, 'date'):
                row_date = row_date.date()
            elif hasattr(row_date, 'year'):
                row_date = date(row_date.year, row_date.month, row_date.day)
            else:
                try:
                    parts = str(row_date).split('-')
                    row_date = date(int(parts[0]), int(parts[1]), int(parts[2][:2]))
                except:
                    continue

            if start_date <= row_date <= end_date:
                filtered.append(row)
    else:
        # 단일 날짜 모드
        for row in data:
            row_date = row.get('접수일자')
            if not row_date:
                continue

            # 연도 확인
            if hasattr(row_date, 'year'):
                row_year = row_date.year
                row_month = row_date.month
                row_day = row_date.day
            else:
                try:
                    parts = str(row_date).split('-')
                    row_year = int(parts[0])
                    row_month = int(parts[1])
                    row_day = int(parts[2][:2])
                except:
                    continue

            if row_year != year:
                continue

            if month and row_month != month:
                continue

            if day and row_day != day:
                continue

            filtered.append(row)

    return filtered

@app.route('/api/data')
def get_data():
    year = request.args.get('year', '2025')
    month = request.args.get('month', '')
    day = request.args.get('day', '')
    end_year = request.args.get('end_year', '')
    end_month = request.args.get('end_month', '')
    end_day = request.args.get('end_day', '')
    purpose = request.args.get('purpose', '전체')

    # 로그 출력
    date_info = f"year={year}"
    if month: date_info += f", month={month}"
    if day: date_info += f", day={day}"
    if end_year: date_info += f" ~ end_year={end_year}"
    if end_month: date_info += f", end_month={end_month}"
    if end_day: date_info += f", end_day={end_day}"
    print(f"[API] 요청: {date_info}, purpose={purpose}")

    # 기본 데이터 로드 (연도별)
    years_to_load = {year}
    if end_year and end_year != year:
        years_to_load.add(end_year)

    all_data = []
    for y in years_to_load:
        all_data.extend(load_excel_data(y))

    print(f"[API] 로드된 원본 데이터: {len(all_data)}건")

    # 전년도 거래처 목록 추출 (신규/기존 판단용)
    prev_year_clients = set()
    try:
        prev_year = str(int(year) - 1)
        prev_year_data = load_excel_data(prev_year)
        if prev_year_data:
            for row in prev_year_data:
                client = str(row.get('거래처', '') or '').strip()
                if client:
                    prev_year_clients.add(client)
            print(f"[API] 전년도({prev_year}) 거래처: {len(prev_year_clients)}개")
    except Exception as e:
        print(f"[API] 전년도 데이터 로드 실패: {e}")

    # 날짜 필터링 적용
    filtered_data = filter_data_by_date(all_data, year, month, day, end_year, end_month, end_day)
    print(f"[API] 날짜 필터링 후 데이터: {len(filtered_data)}건")

    processed = process_data(filtered_data, purpose, prev_year_clients if prev_year_clients else None)
    print(f"[API] 처리 완료: total_count={processed['total_count']}")
    return jsonify(processed)

@app.route('/api/food_item')
def get_food_item_data():
    """검사항목 데이터 API"""
    year = request.args.get('year', '2025')
    purpose = request.args.get('purpose', '전체')
    sample_type = request.args.get('sample_type', '전체')
    item = request.args.get('item', '전체')
    manager = request.args.get('manager', '전체')

    print(f"[API] food_item 요청: year={year}, purpose={purpose}, sample_type={sample_type}, item={item}, manager={manager}")

    # 데이터 로드
    data = load_food_item_data(year)
    print(f"[API] food_item 로드: {len(data)}건")

    # 데이터 처리
    processed = process_food_item_data(
        data,
        purpose_filter=purpose if purpose != '전체' else None,
        sample_type_filter=sample_type if sample_type != '전체' else None,
        item_filter=item if item != '전체' else None,
        manager_filter=manager if manager != '전체' else None
    )

    processed['year'] = int(year)
    print(f"[API] food_item 처리 완료: total_count={processed['total_count']}")
    return jsonify(processed)

@app.route('/api/collection')
@login_required
def get_collection_data():
    """수금 현황 API"""
    from datetime import datetime, date
    year = request.args.get('year', '2025')

    try:
        # 데이터 로드
        data = load_excel_data(year)

        # 디버그: 첫 번째 row의 키 출력
        if data:
            print(f"[수금API] 데이터 건수: {len(data)}")
            print(f"[수금API] 수수료: {data[0].get('수수료')}, 입금여부: {data[0].get('입금여부')}, 거래처: {data[0].get('거래처')}")

        today = date.today()
        total_sales = 0
        paid_amount = 0
        unpaid_amount = 0
        collection_days = []
        by_manager = {}
        by_month = {}
        by_type = {}
        unpaid_list = []

        for row in data:
            # 수수료 = 공급가액 + 세액 (부가세 포함 총액)
            sales = row.get('수수료', 0) or 0
            if isinstance(sales, str):
                sales = float(sales.replace(',', '').replace('원', '')) if sales else 0

            total_sales += sales

            manager = str(row.get('영업담당', '') or '').strip() or '미지정'
            payment_status = str(row.get('입금여부', '') or '').strip()
            payment_date_str = str(row.get('입금일', '') or '').strip()
            reception_date_str = str(row.get('접수일자', '') or '').strip()
            payment_type = str(row.get('입금구분', '') or '').strip() or '기타'
            company = str(row.get('거래처', '') or '').strip()

            if manager not in by_manager:
                by_manager[manager] = {'total': 0, 'paid': 0, 'unpaid': 0}
            by_manager[manager]['total'] += sales

            if payment_type not in by_type:
                by_type[payment_type] = 0

            is_paid = payment_status in ['Y', 'y', '완료', '입금', '입금완료', '수금', '수금완료']

            if is_paid and sales > 0:
                paid_amount += sales
                by_manager[manager]['paid'] += sales
                by_type[payment_type] += sales

                try:
                    if reception_date_str and payment_date_str:
                        reception_date = datetime.strptime(reception_date_str[:10], '%Y-%m-%d').date()
                        payment_date = datetime.strptime(payment_date_str[:10], '%Y-%m-%d').date()
                        days = (payment_date - reception_date).days
                        if 0 <= days <= 365:
                            collection_days.append(days)
                        month = payment_date.month
                        if month not in by_month:
                            by_month[month] = {'paid': 0, 'count': 0}
                        by_month[month]['paid'] += sales
                        by_month[month]['count'] += 1
                except:
                    pass
            else:
                unpaid_amount += sales
                by_manager[manager]['unpaid'] += sales

                if sales > 0:
                    elapsed_days = 0
                    try:
                        if reception_date_str:
                            reception_date = datetime.strptime(reception_date_str[:10], '%Y-%m-%d').date()
                            elapsed_days = (today - reception_date).days
                    except:
                        pass

                    unpaid_list.append({
                        'company': company,
                        'date': reception_date_str[:10] if reception_date_str else '-',
                        'amount': sales,
                        'days': elapsed_days,
                        'manager': manager
                    })

        avg_days = sum(collection_days) / len(collection_days) if collection_days else 0
        min_days = min(collection_days) if collection_days else 0
        max_days = max(collection_days) if collection_days else 0

        days_distribution = {'0-7일': 0, '8-14일': 0, '15-30일': 0, '31-60일': 0, '60일+': 0}
        for d in collection_days:
            if d <= 7:
                days_distribution['0-7일'] += 1
            elif d <= 14:
                days_distribution['8-14일'] += 1
            elif d <= 30:
                days_distribution['15-30일'] += 1
            elif d <= 60:
                days_distribution['31-60일'] += 1
            else:
                days_distribution['60일+'] += 1

        by_manager_sorted = sorted(by_manager.items(), key=lambda x: x[1]['total'], reverse=True)[:15]
        unpaid_list_sorted = sorted(unpaid_list, key=lambda x: x['amount'], reverse=True)[:50]
        collection_rate = (paid_amount / total_sales * 100) if total_sales > 0 else 0

        return jsonify({
            'year': int(year),
            'total_sales': total_sales,
            'paid_amount': paid_amount,
            'unpaid_amount': unpaid_amount,
            'collection_rate': round(collection_rate, 1),
            'avg_days': round(avg_days, 1),
            'min_days': min_days,
            'max_days': max_days,
            'by_manager': by_manager_sorted,
            'by_month': sorted(by_month.items()),
            'by_type': sorted(by_type.items(), key=lambda x: x[1], reverse=True),
            'days_distribution': list(days_distribution.items()),
            'unpaid_list': unpaid_list_sorted
        })
    except Exception as e:
        print(f"[API] 수금 API 에러: {e}")
        return jsonify({'error': str(e)}), 500

@app.route('/api/food_item/verify')
def verify_food_item_data():
    """검사항목 데이터 검증 API - 원시 SQL 데이터와 비교"""
    import sqlite3
    year = request.args.get('year', '2025')

    conn = sqlite3.connect(str(SQLITE_DB))
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()

    verification_results = {}

    # 1. 검사목적별-항목별 건수 직접 조회 (SQL)
    cursor.execute('''
        SELECT 검사목적, 항목명, COUNT(*) as cnt, SUM(CAST(항목수수료 AS REAL)) as fee
        FROM food_item_data
        WHERE year = ? AND 검사목적 IS NOT NULL AND 검사목적 != ''
              AND 항목명 IS NOT NULL AND 항목명 != ''
        GROUP BY 검사목적, 항목명
        ORDER BY 검사목적, cnt DESC
    ''', (year,))

    sql_by_purpose_item = {}
    for row in cursor.fetchall():
        purpose = row['검사목적']
        item = row['항목명']
        cnt = row['cnt']
        fee = row['fee'] or 0

        if purpose not in sql_by_purpose_item:
            sql_by_purpose_item[purpose] = {}
        sql_by_purpose_item[purpose][item] = {'count': cnt, 'fee': fee}

    # 2. process_food_item_data 결과 가져오기
    data = load_food_item_data(year)
    processed = process_food_item_data(data)
    processed_by_purpose_item = processed.get('by_purpose_item', {})

    # 3. 비교
    discrepancies = []

    for purpose in set(list(sql_by_purpose_item.keys()) + [p for p in processed_by_purpose_item.keys()]):
        sql_items = sql_by_purpose_item.get(purpose, {})
        proc_items = {item[0]: item[1] for item in processed_by_purpose_item.get(purpose, [])}

        sql_total = sum(d['count'] for d in sql_items.values())
        proc_total = sum(d['count'] for d in proc_items.values())

        if sql_total != proc_total:
            discrepancies.append({
                'purpose': purpose,
                'sql_total': sql_total,
                'processed_total': proc_total,
                'diff': sql_total - proc_total,
                'sql_items_count': len(sql_items),
                'processed_items_count': len(proc_items)
            })

        # 개별 항목 차이 체크
        for item_name in set(list(sql_items.keys()) + list(proc_items.keys())):
            sql_cnt = sql_items.get(item_name, {}).get('count', 0)
            proc_cnt = proc_items.get(item_name, {}).get('count', 0)

            if sql_cnt != proc_cnt:
                discrepancies.append({
                    'purpose': purpose,
                    'item': item_name,
                    'sql_count': sql_cnt,
                    'processed_count': proc_cnt,
                    'diff': sql_cnt - proc_cnt
                })

    # 4. 전체 통계
    cursor.execute('''
        SELECT COUNT(*) as total FROM food_item_data WHERE year = ?
    ''', (year,))
    total_rows = cursor.fetchone()['total']

    cursor.execute('''
        SELECT 검사목적, COUNT(*) as cnt FROM food_item_data
        WHERE year = ? AND 검사목적 IS NOT NULL AND 검사목적 != ''
        GROUP BY 검사목적 ORDER BY cnt DESC
    ''', (year,))
    purpose_summary = [dict(row) for row in cursor.fetchall()]

    conn.close()

    return jsonify({
        'year': year,
        'total_rows_in_db': total_rows,
        'processed_total_count': processed.get('total_count', 0),
        'purposes_in_db': len(sql_by_purpose_item),
        'purposes_in_processed': len(processed_by_purpose_item),
        'discrepancies': discrepancies[:50],  # 최대 50개
        'discrepancy_count': len(discrepancies),
        'purpose_summary_from_sql': purpose_summary[:20]
    })

@app.route('/api/food_item/debug')
def debug_food_item_data():
    """특정 검사목적/항목 데이터 상세 디버깅"""
    import sqlite3
    year = request.args.get('year', '2025')
    purpose = request.args.get('purpose', '')
    item = request.args.get('item', '')

    conn = sqlite3.connect(str(SQLITE_DB))
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()

    results = {}

    # 1. 해당 검사목적의 모든 항목 건수 (SQL)
    if purpose:
        cursor.execute('''
            SELECT 항목명, COUNT(*) as cnt, SUM(CAST(항목수수료 AS REAL)) as fee
            FROM food_item_data
            WHERE year = ? AND 검사목적 = ?
            GROUP BY 항목명
            ORDER BY cnt DESC
        ''', (year, purpose))
        results['sql_items_for_purpose'] = [dict(row) for row in cursor.fetchall()]
        results['sql_total_for_purpose'] = sum(r['cnt'] for r in results['sql_items_for_purpose'])

    # 2. 특정 항목의 모든 검사목적 건수 (SQL)
    if item:
        cursor.execute('''
            SELECT 검사목적, COUNT(*) as cnt
            FROM food_item_data
            WHERE year = ? AND 항목명 = ?
            GROUP BY 검사목적
            ORDER BY cnt DESC
        ''', (year, item))
        results['sql_purposes_for_item'] = [dict(row) for row in cursor.fetchall()]
        results['sql_total_for_item'] = sum(r['cnt'] for r in results['sql_purposes_for_item'])

    # 3. 특정 검사목적+항목 조합 건수 (SQL)
    if purpose and item:
        cursor.execute('''
            SELECT COUNT(*) as cnt, SUM(CAST(항목수수료 AS REAL)) as fee
            FROM food_item_data
            WHERE year = ? AND 검사목적 = ? AND 항목명 = ?
        ''', (year, purpose, item))
        row = cursor.fetchone()
        results['sql_exact_match'] = {'count': row['cnt'], 'fee': row['fee']}

        # 샘플 데이터 조회
        cursor.execute('''
            SELECT id, 접수일자, 검사목적, 항목명, 항목수수료, 결과입력자, 업체명
            FROM food_item_data
            WHERE year = ? AND 검사목적 = ? AND 항목명 = ?
            LIMIT 10
        ''', (year, purpose, item))
        results['sql_sample_rows'] = [dict(row) for row in cursor.fetchall()]

    # 4. process_food_item_data 결과 확인
    data = load_food_item_data(year)
    processed = process_food_item_data(data)

    if purpose:
        purpose_items = processed.get('by_purpose_item', {}).get(purpose, [])
        results['processed_items_for_purpose'] = purpose_items[:30]
        results['processed_total_for_purpose'] = sum(d[1]['count'] for d in purpose_items)

        if item:
            found = [d for d in purpose_items if d[0] == item]
            results['processed_exact_match'] = found[0] if found else None

    conn.close()

    return jsonify({
        'year': year,
        'purpose': purpose,
        'item': item,
        'results': results
    })

@app.route('/api/columns')
def get_columns():
    """Excel 파일의 컬럼명 조회"""
    year = request.args.get('year', '2025')
    from openpyxl import load_workbook

    data_path = DATA_DIR / str(year)
    if not data_path.exists():
        return jsonify({'error': f'{year}년 데이터 폴더가 없습니다.', 'columns': []})

    files = sorted(data_path.glob("*.xlsx"))
    if not files:
        return jsonify({'error': f'{year}년 데이터 파일이 없습니다.', 'columns': []})

    try:
        wb = load_workbook(files[0], read_only=True, data_only=True)
        ws = wb.active
        headers = [cell.value for cell in ws[1] if cell.value]
        wb.close()

        # 주소 관련 컬럼 표시
        address_cols = [h for h in headers if h and any(k in str(h) for k in ['주소', '지역', '시', '도', '군', '구', '동', '장소'])]

        return jsonify({
            'year': year,
            'file': files[0].name,
            'total_columns': len(headers),
            'columns': headers,
            'address_columns': address_cols
        })
    except Exception as e:
        return jsonify({'error': str(e), 'columns': []})

@app.route('/api/upload-db', methods=['POST'])
def upload_db():
    """Colab에서 생성된 DB 파일 업로드 API"""
    import shutil

    # 간단한 API 키 인증 (환경변수 또는 기본값)
    api_key = request.headers.get('X-API-Key', '')
    expected_key = os.environ.get('DB_UPLOAD_KEY', 'biofl1411-upload-key')

    if api_key != expected_key:
        return jsonify({'error': '인증 실패'}), 401

    if 'file' not in request.files:
        return jsonify({'error': '파일이 없습니다'}), 400

    file = request.files['file']
    if file.filename == '':
        return jsonify({'error': '파일명이 없습니다'}), 400

    try:
        # 기존 DB 백업
        if SQLITE_DB.exists():
            backup_path = SQLITE_DB.with_suffix('.db.backup')
            shutil.copy(str(SQLITE_DB), str(backup_path))
            print(f"[DB] 기존 DB 백업: {backup_path}")

        # 새 DB 저장
        file.save(str(SQLITE_DB))
        print(f"[DB] 새 DB 업로드 완료: {SQLITE_DB}")

        # DB 검증 - 테이블 및 행 수 확인
        import sqlite3
        conn = sqlite3.connect(str(SQLITE_DB))
        cursor = conn.cursor()

        cursor.execute("SELECT name FROM sqlite_master WHERE type='table'")
        tables = [row[0] for row in cursor.fetchall()]

        table_info = {}
        for table in tables:
            cursor.execute(f"SELECT COUNT(*) FROM {table}")
            count = cursor.fetchone()[0]
            table_info[table] = count

        conn.close()

        # 캐시 초기화
        global DATA_CACHE, CACHE_TIME, AI_SUMMARY_CACHE, FILE_MTIME
        DATA_CACHE = {}
        CACHE_TIME = {}
        AI_SUMMARY_CACHE = {}
        FILE_MTIME = {}
        print("[DB] 캐시 초기화 완료")

        return jsonify({
            'status': 'ok',
            'message': 'DB 업로드 성공',
            'tables': table_info
        })

    except Exception as e:
        print(f"[DB ERROR] 업로드 실패: {e}")
        return jsonify({'error': str(e)}), 500


@app.route('/api/cache/refresh')
def refresh_cache():
    """캐시 새로고침"""
    global DATA_CACHE, CACHE_TIME, AI_SUMMARY_CACHE, FILE_MTIME
    DATA_CACHE = {}
    CACHE_TIME = {}
    AI_SUMMARY_CACHE = {}
    FILE_MTIME = {}
    print("[CACHE] 모든 캐시 초기화됨")
    # 데이터 미리 로드
    for year in ['2024', '2025']:
        load_excel_data(year, use_cache=False)
    # AI 요약 캐시도 미리 생성
    get_ai_data_summary(force_refresh=True)
    return jsonify({'status': 'ok', 'message': '캐시가 새로고침되었습니다.'})


@app.route('/api/debug/urgent')
def debug_urgent():
    """긴급여부 필드 값 확인용 디버그 API"""
    import pandas as pd
    urgent_values = {}

    for year in ['2024', '2025']:
        data_path = DATA_DIR / str(year)
        if not data_path.exists():
            continue
        urgent_values[year] = set()
        for f in sorted(data_path.glob("*.xlsx")):
            try:
                df = pd.read_excel(f)
                if '긴급여부' in df.columns:
                    values = df['긴급여부'].dropna().unique()
                    for v in values:
                        urgent_values[year].add(str(v).strip())
            except Exception as e:
                pass
        urgent_values[year] = list(urgent_values[year])

    return jsonify({'urgent_values': urgent_values})


@app.route('/api/token-usage')
def api_token_usage():
    """토큰 사용량 조회 API"""
    try:
        stats = get_token_usage_stats()
        return jsonify({
            'success': True,
            'this_month': stats['this_month'],
            'last_month': stats['last_month']
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


# 기업 정보 파일 경로
COMPANY_INFO_FILE = os.path.join(DATA_DIR, 'company_info.json')

@app.route('/api/company-info', methods=['GET'])
def get_company_info():
    """기업 정보 조회"""
    try:
        if os.path.exists(COMPANY_INFO_FILE):
            with open(COMPANY_INFO_FILE, 'r', encoding='utf-8') as f:
                data = json.load(f)
            print(f"[CompanyInfo] 기업 정보 로드 성공: {data.get('companyName', 'N/A')}")
            return jsonify({'success': True, 'data': data})
        else:
            print("[CompanyInfo] 저장된 기업 정보 없음")
            return jsonify({'success': True, 'data': None})
    except Exception as e:
        print(f"[CompanyInfo] 로드 오류: {e}")
        return jsonify({'success': False, 'error': str(e)})

@app.route('/api/company-info', methods=['POST'])
def save_company_info():
    """기업 정보 저장"""
    try:
        data = request.json
        with open(COMPANY_INFO_FILE, 'w', encoding='utf-8') as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
        print(f"[CompanyInfo] 기업 정보 저장 완료: {data.get('companyName', 'N/A')}")
        return jsonify({'success': True})
    except Exception as e:
        print(f"[CompanyInfo] 저장 오류: {e}")
        return jsonify({'success': False, 'error': str(e)})

# 식품제조가공업 Open API
FOOD_MANUFACTURING_API_KEY = 'db180118ffa742c0b5be'
FOOD_MANUFACTURING_CACHE_FILE = os.path.join(DATA_DIR, 'food_manufacturing_cache.json')

@app.route('/api/food-manufacturing/stats')
def get_food_manufacturing_stats():
    """지역별 식품제조가공업소 통계 조회"""
    import urllib.request
    import ssl

    try:
        # 캐시 확인 (24시간 유효)
        if os.path.exists(FOOD_MANUFACTURING_CACHE_FILE):
            with open(FOOD_MANUFACTURING_CACHE_FILE, 'r', encoding='utf-8') as f:
                cache = json.load(f)
            cache_time = cache.get('timestamp', 0)
            if time.time() - cache_time < 86400:  # 24시간
                print('[FoodAPI] 캐시 데이터 사용')
                return jsonify({'success': True, 'data': cache.get('data', {}), 'cached': True})

        # API 호출 (전체 건수 먼저 확인)
        ssl_context = ssl.create_default_context()
        ssl_context.check_hostname = False
        ssl_context.verify_mode = ssl.CERT_NONE

        # 총 건수 확인
        url = f'http://openapi.foodsafetykorea.go.kr/api/{FOOD_MANUFACTURING_API_KEY}/I1220/json/1/1'
        print(f'[FoodAPI] API 요청: {url}')
        req = urllib.request.Request(url, headers={'User-Agent': 'Mozilla/5.0'})

        with urllib.request.urlopen(req, timeout=30, context=ssl_context) as response:
            response_text = response.read().decode('utf-8')
            print(f'[FoodAPI] API 응답: {response_text[:500]}')

            # Host not allowed 에러 체크
            if 'Host not allowed' in response_text or 'ERROR' in response_text.upper():
                return jsonify({
                    'success': False,
                    'error': 'API 접근 권한 오류: 서버 IP가 등록되지 않았습니다. 식품안전나라에서 서버 IP를 허용 목록에 추가해주세요.'
                })

            result = json.loads(response_text)

        # API 에러 응답 체크 (INFO-000이 아니면 에러)
        api_result = result.get('I1220', {}).get('RESULT', {})
        if api_result.get('CODE') != 'INFO-000':
            error_msg = api_result.get('MSG', 'Unknown error')
            error_code = api_result.get('CODE', '')
            print(f'[FoodAPI] API 에러: {error_code} - {error_msg}')
            return jsonify({'success': False, 'error': f'API 에러: {error_msg}'})

        total_count = int(result.get('I1220', {}).get('total_count', 0))
        print(f'[FoodAPI] 총 식품제조가공업소 수: {total_count}')

        if total_count == 0:
            return jsonify({'success': False, 'error': 'API 데이터 없음'})

        # 지역별 통계 수집 (페이지네이션)
        region_stats = {}
        page_size = 1000

        for start in range(1, min(total_count + 1, 50001), page_size):  # 최대 5만건
            end = min(start + page_size - 1, total_count)
            url = f'http://openapi.foodsafetykorea.go.kr/api/{FOOD_MANUFACTURING_API_KEY}/I1220/json/{start}/{end}'
            req = urllib.request.Request(url, headers={'User-Agent': 'Mozilla/5.0'})

            try:
                with urllib.request.urlopen(req, timeout=60, context=ssl_context) as response:
                    data = json.loads(response.read().decode('utf-8'))

                rows = data.get('I1220', {}).get('row', [])
                for row in rows:
                    # 주소에서 시도/시군구 추출 (LOCP_ADDR 필드 사용)
                    addr = row.get('LOCP_ADDR', '') or row.get('SITE_ADDR', '') or ''
                    if not addr:
                        continue

                    sido = extract_sido(addr)
                    if sido:
                        if sido not in region_stats:
                            region_stats[sido] = {'total': 0, 'sigungu': {}}
                        region_stats[sido]['total'] += 1

                        # 시군구 추출
                        _, sigungu = extract_region(addr)
                        if sigungu:
                            if sigungu not in region_stats[sido]['sigungu']:
                                region_stats[sido]['sigungu'][sigungu] = 0
                            region_stats[sido]['sigungu'][sigungu] += 1

                print(f'[FoodAPI] {start}-{end} 처리 완료 ({len(rows)}건)')
            except Exception as e:
                print(f'[FoodAPI] {start}-{end} 처리 실패: {e}')
                continue

        # 캐시 저장
        cache_data = {
            'timestamp': time.time(),
            'total_count': total_count,
            'data': region_stats
        }
        with open(FOOD_MANUFACTURING_CACHE_FILE, 'w', encoding='utf-8') as f:
            json.dump(cache_data, f, ensure_ascii=False, indent=2)

        print(f'[FoodAPI] 지역별 통계 완료: {len(region_stats)}개 시도')
        return jsonify({'success': True, 'data': region_stats, 'total': total_count})

    except Exception as e:
        import traceback
        print(f'[FoodAPI] 오류: {e}')
        traceback.print_exc()
        return jsonify({'success': False, 'error': str(e)})

# 축산물 가공업허가정보 Open API
LIVESTOCK_API_KEY = 'db180118ffa742c0b5be'
LIVESTOCK_CACHE_FILE = os.path.join(DATA_DIR, 'livestock_manufacturing_cache.json')

@app.route('/api/livestock-manufacturing/stats')
def get_livestock_manufacturing_stats():
    """지역별 축산물가공업소 통계 조회"""
    import urllib.request
    import ssl

    try:
        # 캐시 확인 (24시간 유효)
        if os.path.exists(LIVESTOCK_CACHE_FILE):
            with open(LIVESTOCK_CACHE_FILE, 'r', encoding='utf-8') as f:
                cache = json.load(f)
            cache_time = cache.get('timestamp', 0)
            if time.time() - cache_time < 86400:  # 24시간
                print('[LivestockAPI] 캐시 데이터 사용')
                return jsonify({'success': True, 'data': cache.get('data', {}), 'cached': True})

        # API 호출 (전체 건수 먼저 확인)
        ssl_context = ssl.create_default_context()
        ssl_context.check_hostname = False
        ssl_context.verify_mode = ssl.CERT_NONE

        # 총 건수 확인
        url = f'http://openapi.foodsafetykorea.go.kr/api/{LIVESTOCK_API_KEY}/I1300/json/1/1'
        print(f'[LivestockAPI] API 요청: {url}')
        req = urllib.request.Request(url, headers={'User-Agent': 'Mozilla/5.0'})

        with urllib.request.urlopen(req, timeout=30, context=ssl_context) as response:
            response_text = response.read().decode('utf-8')
            print(f'[LivestockAPI] API 응답: {response_text[:500]}')

            if 'Host not allowed' in response_text or 'ERROR' in response_text.upper():
                return jsonify({
                    'success': False,
                    'error': 'API 접근 권한 오류: 서버 IP가 등록되지 않았습니다.'
                })

            result = json.loads(response_text)

        # API 에러 응답 체크
        api_result = result.get('I1300', {}).get('RESULT', {})
        if api_result.get('CODE') != 'INFO-000':
            error_msg = api_result.get('MSG', 'Unknown error')
            print(f'[LivestockAPI] API 에러: {error_msg}')
            return jsonify({'success': False, 'error': f'API 에러: {error_msg}'})

        total_count = int(result.get('I1300', {}).get('total_count', 0))
        print(f'[LivestockAPI] 총 축산물가공업소 수: {total_count}')

        if total_count == 0:
            return jsonify({'success': False, 'error': 'API 데이터 없음'})

        # 지역별 통계 수집 (페이지네이션)
        region_stats = {}
        page_size = 1000

        for start in range(1, min(total_count + 1, 50001), page_size):
            end = min(start + page_size - 1, total_count)
            url = f'http://openapi.foodsafetykorea.go.kr/api/{LIVESTOCK_API_KEY}/I1300/json/{start}/{end}'
            req = urllib.request.Request(url, headers={'User-Agent': 'Mozilla/5.0'})

            try:
                with urllib.request.urlopen(req, timeout=60, context=ssl_context) as response:
                    data = json.loads(response.read().decode('utf-8'))

                rows = data.get('I1300', {}).get('row', [])
                for row in rows:
                    # 주소에서 시도 추출 (ADDR 또는 SITE_ADDR 필드)
                    addr = row.get('ADDR', '') or row.get('SITE_ADDR', '') or row.get('LOCP_ADDR', '') or ''
                    if not addr:
                        continue

                    sido = extract_sido(addr)
                    if sido:
                        if sido not in region_stats:
                            region_stats[sido] = {'total': 0, 'sigungu': {}}
                        region_stats[sido]['total'] += 1

                        # 시군구 추출
                        _, sigungu = extract_region(addr)
                        if sigungu:
                            if sigungu not in region_stats[sido]['sigungu']:
                                region_stats[sido]['sigungu'][sigungu] = 0
                            region_stats[sido]['sigungu'][sigungu] += 1

                print(f'[LivestockAPI] {start}-{end} 처리 완료 ({len(rows)}건)')
            except Exception as e:
                print(f'[LivestockAPI] {start}-{end} 처리 실패: {e}')
                continue

        # 캐시 저장
        cache_data = {
            'timestamp': time.time(),
            'total_count': total_count,
            'data': region_stats
        }
        with open(LIVESTOCK_CACHE_FILE, 'w', encoding='utf-8') as f:
            json.dump(cache_data, f, ensure_ascii=False, indent=2)

        print(f'[LivestockAPI] 지역별 통계 완료: {len(region_stats)}개 시도')
        return jsonify({'success': True, 'data': region_stats, 'total': total_count})

    except Exception as e:
        import traceback
        print(f'[LivestockAPI] 오류: {e}')
        traceback.print_exc()
        return jsonify({'success': False, 'error': str(e)})

def get_company_context():
    """AI 분석용 기업 정보 컨텍스트 생성"""
    try:
        if os.path.exists(COMPANY_INFO_FILE):
            with open(COMPANY_INFO_FILE, 'r', encoding='utf-8') as f:
                data = json.load(f)

            # 부서 정보 요약
            dept_summary = []
            total_employees = 0
            if data.get('departments'):
                for dept_name, dept_info in data['departments'].items():
                    count = dept_info.get('count', 0)
                    if count > 0:
                        total_employees += count
                        role = dept_info.get('role', '')
                        dept_summary.append(f"{dept_name}({count}명): {role}")

            # 영업부 인력 요약
            sales_summary = []
            if data.get('salesPersonnel'):
                for person in data['salesPersonnel']:
                    if person.get('name'):
                        sales_summary.append(f"{person['name']}({person.get('region', '')})")

            # 지사 인력 요약
            branch_summary = []
            if data.get('branchPersonnel'):
                for person in data['branchPersonnel']:
                    if person.get('name'):
                        branch_summary.append(f"{person['name']}({person.get('region', '')})")

            context = f"""[기업 정보]
- 기업명: {data.get('companyName', '미입력')}
- 설립연도: {data.get('foundedYear', '미입력')}
- 사업분야: {data.get('businessField', '미입력')}
- 주요서비스: {data.get('mainServices', '미입력')}
- 연간매출목표: {data.get('revenueTarget', '미입력')}억원
- 연간검사목표: {data.get('inspectionTarget', '미입력')}건
- KPI: {data.get('kpiDescription', '미입력')}
- 경영전략: {data.get('businessStrategy', '미입력')}
- 총인원: {total_employees}명
- 조직구성: {'; '.join(dept_summary[:5]) if dept_summary else '미입력'}
- 영업담당자: {', '.join(sales_summary) if sales_summary else '미입력'}
- 지사담당자: {', '.join(branch_summary) if branch_summary else '미입력'}"""
            return context
        return ""
    except Exception as e:
        print(f"[CompanyInfo] 컨텍스트 생성 오류: {e}")
        return ""

@app.route('/api/ai/analyze', methods=['POST'])
def ai_analyze():
    """AI 경영 분석 API - Claude를 사용한 경영 판단 지원"""
    import urllib.request
    import urllib.error
    import time

    query = request.json.get('query', '')
    print(f"[AI] === 경영 분석 요청 시작 ===")
    print(f"[AI] 질문: {query}")

    if not query:
        return jsonify({'error': '질문을 입력해주세요.'})

    # 종합 데이터 수집
    data_summary = get_ai_data_summary()
    stats_2024 = data_summary['2024']
    stats_2025 = data_summary['2025']

    # 2024년 vs 2025년 비교 데이터 계산
    growth_rate = ((stats_2025['total_fee'] - stats_2024['total_fee']) / stats_2024['total_fee'] * 100) if stats_2024['total_fee'] > 0 else 0
    count_growth = ((stats_2025['total_count'] - stats_2024['total_count']) / stats_2024['total_count'] * 100) if stats_2024['total_count'] > 0 else 0

    # TOP 분석
    top_purposes_2025 = sorted(stats_2025['by_purpose'].items(), key=lambda x: x[1]['fee'], reverse=True)[:7]
    top_purposes_2024 = sorted(stats_2024['by_purpose'].items(), key=lambda x: x[1]['fee'], reverse=True)[:7]
    top_managers_2025 = sorted(stats_2025['by_manager'].items(), key=lambda x: x[1]['fee'], reverse=True)[:10]
    top_managers_2024 = sorted(stats_2024['by_manager'].items(), key=lambda x: x[1]['fee'], reverse=True)[:10]

    # 월별 추이 (2025년)
    monthly_2025 = stats_2025.get('monthly', {})
    monthly_trend = []
    for m in range(1, 13):
        if m in monthly_2025:
            monthly_trend.append(f"{m}월: {monthly_2025[m]['fee']/100000000:.2f}억")

    # 영업담당별 상세 분석
    manager_analysis = []
    for name, data in top_managers_2025:
        prev = stats_2024['by_manager'].get(name, {'fee': 0, 'count': 0})
        growth = ((data['fee'] - prev['fee']) / prev['fee'] * 100) if prev['fee'] > 0 else 0
        manager_analysis.append(f"{name}: {data['fee']/100000000:.2f}억(전년비 {growth:+.1f}%)")

    # 검사목적별 성장률 분석
    purpose_growth = []
    for name, data in top_purposes_2025:
        prev = stats_2024['by_purpose'].get(name, {'fee': 0})
        growth = ((data['fee'] - prev['fee']) / prev['fee'] * 100) if prev['fee'] > 0 else 0
        purpose_growth.append(f"{name}: {data['fee']/100000000:.2f}억(전년비 {growth:+.1f}%)")

    # 고객(업체) 분석 추가
    top_clients_2025 = sorted(stats_2025.get('by_client', {}).items(), key=lambda x: x[1]['fee'], reverse=True)[:10]

    # 고객별 상세 분석
    client_analysis = []
    for name, data in top_clients_2025:
        prev = stats_2024.get('by_client', {}).get(name, {'fee': 0, 'count': 0})
        growth = ((data['fee'] - prev['fee']) / prev['fee'] * 100) if prev['fee'] > 0 else 100
        months_active = len(data.get('months', []))
        client_analysis.append(f"{name}: {data['fee']/100000000:.2f}억({data['count']}건, {months_active}개월 거래, 전년비 {growth:+.1f}%)")

    # 신규/이탈 고객 분석
    clients_2024_set = set(stats_2024.get('by_client', {}).keys())
    clients_2025_set = set(stats_2025.get('by_client', {}).keys())
    new_clients = clients_2025_set - clients_2024_set
    lost_clients = clients_2024_set - clients_2025_set
    retained_clients = clients_2024_set & clients_2025_set

    new_client_revenue = sum(stats_2025.get('by_client', {}).get(c, {}).get('fee', 0) for c in new_clients)
    lost_client_revenue = sum(stats_2024.get('by_client', {}).get(c, {}).get('fee', 0) for c in lost_clients)
    retention_rate = (len(retained_clients) / len(clients_2024_set) * 100) if clients_2024_set else 0

    avg_revenue_per_client_2025 = (stats_2025['total_fee'] / len(clients_2025_set)) if clients_2025_set else 0
    avg_revenue_per_client_2024 = (stats_2024['total_fee'] / len(clients_2024_set)) if clients_2024_set else 0

    # 핵심 KPI 계산
    months_with_data_2025 = len([m for m in monthly_2025.values() if m['fee'] > 0])
    months_with_data_2024 = len([m for m in stats_2024.get('monthly', {}).values() if m['fee'] > 0])

    monthly_avg_2025 = (stats_2025['total_fee'] / months_with_data_2025) if months_with_data_2025 > 0 else 0
    monthly_avg_2024 = (stats_2024['total_fee'] / months_with_data_2024) if months_with_data_2024 > 0 else 0
    avg_price_per_case_2025 = (stats_2025['total_fee'] / stats_2025['total_count']) if stats_2025['total_count'] > 0 else 0
    avg_price_per_case_2024 = (stats_2024['total_fee'] / stats_2024['total_count']) if stats_2024['total_count'] > 0 else 0
    monthly_avg_count_2025 = (stats_2025['total_count'] / months_with_data_2025) if months_with_data_2025 > 0 else 0

    # 전월 대비 성장률
    sorted_months = sorted(monthly_2025.keys())
    if len(sorted_months) >= 2:
        latest_month = sorted_months[-1]
        prev_month = sorted_months[-2]
        mom_growth = ((monthly_2025[latest_month]['fee'] - monthly_2025[prev_month]['fee']) / monthly_2025[prev_month]['fee'] * 100) if monthly_2025[prev_month]['fee'] > 0 else 0
        mom_text = f"- 전월 대비 성장률: {mom_growth:+.1f}% ({prev_month}월→{latest_month}월)"
    else:
        mom_text = ""

    # 기업 정보 컨텍스트
    company_context = get_company_context()

    # 종합 데이터 컨텍스트 생성
    comprehensive_context = f"""
=== 경영 데이터 현황 ===

[2025년 실적]
- 총 매출: {stats_2025['total_fee']/100000000:.2f}억원 (전년비 {growth_rate:+.1f}%)
- 총 건수: {stats_2025['total_count']:,}건 (전년비 {count_growth:+.1f}%)

[2024년 실적]
- 총 매출: {stats_2024['total_fee']/100000000:.2f}억원
- 총 건수: {stats_2024['total_count']:,}건

[핵심 경영 지표 (KPI)]
- 월평균 매출: {monthly_avg_2025/100000000:.2f}억원 (전년 {monthly_avg_2024/100000000:.2f}억)
- 건당 평균 단가: {avg_price_per_case_2025:,.0f}원 (전년 {avg_price_per_case_2024:,.0f}원)
- 월평균 검사 건수: {monthly_avg_count_2025:,.0f}건
{mom_text}

[2025년 월별 매출 추이]
{', '.join(monthly_trend) if monthly_trend else '데이터 없음'}

[영업담당별 실적 (2025년 TOP 10)]
{chr(10).join(manager_analysis)}

[검사목적별 매출 (2025년)]
{chr(10).join(purpose_growth)}

[검체유형 TOP 5 (2025년)]
{', '.join([f"{k}({v['fee']/100000000:.2f}억)" for k, v in sorted(stats_2025['by_sample_type'].items(), key=lambda x: x[1]['fee'], reverse=True)[:5]])}

[고객(업체) 분석]
- 총 거래처 수: 2025년 {len(clients_2025_set):,}개 / 2024년 {len(clients_2024_set):,}개
- 고객 유지율: {retention_rate:.1f}% (유지 {len(retained_clients):,}개 / 전년 {len(clients_2024_set):,}개)
- 신규 고객: {len(new_clients):,}개 (매출 {new_client_revenue/100000000:.2f}억)
- 이탈 고객: {len(lost_clients):,}개 (전년 매출 {lost_client_revenue/100000000:.2f}억)
- 평균 객단가: 2025년 {avg_revenue_per_client_2025/10000:.0f}만원 / 2024년 {avg_revenue_per_client_2024/10000:.0f}만원

[TOP 10 고객사 (2025년)]
{chr(10).join(client_analysis)}

{company_context if company_context else ''}
"""

    # Claude API 호출 - 경영 분석 전문가 프롬프트
    system_prompt = f"""당신은 식품검사업계 전문 경영 컨설턴트입니다. 제공된 데이터를 분석하여 경영자의 의사결정에 도움이 되는 인사이트를 제공합니다.

{comprehensive_context}

응답 지침:
1. 질문에 대해 데이터 기반의 명확한 분석을 제공하세요
2. 반드시 다음 구조로 답변하세요:

## 📊 현황 분석
(데이터에 기반한 현재 상황 설명)

## ✅ 장점 (강점)
- 구체적인 수치와 함께 긍정적인 측면 나열

## ⚠️ 개선 필요 사항
- 구체적인 수치와 함께 주의가 필요한 부분 나열

## 💡 개선 방향 제안
- 실행 가능한 구체적인 개선 방안 제시

## 📈 근거 데이터
- 분석에 사용된 핵심 수치 요약

중요:
- 모든 분석은 제공된 데이터의 구체적인 수치를 인용하세요
- 추측이나 일반론이 아닌 데이터 기반 인사이트를 제공하세요
- 경영자가 바로 활용할 수 있는 실용적인 제안을 하세요"""

    print(f"[AI] Claude API 호출 중...")
    claude_result = call_claude_api(f"질문: {query}", system_prompt=system_prompt, max_tokens=2000)

    if claude_result['success']:
        ai_response = claude_result['text']
        print(f"[AI] Claude 응답 수신: {len(ai_response)}자")

        # 로그 기록
        session_id = request.cookies.get('session_id')
        session = verify_user_session(session_id) if session_id else None
        if session:
            log_ai_analysis(session.get('user_id'), query, len(ai_response), claude_result.get('tokens', 0))

        return jsonify({
            'success': True,
            'analysis_type': 'management_insight',
            'response': ai_response,
            'ai_model': 'Claude Sonnet 4',
            'data_summary': {
                'total_sales_2025': stats_2025['total_fee'],
                'total_sales_2024': stats_2024['total_fee'],
                'growth_rate': round(growth_rate, 1),
                'total_count_2025': stats_2025['total_count']
            }
        })
    else:
        print(f"[AI] Claude API 오류: {claude_result.get('error')}")
        return jsonify({'error': f"AI 분석 실패: {claude_result.get('error', '알 수 없는 오류')}"})


@app.route('/api/ai/analyze-legacy', methods=['POST'])
def ai_analyze_legacy():
    """AI 분석 API (레거시) - 기존 JSON 파싱 방식"""
    import urllib.request
    import urllib.error
    import time

    query = request.json.get('query', '')
    print(f"[AI-Legacy] === 분석 요청 시작 ===")
    print(f"[AI-Legacy] 질문: {query}")

    if not query:
        return jsonify({'error': '질문을 입력해주세요.'})

    # 캐시된 데이터 요약 사용 (변경 감지 포함)
    data_summary = get_ai_data_summary()
    filter_values = data_summary['filter_values']

    # 2025년 주요 통계 요약
    stats_2025 = data_summary['2025']
    top_purposes = sorted(stats_2025['by_purpose'].items(), key=lambda x: x[1]['fee'], reverse=True)[:5]
    top_managers = sorted(stats_2025['by_manager'].items(), key=lambda x: x[1]['fee'], reverse=True)[:5]

    stats_text = f"""2025년 현황:
- 총 건수: {stats_2025['total_count']:,}건
- 총 매출: {stats_2025['total_fee']/100000000:.2f}억원
- TOP 검사목적: {', '.join([f"{p[0]}({p[1]['fee']/10000:.0f}만)" for p in top_purposes])}
- TOP 영업담당: {', '.join([f"{m[0]}({m[1]['fee']/10000:.0f}만)" for m in top_managers])}"""

    # Claude API 사용
    if USE_CLAUDE and CLAUDE_API_KEY:
        system_prompt = f"""당신은 경영 데이터 분석 전문가입니다. 사용자의 질문을 분석하여 JSON 형식으로 응답하세요.

{stats_text}

사용 가능한 필터 값:
- 연도: 2024, 2025
- 월: 1~12 (특정 월 분석 시)
- 검사목적: {', '.join(filter_values['purposes'][:10])}
- 검체유형: {', '.join(filter_values['sample_types'][:10])}
- 영업담당: {', '.join(filter_values['managers'][:10])}

분석 유형:
- year_comparison: 연도간 비교 분석 (예: 2025년 vs 2024년)
- monthly_trend: 월별 추이 분석
- top_managers: 영업담당별 TOP N 분석
- top_purposes: 검사목적별 TOP N 분석
- summary: 요약 통계
- direct_answer: 직접 답변 (계산 없이 바로 답변 가능한 경우)

반드시 JSON 형식만 응답하세요:
{{"analysis_type":"타입","year":"2025","compare_year":"2024","month":null,"purpose":null,"sample_type":null,"manager":null,"top_n":10,"description":"분석 설명","direct_answer":"직접 답변 가능시 여기에 작성"}}"""

        claude_result = call_claude_api(f"질문: {query}", system_prompt=system_prompt, max_tokens=800)

        if claude_result['success']:
            ai_response = claude_result['text']

            # JSON 파싱
            try:
                json_str = ai_response.strip()
                if '```json' in json_str:
                    json_str = json_str.split('```json')[1].split('```')[0]
                elif '```' in json_str:
                    json_str = json_str.split('```')[1].split('```')[0]

                parsed = json.loads(json_str.strip())

                # direct_answer 타입이면 바로 응답 반환
                if parsed.get('analysis_type') == 'direct_answer' and parsed.get('direct_answer'):
                    return jsonify({
                        'success': True,
                        'analysis_type': 'direct_answer',
                        'description': parsed.get('description', ''),
                        'direct_answer': parsed.get('direct_answer'),
                        'parsed_query': parsed,
                        'ai_model': 'Claude Sonnet 4'
                    })

                # 데이터 조회 및 분석 실행
                food_2024 = load_food_item_data('2024')
                food_2025 = load_food_item_data('2025')
                data_2024 = load_excel_data('2024')
                data_2025 = load_excel_data('2025')

                analysis_result = execute_analysis(parsed, food_2024, food_2025, data_2024, data_2025)
                analysis_result['parsed_query'] = parsed
                analysis_result['ai_model'] = 'Claude Sonnet 4'

                print(f"[AI-Legacy] 분석 완료: {analysis_result.get('analysis_type')}")
                return jsonify(analysis_result)

            except json.JSONDecodeError as e:
                print(f"[AI] Claude JSON 파싱 오류: {e}")
                return jsonify({
                    'error': 'Claude 응답 파싱 실패',
                    'raw_response': ai_response[:500]
                })
        else:
            print(f"[AI] Claude API 실패: {claude_result.get('error')}")
            # Claude 실패 시 Gemini로 폴백
            print(f"[AI] Gemini로 폴백...")

    # Gemini API 사용 (폴백 또는 기본)
    global current_api_key_index
    if not GEMINI_API_KEYS:
        print(f"[AI] 오류: API 키 없음")
        return jsonify({'error': 'API 키가 설정되지 않았습니다.'})

    print(f"[AI] 사용 가능한 Gemini API 키: {len(GEMINI_API_KEYS)}개")

    # 간소화된 Gemini 프롬프트 (토큰 절약)
    system_prompt = f"""데이터 분석 도우미입니다. 질문을 JSON으로 변환하세요.

{stats_text}

가능한 값:
- 연도: 2024, 2025
- 월: 1~12
- 검사목적: {', '.join(filter_values['purposes'][:10])}
- 검체유형: {', '.join(filter_values['sample_types'][:10])}
- 영업담당: {', '.join(filter_values['managers'][:10])}

분석유형: year_comparison(연도비교), monthly_trend(월별추이), top_managers(담당자TOP), top_purposes(목적별TOP), summary(요약), direct_answer(직접답변)

연도 비교 질문은 year_comparison 사용, compare_year 설정 필수

JSON 형식만 응답:
{{"analysis_type":"타입","year":"2025","compare_year":"2024","month":null,"purpose":null,"sample_type":null,"manager":null,"top_n":10,"description":"설명","direct_answer":"직접 답변이 가능하면 여기에 작성"}}"""

    print(f"[AI] 프롬프트 길이: {len(system_prompt)}자")

    payload = {
        "contents": [{"parts": [{"text": system_prompt + f"\n\n질문: {query}"}]}],
        "generationConfig": {"temperature": 0.1, "maxOutputTokens": 500}
    }

    # Gemini API 호출 (여러 키로 429 대응)
    total_keys = len(GEMINI_API_KEYS)
    keys_tried = 0

    while keys_tried < total_keys:
        api_key = GEMINI_API_KEYS[current_api_key_index]
        url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key={api_key}"

        print(f"[AI] API 키 {current_api_key_index + 1}/{total_keys} 사용: {api_key[:15]}...")

        try:
            req = urllib.request.Request(
                url,
                data=json.dumps(payload).encode('utf-8'),
                headers={'Content-Type': 'application/json'},
                method='POST'
            )

            with urllib.request.urlopen(req, timeout=30) as response:
                result = json.loads(response.read().decode('utf-8'))

            print(f"[AI] Gemini API 응답 수신 성공")

            # 토큰 사용량 기록
            try:
                usage_metadata = result.get('usageMetadata', {})
                input_tokens = usage_metadata.get('promptTokenCount', len(system_prompt) // 4)
                output_tokens = usage_metadata.get('candidatesTokenCount', 100)
                record_token_usage('gemini-2.0-flash', input_tokens, output_tokens)
                print(f"[AI] 토큰 사용: 입력={input_tokens}, 출력={output_tokens}")
            except Exception as te:
                print(f"[AI] 토큰 기록 오류: {te}")

            # 라운드 로빈: 성공 후에도 다음 키로 전환 (부하 분산)
            current_api_key_index = (current_api_key_index + 1) % total_keys

            # Gemini 응답에서 JSON 추출
            ai_response = result['candidates'][0]['content']['parts'][0]['text']
            print(f"[AI] Gemini 원본 응답: {ai_response[:200]}...")

            # JSON 파싱 (코드블록 제거)
            json_str = ai_response.strip()
            if '```json' in json_str:
                json_str = json_str.split('```json')[1].split('```')[0]
            elif '```' in json_str:
                json_str = json_str.split('```')[1].split('```')[0]

            parsed = json.loads(json_str.strip())
            print(f"[AI] 파싱 성공: {parsed}")

            # direct_answer 타입이면 바로 응답 반환
            if parsed.get('analysis_type') == 'direct_answer' and parsed.get('direct_answer'):
                print(f"[AI] 직접 답변 반환")
                return jsonify({
                    'success': True,
                    'analysis_type': 'direct_answer',
                    'description': parsed.get('description', ''),
                    'direct_answer': parsed.get('direct_answer'),
                    'parsed_query': parsed
                })

            # 데이터 조회 및 분석 실행 (캐시된 데이터 사용)
            food_2024 = load_food_item_data('2024')
            food_2025 = load_food_item_data('2025')
            data_2024 = load_excel_data('2024')
            data_2025 = load_excel_data('2025')

            analysis_result = execute_analysis(parsed, food_2024, food_2025, data_2024, data_2025)
            analysis_result['parsed_query'] = parsed

            print(f"[AI] 분석 완료: {analysis_result.get('analysis_type')}, 건수: {analysis_result.get('total_count')}")
            return jsonify(analysis_result)

        except urllib.error.HTTPError as e:
            error_body = e.read().decode('utf-8') if e.fp else ''
            print(f"[AI] HTTP 오류 {e.code}: {e.reason}")
            print(f"[AI] 오류 상세: {error_body[:300]}")

            if e.code == 429:  # Too Many Requests - 다음 키로 전환
                keys_tried += 1
                current_api_key_index = (current_api_key_index + 1) % total_keys
                print(f"[AI] 429 오류 - 다음 API 키로 전환 (키 {current_api_key_index + 1})")
                time.sleep(1)  # 짧은 대기 후 다음 키 시도
                continue
            elif e.code == 404:
                return jsonify({'error': f'API 모델을 찾을 수 없습니다 (404). 모델명 확인 필요.'})
            else:
                return jsonify({'error': f'API 오류 {e.code}: {e.reason}'})

        except urllib.error.URLError as e:
            print(f"[AI] URL 오류: {e.reason}")
            return jsonify({'error': f'API 연결 실패: {str(e.reason)}'})

        except json.JSONDecodeError as e:
            print(f"[AI] JSON 파싱 오류: {e}")
            print(f"[AI] 파싱 시도한 문자열: {json_str[:300] if 'json_str' in locals() else 'N/A'}")
            return jsonify({
                'error': f'응답 파싱 실패. Gemini가 올바른 JSON을 반환하지 않았습니다.',
                'raw_response': ai_response[:500] if 'ai_response' in locals() else ''
            })

        except Exception as e:
            import traceback
            print(f"[AI] 예외 발생: {e}")
            print(f"[AI] 트레이스백: {traceback.format_exc()}")
            return jsonify({'error': f'분석 실패: {str(e)}'})

    return jsonify({'error': f'모든 API 키({total_keys}개)가 할당량을 초과했습니다. 잠시 후 다시 시도해주세요.'})


def execute_analysis(params, food_2024, food_2025, data_2024, data_2025):
    """파싱된 조건으로 실제 데이터 분석 실행 - 대시보드와 동일한 데이터(공급가액) 사용"""
    analysis_type = params.get('analysis_type', 'summary')
    year = params.get('year', '2025')
    compare_year = params.get('compare_year')  # 비교 연도 (예: 2024)
    month = params.get('month')  # 월 필터
    purpose = params.get('purpose')
    sample_type = params.get('sample_type')
    manager = params.get('manager')
    top_n = params.get('top_n', 10)
    description = params.get('description', '')

    def get_sales(row):
        """공급가액 추출 (대시보드와 동일)"""
        sales = row.get('공급가액', 0) or 0
        if isinstance(sales, str):
            sales = float(sales.replace(',', '').replace('원', '')) if sales else 0
        return sales

    def get_month(row):
        """월 추출"""
        date = row.get('접수일자')
        if date and hasattr(date, 'month'):
            return date.month
        return 0

    def filter_data(data, month_filter=None, purpose_filter=None, sample_type_filter=None, manager_filter=None):
        """데이터 필터링"""
        filtered = []
        for row in data:
            if month_filter:
                row_month = get_month(row)
                if row_month != int(month_filter):
                    continue
            if purpose_filter and str(row.get('검사목적', '')).strip() != purpose_filter:
                continue
            if sample_type_filter and str(row.get('검체유형', '')).strip() != sample_type_filter:
                continue
            if manager_filter and str(row.get('영업담당', '')).strip() != manager_filter:
                continue
            filtered.append(row)
        return filtered

    # 대시보드와 동일한 데이터 소스 사용 (공급가액 기준)
    main_data = data_2025 if year == '2025' else data_2024
    compare_data = data_2024 if compare_year == '2024' else (data_2025 if compare_year == '2025' else None)

    # 메인 데이터 필터링
    filtered = filter_data(main_data, month, purpose, sample_type, manager)

    # 비교 데이터 필터링
    filtered_compare = filter_data(compare_data, month, purpose, sample_type, manager) if compare_data else []

    # compare_year가 있으면 무조건 year_comparison 타입으로 처리
    if compare_year:
        analysis_type = 'year_comparison'

    result = {
        'success': True,
        'description': description,
        'analysis_type': analysis_type,
        'total_count': len(filtered),
        'year': year
    }

    if analysis_type == 'year_comparison':
        # 연도간 비교 분석
        main_total = sum(get_sales(row) for row in filtered)
        main_count = len(filtered)
        compare_total = sum(get_sales(row) for row in filtered_compare)
        compare_count = len(filtered_compare)

        diff_sales = main_total - compare_total
        diff_count = main_count - compare_count
        growth_rate = ((main_total - compare_total) / compare_total * 100) if compare_total > 0 else 0

        result['comparison'] = {
            'main_year': {'year': year, 'count': main_count, 'sales': main_total},
            'compare_year': {'year': compare_year, 'count': compare_count, 'sales': compare_total},
            'difference': {'count': diff_count, 'sales': diff_sales, 'growth_rate': round(growth_rate, 1)}
        }
        result['total_fee'] = main_total

        # 월별 비교 차트 데이터
        if month:
            result['month'] = int(month)
        else:
            # 전체 월별 추이 비교
            monthly_main = {}
            monthly_compare = {}
            for row in filtered:
                m = get_month(row)
                if m > 0:
                    monthly_main[m] = monthly_main.get(m, 0) + get_sales(row)
            for row in filtered_compare:
                m = get_month(row)
                if m > 0:
                    monthly_compare[m] = monthly_compare.get(m, 0) + get_sales(row)

            result['chart_data'] = {
                'labels': [f'{m}월' for m in range(1, 13)],
                'datasets': [
                    {'label': f'{year}년', 'data': [monthly_main.get(m, 0) for m in range(1, 13)]},
                    {'label': f'{compare_year}년', 'data': [monthly_compare.get(m, 0) for m in range(1, 13)]}
                ]
            }

    elif analysis_type == 'monthly_trend':
        # 월별 추이
        monthly = {}
        for row in filtered:
            m = get_month(row)
            if m > 0:
                monthly[m] = monthly.get(m, 0) + get_sales(row)

        result['chart_data'] = {
            'labels': [f'{m}월' for m in range(1, 13)],
            'datasets': [
                {'label': f'{year}년 매출', 'data': [monthly.get(m, 0) for m in range(1, 13)]}
            ]
        }
        result['total_fee'] = sum(monthly.values())

    elif analysis_type == 'top_managers':
        # 영업담당별 TOP N
        manager_stats = {}
        for row in filtered:
            mgr = str(row.get('영업담당', '미지정')).strip()
            if mgr not in manager_stats:
                manager_stats[mgr] = {'count': 0, 'sales': 0}
            manager_stats[mgr]['count'] += 1
            manager_stats[mgr]['sales'] += get_sales(row)

        sorted_managers = sorted(manager_stats.items(), key=lambda x: x[1]['sales'], reverse=True)[:top_n]
        result['top_items'] = [{'name': k, 'count': v['count'], 'sales': v['sales']} for k, v in sorted_managers]
        result['chart_data'] = {
            'labels': [m[0] for m in sorted_managers],
            'datasets': [{'label': '매출', 'data': [m[1]['sales'] for m in sorted_managers]}]
        }
        result['total_fee'] = sum(get_sales(row) for row in filtered)

    elif analysis_type == 'top_purposes':
        # 검사목적별 TOP N
        purpose_stats = {}
        for row in filtered:
            p = str(row.get('검사목적', '미지정')).strip()
            if p not in purpose_stats:
                purpose_stats[p] = {'count': 0, 'sales': 0}
            purpose_stats[p]['count'] += 1
            purpose_stats[p]['sales'] += get_sales(row)

        sorted_purposes = sorted(purpose_stats.items(), key=lambda x: x[1]['sales'], reverse=True)[:top_n]
        result['top_items'] = [{'name': k, 'count': v['count'], 'sales': v['sales']} for k, v in sorted_purposes]
        result['chart_data'] = {
            'labels': [p[0][:15] for p in sorted_purposes],
            'datasets': [{'label': '매출', 'data': [p[1]['sales'] for p in sorted_purposes]}]
        }
        result['total_fee'] = sum(get_sales(row) for row in filtered)

    else:  # summary
        total_sales = sum(get_sales(row) for row in filtered)
        result['summary'] = {
            'total_count': len(filtered),
            'total_sales': total_sales,
            'avg_sales': total_sales / len(filtered) if filtered else 0
        }
        result['total_fee'] = total_sales

    return result


@app.route('/api/ai/goal-analysis', methods=['POST'])
def goal_analysis():
    """목표 달성 분석 API - 데이터 기반 종합 분석"""
    try:
        target_revenue = request.json.get('target', 7000000000)  # 기본 70억
        target_year = request.json.get('year', 2026)

        # 필터 옵션 (체크박스 선택)
        filters = request.json.get('filters', {})
        selected_managers = filters.get('managers', [])  # 빈 배열 = 전체
        selected_teams = filters.get('teams', [])
        selected_months = filters.get('months', [])
        selected_purposes = filters.get('purposes', [])
        selected_regions = filters.get('regions', [])
        selected_sample_types = filters.get('sample_types', [])
        selected_items = filters.get('items', [])
        selected_analyzers = filters.get('analyzers', [])

        # 데이터 로드 (메인 Excel 데이터 사용 - 공급가액 기준)
        data_2024 = load_excel_data('2024')
        data_2025 = load_excel_data('2025')

        def get_fee(row):
            """공급가액 추출"""
            fee = row.get('공급가액', 0) or 0
            if isinstance(fee, str):
                fee = float(fee.replace(',', '').replace('원', '')) if fee else 0
            return float(fee)

        def match_filter(row, managers, teams, months, purposes, regions, sample_types, items, analyzers):
            """필터 조건 매칭"""
            # 빈 배열이면 전체 선택으로 처리
            if managers and str(row.get('영업담당', '')).strip() not in managers:
                return False
            if teams:
                manager = str(row.get('영업담당', '')).strip()
                team = MANAGER_TO_BRANCH.get(manager, '기타')
                if team not in teams:
                    return False
            if months:
                date = row.get('접수일자')
                if date and hasattr(date, 'month'):
                    if date.month not in months:
                        return False
            if purposes and str(row.get('검사목적', '')).strip() not in purposes:
                return False
            if regions and str(row.get('지역', '')).strip() not in regions:
                return False
            if sample_types and str(row.get('검체유형', '')).strip() not in sample_types:
                return False
            if items and str(row.get('항목명', '')).strip() not in items:
                return False
            if analyzers and str(row.get('결과입력자', '')).strip() not in analyzers:
                return False
            return True

        # 연도별 매출 계산 (공급가액 기준)
        revenue_2024 = sum(get_fee(row) for row in data_2024 if match_filter(
            row, selected_managers, selected_teams, selected_months, selected_purposes,
            selected_regions, selected_sample_types, selected_items, selected_analyzers))
        revenue_2025 = sum(get_fee(row) for row in data_2025 if match_filter(
            row, selected_managers, selected_teams, selected_months, selected_purposes,
            selected_regions, selected_sample_types, selected_items, selected_analyzers))

        # 성장률 계산
        growth_rate = ((revenue_2025 - revenue_2024) / revenue_2024 * 100) if revenue_2024 > 0 else 0

        # 목표 달성에 필요한 추가 매출
        gap = target_revenue - revenue_2025
        required_growth = ((target_revenue - revenue_2025) / revenue_2025 * 100) if revenue_2025 > 0 else 0

        result = {
            'success': True,
            'target': target_revenue,
            'target_year': target_year,
            'current_status': {
                'revenue_2024': revenue_2024,
                'revenue_2025': revenue_2025,
                'growth_rate': round(growth_rate, 1),
                'gap_to_target': gap,
                'required_growth': round(required_growth, 1)
            },
            'analysis': {},
            'recommendations': []
        }

        # 1. 영업담당별 분석
        by_manager = {}
        for row in data_2025:
            if not match_filter(row, [], selected_teams, selected_months, selected_purposes,
                               selected_regions, selected_sample_types, selected_items, selected_analyzers):
                continue
            manager = str(row.get('영업담당', '') or '').strip() or '미지정'
            revenue = get_fee(row)
            if manager not in by_manager:
                by_manager[manager] = {'revenue_2025': 0, 'count_2025': 0, 'revenue_2024': 0, 'count_2024': 0}
            by_manager[manager]['revenue_2025'] += revenue
            by_manager[manager]['count_2025'] += 1

        for row in data_2024:
            if not match_filter(row, [], selected_teams, selected_months, selected_purposes,
                               selected_regions, selected_sample_types, selected_items, selected_analyzers):
                continue
            manager = str(row.get('영업담당', '') or '').strip() or '미지정'
            revenue = get_fee(row)
            if manager not in by_manager:
                by_manager[manager] = {'revenue_2025': 0, 'count_2025': 0, 'revenue_2024': 0, 'count_2024': 0}
            by_manager[manager]['revenue_2024'] += revenue
            by_manager[manager]['count_2024'] += 1

        # 영업담당별 성장률 계산 (ISA, IBK 등 제외)
        manager_analysis = []
        for manager, data in by_manager.items():
            # 제외 대상 확인
            if manager in EXCLUDED_MANAGERS:
                continue
            if data['revenue_2024'] > 0:
                mgr_growth = ((data['revenue_2025'] - data['revenue_2024']) / data['revenue_2024'] * 100)
            else:
                mgr_growth = 100 if data['revenue_2025'] > 0 else 0
            manager_analysis.append({
                'name': manager,
                'revenue_2024': data['revenue_2024'],
                'revenue_2025': data['revenue_2025'],
                'growth': round(mgr_growth, 1),
                'count_2025': data['count_2025'],
                'potential': data['revenue_2025'] * (required_growth / 100) if mgr_growth < required_growth else 0
            })

        manager_analysis.sort(key=lambda x: x['revenue_2025'], reverse=True)
        result['analysis']['by_manager'] = manager_analysis[:15]

        # 성장률 낮은 영업담당 (개선 필요) - 제외 대상 빼고
        underperforming_managers = [m for m in manager_analysis if m['growth'] < growth_rate and m['revenue_2024'] > 10000000 and m['name'] not in EXCLUDED_MANAGERS]
        underperforming_managers.sort(key=lambda x: x['growth'])

        # 2. 검사목적별 분석
        by_purpose = {}
        for row in data_2025:
            if not match_filter(row, selected_managers, selected_teams, selected_months, [],
                               selected_regions, selected_sample_types, selected_items, selected_analyzers):
                continue
            purpose = str(row.get('검사목적', '') or '').strip() or '미지정'
            revenue = get_fee(row)
            if purpose not in by_purpose:
                by_purpose[purpose] = {'revenue_2025': 0, 'count_2025': 0, 'revenue_2024': 0, 'count_2024': 0}
            by_purpose[purpose]['revenue_2025'] += revenue
            by_purpose[purpose]['count_2025'] += 1

        for row in data_2024:
            if not match_filter(row, selected_managers, selected_teams, selected_months, [],
                               selected_regions, selected_sample_types, selected_items, selected_analyzers):
                continue
            purpose = str(row.get('검사목적', '') or '').strip() or '미지정'
            revenue = get_fee(row)
            if purpose not in by_purpose:
                by_purpose[purpose] = {'revenue_2025': 0, 'count_2025': 0, 'revenue_2024': 0, 'count_2024': 0}
            by_purpose[purpose]['revenue_2024'] += revenue
            by_purpose[purpose]['count_2024'] += 1

        purpose_analysis = []
        for purpose, data in by_purpose.items():
            if data['revenue_2024'] > 0:
                purp_growth = ((data['revenue_2025'] - data['revenue_2024']) / data['revenue_2024'] * 100)
            else:
                purp_growth = 100 if data['revenue_2025'] > 0 else 0
            purpose_analysis.append({
                'name': purpose,
                'revenue_2024': data['revenue_2024'],
                'revenue_2025': data['revenue_2025'],
                'growth': round(purp_growth, 1),
                'count_2025': data['count_2025'],
                'share': round(data['revenue_2025'] / revenue_2025 * 100, 1) if revenue_2025 > 0 else 0
            })

        purpose_analysis.sort(key=lambda x: x['revenue_2025'], reverse=True)
        result['analysis']['by_purpose'] = purpose_analysis[:10]

        # 3. 검체유형별 분석
        by_sample_type = {}
        for row in data_2025:
            if not match_filter(row, selected_managers, selected_teams, selected_months, selected_purposes,
                               selected_regions, [], selected_items, selected_analyzers):
                continue
            sample_type = str(row.get('검체유형', '') or '').strip() or '미지정'
            revenue = get_fee(row)
            if sample_type not in by_sample_type:
                by_sample_type[sample_type] = {'revenue_2025': 0, 'revenue_2024': 0}
            by_sample_type[sample_type]['revenue_2025'] += revenue

        for row in data_2024:
            if not match_filter(row, selected_managers, selected_teams, selected_months, selected_purposes,
                               selected_regions, [], selected_items, selected_analyzers):
                continue
            sample_type = str(row.get('검체유형', '') or '').strip() or '미지정'
            revenue = get_fee(row)
            if sample_type not in by_sample_type:
                by_sample_type[sample_type] = {'revenue_2025': 0, 'revenue_2024': 0}
            by_sample_type[sample_type]['revenue_2024'] += revenue

        sample_analysis = []
        for st, data in by_sample_type.items():
            if data['revenue_2024'] > 0:
                st_growth = ((data['revenue_2025'] - data['revenue_2024']) / data['revenue_2024'] * 100)
            else:
                st_growth = 100 if data['revenue_2025'] > 0 else 0
            sample_analysis.append({
                'name': st,
                'revenue_2024': data['revenue_2024'],
                'revenue_2025': data['revenue_2025'],
                'growth': round(st_growth, 1)
            })

        sample_analysis.sort(key=lambda x: x['revenue_2025'], reverse=True)
        result['analysis']['by_sample_type'] = sample_analysis[:15]

        # 4. 지역별 분석
        by_region = {}
        for row in data_2025:
            if not match_filter(row, selected_managers, selected_teams, selected_months, selected_purposes,
                               [], selected_sample_types, selected_items, selected_analyzers):
                continue
            address = str(row.get('업체주소', '') or '').strip()
            region = extract_sido(address)
            if not region:
                region = '미지정'
            revenue = get_fee(row)
            if region not in by_region:
                by_region[region] = {'revenue_2025': 0, 'revenue_2024': 0, 'count_2025': 0}
            by_region[region]['revenue_2025'] += revenue
            by_region[region]['count_2025'] += 1

        for row in data_2024:
            if not match_filter(row, selected_managers, selected_teams, selected_months, selected_purposes,
                               [], selected_sample_types, selected_items, selected_analyzers):
                continue
            address = str(row.get('업체주소', '') or '').strip()
            region = extract_sido(address)
            if not region:
                region = '미지정'
            revenue = get_fee(row)
            if region not in by_region:
                by_region[region] = {'revenue_2025': 0, 'revenue_2024': 0, 'count_2025': 0}
            by_region[region]['revenue_2024'] += revenue

        region_analysis = []
        for region, data in by_region.items():
            if data['revenue_2024'] > 0:
                reg_growth = ((data['revenue_2025'] - data['revenue_2024']) / data['revenue_2024'] * 100)
            else:
                reg_growth = 100 if data['revenue_2025'] > 0 else 0
            region_analysis.append({
                'name': region,
                'revenue_2024': data['revenue_2024'],
                'revenue_2025': data['revenue_2025'],
                'growth': round(reg_growth, 1),
                'count_2025': data['count_2025']
            })

        region_analysis.sort(key=lambda x: x['revenue_2025'], reverse=True)
        result['analysis']['by_region'] = region_analysis

        # 5. 항목별 분석 (food_item 데이터)
        by_item = {}
        for row in data_2025:
            if not match_filter(row, selected_managers, selected_teams, selected_months, selected_purposes,
                               selected_regions, selected_sample_types, [], selected_analyzers):
                continue
            item = str(row.get('항목명', '') or '').strip()
            if not item:
                continue
            fee = get_fee(row)
            if item not in by_item:
                by_item[item] = {'fee_2025': 0, 'count_2025': 0, 'fee_2024': 0, 'count_2024': 0}
            by_item[item]['fee_2025'] += fee
            by_item[item]['count_2025'] += 1

        for row in data_2024:
            if not match_filter(row, selected_managers, selected_teams, selected_months, selected_purposes,
                               selected_regions, selected_sample_types, [], selected_analyzers):
                continue
            item = str(row.get('항목명', '') or '').strip()
            if not item:
                continue
            fee = get_fee(row)
            if item not in by_item:
                by_item[item] = {'fee_2025': 0, 'count_2025': 0, 'fee_2024': 0, 'count_2024': 0}
            by_item[item]['fee_2024'] += fee
            by_item[item]['count_2024'] += 1

        item_analysis = []
        for item, data in by_item.items():
            if data['fee_2024'] > 0:
                item_growth = ((data['fee_2025'] - data['fee_2024']) / data['fee_2024'] * 100)
            else:
                item_growth = 100 if data['fee_2025'] > 0 else 0
            item_analysis.append({
                'name': item,
                'fee_2024': data['fee_2024'],
                'fee_2025': data['fee_2025'],
                'growth': round(item_growth, 1),
                'count_2025': data['count_2025']
            })

        item_analysis.sort(key=lambda x: x['fee_2025'], reverse=True)
        result['analysis']['by_item'] = item_analysis[:20]

        # 감소 항목 (위험 요소)
        declining_items = [i for i in item_analysis if i['growth'] < 0 and i['fee_2024'] > 5000000]
        declining_items.sort(key=lambda x: x['growth'])

        # ===== 추천사항 생성 =====
        recommendations = []

        # 1. 전체 목표 분석
        recommendations.append({
            'category': '📊 목표 분석',
            'title': f'{target_year}년 {target_revenue/100000000:.0f}억 달성 가능성',
            'content': f'현재 추세(연 {growth_rate:.1f}% 성장) 유지 시 {target_year}년 예상 매출: {revenue_2025 * (1 + growth_rate/100)/100000000:.1f}억원',
            'action': f'목표 달성을 위해 추가 {gap/100000000:.1f}억원 ({required_growth:.1f}% 성장) 필요',
            'priority': 'high' if required_growth > growth_rate * 1.5 else 'medium'
        })

        # 2. 영업담당 개선
        if underperforming_managers:
            top_under = underperforming_managers[:3]
            potential_gain = sum(m['potential'] for m in top_under)
            recommendations.append({
                'category': '👤 영업담당',
                'title': '성장률 개선 필요 담당자',
                'content': ', '.join([f"{m['name']}({m['growth']:+.1f}%)" for m in top_under]),
                'action': f'이 담당자들이 평균 성장률 달성 시 약 {potential_gain/10000:.0f}만원 추가 가능',
                'evidence': [{'name': m['name'], 'current': m['revenue_2025'], 'growth': m['growth']} for m in top_under],
                'priority': 'high'
            })

        # 3. 고성장 영업담당 (롤모델)
        high_growth_managers = [m for m in manager_analysis if m['growth'] > growth_rate * 1.5 and m['revenue_2025'] > 50000000]
        if high_growth_managers:
            recommendations.append({
                'category': '⭐ 우수 사례',
                'title': '고성장 영업담당 (벤치마킹 대상)',
                'content': ', '.join([f"{m['name']}({m['growth']:+.1f}%)" for m in high_growth_managers[:3]]),
                'action': '이들의 영업 전략 분석 및 공유 권장',
                'priority': 'medium'
            })

        # 4. 검사목적별 기회
        growing_purposes = [p for p in purpose_analysis if p['growth'] > 10 and p['revenue_2025'] > 100000000]
        if growing_purposes:
            recommendations.append({
                'category': '🎯 검사목적',
                'title': '성장 중인 검사목적 (집중 공략)',
                'content': ', '.join([f"{p['name']}({p['growth']:+.1f}%)" for p in growing_purposes[:3]]),
                'action': '이 분야 마케팅 강화 및 전문성 확보',
                'evidence': growing_purposes[:3],
                'priority': 'high'
            })

        # 5. 감소 항목 경고
        if declining_items:
            total_decline = sum(abs(i['fee_2025'] - i['fee_2024']) for i in declining_items[:5])
            recommendations.append({
                'category': '⚠️ 위험 요소',
                'title': '매출 감소 항목',
                'content': ', '.join([f"{i['name']}({i['growth']:.1f}%)" for i in declining_items[:5]]),
                'action': f'감소 원인 분석 필요 (총 감소액: {total_decline/10000:.0f}만원)',
                'evidence': declining_items[:5],
                'priority': 'high'
            })

        # 6. 지역별 기회
        growing_regions = [r for r in region_analysis if r['growth'] > growth_rate and r['revenue_2025'] > 50000000]
        weak_regions = [r for r in region_analysis if r['growth'] < 0 and r['revenue_2024'] > 50000000]

        if growing_regions:
            recommendations.append({
                'category': '📍 지역',
                'title': '성장 지역 (확대 공략)',
                'content': ', '.join([f"{r['name']}({r['growth']:+.1f}%)" for r in growing_regions[:5]]),
                'action': '해당 지역 영업 인력/마케팅 확대 검토',
                'priority': 'medium'
            })

        if weak_regions:
            recommendations.append({
                'category': '📍 지역',
                'title': '감소 지역 (원인 분석 필요)',
                'content': ', '.join([f"{r['name']}({r['growth']:.1f}%)" for r in weak_regions[:5]]),
                'action': '경쟁사 동향 및 고객 이탈 원인 파악',
                'priority': 'medium'
            })

        # 7. 실행 계획 제안
        monthly_target = gap / 12 if gap > 0 else 0
        active_managers = len([m for m in manager_analysis if m['revenue_2025'] > 0])
        per_manager_target = (monthly_target / active_managers / 10000) if active_managers > 0 else 0
        recommendations.append({
            'category': '📋 실행 계획',
            'title': '월별 추가 목표',
            'content': f'목표 달성을 위해 월 평균 {monthly_target/10000:.0f}만원 추가 매출 필요',
            'action': f'영업담당 1인당 월 {per_manager_target:.0f}만원 추가 목표 설정 ({active_managers}명 기준)',
            'priority': 'high'
        })

        result['recommendations'] = recommendations

        # ===== Claude AI 인사이트 생성 =====
        if USE_CLAUDE and CLAUDE_API_KEY:
            try:
                # 분석 데이터 요약
                analysis_summary = f"""
## 사업 성과 분석 데이터

### 기본 현황
- 2024년 매출: {revenue_2024/100000000:.2f}억원
- 2025년 매출: {revenue_2025/100000000:.2f}억원
- 전년 대비 성장률: {growth_rate:+.1f}%
- {target_year}년 목표: {target_revenue/100000000:.0f}억원
- 목표 달성 격차: {gap/100000000:.2f}억원 (추가 {required_growth:.1f}% 성장 필요)

### 영업담당별 현황 (상위 5명)
{chr(10).join([f"- {m['name']}: {m['revenue_2025']/10000:.0f}만원 (성장률 {m['growth']:+.1f}%)" for m in manager_analysis[:5]])}

### 성장률 부진 담당자
{chr(10).join([f"- {m['name']}: 성장률 {m['growth']:+.1f}% (전체 평균 {growth_rate:.1f}% 미달)" for m in underperforming_managers[:3]]) if underperforming_managers else '- 없음'}

### 검사목적별 현황 (상위 5개)
{chr(10).join([f"- {p['name']}: {p['revenue_2025']/10000:.0f}만원 (비중 {p['share']:.1f}%, 성장률 {p['growth']:+.1f}%)" for p in purpose_analysis[:5]])}

### 지역별 현황 (상위 5개)
{chr(10).join([f"- {r['name']}: {r['revenue_2025']/10000:.0f}만원 (성장률 {r['growth']:+.1f}%)" for r in region_analysis[:5]])}

### 매출 감소 항목
{chr(10).join([f"- {i['name']}: {i['growth']:.1f}% 감소" for i in declining_items[:5]]) if declining_items else '- 없음'}
"""

                ai_prompt = f"""당신은 사업 분석 전문가입니다. 아래 데이터를 분석하여 목표 달성을 위한 구체적인 전략적 인사이트를 제공해주세요.

## 분석 지침
- 모든 탭(메인, 개인별, 팀별, 월별, 업체별, 지역별, 목적별, 유형, 부적합, 검사항목, 수금)을 참고하여 다각도로 분석
- 매출은 공급가액을 기준으로 분석 (검사항목의 매출 값이 아님)
- 항상 평균에 준하는 값을 기준으로 평균 이하/이상으로 분석

{analysis_summary}

다음 형식으로 분석해주세요:

1. **핵심 진단** (3줄 이내): 현재 상황의 핵심 문제점 또는 기회 (평균 대비 분석 포함)
2. **우선순위 전략** (3개): 가장 효과적인 매출 증대 전략
3. **위험 요소** (2개): 주의해야 할 리스크 (평균 이하 항목 중심)
4. **실행 제안** (3개): 구체적인 실행 방안 (평균 이상으로 끌어올릴 방안)

한국어로 간결하고 실행 가능한 조언을 제공해주세요."""

                ai_result = call_claude_api(ai_prompt, max_tokens=1024)

                if ai_result and 'response' in ai_result:
                    result['ai_insight'] = {
                        'content': ai_result['response'],
                        'model': 'Claude Opus 4',
                        'generated_at': datetime.now().isoformat()
                    }
                    if 'tokens' in ai_result:
                        result['ai_insight']['tokens'] = ai_result['tokens']
            except Exception as ai_error:
                result['ai_insight'] = {
                    'error': str(ai_error),
                    'content': None
                }

        # 필터 옵션 추가 (선택 가능한 값들)
        all_managers = set()
        all_purposes = set()
        all_sample_types = set()
        all_items = set()
        all_analyzers = set()
        all_regions = set()

        for row in data_2025:
            if row.get('영업담당'): all_managers.add(str(row.get('영업담당')).strip())
            if row.get('검사목적'): all_purposes.add(str(row.get('검사목적')).strip())
            if row.get('검체유형'): all_sample_types.add(str(row.get('검체유형')).strip())
            if row.get('항목명'): all_items.add(str(row.get('항목명')).strip())
            if row.get('결과입력자'): all_analyzers.add(str(row.get('결과입력자')).strip())
            address = str(row.get('업체주소', '') or '').strip()
            region = extract_sido(address)
            if region: all_regions.add(region)

        # 팀 목록 생성
        teams = set(MANAGER_TO_BRANCH.values())

        result['filter_options'] = {
            'managers': sorted([m for m in all_managers if m not in EXCLUDED_MANAGERS]),  # ISA, IBK 등 제외
            'teams': sorted(teams),
            'months': list(range(1, 13)),
            'purposes': sorted(all_purposes),
            'regions': sorted(all_regions),
            'sample_types': sorted(all_sample_types),
            'items': sorted(all_items)[:100],  # 상위 100개만
            'analyzers': sorted(all_analyzers)
        }

        # 적용된 필터 정보
        result['applied_filters'] = {
            'managers': selected_managers,
            'teams': selected_teams,
            'months': selected_months,
            'purposes': selected_purposes,
            'regions': selected_regions,
            'sample_types': selected_sample_types,
            'items': selected_items,
            'analyzers': selected_analyzers
        }

        return jsonify(result)

    except Exception as e:
        import traceback
        return jsonify({'error': str(e), 'traceback': traceback.format_exc()})


def extract_sido(address):
    """주소에서 시/도 추출"""
    if not address:
        return None
    # 전체 이름 + 약칭 매핑
    sido_full_to_short = {
        '서울특별시': '서울', '서울시': '서울', '서울': '서울',
        '부산광역시': '부산', '부산시': '부산', '부산': '부산',
        '대구광역시': '대구', '대구시': '대구', '대구': '대구',
        '인천광역시': '인천', '인천시': '인천', '인천': '인천',
        '광주광역시': '광주', '광주시': '광주', '광주': '광주',
        '대전광역시': '대전', '대전시': '대전', '대전': '대전',
        '울산광역시': '울산', '울산시': '울산', '울산': '울산',
        '세종특별자치시': '세종', '세종시': '세종', '세종': '세종',
        '경기도': '경기', '경기': '경기',
        '강원도': '강원', '강원특별자치도': '강원', '강원': '강원',
        '충청북도': '충북', '충북': '충북',
        '충청남도': '충남', '충남': '충남',
        '전라북도': '전북', '전북특별자치도': '전북', '전북': '전북',
        '전라남도': '전남', '전남': '전남',
        '경상북도': '경북', '경북': '경북',
        '경상남도': '경남', '경남': '경남',
        '제주특별자치도': '제주', '제주도': '제주', '제주': '제주'
    }
    # 긴 이름부터 매칭
    for full_name in sorted(sido_full_to_short.keys(), key=len, reverse=True):
        if full_name in address:
            return sido_full_to_short[full_name]
    return None


def preload_data():
    """서버 시작 시 데이터 미리 로드 (SQLite 우선)"""
    import time
    start_time = time.time()

    # 1. SQLite 모드인 경우
    if USE_SQLITE:
        print("[PRELOAD] SQLite 모드로 시작...")

        # SQLite DB 업데이트 필요 여부 확인
        if check_sqlite_needs_update():
            print("[PRELOAD] SQLite DB 업데이트 필요 - Excel 변환 시작...")
            convert_excel_to_sqlite()
        else:
            print("[PRELOAD] SQLite DB 최신 상태 유지")

        # SQLite에서 빠르게 로드 (기본 데이터만, food_item은 필요시 로드)
        for year in ['2024', '2025']:
            load_excel_data(year)
            # load_food_item_data(year)  # 메모리 절약: 필요시 로드

        # AI 요약 캐시 생성 (스킵 - 메모리 절약)
        # get_ai_data_summary(force_refresh=True)

        elapsed = time.time() - start_time
        print(f"[PRELOAD] SQLite 로드 완료! ({elapsed:.1f}초)")
        return

    # 2. 기존 방식: 파일 캐시에서 로드 시도
    if load_cache_from_file():
        elapsed = time.time() - start_time
        print(f"[PRELOAD] 파일 캐시에서 로드 완료! ({elapsed:.1f}초)")
        return

    # 3. 파일 캐시가 없거나 무효 -> Excel에서 로드
    print("[PRELOAD] Excel에서 데이터 로드 시작...")
    for year in ['2024', '2025']:
        load_excel_data(year)
        load_food_item_data(year)

    # 4. AI 요약 캐시도 미리 생성
    get_ai_data_summary(force_refresh=True)

    # 5. 파일로 캐시 저장
    save_cache_to_file()

    elapsed = time.time() - start_time
    print(f"[PRELOAD] 완료! ({elapsed:.1f}초)")


# ========== 웹 터미널 API ==========
@app.route('/api/terminal/auth', methods=['POST'])
def terminal_auth():
    """터미널 인증 API"""
    try:
        password = request.json.get('password', '')

        if password == TERMINAL_PASSWORD:
            # 세션 토큰 생성
            token = secrets.token_hex(32)
            terminal_sessions[token] = {
                'created': datetime.now(),
                'ip': request.remote_addr
            }
            return jsonify({'success': True, 'token': token})
        else:
            return jsonify({'success': False, 'error': '비밀번호가 틀렸습니다'})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/terminal/exec', methods=['POST'])
def terminal_exec():
    """터미널 명령어 실행 API"""
    try:
        token = request.json.get('token', '')
        command = request.json.get('command', '')

        # 토큰 검증
        if token not in terminal_sessions:
            return jsonify({'success': False, 'error': '인증이 필요합니다'})

        # 세션 만료 확인 (1시간)
        session = terminal_sessions[token]
        if (datetime.now() - session['created']).seconds > 3600:
            del terminal_sessions[token]
            return jsonify({'success': False, 'error': '세션이 만료되었습니다. 다시 인증해주세요.'})

        if not command.strip():
            return jsonify({'success': False, 'error': '명령어를 입력하세요'})

        # 위험한 명령어 차단
        dangerous_commands = ['rm -rf /', 'mkfs', 'dd if=', ':(){:|:&};:', '> /dev/sda']
        for dangerous in dangerous_commands:
            if dangerous in command:
                return jsonify({'success': False, 'error': f'위험한 명령어가 차단되었습니다: {dangerous}'})

        # 명령어 실행
        result = subprocess.run(
            command,
            shell=True,
            capture_output=True,
            text=True,
            timeout=60,  # 60초 타임아웃
            cwd='/home/biofl/business_metrics'  # 작업 디렉토리
        )

        output = result.stdout
        if result.stderr:
            output += '\n[STDERR]\n' + result.stderr

        return jsonify({
            'success': True,
            'output': output if output else '(출력 없음)',
            'returncode': result.returncode
        })

    except subprocess.TimeoutExpired:
        return jsonify({'success': False, 'error': '명령어 실행 시간 초과 (60초)'})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


if __name__ == '__main__':
    # 서버 시작 시 데이터 미리 로드
    preload_data()
    port = int(os.environ.get('PORT', 6001))
    app.run(host='0.0.0.0', port=port, debug=False)
